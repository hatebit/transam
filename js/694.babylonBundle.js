"use strict";(self.webpackChunktrans_america=self.webpackChunktrans_america||[]).push([[694,158,75,229,973,130,894,153,385,752,542,691,535,143,7],{46077:(e,t,i)=>{i.d(t,{SM:()=>p,rT:()=>c,BT:()=>d});var r=i(93420),n=i(6740),s=i(30966),a=i(13528),o=i(40505),l=i(54983);class c{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,s=!1,a=1,o,l,c,h=!1,u=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=h,this.playOrder=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new n.cP,this.onAnimationLoopObservable=new n.cP,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const r=t[i],n=new s.x(e,r,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){const i=this._runtimeAnimations;if(i[0]){const t=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;const r=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/t*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let r=0;r<i.length;r++)i[r].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){const s=this._runtimeAnimations;for(let i=s.length-1;i>=0;i--){const r=s[i];e&&r.animation.name!=e||t&&!t(r.target)||(r.dispose(),s.splice(i,1))}0==s.length&&(i||this._scene._activeAnimatables.splice(n,1),r||this._raiseOnAnimationEnd())}}else{const e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise((e=>{this.onAnimationEndObservable.add((()=>{e(this)}),void 0,void 0,this,!0)}))}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let r;for(r=0;r<i.length;r++){const n=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}function h(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1;const i=l.AA.Vector3[0],r=l.AA.Vector3[1],n=l.AA.Quaternion[0];let s=0;const a=e.animations[0],o=e.originalValue;let c=1,h=!1;if(e.totalWeight<1)c=1-e.totalWeight,o.decompose(r,n,i);else{if(s=1,t=e.totalWeight,c=a.weight/t,1==c){if(!e.totalAdditiveWeight)return a.currentValue;h=!0}a.currentValue.decompose(r,n,i)}if(!h){r.scaleInPlace(c),i.scaleInPlace(c),n.scaleInPlace(c);for(let a=s;a<e.animations.length;a++){const s=e.animations[a];if(0===s.weight)continue;c=s.weight/t;const o=l.AA.Vector3[2],h=l.AA.Vector3[3],u=l.AA.Quaternion[1];s.currentValue.decompose(h,u,o),h.scaleAndAddToRef(c,r),u.scaleAndAddToRef(l.PT.Dot(n,u)>0?c:-c,n),o.scaleAndAddToRef(c,i)}n.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){const s=e.additiveAnimations[t];if(0===s.weight)continue;const a=l.AA.Vector3[2],o=l.AA.Vector3[3],c=l.AA.Quaternion[1];s.currentValue.decompose(o,c,a),o.multiplyToRef(r,o),l.Pq.LerpToRef(r,o,s.weight,r),n.multiplyToRef(c,c),l.PT.SlerpToRef(n,c,s.weight,n),a.scaleAndAddToRef(s.weight,i)}const u=a?a._animationState.workValue:l.AA.Matrix[0].clone();return l.uq.ComposeToRef(r,n,i,u),u}function u(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;const i=e.animations[0],r=e.originalValue;let n=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)n.copyFrom(r);else if(1===e.animations.length){if(l.PT.SlerpToRef(r,i.currentValue,Math.min(1,e.totalWeight),n),0===e.totalAdditiveWeight)return n}else if(e.animations.length>1){let i,s,a=1;if(e.totalWeight<1){const t=1-e.totalWeight;i=[],s=[],i.push(r),s.push(t)}else{if(2===e.animations.length&&(l.PT.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],s=[],a=e.totalWeight}for(let t=0;t<e.animations.length;t++){const r=e.animations[t];i.push(r.currentValue),s.push(r.weight/a)}let o=0;for(let e=0;e<i.length;)e?(o+=s[e],l.PT.SlerpToRef(n,i[e],s[e]/o,n),e++):(l.PT.SlerpToRef(i[e],i[e+1],s[e+1]/(s[e]+s[e+1]),t),n=t,o=s[e]+s[e+1],e+=2)}for(let t=0;t<e.additiveAnimations.length;t++){const i=e.additiveAnimations[t];0!==i.weight&&(n.multiplyToRef(i.currentValue,l.AA.Quaternion[0]),l.PT.SlerpToRef(n,l.AA.Quaternion[0],i.weight,n))}return n}function d(e,t,i){const r=t.target;e._registeredForLateAnimationBindings.pushNoDuplicate(r),r._lateAnimationHolders||(r._lateAnimationHolders={}),r._lateAnimationHolders[t.targetPath]||(r._lateAnimationHolders[t.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:i}),t.isAdditive?(r._lateAnimationHolders[t.targetPath].additiveAnimations.push(t),r._lateAnimationHolders[t.targetPath].totalAdditiveWeight+=t.weight):(r._lateAnimationHolders[t.targetPath].animations.push(t),r._lateAnimationHolders[t.targetPath].totalWeight+=t.weight)}function p(e,t){t&&(t.prototype.copyAnimationRange=function(e,t,i,r=!1,n=null){0===this.animations.length&&(this.animations.push(new a.X5(this.name,"_matrix",e.animations[0].framePerSecond,a.X5.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const s=e.animations[0].getRange(t);if(!s)return!1;const o=s.from,l=s.to,c=e.animations[0].getKeys(),h=e.length,u=e.getParent(),d=this.getParent(),p=r&&u&&h&&this.length&&h!==this.length,f=p&&d&&u?d.length/u.length:1,m=r&&!d&&n&&(1!==n.x||1!==n.y||1!==n.z),_=this.animations[0].getKeys();let g,v,S;for(let e=0,t=c.length;e<t;e++)g=c[e],g.frame>=o&&g.frame<=l&&(r?(S=g.value.clone(),p?(v=S.getTranslation(),S.setTranslation(v.scaleInPlace(f))):m&&n?(v=S.getTranslation(),S.setTranslation(v.multiplyInPlace(n))):S=g.value):S=g.value,_.push({frame:g.frame+i,value:S}));return this.animations[0].createRange(t,o+i,l+i),!0}),e&&(e.prototype._animate=function(e){if(!this.animationsEnabled)return;const t=o.j.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}this.deltaTime=void 0!==e?e:this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=t;const i=this._activeAnimatables;if(0===i.length)return;this._animationTime+=this.deltaTime;const r=this._animationTime;for(let e=0;e<i.length;e++){const t=i[e];!t._animate(r)&&t.disposeOnEnd&&e--}!function(e){if(e._registeredForLateAnimationBindings.length){for(let t=0;t<e._registeredForLateAnimationBindings.length;t++){const i=e._registeredForLateAnimationBindings.data[t];for(const e in i._lateAnimationHolders){const t=i._lateAnimationHolders[e],r=t.animations[0],n=t.originalValue;if(null==n)continue;const s=a.X5.AllowMatrixDecomposeForInterpolation&&n.m;let o=i[e];if(s)o=h(t);else if(void 0!==n.w)o=u(t,o||l.PT.Identity());else{let e=0,i=1;const s=r&&r._animationState.loopMode===a.X5.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(t.totalWeight<1)o=s?n.clone?n.clone():n:r&&n.scale?n.scale(1-t.totalWeight):r?n*(1-t.totalWeight):n.clone?n.clone():n;else if(r){i=t.totalWeight;const a=r.weight/i;o=1!==a?r.currentValue.scale?r.currentValue.scale(a):r.currentValue*a:r.currentValue,s&&(o.addToRef?o.addToRef(n,o):o+=n),e=1}for(let r=e;r<t.animations.length;r++){const e=t.animations[r],n=e.weight/i;n&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(n,o):o+=e.currentValue*n)}for(let e=0;e<t.additiveAnimations.length;e++){const i=t.additiveAnimations[e],r=i.weight;r&&(i.currentValue.scaleAndAddToRef?i.currentValue.scaleAndAddToRef(r,o):o+=i.currentValue*r)}}i[e]=o}i._lateAnimationHolders={}}e._registeredForLateAnimationBindings.reset()}}(this)},e.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort(((e,t)=>e.playOrder-t.playOrder))},e.prototype.beginWeightedAnimation=function(e,t,i,r=1,n,s=1,a,o,l,c,h=!1){const u=this.beginAnimation(e,t,i,n,s,a,o,!1,l,c,h);return u.weight=r,u},e.prototype.beginAnimation=function(e,t,i,r,n=1,s,a,o=!0,l,h,u=!1){if(n<0){const e=t;t=i,i=e,n=-n}t>i&&(n=-n),o&&this.stopAnimation(e,void 0,l),a||(a=new c(this,e,t,i,r,n,s,void 0,h,u));const d=!l||l(e);if(e.animations&&d&&a.appendAnimations(e,e.animations),e.getAnimatables){const c=e.getAnimatables();for(let e=0;e<c.length;e++)this.beginAnimation(c[e],t,i,r,n,s,a,o,l,h)}return a.reset(),a},e.prototype.beginHierarchyAnimation=function(e,t,i,r,n,s=1,a,o,l=!0,c,h,u=!1){const d=e.getDescendants(t),p=[];p.push(this.beginAnimation(e,i,r,n,s,a,o,l,c,void 0,u));for(const e of d)p.push(this.beginAnimation(e,i,r,n,s,a,o,l,c,void 0,u));return p},e.prototype.beginDirectAnimation=function(e,t,i,r,n,s=1,a,o,l=!1){if(s<0){const e=i;i=r,r=e,s=-s}return i>r&&(s=-s),new c(this,e,i,r,n,s,a,t,o,l)},e.prototype.beginDirectHierarchyAnimation=function(e,t,i,r,n,s,a,o,l,c=!1){const h=e.getDescendants(t),u=[];u.push(this.beginDirectAnimation(e,i,r,n,s,a,o,l,c));for(const e of h)u.push(this.beginDirectAnimation(e,i,r,n,s,a,o,l,c));return u},e.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},e.prototype.getAllAnimatablesByTarget=function(e){const t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},e.prototype.stopAnimation=function(e,t,i){const r=this.getAllAnimatablesByTarget(e);for(const e of r)e.stop(t,i)},e.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const e of this.animationGroups)e.stop()})}p(i(86521).Z,r.$)},13528:(e,t,i)=>{i.d(t,{X5:()=>S,eA:()=>_,nl:()=>g,rq:()=>f,s$:()=>d,vF:()=>m,y4:()=>p});var r=i(54983),n=i(39341),s=i(49111),a=i(88252),o=i(82423),l=i(69346),c=i(78037),h=i(17298),u=i(16265);const d=Object.freeze(new r.PT(0,0,0,0)),p=Object.freeze(r.Pq.Zero()),f=Object.freeze(r.I9.Zero()),m=Object.freeze(c.o.Zero()),_=Object.freeze(n.v9.Black()),g=Object.freeze(new n.ov(0,0,0,0)),v={key:0,repeatCount:0,loopMode:2};class S{static _PrepareAnimation(e,t,i,s,a,o,l,h){let u;if(!isNaN(parseFloat(a))&&isFinite(a)?u=S.ANIMATIONTYPE_FLOAT:a instanceof r.PT?u=S.ANIMATIONTYPE_QUATERNION:a instanceof r.Pq?u=S.ANIMATIONTYPE_VECTOR3:a instanceof r.I9?u=S.ANIMATIONTYPE_VECTOR2:a instanceof n.v9?u=S.ANIMATIONTYPE_COLOR3:a instanceof n.ov?u=S.ANIMATIONTYPE_COLOR4:a instanceof c.o&&(u=S.ANIMATIONTYPE_SIZE),null==u)return null;const d=new S(e,t,i,u,l),p=[{frame:0,value:a},{frame:s,value:o}];return d.setKeys(p),void 0!==h&&d.setEasingFunction(h),d}static CreateAnimation(e,t,i,r){const n=new S(e+"Animation",e,i,t,S.ANIMATIONLOOPMODE_CONSTANT);return n.setEasingFunction(r),n}static CreateAndStartAnimation(e,t,i,r,n,s,a,o,l,c,h){const u=S._PrepareAnimation(e,i,r,n,s,a,o,l);return u?(t.getScene&&(h=t.getScene()),h?h.beginDirectAnimation(t,[u],0,n,1===u.loopMode,1,c):null):null}static CreateAndStartHierarchyAnimation(e,t,i,r,n,s,a,o,l,c,h){const u=S._PrepareAnimation(e,r,n,s,a,o,l,c);return u?t.getScene().beginDirectHierarchyAnimation(t,i,[u],0,s,1===u.loopMode,1,h):null}static CreateMergeAndStartAnimation(e,t,i,r,n,s,a,o,l,c){const h=S._PrepareAnimation(e,i,r,n,s,a,o,l);return h?(t.animations.push(h),t.getScene().beginAnimation(t,0,n,1===h.loopMode,1,c)):null}static MakeAnimationAdditive(e,t,i,n=!1,s){let a;a="object"==typeof t?t:{referenceFrame:t??0,range:i,cloneOriginalAnimation:n,clonedAnimationName:s};let o=e;if(a.cloneOriginalAnimation&&(o=e.clone(),o.name=a.clonedAnimationName||o.name),!o._keys.length)return o;const l=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0;let c=0;const h=o._keys[0];let u=o._keys.length-1;const d=o._keys[u],p={referenceValue:h.value,referencePosition:r.AA.Vector3[0],referenceQuaternion:r.AA.Quaternion[0],referenceScaling:r.AA.Vector3[1],keyPosition:r.AA.Vector3[2],keyQuaternion:r.AA.Quaternion[1],keyScaling:r.AA.Vector3[3]};let f=h.frame,m=d.frame;if(a.range){const e=o.getRange(a.range);e&&(f=e.from,m=e.to)}else f=a.fromFrame??f,m=a.toFrame??m;if(f!==h.frame&&(c=o.createKeyForFrame(f)),m!==d.frame&&(u=o.createKeyForFrame(m)),1===o._keys.length){const e=o._getKeyValue(o._keys[0]);p.referenceValue=e.clone?e.clone():e}else if(l<=h.frame){const e=o._getKeyValue(h.value);p.referenceValue=e.clone?e.clone():e}else if(l>=d.frame){const e=o._getKeyValue(d.value);p.referenceValue=e.clone?e.clone():e}else{v.key=0;const e=o._interpolate(l,v);p.referenceValue=e.clone?e.clone():e}o.dataType===S.ANIMATIONTYPE_QUATERNION?p.referenceValue.normalize().conjugateInPlace():o.dataType===S.ANIMATIONTYPE_MATRIX&&(p.referenceValue.decompose(p.referenceScaling,p.referenceQuaternion,p.referencePosition),p.referenceQuaternion.normalize().conjugateInPlace());let _=Number.MAX_VALUE;const g=a.clipKeys?[]:null;for(let e=c;e<=u;e++){let t=o._keys[e];if((g||a.cloneOriginalAnimation)&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},g&&(_===Number.MAX_VALUE&&(_=t.frame),t.frame-=_,g.push(t))),!e||o.dataType===S.ANIMATIONTYPE_FLOAT||t.value!==h.value)switch(o.dataType){case S.ANIMATIONTYPE_MATRIX:t.value.decompose(p.keyScaling,p.keyQuaternion,p.keyPosition),p.keyPosition.subtractInPlace(p.referencePosition),p.keyScaling.divideInPlace(p.referenceScaling),p.referenceQuaternion.multiplyToRef(p.keyQuaternion,p.keyQuaternion),r.uq.ComposeToRef(p.keyScaling,p.keyQuaternion,p.keyPosition,t.value);break;case S.ANIMATIONTYPE_QUATERNION:p.referenceValue.multiplyToRef(t.value,t.value);break;case S.ANIMATIONTYPE_VECTOR2:case S.ANIMATIONTYPE_VECTOR3:case S.ANIMATIONTYPE_COLOR3:case S.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(p.referenceValue,t.value);break;case S.ANIMATIONTYPE_SIZE:t.value.width-=p.referenceValue.width,t.value.height-=p.referenceValue.height;break;default:t.value-=p.referenceValue}}return g&&o.setKeys(g,!0),o}static TransitionTo(e,t,i,r,n,s,a,o=null){if(a<=0)return i[e]=t,o&&o(),null;const l=n*(a/1e3);s.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:l,value:t}]),i.animations||(i.animations=[]),i.animations.push(s);const c=r.beginAnimation(i,0,l,!1);return c.onAnimationEnd=o,c}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,n,s){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=n,this.enableBlending=s,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=void 0===n?S.ANIMATIONLOOPMODE_CYCLE:n,this.uniqueId=S._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort(((e,t)=>e.frame-t.frame))}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new o.K(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const e=i.from,t=i.to;for(let i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=e&&this._keys[i].frame<=t&&this._keys.splice(i,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return(0,s.Lerp)(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,n){return(0,s.Hermite)(e,t,i,r,n)}quaternionInterpolateFunction(e,t,i){return r.PT.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,n,s){return r.PT.Hermite(e,t,i,n,s).normalize()}vector3InterpolateFunction(e,t,i){return r.Pq.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,n,s){return r.Pq.Hermite(e,t,i,n,s)}vector2InterpolateFunction(e,t,i){return r.I9.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,n,s){return r.I9.Hermite(e,t,i,n,s)}sizeInterpolateFunction(e,t,i){return c.o.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return n.v9.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,s){return n.v9.Hermite(e,t,i,r,s)}color4InterpolateFunction(e,t,i){return n.ov.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,s){return n.ov.Hermite(e,t,i,r,s)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return v.key=0,this._interpolate(e,v)}_interpolate(e,t,i=!1){if(t.loopMode===S.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const r=this._keys,n=r.length;let s=t.key;for(;s>=0&&e<r[s].frame;)--s;for(;s+1<=n-1&&e>=r[s+1].frame;)++s;if(t.key=s,s<0)return i?void 0:this._getKeyValue(r[0].value);if(s+1>n-1)return i?void 0:this._getKeyValue(r[n-1].value);const a=r[s],o=r[s+1];if(i&&(e===a.frame||e===o.frame))return;const l=this._getKeyValue(a.value),c=this._getKeyValue(o.value);if(1===a.interpolation)return o.frame>e?l:c;const h=void 0!==a.outTangent&&void 0!==o.inTangent,u=o.frame-a.frame;let v=(e-a.frame)/u;const x=a.easingFunction||this.getEasingFunction();switch(null!==x&&(v=x.ease(v)),this.dataType){case S.ANIMATIONTYPE_FLOAT:{const e=h?this.floatInterpolateFunctionWithTangents(l,a.outTangent*u,c,o.inTangent*u,v):this.floatInterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case S.ANIMATIONTYPE_QUATERNION:{const e=h?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(u),c,o.inTangent.scale(u),v):this.quaternionInterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||d).scale(t.repeatCount))}return e}case S.ANIMATIONTYPE_VECTOR3:{const e=h?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(u),c,o.inTangent.scale(u),v):this.vector3InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||p).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_VECTOR2:{const e=h?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(u),c,o.inTangent.scale(u),v):this.vector2InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||f).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_SIZE:switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,c,v);case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,c,v).add((t.offsetValue||m).scale(t.repeatCount))}break;case S.ANIMATIONTYPE_COLOR3:{const e=h?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(u),c,o.inTangent.scale(u),v):this.color3InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||_).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_COLOR4:{const e=h?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(u),c,o.inTangent.scale(u),v):this.color4InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||g).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return S.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,c,v,t.workValue):l;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}return 0}matrixInterpolateFunction(e,t,i,n){return S.AllowMatrixDecomposeForInterpolation?n?(r.uq.DecomposeLerpToRef(e,t,i,n),n):r.uq.DecomposeLerp(e,t,i):n?(r.uq.LerpToRef(e,t,i,n),n):r.uq.Lerp(e,t,i)}clone(){const e=new S(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){v.key=0;const t=this._interpolate(e,v,!0);if(!t)return this._keys[v.key].frame===e?v.key:v.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(v.key+1,0,i),v.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let r=0;r<i.length;r++){const n=i[r],s={};switch(s.frame=n.frame,t){case S.ANIMATIONTYPE_FLOAT:s.values=[n.value],void 0!==n.inTangent&&s.values.push(n.inTangent),void 0!==n.outTangent&&(void 0===n.inTangent&&s.values.push(void 0),s.values.push(n.outTangent)),void 0!==n.interpolation&&(void 0===n.inTangent&&s.values.push(void 0),void 0===n.outTangent&&s.values.push(void 0),s.values.push(n.interpolation));break;case S.ANIMATIONTYPE_QUATERNION:case S.ANIMATIONTYPE_MATRIX:case S.ANIMATIONTYPE_VECTOR3:case S.ANIMATIONTYPE_COLOR3:case S.ANIMATIONTYPE_COLOR4:s.values=n.value.asArray(),null!=n.inTangent&&s.values.push(n.inTangent.asArray()),null!=n.outTangent&&(void 0===n.inTangent&&s.values.push(void 0),s.values.push(n.outTangent.asArray())),void 0!==n.interpolation&&(void 0===n.inTangent&&s.values.push(void 0),void 0===n.outTangent&&s.values.push(void 0),s.values.push(n.interpolation))}e.keys.push(s)}e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.ranges.push(r)}return e}static _UniversalLerp(e,t,i){const r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new S(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let a,o;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),o=0;o<e.keys.length;o++){const t=e.keys[o];let l,c,h;switch(i){case S.ANIMATIONTYPE_FLOAT:a=t.values[0],t.values.length>=2&&(l=t.values[1]),t.values.length>=3&&(c=t.values[2]),t.values.length>=4&&(h=t.values[3]);break;case S.ANIMATIONTYPE_QUATERNION:if(a=r.PT.FromArray(t.values),t.values.length>=8){const e=r.PT.FromArray(t.values.slice(4,8));e.equals(r.PT.Zero())||(l=e)}if(t.values.length>=12){const e=r.PT.FromArray(t.values.slice(8,12));e.equals(r.PT.Zero())||(c=e)}t.values.length>=13&&(h=t.values[12]);break;case S.ANIMATIONTYPE_MATRIX:a=r.uq.FromArray(t.values),t.values.length>=17&&(h=t.values[16]);break;case S.ANIMATIONTYPE_COLOR3:a=n.v9.FromArray(t.values),t.values[3]&&(l=n.v9.FromArray(t.values[3])),t.values[4]&&(c=n.v9.FromArray(t.values[4])),t.values[5]&&(h=t.values[5]);break;case S.ANIMATIONTYPE_COLOR4:a=n.ov.FromArray(t.values),t.values[4]&&(l=n.ov.FromArray(t.values[4])),t.values[5]&&(c=n.ov.FromArray(t.values[5])),t.values[6]&&(h=n.ov.FromArray(t.values[6]));break;case S.ANIMATIONTYPE_VECTOR3:default:a=r.Pq.FromArray(t.values),t.values[3]&&(l=r.Pq.FromArray(t.values[3])),t.values[4]&&(c=r.Pq.FromArray(t.values[4])),t.values[5]&&(h=t.values[5])}const u={};u.frame=t.frame,u.value=a,null!=l&&(u.inTangent=l),null!=c&&(u.outTangent=c),null!=h&&(u.interpolation=h),s.push(u)}if(t.setKeys(s),e.ranges)for(o=0;o<e.ranges.length;o++)a=e.ranges[o],t.createRange(a.name,a.from,a.to);return t}static AppendSerializedAnimations(e,t){u.p.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise(((i,r)=>{const n=new h.u;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){let t=JSON.parse(n.responseText);if(t.animations&&(t=t.animations),t.length){const e=[];for(const i of t)e.push(this.Parse(i));i(e)}else{const r=this.Parse(t);e&&(r.name=e),i(r)}}else r("Unable to load the animation")})),n.open("GET",t),n.send()}))}static ParseFromSnippetAsync(e){return new Promise(((t,i)=>{const r=new h.u;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){const i=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(i.animations){const r=JSON.parse(i.animations),n=[];for(const t of r.animations){const i=this.Parse(t);i.snippetId=e,n.push(i)}t(n)}else{const r=JSON.parse(i.animation),n=this.Parse(r);n.snippetId=e,t(n)}}else i("Unable to load the snippet "+e)})),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()}))}}S._UniqueIdGenerator=0,S.AllowMatricesInterpolation=!1,S.AllowMatrixDecomposeForInterpolation=!0,S.SnippetUrl="https://snippet.babylonjs.com",S.ANIMATIONTYPE_FLOAT=0,S.ANIMATIONTYPE_VECTOR3=1,S.ANIMATIONTYPE_QUATERNION=2,S.ANIMATIONTYPE_MATRIX=3,S.ANIMATIONTYPE_COLOR3=4,S.ANIMATIONTYPE_COLOR4=7,S.ANIMATIONTYPE_VECTOR2=5,S.ANIMATIONTYPE_SIZE=6,S.ANIMATIONLOOPMODE_RELATIVE=0,S.ANIMATIONLOOPMODE_CYCLE=1,S.ANIMATIONLOOPMODE_CONSTANT=2,S.ANIMATIONLOOPMODE_YOYO=4,S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,S.CreateFromSnippetAsync=S.ParseFromSnippetAsync,(0,a.Y5)("BABYLON.Animation",S),l.b._AnimationRangeFactory=(e,t,i)=>new o.K(e,t,i)},25530:(e,t,i)=>{i.d(t,{p:()=>r});class r{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new r(this.frame,this.action,this.onlyOnce)}}},5933:(e,t,i)=>{i.r(t),i.d(t,{AnimationGroup:()=>l,TargetedAnimation:()=>o});var r=i(13528),n=i(6740),s=i(69583),a=i(88836);i(46077);class o{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class l{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(this.mask||e){this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];!this.mask||this.mask.disabled||this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}else this._numActiveAnimatables=this._targetedAnimations.length}removeUnmaskedAnimations(){if(this.mask&&!this.mask.disabled){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].fromFrame=this._from}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].toFrame=this._to}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].isAdditive=this._isAdditive}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){return e=e??this._from,((t=t??this._to)-e)/(this.targetedAnimations[0].animation.framePerSecond*this._speedRatio)}static MergeAnimationGroups(e,t=!0,i=!1,r){if(0===e.length)return null;r=r??e[0].weight;let n=Number.MAX_VALUE,s=-Number.MAX_VALUE;if(i)for(const t of e)t.from<n&&(n=t.from),t.to>s&&(s=t.to);const a=new l(e[0].name+"_merged",e[0]._scene,r);for(const r of e){i&&r.normalize(n,s);for(const e of r.targetedAnimations)a.addTargetedAnimation(e.animation,e.target);t&&r.dispose()}return a}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new n.cP,this.onAnimationLoopObservable=new n.cP,this.onAnimationGroupLoopObservable=new n.cP,this.onAnimationGroupEndObservable=new n.cP,this.onAnimationGroupPauseObservable=new n.cP,this.onAnimationGroupPlayObservable=new n.cP,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||s.q.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new o;i.animation=e,i.target=t;const r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),null!==this._enableBlending&&(e.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const r=this._targetedAnimations[i].animation.getKeys(),n=r[0],s=r[r.length-1];if(n.frame>e){const t={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};r.splice(0,0,t)}if(s.frame<t){const e={frame:t,value:s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation};r.push(e)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),this._animationLoopFlags[i]||(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,n){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let s=0;s<this._targetedAnimations.length;s++){const a=this._targetedAnimations[s],o=this._scene.beginDirectAnimation(a.target,[a.animation],void 0!==i?i:this._from,void 0!==r?r:this._to,e,t,void 0,void 0,void 0!==n?n:this._isAdditive);o.weight=this._weight,o.playOrder=this._playOrder,o.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(o)},this._processLoop(o,a,s),this._animatables.push(o)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;const t=this._animatables.slice();for(let i=0;i<t.length;i++)t[i].stop(void 0,void 0,!0,e);let i=0;for(let t=0;t<this._scene._activeAnimatables.length;t++){const r=this._scene._activeAnimatables[t];r._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=r:e&&this._checkAnimationGroupEnded(r,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e,t=!1){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(e,t);return this}getCurrentFrame(){return this.animatables[0]?.masterFrame||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){const i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0)}clone(e,t,i=!1){const r=new l(e||this.name,this._scene,this._weight,this._playOrder);r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask;for(const e of this._targetedAnimations)r.addTargetedAnimation(i?e.animation.clone():e.animation,t?t(e.target):e.target);return r}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return a.Y&&a.Y.HasTags(this)&&(e.tags=a.Y.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new l(e.name,t,e.weight,e.playOrder);for(let n=0;n<e.targetedAnimations.length;n++){const s=e.targetedAnimations[n],a=r.X5.Parse(s.animation),o=s.targetId;if("influence"===s.animation.property){const e=t.getMorphTargetById(o);e&&i.addTargetedAnimation(a,e)}else{const e=t.getNodeById(o);null!=e&&i.addTargetedAnimation(a,e)}}return a.Y&&a.Y.AddTagsTo(i,e.tags),null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),void 0!==e.speedRatio&&(i._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(i._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(i._isAdditive=e.isAdditive),void 0!==e.weight&&(i._weight=e.weight),void 0!==e.playOrder&&(i._playOrder=e.playOrder),void 0!==e.enableBlending&&(i._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(i._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,n=!1,s){let a;a="object"==typeof t?t:{referenceFrame:t,range:i,cloneOriginalAnimationGroup:n,clonedAnimationName:s};let o=e;a.cloneOriginalAnimationGroup&&(o=e.clone(a.clonedAnimationGroupName||o.name));const l=o.targetedAnimations;for(let e=0;e<l.length;e++){const t=l[e];t.animation=r.X5.MakeAnimationAdditive(t.animation,a)}if(o.isAdditive=!0,a.clipKeys){let e=Number.MAX_VALUE,t=-Number.MAX_VALUE;const i=o.targetedAnimations;for(let r=0;r<i.length;r++){const n=i[r].animation.getKeys();e>n[0].frame&&(e=n[0].frame),t<n[n.length-1].frame&&(t=n[n.length-1].frame)}o._from=e,o._to=t}return o}static ClipKeys(e,t,i,r,n){const s=e.clone(r||e.name);return l.ClipKeysInPlace(s,t,i,n)}static ClipKeysInPlace(e,t,i,r){return l.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,n){const s=e.clone(r||e.name);return l.ClipFramesInPlace(s,t,i,n)}static ClipFramesInPlace(e,t,i,r){return l.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,n=!1){let s=Number.MAX_VALUE,a=-Number.MAX_VALUE;const o=e.targetedAnimations;for(let e=0;e<o.length;e++){const l=o[e],c=r?l.animation:l.animation.clone();n&&(c.createKeyForFrame(t),c.createKeyForFrame(i));const h=c.getKeys(),u=[];let d=Number.MAX_VALUE;for(let e=0;e<h.length;e++){const r=h[e];if(!n&&e>=t&&e<=i||n&&r.frame>=t&&r.frame<=i){const e={frame:r.frame,value:r.value.clone?r.value.clone():r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation,lockedTangent:r.lockedTangent};d===Number.MAX_VALUE&&(d=e.frame),e.frame-=d,u.push(e)}}0!==u.length?(s>u[0].frame&&(s=u[0].frame),a<u[u.length-1].frame&&(a=u[u.length-1].frame),c.setKeys(u,!0),l.animation=c):(o.splice(e,1),e--)}return e._from=s,e._to=a,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}},82423:(e,t,i)=>{i.d(t,{K:()=>r});class r{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new r(this.name,this.from,this.to)}}},30966:(e,t,i)=>{i.d(t,{x:()=>s});var r=i(54983),n=i(13528);class s{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===n.X5.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=r.uq.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){const e={frame:0,value:this._minValue};this._keys.splice(0,0,e)}if(this._target instanceof Array){let e=0;for(const t of this._target)this._preparePath(t,e),this._getOriginalValues(e),e++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const a=t.getEvents();a&&a.length>0&&a.forEach((e=>{this._events.push(e._clone())})),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let e=0;e<i.length-1;e++){const t=i[e];if(r=r[t],void 0===r)throw new Error(`Invalid property (${t}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(void 0===this._activeTargets[t][this._targetPath])throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let e=0;for(const t of this._target)void 0!==this._originalValue[e]&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let i=0;i<this._target.length;i++){const r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];t=i.getLocalMatrix&&"_matrix"===this._targetPath?i.getLocalMatrix():i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){const i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,s,a){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const e=t[this._targetPath];e.clone?this._originalBlendValue=e.clone():this._originalBlendValue=e}this._originalBlendValue.m?n.X5.AllowMatrixDecomposeForInterpolation?this._currentValue?r.uq.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=r.uq.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?r.uq.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=r.uq.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=n.X5._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const s=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=s}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:this._currentValue=i?.clone?i.clone():i;-1!==s?this._registerTargetForLateAnimationBinding(this,this._originalValue[a]):this._animationState.loopMode===n.X5.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[a],t[this._targetPath]):t[this._targetPath]=this._originalValue[a]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){const i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);const r=this._events;if(r.length)for(let t=0;t<r.length;t++)r[t].onlyOnce||(r[t].isDone=r[t].frame<e);this._currentFrame=e;const n=this._animation._interpolate(e,this._animationState);this.setValue(n,t)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,s,a=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let u,d=e*(o.framePerSecond*s)/1e3+this._absoluteFrameOffset,p=0,f=!1;const m=r&&this._animationState.loopMode===n.X5.ANIMATIONLOOPMODE_YOYO;if(m){const e=(d-t)/h,i=Math.sin(e*Math.PI);d=Math.abs(i)*h+t;const r=i>=0?1:-1;this._yoyoDirection!==r&&(f=!0),this._yoyoDirection=r}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=d,!r&&i>=t&&(d>=h&&s>0||d<=0&&s<0))c=!1,p=o._getKeyValue(this._maxValue);else if(!r&&t>=i&&(d<=h&&s<0||d>=0&&s>0))c=!1,p=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==n.X5.ANIMATIONLOOPMODE_CYCLE){const e=i.toString()+t.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=n.X5.ANIMATIONLOOPMODE_CYCLE;const r=o._interpolate(t,this._animationState),s=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case n.X5.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=s-r;break;case n.X5.ANIMATIONTYPE_QUATERNION:case n.X5.ANIMATIONTYPE_VECTOR3:case n.X5.ANIMATIONTYPE_VECTOR2:case n.X5.ANIMATIONTYPE_SIZE:case n.X5.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=s.subtract(r)}this._highLimitsCache[e]=s}p=this._highLimitsCache[e],u=this._offsetsCache[e]}if(void 0===u)switch(o.dataType){case n.X5.ANIMATIONTYPE_FLOAT:u=0;break;case n.X5.ANIMATIONTYPE_QUATERNION:u=n.s$;break;case n.X5.ANIMATIONTYPE_VECTOR3:u=n.y4;break;case n.X5.ANIMATIONTYPE_VECTOR2:u=n.rq;break;case n.X5.ANIMATIONTYPE_SIZE:u=n.vF;break;case n.X5.ANIMATIONTYPE_COLOR3:u=n.eA;break;case n.X5.ANIMATIONTYPE_COLOR4:u=n.nl}let _;if(this._host&&this._host.syncRoot){const e=this._host.syncRoot;_=t+h*((e.masterFrame-e.fromFrame)/(e.toFrame-e.fromFrame))}else _=d>0&&t>i||d<0&&t<i?c&&0!==h?i+d%h:t:c&&0!==h?t+d%h:i;const g=this._events;if(!m&&(s>0&&this.currentFrame>_||s<0&&this.currentFrame<_)||m&&f){this._onLoop();for(let e=0;e<g.length;e++)g[e].onlyOnce||(g[e].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=_,this._animationState.repeatCount=0===h?0:d/h|0,this._animationState.highLimitValue=p,this._animationState.offsetValue=u;const v=o._interpolate(_,this._animationState);if(this.setValue(v,a),g.length)for(let e=0;e<g.length;e++)if(h>=0&&_>=g[e].frame&&g[e].frame>=t||h<0&&_<=g[e].frame&&g[e].frame<=t){const t=g[e];t.isDone||(t.onlyOnce&&(g.splice(e,1),e--),t.isDone=!0,t.action(_))}return c||(this._stopped=!0),c}}},36908:(e,t,i)=>{i.d(t,{Y:()=>u});var r=i(25494),n=i(4483),s=i(54983),a=i(43981),o=i(86521),l=(i(26421),i(40505)),c=i(69583),h=i(80770);(0,i(88576).ji)(a.v.NAME_AUDIO,((e,t,i,n)=>{let s,a=[];if(i.sounds=i.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let o=0,l=e.sounds.length;o<l;o++){const l=e.sounds[o];h.$.audioEngine?.canUseWebAudio?(l.url||(l.url=l.name),a[l.url]?i.sounds.push(r.A.Parse(l,t,n,a[l.url])):(s=r.A.Parse(l,t,n),a[l.url]=s,i.sounds.push(s))):i.sounds.push(new r.A(l.name,null,t))}a=[]})),Object.defineProperty(o.Z.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(a.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new n.j(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),o.Z.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks)for(let i=0;i<this.soundTracks.length;i++)for(t=0;t<this.soundTracks[i].soundCollection.length;t++)if(this.soundTracks[i].soundCollection[t].name===e)return this.soundTracks[i].soundCollection[t];return null},Object.defineProperty(o.Z.prototype,"audioEnabled",{get:function(){let e=this._getComponent(a.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(a.v.NAME_AUDIO);t||(t=new u(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(o.Z.prototype,"headphone",{get:function(){let e=this._getComponent(a.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(a.v.NAME_AUDIO);t||(t=new u(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(o.Z.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(a.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(a.v.NAME_AUDIO);if(t||(t=new u(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(o.Z.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(a.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(a.v.NAME_AUDIO);if(t||(t=new u(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(o.Z.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(a.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(a.v.NAME_AUDIO);t||(t=new u(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class u{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=a.v.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new s.Pq,this._cachedCameraPosition=new s.Pq,this._lastCheck=0,this._invertMatrixTemp=new s.uq,this._cameraDirectionTemp=new s.Pq,(e=e||c.q.LastCreatedScene)&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(a.v.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let t=0;t<i.soundCollection.length;t++)e.sounds.push(i.soundCollection[t].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach((e=>{e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)}))}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach((e=>{e.stop(),e.autoplay=!1,this.scene.mainSoundTrack.removeSound(e),t&&e.dispose()}))}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;let t;for(this._audioEnabled=!1,h.$.audioEngine&&h.$.audioEngine.audioContext&&h.$.audioEngine.audioContext.suspend(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;let t;for(this._audioEnabled=!0,h.$.audioEngine&&h.$.audioEngine.audioContext&&h.$.audioEngine.audioContext.resume(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=l.j.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;const i=h.$.audioEngine;if(i&&i.audioContext){let e,r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){const e=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const e=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),s.Pq.TransformNormalToRef(u._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){const i=t.mainSoundTrack.soundCollection[e];i.useCustomAttenuation&&i.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++){const r=t.soundTracks[e].soundCollection[i];r.useCustomAttenuation&&r.updateDistanceFromListener()}}}}u._CameraDirection=new s.Pq(0,0,-1),r.A._SceneComponentInitialization=e=>{let t=e._getComponent(a.v.NAME_AUDIO);t||(t=new u(e),e._addComponent(t))}},25494:(e,t,i)=>{i.d(t,{A:()=>u});var r=i(90066),n=i(6740),s=i(54983),a=i(70461),o=i(60299),l=i(69583),c=i(88252),h=i(80770);class u{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(h.$.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){const e=this.isPaused?0:h.$.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+e}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,o=null,c){if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new n.cP,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=s.Pq.Zero(),this._localDirection=new s.Pq(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||l.q.LastCreatedScene)if(this._scene=i,u._SceneComponentInitialization(i),this._readyToPlayCallback=o,this._customAttenuationFunction=(e,t,i,r,n)=>t<i?e*(1-t/i):0,c&&(this.autoplay=c.autoplay||!1,this._loop=c.loop||!1,void 0!==c.volume&&(this._volume=c.volume),this._spatialSound=c.spatialSound??!1,this.maxDistance=c.maxDistance??100,this.useCustomAttenuation=c.useCustomAttenuation??!1,this.rolloffFactor=c.rolloffFactor||1,this.refDistance=c.refDistance||1,this.distanceModel=c.distanceModel||"linear",this._playbackRate=c.playbackRate||1,this._streaming=c.streaming??!1,this._length=c.length,this._offset=c.offset),h.$.audioEngine?.canUseWebAudio&&h.$.audioEngine.audioContext){this._soundGain=h.$.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let e=!0;if(t)try{"string"==typeof t?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let i=[],n=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=h.$.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=h.$.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(n=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":i.push(t);case"Array":0===i.length&&(i=t);for(let e=0;e<i.length;e++){const t=i[e];if(n=c&&c.skipCodecCheck||-1!==t.indexOf(".mp3",t.length-4)&&h.$.audioEngine.isMP3supported||-1!==t.indexOf(".ogg",t.length-4)&&h.$.audioEngine.isOGGsupported||-1!==t.indexOf(".wav",t.length-4)||-1!==t.indexOf(".m4a",t.length-4)||-1!==t.indexOf(".mp4",t.length-4)||-1!==t.indexOf("blob:"),n){this._streaming?(this._htmlAudioElement=new Audio(t),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,r.S0.SetCorsBehavior(t,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",(()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(t,(e=>{this._soundLoaded(e)}),void 0,!0,!0,(e=>{e&&a.V.Error("XHR "+e.status+" error on: "+t+"."),a.V.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}));break}}break;default:e=!1}e?n||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout((()=>{this._readyToPlayCallback&&this._readyToPlayCallback()}),1e3)):a.V.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(e){a.V.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),h.$.audioEngine&&!h.$.audioEngine.WarnedWebAudioUnsupported&&(a.V.Error("Web Audio is not supported by your browser."),h.$.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout((()=>{this._readyToPlayCallback&&this._readyToPlayCallback()}),1e3)}dispose(){h.$.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){h.$.audioEngine?.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){h.$.audioEngine?.audioContext&&h.$.audioEngine.audioContext.decodeAudioData(e,(e=>{this._audioBufferLoaded(e)}),(e=>{a.V.Error("Error while decoding audio data for: "+this.name+" / Error: "+e)}))}setAudioBuffer(e){h.$.audioEngine?.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))))}_createSpatialParameters(){h.$.audioEngine?.canUseWebAudio&&h.$.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??h.$.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){h.$.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){h.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){t<e?a.V.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length)))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e)return void a.V.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e,h.$.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle)return void a.V.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e,h.$.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){e.equals(this._position)||(this._position.copyFrom(e),h.$.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){this._localDirection=e,h.$.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=s.Pq.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){if(h.$.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){if(this._isReadyToPlay&&this._scene.audioEnabled&&h.$.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let r=e?h.$.audioEngine?.audioContext.currentTime+e:h.$.audioEngine?.audioContext.currentTime;if(this._soundSource&&this._streamingSource||this._spatialSound&&this._soundPanner&&(isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=h.$.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){const e=()=>{if(h.$.audioEngine?.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=t??0;const i=this._htmlAudioElement.play();void 0!==i&&i.catch((()=>{h.$.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=h.$.audioEngine?.onAudioUnlockedObservable.addOnce((()=>{e()})))}))}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=h.$.audioEngine?.onAudioUnlockedObservable.addOnce((()=>{e()})))};e()}}else{const n=()=>{if(h.$.audioEngine?.audioContext){if(i=i||this._length,void 0!==t&&this._setOffset(t),this._soundSource){const e=this._soundSource;e.onended=()=>{e.disconnect()}}if(this._soundSource=h.$.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,void 0!==t&&(this._soundSource.loopStart=t),void 0!==i&&(this._soundSource.loopEnd=(0|t)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},r=e?h.$.audioEngine?.audioContext.currentTime+e:h.$.audioEngine.audioContext.currentTime;const n=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(r,n,this.loop?void 0:i)}}};"suspended"===h.$.audioEngine?.audioContext.state?this._tryToPlayTimeout=setTimeout((()=>{"suspended"===h.$.audioEngine?.audioContext.state?(h.$.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=h.$.audioEngine.onAudioUnlockedObservable.addOnce((()=>{n()})))):n()}),500):n()}this._startTime=r,this.isPlaying=!0,this.isPaused=!1}catch(e){a.V.Error("Error while trying to play audio: "+this.name+", "+e.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource?.disconnect(),this.isPlaying=!1;else if(h.$.audioEngine?.audioContext&&this._soundSource){const t=e?h.$.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(t)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource?.disconnect(),this.isPlaying=!1,this.isPaused=!0):h.$.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=h.$.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){h.$.audioEngine?.canUseWebAudio&&this._soundGain&&(t&&h.$.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(h.$.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,h.$.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,h.$.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){if(e.getBoundingInfo){const t=e.getBoundingInfo();this.setPosition(t.boundingSphere.centerWorld)}else this.setPosition(e.absolutePosition);h.$.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new u(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){const n=e.name;let a;a=e.url?i+e.url:i+n;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(r){const e=()=>{r._isReadyToPlay?(l._audioBuffer=r.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):setTimeout(e,300)};l=new u(n,new ArrayBuffer(0),t,null,o),e()}else l=new u(n,a,t,(()=>{t.removePendingData(l)}),o),t.addPendingData(l);if(e.position){const t=s.Pq.FromArray(e.position);l.setPosition(t)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const t=s.Pq.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(t)}if(e.connectedMeshId){const i=t.getMeshById(e.connectedMeshId);i&&l.attachToMesh(i)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(h.$.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}u._SceneComponentInitialization=e=>{throw(0,o.n)("AudioSceneComponent")},(0,c.Y5)("BABYLON.Sound",u)},4483:(e,t,i)=>{i.d(t,{j:()=>s});var r=i(69583),n=i(80770);class s{constructor(e,t={}){this.id=-1,this._isInitialized=!1,(e=e||r.q.LastCreatedScene)&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){n.$.audioEngine?.canUseWebAudio&&n.$.audioEngine.audioContext&&(this._outputAudioNode=n.$.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(n.$.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(n.$.audioEngine&&n.$.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),n.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1)}setVolume(e){n.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(n.$.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(n.$.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,n.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,n.$.audioEngine.masterGain))}}},15265:(e,t,i)=>{i.d(t,{r:()=>n});var r=i(70461);class n{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let r=0;for(const e of i)r+=e;const n=r>0?1/r:0;for(let e=0;e<this._weights.length;e++)this._weights[e]*=n;this._sounds=t;for(const e of this._sounds)e.onEndedObservable.add((()=>{this._onended()}))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void r.V.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void r.V.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const e=Math.random();let t=0;for(let i=0;i<this._weights.length;i++)if(t+=this._weights[i],e<=t){this._currentIndex=i;break}}const t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}},16318:(e,t,i)=>{i.d(t,{D:()=>c});var r=i(86521),n=i(31780),s=i(54983),a=i(6740),o=i(34116),l=i(63832);class c{constructor(){this._attachedToElement=!1,this._virtualMeshesInfo={},this._tmpVector=new s.Pq,this._tmpQuaternion=new s.PT,this._dragType={NONE:0,DRAG:1,DRAG_WITH_CONTROLLER:2,NEAR_DRAG:3},this._moving=!1,this._dragging=this._dragType.NONE,this.draggableMeshes=null,this.zDragFactor=3,this.currentDraggingPointerIds=[],this.detachCameraControls=!0,this.onDragStartObservable=new a.cP,this.onDragObservable=new a.cP,this.onDragEndObservable=new a.cP,this.allowMultiPointer=!0}get currentDraggingPointerId(){return void 0!==this.currentDraggingPointerIds[0]?this.currentDraggingPointerIds[0]:-1}set currentDraggingPointerId(e){this.currentDraggingPointerIds[0]=e}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}get name(){return"BaseSixDofDrag"}get isMoving(){return this._moving}init(){}get _pointerCamera(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera}_createVirtualMeshInfo(){const e=new o.V("",c._virtualScene);e.rotationQuaternion=new s.PT;const t=new o.V("",c._virtualScene);t.rotationQuaternion=new s.PT;const i=new o.V("",c._virtualScene);return i.rotationQuaternion=new s.PT,{dragging:!1,moving:!1,dragMesh:e,originMesh:t,pivotMesh:i,startingPivotPosition:new s.Pq,startingPivotOrientation:new s.PT,startingPosition:new s.Pq,startingOrientation:new s.PT,lastOriginPosition:new s.Pq,lastDragPosition:new s.Pq}}_resetVirtualMeshesPosition(){for(let e=0;e<this.currentDraggingPointerIds.length;e++)this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.rotationQuaternion)}_pointerUpdate2D(e,t,i){!this._pointerCamera||this._pointerCamera.cameraRigMode!=l.i.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||(e.origin.copyFrom(this._pointerCamera.globalPosition),i=0);const r=this._virtualMeshesInfo[t],n=s.AA.Vector3[0];e.origin.subtractToRef(r.lastOriginPosition,n),r.lastOriginPosition.copyFrom(e.origin);const a=-s.Pq.Dot(n,e.direction);r.originMesh.addChild(r.dragMesh),r.originMesh.addChild(r.pivotMesh),this._applyZOffset(r.dragMesh,a,i),this._applyZOffset(r.pivotMesh,a,i),r.originMesh.position.copyFrom(e.origin);const o=s.AA.Vector3[0];e.origin.addToRef(e.direction,o),r.originMesh.lookAt(o),r.originMesh.removeChild(r.dragMesh),r.originMesh.removeChild(r.pivotMesh)}_pointerUpdateXR(e,t,i,r){const n=this._virtualMeshesInfo[i];if(n.originMesh.position.copyFrom(e.position),this._dragging===this._dragType.NEAR_DRAG&&t?n.originMesh.rotationQuaternion.copyFrom(t.rotationQuaternion):n.originMesh.rotationQuaternion.copyFrom(e.rotationQuaternion),n.pivotMesh.computeWorldMatrix(!0),n.dragMesh.computeWorldMatrix(!0),0!==r){const e=s.AA.Vector3[0],t=s.AA.Vector3[1];e.copyFrom(this._pointerCamera.getForwardRay().direction),n.originMesh.position.subtractToRef(n.lastOriginPosition,t),n.lastOriginPosition.copyFrom(n.originMesh.position);const i=t.length();t.normalize();const a=s.AA.Vector3[2],o=s.AA.Vector3[3];n.dragMesh.absolutePosition.subtractToRef(this._pointerCamera.globalPosition,a),n.dragMesh.absolutePosition.subtractToRef(n.originMesh.position,o);const l=o.length();a.normalize(),o.normalize();let c=Math.abs(s.Pq.Dot(t,o))*s.Pq.Dot(t,e)*r*i*l;const h=.01;c<0&&h-l>c&&(c=Math.min(h-l,0)),o.scaleInPlace(c),o.addToRef(n.pivotMesh.absolutePosition,this._tmpVector),n.pivotMesh.setAbsolutePosition(this._tmpVector),o.addToRef(n.dragMesh.absolutePosition,this._tmpVector),n.dragMesh.setAbsolutePosition(this._tmpVector)}}attach(e){this._ownerNode=e,this._scene=this._ownerNode.getScene(),c._virtualScene||(c._virtualScene=new r.Z(this._scene.getEngine(),{virtual:!0}),c._virtualScene.detachControl());const t=e=>this._ownerNode===e||e.isDescendantOf(this._ownerNode)&&(!this.draggableMeshes||-1!==this.draggableMeshes.indexOf(e));this._pointerObserver=this._scene.onPointerObservable.add((e=>{const i=e.event.pointerId;this._virtualMeshesInfo[i]||(this._virtualMeshesInfo[i]=this._createVirtualMeshInfo());const r=this._virtualMeshesInfo[i],s="xr-near"===e.event.pointerType||"xr"===e.event.pointerType;if(e.type==n.Zp.POINTERDOWN){if(!r.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&(!s||e.pickInfo.aimTransform)&&t(e.pickInfo.pickedMesh)){if((!this.allowMultiPointer||s)&&this.currentDraggingPointerIds.length>0)return;!this._pointerCamera||this._pointerCamera.cameraRigMode!==l.i.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||e.pickInfo.ray.origin.copyFrom(this._pointerCamera.globalPosition),this._ownerNode.computeWorldMatrix(!0);const t=this._virtualMeshesInfo[i];s?(this._dragging=e.pickInfo.originMesh?this._dragType.NEAR_DRAG:this._dragType.DRAG_WITH_CONTROLLER,t.originMesh.position.copyFrom(e.pickInfo.aimTransform.position),this._dragging===this._dragType.NEAR_DRAG&&e.pickInfo.gripTransform?t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.gripTransform.rotationQuaternion):t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.aimTransform.rotationQuaternion)):(this._dragging=this._dragType.DRAG,t.originMesh.position.copyFrom(e.pickInfo.ray.origin)),t.lastOriginPosition.copyFrom(t.originMesh.position),t.dragMesh.position.copyFrom(e.pickInfo.pickedPoint),t.lastDragPosition.copyFrom(e.pickInfo.pickedPoint),t.pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),t.pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),t.startingPosition.copyFrom(t.dragMesh.position),t.startingPivotPosition.copyFrom(t.pivotMesh.position),t.startingOrientation.copyFrom(t.dragMesh.rotationQuaternion),t.startingPivotOrientation.copyFrom(t.pivotMesh.rotationQuaternion),s?(t.originMesh.addChild(t.dragMesh),t.originMesh.addChild(t.pivotMesh)):t.originMesh.lookAt(t.dragMesh.position),t.dragging=!0,-1===this.currentDraggingPointerIds.indexOf(i)&&this.currentDraggingPointerIds.push(i),this.detachCameraControls&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.inputs&&this._pointerCamera.inputs.attachedToElement?(this._pointerCamera.detachControl(),this._attachedToElement=!0):this.allowMultiPointer&&0!==this.currentDraggingPointerIds.length||(this._attachedToElement=!1)),this._targetDragStart(t.pivotMesh.position,t.pivotMesh.rotationQuaternion,i),this.onDragStartObservable.notifyObservers({position:t.pivotMesh.position})}}else if(e.type==n.Zp.POINTERUP||e.type==n.Zp.POINTERDOUBLETAP){const e=this.currentDraggingPointerIds.indexOf(i);r.dragging=!1,-1!==e&&(this.currentDraggingPointerIds.splice(e,1),0===this.currentDraggingPointerIds.length&&(this._moving=!1,this._dragging=this._dragType.NONE,this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1)),r.originMesh.removeChild(r.dragMesh),r.originMesh.removeChild(r.pivotMesh),this._targetDragEnd(i),this.onDragEndObservable.notifyObservers({}))}else if(e.type==n.Zp.POINTERMOVE&&-1!==this.currentDraggingPointerIds.indexOf(i)&&r.dragging&&e.pickInfo&&(e.pickInfo.ray||e.pickInfo.aimTransform)){let t=this.zDragFactor;(this.currentDraggingPointerIds.length>1||e.pickInfo.originMesh)&&(t=0),this._ownerNode.computeWorldMatrix(!0),s?this._pointerUpdateXR(e.pickInfo.aimTransform,e.pickInfo.gripTransform,i,t):this._pointerUpdate2D(e.pickInfo.ray,i,t),this._tmpQuaternion.copyFrom(r.startingPivotOrientation),this._tmpQuaternion.x=-this._tmpQuaternion.x,this._tmpQuaternion.y=-this._tmpQuaternion.y,this._tmpQuaternion.z=-this._tmpQuaternion.z,r.pivotMesh.absoluteRotationQuaternion.multiplyToRef(this._tmpQuaternion,this._tmpQuaternion),r.pivotMesh.absolutePosition.subtractToRef(r.startingPivotPosition,this._tmpVector),this.onDragObservable.notifyObservers({delta:this._tmpVector,position:r.pivotMesh.position,pickInfo:e.pickInfo}),this._targetDrag(this._tmpVector,this._tmpQuaternion,i),r.lastDragPosition.copyFrom(r.dragMesh.absolutePosition),this._moving=!0}}))}_applyZOffset(e,t,i){e.position.z-=e.position.z<1?t*i:t*i*e.position.z,e.position.z<0&&(e.position.z=0)}_targetDragStart(e,t,i){}_targetDrag(e,t,i){}_targetDragEnd(e){}_reattachCameraControls(){if(this._pointerCamera)if("ArcRotateCamera"===this._pointerCamera.getClassName()){const e=this._pointerCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._pointerCamera.attachControl(!this._pointerCamera.inputs||this._pointerCamera.inputs.noPreventDefault)}detach(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver));for(const e in this._virtualMeshesInfo)this._virtualMeshesInfo[e].originMesh.dispose(),this._virtualMeshesInfo[e].dragMesh.dispose();this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()}}},54321:(e,t,i)=>{i.d(t,{_:()=>r});class r{get delay(){return this.fadeInDelay}set delay(e){this.fadeInDelay=e,this.fadeOutDelay=e}constructor(){this.fadeInDelay=0,this.fadeOutDelay=0,this.fadeInTime=300,this.fadeOutTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._delay=0,this._time=300,this._update=()=>{if(this._ownerNode){if(this._hoverValue+=this._hovered?this._millisecondsPerFrame:-this._millisecondsPerFrame,this._setAllVisibility(this._ownerNode,(this._hoverValue-this._delay)/this._time),this._ownerNode.visibility>1){if(this._setAllVisibility(this._ownerNode,1),this._hoverValue>this._time)return this._hoverValue=this._time,void this._detachObserver()}else if(this._ownerNode.visibility<0&&(this._setAllVisibility(this._ownerNode,0),this._hoverValue<0))return this._hoverValue=0,void this._detachObserver();this._attachObserver()}}}get name(){return"FadeInOut"}init(){}attach(e){this._ownerNode=e,this._setAllVisibility(this._ownerNode,0)}detach(){this._ownerNode=null}fadeIn(e=!0){this._delay=e?this.fadeInDelay:this.fadeOutDelay,this._time=e?this.fadeInTime:this.fadeOutTime,this._detachObserver(),this._ownerNode&&(e&&this._ownerNode.visibility>=1||!e&&this._ownerNode.visibility<=0)||(this._hovered=e,this._hovered||(this._delay*=-1),this._ownerNode.visibility>=1?this._hoverValue=this._time:this._ownerNode.visibility<=0&&(this._hoverValue=0),this._update())}fadeOut(){this.fadeIn(!1)}_setAllVisibility(e,t){e.visibility=t,e.getChildMeshes().forEach((e=>{this._setAllVisibility(e,t)}))}_attachObserver(){this._onBeforeRenderObserver||(this._onBeforeRenderObserver=this._ownerNode?.getScene().onBeforeRenderObservable.add(this._update))}_detachObserver(){this._onBeforeRenderObserver&&(this._ownerNode?.getScene().onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=null)}}},39485:(e,t,i)=>{i.d(t,{S:()=>a});var r=i(54983),n=i(49111),s=i(50507);class a{constructor(){this._tmpQuaternion=new r.PT,this._tmpVectors=[new r.Pq,new r.Pq,new r.Pq,new r.Pq,new r.Pq,new r.Pq,new r.Pq],this._tmpMatrix=new r.uq,this._tmpInvertView=new r.uq,this._tmpForward=new r.Pq,this._tmpNodeForward=new r.Pq,this._tmpPosition=new r.Pq,this._workingPosition=new r.Pq,this._workingQuaternion=new r.PT,this._lastTick=-1,this._recenterNextUpdate=!0,this.interpolatePose=!0,this.lerpTime=500,this.ignoreCameraPitchAndRoll=!1,this.pitchOffset=15,this.maxViewVerticalDegrees=30,this.maxViewHorizontalDegrees=30,this.orientToCameraDeadzoneDegrees=60,this.ignoreDistanceClamp=!1,this.ignoreAngleClamp=!1,this.verticalMaxDistance=0,this.defaultDistance=.8,this.maximumDistance=2,this.minimumDistance=.3,this.useFixedVerticalOffset=!1,this.fixedVerticalOffset=0,this._enabled=!0}get followedCamera(){return this._followedCamera||this._scene.activeCamera}set followedCamera(e){this._followedCamera=e}get name(){return"Follow"}init(){}attach(e,t){this._scene=e.getScene(),this.attachedNode=e,t&&(this.followedCamera=t),this._addObservables()}detach(){this.attachedNode=null,this._removeObservables()}recenter(){this._recenterNextUpdate=!0}_angleBetweenVectorAndPlane(e,t){return this._tmpVectors[0].copyFrom(e),e=this._tmpVectors[0],this._tmpVectors[1].copyFrom(t),t=this._tmpVectors[1],e.normalize(),t.normalize(),Math.PI/2-Math.acos(r.Pq.Dot(e,t))}_length2D(e){return Math.sqrt(e.x*e.x+e.z*e.z)}_distanceClamp(e,t=!1){let i=this.minimumDistance,r=this.maximumDistance;const s=this.defaultDistance,a=this._tmpVectors[0];a.copyFrom(e);let o=a.length();if(a.normalizeFromLength(o),this.ignoreCameraPitchAndRoll){i=this._length2D(a)*i,r=this._length2D(a)*r;const t=this._length2D(e);a.scaleInPlace(o/t),o=t}let l=o;return l=t?s:(0,n.Clamp)(o,i,r),e.copyFrom(a).scaleInPlace(l),o!==l}_applyVerticalClamp(e){0!==this.verticalMaxDistance&&(e.y=(0,n.Clamp)(e.y,-this.verticalMaxDistance,this.verticalMaxDistance))}_toOrientationQuatToRef(e,t){r.PT.RotationYawPitchRollToRef(Math.atan2(e.x,e.z),Math.atan2(e.y,Math.sqrt(e.z*e.z+e.x*e.x)),0,t)}_applyPitchOffset(e){const t=this._tmpVectors[0],i=this._tmpVectors[1];t.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),i.copyFromFloats(1,0,0),r.Pq.TransformNormalToRef(t,e,t),t.y=0,t.normalize(),r.Pq.TransformNormalToRef(i,e,i),r.PT.RotationAxisToRef(i,this.pitchOffset*Math.PI/180,this._tmpQuaternion),t.rotateByQuaternionToRef(this._tmpQuaternion,t),this._toOrientationQuatToRef(t,this._tmpQuaternion),this._tmpQuaternion.toRotationMatrix(this._tmpMatrix),e.copyFrom(this._tmpMatrix)}_angularClamp(e,t){const i=this._tmpVectors[5];i.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1);const n=this._tmpVectors[6];n.copyFromFloats(1,0,0),r.Pq.TransformNormalToRef(i,e,i),r.Pq.TransformNormalToRef(n,e,n);const a=r.Pq.UpReadOnly;if(t.length()<s.bH)return!1;let o=!1;const l=this._tmpQuaternion;if(this.ignoreCameraPitchAndRoll){const e=r.Pq.GetAngleBetweenVectorsOnPlane(t,i,n);r.PT.RotationAxisToRef(n,e,l),t.rotateByQuaternionToRef(l,t)}else{const e=-r.Pq.GetAngleBetweenVectorsOnPlane(t,i,n),s=this.maxViewVerticalDegrees*Math.PI/180*.5;e<-s?(r.PT.RotationAxisToRef(n,-e-s,l),t.rotateByQuaternionToRef(l,t),o=!0):e>s&&(r.PT.RotationAxisToRef(n,-e+s,l),t.rotateByQuaternionToRef(l,t),o=!0)}const c=this._angleBetweenVectorAndPlane(t,n)*(this._scene.useRightHandedSystem?-1:1),h=this.maxViewHorizontalDegrees*Math.PI/180*.5;return c<-h?(r.PT.RotationAxisToRef(a,-c-h,l),t.rotateByQuaternionToRef(l,t),o=!0):c>h&&(r.PT.RotationAxisToRef(a,-c+h,l),t.rotateByQuaternionToRef(l,t),o=!0),o}_orientationClamp(e,t){const i=this._tmpVectors[0];i.copyFrom(e).scaleInPlace(-1).normalize();const n=this._tmpVectors[1],a=this._tmpVectors[2];n.copyFromFloats(0,1,0),r.Pq.CrossToRef(i,n,a);const o=a.length();o<s.bH||(a.normalizeFromLength(o),r.Pq.CrossToRef(a,i,n),this.attachedNode?.getScene().useRightHandedSystem?r.PT.FromLookDirectionRHToRef(i,n,t):r.PT.FromLookDirectionLHToRef(i,n,t))}_passedOrientationDeadzone(e,t){const i=this._tmpVectors[5];return i.copyFrom(e),i.normalize(),180*Math.abs(r.Pq.GetAngleBetweenVectorsOnPlane(t,i,r.Pq.UpReadOnly))/Math.PI>this.orientToCameraDeadzoneDegrees}_updateLeashing(e){if(this.attachedNode&&this._enabled){const t=this.attachedNode.parent;this.attachedNode.setParent(null);const i=this.attachedNode.getWorldMatrix(),n=this._workingPosition,s=this._workingQuaternion,a=this.attachedNode.getPivotPoint(),o=this._tmpInvertView;o.copyFrom(e.getViewMatrix()),o.invert(),r.Pq.TransformCoordinatesToRef(a,i,n);const l=this._tmpPosition;l.copyFromFloats(0,0,0),r.Pq.TransformCoordinatesToRef(l,i,l),l.scaleInPlace(-1).subtractInPlace(a),n.subtractInPlace(e.globalPosition),this.ignoreCameraPitchAndRoll&&this._applyPitchOffset(o);let c=!1;const h=this._tmpForward;h.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),r.Pq.TransformNormalToRef(h,o,h);const u=this._tmpNodeForward;if(u.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),r.Pq.TransformNormalToRef(u,i,u),this._recenterNextUpdate)n.copyFrom(h).scaleInPlace(this.defaultDistance);else if(this.ignoreAngleClamp){const e=n.length();n.copyFrom(h).scaleInPlace(e)}else c=this._angularClamp(o,n);let d=!1;this.ignoreDistanceClamp||(d=this._distanceClamp(n,c),this._applyVerticalClamp(n)),this.useFixedVerticalOffset&&(n.y=l.y-e.globalPosition.y+this.fixedVerticalOffset),(c||d||this._passedOrientationDeadzone(n,u)||this._recenterNextUpdate)&&this._orientationClamp(n,s),this._workingPosition.subtractInPlace(a),this._recenterNextUpdate=!1,this.attachedNode.setParent(t)}}_updateTransformToGoal(e){if(!this.attachedNode||!this.followedCamera||!this._enabled)return;this.attachedNode.rotationQuaternion||(this.attachedNode.rotationQuaternion=r.PT.Identity());const t=this.attachedNode.parent;if(this.attachedNode.setParent(null),!this.interpolatePose)return this.attachedNode.position.copyFrom(this.followedCamera.globalPosition).addInPlace(this._workingPosition),void this.attachedNode.rotationQuaternion.copyFrom(this._workingQuaternion);const i=new r.Pq;i.copyFrom(this.attachedNode.position).subtractInPlace(this.followedCamera.globalPosition),r.Pq.SmoothToRef(i,this._workingPosition,e,this.lerpTime,i),i.addInPlace(this.followedCamera.globalPosition),this.attachedNode.position.copyFrom(i);const n=new r.PT;n.copyFrom(this.attachedNode.rotationQuaternion),r.PT.SmoothToRef(n,this._workingQuaternion,e,this.lerpTime,this.attachedNode.rotationQuaternion),this.attachedNode.setParent(t)}_addObservables(){this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{if(!this.followedCamera)return;const e=Date.now();this._updateLeashing(this.followedCamera),this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._onBeforeRender&&this._scene.onBeforeRenderObservable.remove(this._onBeforeRender)}}},90594:(e,t,i)=>{i.d(t,{Re:()=>c,VF:()=>s,d9:()=>n,rf:()=>r});var r,n,s,a=i(39653),o=i(54983),l=i(90066);!function(e){e[e.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",e[e.RADIAL_SIDE=1]="RADIAL_SIDE",e[e.ULNAR_SIDE=2]="ULNAR_SIDE",e[e.BELOW_WRIST=3]="BELOW_WRIST"}(r||(r={})),function(e){e[e.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",e[e.HAND_ROTATION=1]="HAND_ROTATION"}(n||(n={})),function(e){e[e.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",e[e.PALM_UP=1]="PALM_UP",e[e.GAZE_FOCUS=2]="GAZE_FOCUS",e[e.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(s||(s={}));class c{constructor(){this._sceneRenderObserver=null,this._zoneAxis={},this.handConstraintVisibility=3,this.palmUpStrictness=.95,this.gazeProximityRadius=.15,this.targetOffset=.1,this.targetZone=2,this.zoneOrientationMode=1,this.nodeOrientationMode=1,this.handedness="none",this.lerpTime=100,this._zoneAxis[0]=new o.Pq(0,1,0),this._zoneAxis[1]=new o.Pq(-1,0,0),this._zoneAxis[2]=new o.Pq(1,0,0),this._zoneAxis[3]=new o.Pq(0,-1,0)}get name(){return"HandConstraint"}enable(){this._node.setEnabled(!0)}disable(){this._node.setEnabled(!1)}_getHandPose(){if(!this._handTracking)return null;let e;if(e="none"===this.handedness?this._handTracking.getHandByHandedness("left")||this._handTracking.getHandByHandedness("right"):this._handTracking.getHandByHandedness(this.handedness),e){const t=e.getJointMesh("pinky-finger-metacarpal"),i=e.getJointMesh("middle-finger-metacarpal"),r=e.getJointMesh("wrist");if(r&&i&&t){const n={position:i.absolutePosition,quaternion:new o.PT,id:e.xrController.uniqueId},s=o.AA.Vector3[0],a=o.AA.Vector3[1],l=o.AA.Vector3[2];return s.copyFrom(i.absolutePosition).subtractInPlace(r.absolutePosition).normalize(),a.copyFrom(t.absolutePosition).subtractInPlace(i.absolutePosition).normalize(),o.Pq.CrossToRef(s,a,a),o.Pq.CrossToRef(a,s,l),o.PT.FromLookDirectionLHToRef(a,s,n.quaternion),n}}return null}init(){}attach(e){this._node=e,this._scene=e.getScene(),this._node.rotationQuaternion||(this._node.rotationQuaternion=o.PT.RotationYawPitchRoll(this._node.rotation.y,this._node.rotation.x,this._node.rotation.z));let t=Date.now();this._sceneRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{const e=this._getHandPose();if(this._node.reservedDataStore=this._node.reservedDataStore||{},this._node.reservedDataStore.nearInteraction=this._node.reservedDataStore.nearInteraction||{},this._node.reservedDataStore.nearInteraction.excludedControllerId=null,e){const i=o.AA.Vector3[0],r=this._scene.activeCamera;i.copyFrom(this._zoneAxis[this.targetZone]);const n=o.AA.Quaternion[0];if(r&&(0===this.zoneOrientationMode||0===this.nodeOrientationMode)){const t=o.AA.Vector3[1];t.copyFrom(r.position).subtractInPlace(e.position).normalize(),this._scene.useRightHandedSystem?o.PT.FromLookDirectionRHToRef(t,o.Pq.UpReadOnly,n):o.PT.FromLookDirectionLHToRef(t,o.Pq.UpReadOnly,n)}1===this.zoneOrientationMode?e.quaternion.toRotationMatrix(o.AA.Matrix[0]):n.toRotationMatrix(o.AA.Matrix[0]),o.Pq.TransformNormalToRef(i,o.AA.Matrix[0],i),i.scaleInPlace(this.targetOffset);const s=o.AA.Vector3[2],a=o.AA.Quaternion[1];s.copyFrom(e.position).addInPlace(i),1===this.nodeOrientationMode?a.copyFrom(e.quaternion):a.copyFrom(n);const l=Date.now()-t;o.Pq.SmoothToRef(this._node.position,s,l,this.lerpTime,this._node.position),o.PT.SmoothToRef(this._node.rotationQuaternion,a,l,this.lerpTime,this._node.rotationQuaternion),this._node.reservedDataStore.nearInteraction.excludedControllerId=e.id}this._setVisibility(e),t=Date.now()}))}_setVisibility(e){let t=!0,i=!0;const r=this._scene.activeCamera;if(r){const n=r.getForwardRay();if(2===this.handConstraintVisibility||3===this.handConstraintVisibility){let t;i=!1,this._eyeTracking&&(t=this._eyeTracking.getEyeGaze()),t=t||n;const r=o.AA.Vector3[0];e?e.position.subtractToRef(t.origin,r):this._node.getAbsolutePosition().subtractToRef(t.origin,r);const s=o.Pq.Dot(r,t.direction),a=s*s;s>0&&r.lengthSquared()-a<this.gazeProximityRadius*this.gazeProximityRadius&&(i=!0)}if((1===this.handConstraintVisibility||3===this.handConstraintVisibility)&&(t=!1,e)){const i=o.AA.Vector3[0];o.Pq.LeftHandedForwardReadOnly.rotateByQuaternionToRef(e.quaternion,i),o.Pq.Dot(i,n.direction)>2*this.palmUpStrictness-1&&(t=!0)}}this._node.setEnabled(t&&i)}detach(){this._scene.onBeforeRenderObservable.remove(this._sceneRenderObserver)}linkToXRExperience(e){const t=e.featuresManager?e.featuresManager:e;if(t){try{this._eyeTracking=t.getEnabledFeature(a._.EYE_TRACKING)}catch{}try{this._handTracking=t.getEnabledFeature(a._.HAND_TRACKING)}catch{l.S0.Error("Hand tracking must be enabled for the Hand Menu to work")}}else l.S0.Error("XR features manager must be available or provided directly for the Hand Menu to work")}}},2073:(e,t,i)=>{i.d(t,{C:()=>d});var r=i(9191),n=i(86521),s=i(6740),a=i(54983),o=i(31780),l=i(1675),c=i(18458),h=i(93260),u=i(50507);class d{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new s.cP,this.onDragStartObservable=new s.cP,this.onDragEndObservable=new s.cP,this.onEnabledObservable=new s.cP,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=e=>!0,this._tmpVector=new a.Pq(0,0,0),this._alternatePickedPoint=new a.Pq(0,0,0),this._worldDragAxis=new a.Pq(0,0,0),this._targetPosition=new a.Pq(0,0,0),this._attachedToElement=!1,this._startDragRay=new l.Rl(new a.Pq,new a.Pq),this._lastPointerRay={},this._dragDelta=new a.Pq,this._pointA=new a.Pq(0,0,0),this._pointC=new a.Pq(0,0,0),this._localAxis=new a.Pq(0,0,0),this._lookAt=new a.Pq(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,d._PlaneScene||(this._debugMode?d._PlaneScene=this._scene:(d._PlaneScene=new n.Z(this._scene.getEngine(),{virtual:!0}),d._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce((()=>{d._PlaneScene.dispose(),d._PlaneScene=null})))),this._dragPlane=(0,h.x)("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:r.e.DOUBLESIDE},d._PlaneScene),this.lastDragPosition=new a.Pq(0,0,0);const i=t||(e=>this.attachedNode==e||e.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add((e=>{if(this.enabled){if(e.type==o.Zp.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&i(e.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(e.event.button)&&(this._activeDragButton=e.event.button,this._activePointerInfo=e,this._startDrag(e.event.pointerId,e.pickInfo.ray,e.pickInfo.pickedPoint));else if(e.type==o.Zp.POINTERUP)!this.startAndReleaseDragOnPointerEvents||this.currentDraggingPointerId!=e.event.pointerId||this._activeDragButton!==e.event.button&&-1!==this._activeDragButton||this.releaseDrag();else if(e.type==o.Zp.POINTERMOVE){const t=e.event.pointerId;if(this.currentDraggingPointerId===d._AnyMouseId&&t!==d._AnyMouseId){const i=e.event;("mouse"===i.pointerType||!this._scene.getEngine().hostInformation.isMobile&&i instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[t]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=t)}this._lastPointerRay[t]||(this._lastPointerRay[t]=new l.Rl(new a.Pq,new a.Pq)),e.pickInfo&&e.pickInfo.ray&&(this._lastPointerRay[t].origin.copyFrom(e.pickInfo.ray.origin),this._lastPointerRay[t].direction.copyFrom(e.pickInfo.ray.direction),this.currentDraggingPointerId==t&&this.dragging&&this._moveDrag(e.pickInfo.ray))}}else this._attachedToElement&&this.releaseDrag()})),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(this._moving&&this.moveAttached){let e=!1;c.G._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),e=!0),c.G._RestorePivotPoint(this.attachedNode),e&&this.attachedNode.computeWorldMatrix()}}))}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){const e=this._scene.activeCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(e=d._AnyMouseId,t,i){this._startDrag(e,t,i);let r=this._lastPointerRay[e];e===d._AnyMouseId&&(r=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),r&&this._moveDrag(r)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;c.G._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);const r=this._pickWithRayOnDragPlane(this._startDragRay);r?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(r),this.onDragStartObservable.notifyObservers({dragPlanePoint:r,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),c.G._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;const t=this._pickWithRayOnDragPlane(e);if(t){c.G._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?a.Pq.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),this._worldDragAxis.normalize(),i=a.Pq.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),c.G._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(a.Pq.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle){if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*a.Pq.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const t=a.Pq.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-t,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}return null}const i=this._dragPlane.forward,r=this._dragPlane.position,n=e.direction.dot(i);if(Math.abs(n)<u.bH)return null;r.subtractToRef(e.origin,a.AA.Vector3[0]);const s=a.AA.Vector3[0].dot(i)/n;return s<0?null:(e.direction.scaleToRef(s,a.AA.Vector3[0]),e.origin.add(a.AA.Vector3[0]))}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?a.Pq.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(a.Pq.Dot(this._localAxis,this._pointC))>.999?Math.abs(a.Pq.Dot(a.Pq.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(a.Pq.Right()):this._lookAt.copyFrom(a.Pq.UpReadOnly):(a.Pq.CrossToRef(this._localAxis,this._pointC,this._lookAt),a.Pq.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?a.Pq.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}d._AnyMouseId=-2},73395:(e,t,i)=>{i.d(t,{Y:()=>o});var r=i(54983),n=i(6740),s=i(16318),a=i(34116);class o extends s.D{constructor(){super(...arguments),this._sceneRenderObserver=null,this._targetPosition=new r.Pq(0,0,0),this._targetOrientation=new r.PT,this._targetScaling=new r.Pq(1,1,1),this._startingPosition=new r.Pq(0,0,0),this._startingOrientation=new r.PT,this._startingScaling=new r.Pq(1,1,1),this.onPositionChangedObservable=new n.cP,this.dragDeltaRatio=.2,this.rotateDraggedObject=!0,this.rotateAroundYOnly=!1,this.rotateWithMotionController=!0,this.disableMovement=!1,this.faceCameraOnDragStart=!1}get name(){return"SixDofDrag"}attach(e){super.attach(e),e.isNearGrabbable=!0,e.getChildMeshes().forEach((e=>{e.isNearGrabbable=!0})),this._virtualTransformNode=new a.V("virtual_sixDof",s.D._virtualScene),this._virtualTransformNode.rotationQuaternion=r.PT.Identity(),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(1===this.currentDraggingPointerIds.length&&this._moving&&!this.disableMovement){const t=r.AA.Vector3[0];t.copyFrom(this._targetPosition).subtractInPlace(e.absolutePosition).scaleInPlace(this.dragDeltaRatio);const i=r.AA.Vector3[1];if(i.copyFrom(t),e.parent){const n=r.AA.Matrix[0];e.parent.absoluteRotationQuaternion.toRotationMatrix(n),n.invert(),r.Pq.TransformNormalToRef(t,n,i)}if(e.position.addInPlace(i),this.onPositionChangedObservable.notifyObservers({position:e.absolutePosition}),!e.parent||e.parent.scaling&&!e.parent.scaling.isNonUniformWithinEpsilon(.001)){const t=r.AA.Quaternion[0];if(t.copyFrom(this._targetOrientation),e.parent){const i=r.AA.Quaternion[0];i.copyFrom(e.parent.absoluteRotationQuaternion),i.invertInPlace(),i.multiplyToRef(this._targetOrientation,t)}r.PT.SlerpToRef(e.rotationQuaternion,t,this.dragDeltaRatio,e.rotationQuaternion)}}}))}_getPositionOffsetAround(e,t,i){const n=r.AA.Matrix[0],s=r.AA.Matrix[1],a=r.AA.Matrix[2],o=r.AA.Matrix[3],l=r.AA.Matrix[4];return r.uq.TranslationToRef(e.x,e.y,e.z,n),r.uq.TranslationToRef(-e.x,-e.y,-e.z,s),r.uq.FromQuaternionToRef(i,a),r.uq.ScalingToRef(t,t,t,o),s.multiplyToRef(a,l),l.multiplyToRef(o,l),l.multiplyToRef(n,l),l.getTranslation()}_onePointerPositionUpdated(e,t){r.AA.Vector3[0].setAll(0),this._dragging===this._dragType.DRAG?this.rotateDraggedObject&&(this.rotateAroundYOnly?r.PT.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,r.AA.Quaternion[0]):r.AA.Quaternion[0].copyFrom(t),r.AA.Quaternion[0].multiplyToRef(this._startingOrientation,this._targetOrientation)):(this._dragging===this._dragType.NEAR_DRAG||this._dragging===this._dragType.DRAG_WITH_CONTROLLER&&this.rotateWithMotionController)&&t.multiplyToRef(this._startingOrientation,this._targetOrientation),this._targetPosition.copyFrom(this._startingPosition).addInPlace(e)}_twoPointersPositionUpdated(){const e=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].startingPosition,t=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].startingPosition,i=r.AA.Vector3[0];e.addToRef(t,i),i.scaleInPlace(.5);const n=r.AA.Vector3[1];t.subtractToRef(e,n);const s=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].dragMesh.absolutePosition,a=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].dragMesh.absolutePosition,o=r.AA.Vector3[2];s.addToRef(a,o),o.scaleInPlace(.5);const l=r.AA.Vector3[3];a.subtractToRef(s,l);const c=l.length()/n.length(),h=o.subtract(i),u=r.PT.FromEulerAngles(0,r.Pq.GetAngleBetweenVectorsOnPlane(n.normalize(),l.normalize(),r.Pq.UpReadOnly),0),d=this._ownerNode.parent;this._ownerNode.setParent(null);const p=this._getPositionOffsetAround(i.subtract(this._virtualTransformNode.getAbsolutePivotPoint()),c,u);this._virtualTransformNode.rotationQuaternion.multiplyToRef(u,this._ownerNode.rotationQuaternion),this._virtualTransformNode.scaling.scaleToRef(c,this._ownerNode.scaling),this._virtualTransformNode.position.addToRef(h.addInPlace(p),this._ownerNode.position),this.onPositionChangedObservable.notifyObservers({position:this._ownerNode.position}),this._ownerNode.setParent(d)}_targetDragStart(){const e=this.currentDraggingPointerIds.length;this._ownerNode.rotationQuaternion||(this._ownerNode.rotationQuaternion=r.PT.RotationYawPitchRoll(this._ownerNode.rotation.y,this._ownerNode.rotation.x,this._ownerNode.rotation.z));const t=this._ownerNode.getAbsolutePivotPoint();if(1===e){if(this._targetPosition.copyFrom(this._ownerNode.absolutePosition),this._targetOrientation.copyFrom(this._ownerNode.rotationQuaternion),this._targetScaling.copyFrom(this._ownerNode.absoluteScaling),this.faceCameraOnDragStart&&this._scene.activeCamera){const e=r.AA.Vector3[0];this._scene.activeCamera.position.subtractToRef(t,e),e.normalize();const i=r.AA.Quaternion[0];this._scene.useRightHandedSystem?r.PT.FromLookDirectionRHToRef(e,new r.Pq(0,1,0),i):r.PT.FromLookDirectionLHToRef(e,new r.Pq(0,1,0),i),i.normalize(),r.PT.RotationYawPitchRollToRef(i.toEulerAngles().y,0,0,r.AA.Quaternion[0]),this._targetOrientation.copyFrom(r.AA.Quaternion[0])}this._startingPosition.copyFrom(this._targetPosition),this._startingOrientation.copyFrom(this._targetOrientation),this._startingScaling.copyFrom(this._targetScaling)}else 2===e&&(this._virtualTransformNode.setPivotPoint(new r.Pq(0,0,0),0),this._virtualTransformNode.position.copyFrom(this._ownerNode.absolutePosition),this._virtualTransformNode.scaling.copyFrom(this._ownerNode.absoluteScaling),this._virtualTransformNode.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),this._virtualTransformNode.setPivotPoint(t,1),this._resetVirtualMeshesPosition())}_targetDrag(e,t){1===this.currentDraggingPointerIds.length?this._onePointerPositionUpdated(e,t):2===this.currentDraggingPointerIds.length&&this._twoPointersPositionUpdated()}_targetDragEnd(){if(1===this.currentDraggingPointerIds.length){this._resetVirtualMeshesPosition();const e=this.faceCameraOnDragStart;this.faceCameraOnDragStart=!1,this._targetDragStart(),this.faceCameraOnDragStart=e}}detach(){super.detach(),this._ownerNode&&this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),this._virtualTransformNode&&this._virtualTransformNode.dispose()}}},39500:(e,t,i)=>{i.d(t,{B:()=>s});var r=i(31780),n=i(54983);class s{constructor(){this._attachPointLocalOffset=new n.Pq,this._workingPosition=new n.Pq,this._workingQuaternion=new n.PT,this._lastTick=-1,this._hit=!1,this.hitNormalOffset=.05,this.meshes=[],this.interpolatePose=!0,this.lerpTime=250,this.keepOrientationVertical=!0,this.enabled=!0,this.maxStickingDistance=.8}get name(){return"SurfaceMagnetism"}init(){}attach(e,t){this._attachedMesh=e,this._scene=t||e.getScene(),this._attachedMesh.rotationQuaternion||(this._attachedMesh.rotationQuaternion=n.PT.RotationYawPitchRoll(this._attachedMesh.rotation.y,this._attachedMesh.rotation.x,this._attachedMesh.rotation.z)),this.updateAttachPoint(),this._workingPosition.copyFrom(this._attachedMesh.position),this._workingQuaternion.copyFrom(this._attachedMesh.rotationQuaternion),this._addObservables()}detach(){this._attachedMesh=null,this._removeObservables()}_getTargetPose(e){if(!this._attachedMesh)return null;if(e&&e.hit){const t=e.getNormal(!0,!0),i=e.pickedPoint;if(!t||!i)return null;t.normalize();const r=n.AA.Vector3[0];return r.copyFrom(t),r.scaleInPlace(this.hitNormalOffset),r.addInPlace(i),this._attachedMesh.parent&&(n.AA.Matrix[0].copyFrom(this._attachedMesh.parent.getWorldMatrix()).invert(),n.Pq.TransformNormalToRef(r,n.AA.Matrix[0],r)),{position:r,quaternion:n.PT.RotationYawPitchRoll(-Math.atan2(t.x,-t.z),this.keepOrientationVertical?0:Math.atan2(t.y,Math.sqrt(t.z*t.z+t.x*t.x)),0)}}return null}updateAttachPoint(){this._getAttachPointOffsetToRef(this._attachPointLocalOffset)}findAndUpdateTarget(e){if(this._hit=!1,!e.ray)return!1;const t=e.ray.intersectsMeshes(this.meshes)[0];if(this._attachedMesh&&t&&t.hit&&t.pickedMesh){const e=this._getTargetPose(t);e&&n.Pq.Distance(this._attachedMesh.position,e.position)<this.maxStickingDistance&&(this._workingPosition.copyFrom(e.position),this._workingQuaternion.copyFrom(e.quaternion),this._hit=!0)}return this._hit}_getAttachPointOffsetToRef(e){if(!this._attachedMesh)return void e.setAll(0);const t=n.AA.Quaternion[0];t.copyFrom(this._attachedMesh.rotationQuaternion),this._attachedMesh.rotationQuaternion.copyFromFloats(0,0,0,1),this._attachedMesh.computeWorldMatrix();const i=this._attachedMesh.getHierarchyBoundingVectors(),r=n.AA.Vector3[0];i.max.addToRef(i.min,r),r.scaleInPlace(.5),r.z=i.max.z;const s=n.AA.Matrix[0];this._attachedMesh.getWorldMatrix().invertToRef(s),n.Pq.TransformCoordinatesToRef(r,s,e),this._attachedMesh.rotationQuaternion.copyFrom(t)}_updateTransformToGoal(e){if(!this._attachedMesh||!this._hit)return;const t=this._attachedMesh.parent;this._attachedMesh.setParent(null);const i=n.AA.Vector3[0];if(n.Pq.TransformNormalToRef(this._attachPointLocalOffset,this._attachedMesh.getWorldMatrix(),i),!this.interpolatePose)return this._attachedMesh.position.copyFrom(this._workingPosition).subtractInPlace(i),void this._attachedMesh.rotationQuaternion.copyFrom(this._workingQuaternion);const r=new n.Pq;n.Pq.SmoothToRef(this._attachedMesh.position,this._workingPosition,e,this.lerpTime,r),this._attachedMesh.position.copyFrom(r);const s=new n.PT;s.copyFrom(this._attachedMesh.rotationQuaternion),n.PT.SmoothToRef(s,this._workingQuaternion,e,this.lerpTime,this._attachedMesh.rotationQuaternion),this._attachedMesh.setParent(t)}_addObservables(){this._pointerObserver=this._scene.onPointerObservable.add((e=>{this.enabled&&e.type==r.Zp.POINTERMOVE&&e.pickInfo&&this.findAndUpdateTarget(e.pickInfo)})),this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{const e=Date.now();this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._scene.onPointerObservable.remove(this._pointerObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRender),this._pointerObserver=null,this._onBeforeRender=null}}},93420:(e,t,i)=>{i.d(t,{$:()=>a});var r=i(54983),n=i(87649),s=i(69346);class a extends s.b{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){(e.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,n=null,s=null,a=null,o=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=n?.clone()??r.uq.Identity(),this._restMatrix=s??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new r.uq,this._absoluteBindMatrix=new r.uq,this._absoluteInverseBindMatrix=new r.uq,this._finalMatrix=new r.uq,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const e=this.parent.children.indexOf(this);-1!==e&&this.parent.children.splice(e,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const e=r.AA.Vector3[0],t=r.AA.Quaternion[0],i=r.AA.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??r.PT.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=r.Pq.Zero(),this._localRotation=r.PT.Zero(),this._localPosition=r.Pq.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,r.uq.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,n=!0){const s=this.getLocalMatrix();if(0==t)n?(s.addAtIndex(12,e.x),s.addAtIndex(13,e.y),s.addAtIndex(14,e.z)):s.setTranslationFromFloats(e.x,e.y,e.z);else{let t=null;i&&(t=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const o=a._TmpMats[0],l=a._TmpVecs[0];this.parent?i&&t?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(t,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):r.uq.IdentityToRef(o),n&&o.setTranslationFromFloats(0,0,0),o.invert(),r.Pq.TransformCoordinatesToRef(e,o,l),n?(s.addAtIndex(12,l.x),s.addAtIndex(13,l.y),s.addAtIndex(14,l.z)):s.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,n=!1){const s=this.getLocalMatrix(),o=a._TmpMats[0];r.uq.ScalingToRef(e,t,i,o),o.multiplyToRef(s,s),o.invert();for(const r of this.children){const n=r.getLocalMatrix();n.multiplyToRef(o,n),n.multiplyAtIndex(12,e),n.multiplyAtIndex(13,t),n.multiplyAtIndex(14,i),r._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),n)for(const r of this.children)r.scale(e,t,i,n)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,n=0,s){if(0===n){const o=a._TmpQuat;return r.PT.RotationYawPitchRollToRef(e,t,i,o),void this.setRotationQuaternion(o,n,s)}const o=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(o,s))return;const l=a._TmpMats[1];r.uq.RotationYawPitchRollToRef(e,t,i,l),o.multiplyToRef(l,l),this._rotateWithMatrix(l,n,s)}rotate(e,t,i=0,n){const s=a._TmpMats[0];s.setTranslationFromFloats(0,0,0),r.uq.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,i,n)}setAxisAngle(e,t,i=0,n){if(0===i){const s=a._TmpQuat;return r.PT.RotationAxisToRef(e,t,s),void this.setRotationQuaternion(s,i,n)}const s=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,n))return;const o=a._TmpMats[1];r.uq.RotationAxisToRef(e,t,o),s.multiplyToRef(o,o),this._rotateWithMatrix(o,i,n)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(0===t)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const n=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,i))return;const s=a._TmpMats[1];r.uq.FromQuaternionToRef(e,s),n.multiplyToRef(s,s),this._rotateWithMatrix(s,t,i)}setRotationMatrix(e,t=0,i){if(0===t){const n=a._TmpQuat;return r.PT.FromRotationMatrixToRef(e,n),void this.setRotationQuaternion(n,t,i)}const n=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,i))return;const s=a._TmpMats[1];s.copyFrom(e),n.multiplyToRef(e,s),this._rotateWithMatrix(s,t,i)}_rotateWithMatrix(e,t=0,i){const r=this.getLocalMatrix(),n=r.m[12],s=r.m[13],o=r.m[14],l=this.getParent(),c=a._TmpMats[3],h=a._TmpMats[4];l&&1==t?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):1==t&&i?(c.copyFrom(i.getWorldMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(n,s,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=a._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),r.uq.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):r.uq.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){const i=r.Pq.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(0==e){const e=this.getLocalMatrix();i.x=e.m[12],i.y=e.m[13],i.z=e.m[14]}else{let e=null;t&&(e=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let r=a._TmpMats[0];t&&e?(r.copyFrom(this.getAbsoluteMatrix()),r.multiplyToRef(e,r)):r=this.getAbsoluteMatrix(),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){const t=r.Pq.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=r.Pq.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=a._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&n&&s.multiplyToRef(n,s),r.Pq.TransformNormalToRef(e,s,i),i.normalize()}getRotation(e=0,t=null){const i=r.Pq.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){const r=a._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){const i=r.PT.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(0==e)this._decompose(),i.copyFrom(this._localRotation);else{const e=a._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(r),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){const i=r.uq.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(0==e)this.getLocalMatrix().getRotationMatrixToRef(i);else{const e=a._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(r),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=r.Pq.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=a._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&n&&s.multiplyToRef(n,s),r.Pq.TransformCoordinatesToRef(e,s,i)}getLocalPositionFromAbsolute(e,t=null){const i=r.Pq.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=a._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&n&&s.multiplyToRef(n,s),s.invert(),r.Pq.TransformCoordinatesToRef(e,s,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;const e=this._skeleton.bones.indexOf(this);if(-1!==e&&this._skeleton.bones.splice(e,1),this._parentNode&&this._parentNode.children){const e=this._parentNode.children,t=e.indexOf(this);-1!==t&&e.splice(t,1)}super.dispose()}}a._TmpVecs=(0,n.mI)(2,r.Pq.Zero),a._TmpQuat=r.PT.Identity(),a._TmpMats=(0,n.mI)(5,r.uq.Identity)},90321:(e,t,i)=>{i.d(t,{E:()=>d});var r=i(93420),n=i(6740),s=i(54983),a=i(18645),o=i(13528),l=i(82423),c=i(69583),h=i(70461),u=i(34829);class d{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=s.uq.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new n.cP,this.bones=[],this._scene=i||c.q.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter((e=>!e.getParent()))}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return this._transformMatrices&&!this._isDirty||this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new l.K(e,t,i);for(let r=0,n=this.bones.length;r<n;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0;const n=this._getHighestAnimationFrame()+1,s={},a=e.bones;let o,c;for(c=0,o=a.length;c<o;c++)s[a[c].name]=a[c];this.bones.length!==a.length&&(h.V.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),r=!1);const u=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,o=this.bones.length;c<o;c++){const e=this.bones[c].name,a=s[e];a?r=r&&this.bones[c].copyAnimationRange(a,t,n,i,u):(h.V.Warn("copyAnimationRange: not same rig, missing source bone "+e),r=!1)}const d=e.getAnimationRange(t);return d&&(this._ranges[t]=new l.K(t,d.from+n,d.to+n)),r}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const i=this.bones[t].animations[0].getHighestFrame();e<i&&(e=i)}return e}beginAnimation(e,t,i,r){const n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){const r=e.getAnimationRange(i);if(!r)return null;const n=e._scene.getAllAnimatablesByTarget(e);let s=null;for(let e=0;e<n.length;e++){const t=n[e];if(t.fromFrame===r?.from&&t.toFrame===r?.to){s=t;break}}const a=e.getAnimatables();for(let e=0;e<a.length;e++){const r=a[e].animations;if(r)for(let e=0;e<r.length;e++)o.X5.MakeAnimationAdditive(r[e],t,i)}return s&&(s.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const r=this.bones[i];r._childUpdateId++;const n=r.getParent();if(n?r.getLocalMatrix().multiplyToRef(n.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),-1!==r._index){const t=null===r._index?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){const e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const e of this.bones)e.getParent()||(e.getBindMatrix().multiplyToRef(t,s.AA.Matrix[1]),e._updateAbsoluteBindMatrices(s.AA.Matrix[1]));if(this.isUsingTextureForMatrices){const t=4*(this.bones.length+1);e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=a.I.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=a.I.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new d(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){const t=this.bones[e];let n=null;const s=t.getParent();if(s){const e=this.bones.indexOf(s);n=i.bones[e]}const a=new r.$(t.name,i,n,t.getBindMatrix().clone(),t.getRestMatrix().clone());a._index=t._index,t._linkedTransformNode&&a.linkTransformNode(t._linkedTransformNode),u.r.DeepCopy(t.animations,a.animations)}if(this._ranges){i._ranges={};for(const e in this._ranges){const t=this._ranges[e];t&&(i._ranges[e]=t.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach((t=>{t.animations.forEach((t=>{t.enableBlending=!0,t.blendingSpeed=e}))}))}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let t=0;t<this.bones.length;t++){const i=this.bones[t],r=i.getParent(),n={parentBoneIndex:r?this.bones.indexOf(r):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};e.bones.push(n),i.length&&(n.length=i.length),i.metadata&&(n.metadata=i.metadata),i.animations&&i.animations.length>0&&(n.animation=i.animations[0].serialize()),e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.ranges.push(r)}}return e}static Parse(e,t){const i=new d(e.name,e.id,t);let n;for(e.dimensionsAtRest&&(i.dimensionsAtRest=s.Pq.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,n=0;n<e.bones.length;n++){const t=e.bones[n],a=e.bones[n].index;let l=null;t.parentBoneIndex>-1&&(l=i.bones[t.parentBoneIndex]);const c=t.rest?s.uq.FromArray(t.rest):null,h=new r.$(t.name,i,l,s.uq.FromArray(t.matrix),c,null,a);void 0!==t.id&&null!==t.id&&(h.id=t.id),t.length&&(h.length=t.length),t.metadata&&(h.metadata=t.metadata),t.animation&&h.animations.push(o.X5.Parse(t.animation)),void 0!==t.linkedTransformNodeId&&null!==t.linkedTransformNodeId&&(i._hasWaitingData=!0,h._waitingTransformNodeId=t.linkedTransformNodeId)}if(e.ranges)for(n=0;n<e.ranges.length;n++){const t=e.ranges[n];i.createAnimationRange(t.name,t.from,t.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const r=this.bones[e];if(!r)return;void 0===r._index&&(r._index=e);const n=r.getParent();n&&this._sortBones(this.bones.indexOf(n),t,i),t.push(r)}setCurrentPoseAsRest(){this.bones.forEach((e=>{e.setCurrentPoseAsRest()}))}}},43027:(e,t,i)=>{i.d(t,{K:()=>r});class r{constructor(e,t,i=3,r){this._engine=e,this._label=r,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i,r){return this._engine.readFromStorageBuffer(this._buffer,e,t,i,r)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}},58001:(e,t,i)=>{i.d(t,{l:()=>c});var r=i(90576),n=i(96631),s=i(6740),a=i(31780),o=i(35927),l=i(90066);class c{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new s.cP,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=l.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==a.Zp.POINTERWHEEL)return;const i=t.event,r=i.deltaMode===o.s.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,a.Zp.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}(0,r.Cg)([(0,n.lK)()],c.prototype,"wheelPrecisionX",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"wheelPrecisionY",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"wheelPrecisionZ",void 0)},29978:(e,t,i)=>{i.d(t,{i:()=>c});var r=i(90576),n=i(96631),s=i(16374),a=i(79046),o=i(54983),l=i(90066);class c{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=l.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===a.TB.KEYDOWN)-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)&&-1===this.keysUpward.indexOf(i.keyCode)&&-1===this.keysDownward.indexOf(i.keyCode)&&-1===this.keysRotateLeft.indexOf(i.keyCode)&&-1===this.keysRotateRight.indexOf(i.keyCode)&&-1===this.keysRotateUp.indexOf(i.keyCode)&&-1===this.keysRotateDown.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-r,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,r):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(r,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-r):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,r,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-r,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),o.Pq.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}(0,r.Cg)([(0,n.lK)()],c.prototype,"keysUp",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysUpward",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysDown",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysDownward",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysLeft",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysRight",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"rotationSpeed",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysRotateLeft",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysRotateRight",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysRotateUp",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"keysRotateDown",void 0),s.H.FreeCameraKeyboardMoveInput=c},64081:(e,t,i)=>{i.d(t,{h:()=>c});var r=i(90576),n=i(6740),s=i(96631),a=i(16374),o=i(31780),l=i(90066);class c{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new n.cP,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=l.S0.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{const n=r.event,s="touch"===n.pointerType;if(!this.touchEnabled&&s)return;if(r.type!==o.Zp.POINTERMOVE&&-1===this.buttons.indexOf(n.button))return;const a=n.target;if(r.type===o.Zp.POINTERDOWN){if(s&&-1!==this._activePointerId||!s&&-1!==this._currentActiveButton)return;this._activePointerId=n.pointerId;try{a?.setPointerCapture(n.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===o.Zp.POINTERUP){if(s&&this._activePointerId!==n.pointerId||!s&&this._currentActiveButton!==n.button)return;try{a?.releasePointerCapture(n.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(r.type===o.Zp.POINTERMOVE&&(this._activePointerId===n.pointerId||!s))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),i=(n.clientX-this._previousPosition.x)*t,r=n.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=i/this.angularSensibility,this.camera.cameraRotation.x+=r/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:i,offsetY:r}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}),this._onMouseMove=i=>{if(!t.isPointerLock)return;const r=this.camera._calculateHandednessMultiplier(),n=i.movementX*r;this.camera.cameraRotation.y+=n/this.angularSensibility;const s=i.movementY;this.camera.cameraRotation.x+=s/this.angularSensibility,this._previousPosition=null,e||i.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,o.Zp.POINTERDOWN|o.Zp.POINTERUP|o.Zp.POINTERMOVE),i&&(this._contextMenuBind=e=>this.onContextMenu(e),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}(0,r.Cg)([(0,s.lK)()],c.prototype,"buttons",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"angularSensibility",void 0),a.H.FreeCameraMouseInput=c},20548:(e,t,i)=>{i.d(t,{m:()=>c});var r,n=i(90576),s=i(96631),a=i(16374),o=i(58001),l=i(54983);!function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(r||(r={}));class c extends o.l{constructor(){super(...arguments),this._moveRelative=l.Pq.Zero(),this._rotateRelative=l.Pq.Zero(),this._moveScene=l.Pq.Zero(),this._wheelXAction=r.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=r.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==r.MoveRelative||(this._wheelXAction=r.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==r.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==r.MoveRelative||(this._wheelYAction=r.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==r.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==r.MoveRelative||(this._wheelZAction=r.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==r.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==r.RotateRelative||(this._wheelXAction=r.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==r.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==r.RotateRelative||(this._wheelYAction=r.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==r.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==r.RotateRelative||(this._wheelZAction=r.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==r.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==r.MoveScene||(this._wheelXAction=r.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==r.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==r.MoveScene||(this._wheelYAction=r.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==r.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==r.MoveScene||(this._wheelZAction=r.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==r.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=l.uq.Zero();this.camera.getViewMatrix().invertToRef(e);const t=l.Pq.Zero();l.Pq.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e)return;if(null===t||null===i)return;let n=null;switch(t){case r.MoveRelative:n=this._moveRelative;break;case r.RotateRelative:n=this._rotateRelative;break;case r.MoveScene:n=this._moveScene}switch(i){case 0:n.set(e,0,0);break;case 1:n.set(0,e,0);break;case 2:n.set(0,0,e)}}}(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelXMoveRelative",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelYMoveRelative",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelZMoveRelative",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelXRotateRelative",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelYRotateRelative",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelZRotateRelative",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelXMoveScene",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelYMoveScene",null),(0,n.Cg)([(0,s.lK)()],c.prototype,"wheelZMoveScene",null),a.H.FreeCameraMouseWheelInput=c},46797:(e,t,i)=>{i.d(t,{Z:()=>c});var r=i(90576),n=i(96631),s=i(16374),a=i(31780),o=i(54983),l=i(90066);class c{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=l.S0.IsSafari()}attachControl(e){e=l.S0.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const r=i.event,n="mouse"===r.pointerType||this._isSafari&&void 0===r.pointerType;if(this.allowMouse||!n)if(i.type===a.Zp.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),1!==this._pointerPressed.length)return;t={x:r.clientX,y:r.clientY}}else if(i.type===a.Zp.POINTERUP){e||r.preventDefault();const i=this._pointerPressed.indexOf(r.pointerId);if(-1===i)return;if(this._pointerPressed.splice(i,1),0!=i)return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===a.Zp.POINTERMOVE){if(e||r.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(r.pointerId))return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,a.Zp.POINTERDOWN|a.Zp.POINTERUP|a.Zp.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),i=new o.Pq(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);o.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(o.Pq.TransformCoordinates(i,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}(0,r.Cg)([(0,n.lK)()],c.prototype,"touchAngularSensibility",void 0),(0,r.Cg)([(0,n.lK)()],c.prototype,"touchMoveSensibility",void 0),s.H.FreeCameraTouchInput=c},87562:(e,t,i)=>{i.d(t,{S:()=>u});var r=i(90576),n=i(96631),s=i(54983),a=i(63825),o=i(90392),l=i(90066),c=i(88252),h=i(80770);class u extends a.F{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new s.Pq(.5,1,.5),this.ellipsoidOffset=new s.Pq(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=s.Pq.Zero(),this._diffPosition=s.Pq.Zero(),this._newPosition=s.Pq.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>h.$.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&i&&this.onCollide(i))},this.inputs=new o.s(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=l.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new s.Pq(0,0,0),this.cameraRotation=new s.I9(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?s.Pq.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=s.Pq.Zero(),this._transformedDirection=s.Pq.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}(0,r.Cg)([(0,n.P_)()],u.prototype,"ellipsoid",void 0),(0,r.Cg)([(0,n.P_)()],u.prototype,"ellipsoidOffset",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"checkCollisions",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"applyGravity",void 0),(0,c.Y5)("BABYLON.FreeCamera",u)},90392:(e,t,i)=>{i.d(t,{s:()=>l});var r=i(16374),n=i(29978),s=i(64081),a=i(20548),o=i(46797);class l extends r._{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new n.i),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new s.h(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new a.m,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new o.Z),this}clear(){super.clear(),this._mouseInput=null}}},63414:(e,t,i)=>{i.d(t,{H:()=>d});var r=i(90576),n=i(96631),s=i(16265),a=i(88252),o=i(23077),l=i(522),c=i(70461),h=i(67065),u=i(16228);class d{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,r={}){this._bindings={},this._samplers={},this._contextIsDirty=!1,this.fastMode=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=l.K.UniqueId,t.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new u.e),this._engine.getCaps().supportComputeShaders?r.bindingsMapping?(this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...r}):c.V.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!"):c.V.Error("This engine does not support compute shaders!")}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const r=this._bindings[e];this._bindings[e]={type:i?0:4,object:t,indexInGroupEntries:r?.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:1,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setExternalTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:6,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setVideoTexture(e,t){return!!t.externalTexture&&(this.setExternalTexture(e,t.externalTexture),!0)}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:d._BufferIsDataBuffer(t)?7:2,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:d._BufferIsDataBuffer(t)?7:3,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:5,object:t,indexInGroupEntries:i?.indexInGroupEntries}}isReady(){let e=this._effect;for(const e in this._bindings){const t=this._bindings[e],i=t.type,r=t.object;switch(i){case 0:case 4:case 1:case 6:if(!r.isReady())return!1}}const t=[],i=this._shaderPath;if(this._options.defines)for(let e=0;e<this._options.defines.length;e++)t.push(this._options.defines[e]);const r=t.join("\n");return this._cachedDefines!==r&&(this._cachedDefines=r,e=this._engine.createComputeEffect(i,{defines:r,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){return!(!this.fastMode&&!this._checkContext()||(this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping,this.gpuTimeInFrame),0))}dispatchIndirect(e,t=0){if(!this.fastMode&&!this._checkContext())return!1;const i=d._BufferIsDataBuffer(e)?e:e.getBuffer();return this._engine.computeDispatchIndirect(this._effect,this._context,this._bindings,i,t,this._options.bindingsMapping,this.gpuTimeInFrame),!0}_checkContext(){if(!this.isReady())return!1;for(const e in this._bindings){const t=this._bindings[e];if(!this._options.bindingsMapping[e])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+e+"'");switch(t.type){case 0:{const i=this._samplers[e],r=t.object;i&&r._texture&&i.compareSampler(r._texture)||(this._samplers[e]=(new h.u).setParameters(r.wrapU,r.wrapV,r.wrapR,r.anisotropicFilteringLevel,r._texture.samplingMode,r._texture?._comparisonFunction),this._contextIsDirty=!0);break}case 6:this._contextIsDirty=!0;break;case 2:{const e=t.object;e.getBuffer()!==t.buffer&&(t.buffer=e.getBuffer(),this._contextIsDirty=!0);break}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),!0}dispatchWhenReady(e,t,i,r=10){return new Promise((n=>{const s=()=>{this.dispatch(e,t,i)?n():setTimeout(s,r)};s()}))}serialize(){const e=s.p.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],r=i.object;switch(i.type){case 0:case 4:case 1:{const n=r.serialize();n&&(e.textures[t]=n,e.bindings[t]={type:i.type});break}}}return e}static Parse(e,t,i){const r=s.p.Parse((()=>new d(e.name,t.getEngine(),e.shaderPath,e.options)),e,t,i);for(const n in e.textures){const s=e.bindings[n],a=o.g.Parse(e.textures[n],t,i);0===s.type?r.setTexture(n,a):4===s.type?r.setTexture(n,a,!1):r.setStorageTexture(n,a)}return r}static _BufferIsDataBuffer(e){return void 0!==e.underlyingResource}}(0,r.Cg)([(0,n.lK)()],d.prototype,"name",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"fastMode",void 0),(0,a.Y5)("BABYLON.ComputeShader",d)},51519:(e,t,i)=>{i.r(t),i.d(t,{ComputeShaderBoundingHelper:()=>l});var r=i(63414),n=i(43027),s=i(59396),a=i(54983),o=i(55179);i(43862).l.ShadersStoreWGSL.boundingInfoComputeShader="struct Results {minX : atomic<i32>,\nminY : atomic<i32>,\nminZ : atomic<i32>,\nmaxX : atomic<i32>,\nmaxY : atomic<i32>,\nmaxZ : atomic<i32>,\ndummy1 : i32,\ndummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}\nfn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}\nfn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}\nif (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}\nfn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}\nif (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{let offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}\nconst identity=mat4x4f(\nvec4f(1.0,0.0,0.0,0.0),\nvec4f(0.0,1.0,0.0,0.0),\nvec4f(0.0,0.0,1.0,0.0),\nvec4f(0.0,0.0,0.0,1.0)\n);struct Settings {morphTargetTextureInfo: vec3f,\nmorphTargetCount: i32,\nindexResult : u32,};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;\n#if NUM_BONE_INFLUENCERS>0\n@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;\n#if NUM_BONE_INFLUENCERS>4\n@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;\n#endif\n#endif\n#ifdef MORPHTARGETS\n@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;\n#endif\n#ifdef MORPHTARGETS\nfn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f\n{ \nlet vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}\n#endif\n@compute @workgroup_size(256,1,1)\nfn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}\nlet position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\nlet matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;\n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;\n#endif \n#endif \nfinalWorld=finalWorld*influence;\n#endif\n#ifdef MORPHTARGETS\nfor (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=settings.morphTargetCount) {break;}\npositionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}\n#endif\nvar worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}\n";class l{constructor(e){this._computeShadersCache={},this._positionBuffers={},this._indexBuffers={},this._weightBuffers={},this._indexExtraBuffers={},this._weightExtraBuffers={},this._morphTargetInfluenceBuffers={},this._morphTargetTextureIndexBuffers={},this._ubos=[],this._uboIndex=0,this._processedMeshes=[],this._computeShaders=[],this._uniqueComputeShaders=new Set,this._resultBuffers=[],this._engine=e}_getComputeShader(e,t,i){let n;const s=e.join("\n");if(this._computeShadersCache[s])n=this._computeShadersCache[s];else{const a={positionBuffer:{group:0,binding:0},resultBuffer:{group:0,binding:1},settings:{group:0,binding:7}};t&&(a.boneSampler={group:0,binding:2},a.indexBuffer={group:0,binding:3},a.weightBuffer={group:0,binding:4},a.indexExtraBuffer={group:0,binding:5},a.weightExtraBuffer={group:0,binding:6}),i&&(a.morphTargets={group:0,binding:8},a.morphTargetInfluences={group:0,binding:9},a.morphTargetTextureIndices={group:0,binding:10}),n=new r.H(`boundingInfoCompute${t?"_bones":""}${i?"_morphs":""}`,this._engine,"boundingInfo",{bindingsMapping:a,defines:e}),this._computeShadersCache[s]=n}return n}_getUBO(){if(this._uboIndex>=this._ubos.length){const e=new o.D(this._engine);e.addFloat3("morphTargetTextureInfo",0,0,0),e.addUniform("morphTargetCount",1),e.addUniform("indexResult",1),this._ubos.push(e)}return this._ubos[this._uboIndex++]}_extractDataAndLink(e,t,i,r,s,a){let o;const l=t.getTotalVertices();if(a[t.uniqueId])o=a[t.uniqueId];else{const e=t.getVertexBuffer(i)?.getFloatData(l);o=new n.K(this._engine,Float32Array.BYTES_PER_ELEMENT*l*r),o.update(e),a[t.uniqueId]=o}e.setStorageBuffer(s,o)}_prepareStorage(e,t,i,r,s,a){let o;r[i]?o=r[i]:(o=new n.K(this._engine,Float32Array.BYTES_PER_ELEMENT*s),r[i]=o),o.update(a),e.setStorageBuffer(t,o)}async processAsync(e){await this.registerMeshListAsync(e),this.processMeshList(),await this.fetchResultsForMeshListAsync()}registerMeshListAsync(e){this._disposeForMeshList(),Array.isArray(e)||(e=[e]);let t=0;for(let i=0;i<e.length;i++){const r=e[i];if(0===r.getTotalVertices()||!r.getVertexBuffer||!r.getVertexBuffer(s.R.PositionKind))continue;this._processedMeshes.push(r);const n=r.morphTargetManager;n&&(t=Math.max(t,n.numTargets))}for(let e=0;e<this._processedMeshes.length;e++){const i=this._processedMeshes[e];let r=[""],n=!1;i&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&(r.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),n=!0);const s=this._getComputeShader(r,n,!1);if(this._uniqueComputeShaders.add(s),i.morphTargetManager){r=r.slice(),r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+t);const e=this._getComputeShader(r,n,!0);this._uniqueComputeShaders.add(e),this._computeShaders.push([s,e])}else this._computeShaders.push([s,s]);const a=this._getUBO();a.updateUInt("indexResult",e),a.update()}return new Promise((e=>{const t=()=>{const i=this._uniqueComputeShaders.keys();for(let e=i.next();!0!==e.done;e=i.next())if(!e.value.isReady())return void setTimeout(t,10);e()};t()}))}processMeshList(){if(0===this._processedMeshes.length)return;this._uboIndex=0;const e=8*this._processedMeshes.length,t=new Float32Array(e),i=new n.K(this._engine,Float32Array.BYTES_PER_ELEMENT*e);this._resultBuffers.push(i);for(let e=0;e<this._processedMeshes.length;e++)t[8*e+0]=Number.POSITIVE_INFINITY,t[8*e+1]=Number.POSITIVE_INFINITY,t[8*e+2]=Number.POSITIVE_INFINITY,t[8*e+3]=Number.NEGATIVE_INFINITY,t[8*e+4]=Number.NEGATIVE_INFINITY,t[8*e+5]=Number.NEGATIVE_INFINITY;i.update(t);for(let e=0;e<this._processedMeshes.length;e++){const t=this._processedMeshes[e],r=t.getTotalVertices(),[n,a]=this._computeShaders[e],o=t.morphTargetManager,l=o&&o.numInfluencers>0,c=l?a:n;if(this._extractDataAndLink(c,t,s.R.PositionKind,3,"positionBuffer",this._positionBuffers),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&t.skeleton.useTextureToStoreBoneMatrices){this._extractDataAndLink(c,t,s.R.MatricesIndicesKind,4,"indexBuffer",this._indexBuffers),this._extractDataAndLink(c,t,s.R.MatricesWeightsKind,4,"weightBuffer",this._weightBuffers);const e=t.skeleton.getTransformMatrixTexture(t);c.setTexture("boneSampler",e,!1),t.numBoneInfluencers>4&&(this._extractDataAndLink(c,t,s.R.MatricesIndicesExtraKind,4,"indexExtraBuffer",this._indexExtraBuffers),this._extractDataAndLink(c,t,s.R.MatricesWeightsExtraKind,4,"weightExtraBuffer",this._weightExtraBuffers))}const h=this._getUBO();if(l){const e=o._targetStoreTexture;c.setTexture("morphTargets",e,!1),this._prepareStorage(c,"morphTargetInfluences",t.uniqueId,this._morphTargetInfluenceBuffers,o.numInfluencers,o.influences),this._prepareStorage(c,"morphTargetTextureIndices",t.uniqueId,this._morphTargetTextureIndexBuffers,o.numInfluencers,o._morphTargetTextureIndices),h.updateFloat3("morphTargetTextureInfo",o._textureVertexStride,o._textureWidth,o._textureHeight),h.updateInt("morphTargetCount",o.numInfluencers),h.update()}c.setStorageBuffer("resultBuffer",i),c.setUniformBuffer("settings",h),c.dispatch(Math.ceil(r/256)),this._engine.flushFramebuffer()}}fetchResultsForMeshListAsync(){return new Promise((e=>{const t=[];let i=0;for(let e=0;e<this._resultBuffers.length;e++){const r=this._resultBuffers[e].getBuffer();t.push(r),i+=r.capacity}const r=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),n=a.Pq.Zero(),s=a.Pq.Zero(),o={minimum:n,maximum:s};this._engine.readFromMultipleStorageBuffers(t,0,void 0,r,!0).then((()=>{let t=0;for(let e=0;e<this._resultBuffers.length;e++){for(let i=0;i<this._processedMeshes.length;i++){const l=this._processedMeshes[i];a.Pq.FromArrayToRef(r,t+8*i,n),a.Pq.FromArrayToRef(r,t+8*i+3,s),e>0&&(n.minimizeInPlace(l.getBoundingInfo().minimum),s.maximizeInPlace(l.getBoundingInfo().maximum)),l._refreshBoundingInfoDirect(o)}t+=8*this._processedMeshes.length}for(const e of this._resultBuffers)e.dispose();this._resultBuffers=[],this._uboIndex=0,e()}))}))}_disposeCache(e){for(const t in e)e[t].dispose()}_disposeForMeshList(){for(const e of this._resultBuffers)e.dispose();this._resultBuffers=[],this._processedMeshes=[],this._computeShaders=[],this._uniqueComputeShaders=new Set}dispose(){this._disposeCache(this._positionBuffers),this._positionBuffers={},this._disposeCache(this._indexBuffers),this._indexBuffers={},this._disposeCache(this._weightBuffers),this._weightBuffers={},this._disposeCache(this._morphTargetInfluenceBuffers),this._morphTargetInfluenceBuffers={},this._disposeCache(this._morphTargetTextureIndexBuffers),this._morphTargetTextureIndexBuffers={};for(const e of this._ubos)e.dispose();this._ubos=[],this._computeShadersCache={},this._engine=void 0,this._disposeForMeshList()}}},39501:(e,t,i)=>{i.r(t),i.d(t,{TransformFeedbackBoundingHelper:()=>l});var r=i(59396),n=i(64871),s=i(53679),a=i(54983),o=i(43862);i(50143),i(28939),i(4835),i(88822),i(41375),i(58176),i(95581),i(75159);o.l.ShadersStore.gpuTransformVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\nout vec3 outPosition;const mat4 identity=mat4(\nvec4(1.0,0.0,0.0,0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(0.0,0.0,0.0,1.0)\n);void main(void) {vec3 positionUpdated=position;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nmat4 finalWorld=identity;\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);outPosition=worldPos.xyz;}";o.l.ShadersStore.gpuTransformPixelShader="#version 300 es\nvoid main() {discard;}\n";class l{constructor(e){this._buffers={},this._effects={},this._meshListCounter=0,this._engine=e}processAsync(e){return Array.isArray(e)||(e=[e]),this._meshListCounter=0,this._processMeshList(e),Promise.resolve()}_processMeshList(e){const t=this._engine.getCaps().parallelShaderCompile;this._engine.getCaps().parallelShaderCompile=void 0;for(let t=0;t<e.length;++t){const i=e[t];if(0===i.getTotalVertices()||!i.getVertexBuffer||!i.getVertexBuffer(r.R.PositionKind))continue;let s,a=0;const o=[];let l=[];const c=[r.R.PositionKind],h=[];if(i&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton){c.push(r.R.MatricesIndicesKind),c.push(r.R.MatricesWeightsKind),i.numBoneInfluencers>4&&(c.push(r.R.MatricesIndicesExtraKind),c.push(r.R.MatricesWeightsExtraKind));const e=i.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),e.isUsingTextureForMatrices?(o.push("#define BONETEXTURE"),-1===l.indexOf("boneTextureWidth")&&l.push("boneTextureWidth"),-1===h.indexOf("boneSampler")&&h.push("boneSampler")):(o.push("#define BonesPerMesh "+(e.bones.length+1)),-1===l.indexOf("mBones")&&l.push("mBones"))}else o.push("#define NUM_BONE_INFLUENCERS 0");const u=i?i.morphTargetManager:null;if(u){a=u.numMaxInfluencers||u.numInfluencers,a>0&&o.push("#define MORPHTARGETS"),u.isUsingTextureForTargets&&(o.push("#define MORPHTARGETS_TEXTURE"),-1===l.indexOf("morphTargetTextureIndices")&&l.push("morphTargetTextureIndices"),-1===h.indexOf("morphTargets")&&h.push("morphTargets")),o.push("#define NUM_MORPH_INFLUENCERS "+a);for(let e=0;e<a;e++)c.push(r.R.PositionKind+e);a>0&&(l=l.slice(),l.push("morphTargetInfluences"),l.push("morphTargetCount"),l.push("morphTargetTextureInfo"),l.push("morphTargetTextureIndices"))}const d=i.bakedVertexAnimationManager;d&&d.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===l.indexOf("bakedVertexAnimationSettings")&&l.push("bakedVertexAnimationSettings"),-1===l.indexOf("bakedVertexAnimationTextureSizeInverted")&&l.push("bakedVertexAnimationTextureSizeInverted"),-1===l.indexOf("bakedVertexAnimationTime")&&l.push("bakedVertexAnimationTime"),-1===h.indexOf("bakedVertexAnimationTexture")&&h.push("bakedVertexAnimationTexture"),(0,n.J2)(c,i,o));const p=o.join("\n");if(this._effects[p])s=this._effects[p];else{const e={attributes:c,uniformsNames:l,uniformBuffersNames:[],samplers:h,defines:p,fallbacks:null,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:a},maxSimultaneousLights:0,transformFeedbackVaryings:["outPosition"]};s=this._engine.createEffect("gpuTransform",e,this._engine),this._effects[p]=s}this._compute(i,s)}this._engine.getCaps().parallelShaderCompile=t}_compute(e,t){const i=this._engine;let a;const o=e.getTotalVertices();if(this._buffers[e.uniqueId])a=this._buffers[e.uniqueId];else{const t=new Float32Array(3*o);a=new r.h(e.getEngine(),t,!0,3),this._buffers[e.uniqueId]=a}t.getEngine().enableEffect(t),e._bindDirect(t,null,!0),(0,n.f$)(e,t);const c=e.morphTargetManager;c&&c.numInfluencers>0&&(0,n.nR)(e,t);const h=e.bakedVertexAnimationManager;h&&h.isEnabled&&e.bakedVertexAnimationManager?.bind(t,!1);const u=a.getData();if(i.bindTransformFeedbackBuffer(a.getBuffer()),i.setRasterizerState(!1),i.beginTransformFeedback(!0),i.drawArraysType(2,0,o),i.endTransformFeedback(),i.setRasterizerState(!0),i.readTransformFeedbackBuffer(u),i.bindTransformFeedbackBuffer(null),0===this._meshListCounter)e._refreshBoundingInfo(u,null);else{const t=e.getBoundingInfo().boundingBox,i=(0,s.b8)(u,0,o);l._Min.copyFrom(t.minimum).minimizeInPlace(i.minimum),l._Max.copyFrom(t.maximum).maximizeInPlace(i.maximum),e._refreshBoundingInfoDirect({minimum:l._Min,maximum:l._Max})}}registerMeshListAsync(e){return Array.isArray(e)||(e=[e]),this._meshList=e,this._meshListCounter=0,Promise.resolve()}processMeshList(){0!==this._meshList.length&&(this._processMeshList(this._meshList),this._meshListCounter++)}fetchResultsForMeshListAsync(){return this._meshListCounter=0,Promise.resolve()}dispose(){for(const e in this._buffers)this._buffers[e].dispose();this._buffers={},this._effects={},this._engine=null}}l._Min=new a.Pq,l._Max=new a.Pq},39626:(e,t,i)=>{i.d(t,{AU:()=>f,DY:()=>E,Gz:()=>p,KI:()=>b,Oj:()=>y,R0:()=>h,Rl:()=>u,S:()=>T,TR:()=>C,m9:()=>P,mc:()=>x,oZ:()=>m,uW:()=>S,ui:()=>d});var r=i(50507),n=i(54983),s=i(87649),a=i(92371),o=i(40475),l=i(69583),c=i(44625);const h={internalPickerForMesh:void 0};class u{constructor(e,t,i=Number.MAX_VALUE,n=r.bH){this.origin=e,this.direction=t,this.length=i,this.epsilon=n}clone(){return new u(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const r=u._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),n=u._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let s,a,o,l,c=0,h=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>n.x)return!1}else if(s=1/this.direction.x,a=(r.x-this.origin.x)*s,o=(n.x-this.origin.x)*s,o===-1/0&&(o=1/0),a>o&&(l=a,a=o,o=l),c=Math.max(a,c),h=Math.min(o,h),c>h)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>n.y)return!1}else if(s=1/this.direction.y,a=(r.y-this.origin.y)*s,o=(n.y-this.origin.y)*s,o===-1/0&&(o=1/0),a>o&&(l=a,a=o,o=l),c=Math.max(a,c),h=Math.min(o,h),c>h)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>n.z)return!1}else if(s=1/this.direction.z,a=(r.z-this.origin.z)*s,o=(n.z-this.origin.z)*s,o===-1/0&&(o=1/0),a>o&&(l=a,a=o,o=l),c=Math.max(a,c),h=Math.min(o,h),c>h)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,n=e.center.z-this.origin.z,s=i*i+r*r+n*n,a=e.radius+t,o=a*a;if(s<=o)return!0;const l=i*this.direction.x+r*this.direction.y+n*this.direction.z;return!(l<0)&&s-l*l<=o}intersectsTriangle(e,t,i){const r=u._TmpVector3[0],s=u._TmpVector3[1],o=u._TmpVector3[2],l=u._TmpVector3[3],c=u._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,s),n.Pq.CrossToRef(this.direction,s,o);const h=n.Pq.Dot(r,o);if(0===h)return null;const d=1/h;this.origin.subtractToRef(e,l);const p=n.Pq.Dot(l,o)*d;if(p<-this.epsilon||p>1+this.epsilon)return null;n.Pq.CrossToRef(l,r,c);const f=n.Pq.Dot(this.direction,c)*d;if(f<-this.epsilon||p+f>1+this.epsilon)return null;const m=n.Pq.Dot(s,c)*d;return m>this.length?null:new a.w(1-p-f,p,m)}intersectsPlane(e){let t;const i=n.Pq.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const r=n.Pq.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const e=(this.origin.y-t)/this.direction.y;return e>0?null:new n.Pq(this.origin.x+this.direction.x*-e,t,this.origin.z+this.direction.z*-e)}case"x":{const e=(this.origin.x-t)/this.direction.x;return e>0?null:new n.Pq(t,this.origin.y+this.direction.y*-e,this.origin.z+this.direction.z*-e)}case"z":{const e=(this.origin.z-t)/this.direction.z;return e>0?null:new n.Pq(this.origin.x+this.direction.x*-e,this.origin.y+this.direction.y*-e,t)}default:return null}}intersectsMesh(e,t,i,r=!1,s,a=!1){const o=n.AA.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?u.TransformToRef(this,o,this._tmpRay):this._tmpRay=u.Transform(this,o),e.intersects(this._tmpRay,t,i,r,s,a)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){const n=this.intersectsMesh(e[r],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const r=this.origin,s=n.AA.Vector3[0],a=n.AA.Vector3[1],o=n.AA.Vector3[2],l=n.AA.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(u._Rayl,o),r.addToRef(o,a),e.subtractToRef(r,l);const c=n.Pq.Dot(s,s),h=n.Pq.Dot(s,o),d=n.Pq.Dot(o,o),p=n.Pq.Dot(s,l),f=n.Pq.Dot(o,l),m=c*d-h*h;let _,g,v=m,S=m;m<u._Smallnum?(_=0,v=1,g=f,S=d):(_=h*f-d*p,g=c*f-h*p,_<0?(_=0,g=f,S=d):_>v&&(_=v,g=f+h,S=d)),g<0?(g=0,-p<0?_=0:-p>c?_=v:(_=-p,v=c)):g>S&&(g=S,-p+h<0?_=0:-p+h>c?_=v:(_=-p+h,v=c));const x=Math.abs(_)<u._Smallnum?0:_/v,T=Math.abs(g)<u._Smallnum?0:g/S,E=n.AA.Vector3[4];o.scaleToRef(T,E);const C=n.AA.Vector3[5];s.scaleToRef(x,C),C.addInPlace(l);const b=n.AA.Vector3[6];return C.subtractToRef(E,b),T>0&&T<=this.length&&b.lengthSquared()<i*i?C.length():-1}update(e,t,i,r,s,a,o,l=!1){if(l){u._RayDistant||(u._RayDistant=u.Zero()),u._RayDistant.unprojectRayToRef(e,t,i,r,n.uq.IdentityReadOnly,a,o);const l=n.AA.Matrix[0];s.invertToRef(l),u.TransformToRef(u._RayDistant,l,this)}else this.unprojectRayToRef(e,t,i,r,s,a,o);return this}static Zero(){return new u(n.Pq.Zero(),n.Pq.Zero())}static CreateNew(e,t,i,r,n,s,a){return u.Zero().update(e,t,i,r,n,s,a)}static CreateNewFromTo(e,t,i=n.uq.IdentityReadOnly){const r=new u(new n.Pq(0,0,0),new n.Pq(0,0,0));return u.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=n.uq.IdentityReadOnly){i.origin.copyFrom(e);const s=t.subtractToRef(e,i.direction),a=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return i.length=a,i.direction.normalize(),u.TransformToRef(i,r,i)}static Transform(e,t){const i=new u(new n.Pq(0,0,0),new n.Pq(0,0,0));return u.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){n.Pq.TransformCoordinatesToRef(e.origin,t,i.origin),n.Pq.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;const r=i.direction,s=r.length();if(0!==s&&1!==s){const e=1/s;r.x*=e,r.y*=e,r.z*=e,i.length*=s}return i}unprojectRayToRef(e,t,i,r,s,a,o){const c=n.AA.Matrix[0];s.multiplyToRef(a,c),c.multiplyToRef(o,c),c.invert();const h=l.q.LastCreatedEngine,u=n.AA.Vector3[0];u.x=e/i*2-1,u.y=-(t/r*2-1),u.z=h?.useReverseDepthBuffer?1:h?.isNDCHalfZRange?0:-1;const d=n.AA.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),p=n.AA.Vector3[2],f=n.AA.Vector3[3];n.Pq._UnprojectFromInvertedMatrixToRef(u,c,p),n.Pq._UnprojectFromInvertedMatrixToRef(d,c,f),this.origin.copyFrom(p),f.subtractToRef(p,this.direction),this.direction.normalize()}}function d(e,t,i,r,n,s=!1){const a=u.Zero();return p(e,t,i,r,a,n,s),a}function p(e,t,i,r,s,a,o=!1,l=!1){const c=e.getEngine();if(!a&&!(a=e.activeCamera))return e;const h=a.viewport,u=c.getRenderHeight(),{x:d,y:p,width:f,height:m}=h.toGlobal(c.getRenderWidth(),u),_=1/c.getHardwareScalingLevel();return t=t*_-d,i=i*_-(u-p-m),s.update(t,i,f,m,r||n.uq.IdentityReadOnly,o?n.uq.IdentityReadOnly:a.getViewMatrix(),a.getProjectionMatrix(),l),e}function f(e,t,i,r){const n=u.Zero();return m(e,t,i,n,r),n}function m(e,t,i,r,s){if(!o.G)return e;const a=e.getEngine();if(!s&&!(s=e.activeCamera))throw new Error("Active camera not set");const l=s.viewport,c=a.getRenderHeight(),{x:h,y:u,width:d,height:p}=l.toGlobal(a.getRenderWidth(),c),f=n.uq.Identity(),m=1/a.getHardwareScalingLevel();return t=t*m-h,i=i*m-(c-u-p),r.update(t,i,d,p,f,f,s.getProjectionMatrix()),e}function _(e,t,i,r,n,s,a,o){const l=t(r,i.enableDistantPicking),c=i.intersects(l,n,a,s,r,o);return c&&c.hit?!n&&null!=e&&c.distance>=e.distance?null:c:null}function g(e,t,i,r,s,a){let l=null;const c=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),u=e.cameraToUseForPointers||e.activeCamera,d=h.internalPickerForMesh||_;for(let o=0;o<e.meshes.length;o++){const h=e.meshes[o];if(i){if(!i(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const p=c&&h.isWorldMatrixCameraDependent(),f=h.computeWorldMatrix(p,u);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const e=d(l,t,h,f,!0,!0,a);if(e){if(s)return e;const o=n.AA.Matrix[1],c=h.thinInstanceGetWorldMatrices();for(let e=0;e<c.length;e++){if(i&&!i(h,e))continue;c[e].multiplyToRef(f,o);const n=d(l,t,h,o,r,s,a,!0);if(n&&(l=n,l.thinInstanceIndex=e,r))return l}}}else{const e=d(l,t,h,f,r,s,a);if(e&&(l=e,r))return l}}return l||new o.G}function v(e,t,i,r){if(!o.G)return null;const s=[],a=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),l=e.cameraToUseForPointers||e.activeCamera,c=h.internalPickerForMesh||_;for(let o=0;o<e.meshes.length;o++){const h=e.meshes[o];if(i){if(!i(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const u=a&&h.isWorldMatrixCameraDependent(),d=h.computeWorldMatrix(u,l);if(h.hasThinInstances&&h.thinInstanceEnablePicking){if(c(null,t,h,d,!0,!0,r)){const e=n.AA.Matrix[1],a=h.thinInstanceGetWorldMatrices();for(let n=0;n<a.length;n++){if(i&&!i(h,n))continue;a[n].multiplyToRef(d,e);const o=c(null,t,h,e,!1,!1,r,!0);o&&(o.thinInstanceIndex=n,s.push(o))}}}else{const e=c(null,t,h,d,!1,!1,r);e&&s.push(e)}}return s}function S(e,t,i,r,s,a){if(!o.G)return null;const l=g(e,(r=>(e._tempPickingRay||(e._tempPickingRay=u.Zero()),p(e,t,i,r,e._tempPickingRay,a||null),e._tempPickingRay)),r,s,!0);return l&&(l.ray=d(e,t,i,n.uq.Identity(),a||null)),l}function x(e,t,i,r,s,a,o,l=!1){const c=g(e,((r,n)=>(e._tempPickingRay||(e._tempPickingRay=u.Zero()),p(e,t,i,r,e._tempPickingRay,a||null,!1,n),e._tempPickingRay)),r,s,!1,o);return c&&(c.ray=d(e,t,i,n.uq.Identity(),a||null)),c}function T(e,t,i,r,s){const a=g(e,(i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=n.uq.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=u.Zero()),u.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform)),i,r,!1,s);return a&&(a.ray=t),a}function E(e,t,i,r,n,s){return v(e,(r=>d(e,t,i,r,n||null)),r,s)}function C(e,t,i,r){return v(e,(i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=n.uq.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=u.Zero()),u.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform)),i,r)}function b(e,t=100,i,r){return P(e,new u(n.Pq.Zero(),n.Pq.Zero(),t),t,i,r)}function P(e,t,i=100,r,s){r||(r=e.getWorldMatrix()),t.length=i,s?t.origin.copyFrom(s):t.origin.copyFrom(e.position);const a=n.AA.Vector3[2];a.set(0,0,e._scene.useRightHandedSystem?-1:1);const o=n.AA.Vector3[3];return n.Pq.TransformNormalToRef(a,r,o),n.Pq.NormalizeToRef(o,t.direction),t}function y(e,t){t&&(t.prototype.getForwardRay=function(e=100,t,i){return P(this,new u(n.Pq.Zero(),n.Pq.Zero(),e),e,t,i)},t.prototype.getForwardRayToRef=function(e,t=100,i,r){return P(this,e,t,i,r)}),e&&(c.h._IsPickingAvailable=!0,e.prototype.createPickingRay=function(e,t,i,r,n=!1){return d(this,e,t,i,r,n)})}u._TmpVector3=(0,s.mI)(6,n.Pq.Zero),u._RayDistant=u.Zero(),u._Smallnum=1e-8,u._Rayl=1e9},1675:(e,t,i)=>{i.d(t,{AU:()=>s.AU,DY:()=>s.DY,Gz:()=>s.Gz,KI:()=>s.KI,Oj:()=>s.Oj,R0:()=>s.R0,Rl:()=>s.Rl,S:()=>s.S,TR:()=>s.TR,m9:()=>s.m9,mc:()=>s.mc,oZ:()=>s.oZ,uW:()=>s.uW,ui:()=>s.ui});var r=i(86521),n=i(63832),s=i(39626);(0,s.Oj)(r.Z,n.i),r.Z.prototype.createPickingRayToRef=function(e,t,i,r,n,a=!1,o=!1){return(0,s.Gz)(this,e,t,i,r,n,a,o)},r.Z.prototype.createPickingRayInCameraSpace=function(e,t,i){return(0,s.AU)(this,e,t,i)},r.Z.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,r){return(0,s.oZ)(this,e,t,i,r)},r.Z.prototype.pickWithBoundingInfo=function(e,t,i,r,n){return(0,s.uW)(this,e,t,i,r,n)},r.Z.prototype.pick=function(e,t,i,r,n,a,o=!1){return(0,s.mc)(this,e,t,i,r,n,a,o)},r.Z.prototype.pickWithRay=function(e,t,i,r){return(0,s.S)(this,e,t,i,r)},r.Z.prototype.multiPick=function(e,t,i,r,n){return(0,s.DY)(this,e,t,i,r,n)},r.Z.prototype.multiPickWithRay=function(e,t,i){return(0,s.TR)(this,e,t,i)}},28425:(e,t,i)=>{i.r(t),i.d(t,{AxesViewer:()=>l,BoneAxesViewer:()=>h,DebugLayer:()=>_,DebugLayerTab:()=>u,DirectionalLightFrustumViewer:()=>k,PhysicsViewer:()=>I,RayHelper:()=>O,SkeletonViewer:()=>V});var r=i(54983),n=i(78065),s=i(8209),a=i(39341),o=i(69583);class l{get scaleLines(){return this._scaleLines}set scaleLines(e){this._scaleLines=e,this._xAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor),this._yAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor),this._zAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor)}get xAxis(){return this._xAxis}get yAxis(){return this._yAxis}get zAxis(){return this._zAxis}constructor(e,t=1,i=2,c,h,u,d=1){if(this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this._scaleLines=1,e=e||o.q.LastCreatedScene){if(!c){const t=new n.F("xAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=a.v9.Red().scale(.5),c=s.e._CreateArrow(e,t,d)}if(!h){const t=new n.F("yAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=a.v9.Green().scale(.5),h=s.e._CreateArrow(e,t,d)}if(!u){const t=new n.F("zAxisMaterial",e);t.disableLighting=!0,t.emissiveColor=a.v9.Blue().scale(.5),u=s.e._CreateArrow(e,t,d)}this._xAxis=c,this._yAxis=h,this._zAxis=u,this.scaleLines=t,null!=i&&(l._SetRenderingGroupId(this._xAxis,i),l._SetRenderingGroupId(this._yAxis,i),l._SetRenderingGroupId(this._zAxis,i)),this.scene=e,this.update(new r.Pq,r.Pq.Right(),r.Pq.Up(),r.Pq.Forward())}}update(e,t,i,r){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(i),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(r)}createInstance(){const e=s.e._CreateArrowInstance(this.scene,this._xAxis),t=s.e._CreateArrowInstance(this.scene,this._yAxis),i=s.e._CreateArrowInstance(this.scene,this._zAxis),r=new l(this.scene,this.scaleLines,null,e,t,i);return r._instanced=!0,r}dispose(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null}static _SetRenderingGroupId(e,t){e.getChildMeshes().forEach((e=>{e.renderingGroupId=t}))}}var c=i(73537);class h extends l{constructor(e,t,i,n=1){super(e,n),this.pos=r.Pq.Zero(),this.xaxis=r.Pq.Zero(),this.yaxis=r.Pq.Zero(),this.zaxis=r.Pq.Zero(),this.mesh=i,this.bone=t}update(){if(!this.mesh||!this.bone)return;const e=this.bone;e.getAbsolutePositionToRef(this.mesh,this.pos),e.getDirectionToRef(c._0.X,this.mesh,this.xaxis),e.getDirectionToRef(c._0.Y,this.mesh,this.yaxis),e.getDirectionToRef(c._0.Z,this.mesh,this.zaxis),super.update(this.pos,this.xaxis,this.yaxis,this.zaxis)}dispose(){this.mesh&&(this.mesh=null,this.bone=null,super.dispose())}}var u,d=i(90066),p=i(6740),f=i(86521),m=i(80770);Object.defineProperty(f.Z.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new _(this)),this._debugLayer},enumerable:!0,configurable:!0}),function(e){e[e.Properties=0]="Properties",e[e.Debug=1]="Debug",e[e.Statistics=2]="Statistics",e[e.Tools=3]="Tools",e[e.Settings=4]="Settings"}(u||(u={}));class _{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new p.cP),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new p.cP),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||o.q.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add((()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()}))}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const e of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(e);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const e of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(e);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={..._.Config,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}popupSceneExplorer(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupSceneExplorer()}popupInspector(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupInspector()}popupEmbed(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupEmbed()}show(e){return new Promise((t=>{if(void 0===this.BJSINSPECTOR){const i=e&&e.inspectorURL?e.inspectorURL:_.InspectorURL;d.S0.LoadBabylonScript(i,(()=>{this._createInspector(e),t(this)}))}else this._createInspector(e),t(this)}))}}_.InspectorURL=`${d.S0._DefaultCdnUrl}/v${m.$.Version}/inspector/babylon.inspector.bundle.js`,_.Config={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0};var g=i(9191),v=i(18917),S=i(90197),x=i(29206),T=i(35881),E=i(84900),C=i(86795),b=i(70461),P=i(33543),y=i(32404),A=i(34116),R=i(50507);class I{constructor(e){if(this._impostors=[],this._meshes=[],this._bodies=[],this._inertiaBodies=[],this._constraints=[],this._bodyMeshes=[],this._inertiaMeshes=[],this._constraintMeshes=[],this._numMeshes=0,this._numBodies=0,this._numInertiaBodies=0,this._numConstraints=0,this._debugMeshMeshes=new Array,this._constraintAxesSize=.4,this._scene=e||o.q.LastCreatedScene,!this._scene)return;const t=this._scene.getPhysicsEngine();t&&(this._physicsEnginePlugin=t.getPhysicsPlugin()),this._utilityLayer=new T.j(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0}_updateDebugMeshes(){const e=this._physicsEnginePlugin;1===e?.getPluginVersion()?this._updateDebugMeshesV1():this._updateDebugMeshesV2()}_updateDebugMeshesV1(){const e=this._physicsEnginePlugin;for(let t=0;t<this._numMeshes;t++){const i=this._impostors[t];if(i)if(i.isDisposed)this.hideImpostor(this._impostors[t--]);else{if(i.type===x.j.MeshImpostor)continue;const r=this._meshes[t];r&&e&&e.syncMeshWithImpostor(r,i)}}}_updateDebugMeshesV2(){const e=this._physicsEnginePlugin;for(let t=0;t<this._numBodies;){const i=this._bodies[t];if(i&&i.isDisposed&&this.hideBody(i))continue;const r=this._bodyMeshes[t];i&&r&&e.syncTransform(i,r),t++}}_updateInertiaMeshes(){for(let e=0;e<this._numInertiaBodies;){const t=this._inertiaBodies[e];if(t&&t.isDisposed&&this.hideInertia(t))continue;const i=this._inertiaMeshes[e];t&&i&&this._updateDebugInertia(t,i),e++}}_updateDebugInertia(e,t){const i=r.uq.Identity(),n=r.uq.Identity(),s=r.uq.Identity();if(e._pluginDataInstances.length){const a=t,o=a._thinInstanceDataStorage.matrixData,l=e.transformNode._thinInstanceDataStorage.matrixData;for(let t=0;t<e._pluginDataInstances.length;t++){const a=e.getMassProperties(t);this._getMeshDebugInertiaMatrixToRef(a,i),r.uq.FromArrayToRef(l,16*t,n),i.multiplyToRef(n,s),s.copyToArray(o,16*t)}a.thinInstanceBufferUpdated("matrix")}else{const r=e.getMassProperties();if(this._getMeshDebugInertiaMatrixToRef(r,i),e.transformNode.rotationQuaternion?.toRotationMatrix(n),n.setTranslation(e.transformNode.position),e.transformNode.parent){const t=e.transformNode.parent.computeWorldMatrix(!0);n.multiplyToRef(t,n)}i.multiplyToRef(n,i),i.decomposeToTransformNode(t)}}_updateDebugConstraints(){for(let e=0;e<this._numConstraints;e++){const t=this._constraints[e],i=this._constraintMeshes[e];t&&i&&this._updateDebugConstraint(t,i)}}_makeScalingUnitInPlace(e){Math.abs(e.x-1)>R.bH&&(e.x=1*Math.sign(e.x)),Math.abs(e.y-1)>R.bH&&(e.y=1*Math.sign(e.y)),Math.abs(e.z-1)>R.bH&&(e.z=1*Math.sign(e.z))}_updateDebugConstraint(e,t){if(!e._initOptions)return;const{pivotA:i,pivotB:n,axisA:s,axisB:a,perpAxisA:o,perpAxisB:l}=e._initOptions;i&&n&&s&&a&&o&&l&&t.getDescendants(!0).forEach((e=>{const t=e.getDescendants(!0)[0],c=e.getDescendants(!0)[1],{parentBody:h,parentBodyIndex:u}=t.metadata,{childBody:d,childBodyIndex:p}=c.metadata,f=this._getTransformFromBodyToRef(h,r.AA.Matrix[0],u),m=this._getTransformFromBodyToRef(d,r.AA.Matrix[1],p);f.decomposeToTransformNode(t),this._makeScalingUnitInPlace(t.scaling),m.decomposeToTransformNode(c),this._makeScalingUnitInPlace(c.scaling);const _=t.getDescendants(!0)[0];_.position.copyFrom(i);const g=c.getDescendants(!0)[0];g.position.copyFrom(n),r.PT.FromRotationMatrixToRef(r.uq.FromXYZAxesToRef(s,o,r.Pq.CrossToRef(s,o,r.AA.Vector3[0]),r.AA.Matrix[0]),_.rotationQuaternion),r.PT.FromRotationMatrixToRef(r.uq.FromXYZAxesToRef(a,l,r.Pq.CrossToRef(a,l,r.AA.Vector3[1]),r.AA.Matrix[1]),g.rotationQuaternion)}))}showImpostor(e,t){if(!this._scene)return null;for(let t=0;t<this._numMeshes;t++)if(this._impostors[t]==e)return null;const i=this._getDebugMesh(e,t);return i&&(this._impostors[this._numMeshes]=e,this._meshes[this._numMeshes]=i,0===this._numMeshes&&(this._renderFunction=()=>this._updateDebugMeshes(),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++),i}showBody(e){if(!this._scene)return null;for(let t=0;t<this._numBodies;t++)if(this._bodies[t]==e)return null;const t=this._getDebugBodyMesh(e);return t&&(this._bodies[this._numBodies]=e,this._bodyMeshes[this._numBodies]=t,0===this._numBodies&&(this._renderFunction=()=>this._updateDebugMeshes(),this._scene.registerBeforeRender(this._renderFunction)),this._numBodies++),t}showInertia(e){if(!this._scene)return null;for(let t=0;t<this._numInertiaBodies;t++)if(this._inertiaBodies[t]==e)return null;const t=this._getDebugInertiaMesh(e);return t&&(this._inertiaBodies[this._numInertiaBodies]=e,this._inertiaMeshes[this._numInertiaBodies]=t,0===this._numInertiaBodies&&(this._inertiaRenderFunction=()=>this._updateInertiaMeshes(),this._scene.registerBeforeRender(this._inertiaRenderFunction)),this._numInertiaBodies++),t}showConstraint(e){if(!this._scene)return null;for(let t=0;t<this._numConstraints;t++)if(this._constraints[t]==e)return null;const t=this._getDebugConstraintMesh(e);return t&&(this._constraints[this._numConstraints]=e,this._constraintMeshes[this._numConstraints]=t,0===this._numConstraints&&(this._constraintRenderFunction=()=>this._updateDebugConstraints(),this._scene.registerBeforeRender(this._constraintRenderFunction)),this._numConstraints++),t}hideImpostor(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numMeshes;r++)if(this._impostors[r]==e){const e=this._meshes[r];if(!e)continue;i.removeMesh(e),e.dispose();const n=this._debugMeshMeshes.indexOf(e);n>-1&&this._debugMeshMeshes.splice(n,1),this._numMeshes--,this._numMeshes>0?(this._meshes[r]=this._meshes[this._numMeshes],this._impostors[r]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),t=!0;break}t&&0===this._numMeshes&&this._scene.unregisterBeforeRender(this._renderFunction)}hideBody(e){if(!e||!this._scene||!this._utilityLayer)return!1;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numBodies;r++)if(this._bodies[r]===e){const e=this._bodyMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._numBodies--,this._numBodies>0?(this._bodyMeshes[r]=this._bodyMeshes[this._numBodies],this._bodies[r]=this._bodies[this._numBodies],this._bodyMeshes[this._numBodies]=null,this._bodies[this._numBodies]=null):(this._bodyMeshes[0]=null,this._bodies[0]=null),t=!0;break}return t&&0===this._numBodies&&this._scene.unregisterBeforeRender(this._renderFunction),t}hideInertia(e){if(!e||!this._scene||!this._utilityLayer)return!1;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numInertiaBodies;r++)if(this._inertiaBodies[r]===e){const e=this._inertiaMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._inertiaBodies.splice(r,1),this._inertiaMeshes.splice(r,1),this._numInertiaBodies--,t=!0;break}return t&&0===this._numInertiaBodies&&this._scene.unregisterBeforeRender(this._inertiaRenderFunction),t}hideConstraint(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1;const i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numConstraints;r++)if(this._constraints[r]===e){const e=this._constraintMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._constraints.splice(r,1),this._constraintMeshes.splice(r,1),this._numConstraints--,this._numConstraints>0?(this._constraints[r]=this._constraints[this._numConstraints],this._constraintMeshes[r]=this._constraintMeshes[this._numConstraints],this._constraints[this._numConstraints]=null,this._constraintMeshes[this._numConstraints]=null):(this._constraints[0]=null,this._constraintMeshes[0]=null),t=!0;break}t&&0===this._numConstraints&&this._scene.unregisterBeforeRender(this._constraintRenderFunction)}_getDebugMaterial(e){return this._debugMaterial||(this._debugMaterial=new n.F("",e),this._debugMaterial.wireframe=!0,this._debugMaterial.emissiveColor=a.v9.White(),this._debugMaterial.disableLighting=!0),this._debugMaterial}_getDebugInertiaMaterial(e){return this._debugInertiaMaterial||(this._debugInertiaMaterial=new n.F("",e),this._debugInertiaMaterial.disableLighting=!0,this._debugInertiaMaterial.alpha=0),this._debugInertiaMaterial}_getDebugBoxMesh(e){return this._debugBoxMesh||(this._debugBoxMesh=(0,v.an)("physicsBodyBoxViewMesh",{size:1},e),this._debugBoxMesh.rotationQuaternion=r.PT.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(e),this._debugBoxMesh.setEnabled(!1)),this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")}_getDebugSphereMesh(e){return this._debugSphereMesh||(this._debugSphereMesh=(0,S._6)("physicsBodySphereViewMesh",{diameter:1},e),this._debugSphereMesh.rotationQuaternion=r.PT.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(e),this._debugSphereMesh.setEnabled(!1)),this._debugSphereMesh.createInstance("physicsBodySphereViewInstance")}_getDebugCapsuleMesh(e){return this._debugCapsuleMesh||(this._debugCapsuleMesh=(0,C._S)("physicsBodyCapsuleViewMesh",{height:1},e),this._debugCapsuleMesh.rotationQuaternion=r.PT.Identity(),this._debugCapsuleMesh.material=this._getDebugMaterial(e),this._debugCapsuleMesh.setEnabled(!1)),this._debugCapsuleMesh.createInstance("physicsBodyCapsuleViewInstance")}_getDebugCylinderMesh(e){return this._debugCylinderMesh||(this._debugCylinderMesh=(0,E.zk)("physicsBodyCylinderViewMesh",{diameterTop:1,diameterBottom:1,height:1},e),this._debugCylinderMesh.rotationQuaternion=r.PT.Identity(),this._debugCylinderMesh.material=this._getDebugMaterial(e),this._debugCylinderMesh.setEnabled(!1)),this._debugCylinderMesh.createInstance("physicsBodyCylinderViewInstance")}_getDebugMeshMesh(e,t){const i=new g.e(e.name,t,null,e);return i.setParent(e),i.position=r.Pq.Zero(),i.material=this._getDebugMaterial(t),this._debugMeshMeshes.push(i),i}_getDebugMesh(e,t){if(!this._utilityLayer)return null;if(t&&t.parent&&t.parent.physicsImpostor)return null;let i=null;const r=this._utilityLayer.utilityLayerScene;if(!e.physicsBody)return b.V.Warn("Unable to get physicsBody of impostor. It might be initialized later by its parent's impostor."),null;switch(e.type){case x.j.BoxImpostor:i=this._getDebugBoxMesh(r),e.getBoxSizeToRef(i.scaling);break;case x.j.SphereImpostor:{i=this._getDebugSphereMesh(r);const t=e.getRadius();i.scaling.x=2*t,i.scaling.y=2*t,i.scaling.z=2*t;break}case x.j.CapsuleImpostor:{i=this._getDebugCapsuleMesh(r);const t=e.object.getBoundingInfo();i.scaling.x=2*(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=2*(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z;break}case x.j.MeshImpostor:t&&(i=this._getDebugMeshMesh(t,r));break;case x.j.NoImpostor:t?t.getChildMeshes().filter((e=>e.physicsImpostor?1:0)).forEach((e=>{if(e.physicsImpostor&&"Mesh"===e.getClassName()){const t=e.getBoundingInfo(),n=t.boundingBox.minimum,s=t.boundingBox.maximum;switch(e.physicsImpostor.type){case x.j.BoxImpostor:i=this._getDebugBoxMesh(r),i.position.copyFrom(n),i.position.addInPlace(s),i.position.scaleInPlace(.5);break;case x.j.SphereImpostor:i=this._getDebugSphereMesh(r);break;case x.j.CylinderImpostor:i=this._getDebugCylinderMesh(r);break;default:i=null}i&&(i.scaling.x=s.x-n.x,i.scaling.y=s.y-n.y,i.scaling.z=s.z-n.z,i.parent=e)}})):b.V.Warn("No target mesh parameter provided for NoImpostor. Skipping."),i=null;break;case x.j.CylinderImpostor:{i=this._getDebugCylinderMesh(r);const t=e.object.getBoundingInfo();i.scaling.x=(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z;break}}return i}_getDebugBodyMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene,i=new g.e("custom",t),r=new P.P,n=e.getGeometry();if(r.positions=n.positions,r.indices=n.indices,r.applyToMesh(i),e._pluginDataInstances){const t=new Float32Array(16*e._pluginDataInstances.length);i.thinInstanceSetBuffer("matrix",t,16,!1)}return i.material=this._getDebugMaterial(t),i}_getMeshDebugInertiaMatrixToRef(e,t){const i=e.inertiaOrientation??r.PT.Identity(),n=e.inertia??r.Pq.Zero(),s=e.centerOfMass??r.Pq.Zero(),a=6*(n.x-n.y+n.z),o=Math.sqrt(Math.max(a,0)),l=12*n.x-a,c=Math.sqrt(Math.max(l,0)),h=12*n.z-a,u=Math.sqrt(Math.max(h,0)),d=r.AA.Vector3[0];d.set(u,o,c);const p=r.uq.ScalingToRef(d.x,d.y,d.z,r.AA.Matrix[0]),f=i.toRotationMatrix(r.AA.Matrix[1]),m=r.uq.TranslationToRef(s.x,s.y,s.z,r.AA.Matrix[2]);return p.multiplyToRef(f,t),t.multiplyToRef(m,t),t}_getDebugInertiaMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene,i=y.P.CreateBox("custom",{size:1},t),n=r.uq.Identity();if(e._pluginDataInstances.length){const t=new Float32Array(16*e._pluginDataInstances.length);for(let i=0;i<e._pluginDataInstances.length;++i){const r=e.getMassProperties(i);this._getMeshDebugInertiaMatrixToRef(r,n),n.copyToArray(t,16*i)}i.thinInstanceSetBuffer("matrix",t,16,!1)}else{const t=e.getMassProperties();this._getMeshDebugInertiaMatrixToRef(t,n),n.decomposeToTransformNode(i)}return i.enableEdgesRendering(),i.edgesWidth=2,i.edgesColor=new a.ov(1,0,1,1),i.material=this._getDebugInertiaMaterial(t),i}_getTransformFromBodyToRef(e,t,i){const n=e.transformNode;return i&&i>=0?r.uq.FromArrayToRef(n._thinInstanceDataStorage.matrixData,i,t):t.copyFrom(n.getWorldMatrix())}_getDebugConstraintMesh(e){if(!this._utilityLayer)return null;const t=this._utilityLayer.utilityLayerScene;if(!e._initOptions)return null;const{pivotA:i,pivotB:n,axisA:s,axisB:a,perpAxisA:o,perpAxisB:c}=e._initOptions;if(!(i&&n&&s&&a&&o&&c))return null;const h=new g.e("parentingDebugConstraint",t),u=e.getBodiesUsingConstraint();for(const e of u){const u=new A.V("parentOfPair",t);u.parent=h;const{parentBody:d,parentBodyIndex:p,childBody:f,childBodyIndex:m}=e,_=this._getTransformFromBodyToRef(d,r.AA.Matrix[0],p),g=this._getTransformFromBodyToRef(f,r.AA.Matrix[1],m),v=new A.V("parentCoordSystem",t);v.parent=u,v.metadata={parentBody:d,parentBodyIndex:p},_.decomposeToTransformNode(v);const S=new A.V("childCoordSystem",t);S.parent=u,S.metadata={childBody:f,childBodyIndex:m},g.decomposeToTransformNode(S);const x=r.PT.FromRotationMatrix(r.uq.FromXYZAxesToRef(s,o,s.cross(o),r.AA.Matrix[0])),T=r.PT.FromRotationMatrix(r.uq.FromXYZAxesToRef(a,c,a.cross(c),r.AA.Matrix[0])),E=i,C=n,b=new A.V("constraint_parent",t);b.position.copyFrom(E),b.rotationQuaternion=x,b.parent=v;const P=new A.V("constraint_child",t);P.parent=S,P.position.copyFrom(C),P.rotationQuaternion=T;const y=new l(t,this._constraintAxesSize);y.xAxis.parent=b,y.yAxis.parent=b,y.zAxis.parent=b;const R=new l(t,this._constraintAxesSize);R.xAxis.parent=P,R.yAxis.parent=P,R.zAxis.parent=P}return h}dispose(){for(let e=this._numMeshes-1;e>=0;e--)this.hideImpostor(this._impostors[0]);for(let e=this._numBodies-1;e>=0;e--)this.hideBody(this._bodies[0]);for(let e=this._numInertiaBodies-1;e>=0;e--)this.hideInertia(this._inertiaBodies[0]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugCylinderMesh&&this._debugCylinderMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null,this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null)}}var M=i(96487);class O{static CreateAndShow(e,t,i){const r=new O(e);return r.show(t,i),r}constructor(e){this.ray=e}show(e,t){if(!this._renderFunction&&this.ray){const t=this.ray;this._renderFunction=()=>this._render(),this._scene=e,this._renderPoints=[t.origin,t.origin.add(t.direction.scale(t.length))],this._renderLine=(0,M.sh)("ray",{points:this._renderPoints,updatable:!0},e),this._renderLine.isPickable=!1,this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}t&&this._renderLine&&this._renderLine.color.copyFrom(t)}hide(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])}_render(){const e=this.ray;if(!e)return;const t=this._renderPoints[1],i=Math.min(e.length,1e6);t.copyFrom(e.direction),t.scaleInPlace(i),t.addInPlace(e.origin),this._renderPoints[0].copyFrom(e.origin),(0,M.sh)("ray",{points:this._renderPoints,updatable:!0,instance:this._renderLine},this._scene),this._renderLine?.refreshBoundingInfo()}attachToMesh(e,t,i,n){this._attachedToMesh=e;const s=this.ray;s&&(s.direction||(s.direction=r.Pq.Zero()),s.origin||(s.origin=r.Pq.Zero()),n&&(s.length=n),i||(i=r.Pq.Zero()),t||(t=new r.Pq(0,0,-1)),this._scene||(this._scene=e.getScene()),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(t),this._meshSpaceOrigin.copyFrom(i)):(this._meshSpaceDirection=t.clone(),this._meshSpaceOrigin=i.clone()),this._onAfterRenderObserver||(this._onAfterRenderObserver=this._scene.onBeforeRenderObservable.add((()=>this._updateToMesh())),this._onAfterStepObserver=this._scene.onAfterStepObservable.add((()=>this._updateToMesh()))),this._attachedToMesh.computeWorldMatrix(!0),this._updateToMesh())}detachFromMesh(){this._attachedToMesh&&this._scene&&(this._onAfterRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._onAfterRenderObserver),this._scene.onAfterStepObservable.remove(this._onAfterStepObserver)),this._attachedToMesh=null,this._onAfterRenderObserver=null,this._onAfterStepObserver=null,this._scene=null)}_updateToMesh(){const e=this.ray;this._attachedToMesh&&e&&(this._attachedToMesh.isDisposed()?this.detachFromMesh():(this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,e.direction),r.Pq.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),e.origin)))}dispose(){this.hide(),this.detachFromMesh(),this.ray=null}}var N=i(93803),D=i(27225),F=i(41e3),L=i(59396),w=i(91056),B=i(32725);class V{static CreateBoneWeightShader(e,t){const i=e.skeleton,r=e.colorBase??a.v9.Black(),n=e.colorZero??a.v9.Blue(),s=e.colorQuarter??a.v9.Green(),o=e.colorHalf??a.v9.Yellow(),l=e.colorFull??a.v9.Red(),c=e.targetBoneIndex??0;w.M.ShadersStore["boneWeights:"+i.name+"VertexShader"]="precision highp float;\n\n        attribute vec3 position;\n        attribute vec2 uv;\n\n        uniform mat4 view;\n        uniform mat4 projection;\n        uniform mat4 worldViewProjection;\n\n        #include<bonesDeclaration>\n        #if NUM_BONE_INFLUENCERS == 0\n            attribute vec4 matricesIndices;\n            attribute vec4 matricesWeights;\n        #endif\n        #include<bakedVertexAnimationDeclaration>\n\n        #include<instancesDeclaration>\n\n        varying vec3 vColor;\n\n        uniform vec3 colorBase;\n        uniform vec3 colorZero;\n        uniform vec3 colorQuarter;\n        uniform vec3 colorHalf;\n        uniform vec3 colorFull;\n\n        uniform float targetBoneIndex;\n\n        void main() {\n            vec3 positionUpdated = position;\n\n            #include<instancesVertex>\n            #include<bonesVertex>\n            #include<bakedVertexAnimation>\n\n            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n            vec3 color = colorBase;\n            float totalWeight = 0.;\n            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){\n                totalWeight += matricesWeights[0];\n            }\n            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){\n                totalWeight += matricesWeights[1];\n            }\n            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){\n                totalWeight += matricesWeights[2];\n            }\n            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){\n                totalWeight += matricesWeights[3];\n            }\n\n            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));\n            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));\n            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));\n            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));\n            vColor = color;\n\n        gl_Position = projection * view * worldPos;\n        }",w.M.ShadersStore["boneWeights:"+i.name+"FragmentShader"]="\n            precision highp float;\n            varying vec3 vPosition;\n\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4(vColor, 1.0);\n                gl_FragColor = color;\n            }\n        ";const h=new D.B("boneWeight:"+i.name,t,{vertex:"boneWeights:"+i.name,fragment:"boneWeights:"+i.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return h.setColor3("colorBase",r),h.setColor3("colorZero",n),h.setColor3("colorQuarter",s),h.setColor3("colorHalf",o),h.setColor3("colorFull",l),h.setFloat("targetBoneIndex",c),h.getClassName=()=>"BoneWeightShader",h.transparencyMode=N.i.MATERIAL_OPAQUE,h}static CreateSkeletonMapShader(e,t){const i=e.skeleton,r=e.colorMap??[{color:new a.v9(1,.38,.18),location:0},{color:new a.v9(.59,.18,1),location:.2},{color:new a.v9(.59,1,.18),location:.4},{color:new a.v9(1,.87,.17),location:.6},{color:new a.v9(1,.17,.42),location:.8},{color:new a.v9(.17,.68,1),location:1}],n=i.bones.length+1,s=V._CreateBoneMapColorBuffer(n,r,t),o=new D.B("boneWeights:"+i.name,t,{vertexSource:"precision highp float;\n\n            attribute vec3 position;\n            attribute vec2 uv;\n\n            uniform mat4 view;\n            uniform mat4 projection;\n            uniform mat4 worldViewProjection;\n            uniform float colorMap["+4*i.bones.length+"];\n\n            #include<bonesDeclaration>\n            #if NUM_BONE_INFLUENCERS == 0\n                attribute vec4 matricesIndices;\n                attribute vec4 matricesWeights;\n            #endif\n            #include<bakedVertexAnimationDeclaration>\n            #include<instancesDeclaration>\n\n            varying vec3 vColor;\n\n            void main() {\n                vec3 positionUpdated = position;\n\n                #include<instancesVertex>\n                #include<bonesVertex>\n                #include<bakedVertexAnimation>\n\n                vec3 color = vec3(0.);\n                bool first = true;\n\n                for (int i = 0; i < 4; i++) {\n                    int boneIdx = int(matricesIndices[i]);\n                    float boneWgt = matricesWeights[i];\n\n                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);\n\n                    if (boneWgt > 0.) {\n                        if (first) {\n                            first = false;\n                            color = c;\n                        } else {\n                            color = mix(color, c, boneWgt);\n                        }\n                    }\n                }\n\n                vColor = color;\n\n                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);\n\n                gl_Position = projection * view * worldPos;\n            }",fragmentSource:"\n            precision highp float;\n            varying vec3 vColor;\n\n            void main() {\n                vec4 color = vec4( vColor, 1.0 );\n                gl_FragColor = color;\n            }\n            "},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return o.setFloats("colorMap",s),o.getClassName=()=>"SkeletonMapShader",o.transparencyMode=N.i.MATERIAL_OPAQUE,o}static _CreateBoneMapColorBuffer(e,t,i){const r=new F.R("temp",{width:e,height:1},i,!1),n=r.getContext(),s=n.createLinearGradient(0,0,e,0);t.forEach((e=>{s.addColorStop(e.location,e.color.toHexString())})),n.fillStyle=s,n.fillRect(0,0,e,1),r.update();const a=[],o=n.getImageData(0,0,e,1).data,l=1/255;for(let e=0;e<o.length;e++)a.push(o[e]*l);return r.dispose(),a}get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get isReady(){return this._ready}set ready(e){this._ready=e}get debugMesh(){return this._debugMesh}set debugMesh(e){this._debugMesh=e}get displayMode(){return this.options.displayMode||V.DISPLAY_LINES}set displayMode(e){e>V.DISPLAY_SPHERE_AND_SPURS&&(e=V.DISPLAY_LINES),this.options.displayMode=e}constructor(e,t,i,r=!0,n=3,s={}){if(this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=r,this.renderingGroupId=n,this.options=s,this.color=a.v9.White(),this._debugLines=new Array,this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=i,this._ready=!1,s.pauseAnimations=s.pauseAnimations??!0,s.returnToRest=s.returnToRest??!1,s.displayMode=s.displayMode??V.DISPLAY_LINES,s.displayOptions=s.displayOptions??{},s.displayOptions.midStep=s.displayOptions.midStep??.235,s.displayOptions.midStepFactor=s.displayOptions.midStepFactor??.155,s.displayOptions.sphereBaseSize=s.displayOptions.sphereBaseSize??.15,s.displayOptions.sphereScaleUnit=s.displayOptions.sphereScaleUnit??2,s.displayOptions.sphereFactor=s.displayOptions.sphereFactor??.865,s.displayOptions.spurFollowsChild=s.displayOptions.spurFollowsChild??!1,s.displayOptions.showLocalAxes=s.displayOptions.showLocalAxes??!1,s.displayOptions.localAxesSize=s.displayOptions.localAxesSize??.075,s.computeBonesUsingShaders=s.computeBonesUsingShaders??!0,s.useAllBones=s.useAllBones??!0,this._boneIndices=new Set,!s.useAllBones){const e=t?.getVerticesData(L.R.MatricesIndicesKind),i=t?.getVerticesData(L.R.MatricesWeightsKind);if(e&&i)for(let t=0;t<e.length;++t){const r=e[t];0!==i[t]&&this._boneIndices.add(r)}}this._utilityLayer=new T.j(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;let o=this.options.displayMode||0;o>V.DISPLAY_SPHERE_AND_SPURS&&(o=V.DISPLAY_LINES),this.displayMode=o,this.update(),this._bindObs()}_bindObs(){this.displayMode===V.DISPLAY_LINES&&(this._obs=this.scene.onBeforeRenderObservable.add((()=>{this._displayLinesUpdate()})))}update(){switch(this.displayMode){case V.DISPLAY_LINES:this._displayLinesUpdate();break;case V.DISPLAY_SPHERES:this._buildSpheresAndSpurs(!0);break;case V.DISPLAY_SPHERE_AND_SPURS:this._buildSpheresAndSpurs(!1)}this._buildLocalAxes()}set isEnabled(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))}get isEnabled(){return this._isEnabled}_getBonePosition(e,t,i,n=0,s=0,a=0){const o=r.AA.Matrix[0],l=t.getParent();if(o.copyFrom(t.getLocalMatrix()),0!==n||0!==s||0!==a){const e=r.AA.Matrix[1];r.uq.IdentityToRef(e),e.setTranslationFromFloats(n,s,a),e.multiplyToRef(o,o)}l&&o.multiplyToRef(l.getAbsoluteMatrix(),o),o.multiplyToRef(i,o),e.x=o.m[12],e.y=o.m[13],e.z=o.m[14]}_getLinesForBonesWithLength(e,t){const i=e.length;let n,s;t?(n=t.getWorldMatrix(),s=t.position):(n=new r.uq,s=e[0].position);let a=0;for(let t=0;t<i;t++){const i=e[t];let o=this._debugLines[a];-1!==i._index&&(this._boneIndices.has(i.getIndex())||this.options.useAllBones)&&(o||(o=[r.Pq.Zero(),r.Pq.Zero()],this._debugLines[a]=o),this._getBonePosition(o[0],i,n),this._getBonePosition(o[1],i,n,0,i.length,0),o[0].subtractInPlace(s),o[1].subtractInPlace(s),a++)}}_getLinesForBonesNoLength(e){const t=e.length;let i=0;const n=this.mesh;let s,a;n?(s=n,a=n.position):(s=new A.V(""),a=e[0].position);for(let n=t-1;n>=0;n--){const t=e[n],o=t.getParent();if(!o||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;let l=this._debugLines[i];l||(l=[r.Pq.Zero(),r.Pq.Zero()],this._debugLines[i]=l),t.getAbsolutePositionToRef(s,l[0]),o.getAbsolutePositionToRef(s,l[1]),l[0].subtractInPlace(a),l[1].subtractInPlace(a),i++}n||s.dispose()}_revert(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)}_getAbsoluteBindPoseToRef(e,t){null!==e&&-1!==e._index?(this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBindMatrix().multiplyToRef(t,t)):t.copyFrom(r.uq.Identity())}_createSpur(e,t,i,n,s,a){const o=i.subtract(e),l=o.length(),c=o.normalize().scale(l),h=s.midStep||.165,u=s.midStepFactor||.215,d=c.scale(h),p=(0,B.ei)("skeletonViewer",{shape:[new r.Pq(1,-1,0),new r.Pq(1,1,0),new r.Pq(-1,1,0),new r.Pq(-1,-1,0),new r.Pq(1,-1,0)],path:[r.Pq.Zero(),d,c],scaleFunction:e=>{switch(e){case 0:case 2:return 0;case 1:return l*u}return 0},sideOrientation:g.e.DEFAULTSIDE,updatable:!1},a),f=p.getTotalVertices(),m=[],_=[];for(let e=0;e<f;e++)m.push(1,0,0,0),n&&s.spurFollowsChild&&e>9?_.push(n.getIndex(),0,0,0):_.push(t.getIndex(),0,0,0);return p.position=e.clone(),p.setVerticesData(L.R.MatricesWeightsKind,m,!1),p.setVerticesData(L.R.MatricesIndicesKind,_,!1),p.convertToFlatShadedMesh(),p}_getBoundingSphereForBone(e){if(!this.mesh)return null;const t=this.mesh.getVerticesData(L.R.PositionKind),i=this.mesh.getIndices(),n=this.mesh.getVerticesData(L.R.MatricesWeightsKind),s=this.mesh.getVerticesData(L.R.MatricesIndicesKind);if(!(t&&i&&n&&s))return null;const a=new r.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new r.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);let l=0;for(let c=0;c<i.length;++c){const h=i[c];for(let i=0;i<4;++i){const c=s[4*h+i],u=n[4*h+i];if(c===e&&u>1e-5){r.Pq.FromArrayToRef(t,3*h,r.AA.Vector3[0]),a.minimizeInPlace(r.AA.Vector3[0]),o.maximizeInPlace(r.AA.Vector3[0]),l++;break}}}return l>1?{center:r.Pq.Center(a,o),radius:r.Pq.Distance(a,o)/2}:null}_buildSpheresAndSpurs(e=!0){this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;const t=this.utilityLayer?.utilityLayerScene,i=this.skeleton.bones,n=[],s=[],a=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,t.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices();let o=Number.NEGATIVE_INFINITY;const l=this.options.displayOptions||{};for(let a=0;a<i.length;a++){const c=i[a];if(-1===c._index||!this._boneIndices.has(c.getIndex())&&!this.options.useAllBones)continue;const h=new r.uq;this._getAbsoluteBindPoseToRef(c,h);const u=new r.Pq;if(h.decompose(void 0,void 0,u),c.children.length>0)c.children.forEach((i=>{const n=new r.uq;i.getLocalMatrix().multiplyToRef(h,n);const a=new r.Pq;n.decompose(void 0,void 0,a);const d=r.Pq.Distance(u,a);d>o&&(o=d),e||s.push(this._createSpur(u,c,a,i,l,t))}));else{const i=this._getBoundingSphereForBone(c.getIndex());if(i&&(i.radius>o&&(o=i.radius),!e)){let e;const n=c.getParent();n?(this._getAbsoluteBindPoseToRef(n,h),h.decompose(void 0,void 0,r.AA.Vector3[0]),e=u.subtract(r.AA.Vector3[0]).normalize().scale(i.radius).add(u)):e=i.center.subtract(u).normalize().scale(i.radius).add(u),s.push(this._createSpur(u,c,e,null,l,t))}}const d=l.sphereBaseSize||.2,p=(0,S._6)("skeletonViewer",{segments:6,diameter:d,updatable:!0},t),f=p.getTotalVertices(),m=[],_=[];for(let e=0;e<f;e++)m.push(1,0,0,0),_.push(c.getIndex(),0,0,0);p.setVerticesData(L.R.MatricesWeightsKind,m,!1),p.setVerticesData(L.R.MatricesIndicesKind,_,!1),p.position=u.clone(),n.push([p,c])}const c=l.sphereScaleUnit||2,h=l.sphereFactor||.85,u=[];for(let e=0;e<n.length;e++){const[t,i]=n[e],r=1/(c/o);let s=0,a=i;for(;a.getParent()&&-1!==a.getParent().getIndex();)s++,a=a.getParent();t.scaling.scaleInPlace(r*Math.pow(h,s)),u.push(t)}this.debugMesh=g.e.MergeMeshes(u.concat(s),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=this.options.computeBonesUsingShaders??!0,this.debugMesh.alwaysSelectAsActiveMesh=!0),this.utilityLayer._getSharedGizmoLight().intensity=.7,this._revert(a),this.ready=!0}catch(e){b.V.Error(e),this._revert(a),this.dispose()}}_buildLocalAxes(){this._localAxes&&this._localAxes.dispose(),this._localAxes=null;const e=this.options.displayOptions||{};if(!e.showLocalAxes)return;const t=this._utilityLayer.utilityLayerScene,i=e.localAxesSize||.075,n=[],s=[],o=new a.ov(1,0,0,1),l=new a.ov(0,1,0,1),c=new a.ov(0,0,1,1),h=[],u=[];for(const e in this.skeleton.bones){const t=this.skeleton.bones[e];if(-1===t._index||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;const a=new r.uq,d=new r.Pq;this._getAbsoluteBindPoseToRef(t,a),a.decompose(void 0,r.AA.Quaternion[0],d);const p=new r.uq;r.AA.Quaternion[0].toRotationMatrix(p);const f=r.Pq.TransformCoordinates(new r.Pq(0+i,0,0),p),m=r.Pq.TransformCoordinates(new r.Pq(0,0+i,0),p),_=r.Pq.TransformCoordinates(new r.Pq(0,0,0+i),p),g=[[d,d.add(f)],[d,d.add(m)],[d,d.add(_)]],v=[[o,o],[l,l],[c,c]];n.push(...g),s.push(...v);for(let e=0;e<6;e++)h.push(1,0,0,0),u.push(t.getIndex(),0,0,0)}this._localAxes=(0,M.uz)("localAxes",{lines:n,colors:s,updatable:!0},t),this._localAxes.setVerticesData(L.R.MatricesWeightsKind,h,!1),this._localAxes.setVerticesData(L.R.MatricesIndicesKind,u,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=this.options.computeBonesUsingShaders??!0}_displayLinesUpdate(){if(!this._utilityLayer)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh);const e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?(0,M.uz)("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=(0,M.uz)("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this.mesh?this._debugMesh.position.copyFrom(this.mesh.position):this._debugMesh.position.copyFrom(this.skeleton.bones[0].position),this._debugMesh.color=this.color)}changeDisplayMode(e){const t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)}changeDisplayOptions(e,t){const i=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=i}dispose(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1}}V.DISPLAY_LINES=0,V.DISPLAY_SPHERES=1,V.DISPLAY_SPHERE_AND_SPURS=2;class k{get transparency(){return this._transparency}set transparency(e){this._transparency=e;for(let t=6;t<12;++t)this._lightHelperFrustumMeshes[t].material.alpha=e}get showLines(){return this._showLines}set showLines(e){if(this._showLines!==e){this._showLines=e;for(let t=0;t<6;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}}get showPlanes(){return this._showPlanes}set showPlanes(e){if(this._showPlanes!==e){this._showPlanes=e;for(let t=6;t<12;++t)this._lightHelperFrustumMeshes[t].setEnabled(e)}}constructor(e,t){this._oldPosition=new r.Pq(Number.NaN,Number.NaN,Number.NaN),this._oldDirection=new r.Pq(Number.NaN,Number.NaN,Number.NaN),this._transparency=.3,this._showLines=!0,this._showPlanes=!0,this._scene=e.getScene(),this._light=e,this._camera=t,this._inverseViewMatrix=r.uq.Identity(),this._lightHelperFrustumMeshes=[],this._createGeometry(),this.show(),this.update()}show(){this._lightHelperFrustumMeshes.forEach(((e,t)=>{e.setEnabled(t<6&&this._showLines||t>=6&&this._showPlanes)})),this._oldPosition.set(Number.NaN,Number.NaN,Number.NaN),this._visible=!0}hide(){this._lightHelperFrustumMeshes.forEach((e=>{e.setEnabled(!1)})),this._visible=!1}update(){if(!this._visible)return;if(this._oldPosition.equals(this._light.position)&&this._oldDirection.equals(this._light.direction)&&this._oldAutoCalc===this._light.autoCalcShadowZBounds&&this._oldMinZ===this._light.shadowMinZ&&this._oldMaxZ===this._light.shadowMaxZ)return;this._oldPosition.copyFrom(this._light.position),this._oldDirection.copyFrom(this._light.direction),this._oldAutoCalc=this._light.autoCalcShadowZBounds,this._oldMinZ=this._light.shadowMinZ,this._oldMaxZ=this._light.shadowMaxZ,r.AA.Vector3[0].set(this._light.orthoLeft,this._light.orthoBottom,void 0!==this._light.shadowMinZ?this._light.shadowMinZ:this._camera.minZ),r.AA.Vector3[1].set(this._light.orthoRight,this._light.orthoTop,void 0!==this._light.shadowMaxZ?this._light.shadowMaxZ:this._camera.maxZ);const e=this._getInvertViewMatrix();r.AA.Vector3[2].copyFromFloats(r.AA.Vector3[1].x,r.AA.Vector3[1].y,r.AA.Vector3[0].z),r.AA.Vector3[3].copyFromFloats(r.AA.Vector3[1].x,r.AA.Vector3[0].y,r.AA.Vector3[0].z),r.AA.Vector3[4].copyFromFloats(r.AA.Vector3[0].x,r.AA.Vector3[0].y,r.AA.Vector3[0].z),r.AA.Vector3[5].copyFromFloats(r.AA.Vector3[0].x,r.AA.Vector3[1].y,r.AA.Vector3[0].z),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[2],e,r.AA.Vector3[2]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[3],e,r.AA.Vector3[3]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[4],e,r.AA.Vector3[4]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[5],e,r.AA.Vector3[5]),r.AA.Vector3[6].copyFromFloats(r.AA.Vector3[1].x,r.AA.Vector3[1].y,r.AA.Vector3[1].z),r.AA.Vector3[7].copyFromFloats(r.AA.Vector3[1].x,r.AA.Vector3[0].y,r.AA.Vector3[1].z),r.AA.Vector3[8].copyFromFloats(r.AA.Vector3[0].x,r.AA.Vector3[0].y,r.AA.Vector3[1].z),r.AA.Vector3[9].copyFromFloats(r.AA.Vector3[0].x,r.AA.Vector3[1].y,r.AA.Vector3[1].z),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[6],e,r.AA.Vector3[6]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[7],e,r.AA.Vector3[7]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[8],e,r.AA.Vector3[8]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3[9],e,r.AA.Vector3[9]),(0,M.sh)("nearlines",{updatable:!0,points:this._nearLinesPoints,instance:this._lightHelperFrustumMeshes[0]},this._scene),(0,M.sh)("farlines",{updatable:!0,points:this._farLinesPoints,instance:this._lightHelperFrustumMeshes[1]},this._scene),(0,M.sh)("trlines",{updatable:!0,points:this._trLinesPoints,instance:this._lightHelperFrustumMeshes[2]},this._scene),(0,M.sh)("brlines",{updatable:!0,points:this._brLinesPoints,instance:this._lightHelperFrustumMeshes[3]},this._scene),(0,M.sh)("tllines",{updatable:!0,points:this._tlLinesPoints,instance:this._lightHelperFrustumMeshes[4]},this._scene),(0,M.sh)("bllines",{updatable:!0,points:this._blLinesPoints,instance:this._lightHelperFrustumMeshes[5]},this._scene),r.AA.Vector3[2].toArray(this._nearPlaneVertices,0),r.AA.Vector3[3].toArray(this._nearPlaneVertices,3),r.AA.Vector3[4].toArray(this._nearPlaneVertices,6),r.AA.Vector3[5].toArray(this._nearPlaneVertices,9),this._lightHelperFrustumMeshes[6].geometry?.updateVerticesDataDirectly("position",this._nearPlaneVertices,0),r.AA.Vector3[6].toArray(this._farPlaneVertices,0),r.AA.Vector3[7].toArray(this._farPlaneVertices,3),r.AA.Vector3[8].toArray(this._farPlaneVertices,6),r.AA.Vector3[9].toArray(this._farPlaneVertices,9),this._lightHelperFrustumMeshes[7].geometry?.updateVerticesDataDirectly("position",this._farPlaneVertices,0),r.AA.Vector3[2].toArray(this._rightPlaneVertices,0),r.AA.Vector3[6].toArray(this._rightPlaneVertices,3),r.AA.Vector3[7].toArray(this._rightPlaneVertices,6),r.AA.Vector3[3].toArray(this._rightPlaneVertices,9),this._lightHelperFrustumMeshes[8].geometry?.updateVerticesDataDirectly("position",this._rightPlaneVertices,0),r.AA.Vector3[5].toArray(this._leftPlaneVertices,0),r.AA.Vector3[9].toArray(this._leftPlaneVertices,3),r.AA.Vector3[8].toArray(this._leftPlaneVertices,6),r.AA.Vector3[4].toArray(this._leftPlaneVertices,9),this._lightHelperFrustumMeshes[9].geometry?.updateVerticesDataDirectly("position",this._leftPlaneVertices,0),r.AA.Vector3[2].toArray(this._topPlaneVertices,0),r.AA.Vector3[6].toArray(this._topPlaneVertices,3),r.AA.Vector3[9].toArray(this._topPlaneVertices,6),r.AA.Vector3[5].toArray(this._topPlaneVertices,9),this._lightHelperFrustumMeshes[10].geometry?.updateVerticesDataDirectly("position",this._topPlaneVertices,0),r.AA.Vector3[3].toArray(this._bottomPlaneVertices,0),r.AA.Vector3[7].toArray(this._bottomPlaneVertices,3),r.AA.Vector3[8].toArray(this._bottomPlaneVertices,6),r.AA.Vector3[4].toArray(this._bottomPlaneVertices,9),this._lightHelperFrustumMeshes[11].geometry?.updateVerticesDataDirectly("position",this._bottomPlaneVertices,0)}dispose(){this._lightHelperFrustumMeshes.forEach((e=>{e.material?.dispose(),e.dispose()})),this._rootNode.dispose()}_createGeometry(){this._rootNode=new A.V("directionalLightHelperRoot_"+this._light.name,this._scene),this._rootNode.parent=this._light.parent,this._nearLinesPoints=[r.AA.Vector3[0],r.AA.Vector3[1],r.AA.Vector3[2],r.AA.Vector3[3],r.AA.Vector3[4]];const e=(0,M.sh)("nearlines",{updatable:!0,points:this._nearLinesPoints},this._scene);e.parent=this._rootNode,e.alwaysSelectAsActiveMesh=!0,this._farLinesPoints=[r.AA.Vector3[5],r.AA.Vector3[6],r.AA.Vector3[7],r.AA.Vector3[8],r.AA.Vector3[9]];const t=(0,M.sh)("farlines",{updatable:!0,points:this._farLinesPoints},this._scene);t.parent=this._rootNode,t.alwaysSelectAsActiveMesh=!0,this._trLinesPoints=[r.AA.Vector3[10],r.AA.Vector3[11]];const i=(0,M.sh)("trlines",{updatable:!0,points:this._trLinesPoints},this._scene);i.parent=this._rootNode,i.alwaysSelectAsActiveMesh=!0,this._brLinesPoints=[r.AA.Vector3[12],r.AA.Vector3[0]];const s=(0,M.sh)("brlines",{updatable:!0,points:this._brLinesPoints},this._scene);s.parent=this._rootNode,s.alwaysSelectAsActiveMesh=!0,this._tlLinesPoints=[r.AA.Vector3[1],r.AA.Vector3[2]];const o=(0,M.sh)("tllines",{updatable:!0,points:this._tlLinesPoints},this._scene);o.parent=this._rootNode,o.alwaysSelectAsActiveMesh=!0,this._blLinesPoints=[r.AA.Vector3[3],r.AA.Vector3[4]];const l=(0,M.sh)("bllines",{updatable:!0,points:this._blLinesPoints},this._scene);l.parent=this._rootNode,l.alwaysSelectAsActiveMesh=!0,this._lightHelperFrustumMeshes.push(e,t,i,s,o,l);const c=(e,t,i)=>{const r=new g.e(e+"plane",this._scene),s=new n.F(e+"PlaneMat",this._scene);r.material=s,r.parent=this._rootNode,r.alwaysSelectAsActiveMesh=!0,s.emissiveColor=t,s.alpha=this.transparency,s.backFaceCulling=!1,s.disableLighting=!0;const a=new P.P;a.positions=i,a.indices=[0,1,2,0,2,3],a.applyToMesh(r,!0),this._lightHelperFrustumMeshes.push(r)};this._nearPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._farPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._rightPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._leftPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._topPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],this._bottomPlaneVertices=[0,0,0,0,0,0,0,0,0,0,0,0],c("near",new a.v9(1,0,0),this._nearPlaneVertices),c("far",new a.v9(.3,0,0),this._farPlaneVertices),c("right",new a.v9(0,1,0),this._rightPlaneVertices),c("left",new a.v9(0,.3,0),this._leftPlaneVertices),c("top",new a.v9(0,0,1),this._topPlaneVertices),c("bottom",new a.v9(0,0,.3),this._bottomPlaneVertices),this._nearLinesPoints[0]=r.AA.Vector3[2],this._nearLinesPoints[1]=r.AA.Vector3[3],this._nearLinesPoints[2]=r.AA.Vector3[4],this._nearLinesPoints[3]=r.AA.Vector3[5],this._nearLinesPoints[4]=r.AA.Vector3[2],this._farLinesPoints[0]=r.AA.Vector3[6],this._farLinesPoints[1]=r.AA.Vector3[7],this._farLinesPoints[2]=r.AA.Vector3[8],this._farLinesPoints[3]=r.AA.Vector3[9],this._farLinesPoints[4]=r.AA.Vector3[6],this._trLinesPoints[0]=r.AA.Vector3[2],this._trLinesPoints[1]=r.AA.Vector3[6],this._brLinesPoints[0]=r.AA.Vector3[3],this._brLinesPoints[1]=r.AA.Vector3[7],this._tlLinesPoints[0]=r.AA.Vector3[4],this._tlLinesPoints[1]=r.AA.Vector3[8],this._blLinesPoints[0]=r.AA.Vector3[5],this._blLinesPoints[1]=r.AA.Vector3[9]}_getInvertViewMatrix(){return r.uq.LookAtLHToRef(this._light.position,this._light.position.add(this._light.direction),r.Pq.UpReadOnly,this._inverseViewMatrix),this._inverseViewMatrix.invertToRef(this._inverseViewMatrix),this._inverseViewMatrix}}},81499:(e,t,i)=>{var r=i(91585),n=i(30418),s=i(58478);n.ThinEngine.prototype.createDynamicTexture=function(e,t,i,n){const a=new s.hV(this,4);return a.baseWidth=e,a.baseHeight=t,i&&(e=this.needPOTTextures?(0,r.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,r.R)(t,this._caps.maxTextureSize):t),a.width=e,a.height=t,a.isReady=!1,a.generateMipMaps=i,a.samplingMode=n,this.updateTextureSamplingMode(n,a),this._internalTexturesCache.push(a),a},n.ThinEngine.prototype.updateDynamicTexture=function(e,t,i,r=!1,n,s=!1,a=!1){if(!e)return;const o=this._gl,l=o.TEXTURE_2D,c=this._bindTextureDirectly(l,e,!0,s);this._unpackFlipY(void 0===i?e.invertY:i),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const h=this._getWebGLTextureType(e.type),u=this._getInternalFormat(n||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,u);o.texImage2D(l,0,d,u,h,t),e.generateMipMaps&&o.generateMipmap(l),c||this._bindTextureDirectly(l,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),n&&(e.format=n),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0}},10793:(e,t,i)=>{i.d(t,{Y:()=>r});class r{}r.AUTOSAMPLERSUFFIX="Sampler",r.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_R16_UNORM=33322,r.TEXTUREFORMAT_RG16_UNORM=33324,r.TEXTUREFORMAT_RGB16_UNORM=32852,r.TEXTUREFORMAT_RGBA16_UNORM=32859,r.TEXTUREFORMAT_R16_SNORM=36760,r.TEXTUREFORMAT_RG16_SNORM=36761,r.TEXTUREFORMAT_RGB16_SNORM=36762,r.TEXTUREFORMAT_RGBA16_SNORM=36763,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,r.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,r.TEXTUREFORMAT_STENCIL8=19,r.TEXTUREFORMAT_UNDEFINED=4294967295,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,r.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,r.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,r.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,r.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_2D=3553,r.TEXTURE_2D_ARRAY=35866,r.TEXTURE_CUBE_MAP=34067,r.TEXTURE_CUBE_MAP_ARRAY=3735928559,r.TEXTURE_3D=32879,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_AllDirtyFlag=63,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8,r.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9,r.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10,r.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11,r.PREPASS_ALBEDO_TEXTURE_TYPE=12,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.BUFFER_CREATIONFLAG_INDIRECT=64,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r.GL_ALPHA_FUNCTION_SRC1_COLOR=35065,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066,r.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067,r.SnippetUrl="https://snippet.babylonjs.com",r.FOGMODE_NONE=0,r.FOGMODE_EXP=1,r.FOGMODE_EXP2=2,r.FOGMODE_LINEAR=3,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.PositionKind="position",r.NormalKind="normal",r.TangentKind="tangent",r.UVKind="uv",r.UV2Kind="uv2",r.UV3Kind="uv3",r.UV4Kind="uv4",r.UV5Kind="uv5",r.UV6Kind="uv6",r.ColorKind="color",r.ColorInstanceKind="instanceColor",r.MatricesIndicesKind="matricesIndices",r.MatricesWeightsKind="matricesWeights",r.MatricesIndicesExtraKind="matricesIndicesExtra",r.MatricesWeightsExtraKind="matricesWeightsExtra"},4407:(e,t,i)=>{i.d(t,{G:()=>r,f:()=>n});class r{}r.COPY=1,r.CUT=2,r.PASTE=3;class n{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return r.COPY;case 86:return r.PASTE;case 88:return r.CUT;default:return-1}}}},83376:(e,t,i)=>{i.d(t,{IC:()=>A,eR:()=>ne,c5:()=>ue,nm:()=>_,P3:()=>re,dm:()=>he,CN:()=>ae,Q6:()=>se,yq:()=>de,EX:()=>Me,Mq:()=>De,uk:()=>Ie,YT:()=>Oe,xi:()=>Fe,w1:()=>Ne,Bz:()=>O,FZ:()=>G,fk:()=>te,ro:()=>le,_I:()=>Le,j:()=>Be,KJ:()=>we,M:()=>Ee,T2:()=>ve,i2:()=>Q,Rl:()=>ye,VZ:()=>S,xv:()=>T,nc:()=>E,ud:()=>H,B5:()=>pe,my:()=>M,_L:()=>N,Vu:()=>$,ct:()=>j,vs:()=>b,rY:()=>W,P_:()=>Ae,hH:()=>Z,JA:()=>K,EF:()=>xe,ws:()=>X,dq:()=>q,l9:()=>_e,w$:()=>me,uE:()=>fe,Ix:()=>Re,OK:()=>B,WR:()=>w,yW:()=>v,pg:()=>P,Oi:()=>D,TK:()=>Te,L7:()=>C,sV:()=>Se,Qe:()=>J,Je:()=>x,fG:()=>L,z6:()=>Ce,g1:()=>be,ns:()=>z,Fz:()=>R,sR:()=>ee,Mk:()=>oe,qJ:()=>ge,Cu:()=>g,Vb:()=>ie,Vl:()=>ce,F9:()=>Pe,CM:()=>I});var r=i(88252),n=i(58628),s=i(75892),a=i(28747);class o extends a.r{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation()}getClassName(){return this._className}}var l=i(54983),c=i(10338);class h extends a.r{constructor(e,t,i,r,n,s,a){super(r,a),this._operation=n,this._className=s,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}var u=i(32685);function d(e){return e.getClassName?e.getClassName():""}function p(e,t){return"Vector2"===e&&"Vector2"===t||"Vector3"===e&&"Vector3"===t||"Vector4"===e&&"Vector4"===t}function f(e,t){return"Matrix"===e&&"Matrix"===t}function m(e,t){return"FlowGraphInteger"===e&&"FlowGraphInteger"===t}class _ extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicAdd(e,t)),_.ClassName,e)}_polymorphicAdd(e,t){const i=d(e),r=d(t);return p(i,r)||f(i,r)||m(i,r)?e.add(t):e+t}}_.ClassName="FGAddBlock",(0,r.Y5)(_.ClassName,_);class g extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicAdd(e,t)),g.ClassName,e)}_polymorphicAdd(e,t){const i=d(e),r=d(t);return p(i,r)||m(i,r)?e.subtract(t):f(i,r)?e.add(t.scale(-1)):e-t}}g.ClassName="FGSubBlock",(0,r.Y5)(g.ClassName,g);class v extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicMultiply(e,t)),v.ClassName,e)}_polymorphicMultiply(e,t){const i=d(e),r=d(t);return p(i,r)||m(i,r)?e.multiply(t):f(i,r)?l.uq.FromValues(e.m[0]*t.m[0],e.m[4]*t.m[4],e.m[8]*t.m[8],e.m[12]*t.m[12],e.m[1]*t.m[1],e.m[5]*t.m[5],e.m[9]*t.m[9],e.m[13]*t.m[13],e.m[2]*t.m[2],e.m[6]*t.m[6],e.m[10]*t.m[10],e.m[14]*t.m[14],e.m[3]*t.m[3],e.m[7]*t.m[7],e.m[11]*t.m[11],e.m[15]*t.m[15]):e*t}}v.ClassName="FGMultiplyBlock",(0,r.Y5)(v.ClassName,v);class S extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicDivide(e,t)),S.ClassName,e)}_polymorphicDivide(e,t){const i=d(e),r=d(t);return p(i,r)||m(i,r)?e.divide(t):f(i,r)?l.uq.FromValues(e.m[0]/t.m[0],e.m[4]/t.m[4],e.m[8]/t.m[8],e.m[12]/t.m[12],e.m[1]/t.m[1],e.m[5]/t.m[5],e.m[9]/t.m[9],e.m[13]/t.m[13],e.m[2]/t.m[2],e.m[6]/t.m[6],e.m[10]/t.m[10],e.m[14]/t.m[14],e.m[3]/t.m[3],e.m[7]/t.m[7],e.m[11]/t.m[11],e.m[15]/t.m[15]):e/t}}S.ClassName="FGDivideBlock",(0,r.Y5)(S.ClassName,S);class x extends o{constructor(e){super(n.Es,(()=>Math.random()),x.ClassName,e)}}x.ClassName="FGRandomBlock",(0,r.Y5)(x.ClassName,x);class T extends s.W{constructor(e){super(n.Vv,n.Vv,n.Es,((e,t)=>this._polymorphicDot(e,t)),T.ClassName,e)}_polymorphicDot(e,t){switch(d(e)){case"Vector2":return l.I9.Dot(e,t);case"Vector3":return l.Pq.Dot(e,t);case"Vector4":return l.IU.Dot(e,t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}}T.ClassName="FGDotBlock",(0,r.Y5)(T.ClassName,T);class E extends o{constructor(e){super(n.Es,(()=>Math.E),E.ClassName,e)}}E.ClassName="FGEBlock",(0,r.Y5)(E.ClassName,E);class C extends o{constructor(e){super(n.Es,(()=>Math.PI),C.ClassName,e)}}C.ClassName="FGPIBlock",(0,r.Y5)(C.ClassName,C);class b extends o{constructor(e){super(n.Es,(()=>Number.POSITIVE_INFINITY),b.ClassName,e)}}b.ClassName="FGInfBlock",(0,r.Y5)(b.ClassName,b);class P extends o{constructor(e){super(n.Es,(()=>Number.NaN),P.ClassName,e)}}function y(e,t){switch(d(e)){case"FlowGraphInteger":return new u.P(t(e.value));case"Vector2":return new l.I9(t(e.x),t(e.y));case"Vector3":return new l.Pq(t(e.x),t(e.y),t(e.z));case"Vector4":return new l.IU(t(e.x),t(e.y),t(e.z),t(e.w));case"Matrix":return l.uq.FromValues(t(e.m[0]),t(e.m[4]),t(e.m[8]),t(e.m[12]),t(e.m[1]),t(e.m[5]),t(e.m[9]),t(e.m[13]),t(e.m[2]),t(e.m[6]),t(e.m[10]),t(e.m[14]),t(e.m[3]),t(e.m[7]),t(e.m[11]),t(e.m[15]));default:return t(e)}}P.ClassName="FGNaNBlock",(0,r.Y5)(P.ClassName,P);class A extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicAbs(e)),A.ClassName,e)}_polymorphicAbs(e){return y(e,Math.abs)}}A.ClassName="FGAbsBlock",(0,r.Y5)(A.ClassName,A);class R extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicSign(e)),R.ClassName,e)}_polymorphicSign(e){return y(e,Math.sign)}}R.ClassName="FGSignBlock",(0,r.Y5)(R.ClassName,R);class I extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicTrunc(e)),I.ClassName,e)}_polymorphicTrunc(e){return y(e,Math.trunc)}}I.ClassName="FGTruncBlock",(0,r.Y5)(I.ClassName,I);class M extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicFloor(e)),M.ClassName,e)}_polymorphicFloor(e){return y(e,Math.floor)}}M.ClassName="FGFloorBlock",(0,r.Y5)(M.ClassName,M);class O extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicCeiling(e)),O.ClassName,e)}_polymorphicCeiling(e){return y(e,Math.ceil)}}O.ClassName="FGCeilBlock",(0,r.Y5)(O.ClassName,O);class N extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicFract(e)),N.ClassName,e)}_polymorphicFract(e){return y(e,(e=>e-Math.floor(e)))}}N.ClassName="FGFractBlock",(0,r.Y5)(N.ClassName,N);class D extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicNeg(e)),D.ClassName,e)}_polymorphicNeg(e){return y(e,(e=>-e))}}function F(e,t,i){switch(d(e)){case"FlowGraphInteger":return new u.P(i(e.value,t.value));case"Vector2":return new l.I9(i(e.x,t.x),i(e.y,t.y));case"Vector3":return new l.Pq(i(e.x,t.x),i(e.y,t.y),i(e.z,t.z));case"Vector4":return new l.IU(i(e.x,t.x),i(e.y,t.y),i(e.z,t.z),i(e.w,t.w));case"Matrix":return l.uq.FromValues(i(e.m[0],t.m[0]),i(e.m[4],t.m[4]),i(e.m[8],t.m[8]),i(e.m[12],t.m[12]),i(e.m[1],t.m[1]),i(e.m[5],t.m[5]),i(e.m[9],t.m[9]),i(e.m[13],t.m[13]),i(e.m[2],t.m[2]),i(e.m[6],t.m[6]),i(e.m[10],t.m[10]),i(e.m[14],t.m[14]),i(e.m[3],t.m[3]),i(e.m[7],t.m[7]),i(e.m[11],t.m[11]),i(e.m[15],t.m[15]));default:return i(e,t)}}D.ClassName="FGNegBlock",(0,r.Y5)(D.ClassName,D);class L extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicRemainder(e,t)),L.ClassName,e)}_polymorphicRemainder(e,t){return F(e,t,((e,t)=>e%t))}}L.ClassName="FGRemainderBlock",(0,r.Y5)(L.ClassName,L);class w extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicMin(e,t)),w.ClassName,e)}_polymorphicMin(e,t){return F(e,t,Math.min)}}w.ClassName="FGMinBlock",(0,r.Y5)(w.ClassName,w);class B extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicMax(e,t)),B.ClassName,e)}_polymorphicMax(e,t){return F(e,t,Math.max)}}function V(e,t,i){return Math.min(Math.max(e,Math.min(t,i)),Math.max(t,i))}function k(e,t,i,r){switch(d(e)){case"FlowGraphInteger":return new u.P(r(e.value,t.value,i.value));case"Vector2":return new l.I9(r(e.x,t.x,i.x),r(e.y,t.y,i.y));case"Vector3":return new l.Pq(r(e.x,t.x,i.x),r(e.y,t.y,i.y),r(e.z,t.z,i.z));case"Vector4":return new l.IU(r(e.x,t.x,i.x),r(e.y,t.y,i.y),r(e.z,t.z,i.z),r(e.w,t.w,i.w));case"Matrix":return l.uq.FromValues(r(e.m[0],t.m[0],i.m[0]),r(e.m[4],t.m[4],i.m[4]),r(e.m[8],t.m[8],i.m[8]),r(e.m[12],t.m[12],i.m[12]),r(e.m[1],t.m[1],i.m[1]),r(e.m[5],t.m[5],i.m[5]),r(e.m[9],t.m[9],i.m[9]),r(e.m[13],t.m[13],i.m[13]),r(e.m[2],t.m[2],i.m[2]),r(e.m[6],t.m[6],i.m[6]),r(e.m[10],t.m[10],i.m[10]),r(e.m[14],t.m[14],i.m[14]),r(e.m[3],t.m[3],i.m[3]),r(e.m[7],t.m[7],i.m[7]),r(e.m[11],t.m[11],i.m[11]),r(e.m[15],t.m[15],i.m[15]));default:return r(e,t,i)}}B.ClassName="FGMaxBlock",(0,r.Y5)(B.ClassName,B);class G extends h{constructor(e){super(n.Vv,n.Vv,n.Vv,n.Vv,((e,t,i)=>this._polymorphicClamp(e,t,i)),G.ClassName,e)}_polymorphicClamp(e,t,i){return k(e,t,i,V)}}function U(e){return Math.min(Math.max(e,0),1)}G.ClassName="FGClampBlock",(0,r.Y5)(G.ClassName,G);class z extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicSaturate(e)),z.ClassName,e)}_polymorphicSaturate(e){return y(e,U)}}z.ClassName="FGSaturateBlock",(0,r.Y5)(z.ClassName,z);class W extends h{constructor(e){super(n.Vv,n.Vv,n.Vv,n.Vv,((e,t,i)=>this._polymorphicInterpolate(e,t,i)),W.ClassName,e)}_interpolate(e,t,i){return(1-i)*e+i*t}_polymorphicInterpolate(e,t,i){return k(e,t,i,this._interpolate)}}W.ClassName="FGInterpolateBlock",(0,r.Y5)(W.ClassName,W);class H extends s.W{constructor(e){super(n.Vv,n.Vv,n.RI,((e,t)=>this._polymorphicEq(e,t)),H.ClassName,e)}_polymorphicEq(e,t){const i=d(e),r=d(t);return p(i,r)||f(i,r)||m(i,r)?e.equals(t):e===t}}function Y(e,t,i){const r=d(e);if(r===d(t)){if(""===r)return i(e,t);if("FlowGraphInteger"===r)return i(e.value,t.value);throw new Error(`Cannot compare ${e} and ${t}`)}throw new Error(`${e} and ${t} are of different types.`)}H.ClassName="FGEqBlock",(0,r.Y5)(H.ClassName,H);class X extends s.W{constructor(e){super(n.Vv,n.Vv,n.RI,((e,t)=>this._polymorphicLessThan(e,t)),X.ClassName,e)}_polymorphicLessThan(e,t){return Y(e,t,((e,t)=>e<t))}}X.ClassName="FGLessThanBlock",(0,r.Y5)(X.ClassName,X);class q extends s.W{constructor(e){super(n.Vv,n.Vv,n.RI,((e,t)=>this._polymorphicLessThanOrEqual(e,t)),q.ClassName,e)}_polymorphicLessThanOrEqual(e,t){return Y(e,t,((e,t)=>e<=t))}}q.ClassName="FGLessThanOrEqualBlock";class $ extends s.W{constructor(e){super(n.Vv,n.Vv,n.RI,((e,t)=>this._polymorphicGreaterThan(e,t)),$.ClassName,e)}_polymorphicGreaterThan(e,t){return Y(e,t,((e,t)=>e>t))}}$.ClassName="FGGreaterThanBlock",(0,r.Y5)($.ClassName,$);class j extends s.W{constructor(e){super(n.Vv,n.Vv,n.RI,((e,t)=>this._polymorphicGreaterThanOrEqual(e,t)),j.ClassName,e)}_polymorphicGreaterThanOrEqual(e,t){return Y(e,t,((e,t)=>e>=t))}}j.ClassName="FGGreaterThanOrEqualBlock",(0,r.Y5)(j.ClassName,j);class K extends c.a{constructor(e){super(n.Vv,n.RI,(e=>this._polymorphicIsNan(e)),K.ClassName,e)}_polymorphicIsNan(e){const t=d(e);if(""===t)return isNaN(e);if("FlowGraphInteger"===t)return isNaN(e.value);throw new Error(`Cannot get NaN of ${e}`)}}K.ClassName="FGIsNanBlock",(0,r.Y5)(K.ClassName,K);class Z extends c.a{constructor(e){super(n.Vv,n.RI,(e=>this._polymorphicIsInf(e)),Z.ClassName,e)}_polymorphicIsInf(e){const t=d(e);if(""===t)return!isFinite(e);if("FlowGraphInteger"===t)return!isFinite(e.value);throw new Error(`Cannot get isInf of ${e}`)}}Z.ClassName="FGIsInfBlock";class Q extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicDegToRad(e)),Q.ClassName,e)}_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return y(e,this._degToRad)}}Q.ClassName="FGDegToRadBlock",(0,r.Y5)(Q.ClassName,Q);class J extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicRadToDeg(e)),J.ClassName,e)}_radToDeg(e){return 180*e/Math.PI}_polymorphicRadToDeg(e){return y(e,this._radToDeg)}}J.ClassName="FGRadToDegBlock",(0,r.Y5)(J.ClassName,J);class ee extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicSin(e)),ee.ClassName,e)}_polymorphicSin(e){return y(e,Math.sin)}}ee.ClassName="FGSinBlock",(0,r.Y5)(ee.ClassName,ee);class te extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicCos(e)),te.ClassName,e)}_polymorphicCos(e){return y(e,Math.cos)}}te.ClassName="FGCosBlock",(0,r.Y5)(te.ClassName,te);class ie extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicTan(e)),ie.ClassName,e)}_polymorphicTan(e){return y(e,Math.tan)}}ie.ClassName="FGTanBlock",(0,r.Y5)(ie.ClassName,ie);class re extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicAsin(e)),re.ClassName,e)}_polymorphicAsin(e){return y(e,Math.asin)}}re.ClassName="FGAsinBlock",(0,r.Y5)(re.ClassName,re);class ne extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicAcos(e)),ne.ClassName,e)}_polymorphicAcos(e){return y(e,Math.acos)}}ne.ClassName="FGAcosBlock",(0,r.Y5)(ne.ClassName,ne);class se extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicAtan(e)),se.ClassName,e)}_polymorphicAtan(e){return y(e,Math.atan)}}se.ClassName="FGAtanBlock",(0,r.Y5)(se.ClassName,se);class ae extends s.W{constructor(e){super(n.Vv,n.Vv,n.Vv,((e,t)=>this._polymorphicAtan2(e,t)),ae.ClassName,e)}_polymorphicAtan2(e,t){return F(e,t,Math.atan2)}}ae.ClassName="FGAtan2Block",(0,r.Y5)(ae.ClassName,ae);class oe extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicSinh(e)),oe.ClassName,e)}_polymorphicSinh(e){return y(e,Math.sinh)}}oe.ClassName="FGSinhBlock",(0,r.Y5)(oe.ClassName,oe);class le extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicCosh(e)),le.ClassName,e)}_polymorphicCosh(e){return y(e,Math.cosh)}}le.ClassName="FGCoshBlock",(0,r.Y5)(le.ClassName,le);class ce extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicTanh(e)),ce.ClassName,e)}_polymorphicTanh(e){return y(e,Math.tanh)}}ce.ClassName="FGTanhBlock",(0,r.Y5)(ce.ClassName,ce);class he extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicAsinh(e)),he.ClassName,e)}_polymorphicAsinh(e){return y(e,Math.asinh)}}he.ClassName="FGAsinhBlock",(0,r.Y5)(he.ClassName,he);class ue extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicAcosh(e)),ue.ClassName,e)}_polymorphicAcosh(e){return y(e,Math.acosh)}}ue.ClassName="FGAcoshBlock",(0,r.Y5)(ue.ClassName,ue);class de extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicAtanh(e)),de.ClassName,e)}_polymorphicAtanh(e){return y(e,Math.atanh)}}de.ClassName="FGAtanhBlock",(0,r.Y5)(de.ClassName,de);class pe extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicExp(e)),pe.ClassName,e)}_polymorphicExp(e){return y(e,Math.exp)}}pe.ClassName="FGExpBlock",(0,r.Y5)(pe.ClassName,pe);class fe extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicLog(e)),fe.ClassName,e)}_polymorphicLog(e){return y(e,Math.log)}}fe.ClassName="FGLogBlock",(0,r.Y5)(fe.ClassName,fe);class me extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicLog2(e)),me.ClassName,e)}_polymorphicLog2(e){return y(e,Math.log2)}}me.ClassName="FGLog2Block",(0,r.Y5)(me.ClassName,me);class _e extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicLog10(e)),_e.ClassName,e)}_polymorphicLog10(e){return y(e,Math.log10)}}_e.ClassName="FGLog10Block",(0,r.Y5)(_e.ClassName,_e);class ge extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicSqrt(e)),ge.ClassName,e)}_polymorphicSqrt(e){return y(e,Math.sqrt)}}ge.ClassName="FGSqrtBlock",(0,r.Y5)(ge.ClassName,ge);class ve extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicCubeRoot(e)),ve.ClassName,e)}_polymorphicCubeRoot(e){return y(e,Math.cbrt)}}ve.ClassName="FGCubeRootBlock",(0,r.Y5)(ve.ClassName,ve);class Se extends s.W{constructor(e){super(n.Vv,n.Es,n.Es,((e,t)=>this._polymorphicPow(e,t)),Se.ClassName,e)}_polymorphicPow(e,t){return F(e,t,Math.pow)}}Se.ClassName="FGPowBlock",(0,r.Y5)(Se.ClassName,Se);class xe extends c.a{constructor(e){super(n.Vv,n.Es,(e=>this._polymorphicLength(e)),xe.ClassName,e)}_polymorphicLength(e){switch(d(e)){case"Vector2":case"Vector3":case"Vector4":return e.length();default:throw new Error(`Cannot compute length of value ${e}`)}}}xe.ClassName="FGLengthBlock",(0,r.Y5)(xe.ClassName,xe);class Te extends c.a{constructor(e){super(n.Vv,n.Vv,(e=>this._polymorphicNormalize(e)),Te.ClassName,e)}_polymorphicNormalize(e){switch(d(e)){case"Vector2":case"Vector3":case"Vector4":return e.normalize();default:throw new Error(`Cannot normalize value ${e}`)}}}Te.ClassName="FGNormalizeBlock",(0,r.Y5)(Te.ClassName,Te);class Ee extends s.W{constructor(e){super(n.Dx,n.Dx,n.Dx,((e,t)=>l.Pq.Cross(e,t)),Ee.ClassName,e)}}Ee.ClassName="FGCrossBlock",(0,r.Y5)(Ee.ClassName,Ee);class Ce extends s.W{constructor(e){super(n.K$,n.Es,n.K$,((e,t)=>l.I9.Transform(e,l.uq.RotationZ(t))),Ce.ClassName,e)}}Ce.ClassName="FGRotate2DBlock",(0,r.Y5)(Ce.ClassName,Ce);class be extends h{constructor(e){super(n.Dx,n.Dx,n.Es,n.Dx,((e,t,i)=>l.Pq.TransformCoordinates(e,l.uq.RotationAxis(t,i))),be.ClassName,e)}}be.ClassName="FGRotate3DBlock",(0,r.Y5)(be.ClassName,be);class Pe extends c.a{constructor(e){super(n.Sp,n.Sp,(e=>l.uq.Transpose(e)),Pe.ClassName,e)}}Pe.ClassName="FGTransposeBlock",(0,r.Y5)(Pe.ClassName,Pe);class ye extends c.a{constructor(e){super(n.Sp,n.Es,(e=>e.determinant()),ye.ClassName,e)}}ye.ClassName="FGDeterminantBlock",(0,r.Y5)(ye.ClassName,ye);class Ae extends c.a{constructor(e){super(n.Sp,n.Sp,(e=>l.uq.Invert(e)),Ae.ClassName,e)}}Ae.ClassName="FGInvertMatrixBlock",(0,r.Y5)(Ae.ClassName,Ae);class Re extends s.W{constructor(e){super(n.Sp,n.Sp,n.Sp,((e,t)=>t.multiply(e)),Re.ClassName,e)}}Re.ClassName="FGMatMulBlock",(0,r.Y5)(Re.ClassName,Re);class Ie extends c.a{constructor(e){super(n.x2,n.x2,(e=>new u.P(~e.value)),Ie.ClassName,e)}}Ie.ClassName="FGBitwiseNotBlock",(0,r.Y5)(Ie.ClassName,Ie);class Me extends s.W{constructor(e){super(n.x2,n.x2,n.x2,((e,t)=>new u.P(e.value&t.value)),Me.ClassName,e)}}Me.ClassName="FGBitwiseAndBlock",(0,r.Y5)(Me.ClassName,Me);class Oe extends s.W{constructor(e){super(n.x2,n.x2,n.x2,((e,t)=>new u.P(e.value|t.value)),Oe.ClassName,e)}}Oe.ClassName="FGBitwiseOrBlock",(0,r.Y5)(Oe.ClassName,Oe);class Ne extends s.W{constructor(e){super(n.x2,n.x2,n.x2,((e,t)=>new u.P(e.value^t.value)),Ne.ClassName,e)}}Ne.ClassName="FGBitwiseXorBlock",(0,r.Y5)(Ne.ClassName,Ne);class De extends s.W{constructor(e){super(n.x2,n.x2,n.x2,((e,t)=>new u.P(e.value<<t.value)),De.ClassName,e)}}De.ClassName="FGBitwiseLeftShiftBlock",(0,r.Y5)(De.ClassName,De);class Fe extends s.W{constructor(e){super(n.x2,n.x2,n.x2,((e,t)=>new u.P(e.value>>t.value)),Fe.ClassName,e)}}Fe.ClassName="FGBitwiseRightShiftBlock",(0,r.Y5)(Fe.ClassName,Fe);class Le extends c.a{constructor(e){super(n.x2,n.x2,(e=>new u.P(Math.clz32(e.value))),Le.ClassName,e)}}Le.ClassName="FGCountLeadingZerosBlock",(0,r.Y5)(Le.ClassName,Le);class we extends c.a{constructor(e){super(n.x2,n.x2,(e=>new u.P(e.value?31-Math.clz32(e.value&-e.value):32)),we.ClassName,e)}}we.ClassName="FGCountTrailingZerosBlock",(0,r.Y5)(we.ClassName,we);class Be extends c.a{constructor(e){super(n.x2,n.x2,(e=>new u.P(function(e){let t=0;for(;e;)t+=1&e,e>>=1;return t}(e.value))),Be.ClassName,e)}}Be.ClassName="FGCountOneBitsBlock",(0,r.Y5)(Be.ClassName,Be)},75892:(e,t,i)=>{i.d(t,{W:()=>n});var r=i(28747);class n extends r.r{constructor(e,t,i,r,n,s){super(i,s),this._operation=r,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e))}getClassName(){return this._className}}},28747:(e,t,i)=>{i.d(t,{r:()=>a});var r=i(41954);const n="cachedOperationValue",s="cachedExecutionId";class a extends r.e{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e)}_updateOutputs(e){const t=e._getExecutionVariable(this,s),i=e._getExecutionVariable(this,n);if(void 0!==i&&t===e.executionId)this.value.setValue(i,e);else{const t=this._doOperation(e);e._setExecutionVariable(this,n,t),e._setExecutionVariable(this,s,e.executionId),this.value.setValue(t,e)}}}},96073:(e,t,i)=>{i.d(t,{v:()=>o});var r=i(88252),n=i(41954),s=i(58628),a=i(99007);class o extends n.e{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",s.Vv),this.templateComponent=new a.H(e.path,this)}_updateOutputs(e){const t=this.templateComponent.getAccessor(this.config.pathConverter,e),i=t.info.get(t.object);this.value.setValue(i,e)}getClassName(){return o.ClassName}serialize(e={}){super.serialize(e),e.config.path=this.config.path}}o.ClassName="FGGetPropertyBlock",(0,r.Y5)(o.ClassName,o)},91210:(e,t,i)=>{i.d(t,{g:()=>a});var r=i(41954),n=i(58628),s=i(88252);class a extends r.e{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput(e.variableName,n.Vv)}_updateOutputs(e){const t=this.config.variableName;e.hasVariable(t)&&this.output.setValue(e.getVariable(t),e)}getClassName(){return a.ClassName}serialize(e){super.serialize(e),e.config.variableName=this.config.variableName}}a.ClassName="FGGetVariableBlock",(0,s.Y5)(a.ClassName,a)},10338:(e,t,i)=>{i.d(t,{a:()=>n});var r=i(28747);class n extends r.r{constructor(e,t,i,r,n){super(t,n),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}}},64012:(e,t,i)=>{i.d(t,{i:()=>l});var r=i(45413),n=i(82106),s=i(31780),a=i(88252),o=i(49210);class l extends n.i{constructor(e){super(e),this.config=e}_getReferencedMesh(){const e=this.config.pathConverter.convert(this.config.path),t=e.info.getObject(e.object);if(!(t&&t instanceof r.u))throw new Error("Mesh pick event block requires a valid mesh");return t}_preparePendingTasks(e){let t=e._getExecutionVariable(this,"meshPickObserver");if(!t){const i=this._getReferencedMesh();e._setExecutionVariable(this,"mesh",i),t=i.getScene().onPointerObservable.add((t=>{t.type===s.Zp.POINTERPICK&&t.pickInfo?.pickedMesh&&(t.pickInfo?.pickedMesh===i||(0,o.r)(t.pickInfo?.pickedMesh,i))&&this._execute(e)}));const r=i.onDisposeObservable.add((()=>this._onDispose));e._setExecutionVariable(this,"meshPickObserver",t),e._setExecutionVariable(this,"meshDisposeObserver",r)}}_onDispose(e){this._cancelPendingTasks(e),e._removePendingBlock(this)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"mesh"),i=e._getExecutionVariable(this,"meshPickObserver"),r=e._getExecutionVariable(this,"meshDisposeObserver");t.getScene().onPointerObservable.remove(i),t.onDisposeObservable.remove(r),e._deleteExecutionVariable(this,"mesh"),e._deleteExecutionVariable(this,"meshPickObserver"),e._deleteExecutionVariable(this,"meshDisposeObserver")}getClassName(){return l.ClassName}serialize(e){super.serialize(e),e.config.path=this.config.path}}l.ClassName="FGMeshPickEventBlock",(0,a.Y5)(l.ClassName,l)},23182:(e,t,i)=>{i.d(t,{W:()=>o});var r=i(82106),n=i(90066),s=i(58628),a=i(88252);class o extends r.i{constructor(e){super(e),this.config=e;for(let e=0;e<this.config.eventData.length;e++){const t=this.config.eventData[e];this.registerDataOutput(t,s.Vv)}}_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);this._eventObserver=t.add((t=>{for(let i=0;i<t.length;i++)this.dataOutputs[i].setValue(t[i],e);this._execute(e)}))}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);t?t.remove(this._eventObserver):n.S0.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}getClassName(){return o.ClassName}serialize(e){super.serialize(e),e.eventId=this.config.eventId,e.eventData=this.config.eventData}}o.ClassName="FGReceiveCustomEventBlock",(0,a.Y5)(o.ClassName,o)},47387:(e,t,i)=>{i.d(t,{b:()=>s});var r=i(82106),n=i(88252);class s extends r.i{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneReadyObserver")){const t=e.configuration.scene.onReadyObservable.add((()=>{this._execute(e)}));e._setExecutionVariable(this,"sceneReadyObserver",t)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneReadyObserver");e.configuration.scene.onReadyObservable.remove(t),e._deleteExecutionVariable(this,"sceneReadyObserver")}getClassName(){return s.ClassName}}s.ClassName="FGSceneReadyEventBlock",(0,n.Y5)("FGSceneReadyEventBlock",s)},79325:(e,t,i)=>{i.d(t,{B:()=>s});var r=i(82106),n=i(88252);class s extends r.i{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneBeforeRender")){const t=e.configuration.scene.onBeforeRenderObservable.add((()=>{this._execute(e)}));e._setExecutionVariable(this,"sceneBeforeRender",t)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneBeforeRender");e.configuration.scene.onBeforeRenderObservable.remove(t),e._deleteExecutionVariable(this,"sceneBeforeRender")}getClassName(){return s.ClassName}}s.ClassName="FGSceneTickEventBlock",(0,n.Y5)(s.ClassName,s)},45427:(e,t,i)=>{i.d(t,{V:()=>o});var r=i(58628),n=i(23234),s=i(88252),a=i(32685);class o extends n.w{constructor(e={startIndex:new a.P(0)}){super(e),this.config=e,this.reset=this._registerSignalInput("reset"),this.n=this.registerDataInput("n",r.x2),this.value=this.registerDataOutput("value",r.x2)}_execute(e,t){if(t===this.reset)this.value.setValue(this.config.startIndex,e);else{const t=this.value.getValue(e);t.value<this.n.getValue(e).value&&(this.value.setValue(new a.P(t.value+1),e),this.out._activateSignal(e))}}getClassName(){return o.ClassName}}o.ClassName="FGDoNBlock",(0,s.Y5)(o.ClassName,o)},7899:(e,t,i)=>{i.d(t,{v:()=>s});var r=i(88252),n=i(53496);class s extends n.u{constructor(e){super(e),this.config=e,this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(`${e}`))}_execute(e){for(let t=0;t<this.config.numberOutputFlows;t++)this.outFlows[t]._activateSignal(e)}getClassName(){return s.ClassName}}s.ClassName="FGSequenceBlock",(0,r.Y5)(s.ClassName,s)},34571:(e,t,i)=>{i.d(t,{B:()=>l});var r=i(18988),n=i(59988),s=i(58628),a=i(90066),o=i(88252);class l extends n.M{constructor(e){super(e),this.timeout=this.registerDataInput("timeout",s.Es)}_preparePendingTasks(e){const t=this.timeout.getValue(e);if(void 0!==t&&t>=0){const i=e._getExecutionVariable(this,"runningTimers")||[],n=e.configuration.scene,s=new r.Qz({timeout:t,contextObservable:n.onBeforeRenderObservable,onEnded:()=>this._onEnded(s,e)});s.start(),i.push(s),e._setExecutionVariable(this,"runningTimers",i)}}_execute(e){this._startPendingTasks(e),this.out._activateSignal(e)}_onEnded(e,t){const i=t._getExecutionVariable(this,"runningTimers")||[],r=i.indexOf(e);-1!==r?i.splice(r,1):a.S0.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"runningTimers")||[];for(const e of t)e.dispose();e._deleteExecutionVariable(this,"runningTimers")}getClassName(){return l.ClassName}}l.ClassName="FGTimerBlock",(0,o.Y5)("FGTimerBlock",l)},12477:(e,t,i)=>{i.d(t,{J:()=>a});var r=i(58628),n=i(88252),s=i(23234);class a extends s.w{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",r.RI),this.loopBody=this._registerSignalOutput("loopBody")}_execute(e,t){let i=this.condition.getValue(e);for(this.config?.isDo&&!i&&this.loopBody._activateSignal(e);i;)this.loopBody._activateSignal(e),i=this.condition.getValue(e);this.out._activateSignal(e)}getClassName(){return a.ClassName}serialize(e){super.serialize(e),e.isDo=this.config?.isDo}}a.ClassName="FGWhileLoopBlock",(0,n.Y5)(a.ClassName,a)},59433:(e,t,i)=>{i.d(t,{B:()=>o});var r=i(23234),n=i(58628),s=i(88252),a=i(70461);class o extends r.w{constructor(e){super(e),this.message=this.registerDataInput("message",n.Vv)}_execute(e){const t=this.message.getValue(e);a.V.Log(t),this.out._activateSignal(e)}getClassName(){return o.ClassName}}o.ClassName="FGConsoleLogBlock",(0,s.Y5)(o.ClassName,o)},73587:(e,t,i)=>{i.d(t,{z:()=>a});var r=i(58628),n=i(23234),s=i(88252);class a extends n.w{constructor(e){super(e),this.config=e;for(let e=0;e<this.config.eventData.length;e++){const t=this.config.eventData[e];this.registerDataInput(t,r.Vv)}}_execute(e){const t=this.config.eventId,i=this.dataInputs.map((t=>t.getValue(e)));e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return a.ClassName}}a.ClassName="FGSendCustomEventBlock",(0,s.Y5)("FGSendCustomEventBlock",a)},95437:(e,t,i)=>{i.d(t,{L:()=>o});var r=i(58628),n=i(23234),s=i(88252),a=i(99007);class o extends n.w{constructor(e){super(e),this.config=e,this.a=this.registerDataInput("a",r.Vv),this.templateComponent=new a.H(e.path,this)}_execute(e){const t=this.a.getValue(e),i=this.templateComponent.getAccessor(this.config.pathConverter,e);i.info.set(t,i.object),this.out._activateSignal(e)}serialize(e={}){super.serialize(e),e.config.path=this.config.path}getClassName(){return o.ClassName}}o.ClassName="FGSetPropertyBlock",(0,s.Y5)("FGSetPropertyBlock",o)},48078:(e,t,i)=>{i.d(t,{U:()=>a});var r=i(58628),n=i(23234),s=i(88252);class a extends n.w{constructor(e){super(e),this.config=e,this.input=this.registerDataInput(e.variableName,r.Vv)}_execute(e){const t=this.config.variableName,i=this.input.getValue(e);e.setVariable(t,i),this.out._activateSignal(e)}getClassName(){return a.ClassName}}a.ClassName="FGSetVariableBlock",(0,s.Y5)(a.ClassName,a)},22479:(e,t,i)=>{i.d(t,{$:()=>u,I:()=>r});var r,n=i(82106),s=i(80616),a=i(41954),o=i(53496),l=i(64012),c=i(49210),h=i(97711);!function(e){e[e.Stopped=0]="Stopped",e[e.Started=1]="Started"}(r||(r={}));class u{constructor(e){this._eventBlocks=[],this._executionContexts=[],this.state=0,this._scene=e.scene,this._coordinator=e.coordinator,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>this.dispose()))}createContext(){const e=new s.Y({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){this._eventBlocks.push(e)}start(){if(1!==this.state){this.state=1,0===this._executionContexts.length&&this.createContext();for(const e of this._executionContexts){const t=this._getContextualOrder();for(const i of t)i._startPendingTasks(e)}}}_getContextualOrder(){const e=[];for(const t of this._eventBlocks)if(t.getClassName()===l.i.ClassName){const i=t._getReferencedMesh();let r=0;for(;r<e.length;r++){const t=e[r]._getReferencedMesh();if(i&&t&&(0,c.r)(i,t))break}e.splice(r,0,t)}else e.push(t);return e}dispose(){if(0!==this.state){this.state=0;for(const e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0,this._eventBlocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}visitAllBlocks(e){const t=[],i=new Set;for(const e of this._eventBlocks)t.push(e),i.add(e.uniqueId);for(;t.length>0;){const r=t.pop();e(r);for(const e of r.dataInputs)for(const r of e._connectedPoint)i.has(r._ownerBlock.uniqueId)||(t.push(r._ownerBlock),i.add(r._ownerBlock.uniqueId));if(r instanceof o.u)for(const e of r.signalOutputs)for(const r of e._connectedPoint)i.has(r._ownerBlock.uniqueId)||(t.push(r._ownerBlock),i.add(r._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks((t=>{const i={};t.serialize(i),e.allBlocks.push(i)})),e.executionContexts=[];for(const i of this._executionContexts){const r={};i.serialize(r,t),e.executionContexts.push(r)}}static GetDataOutConnectionByUniqueId(e,t){for(const i of e)for(const e of i.dataOutputs)if(e.uniqueId===t)return e;throw new Error("Could not find data out connection with unique id "+t)}static GetSignalInConnectionByUniqueId(e,t){for(const i of e)if(i instanceof o.u)for(const e of i.signalInputs)if(e.uniqueId===t)return e;throw new Error("Could not find signal in connection with unique id "+t)}static Parse(e,t){const i=t.coordinator.createGraph(),r=[],l=t.valueParseFunction??h.wk;for(const s of e.allBlocks){const e=a.e.Parse(s,{scene:t.coordinator.config.scene,pathConverter:t.pathConverter,valueParseFunction:l});r.push(e),e instanceof n.i&&i.addEventBlock(e)}for(const e of r){for(const t of e.dataInputs)for(const e of t.connectedPointIds){const i=u.GetDataOutConnectionByUniqueId(r,e);t.connectTo(i)}if(e instanceof o.u)for(const t of e.signalOutputs)for(const e of t.connectedPointIds){const i=u.GetSignalInConnectionByUniqueId(r,e);t.connectTo(i)}}for(const t of e.executionContexts)s.Y.Parse(t,{graph:i,valueParseFunction:l});return i}}},59988:(e,t,i)=>{i.d(t,{M:()=>n});var r=i(53496);class n extends r.u{constructor(e){super(e),this.out=this._registerSignalOutput("out"),this.done=this._registerSignalOutput("done")}_startPendingTasks(e){this._preparePendingTasks(e),e._addPendingBlock(this)}}},41954:(e,t,i)=>{i.d(t,{e:()=>o});var r=i(88076),n=i(55591),s=i(90066),a=i(97711);class o{constructor(e){this.config=e,this.uniqueId=(0,r.z)(),this.name=this.config?.name??this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t){const i=new n.l(e,0,this,t);return this.dataInputs.push(i),i}registerDataOutput(e,t){const i=new n.l(e,1,this,t);return this.dataOutputs.push(i),i}getDataInput(e){return this.dataInputs.find((t=>t.name===e))}getDataOutput(e){return this.dataOutputs.find((t=>t.name===e))}serialize(e={},t=a.X5){e.uniqueId=this.uniqueId,e.config={},this.config&&(e.config.name=this.config.name),e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const t of this.dataInputs){const i={};t.serialize(i),e.dataInputs.push(i)}for(const t of this.dataOutputs){const i={};t.serialize(i),e.dataOutputs.push(i)}}getClassName(){return"FGBlock"}static Parse(e,t){const i=s.S0.Instantiate(e.className),r={},n=t.valueParseFunction??a.wk;if(e.config)for(const i in e.config)r[i]=n(i,e.config,t.scene);(0,a.$Q)(e.className)&&(r.pathConverter=t.pathConverter);const o=new i(r);o.uniqueId=e.uniqueId;for(let t=0;t<e.dataInputs.length;t++){const i=o.getDataInput(e.dataInputs[t].name);if(!i)throw new Error("Could not find data input with name "+e.dataInputs[t].name+" in block "+e.className);i.deserialize(e.dataInputs[t])}for(let t=0;t<e.dataOutputs.length;t++){const i=o.getDataOutput(e.dataOutputs[t].name);if(!i)throw new Error("Could not find data output with name "+e.dataOutputs[t].name+" in block "+e.className);i.deserialize(e.dataOutputs[t])}return o.metadata=e.metadata,o.deserialize&&o.deserialize(e),o}}},58015:(e,t,i)=>{i.d(t,{H:()=>r,X:()=>a});var r,n=i(90066),s=i(88076);!function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(r||(r={}));class a{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=(0,s.z)(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}static Parse(e={},t){const i=new(n.S0.Instantiate(e.className))(e.name,e._connectionType,t);return i.deserialize(e),i}}},80616:(e,t,i)=>{i.d(t,{Y:()=>l});var r=i(90576),n=i(96631),s=i(88076),a=i(97711),o=i(6740);class l{constructor(e){this.uniqueId=(0,s.z)(),this._userVariables={},this._executionVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new o.cP,this._configuration=e}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t}getVariable(e){return this._userVariables[e]}get userVariables(){return this._userVariables}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t}_getConnectionValue(e){return this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}_addPendingBlock(e){this._pendingBlocks.push(e)}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);-1!==t&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=a.X5){e.uniqueId=this.uniqueId,e._userVariables={};for(const i in this._userVariables)t(i,this._userVariables[i],e._userVariables);e._connectionValues={};for(const i in this._connectionValues)t(i,this._connectionValues[i],e._connectionValues)}getClassName(){return"FGContext"}static Parse(e,t){const i=t.graph.createContext(),r=t.valueParseFunction??a.wk;i.uniqueId=e.uniqueId;for(const t in e._userVariables){const n=r(t,e._userVariables,i._configuration.scene);i._userVariables[t]=n}for(const t in e._connectionValues){const n=r(t,e._connectionValues,i._configuration.scene);i._connectionValues[t]=n}return i}}(0,r.Cg)([(0,n.lK)()],l.prototype,"uniqueId",void 0)},63217:(e,t,i)=>{i.d(t,{x:()=>a});var r=i(6740),n=i(22479),s=i(97711);class a{constructor(e){this.config=e,this._flowGraphs=[],this._customEventsMap=new Map,this.config.scene.onDisposeObservable.add((()=>{this.dispose()})),(a.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){const e=new n.$({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);-1!==t&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach((e=>e.start()))}dispose(){this._flowGraphs.forEach((e=>e.dispose())),this._flowGraphs.length=0;const e=a.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);-1!==t&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach((i=>{const r={};i.serialize(r,t),e._flowGraphs.push(r)}))}static Parse(e,t){const i=t.valueParseFunction??s.wk,r=new a({scene:t.scene});return e._flowGraphs?.forEach((e=>{n.$.Parse(e,{coordinator:r,valueParseFunction:i,pathConverter:t.pathConverter})})),r}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new r.cP,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t){const i=this._customEventsMap.get(e);i&&i.notifyObservers(t)}}a.SceneCoordinators=new Map},55591:(e,t,i)=>{i.d(t,{l:()=>a});var r=i(88252),n=i(58015),s=i(58628);class a extends n.X{constructor(e,t,i,r){super(e,t,i),this.richType=r}_isSingularConnection(){return 0===this.connectionType}setValue(e,t){t._setConnectionValue(this,e)}connectTo(e){super.connectTo(e)}_getValueOrDefault(e){return e._hasConnectionValue(this)?e._getConnectionValue(this):this.richType.defaultValue}getValue(e){return 1===this.connectionType?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e),this._getValueOrDefault(e)):this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e)}getClassName(){return"FGDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType)}static Parse(e,t){const i=n.X.Parse(e,t);return i.richType=s.D.Parse(e.richType),i}}(0,r.Y5)("FGDataConnection",a)},82106:(e,t,i)=>{i.d(t,{i:()=>n});var r=i(59988);class n extends r.M{_execute(e){e._notifyExecuteNode(this),this.out._activateSignal(e)}}},53496:(e,t,i)=>{i.d(t,{u:()=>s});var r=i(41954),n=i(26523);class s extends r.e{constructor(e){super(e),this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in")}_registerSignalInput(e){const t=new n.R(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new n.R(e,1,this);return this.signalOutputs.push(t),t}getSignalInput(e){return this.signalInputs.find((t=>t.name===e))}getSignalOutput(e){return this.signalOutputs.find((t=>t.name===e))}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const i={};t.serialize(i),e.signalInputs.push(i)}for(const t of this.signalOutputs){const i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){const i=this.getSignalInput(e.signalInputs[t].name);if(!i)throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className);i.deserialize(e.signalInputs[t])}for(let t=0;t<e.signalOutputs.length;t++){const i=this.getSignalOutput(e.signalOutputs[t].name);if(!i)throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className);i.deserialize(e.signalOutputs[t])}}getClassName(){return"FGExecutionBlock"}}},23234:(e,t,i)=>{i.d(t,{w:()=>n});var r=i(53496);class n extends r.u{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}},32685:(e,t,i)=>{i.d(t,{P:()=>n});var r=i(88252);class n{constructor(e){this.value=this._toInt(e)}_toInt(e){return 0|e}add(e){return new n(this.value+e.value)}subtract(e){return new n(this.value-e.value)}multiply(e){return new n(Math.imul(this.value,e.value))}divide(e){return new n(this.value/e.value)}getClassName(){return n.ClassName}equals(e){return this.value===e.value}static Parse(e){return new n(e.value)}}n.ClassName="FlowGraphInteger",(0,r.Y5)("FlowGraphInteger",n)},99007:(e,t,i)=>{i.d(t,{H:()=>s});var r=i(58628);const n=new RegExp(/\{(\w+)\}/g);class s{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=n.exec(e);for(;i;){const[,s]=i;this.templatedInputs.push(t.registerDataInput(s,r.x2)),i=n.exec(e)}}getAccessor(e,t){let i=this.path;for(const e of this.templatedInputs){const r=e.getValue(t).value;i=i.replace(`{${e.name}}`,r.toString())}return e.convert(i)}}},58628:(e,t,i)=>{i.d(t,{D:()=>a,Dx:()=>d,Es:()=>c,Gx:()=>_,K$:()=>u,KV:()=>l,Ko:()=>p,Nf:()=>m,P_:()=>g,RI:()=>h,Sp:()=>f,Vv:()=>o,k4:()=>S,x2:()=>v});var r=i(54983),n=i(39341),s=i(32685);class a{constructor(e,t){this.typeName=e,this.defaultValue=t}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}static Parse(e){return new a(e.typeName,e.defaultValue)}}const o=new a("any",void 0),l=new a("string",""),c=new a("number",0),h=new a("boolean",!1),u=new a("Vector2",r.I9.Zero()),d=new a("Vector3",r.Pq.Zero()),p=new a("Vector4",r.IU.Zero()),f=new a("Matrix",r.uq.Identity()),m=new a("Color3",n.v9.Black()),_=new a("Color4",new n.ov(0,0,0,0)),g=new a("Quaternion",r.PT.Identity()),v=new a("FlowGraphInteger",new s.P(0));function S(e){switch(typeof e){case"string":return l;case"number":return c;case"boolean":return h;case"object":return e instanceof r.I9?u:e instanceof r.Pq?d:e instanceof r.IU?p:e instanceof n.v9?m:e instanceof n.ov?_:e instanceof r.PT?g:e instanceof s.P?v:o;default:return o}}},26523:(e,t,i)=>{i.d(t,{R:()=>s});var r=i(58015),n=i(88252);class s extends r.X{_isSingularConnection(){return 1===this.connectionType}_activateSignal(e){0===this.connectionType?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId()):this._connectedPoint[0]?._activateSignal(e)}}(0,n.Y5)("FlowGraphSignalConnection",s)},97711:(e,t,i)=>{i.d(t,{$Q:()=>h,X5:()=>l,wk:()=>c});var r=i(39341),n=i(54983),s=i(32685);function a(e){return"Mesh"===e||"AbstractMesh"===e||"GroundMesh"===e||"InstanceMesh"===e||"LinesMesh"===e||"GoldbergMesh"===e||"GreasedLineMesh"===e||"TrailMesh"===e}function o(e){return"Vector2"===e||"Vector3"===e||"Vector4"===e||"Quaternion"===e||"Color3"===e||"Color4"===e}function l(e,t,i){const r=t?.getClassName?.()??"";a(r)?i[e]={name:t.name,className:r}:o(r)?i[e]={value:t.asArray(),className:r}:i[e]=t}function c(e,t,i){const l=t[e];let c;const h=l?.className;return c=a(h)?i.getMeshByName(l.name):o(h)?function(e,t){if("Vector2"===e)return n.I9.FromArray(t);if("Vector3"===e)return n.Pq.FromArray(t);if("Vector4"===e)return n.IU.FromArray(t);if("Quaternion"===e)return n.PT.FromArray(t);if("Color3"===e)return new r.v9(t[0],t[1],t[2]);if("Color4"===e)return new r.ov(t[0],t[1],t[2],t[3]);throw new Error(`Unknown vector class name ${e}`)}(h,l.value):"Matrix"===h?n.uq.FromArray(l.value):h===s.P.ClassName?s.P.Parse(l):l&&void 0!==l.value?l.value:l,c}function h(e){return"FGSetPropertyBlock"===e||"FGGetPropertyBlock"===e||"FGPlayAnimationBlock"===e||"FGMeshPickEventBlock"===e}},49210:(e,t,i)=>{function r(e,t){return!(!e.parent||e.parent!==t&&!r(e.parent,t))}i.d(t,{r:()=>r})},98552:(e,t,i)=>{var r,n,s;i.d(t,{Kc:()=>s,X_:()=>n,tp:()=>r}),function(e){e[e.Texture=1]="Texture",e[e.TextureBackBuffer=2]="TextureBackBuffer",e[e.TextureBackBufferDepthStencilAttachment=4]="TextureBackBufferDepthStencilAttachment",e[e.TextureDepthStencilAttachment=8]="TextureDepthStencilAttachment",e[e.TextureViewDepth=16]="TextureViewDepth",e[e.TextureViewNormal=32]="TextureViewNormal",e[e.TextureAlbedo=64]="TextureAlbedo",e[e.TextureReflectivity=128]="TextureReflectivity",e[e.TextureWorldPosition=256]="TextureWorldPosition",e[e.TextureVelocity=512]="TextureVelocity",e[e.TextureIrradiance=1024]="TextureIrradiance",e[e.TextureAlbedoSqrt=2048]="TextureAlbedoSqrt",e[e.TextureScreenDepth=4096]="TextureScreenDepth",e[e.TextureWorldNormal=8192]="TextureWorldNormal",e[e.TextureLocalPosition=16384]="TextureLocalPosition",e[e.TextureLinearVelocity=32768]="TextureLinearVelocity",e[e.TextureAllButBackBufferDepthStencil=16777211]="TextureAllButBackBufferDepthStencil",e[e.TextureAllButBackBuffer=16777209]="TextureAllButBackBuffer",e[e.TextureAll=16777215]="TextureAll",e[e.Camera=16777216]="Camera",e[e.ObjectList=33554432]="ObjectList",e[e.AutoDetect=268435456]="AutoDetect",e[e.BasedOnInput=536870912]="BasedOnInput",e[e.Undefined=1073741824]="Undefined",e[e.All=4294967295]="All"}(r||(r={})),function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.HierarchyIssue=2]="HierarchyIssue"}(n||(n={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(s||(s={}))},2610:(e,t,i)=>{i.d(t,{E:()=>u});var r=i(90576),n=i(88252),s=i(96631),a=i(522),o=i(98552),l=i(6740),c=i(70461),h=i(4066);class u{get disabled(){return!!this._frameGraphTask?.disabled}set disabled(e){this._frameGraphTask&&(this._frameGraphTask.disabled=e)}get task(){return this._frameGraphTask}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeRenderGraphBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const t=i.ownerBlock.getDescendantOfPredicate(e);if(t)return t}return null}constructor(e,t,i,...r){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this.onBuildObservable=new l.cP,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this._additionalConstructionParameters=null,this.visibleOnFrame=!1,this._name=e,this._frameGraph=t,this._scene=i,this._engine=i.getEngine(),this.uniqueId=a.K.UniqueId}registerInput(e,t,i=!1,r){return(r=r??new h.t(e,this,0)).type=t,r.isOptional=i,this._inputs.push(r),this}registerOutput(e,t,i){return(i=i??new h.t(e,this,1)).type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}_propagateInputValueToOutput(e,t){e.connectedPoint&&(t.value=e.connectedPoint.value)}build(e){if(this._buildId===e.buildId)return!0;this._buildId=e.buildId;for(const t of this._inputs){if(!t.connectedPoint){t.isOptional||e._notConnectedNonOptionalInputs.push(t);continue}const i=t.connectedPoint.ownerBlock;i&&i!==this&&i.build(e)}return this._customBuildStep(e),e.verbose&&c.V.Log(`Building ${this.name} [${this.getClassName()}]`),this._buildBlock(e),this._frameGraphTask&&this._frameGraph.addTask(this._frameGraphTask),this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.disabled=this.disabled,this._additionalConstructionParameters&&(e.additionalConstructionParameters=this._additionalConstructionParameters),e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=e.visibleOnFrame,this.disabled=e.disabled,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((e=>{const t=this.inputs.find((t=>t.name===e.name));t&&(e.displayName&&(t.displayName=e.displayName),e.isExposedOnFrame&&(t.isExposedOnFrame=e.isExposedOnFrame,t.exposedPortPosition=e.exposedPortPosition))})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.disabled = ${this.disabled};\n`}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`\n// ${this.getClassName()}\n`;this.comments&&(r+=`// ${this.comments}\n`);const n=this.getClassName();if("RenderGraphInputBlock"===n){const e=this.type;r+=`var ${this._codeVariableName} = new BABYLON.NodeRenderGraphInputBlock("${this.name}", nodeRenderGraph.frameGraph, scene, BABYLON.NodeRenderGraphBlockConnectionPointTypes.${o.tp[e]});\n`}else this._additionalConstructionParameters?r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}", nodeRenderGraph.frameGraph, scene, ...${JSON.stringify(this._additionalConstructionParameters)});\n`:r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}", nodeRenderGraph.frameGraph, scene);\n`;r+=this._dumpPropertiesCode()+"\n";for(const i of this.inputs){if(!i.isConnected)continue;const n=i.connectedPoint.ownerBlock;-1===t.indexOf(n)&&(r+=n._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const n of i.endpoints){const i=n.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=(0,n.n9)(e.customType);if(t){const i=e.additionalConstructionParameters,r=i?new t("",this._frameGraph,this._scene,...i):new t("",this._frameGraph,this._scene);return r._deserialize(e),r}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this._frameGraphTask?.dispose(),this._frameGraphTask=void 0,this.onBuildObservable.clear()}}(0,r.Cg)([(0,s.lK)("comment")],u.prototype,"comments",void 0)},4066:(e,t,i)=>{i.d(t,{t:()=>s});var r=i(6740),n=i(98552);class s{get direction(){return this._direction}get type(){if(this._type===n.tp.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===n.tp.BasedOnInput){if(this._typeConnectionSource){const e="function"==typeof this._typeConnectionSource?this._typeConnectionSource():this._typeConnectionSource;return e.isConnected?e._connectedPoint.type:this._defaultConnectionPointType??e.type}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}constructor(e,t,i){this._connectedPoint=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=n.tp.Undefined,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new r.cP,this.onDisconnectionObservable=new r.cP,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeRenderGraphConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==n.tp.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,s=t;return 0===this.direction&&(r=t,s=i),r.isAnAncestorOf(s)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=0,i=2**t;for(;i<n.tp.All;)e&i||this.excludedConnectionPointTypes.push(i),t++,i=2**t}addAcceptedConnectionPointTypes(e){let t=0,i=2**t;for(;i<n.tp.All;)e&i&&-1===this.acceptedConnectionPointTypes.indexOf(i)&&this.acceptedConnectionPointTypes.push(i),t++,i=2**t}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}},97401:(e,t,i)=>{i.d(t,{x:()=>n});var r=i(83445);class n extends r.X{static IsCullPass(e){return void 0!==e.setObjectList}get objectList(){return this._objectList}setObjectList(e){this._objectList=e}constructor(e,t,i,r){super(e,t,i),this._engine=r}_isValid(){return super._isValid()||(void 0!==this._objectList?null:"Object list is not set (call setObjectList to set it)")}}},83445:(e,t,i)=>{i.d(t,{X:()=>r});class r{constructor(e,t,i){this.name=e,this._parentTask=t,this._context=i}setExecuteFunc(e){this._executeFunc=e}_execute(){this._executeFunc(this._context)}_isValid(){return void 0!==this._executeFunc?null:"Execute function is not set (call setExecuteFunc to set it)"}}},95873:(e,t,i)=>{i.d(t,{p:()=>n});var r=i(83445);class n extends r.X{static IsRenderPass(e){return void 0!==e.setRenderTarget}get renderTarget(){return this._renderTarget}get renderTargetDepth(){return this._renderTargetDepth}constructor(e,t,i,r){super(e,t,i),this._usedTextures=[],this._engine=r}useTexture(e){this._usedTextures.push(e)}setRenderTarget(e){this._renderTarget=e}setRenderTargetDepth(e){this._renderTargetDepth=e}_execute(){this._frameGraphRenderTarget=this._frameGraphRenderTarget||this._context.createRenderTarget(this.name,this._renderTarget,this._renderTargetDepth),this._context.bindRenderTarget(this._frameGraphRenderTarget,`frame graph render pass - ${this.name}`),super._execute(),this._context._flushDebugMessages()}_isValid(){return super._isValid()||(void 0!==this._renderTarget||void 0!==this.renderTargetDepth?null:"Render target and render target depth cannot both be undefined.")}}},10310:(e,t,i)=>{i.d(t,{L:()=>s});var r=i(97401),n=i(95873);class s{get name(){return this._name}set name(e){this._name=e}get disabled(){return this._disabled}set disabled(e){this._disabled=e}isReady(){return!0}dispose(){this._reset()}constructor(e,t){this._passes=[],this._passesDisabled=[],this._disabled=!1,this.name=e,this._frameGraph=t,this._reset()}_reset(){this._passes.length=0,this._passesDisabled.length=0}_addPass(e,t){t?this._passesDisabled.push(e):this._passes.push(e)}_checkTask(){let e,t=null,i=null;for(const s of this._passes){const a=s._isValid();if(a)throw new Error(`Pass "${s.name}" is not valid. ${a}`);if(n.p.IsRenderPass(s)){const e=Array.isArray(s.renderTarget)?s.renderTarget:[s.renderTarget];t=[];for(const i of e)void 0!==i&&t.push(this._frameGraph.textureManager.getTextureFromHandle(i));i=void 0!==s.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(s.renderTargetDepth):null}else r.x.IsCullPass(s)&&(e=s.objectList)}let s,a=null,o=[],l=null;for(const e of this._passesDisabled){const t=e._isValid();if(t)throw new Error(`Pass "${e.name}" is not valid. ${t}`);if(n.p.IsRenderPass(e)){const t=Array.isArray(e.renderTarget)?e.renderTarget:[e.renderTarget];a=[];for(const e of t)void 0!==e&&a.push(this._frameGraph.textureManager.getTextureFromHandle(e));o=t,l=void 0!==e.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(e.renderTargetDepth):null}else r.x.IsCullPass(e)&&(s=e.objectList)}if(this._passesDisabled.length>0){if(!this._checkSameRenderTarget(t,a)){let e=!0;for(const t of o)if(void 0!==t&&!this._frameGraph.textureManager.isHistoryTexture(t)){e=!1;break}if(!e)throw new Error(`The output texture of the task "${this.name}" is different when it is enabled or disabled.`)}if(i!==l)throw new Error(`The output depth texture of the task "${this.name}" is different when it is enabled or disabled.`);if(e!==s)throw new Error(`The output object list of the task "${this.name}" is different when it is enabled or disabled.`)}}_getPasses(){return this.disabled&&this._passesDisabled.length>0?this._passesDisabled:this._passes}_checkSameRenderTarget(e,t){if(null===e||null===t)return e===t;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}}},8209:(e,t,i)=>{i.d(t,{e:()=>p});var r=i(6740),n=i(34116),s=i(9191),a=i(84900),o=i(2073),l=i(9472),c=i(35881),h=i(78065),u=i(39341),d=i(54983);class p extends l.Fq{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreateArrow(e,t,i=1,r=!1){const s=new n.V("arrow",e),o=(0,a.zk)("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(i-1)/4),tessellation:96},e),l=(0,a.zk)("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},e);return o.parent=s,o.material=t,o.rotation.x=Math.PI/2,o.position.z+=.3,l.parent=s,l.material=t,l.position.z+=.1375,l.rotation.x=Math.PI/2,r&&(l.visibility=0,o.visibility=0),s}static _CreateArrowInstance(e,t){const i=new n.V("arrow",e);for(const e of t.getChildMeshes())e.createInstance(e.name).parent=i;return i}constructor(e,t=u.v9.Gray(),i=c.j.DefaultUtilityLayer,n=null,a=1,l=u.v9.Yellow(),f=u.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new r.cP,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._parent=n,this._coloredMaterial=new h.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new u.v9(.1,.1,.1)),this._hoverMaterial=new h.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._disableMaterial=new h.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=f,this._disableMaterial.alpha=.4;const m=p._CreateArrow(i.utilityLayerScene,this._coloredMaterial,a),_=p._CreateArrow(i.utilityLayerScene,this._coloredMaterial,a+4,!0);this._gizmoMesh=new s.e("",i.utilityLayerScene),this._gizmoMesh.addChild(m),this._gizmoMesh.addChild(_),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let g=0;const v={snapDistance:0};this.dragBehavior=new o.C({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{if(this.attachedNode){let t=!1;if(0==this.snapDistance)this.attachedNode.getWorldMatrix().getTranslationToRef(d.AA.Vector3[2]),d.AA.Vector3[2].addInPlace(e.delta),this.dragBehavior.validateDrag(d.AA.Vector3[2])&&(this.attachedNode.position&&this.attachedNode.position.addInPlaceFromFloats(e.delta.x,e.delta.y,e.delta.z),this.attachedNode.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z),this.attachedNode.updateCache(),t=!0);else if(g+=e.dragDistance,Math.abs(g)>this.snapDistance){const i=Math.floor(Math.abs(g)/this.snapDistance);g%=this.snapDistance,e.delta.normalizeToRef(d.AA.Vector3[1]),d.AA.Vector3[1].scaleInPlace(this.snapDistance*i),this.attachedNode.getWorldMatrix().getTranslationToRef(d.AA.Vector3[2]),d.AA.Vector3[2].addInPlace(d.AA.Vector3[1]),this.dragBehavior.validateDrag(d.AA.Vector3[2])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(d.AA.Vector3[1].x,d.AA.Vector3[1].y,d.AA.Vector3[1].z),this.attachedNode.updateCache(),v.snapDistance=this.snapDistance*i*Math.sign(g),this.onSnapObservable.notifyObservers(v),t=!0)}t&&this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const S=i._getSharedGizmoLight();S.includedOnlyMeshes=S.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const x={gizmoMeshes:m.getChildMeshes(),colliderMeshes:_.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(_,x),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(!this._customMeshSet&&(this._isHovered=!(-1==x.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent)){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(x.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(x.gizmoMeshes,e?x.material:x.disableMaterial)}))}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}},9472:(e,t,i)=>{i.d(t,{Fq:()=>u,oO:()=>r,ry:()=>n});var r,n,s=i(54983),a=i(9191),o=i(63832),l=i(35881),c=i(31780),h=i(75556);!function(e){e[e.Origin=0]="Origin",e[e.Pivot=1]="Pivot"}(r||(r={})),function(e){e[e.World=0]="World",e[e.Local=1]="Local"}(n||(n={}));class u{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach((e=>{e.dispose()})),e.parent=this._rootMesh,this._customMeshSet=!0}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){this._additionalTransformNode=e}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=1==e;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=l.j.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=0,this._updateScale=!0,this._coordinatesMode=1,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=s.uq.RotationY(Math.PI),this._rootMesh=new a.e("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=s.PT.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this._update()}))}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(1==this.anchorPoint&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new s.Pq(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,u.PreserveScaling?t:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,s.AA.Vector3[0]);let r=this.scaleRatio;if(t.mode==o.i.ORTHOGRAPHIC_CAMERA)t.orthoTop&&t.orthoBottom&&(r*=t.orthoTop-t.orthoBottom);else{const e=t.getScene().useRightHandedSystem?s.Pq.RightHandedForwardReadOnly:s.Pq.LeftHandedForwardReadOnly,i=t.getDirection(e);r*=s.Pq.Dot(s.AA.Vector3[0],i)}this._rootMesh.scaling.setAll(r),e._getWorldMatrixDeterminant()<0&&!u.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}this.additionalTransformNode&&(this._rootMesh.computeWorldMatrix(!0),this._rootMesh.getWorldMatrix().multiplyToRef(this.additionalTransformNode.getWorldMatrix(),s.AA.Matrix[0]),s.AA.Matrix[0].decompose(this._rootMesh.scaling,this._rootMesh.rotationQuaternion,this._rootMesh.position))}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix())return e.getPivotMatrix().invertToRef(s.AA.Matrix[5]),void s.AA.Matrix[5].multiplyToRef(t,i);i.copyFrom(t)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const i=s.AA.Matrix[1];e.parent._worldMatrix.invertToRef(i),this._attachedNode._worldMatrix.multiplyToRef(i,s.AA.Matrix[0]),t=s.AA.Matrix[0]}else t=this._attachedNode._worldMatrix;if(e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,s.AA.Matrix[1]),i=s.AA.Matrix[1]):i=t,i.decompose(s.AA.Vector3[1],s.AA.Quaternion[0],s.AA.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const e=this._attachedNode;e.rotation=s.AA.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(s.AA.Quaternion[0]),e.rotationQuaternion.normalize())}e.position.copyFrom(s.AA.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const e=this._attachedNode;if(e.parent){const t=s.AA.Matrix[0],i=s.AA.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);const r=s.AA.Matrix[4];if(this._handlePivotMatrixInverse(e,i,r),r.decompose(s.AA.Vector3[0],s.AA.Quaternion[0],e.position,u.PreserveScaling?e:void 0,u.UseAbsoluteScaling),s.AA.Quaternion[0].normalize(),e.isUsingPivotMatrix()){const t=s.AA.Quaternion[1];s.PT.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,t);const i=s.AA.Matrix[2];s.uq.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i);const r=s.AA.Matrix[2];t.toRotationMatrix(r);const n=e.getPivotMatrix(),a=s.AA.Matrix[3];n.invertToRef(a),n.multiplyToRef(i,s.AA.Matrix[4]),s.AA.Matrix[4].multiplyToRef(r,s.AA.Matrix[5]),s.AA.Matrix[5].multiplyToRef(a,s.AA.Matrix[6]),s.AA.Matrix[6].getTranslationToRef(s.AA.Vector3[1]),e.position.subtractInPlace(s.AA.Vector3[1])}}else{const t=s.AA.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(s.AA.Vector3[0],s.AA.Quaternion[0],e.position,u.PreserveScaling?e:void 0,u.UseAbsoluteScaling)}s.AA.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(s.AA.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(s.AA.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=s.AA.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const e=this._attachedNode,t=e.getParent();if(t){const i=s.AA.Matrix[0],r=s.AA.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,r),e.getLocalMatrix().copyFrom(r)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===h.v.LIGHTTYPEID_DIRECTIONALLIGHT||t===h.v.LIGHTTYPEID_SPOTLIGHT||t===h.v.LIGHTTYPEID_POINTLIGHT){const t=e.parent;if(t){const i=s.AA.Matrix[0],r=s.AA.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,r),r.decompose(void 0,s.AA.Quaternion[0],s.AA.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,s.AA.Quaternion[0],s.AA.Vector3[0]);e.position=new s.Pq(s.AA.Vector3[0].x,s.AA.Vector3[0].y,s.AA.Vector3[0].z),e.direction&&(e.direction=new s.Pq(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach((e=>{e.material=t,e.color&&(e.color=t.diffuseColor)}))}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add((e=>{if(e.pickInfo){if(e.type===c.Zp.POINTERMOVE){if(i)return;t.forEach((t=>{if(t.colliderMeshes&&t.gizmoMeshes){const i=-1!=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh),r=t.dragBehavior.enabled?i||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=r,e.color&&(e.color=r.diffuseColor)}))}}))}e.type===c.Zp.POINTERDOWN&&t.has(e.pickInfo.pickedMesh?.parent)&&(i=!0,t.get(e.pickInfo.pickedMesh?.parent).active=!0,t.forEach((t=>{const i=(-1!=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh)||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=i,e.color&&(e.color=i.diffuseColor)}))}))),e.type===c.Zp.POINTERUP&&t.forEach((e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach((t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)}))}))}}))}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}u.PreserveScaling=!1,u.UseAbsoluteScaling=!0},84442:(e,t,i)=>{i.d(t,{W:()=>p});var r=i(6740),n=i(54983),s=i(39341),a=i(69583),o=i(59396),l=i(93803),c=i(23077),h=i(43981),u=i(8013),d=i(95776);class p{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,l,f,m=!1){this.name=e,this._applyPostProcess=!0,this.scale=new n.I9(1,1),this.offset=new n.I9(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.convertToLinearSpace=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new r.cP,this.onBeforeRenderObservable=new r.cP,this.onAfterRenderObservable=new r.cP,this._shaderLanguage=0,this._shadersLoaded=!1,this.texture=t?new c.g(t,i,!0):null,this.isBackground=void 0===l||l,this.color=void 0===f?new s.ov(1,1,1,1):f,this._scene=i||a.q.LastCreatedScene;const _=this._scene.getEngine();!_.isWebGPU||m||p.ForceGLSL||(this._shaderLanguage=1);let g=this._scene._getComponent(h.v.NAME_LAYER);g||(g=new u.b(this._scene),this._scene._addComponent(g)),this._scene.layers.push(this),this._drawWrapper=new d.E(_);const v=[];v.push(1,1),v.push(-1,1),v.push(-1,-1),v.push(1,-1);const S=new o.R(_,v,o.R.PositionKind,!1,!1,2);this._vertexBuffers[o.R.PositionKind]=S,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[o.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){const e=this._scene.getEngine();let t="";this.alphaTest&&(t="#define ALPHATEST"),this.texture&&(this.texture.gammaSpace?this.convertToLinearSpace&&(t+="\n#define CONVERT_TO_LINEAR"):this.convertToLinearSpace||(t+="\n#define CONVERT_TO_GAMMA")),this._previousDefines!==t&&(this._previousDefines=t,this._drawWrapper.effect=e.createEffect("layer",[o.R.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],t,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,31333)),Promise.resolve().then(i.bind(i,32379))]):await Promise.all([Promise.resolve().then(i.bind(i,25890)),Promise.resolve().then(i.bind(i,96996))]),this._shadersLoaded=!0}));const r=this._drawWrapper.effect;return!!r?.isReady()&&(!this.texture||this.texture.isReady())}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();if(!this.isReady())return;const t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),this.texture&&(t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix())),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(l.i.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(l.i.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){const e=this._vertexBuffers[o.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[o.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}p.ForceGLSL=!1},8013:(e,t,i)=>{i.d(t,{b:()=>s});var r=i(43981),n=i(69583);class s{constructor(e){this.name=r.v.NAME_LAYER,this.scene=e||n.q.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._beforeCameraDrawStage.registerStep(r.v.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(r.v.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(r.v.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(r.v.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(r.v.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(r.v.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const t of e)t._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(const i of t)e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,r){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&!!(e.layerMask&r)}_drawCameraBackground(e){this._draw((t=>this._drawCameraPredicate(t,!0,!0,e.layerMask)))}_drawCameraForegroundWithPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!0,e.layerMask)))}_drawCameraForegroundWithoutPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!1,e.layerMask)))}_drawRenderTargetPredicate(e,t,i,r,n){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(n)>-1&&!!(e.layerMask&r)}_drawRenderTargetBackground(e){this._draw((t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e)))}addFromContainer(e){e.layers&&e.layers.forEach((e=>{this.scene.layers.push(e)}))}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach((e=>{const i=this.scene.layers.indexOf(e);-1!==i&&this.scene.layers.splice(i,1),t&&e.dispose()}))}}},89962:(e,t,i)=>{i.d(t,{Z:()=>h});var r=i(90576),n=i(96631),s=i(54983),a=i(69346),o=i(75556),l=i(23728),c=i(88252);a.b.AddNodeConstructor("Light_Type_1",((e,t)=>()=>new h(e,s.Pq.Zero(),t)));class h extends l.p{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return o.v.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&s.uq.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=s.Pq.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let r=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let a=0;a<i.length;a++){const o=i[a];if(!o)continue;const l=o.getBoundingInfo().boundingBox;for(let i=0;i<l.vectorsWorld.length;i++)s.Pq.TransformCoordinatesToRef(l.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<r&&(r=e.z),e.z>n&&(n=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=r,this._shadowMaxZ=n)}const n=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,l=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;s.uq.OrthoOffCenterLHToRef(this._orthoLeft-n*this.shadowOrthoScale,this._orthoRight+n*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}(0,r.Cg)([(0,n.lK)()],h.prototype,"shadowFrustumSize",null),(0,r.Cg)([(0,n.lK)()],h.prototype,"shadowOrthoScale",null),(0,r.Cg)([(0,n.lK)()],h.prototype,"autoUpdateExtends",void 0),(0,r.Cg)([(0,n.lK)()],h.prototype,"autoCalcShadowZBounds",void 0),(0,r.Cg)([(0,n.lK)("orthoLeft")],h.prototype,"_orthoLeft",void 0),(0,r.Cg)([(0,n.lK)("orthoRight")],h.prototype,"_orthoRight",void 0),(0,r.Cg)([(0,n.lK)("orthoTop")],h.prototype,"_orthoTop",void 0),(0,r.Cg)([(0,n.lK)("orthoBottom")],h.prototype,"_orthoBottom",void 0),(0,c.Y5)("BABYLON.DirectionalLight",h)},57069:(e,t,i)=>{i.d(t,{g:()=>h});var r=i(90576),n=i(96631),s=i(54983),a=i(39341),o=i(69346),l=i(75556),c=i(88252);o.b.AddNodeConstructor("Light_Type_3",((e,t)=>()=>new h(e,s.Pq.Zero(),t)));class h extends l.v{constructor(e,t,i){super(e,i),this.groundColor=new a.v9(0,0,0),this.direction=t||s.Pq.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=s.Pq.Normalize(e.subtract(s.Pq.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=s.Pq.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=s.Pq.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=s.uq.Identity()),this._worldMatrix}getTypeID(){return l.v.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}(0,r.Cg)([(0,n.jT)()],h.prototype,"groundColor",void 0),(0,r.Cg)([(0,n.P_)()],h.prototype,"direction",void 0),(0,c.Y5)("BABYLON.HemisphericLight",h)},75556:(e,t,i)=>{i.d(t,{v:()=>d});var r=i(90576),n=i(96631),s=i(54983),a=i(39341),o=i(69346),l=i(55179),c=i(88252),h=i(67695),u=i(16265);class d extends o.b{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new a.v9(1,1,1),this.specular=new a.v9(1,1,1),this.falloffType=d.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=d.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new l.D(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,n=!0){const s=e.toString();let o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+s),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;const e=this.getScaledIntensity();this.transferToEffect(i,s),this.diffuse.scaleToRef(e,a.IG.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",a.IG.Color3[0],this.range,s),r&&(this.specular.scaleToRef(e,a.IG.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",a.IG.Color3[1],this.radius,s)),o=!0}if(this.transferTexturesToEffect(i,s),t.shadowsEnabled&&this.shadowEnabled&&n){const e=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();e&&(e.bindShadowLight(s,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return null===this._shadowGenerators?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return s.Pq.Zero()}canAffectMesh(e){return!(e&&(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||!(0===this.includeOnlyWithLayerMask||this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask))}dispose(e,t=!1){if(this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null}for(const e of this.getScene().meshes)e._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=d.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const r=u.p.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){const e=u.p.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach((t=>{e.excludedMeshesIds.push(t.id)}))),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((t=>{e.includedOnlyMeshesIds.push(t.id)}))),u.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){return o.b.Construct("Light_Type_"+e,t,i)||null}static Parse(e,t){const i=d.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const r=u.p.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(r.falloffType=e.falloffType),void 0!==e.lightmapMode&&(r.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=(0,c.n9)("BABYLON.Animation");n&&r.animations.push(n.Parse(i))}o.b.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){const t=e.push;e.push=(...i)=>{const r=t.apply(e,i);for(const e of i)e._resyncLightSource(this);return r};const i=e.splice;e.splice=(t,r)=>{const n=i.apply(e,[t,r]);for(const e of n)e._resyncLightSource(this);return n};for(const t of e)t._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...i)=>{const r=t.apply(e,i);return this._resyncMeshes(),r};const i=e.splice;e.splice=(t,r)=>{const n=i.apply(e,[t,r]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===d.INTENSITYMODE_AUTOMATIC&&(i=t===d.LIGHTTYPEID_DIRECTIONALLIGHT?d.INTENSITYMODE_ILLUMINANCE:d.INTENSITYMODE_LUMINOUSINTENSITY),t){case d.LIGHTTYPEID_POINTLIGHT:case d.LIGHTTYPEID_SPOTLIGHT:switch(i){case d.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case d.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case d.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case d.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case d.INTENSITYMODE_ILLUMINANCE:e=1;break;case d.INTENSITYMODE_LUMINANCE:{let t=this.radius;t=Math.max(t,.001),e=2*Math.PI*(1-Math.cos(t));break}}break;case d.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}d.FALLOFF_DEFAULT=h.c.FALLOFF_DEFAULT,d.FALLOFF_PHYSICAL=h.c.FALLOFF_PHYSICAL,d.FALLOFF_GLTF=h.c.FALLOFF_GLTF,d.FALLOFF_STANDARD=h.c.FALLOFF_STANDARD,d.LIGHTMAP_DEFAULT=h.c.LIGHTMAP_DEFAULT,d.LIGHTMAP_SPECULAR=h.c.LIGHTMAP_SPECULAR,d.LIGHTMAP_SHADOWSONLY=h.c.LIGHTMAP_SHADOWSONLY,d.INTENSITYMODE_AUTOMATIC=h.c.INTENSITYMODE_AUTOMATIC,d.INTENSITYMODE_LUMINOUSPOWER=h.c.INTENSITYMODE_LUMINOUSPOWER,d.INTENSITYMODE_LUMINOUSINTENSITY=h.c.INTENSITYMODE_LUMINOUSINTENSITY,d.INTENSITYMODE_ILLUMINANCE=h.c.INTENSITYMODE_ILLUMINANCE,d.INTENSITYMODE_LUMINANCE=h.c.INTENSITYMODE_LUMINANCE,d.LIGHTTYPEID_POINTLIGHT=h.c.LIGHTTYPEID_POINTLIGHT,d.LIGHTTYPEID_DIRECTIONALLIGHT=h.c.LIGHTTYPEID_DIRECTIONALLIGHT,d.LIGHTTYPEID_SPOTLIGHT=h.c.LIGHTTYPEID_SPOTLIGHT,d.LIGHTTYPEID_HEMISPHERICLIGHT=h.c.LIGHTTYPEID_HEMISPHERICLIGHT,(0,r.Cg)([(0,n.jT)()],d.prototype,"diffuse",void 0),(0,r.Cg)([(0,n.jT)()],d.prototype,"specular",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"falloffType",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"intensity",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"range",null),(0,r.Cg)([(0,n.lK)()],d.prototype,"intensityMode",null),(0,r.Cg)([(0,n.lK)()],d.prototype,"radius",null),(0,r.Cg)([(0,n.lK)()],d.prototype,"_renderPriority",void 0),(0,r.Cg)([(0,n.$z)("_reorderLightsInScene")],d.prototype,"renderPriority",void 0),(0,r.Cg)([(0,n.lK)("shadowEnabled")],d.prototype,"_shadowEnabled",void 0),(0,r.Cg)([(0,n.lK)("excludeWithLayerMask")],d.prototype,"_excludeWithLayerMask",void 0),(0,r.Cg)([(0,n.lK)("includeOnlyWithLayerMask")],d.prototype,"_includeOnlyWithLayerMask",void 0),(0,r.Cg)([(0,n.lK)("lightmapMode")],d.prototype,"_lightmapMode",void 0)},92264:(e,t,i)=>{i.d(t,{H:()=>h});var r=i(90576),n=i(96631),s=i(54983),a=i(69346),o=i(75556),l=i(23728),c=i(88252);a.b.AddNodeConstructor("Light_Type_0",((e,t)=>()=>new h(e,s.Pq.Zero(),t)));class h extends l.p{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return o.v.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new s.Pq(1,0,0);case 1:return new s.Pq(-1,0,0);case 2:return new s.Pq(0,-1,0);case 3:return new s.Pq(0,1,0);case 4:return new s.Pq(0,0,1);case 5:return new s.Pq(0,0,-1)}return s.Pq.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;const n=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;s.uq.PerspectiveFovLHToRef(this.shadowAngle,1,o?a:n,o?n:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}(0,r.Cg)([(0,n.lK)()],h.prototype,"shadowAngle",null),(0,c.Y5)("BABYLON.PointLight",h)},23728:(e,t,i)=>{i.d(t,{p:()=>l});var r=i(90576),n=i(96631),s=i(54983),a=i(75556),o=i(73537);class l extends a.v{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=s.uq.Identity(),this._projectionMatrix=s.uq.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=s.Pq.Zero()),s.Pq.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=s.Pq.Zero()),s.Pq.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=s.Pq.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=s.Pq.Cross(this.direction,o._0.Y),t=s.Pq.Cross(e,this.direction);return s.Pq.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=s.Pq.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=s.uq.Identity()),s.uq.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=s.AA.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),s.Pq.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(s.Pq.Dot(t,s.Pq.Up()))&&(t.z=1e-13);const r=s.AA.Vector3[1];return i.addToRef(t,r),s.uq.LookAtLHToRef(i,r,s.Pq.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}(0,r.Cg)([(0,n.P_)()],l.prototype,"position",null),(0,r.Cg)([(0,n.P_)()],l.prototype,"direction",null),(0,r.Cg)([(0,n.lK)()],l.prototype,"shadowMinZ",null),(0,r.Cg)([(0,n.lK)()],l.prototype,"shadowMaxZ",null)},9212:(e,t,i)=>{i.d(t,{n:()=>u});var r=i(90576),n=i(96631),s=i(54983),a=i(69346),o=i(75556),l=i(23728),c=i(23077),h=i(88252);a.b.AddNodeConstructor("Light_Type_2",((e,t)=>()=>new u(e,s.Pq.Zero(),s.Pq.Zero(),0,0,t)));class u extends l.p{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(u._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled((()=>{this._markMeshesAsLightDirty()})):u._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce((()=>{this._markMeshesAsLightDirty()}))))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,n,a){super(e,a),this._innerAngle=0,this._projectionTextureMatrix=s.uq.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=s.Pq.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=s.Pq.Zero(),this._projectionTextureViewLightMatrix=s.uq.Zero(),this._projectionTextureProjectionLightMatrix=s.uq.Zero(),this._projectionTextureScalingMatrix=s.uq.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=n}getClassName(){return"SpotLight"}getTypeID(){return o.v.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;const n=this._shadowAngleScale*this._angle,a=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;s.uq.PerspectiveFovLHToRef(n,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),s.uq.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,n=1/Math.tan(this._angle/2);s.uq.FromValuesToRef(n/1,0,0,0,0,n,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof c.g){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;s.uq.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=s.Pq.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=s.Pq.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return i=this.computeTransformedInformation()?s.Pq.Normalize(this.transformedDirection):s.Pq.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady())}}(0,r.Cg)([(0,n.lK)()],u.prototype,"angle",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"innerAngle",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"shadowAngleScale",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"exponent",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"projectionTextureLightNear",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"projectionTextureLightFar",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"projectionTextureUpDirection",null),(0,r.Cg)([(0,n.uM)("projectedLightTexture")],u.prototype,"_projectionTexture",void 0),(0,h.Y5)("BABYLON.SpotLight",u)},88576:(e,t,i)=>{i.d(t,{Iz:()=>a,LO:()=>l,cf:()=>o,ji:()=>s,oj:()=>c});const r={},n={};function s(e,t){r[e]=t}function a(e){return r[e]?r[e]:null}function o(e,t){n[e]=t}function l(e){return n[e]?n[e]:null}function c(e,t,i,n){for(const s in r)Object.prototype.hasOwnProperty.call(r,s)&&r[s](e,t,i,n)}},10111:(e,t,i)=>{i.d(t,{cn:()=>B,gD:()=>r,VU:()=>I,fV:()=>L,kS:()=>N,VA:()=>y,cH:()=>C});var r,n=i(90066),s=i(6740),a=i(86521),o=i(69583),l=i(70461),c=i(90777),h=i(42712),u=i(85647),d=i(88076),p=i(80770),f=i(17298);!function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync"}(r||(r={}));const m=new s.cP,_={};let g=!1;function v(){return _[".babylon"]}function S(e,t){return _[e]||(l.V.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),t?v():void 0)}function x(e,t,i){let r="Unable to load from "+(e.rawData?"binary data":e.url);return t?r+=`: ${t}`:i&&(r+=`: ${i}`),r}async function T(e,t,i,r,n,s,a,o,l){const c="data:"===(u=e.url).substring(0,5)?u.substring(5):null;var u;if(e.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";const d=c||a?"":function(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf(".");return e.substring(i,e.length).toLowerCase()}(e.url);let g=a?S(a,!0):c?function(e){for(const t in _){const i=_[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return _[t]}return v()}(e.url):S(d,!1);if(!g&&d){if(e.url&&!e.url.startsWith("blob:")){const t=await function(e,t){const i=t.method||"GET";return new Promise(((r,n)=>{const s=new f.u;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const e={};if(t.responseHeaders)for(const i of t.responseHeaders)e[i]=s.getResponseHeader(i)||"";r({response:s.response,headerValues:e})}else n(`Unable to fetch data from ${e}. Error code: ${s.status}`)})),s.open(i,e),s.send()}))}(e.url,{method:"HEAD",responseHeaders:["Content-Type"]}),i=t.headerValues?t.headerValues["Content-Type"]:"";i&&(g=function(e){for(const t in _){const i=_[t];if(i.mimeType===e)return i}}(i))}g||(g=v())}if(!g)throw new Error(`No plugin or fallback for ${a??e.url}`);if(!1===l?.[g.plugin.name]?.enabled)throw new Error(`The '${g.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(e.rawData&&!g.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(e=>{if(g.plugin.createPlugin){const t=g.plugin.createPlugin(l??{});return t instanceof Promise?(t.then(e).catch((e=>{n("Error instantiating plugin.",e)})),null):(e(t),t)}return e(g.plugin),g.plugin})((l=>{if(!l)throw`The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(m.notifyObservers(l),c&&(l.canDirectLoad&&l.canDirectLoad(e.url)||!(0,h.f2)(e.url))){if(l.directLoad){const e=l.directLoad(t,c);e instanceof Promise?e.then((e=>{i(l,e)})).catch((e=>{n("Error in directLoad of _loadData: "+e,e)})):i(l,e)}else i(l,c);return}const u=g.isBinary,d=(e,r)=>{t.isDisposed?n("Scene has been disposed"):i(l,e,r)};let f=null,_=!1;l.onDisposeObservable?.add((()=>{_=!0,f&&(f.abort(),f=null),s()}));const v=()=>{if(_)return;const i=(e,t)=>{n(e?.statusText,t)};if(!l.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";f=l.loadFile?l.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,d,r,u,i,o):t._loadFile(e.file||e.url,d,r,!0,u,i)},S=t.getEngine();let x=S.enableOfflineSupport;if(x){let i=!1;for(const r of t.disableOfflineSupportExceptionRules)if(r.test(e.url)){i=!0;break}x=!i}x&&p.$.OfflineProviderFactory?t.offlineProvider=p.$.OfflineProviderFactory(e.url,v,S.disableManifestCheck):v()}))}function E(e,t){let i,r,s=null,a=null;if(t)if(t.name)i=`file:${t.name}`,r=t.name,s=t;else if(ArrayBuffer.isView(t))i="",r=(0,d.z)(),a=t;else if(t.startsWith("data:"))i=t,r="";else if(e){const s=t;if("/"===s.substring(0,1))return n.S0.Error("Wrong sceneFilename parameter"),null;i=e+s,r=s}else i=t,r=n.S0.GetFilename(t),e=n.S0.GetFolderPath(t);else i=e,r=n.S0.GetFilename(e),e=n.S0.GetFolderPath(e);return{url:i,rootUrl:e,name:r,file:s,rawData:a}}function C(e){if("string"==typeof e.extensions){const t=e.extensions;_[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach((i=>{_[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary,mimeType:t[i].mimeType}}))}}async function b(e,t,i="",r=o.q.LastCreatedScene,n=null,s=null,a=null,c=null,h="",d={}){if(!r)return l.V.Error("No scene available to import mesh to"),null;const p=E(t,i);if(!p)return null;const f={};r.addPendingData(f);const m=()=>{r.removePendingData(f)},_=(e,t)=>{const i=x(p,e,t);a?a(r,i,new u.bu(i,u.tG.SceneLoaderError,t)):l.V.Error(i),m()},g=s?e=>{try{s(e)}catch(e){_("Error in onProgress callback: "+e,e)}}:void 0,v=(e,t,i,s,a,o,l,c)=>{if(r.importedMeshesFiles.push(p.url),n)try{n(e,t,i,s,a,o,l,c)}catch(e){_("Error in onSuccess callback: "+e,e)}r.removePendingData(f)};return await T(p,r,((t,i,n)=>{if(t.rewriteRootURL&&(p.rootUrl=t.rewriteRootURL(p.rootUrl,n)),t.importMesh){const n=[],s=[],a=[];if(!t.importMesh(e,r,i,p.rootUrl,n,s,a,_))return;r.loadingPluginName=t.name,v(n,s,a,[],[],[],[],[])}else t.importMeshAsync(e,r,i,p.rootUrl,g,p.name).then((e=>{r.loadingPluginName=t.name,v(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights,e.spriteManagers)})).catch((e=>{_(e.message,e)}))}),g,_,m,c,h,d)}function P(e,t="",i=o.q.LastCreatedEngine,r=null,s=null,l=null,c=null,h="",u={}){i?R(e,t,new a.Z(i),r,s,l,c,h,u):n.S0.Error("No engine available")}function y(e,t,i){const{rootUrl:r="",onProgress:n,pluginExtension:s,name:a,pluginOptions:o}=i??{};return A(r,e,t,n,s,a,o)}function A(e,t,i,r,n,s,a){return new Promise(((o,l)=>{P(e,t,i,(e=>{o(e)}),r,((e,t,i)=>{l(i||new Error(t))}),n,s,a)}))}async function R(e,t="",i=o.q.LastCreatedScene,r=null,n=null,s=null,a=null,h="",d={}){if(!i)return l.V.Error("No scene available to append to"),null;const p=E(e,t);if(!p)return null;const f={};i.addPendingData(f);const m=()=>{i.removePendingData(f)};c.B.ShowLoadingScreen&&!g&&(g=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady((()=>{i.getEngine().hideLoadingUI(),g=!1})));const _=(e,t)=>{const r=x(p,e,t);s?s(i,r,new u.bu(r,u.tG.SceneLoaderError,t)):l.V.Error(r),m()},v=n?e=>{try{n(e)}catch(e){_("Error in onProgress callback",e)}}:void 0,S=()=>{if(r)try{r(i)}catch(e){_("Error in onSuccess callback",e)}i.removePendingData(f)};return await T(p,i,((e,t)=>{if(e.load){if(!e.load(i,t,p.rootUrl,_))return;i.loadingPluginName=e.name,S()}else e.loadAsync(i,t,p.rootUrl,v,p.name).then((()=>{i.loadingPluginName=e.name,S()})).catch((e=>{_(e.message,e)}))}),v,_,m,a,h,d)}async function I(e,t,i){const{rootUrl:r="",onProgress:n,pluginExtension:s,name:a,pluginOptions:o}=i??{};await M(r,e,t,n,s,a,o)}function M(e,t,i,r,n,s,a){return new Promise(((o,l)=>{R(e,t,i,(e=>{o(e)}),r,((e,t,i)=>{l(i||new Error(t))}),n,s,a)}))}async function O(e,t="",i=o.q.LastCreatedScene,r=null,n=null,s=null,a=null,c="",h={}){if(!i)return l.V.Error("No scene available to load asset container to"),null;const d=E(e,t);if(!d)return null;const p={};i.addPendingData(p);const f=()=>{i.removePendingData(p)},m=(e,t)=>{const r=x(d,e,t);s?s(i,r,new u.bu(r,u.tG.SceneLoaderError,t)):l.V.Error(r),f()},_=n?e=>{try{n(e)}catch(e){m("Error in onProgress callback",e)}}:void 0,g=e=>{if(r)try{r(e)}catch(e){m("Error in onSuccess callback",e)}i.removePendingData(p)};return await T(d,i,((e,t)=>{if(e.loadAssetContainer){const r=e.loadAssetContainer(i,t,d.rootUrl,m);if(!r)return;r.populateRootNodes(),i.loadingPluginName=e.name,g(r)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(i,t,d.rootUrl,_,d.name).then((t=>{t.populateRootNodes(),i.loadingPluginName=e.name,g(t)})).catch((e=>{m(e.message,e)})):m("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),_,m,f,a,c,h)}function N(e,t,i){const{rootUrl:r="",onProgress:n,pluginExtension:s,name:a,pluginOptions:o}=i??{};return D(r,e,t,n,s,a,o)}function D(e,t,i,r,n,s,a){return new Promise(((o,l)=>{O(e,t,i,(e=>{o(e)}),r,((e,t,i)=>{l(i||new Error(t))}),n,s,a)}))}function F(e,t="",i=o.q.LastCreatedScene,r=!0,n=0,s=null,a=null,c=null,h=null,u=null,d="",p={}){if(!i)return void l.V.Error("No scene available to load animations to");if(r){for(const e of i.animatables)e.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach((e=>{e.dispose()})),i.getNodes().forEach((e=>{e.animations&&(e.animations=[])}))}else switch(n){case 0:i.animationGroups.slice().forEach((e=>{e.dispose()}));break;case 1:i.animationGroups.forEach((e=>{e.stop()}));break;case 2:i.animationGroups.forEach((e=>{e.reset(),e.restart()}));break;case 3:break;default:return void l.V.Error("Unknown animation group loading mode value '"+n+"'")}const f=i.animatables.length;O(e,t,i,(e=>{e.mergeAnimationsTo(i,i.animatables.slice(f),s),e.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)}),c,h,u,d,p)}async function L(e,t,i){const{rootUrl:r="",overwriteAnimations:n,animationGroupLoadingMode:s,targetConverter:a,onProgress:o,pluginExtension:l,name:c,pluginOptions:h}=i??{};await w(r,e,t,n,s,a,o,l,c,h)}function w(e,t,i,r,n,s,a,o,l,c){return new Promise(((h,u)=>{F(e,t,i,r,n,s,(e=>{h(e)}),a,((e,t,i)=>{u(i||new Error(t))}),o,l,c)}))}class B{static get ForceFullSceneLoadingForIncremental(){return c.B.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){c.B.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return c.B.ShowLoadingScreen}static set ShowLoadingScreen(e){c.B.ShowLoadingScreen=e}static get loggingLevel(){return c.B.loggingLevel}static set loggingLevel(e){c.B.loggingLevel=e}static get CleanBoneMatrixWeights(){return c.B.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){c.B.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return v()}static GetPluginForExtension(e){return S(e,!0)?.plugin}static IsPluginForExtensionAvailable(e){return function(e){return!!_[e]}(e)}static RegisterPlugin(e){C(e)}static ImportMesh(e,t,i,r,n,s,a,o,l){b(e,t,i,r,n,s,a,o,l)}static ImportMeshAsync(e,t,i,r,n,s,a){return function(e,t,i,r,n,s,a){return new Promise(((o,l)=>{b(e,t,i,r,((e,t,i,r,n,s,a,l)=>{o({meshes:e,particleSystems:t,skeletons:i,animationGroups:r,transformNodes:n,geometries:s,lights:a,spriteManagers:l})}),n,((e,t,i)=>{l(i||new Error(t))}),s,a,undefined)}))}(e,t,i,r,n,s,a)}static Load(e,t,i,r,n,s,a,o){P(e,t,i,r,n,s,a,o)}static LoadAsync(e,t,i,r,n,s){return A(e,t,i,r,n,s)}static Append(e,t,i,r,n,s,a,o){R(e,t,i,r,n,s,a,o)}static AppendAsync(e,t,i,r,n,s){return M(e,t,i,r,n,s)}static LoadAssetContainer(e,t,i,r,n,s,a,o){O(e,t,i,r,n,s,a,o)}static LoadAssetContainerAsync(e,t,i,r,n,s){return D(e,t,i,r,n,s)}static ImportAnimations(e,t,i,r,n,s,a,o,l,c,h){F(e,t,i,r,n,s,a,o,l,c,h)}static ImportAnimationsAsync(e,t,i,r,n,s,a,o,l,c,h){return w(e,t,i,r,n,s,o,c,h)}}B.NO_LOGGING=0,B.MINIMAL_LOGGING=1,B.SUMMARY_LOGGING=2,B.DETAILED_LOGGING=3,B.OnPluginActivatedObservable=m},92243:(e,t,i)=>{i.d(t,{b:()=>d});var r=i(16265),n=i(59396),s=i(40890),a=i(48248),o=i(88252),l=i(66384),c=i(63832),h=(i(26803),i(74092),i(79986),i(92430),i(64871));class u extends s.M{constructor(){super(),this.FOG=!1,this.THIN_INSTANCES=!0,this.LOGARITHMICDEPTH=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.SH_DEGREE=0,this.rebuild()}}class d extends a.E{constructor(e,t){super(e,t),this.backFaceCulling=!1}get hasRenderTargetTextures(){return!1}needAlphaTesting(){return!1}needAlphaBlending(){return!0}isReadyForSubMesh(e,t){const r=!0,s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===r)return!0;t.materialDefines||(t.materialDefines=new u);const a=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const c=a.getEngine();if((0,h.fm)(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,!1,o),(0,h.OR)(a,c,this,o,r,null,!0),(0,h.qB)(e,o,!1,!1),(c.version>1||c.isWebGPU)&&(o.SH_DEGREE=e.shDegree),o.isDirty){o.markAsProcessed(),a.resetCachedMaterial();const e=[n.R.PositionKind,"splatIndex"];(0,h.ER)(e,o);const r=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal","vEyePosition"],s=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture","shTexture0","shTexture1","shTexture2"],u=["Scene","Mesh"];(0,h.Bb)({uniformsNames:r,uniformBuffersNames:u,samplers:s,defines:o}),(0,l.TV)(r);const d=o.toString(),p=a.getEngine().createEffect("gaussianSplatting",{attributes:e,uniformsNames:r,uniformBuffersNames:u,samplers:s,defines:d,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,79986)),Promise.resolve().then(i.bind(i,92430))]):await Promise.all([Promise.resolve().then(i.bind(i,26803)),Promise.resolve().then(i.bind(i,74092))])}},c);t.setEffect(p,o,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(o._renderId=a.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=r,0))}static BindEffect(e,t,i){const r=i.getEngine(),n=i.activeCamera,s=r.getRenderWidth(),a=r.getRenderHeight(),o=n?.rigParent?.rigCameras.length||1;t.setFloat2("invViewport",1/(s/o),1/a);let l=1e3;if(n){const e=n.getProjectionMatrix().m[5];l=n.fovMode==c.i.FOVMODE_VERTICAL_FIXED?a*e/2:s*e/2}t.setFloat2("focal",l,l);const h=e;if(h.covariancesATexture){const e=h.covariancesATexture.getSize();if(t.setFloat2("dataTextureSize",e.width,e.height),t.setTexture("covariancesATexture",h.covariancesATexture),t.setTexture("covariancesBTexture",h.covariancesBTexture),t.setTexture("centersTexture",h.centersTexture),t.setTexture("colorsTexture",h.colorsTexture),h.shTextures)for(let e=0;e<h.shTextures?.length;e++)t.setTexture(`shTexture${e}`,h.shTextures[e])}}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.materialDefines;if(!n)return;const s=i.effect;s&&(this._activeEffect=s,t.getMeshUniformBuffer().bindToEffect(s,"Mesh"),t.transferToEffect(e),this._mustRebind(r,s,i,t.visibility)?(this.bindView(s),this.bindViewProjection(s),d.BindEffect(t,this._activeEffect,r),(0,l.gS)(s,this,r)):r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0),(0,h.Yy)(r,t,s),this.useLogarithmicDepth&&(0,h.DL)(n,s,r),this._afterBind(t,this._activeEffect,i))}clone(e){return r.p.Clone((()=>new d(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return"GaussianSplattingMaterial"}static Parse(e,t,i){return r.p.Parse((()=>new d(e.name,t)),e,t,i)}}(0,o.Y5)("BABYLON.GaussianSplattingMaterial",d)},12851:(e,t,i)=>{i.d(t,{i:()=>d,v:()=>u});var r=i(90576),n=i(96631),s=i(59396),a=i(54983),o=i(4365),l=i(24470),c=i(40890),h=i(64871);class u extends c.M{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class d extends l.y{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new u,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new a.I9(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&o.h.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(s.R.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&o.h.AnisotropicTextureEnabled?(0,h.YT)(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(this._texture&&o.h.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),(0,h.mA)(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&o.h.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),void 0===e.legacy&&(this.legacy=!0)}}(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isEnabled",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"intensity",void 0),(0,r.Cg)([(0,n.WM)()],d.prototype,"direction",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"texture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],d.prototype,"legacy",void 0)},98152:(e,t,i)=>{i.d(t,{j:()=>l});var r=i(90576),n=i(96631),s=i(40890),a=i(24470);class o extends s.M{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class l extends a.y{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new o,t),this._useEnergyConservation=l.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=l.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=l.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=l.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=l.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=l.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=l.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=l.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}l.DEFAULT_USE_ENERGY_CONSERVATION=!0,l.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,l.DEFAULT_USE_SPHERICAL_HARMONICS=!0,l.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useEnergyConservation",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useSmithVisibilityHeightCorrelated",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useSphericalHarmonics",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useSpecularGlossinessInputEnergyConservation",void 0)},17062:(e,t,i)=>{i.d(t,{d:()=>N,g:()=>O});var r=i(90576),n=i(96631),s=i(70461),a=i(94975),o=i(71689),l=i(86521),c=i(54983),h=i(59396),u=i(98152),d=i(20943),p=i(39341),f=i(53005),m=i(93803),_=i(40890),g=i(48248),v=i(23077),S=i(4365),x=(i(45688),i(64769)),T=i(51242),E=i(3468),C=i(12851),b=i(81791),P=i(76669),y=i(15949),A=i(66384),R=i(64871),I=i(79130);const M={effect:null,subMesh:null};class O extends _.M{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.IBL_CDF_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class N extends g.E{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}constructor(e,t,i=!1){super(e,t,void 0,i||N.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new c.IU(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=N.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=p.v9.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new p.v9(0,0,0),this._albedoColor=new p.v9(1,1,1),this._reflectivityColor=new p.v9(1,1,1),this._reflectionColor=new p.v9(1,1,1),this._emissiveColor=new p.v9(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=N.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new a.L(16),this._globalAmbientColor=new p.v9(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new u.j(this),this.clearCoat=new T.t(this),this.iridescence=new E.z(this),this.anisotropy=new C.i(this),this.sheen=new b.C(this),this.subSurface=new P.I(this),this.detailMap=new y.c(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),S.h.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=(0,o.X)(this.getScene()),this.prePassConfiguration=new d.J}get hasRenderTargetTextures(){return!!(S.h.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){return this._transparencyMode===N.PBRMATERIAL_OPAQUE||this._transparencyMode===N.PBRMATERIAL_ALPHATEST||this.subSurface?.disableAlphaBlending}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){return!!this._forceAlphaTest||!this.subSurface?.disableAlphaBlending&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===N.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==N.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new O(this._eventInfo.defineNames));const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=this.getScene(),o=a.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&S.h.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&S.h.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&S.h.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const e=this._getReflectionTexture();if(e&&S.h.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!e.sphericalPolynomial&&e.getInternalTexture()?._sphericalPolynomialPromise)return!1}if(this._lightmapTexture&&S.h.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&S.h.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(S.h.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return!1;if(this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&S.h.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;if(this._environmentBRDFTexture&&S.h.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;o.getCaps().standardDerivatives||e.isVerticesDataPresent(h.R.NormalKind)||(e.createNormals(!0),s.V.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=n._areLightsDisposed;let u=this._prepareEffect(e,n,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),d=!1;if(u)if(this._onEffectCreatedObservable&&(M.effect=u,M.subMesh=t,this._onEffectCreatedObservable.notifyObservers(M)),this.allowShaderHotSwapping&&l&&!u.isReady()){if(u=l,n.markAsUnprocessed(),d=this.isFrozen,c)return n._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(u,n,this._materialContext);return!(!t.effect||!t.effect.isReady()||(n._renderId=a.getRenderId(),r._wasPreviouslyReady=!d,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,r=null,n=null,s=null,a=null,o){if(this._prepareDefines(e,t,s,a,o),!t.isDirty)return null;t.markAsProcessed();const l=this.getScene().getEngine(),c=new x.J;let u=0;t.USESPHERICALINVERTEX&&c.addFallback(u++,"USESPHERICALINVERTEX"),t.FOG&&c.addFallback(u,"FOG"),t.SPECULARAA&&c.addFallback(u,"SPECULARAA"),t.POINTSIZE&&c.addFallback(u,"POINTSIZE"),t.LOGARITHMICDEPTH&&c.addFallback(u,"LOGARITHMICDEPTH"),t.PARALLAX&&c.addFallback(u,"PARALLAX"),t.PARALLAX_RHS&&c.addFallback(u,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&c.addFallback(u++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&c.addFallback(u++,"ENVIRONMENTBRDF"),t.TANGENT&&c.addFallback(u++,"TANGENT"),t.BUMP&&c.addFallback(u++,"BUMP"),u=(0,R.c4)(t,c,this._maxSimultaneousLights,u++),t.SPECULARTERM&&c.addFallback(u++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&c.addFallback(u++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&c.addFallback(u++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&c.addFallback(u++,"LIGHTMAP"),t.NORMAL&&c.addFallback(u++,"NORMAL"),t.AMBIENT&&c.addFallback(u++,"AMBIENT"),t.EMISSIVE&&c.addFallback(u++,"EMISSIVE"),t.VERTEXCOLOR&&c.addFallback(u++,"VERTEXCOLOR"),t.MORPHTARGETS&&c.addFallback(u++,"MORPHTARGETS"),t.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");const p=[h.R.PositionKind];t.NORMAL&&p.push(h.R.NormalKind),t.TANGENT&&p.push(h.R.TangentKind);for(let e=1;e<=6;++e)t["UV"+e]&&p.push(`uv${1===e?"":e}`);t.VERTEXCOLOR&&p.push(h.R.ColorKind),(0,R.ni)(p,e,t,c),(0,R.ER)(p,t),(0,R.IF)(p,e,t),(0,R.J2)(p,e,t);let m="pbr";const _=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],g=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","icdfxSampler","icdfySampler"],v=["Material","Scene","Mesh"],S={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=u,this._eventInfo.defines=t,this._eventInfo.uniforms=_,this._eventInfo.attributes=p,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=v,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=S,this._callbackPluginEventGeneric(128,this._eventInfo),I.m.AddUniformsAndSamplers(_,g),d.J.AddUniforms(_),d.J.AddSamplers(g),(0,A.TV)(_),f.p&&(f.p.PrepareUniforms(_,t),f.p.PrepareSamplers(g,t)),(0,R.Bb)({uniformsNames:_,uniformBuffersNames:v,samplers:g,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const T={};this.customShaderNameResolve&&(m=this.customShaderNameResolve(m,_,v,g,t,p,T));const E=t.toString(),C=l.createEffect(m,{attributes:p,uniformsNames:_,uniformBuffersNames:v,samplers:g,defines:E,fallbacks:c,onCompiled:r,onError:n,indexParameters:S,processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,46602)),Promise.resolve().then(i.bind(i,21800))]):await Promise.all([Promise.resolve().then(i.bind(i,78979)),Promise.resolve().then(i.bind(i,85773))]),this._shadersLoaded=!0}},l);return this._eventInfo.customCode=void 0,C}_prepareDefines(e,t,i=null,r=null,n=!1){const s=this.getScene(),a=s.getEngine();(0,R.az)(s,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,(0,R.VO)(s,t);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if((0,R.N4)(s,t,this.canRenderToMRT&&!o),(0,R.Nc)(s,t,o),I.m.PrepareDefines(a.currentRenderPassId,e,t),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let e=1;e<=6;++e)t["MAINUV"+e]=!1;if(s.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&S.h.DiffuseTextureEnabled?((0,R.YT)(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&S.h.AmbientTextureEnabled?((0,R.YT)(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&S.h.OpacityTextureEnabled?((0,R.YT)(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const e=this._getReflectionTexture();if(e&&S.h.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=e.gammaSpace,t.RGBDREFLECTION=e.isRGBD,t.LODINREFLECTIONALPHA=e.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=e.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0,this.getScene().iblCdfGenerator&&(t.IBL_CDF_FILTERING=!0)):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=e.coordinatesMode===v.g.INVCUBIC_MODE,t.REFLECTIONMAP_3D=e.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.coordinatesMode){case v.g.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case v.g.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case v.g.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case v.g.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case v.g.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case v.g.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case v.g.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case v.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case v.g.CUBIC_MODE:case v.g.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!e.boundingBoxSize}e.coordinatesMode!==v.g.SKYBOX_MODE&&(e.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):e.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&S.h.LightmapTextureEnabled?((0,R.YT)(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&S.h.EmissiveTextureEnabled?((0,R.YT)(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,S.h.SpecularTextureEnabled?(this._metallicTexture?((0,R.YT)(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?((0,R.YT)(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?((0,R.YT)(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?((0,R.YT)(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?(0,R.YT)(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),a.getCaps().standardDerivatives&&this._bumpTexture&&S.h.BumpTextureEnabled&&!this._disableBumpMap?((0,R.YT)(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&S.h.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=s.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&S.h.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===N.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===N.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&((0,R.fm)(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(h.R.NormalKind),t.DEBUGMODE=this._debugMode),(0,R.OR)(s,a,this,t,!!i,r,n),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),(0,R.qB)(e,t,!0,!0,!0,this._transparencyMode!==N.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const i=new O(this._eventInfo.defineNames),n=this._prepareEffect(e,i,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(M.effect=n,M.subMesh=null,this._onEffectCreatedObservable.notifyObservers(M)),n.isReady()?t&&t(this):n.onCompileObservable.add((()=>{t&&t(this)}))})()}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.materialDefines;if(!n)return;const s=i.effect;if(!s)return;this._activeEffect=s,t.getMeshUniformBuffer().bindToEffect(s,"Mesh"),t.transferToEffect(e);const a=r.getEngine();this._uniformBuffer.bindToEffect(s,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),I.m.Bind(a.currentRenderPassId,this._activeEffect,t,e),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const o=this._mustRebind(r,s,i,t.visibility);(0,R.f$)(t,this._activeEffect,this.prePassConfiguration);let c=null;const h=this._uniformBuffer;if(o){if(this.bindViewProjection(s),c=this._getReflectionTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){if(this._albedoTexture&&S.h.DiffuseTextureEnabled&&(h.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),(0,R.mA)(this._albedoTexture,h,"albedo")),this._ambientTexture&&S.h.AmbientTextureEnabled&&(h.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),(0,R.mA)(this._ambientTexture,h,"ambient")),this._opacityTexture&&S.h.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),(0,R.mA)(this._opacityTexture,h,"opacity")),c&&S.h.ReflectionTextureEnabled){if(h.updateMatrix("reflectionMatrix",c.getReflectionTextureMatrix()),h.updateFloat2("vReflectionInfos",c.level,0),c.boundingBoxSize){const e=c;h.updateVector3("vReflectionPosition",e.boundingBoxPosition),h.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this.realTimeFiltering){const e=c.getSize().width;h.updateFloat2("vReflectionFilteringInfo",e,Math.log2(e))}if(!n.USEIRRADIANCEMAP){const e=c.sphericalPolynomial;if(n.USESPHERICALFROMREFLECTIONMAP&&e)if(n.SPHERICAL_HARMONICS){const t=e.preScaledHarmonics;h.updateVector3("vSphericalL00",t.l00),h.updateVector3("vSphericalL1_1",t.l1_1),h.updateVector3("vSphericalL10",t.l10),h.updateVector3("vSphericalL11",t.l11),h.updateVector3("vSphericalL2_2",t.l2_2),h.updateVector3("vSphericalL2_1",t.l2_1),h.updateVector3("vSphericalL20",t.l20),h.updateVector3("vSphericalL21",t.l21),h.updateVector3("vSphericalL22",t.l22)}else h.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),h.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),h.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),h.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),h.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),h.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),h.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),h.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),h.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}h.updateFloat3("vReflectionMicrosurfaceInfos",c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset)}this._emissiveTexture&&S.h.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),(0,R.mA)(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&S.h.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),(0,R.mA)(this._lightmapTexture,h,"lightmap")),S.h.SpecularTextureEnabled&&(this._metallicTexture?(h.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),(0,R.mA)(this._metallicTexture,h,"reflectivity")):this._reflectivityTexture&&(h.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),(0,R.mA)(this._reflectivityTexture,h,"reflectivity")),this._metallicReflectanceTexture&&(h.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),(0,R.mA)(this._metallicReflectanceTexture,h,"metallicReflectance")),this._reflectanceTexture&&n.REFLECTANCE&&(h.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),(0,R.mA)(this._reflectanceTexture,h,"reflectance")),this._microSurfaceTexture&&(h.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),(0,R.mA)(this._microSurfaceTexture,h,"microSurfaceSampler"))),this._bumpTexture&&a.getCaps().standardDerivatives&&S.h.BumpTextureEnabled&&!this._disableBumpMap&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),(0,R.mA)(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.METALLICWORKFLOW){p.IG.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,p.IG.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,h.updateColor4("vReflectivityColor",p.IG.Color3[0],1);const e=this.subSurface?._indexOfRefraction??1.5,t=1,i=Math.pow((e-t)/(e+t),2);this._metallicReflectanceColor.scaleToRef(i*this._metallicF0Factor,p.IG.Color3[0]);const r=this._metallicF0Factor;h.updateColor4("vMetallicReflectanceFactors",p.IG.Color3[0],r)}else h.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);h.updateColor3("vEmissiveColor",S.h.EmissiveTextureEnabled?this._emissiveColor:p.v9.BlackReadOnly),h.updateColor3("vReflectionColor",this._reflectionColor),!n.SS_REFRACTION&&this.subSurface?._linkRefractionWithTransparency?h.updateColor4("vAlbedoColor",this._albedoColor,1):h.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,h.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}if(r.texturesEnabled){if(this._albedoTexture&&S.h.DiffuseTextureEnabled&&h.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&S.h.AmbientTextureEnabled&&h.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&S.h.OpacityTextureEnabled&&h.setTexture("opacitySampler",this._opacityTexture),c&&S.h.ReflectionTextureEnabled){n.LODBASEDMICROSFURACE?h.setTexture("reflectionSampler",c):(h.setTexture("reflectionSampler",c._lodTextureMid||c),h.setTexture("reflectionSamplerLow",c._lodTextureLow||c),h.setTexture("reflectionSamplerHigh",c._lodTextureHigh||c)),n.USEIRRADIANCEMAP&&h.setTexture("irradianceSampler",c.irradianceTexture);const e=this.getScene().iblCdfGenerator;this.realTimeFiltering&&e&&(h.setTexture("icdfxSampler",e.getIcdfxTexture()),h.setTexture("icdfySampler",e.getIcdfyTexture()))}n.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&S.h.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&S.h.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this._lightmapTexture),S.h.SpecularTextureEnabled&&(this._metallicTexture?h.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&h.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&h.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&n.REFLECTANCE&&h.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&h.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&a.getCaps().standardDerivatives&&S.h.BumpTextureEnabled&&!this._disableBumpMap&&h.setTexture("bumpSampler",this._bumpTexture)}this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(s),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),(0,A.gS)(this._activeEffect,this,r),this.bindEyePosition(s)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!o&&this.isFrozen||(r.lightsEnabled&&!this._disableLighting&&(0,R.RL)(r,t,this._activeEffect,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==l.Z.FOGMODE_NONE||c||this.subSurface.refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(s),(0,R.Yy)(r,t,this._activeEffect,!0),n.NUM_MORPH_INFLUENCERS&&(0,R.nR)(t,this._activeEffect),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(s,n.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),(0,R.DL)(n,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e}setPrePassRenderer(){if(!this.subSurface?.isScatteringEnabled)return!1;const e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._albedoTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._metallicTexture?.dispose(),this._reflectivityTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._metallicReflectanceTexture?.dispose(),this._reflectanceTexture?.dispose(),this._microSurfaceTexture?.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}N.PBRMATERIAL_OPAQUE=m.i.MATERIAL_OPAQUE,N.PBRMATERIAL_ALPHATEST=m.i.MATERIAL_ALPHATEST,N.PBRMATERIAL_ALPHABLEND=m.i.MATERIAL_ALPHABLEND,N.PBRMATERIAL_ALPHATESTANDBLEND=m.i.MATERIAL_ALPHATESTANDBLEND,N.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,N.LIGHTFALLOFF_PHYSICAL=0,N.LIGHTFALLOFF_GLTF=1,N.LIGHTFALLOFF_STANDARD=2,N.ForceGLSL=!1,(0,r.Cg)([(0,n.n1)()],N.prototype,"_imageProcessingConfiguration",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsMiscDirty")],N.prototype,"debugMode",void 0)},51242:(e,t,i)=>{i.d(t,{a:()=>h,t:()=>u});var r=i(90576),n=i(96631),s=i(39341),a=i(4365),o=i(24470),l=i(40890),c=i(64871);class h extends l.M{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class u extends o.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new h,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=u._DefaultIndexOfRefraction,this.indexOfRefraction=u._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=s.v9.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const r=this._material._disableBumpMap;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&a.h.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&a.h.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1;if(i.getCaps().standardDerivatives&&this._bumpTexture&&a.h.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady())return!1;if(this._isTintEnabled&&this._tintTexture&&a.h.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&a.h.ClearCoatTextureEnabled?(0,c.YT)(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&a.h.ClearCoatTextureEnabled?(0,c.YT)(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&a.h.ClearCoatBumpTextureEnabled?(0,c.YT)(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===u._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&a.h.ClearCoatTintTextureEnabled?((0,c.YT)(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;const n=r.materialDefines,s=this._material.isFrozen,o=this._material._disableBumpMap,l=this._material._invertNormalMapX,h=this._material._invertNormalMapY;if(!e.useUbo||!s||!e.isSync){(this._texture||this._textureRoughness)&&a.h.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&(0,c.mA)(this._texture,e,"clearCoat"),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&(0,c.mA)(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&a.h.ClearCoatTextureEnabled&&!o&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),(0,c.mA)(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,h?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,h?-1:1)),this._tintTexture&&a.h.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),(0,c.mA)(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const r=1-this._indexOfRefraction,s=1+this._indexOfRefraction,u=Math.pow(-r/s,2),d=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",u,d,r,s),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&a.h.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&a.h.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&a.h.ClearCoatBumpTextureEnabled&&!o&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&a.h.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose(),this._bumpTexture?.dispose(),this._tintTexture?.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}u._DefaultIndexOfRefraction=1.5,(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"isEnabled",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"intensity",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"roughness",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"indexOfRefraction",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"texture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRoughnessFromMainTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"textureRoughness",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"remapF0OnInterfaceChange",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"bumpTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"isTintEnabled",void 0),(0,r.Cg)([(0,n.jT)()],u.prototype,"tintColor",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"tintColorAtDistance",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"tintThickness",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"tintTexture",void 0)},3468:(e,t,i)=>{i.d(t,{m:()=>c,z:()=>h});var r=i(90576),n=i(96631),s=i(4365),a=i(24470),o=i(40890),l=i(64871);class c extends o.M{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class h extends a.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new c,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=h._DefaultMinimumThickness,this.maximumThickness=h._DefaultMaximumThickness,this.indexOfRefraction=h._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&s.h.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._thicknessTexture&&s.h.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&s.h.IridescenceTextureEnabled?(0,l.YT)(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&s.h.IridescenceTextureEnabled?(0,l.YT)(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||((this._texture||this._thicknessTexture)&&s.h.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._thicknessTexture?.coordinatesIndex??0,this._thicknessTexture?.level??0),this._texture&&(0,l.mA)(this._texture,e,"iridescence"),this._thicknessTexture&&(0,l.mA)(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&s.h.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&s.h.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){e&&(this._texture?.dispose(),this._thicknessTexture?.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}h._DefaultMinimumThickness=100,h._DefaultMaximumThickness=400,h._DefaultIndexOfRefraction=1.3,(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"isEnabled",void 0),(0,r.Cg)([(0,n.lK)()],h.prototype,"intensity",void 0),(0,r.Cg)([(0,n.lK)()],h.prototype,"minimumThickness",void 0),(0,r.Cg)([(0,n.lK)()],h.prototype,"maximumThickness",void 0),(0,r.Cg)([(0,n.lK)()],h.prototype,"indexOfRefraction",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"texture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"thicknessTexture",void 0)},13979:(e,t,i)=>{i.d(t,{Y:()=>u});var r=i(90576),n=i(96631),s=i(71689),a=i(39341),o=i(17062),l=i(88252),c=i(93803),h=i(16265);class u extends o.d{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===o.d.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?o.d.LIGHTFALLOFF_PHYSICAL:o.d.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===o.d.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?o.d.LIGHTFALLOFF_GLTF:o.d.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=u.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=a.v9.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new a.v9(0,0,0),this.albedoColor=new a.v9(1,1,1),this.reflectivityColor=new a.v9(1,1,1),this.reflectionColor=new a.v9(1,1,1),this.emissiveColor=new a.v9(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=(0,s.X)(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const r=h.p.Clone((()=>new u(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const r=h.p.Parse((()=>new u(e.name,t)),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),c.i._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}u.PBRMATERIAL_OPAQUE=o.d.PBRMATERIAL_OPAQUE,u.PBRMATERIAL_ALPHATEST=o.d.PBRMATERIAL_ALPHATEST,u.PBRMATERIAL_ALPHABLEND=o.d.PBRMATERIAL_ALPHABLEND,u.PBRMATERIAL_ALPHATESTANDBLEND=o.d.PBRMATERIAL_ALPHATESTANDBLEND,u.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=o.d.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"directIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"emissiveIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"environmentIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"specularIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"disableBumpMap",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"albedoTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientTextureStrength",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"opacityTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectionTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"emissiveTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectivityTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallic",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"roughness",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicF0Factor",void 0),(0,r.Cg)([(0,n.jT)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicReflectanceColor",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicReflectanceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectanceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"microSurfaceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"bumpTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty",null)],u.prototype,"lightmapTexture",void 0),(0,r.Cg)([(0,n.jT)("ambient"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientColor",void 0),(0,r.Cg)([(0,n.jT)("albedo"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"albedoColor",void 0),(0,r.Cg)([(0,n.jT)("reflectivity"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectivityColor",void 0),(0,r.Cg)([(0,n.jT)("reflection"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectionColor",void 0),(0,r.Cg)([(0,n.jT)("emissive"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"emissiveColor",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"microSurface",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useLightmapAsShadowmap",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"useAlphaFromAlbedoTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"forceAlphaTest",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"alphaCutOff",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useSpecularOverAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRoughnessFromMetallicTextureGreen",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useMetallnessFromMetallicTextureBlue",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAmbientInGrayScale",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"usePhysicalLightFalloff",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"useGLTFLightFalloff",null),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRadianceOverAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useObjectSpaceNormalMap",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useParallax",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useParallaxOcclusion",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"parallaxScaleBias",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsLightsDirty")],u.prototype,"disableLighting",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"forceIrradianceInFragment",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsLightsDirty")],u.prototype,"maxSimultaneousLights",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"invertNormalMapX",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"invertNormalMapY",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"twoSidedLighting",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAlphaFresnel",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useLinearAlphaFresnel",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"environmentBRDFTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"forceNormalForward",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"enableSpecularAntiAliasing",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useHorizonOcclusion",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRadianceOcclusion",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],u.prototype,"unlit",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],u.prototype,"applyDecalMapAfterDetailMap",void 0),(0,l.Y5)("BABYLON.PBRMaterial",u)},81791:(e,t,i)=>{i.d(t,{C:()=>u,Z:()=>h});var r=i(90576),n=i(96631),s=i(39341),a=i(4365),o=i(24470),l=i(40890),c=i(64871);class h extends l.M{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class u extends o.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new h,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=s.v9.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&a.h.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&a.h.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&a.h.SheenTextureEnabled?((0,c.YT)(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&a.h.SheenTextureEnabled?(0,c.YT)(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;const n=r.materialDefines,s=this._material.isFrozen;e.useUbo&&s&&e.isSync||((this._texture||this._textureRoughness)&&a.h.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&(0,c.mA)(this._texture,e,"sheen"),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&(0,c.mA)(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&a.h.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&a.h.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"isEnabled",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"linkSheenWithAlbedo",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"intensity",void 0),(0,r.Cg)([(0,n.jT)()],u.prototype,"color",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"texture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRoughnessFromMainTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"roughness",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"textureRoughness",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"albedoScaling",void 0)},76669:(e,t,i)=>{i.d(t,{I:()=>d,p:()=>u});var r=i(90576),n=i(96631),s=i(39341),a=i(4365),o=i(54983),l=i(24470),c=i(40890),h=i(64871);class u extends c.M{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}}class d extends l.y{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new u,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=s.v9.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=s.v9.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&a.h.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;if(this._translucencyColorTexture&&a.h.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking())return!1;if(this._translucencyIntensityTexture&&a.h.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;const e=this._getRefractionTexture(t);if(e&&a.h.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,void(e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0);if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&a.h.ThicknessTextureEnabled&&(0,h.YT)(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&a.h.RefractionIntensityTextureEnabled&&(0,h.YT)(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&a.h.TranslucencyIntensityTextureEnabled&&(0,h.YT)(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&a.h.TranslucencyColorTextureEnabled&&(0,h.YT)(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&a.h.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)if(0===this.maximumThickness&&0===this.minimumThickness)e.updateFloat2("vThicknessParam",0,0);else{r.getRenderingMesh().getWorldMatrix().decompose(o.AA.Vector3[0]);const t=Math.max(Math.abs(o.AA.Vector3[0].x),Math.abs(o.AA.Vector3[0].y),Math.abs(o.AA.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*t,(this.maximumThickness-this.minimumThickness)*t)}}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const n=r.materialDefines,s=this._material.isFrozen,o=this._material.realTimeFiltering,l=n.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!s||!e.isSync){if(this._thicknessTexture&&a.h.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),(0,h.mA)(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&a.h.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),(0,h.mA)(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&a.h.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),(0,h.mA)(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&a.h.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),(0,h.mA)(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&a.h.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let t=1;c.isCube||c.depth&&(t=c.depth);const i=c.getSize().width,r=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/r,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",i,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",i,Math.log2(i)),c.boundingBoxSize){const t=c;e.updateVector3("vRefractionPosition",t.boundingBoxPosition),e.updateVector3("vRefractionSize",t.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&a.h.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&a.h.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&a.h.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&a.h.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&a.h.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){a.h.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(a.h.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isRefractionEnabled",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isTranslucencyEnabled",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isDispersionEnabled",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markScenePrePassDirty")],d.prototype,"isScatteringEnabled",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"_scatteringDiffusionProfileIndex",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"refractionIntensity",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"translucencyIntensity",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"useAlbedoToTintRefraction",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"useAlbedoToTintTranslucency",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"thicknessTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"refractionTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"indexOfRefraction",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"_volumeIndexOfRefraction",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"volumeIndexOfRefraction",null),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"invertRefractionY",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"linkRefractionWithTransparency",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"minimumThickness",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"maximumThickness",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"useThicknessAsDepth",void 0),(0,r.Cg)([(0,n.jT)()],d.prototype,"tintColor",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"tintColorAtDistance",void 0),(0,r.Cg)([(0,n.lK)()],d.prototype,"dispersion",void 0),(0,r.Cg)([(0,n.jT)()],d.prototype,"diffusionDistance",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"useMaskFromThicknessTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"refractionIntensityTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"translucencyIntensityTexture",void 0),(0,r.Cg)([(0,n.jT)()],d.prototype,"translucencyColor",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"translucencyColorTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"useGltfStyleTextures",void 0)},62158:(e,t,i)=>{i.r(t),i.d(t,{_DDSTextureLoader:()=>s});var r=i(47369),n=i(83404);class s{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,s){const a=t.getEngine();let o,l=!1,c=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){const r=e[i];o=n.DDSTools.GetDDSInfo(r),t.width=o.width,t.height=o.height,l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(o.isCompressed),n.DDSTools.UploadDDSLevels(a,t,r,o,l,6,-1,i),o.isFourCC||1!==o.mipmapCount?c=o.mipmapCount-1:a.generateMipMapsForCubemap(t)}else{const s=e;o=n.DDSTools.GetDDSInfo(s),t.width=o.width,t.height=o.height,i&&(o.sphericalPolynomial=new r.Q),l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(o.isCompressed),n.DDSTools.UploadDDSLevels(a,t,s,o,l,6),o.isFourCC||1!==o.mipmapCount?c=o.mipmapCount-1:a.generateMipMapsForCubemap(t,!1)}a._setCubeMapTextureParams(t,l,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:o,data:e,texture:t})}loadData(e,t,i){const r=n.DDSTools.GetDDSInfo(e),s=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&Math.max(r.width,r.height)>>r.mipmapCount-1==1;i(r.width,r.height,s,r.isFourCC,(()=>{n.DDSTools.UploadDDSLevels(t.getEngine(),t,e,r,s,1)}))}}},76075:(e,t,i)=>{i.r(t),i.d(t,{_HDRTextureLoader:()=>n});var r=i(60554);class n{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=(0,r.NK)(n),a=(0,r.LT)(n,s),o=s.width*s.height,l=new Float32Array(4*o);for(let e=0;e<o;e+=1)l[4*e]=a[3*e],l[4*e+1]=a[3*e+1],l[4*e+2]=a[3*e+2],l[4*e+3]=1;i(s.width,s.height,t.generateMipMaps,!1,(()=>{const e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,l)}))}}},99229:(e,t,i)=>{i.r(t),i.d(t,{_TGATextureLoader:()=>n});var r=i(63665);class n{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),s=(0,r.O_)(n);i(s.width,s.height,t.generateMipMaps,!1,(()=>{(0,r.FA)(t,n)}))}}},30338:(e,t,i)=>{i.d(t,{b:()=>d});var r=i(90576),n=i(96631),s=i(90066),a=i(54983),o=i(85682),l=i(23077),c=i(88252),h=i(6740),u=i(16265);i(7191);class d extends o.t{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(a.uq.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach((e=>r+=e)),new d(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){const n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const s=new d(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=n,s}constructor(e,t,i=null,r=!1,n=null,s=null,o=null,c=5,u=!1,d=null,p=!1,f=.8,m=0,_,g){super(t),this.onLoadObservable=new h.cP,this.boundingBoxPosition=a.Pq.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new a.uq,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=a.uq.Identity(),this.coordinatesMode=l.g.CUBIC_MODE;let v=null,S=null;null===i||Array.isArray(i)?(this._noMipmap=r,this._format=c,this._createPolynomials=p,v=i,this._loaderOptions=_,this._useSRGBBuffer=g,this._lodScale=f,this._lodOffset=m):(v=i.extensions??null,this._noMipmap=i.noMipmap??!1,n=i.files??null,S=i.buffer??null,this._format=i.format??5,u=i.prefiltered??!1,d=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??.8,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,s=i.onLoad??null,o=i.onError??null),(e||n)&&this.updateURL(e,d,s,u,o,v,this.getScene()?.useDelayedTextureLoading,n,S)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,n=null,s=null,a=!1,o=null,l=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,t&&(this._forcedExtension=t);const c=e.lastIndexOf("."),h=t||(c>-1?e.substring(c).toLowerCase():""),u=0===h.indexOf(".dds"),d=0===h.indexOf(".env"),p=0===h.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),o)this._files=o;else if(p||d||u||s||(s=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,s){for(let t=0;t<s.length;t++)this._files.push(e+s[t]);this._extensions=s}this._buffer=l,a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this))),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem)return;const t=a.AA.Vector3[0],i=a.AA.Quaternion[0],r=a.AA.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,a.uq.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){const i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const n=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},a=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),l.g.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?s.S0.SetImmediate((()=>n())):this._texture.onLoadedObservable.add((()=>n())):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))))}static Parse(e,t,i){const r=u.p.Parse((()=>{let r=!1;return e.prefiltered&&(r=e.prefiltered),new d(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=a.Pq.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=a.Pq.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=(0,c.n9)("BABYLON.Animation");n&&r.animations.push(n.Parse(i))}return r}clone(){let e=0;const t=u.p.Clone((()=>{const t=new d(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t}),this);return t.uniqueId=e,t}}(0,r.Cg)([(0,n.lK)()],d.prototype,"url",void 0),(0,r.Cg)([(0,n.P_)()],d.prototype,"boundingBoxPosition",void 0),(0,r.Cg)([(0,n.P_)()],d.prototype,"boundingBoxSize",null),(0,r.Cg)([(0,n.lK)("rotationY")],d.prototype,"rotationY",null),(0,r.Cg)([(0,n.lK)("files")],d.prototype,"_files",void 0),(0,r.Cg)([(0,n.lK)("forcedExtension")],d.prototype,"_forcedExtension",void 0),(0,r.Cg)([(0,n.lK)("extensions")],d.prototype,"_extensions",void 0),(0,r.Cg)([(0,n.GG)("textureMatrix")],d.prototype,"_textureMatrix",void 0),(0,r.Cg)([(0,n.GG)("textureMatrixRefraction")],d.prototype,"_textureMatrixRefraction",void 0),l.g._CubeTextureParser=d.Parse,(0,c.Y5)("BABYLON.CubeTexture",d)},41e3:(e,t,i)=>{i.d(t,{R:()=>s});var r=i(70461),n=i(23077);i(81499);class s extends n.g{constructor(e,t,i,r=!1,s=3,a=5,o){const l=!i||i._isScene;super(null,l?i:i?.scene,l?!r:i,o,s,void 0,void 0,void 0,void 0,a),this.name=e,this.wrapU=n.g.CLAMP_ADDRESSMODE,this.wrapV=n.g.CLAMP_ADDRESSMODE,this._generateMipMaps=r;const c=this._getEngine();if(!c)return;if(t.getContext)this._canvas=t,this._ownCanvas=!1,this._texture=c.createDynamicTexture(this._canvas.width,this._canvas.height,r,s);else{this._canvas=c.createCanvas(1,1),this._ownCanvas=!0;const e=t;e.width||0===e.width?this._texture=c.createDynamicTexture(e.width,e.height,r,s):this._texture=c.createDynamicTexture(t,t,r,s)}const h=this.getSize();this._canvas.width!==h.width&&(this._canvas.width=h.width),this._canvas.height!==h.height&&(this._canvas.height=h.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){const t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,n,s,a,o=!0){const l=this.getSize();if(s&&(this._context.fillStyle=s,this._context.fillRect(0,0,l.width,l.height)),this._context.font=r,null==t){const i=this._context.measureText(e);t=(l.width-i.width)/2}if(null==i){const e=parseInt(r.replace(/\D/g,""));i=l.height/2+e/3.65}this._context.fillStyle=n||"",this._context.fillText(e,t,i),o&&this.update(a)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new s(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&r.V.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return s._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}},43250:(e,t,i)=>{i.d(t,{p:()=>a});var r=i(16265),n=i(82942),s=i(30338);class a extends s.b{constructor(e,t,i,r=5,n=0,s=!1,a=!1,o=3,l=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,n,s,a,o,l)}update(e,t,i,r,n=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,n)}updateRGBDAsync(e,t=null,i=.8,r=0){return(0,n.gW)(this._texture,e,t,i,r).then((()=>{}))}clone(){return r.p.Clone((()=>{const e=this.getScene(),t=this._texture,i=new a(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return 13===t.source&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i}),this)}}},18645:(e,t,i)=>{i.d(t,{I:()=>n});var r=i(23077);class n extends r.g{constructor(e,t,i,n,s,a=!0,o=!1,l=3,c=0,h,u){super(null,s,!a,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=n,this._engine&&(this._engine._caps.textureFloatLinearFiltering||1!==c||(l=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==c||(l=1),this._texture=this._engine.createRawTexture(e,t,i,n,a,o,l,null,c,h??0,u??!1),this.wrapU=r.g.CLAMP_ADDRESSMODE,this.wrapV=r.g.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}clone(){if(!this._texture)return super.clone();const e=new n(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}static CreateLuminanceTexture(e,t,i,r,s=!0,a=!1,o=3){return new n(e,t,i,1,r,s,a,o)}static CreateLuminanceAlphaTexture(e,t,i,r,s=!0,a=!1,o=3){return new n(e,t,i,2,r,s,a,o)}static CreateAlphaTexture(e,t,i,r,s=!0,a=!1,o=3){return new n(e,t,i,0,r,s,a,o)}static CreateRGBTexture(e,t,i,r,s=!0,a=!1,o=3,l=0,c=0,h=!1){return new n(e,t,i,4,r,s,a,o,l,c,h)}static CreateRGBATexture(e,t,i,r,s=!0,a=!1,o=3,l=0,c=0,h=!1){return new n(e,t,i,5,r,s,a,o,l,c,h)}static CreateRGBAStorageTexture(e,t,i,r,s=!0,a=!1,o=3,l=0,c=!1){return new n(e,t,i,5,r,s,a,o,l,1,c)}static CreateRTexture(e,t,i,s,a=!0,o=!1,l=r.g.TRILINEAR_SAMPLINGMODE,c=1){return new n(e,t,i,6,s,a,o,l,c)}static CreateRStorageTexture(e,t,i,s,a=!0,o=!1,l=r.g.TRILINEAR_SAMPLINGMODE,c=1){return new n(e,t,i,6,s,a,o,l,c,1)}}},41930:(e,t,i)=>{i.d(t,{L:()=>n});var r=i(23077);class n extends r.g{get depth(){return this._depth}constructor(e,t,i,n,s,a,o=!0,l=!1,c=r.g.TRILINEAR_SAMPLINGMODE,h=0,u){super(null,a,!o,l),this.format=s,this._texture=a.getEngine().createRawTexture2DArray(e,t,i,n,s,o,l,c,null,h,u),this._depth=n,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,s,a=!0,o=!1,l=3,c=0){return new n(e,t,i,r,5,s,a,o,l,c)}}},87020:(e,t,i)=>{i.d(t,{X:()=>s});var r=i(49111);const n=r.HighestCommonFactor,s={...r,TwoPi:2*Math.PI,Sign:Math.sign,Log2:Math.log2,HCF:n}},86244:(e,t,i)=>{i.d(t,{g:()=>u});var r=i(90066),n=i(78073),s=i(84254),a=i(50004),o=i(33543),l=i(70461);function c(e,t,i,r,n){let s=null,a=null,o=null;try{let l;s=new e.Decoder,a=new e.DecoderBuffer,a.Init(t,t.byteLength);const c=s.GetEncodedGeometryType(a);switch(c){case e.TRIANGULAR_MESH:{const t=new e.Mesh;if(l=s.DecodeBufferToMesh(a,t),!l.ok()||0===t.ptr)throw new Error(l.error_msg());const i=3*t.num_faces(),n=4*i,c=e._malloc(n);try{s.GetTrianglesUInt32Array(t,n,c);const a=new Uint32Array(i);a.set(new Uint32Array(e.HEAPF32.buffer,c,i)),r(a)}finally{e._free(c)}o=t;break}case e.POINT_CLOUD:{const t=new e.PointCloud;if(l=s.DecodeBufferToPointCloud(a,t),!l.ok()||!t.ptr)throw new Error(l.error_msg());o=t;break}default:throw new Error(`Invalid geometry type ${c}`)}const h=o.num_points(),u=(t,i,r,s)=>{const a=s.data_type(),o=s.num_components(),l=s.normalized(),c=s.byte_stride(),u=s.byte_offset(),d={[e.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:e.HEAPF32},[e.DT_INT8]:{typedArrayConstructor:Int8Array,heap:e.HEAP8},[e.DT_INT16]:{typedArrayConstructor:Int16Array,heap:e.HEAP16},[e.DT_INT32]:{typedArrayConstructor:Int32Array,heap:e.HEAP32},[e.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:e.HEAPU8},[e.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:e.HEAPU16},[e.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:e.HEAPU32}}[a];if(!d)throw new Error(`Invalid data type ${a}`);const p=h*o,f=p*d.typedArrayConstructor.BYTES_PER_ELEMENT,m=e._malloc(f);try{t.GetAttributeDataArrayForAllPoints(i,s,a,f,m);const e=new d.typedArrayConstructor(d.heap.buffer,m,p);n(r,e.slice(),o,u,c,l)}finally{e._free(m)}};if(i)for(const e in i){const t=i[e],r=s.GetAttributeByUniqueId(o,t);u(s,o,e,r)}else{const t={position:e.POSITION,normal:e.NORMAL,color:e.COLOR,uv:e.TEX_COORD};for(const e in t){const i=s.GetAttributeId(o,t[e]);if(-1!==i){const t=s.GetAttribute(o,i);u(s,o,e,t)}}}return h}finally{o&&e.destroy(o),a&&e.destroy(a),s&&e.destroy(s)}}function h(){let e;onmessage=t=>{const i=t.data;switch(i.id){case"init":{const t=i.decoder;t.url&&importScripts(t.url);const r=t.wasmBinary?{wasmBinary:t.wasmBinary}:{};e=DracoDecoderModule(r),postMessage({id:"initDone"});break}case"decodeMesh":if(!e)throw new Error("Draco decoder module is not available");e.then((e=>{const t=c(e,i.dataView,i.attributes,(e=>{postMessage({id:"indices",data:e},[e.buffer])}),((e,t,i,r,n,s)=>{postMessage({id:"attribute",kind:e,data:t,size:i,byteOffset:r,byteStride:n,normalized:s},[t.buffer])}));postMessage({id:"decodeMeshDone",totalVertices:t})}))}}}class u{static get DecoderAvailable(){const e=u.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly||e.fallbackUrl)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static get Default(){return u._Default||(u._Default=new u),u._Default}static ResetDefault(e){u._Default&&(e||u._Default.dispose(),u._Default=null)}constructor(e=u.DefaultNumWorkers){const t=u.Configuration.decoder;if(t.workerPool||"object"==typeof e&&e.workerPool)this._workerPoolPromise=Promise.resolve(t.workerPool||e.workerPool);else{const i=t.wasmBinary||"object"==typeof e&&e.wasmBinary,s="number"==typeof e?e:e.numWorkers,a=s&&"function"==typeof Worker&&"function"==typeof URL,o=a||!a&&!t.jsModule,l=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:o?r.S0.GetBabylonScriptURL(t.wasmUrl,!0):"",wasmBinaryPromise:i?Promise.resolve(i):r.S0.LoadFileAsync(r.S0.GetBabylonScriptURL(t.wasmBinaryUrl,!0))}:{url:o?r.S0.GetBabylonScriptURL(t.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};a?this._workerPoolPromise=l.wasmBinaryPromise.then((e=>{const t=`${c}(${h})()`,i=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));return new n.h(s,(()=>function(e,t,i){return new Promise(((r,n)=>{const s=t=>{e.removeEventListener("error",s),e.removeEventListener("message",a),n(t)},a=t=>{"initDone"===t.data.id&&(e.removeEventListener("error",s),e.removeEventListener("message",a),r(e))};if(e.addEventListener("error",s),e.addEventListener("message",a),t){const r=t.slice(0);e.postMessage({id:"init",decoder:{url:i,wasmBinary:r}},[r])}else e.postMessage({id:"init",decoder:{url:i}})}))}(new Worker(i),e,l.url)))})):this._decoderModulePromise=l.wasmBinaryPromise.then((async e=>{if("undefined"==typeof DracoDecoderModule&&!t.jsModule){if(!l.url)throw new Error("Draco decoder module is not available");await r.S0.LoadBabylonScriptAsync(l.url)}return await(i=e,n=t.jsModule,new Promise((e=>{(n||DracoDecoderModule)({wasmBinary:i}).then((t=>{e({module:t})}))})));var i,n}))}}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then((e=>{e.dispose()})),delete this._workerPoolPromise,delete this._decoderModulePromise}async whenReadyAsync(){this._workerPoolPromise?await this._workerPoolPromise:this._decoderModulePromise&&await this._decoderModulePromise}decodeMeshToMeshDataAsync(e,t,i){const r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength);if(this._workerPoolPromise)return this._workerPoolPromise.then((e=>new Promise(((n,s)=>{e.push(((e,a)=>{let o=null;const c=[],h=t=>{e.removeEventListener("error",h),e.removeEventListener("message",u),s(t),a()},u=t=>{const r=t.data;switch(r.id){case"decodeMeshDone":e.removeEventListener("error",h),e.removeEventListener("message",u),n({indices:o,attributes:c,totalVertices:r.totalVertices}),a();break;case"indices":o=r.data;break;case"attribute":c.push({kind:r.kind,data:r.data,size:r.size,byteOffset:r.byteOffset,byteStride:r.byteStride,normalized:(s=r.kind,d=r.normalized,i&&void 0!==i[s]?(d!==i[s]&&l.V.Warn(`Normalized flag from Draco data (${d}) does not match normalized flag from glTF accessor (${i[s]}). Using flag from glTF accessor.`),i[s]):d)})}var s,d};e.addEventListener("error",h),e.addEventListener("message",u);const d=r.slice();e.postMessage({id:"decodeMesh",dataView:d,attributes:t},[d.buffer])}))}))));if(this._decoderModulePromise)return this._decoderModulePromise.then((e=>{let i=null;const n=[],s=c(e.module,r,t,(e=>{i=e}),((e,t,i,r,s,a)=>{n.push({kind:e,data:t,size:i,byteOffset:r,byteStride:s,normalized:a})}));return{indices:i,attributes:n,totalVertices:s}}));throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,i,r){const n=await this.decodeMeshToMeshDataAsync(i,r),o=new s.V(e,t);n.indices&&o.setIndices(n.indices);for(const e of n.attributes)o.setVerticesBuffer(new a.R(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),n.totalVertices);return o}async _decodeMeshToGeometryForGltfAsync(e,t,i,r,n,o){const l=await this.decodeMeshToMeshDataAsync(i,r,n),c=new s.V(e,t);o&&(c._boundingInfo=o,c.useBoundingInfoFromGeometry=!0),l.indices&&c.setIndices(l.indices);for(const e of l.attributes)c.setVerticesBuffer(new a.R(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),l.totalVertices);return c}async decodeMeshAsync(e,t){const i=await this.decodeMeshToMeshDataAsync(e,t),r=new o.P;i.indices&&(r.indices=i.indices);for(const e of i.attributes){const t=a.R.GetFloatData(e.data,e.size,a.R.GetDataType(e.data),e.byteOffset,e.byteStride,e.normalized,i.totalVertices);r.set(t,e.kind)}return r}}u.Configuration={decoder:{wasmUrl:`${r.S0._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${r.S0._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${r.S0._DefaultCdnUrl}/draco_decoder_gltf.js`}},u.DefaultNumWorkers=u.GetDefaultNumWorkers(),u._Default=null},85533:(e,t,i)=>{i.d(t,{v:()=>n});var r=i(90066);class n{static get Default(){return n._Default||(n._Default=new n),n._Default}constructor(){const e=n.Configuration.decoder;this._decoderModulePromise=r.S0.LoadBabylonScriptAsync(e.url).then((()=>MeshoptDecoder.ready))}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,n){return this._decoderModulePromise.then((async()=>{MeshoptDecoder.useWorkers(1);const s=await MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,n);return MeshoptDecoder.useWorkers(0),s}))}}n.Configuration={decoder:{url:`${r.S0._DefaultCdnUrl}/meshopt_decoder.js`}},n._Default=null},80830:(e,t,i)=>{i.d(t,{t:()=>x});var r=i(103),n=i(9191),s=i(33543),a=i(54983),o=i(70461),l=i(92243),c=i(18645),h=i(90066),u=(i(42319),i(89783)),d=i(87020),p=i(60799);const f=(e,t)=>{const i=(1<<t)-1;return(e&i)/i},m=(e,t)=>{t.x=f(e>>>21,11),t.y=f(e>>>11,10),t.z=f(e,11)},_=(e,t)=>{t[0]=255*f(e>>>24,8),t[1]=255*f(e>>>16,8),t[2]=255*f(e>>>8,8),t[3]=255*f(e,8)},g=(e,t)=>{const i=1/(.5*Math.sqrt(2)),r=(f(e>>>20,10)-.5)*i,n=(f(e>>>10,10)-.5)*i,s=(f(e,10)-.5)*i,a=Math.sqrt(1-(r*r+n*n+s*s));switch(e>>>30){case 0:t.set(a,r,n,s);break;case 1:t.set(r,a,n,s);break;case 2:t.set(r,n,a,s);break;case 3:t.set(r,n,s,a)}};var v,S;!function(e){e[e.FLOAT=0]="FLOAT",e[e.INT=1]="INT",e[e.UINT=2]="UINT",e[e.DOUBLE=3]="DOUBLE",e[e.UCHAR=4]="UCHAR",e[e.UNDEFINED=5]="UNDEFINED"}(v||(v={})),function(e){e[e.MIN_X=0]="MIN_X",e[e.MIN_Y=1]="MIN_Y",e[e.MIN_Z=2]="MIN_Z",e[e.MAX_X=3]="MAX_X",e[e.MAX_Y=4]="MAX_Y",e[e.MAX_Z=5]="MAX_Z",e[e.MIN_SCALE_X=6]="MIN_SCALE_X",e[e.MIN_SCALE_Y=7]="MIN_SCALE_Y",e[e.MIN_SCALE_Z=8]="MIN_SCALE_Z",e[e.MAX_SCALE_X=9]="MAX_SCALE_X",e[e.MAX_SCALE_Y=10]="MAX_SCALE_Y",e[e.MAX_SCALE_Z=11]="MAX_SCALE_Z",e[e.PACKED_POSITION=12]="PACKED_POSITION",e[e.PACKED_ROTATION=13]="PACKED_ROTATION",e[e.PACKED_SCALE=14]="PACKED_SCALE",e[e.PACKED_COLOR=15]="PACKED_COLOR",e[e.X=16]="X",e[e.Y=17]="Y",e[e.Z=18]="Z",e[e.SCALE_0=19]="SCALE_0",e[e.SCALE_1=20]="SCALE_1",e[e.SCALE_2=21]="SCALE_2",e[e.DIFFUSE_RED=22]="DIFFUSE_RED",e[e.DIFFUSE_GREEN=23]="DIFFUSE_GREEN",e[e.DIFFUSE_BLUE=24]="DIFFUSE_BLUE",e[e.OPACITY=25]="OPACITY",e[e.F_DC_0=26]="F_DC_0",e[e.F_DC_1=27]="F_DC_1",e[e.F_DC_2=28]="F_DC_2",e[e.F_DC_3=29]="F_DC_3",e[e.ROT_0=30]="ROT_0",e[e.ROT_1=31]="ROT_1",e[e.ROT_2=32]="ROT_2",e[e.ROT_3=33]="ROT_3",e[e.UNDEFINED=34]="UNDEFINED"}(S||(S={}));class x extends n.e{get shDegree(){return this._shDegree}get covariancesATexture(){return this._covariancesATexture}get covariancesBTexture(){return this._covariancesBTexture}get centersTexture(){return this._centersTexture}get colorsTexture(){return this._colorsTexture}get shTextures(){return this._shTextures}set material(e){this._material=e,this._material.backFaceCulling=!0,this._material.cullBackFaces=!1,e.resetDrawCache()}get material(){return this._material}constructor(e,t=null,i=null,n=!1){super(e,i),this._vertexCount=0,this._worker=null,this._frameIdLastUpdate=-1,this._modelViewMatrix=a.uq.Identity(),this._canPostToWorker=!0,this._readyToDisplay=!1,this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._splatPositions=null,this._splatIndex=null,this._shTextures=null,this._covariancesA=null,this._covariancesB=null,this._colors=null,this._sh=null,this._keepInRam=!1,this._delayedTextureUpdate=null,this._oldDirection=new a.Pq,this._useRGBACovariants=!1,this._material=null,this._tmpCovariances=[0,0,0,0,0,0],this._sortIsDirty=!1,this._shDegree=0;const o=new s.P;o.positions=[-3,-2,0,3,-2,0,0,4,0],o.indices=[0,1,2],o.applyToMesh(this),this.subMeshes=[],new r.K(0,0,3,0,3,this),this.setEnabled(!1),this._useRGBACovariants=!this.getEngine().isWebGPU&&1===this.getEngine().version,this._keepInRam=n,t&&this.loadFileAsync(t),this._material=new l.b(this.name+"_material",this._scene)}getClassName(){return"GaussianSplattingMesh"}getTotalVertices(){return this._vertexCount}isReady(e=!1){return!(!super.isReady(e,!0)||!this._readyToDisplay&&(this._postToWorker(!0),1))}_postToWorker(e=!1){const t=this.getScene().getFrameId();if((e||t!==this._frameIdLastUpdate)&&this._worker&&this._scene.activeCamera&&this._canPostToWorker){const i=this._scene.activeCamera.getViewMatrix();this.getWorldMatrix().multiplyToRef(i,this._modelViewMatrix),i.invertToRef(a.AA.Matrix[0]),this.getWorldMatrix().multiplyToRef(a.AA.Matrix[0],a.AA.Matrix[1]),a.Pq.TransformNormalToRef(a.Pq.Forward(this._scene.useRightHandedSystem),a.AA.Matrix[1],a.AA.Vector3[2]),a.AA.Vector3[2].normalize();const r=a.Pq.Dot(a.AA.Vector3[2],this._oldDirection);(e||Math.abs(r-1)>=.01)&&(this._oldDirection.copyFrom(a.AA.Vector3[2]),this._frameIdLastUpdate=t,this._canPostToWorker=!1,this._worker.postMessage({view:this._modelViewMatrix.m,depthMix:this._depthMix,useRightHandedSystem:this._scene.useRightHandedSystem},[this._depthMix.buffer]))}}render(e,t,i){return this._postToWorker(),super.render(e,t,i)}static _TypeNameToEnum(e){switch(e){case"float":return 0;case"int":return 1;case"uint":return 2;case"double":return 3;case"uchar":return 4}return 5}static _ValueNameToEnum(e){switch(e){case"min_x":return 0;case"min_y":return 1;case"min_z":return 2;case"max_x":return 3;case"max_y":return 4;case"max_z":return 5;case"min_scale_x":return 6;case"min_scale_y":return 7;case"min_scale_z":return 8;case"max_scale_x":return 9;case"max_scale_y":return 10;case"max_scale_z":return 11;case"packed_position":return 12;case"packed_rotation":return 13;case"packed_scale":return 14;case"packed_color":return 15;case"x":return 16;case"y":return 17;case"z":return 18;case"scale_0":return 19;case"scale_1":return 20;case"scale_2":return 21;case"diffuse_red":case"red":return 22;case"diffuse_green":case"green":return 23;case"diffuse_blue":case"blue":return 24;case"f_dc_0":return 26;case"f_dc_1":return 27;case"f_dc_2":return 28;case"f_dc_3":return 29;case"opacity":return 25;case"rot_0":return 30;case"rot_1":return 31;case"rot_2":return 32;case"rot_3":return 33}return 34}static ParseHeader(e){const t=new Uint8Array(e),i=(new TextDecoder).decode(t.slice(0,10240)),r=i.indexOf("end_header\n");if(r<0||!i)return null;const n=parseInt(/element vertex (\d+)\n/.exec(i)[1]),s=/element chunk (\d+)\n/.exec(i);let a=0;s&&(a=parseInt(s[1]));let l=0,c=0;const h={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let u;!function(e){e[e.Vertex=0]="Vertex",e[e.Chunk=1]="Chunk"}(u||(u={}));let d=1;const p=[],f=[],m=i.slice(0,r).split("\n");for(const e of m)if(e.startsWith("property ")){const[,t,i]=e.split(" "),r=x._ValueNameToEnum(i),n=x._TypeNameToEnum(t);1==d?(f.push({value:r,type:n,offset:c}),c+=h[t]):0==d&&(p.push({value:r,type:n,offset:l}),l+=h[t]),h[t]||o.V.Warn(`Unsupported property type: ${t}.`)}else if(e.startsWith("element ")){const[,t]=e.split(" ");"chunk"==t?d=1:"vertex"==t&&(d=0)}return{vertexCount:n,chunkCount:a,rowVertexLength:l,rowChunkLength:c,vertexProperties:p,chunkProperties:f,dataView:new DataView(e,r+11),buffer:new ArrayBuffer(x._RowOutputLength*n)}}static _GetCompressedChunks(e,t){if(!e.chunkCount)return null;const i=e.dataView,r=new Array(e.chunkCount);for(let n=0;n<e.chunkCount;n++){const s={min:new a.Pq,max:new a.Pq,minScale:new a.Pq,maxScale:new a.Pq};r[n]=s;for(let r=0;r<e.chunkProperties.length;r++){const n=e.chunkProperties[r];let a;if(0===n.type)switch(a=i.getFloat32(n.offset+t.value,!0),n.value){case 0:s.min.x=a;break;case 1:s.min.y=a;break;case 2:s.min.z=a;break;case 3:s.max.x=a;break;case 4:s.max.y=a;break;case 5:s.max.z=a;break;case 6:s.minScale.x=a;break;case 7:s.minScale.y=a;break;case 8:s.minScale.z=a;break;case 9:s.maxScale.x=a;break;case 10:s.maxScale.y=a;break;case 11:s.maxScale.z=a}}t.value+=e.rowChunkLength}return r}static _GetSplat(e,t,i,r){const n=a.AA.Quaternion[0],s=a.AA.Vector3[0],o=x._RowOutputLength,l=e.buffer,c=e.dataView,h=new Float32Array(l,t*o,3),u=new Float32Array(l,t*o+12,3),p=new Uint8ClampedArray(l,t*o+24,4),f=new Uint8ClampedArray(l,t*o+28,4),v=t>>8;let S=255,T=0,E=0,C=0;for(let t=0;t<e.vertexProperties.length;t++){const a=e.vertexProperties[t];let o;switch(a.type){case 0:o=c.getFloat32(r.value+a.offset,!0);break;case 1:o=c.getInt32(r.value+a.offset,!0);break;case 2:o=c.getUint32(r.value+a.offset,!0);break;case 3:o=c.getFloat64(r.value+a.offset,!0);break;case 4:o=c.getUint8(r.value+a.offset);break;default:continue}switch(a.value){case 12:{const e=i[v];m(o,s),h[0]=d.X.Lerp(e.min.x,e.max.x,s.x),h[1]=-d.X.Lerp(e.min.y,e.max.y,s.y),h[2]=d.X.Lerp(e.min.z,e.max.z,s.z)}break;case 13:g(o,n),S=n.w,T=n.z,E=n.y,C=n.x;break;case 14:{const e=i[v];m(o,s),u[0]=Math.exp(d.X.Lerp(e.minScale.x,e.maxScale.x,s.x)),u[1]=Math.exp(d.X.Lerp(e.minScale.y,e.maxScale.y,s.y)),u[2]=Math.exp(d.X.Lerp(e.minScale.z,e.maxScale.z,s.z))}break;case 15:_(o,p);break;case 16:h[0]=o;break;case 17:h[1]=o;break;case 18:h[2]=o;break;case 19:u[0]=Math.exp(o);break;case 20:u[1]=Math.exp(o);break;case 21:u[2]=Math.exp(o);break;case 22:p[0]=o;break;case 23:p[1]=o;break;case 24:p[2]=o;break;case 26:p[0]=255*(.5+x._SH_C0*o);break;case 27:p[1]=255*(.5+x._SH_C0*o);break;case 28:p[2]=255*(.5+x._SH_C0*o);break;case 29:p[3]=255*(.5+x._SH_C0*o);break;case 25:p[3]=1/(1+Math.exp(-o))*255;break;case 30:S=o;break;case 31:T=o;break;case 32:E=o;break;case 33:C=o}}n.set(T,E,C,S),n.normalize(),f[0]=128*n.w+128,f[1]=128*n.x+128,f[2]=128*n.y+128,f[3]=128*n.z+128,r.value+=e.rowVertexLength}static*ConvertPLYToSplat(e,t=!1){const i=x.ParseHeader(e);if(!i)return e;const r={value:0},n=x._GetCompressedChunks(i,r);for(let e=0;e<i.vertexCount;e++)x._GetSplat(i,e,n,r),e%x._PlyConversionBatchSize==0&&t&&(yield);return i.buffer}static async ConvertPLYToSplatAsync(e){return(0,p.kj)(x.ConvertPLYToSplat(e,!0),(0,p.VP)())}loadDataAsync(e){return this.updateDataAsync(e)}loadFileAsync(e){return h.S0.LoadFileAsync(e,!0).then((async e=>{x.ConvertPLYToSplatAsync(e).then((e=>{this.updateDataAsync(e)}))}))}dispose(e){this._covariancesATexture?.dispose(),this._covariancesBTexture?.dispose(),this._centersTexture?.dispose(),this._colorsTexture?.dispose(),this._shTextures&&this._shTextures.forEach((e=>{e.dispose()})),this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._shTextures=null,this._worker?.terminate(),this._worker=null,super.dispose(e,!0)}_copyTextures(e){this._covariancesATexture=e.covariancesATexture?.clone(),this._covariancesBTexture=e.covariancesBTexture?.clone(),this._centersTexture=e.centersTexture?.clone(),this._colorsTexture=e.colorsTexture?.clone(),e._shTextures&&(this._shTextures=[],this._shTextures.forEach((e=>{this._shTextures?.push(e.clone())})))}clone(e=""){const t=new x(e,void 0,this.getScene());t._copySource(this),t.makeGeometryUnique(),t._vertexCount=this._vertexCount,t._copyTextures(this),t._modelViewMatrix=a.uq.Identity(),t._splatPositions=this._splatPositions,t._readyToDisplay=!1,t._instanciateWorker();const i=this.getBoundingInfo();return t.getBoundingInfo().reConstruct(i.minimum,i.maximum,this.getWorldMatrix()),t.forcedInstanceCount=t._vertexCount,t.setEnabled(!0),t}_makeSplat(e,t,i,r,n,s,o,l,c){const h=a.AA.Matrix[0],d=a.AA.Matrix[1],p=a.AA.Quaternion[0],f=this._useRGBACovariants?4:2,m=i[8*e+0],_=-i[8*e+1],g=i[8*e+2];this._splatPositions[4*e+0]=m,this._splatPositions[4*e+1]=_,this._splatPositions[4*e+2]=g,l.minimizeInPlaceFromFloats(m,_,g),c.maximizeInPlaceFromFloats(m,_,g),p.set((r[32*e+28+1]-128)/128,(r[32*e+28+2]-128)/128,(r[32*e+28+3]-128)/128,-(r[32*e+28+0]-128)/128),p.toRotationMatrix(h),a.uq.ScalingToRef(2*i[8*e+3+0],2*i[8*e+3+1],2*i[8*e+3+2],d);const v=h.multiplyToRef(d,a.AA.Matrix[0]).m,S=this._tmpCovariances;S[0]=v[0]*v[0]+v[1]*v[1]+v[2]*v[2],S[1]=v[0]*v[4]+v[1]*v[5]+v[2]*v[6],S[2]=v[0]*v[8]+v[1]*v[9]+v[2]*v[10],S[3]=v[4]*v[4]+v[5]*v[5]+v[6]*v[6],S[4]=v[4]*v[8]+v[5]*v[9]+v[6]*v[10],S[5]=v[8]*v[8]+v[9]*v[9]+v[10]*v[10];let x=-1e4;for(let e=0;e<6;e++)x=Math.max(x,Math.abs(S[e]));this._splatPositions[4*e+3]=x;const T=x;n[4*t+0]=(0,u.LZ)(S[0]/T),n[4*t+1]=(0,u.LZ)(S[1]/T),n[4*t+2]=(0,u.LZ)(S[2]/T),n[4*t+3]=(0,u.LZ)(S[3]/T),s[t*f+0]=(0,u.LZ)(S[4]/T),s[t*f+1]=(0,u.LZ)(S[5]/T),o[4*t+0]=r[32*e+24+0],o[4*t+1]=r[32*e+24+1],o[4*t+2]=r[32*e+24+2],o[4*t+3]=r[32*e+24+3]}_updateTextures(e,t,i,r){const n=this._getTextureSize(this._vertexCount),s=(e,t,i,r)=>new c.I(e,t,i,r,this._scene,!1,!1,1,7),a=(e,t,i,r)=>new c.I(e,t,i,r,this._scene,!1,!1,2,2);if(this._keepInRam&&(this._covariancesA=e,this._covariancesB=t,this._colors=i,r&&(this._sh=r)),this._covariancesATexture){this._delayedTextureUpdate={covA:e,covB:t,colors:i,centers:this._splatPositions,sh:r};const n=Float32Array.from(this._splatPositions),s=this._vertexCount;this._worker.postMessage({positions:n,vertexCount:s},[n.buffer]),this._postToWorker(!0)}else this._covariancesATexture=a(e,n.x,n.y,5),this._covariancesBTexture=a(t,n.x,n.y,this._useRGBACovariants?5:7),this._centersTexture=((e,t,i,r)=>new c.I(e,t,i,r,this._scene,!1,!1,2,1))(this._splatPositions,n.x,n.y,5),this._colorsTexture=((e,t,i,r)=>new c.I(e,t,i,r,this._scene,!1,!1,2,0))(i,n.x,n.y,5),r&&(this._shTextures=[],r.forEach((e=>{const t=new Uint32Array(e.buffer),i=s(t,n.x,n.y,11);i.wrapU=0,i.wrapV=0,this._shTextures.push(i)}))),this._instanciateWorker()}*_updateData(e,t,i){this._covariancesATexture||(this._readyToDisplay=!1);const r=new Uint8Array(e),n=new Float32Array(r.buffer),s=r.length/x._RowOutputLength;s!=this._vertexCount&&this._updateSplatIndexBuffer(s),this._vertexCount=s,this._shDegree=i?i.length:0;const o=this._getTextureSize(s),l=o.x*o.y,c=x.ProgressiveUpdateAmount??o.y,h=o.x*c;this._splatPositions=new Float32Array(4*l);const u=new Uint16Array(4*l),d=new Uint16Array((this._useRGBACovariants?4:2)*l),p=new Uint8Array(4*l),f=new a.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),m=new a.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(x.ProgressiveUpdateAmount){this._updateTextures(u,d,p,i),this.setEnabled(!0);const e=Math.ceil(o.y/c);for(let i=0;i<e;i++){const e=i*c,s=e*o.x;for(let e=0;e<h;e++)this._makeSplat(s+e,s+e,n,r,u,d,p,f,m);this._updateSubTextures(this._splatPositions,u,d,p,e,Math.min(c,o.y-e)),this.getBoundingInfo().reConstruct(f,m,this.getWorldMatrix()),t&&(yield)}const s=Float32Array.from(this._splatPositions),a=this._vertexCount;this._worker.postMessage({positions:s,vertexCount:a},[s.buffer]),this._sortIsDirty=!0}else{for(let e=0;e<s;e++)this._makeSplat(e,e,n,r,u,d,p,f,m),t&&e%x._SplatBatchSize==0&&(yield);this._updateTextures(u,d,p,i),this.getBoundingInfo().reConstruct(f,m,this.getWorldMatrix()),this.setEnabled(!0)}this._postToWorker(!0)}async updateDataAsync(e,t){return(0,p.kj)(this._updateData(e,!0,t),(0,p.VP)())}updateData(e,t){(0,p.V1)(this._updateData(e,!1,t))}_updateSplatIndexBuffer(e){(!this._splatIndex||e>this._splatIndex.length)&&(this._splatIndex=new Float32Array(e),this.thinInstanceSetBuffer("splatIndex",this._splatIndex,1,!1)),this.forcedInstanceCount=e}_updateSubTextures(e,t,i,r,n,s,a){const o=(e,t,i,r,n)=>{this.getEngine().updateTextureData(e.getInternalTexture(),t,0,r,i,n,0,0,!1)},l=this._getTextureSize(this._vertexCount),c=this._useRGBACovariants?4:2,h=n*l.x,u=s*l.x,d=new Uint16Array(t.buffer,4*h*Uint16Array.BYTES_PER_ELEMENT,4*u),p=new Uint16Array(i.buffer,h*c*Uint16Array.BYTES_PER_ELEMENT,u*c),f=new Uint8Array(r.buffer,4*h,4*u),m=new Float32Array(e.buffer,4*h*Float32Array.BYTES_PER_ELEMENT,4*u);if(o(this._covariancesATexture,d,l.x,n,s),o(this._covariancesBTexture,p,l.x,n,s),o(this._centersTexture,m,l.x,n,s),o(this._colorsTexture,f,l.x,n,s),a)for(let e=0;e<a.length;e++){const t=4,i=new Uint8Array(this._sh[e].buffer,h*t,u*t);o(this._shTextures[e],i,l.x,n,s)}}_instanciateWorker(){if(!this._vertexCount)return;this._updateSplatIndexBuffer(this._vertexCount),this._worker?.terminate(),this._worker=new Worker(URL.createObjectURL(new Blob(["(",x._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._depthMix=new BigInt64Array(this._vertexCount);const e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._worker.onmessage=e=>{this._depthMix=e.data.depthMix;const i=new Uint32Array(e.data.depthMix.buffer);if(this._splatIndex)for(let e=0;e<this._vertexCount;e++)this._splatIndex[e]=i[2*e];if(this._delayedTextureUpdate){const e=this._getTextureSize(t);this._updateSubTextures(this._delayedTextureUpdate.centers,this._delayedTextureUpdate.covA,this._delayedTextureUpdate.covB,this._delayedTextureUpdate.colors,0,e.y,this._delayedTextureUpdate.sh),this._delayedTextureUpdate=null}this.thinInstanceBufferUpdated("splatIndex"),this._canPostToWorker=!0,this._readyToDisplay=!0,this._sortIsDirty&&(this._postToWorker(!0),this._sortIsDirty=!1)}}_getTextureSize(e){const t=this._scene.getEngine(),i=t.getCaps().maxTextureSize;let r=1;if(1!==t.version||t.isWebGPU)r=Math.ceil(e/i);else for(;i*r<e;)r*=2;return r>i&&(o.V.Error("GaussianSplatting texture size: ("+i+", "+r+"), maxTextureSize: "+i),r=i),new a.I9(i,r)}}x._RowOutputLength=32,x._SH_C0=.28209479177387814,x._SplatBatchSize=327680,x._PlyConversionBatchSize=32768,x.ProgressiveUpdateAmount=0,x._CreateWorker=function(e){let t,i,r,n,s=0;e.onmessage=a=>{if(a.data.positions)t=a.data.positions,s=a.data.vertexCount;else{const o=a.data.view;if(!t||!o)throw new Error("positions or view is not defined!");i=a.data.depthMix,r=new Uint32Array(i.buffer),n=new Float32Array(i.buffer);for(let e=0;e<s;e++)r[2*e]=e;let l=-1;a.data.useRightHandedSystem&&(l=1);for(let e=0;e<s;e++)n[2*e+1]=1e4+(o[2]*t[4*e+0]+o[6]*t[4*e+1]+o[10]*t[4*e+2])*l;i.sort(),e.postMessage({depthMix:i},[i.buffer])}}}},42319:(e,t,i)=>{var r=i(9191),n=i(59396),s=i(54983),a=i(70461),o=i(54611);r.e.prototype.thinInstanceAdd=function(e,t=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return a.V.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(e)?e.length:1);const i=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(e))for(let i=0;i<e.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e[i],i===e.length-1&&t);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e,t);return i},r.e.prototype.thinInstanceAddSelf=function(e=!0){return this.thinInstanceAdd(s.uq.IdentityReadOnly,e)},r.e.prototype.thinInstanceRegisterAttribute=function(e,t){e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this.removeVerticesData(e),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[e]=t,this._userThinInstanceBuffersStorage.sizes[e]=t*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[e]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[e]),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!0,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])},r.e.prototype.thinInstanceSetMatrixAt=function(e,t,i=!0){if(!this._thinInstanceDataStorage.matrixData||e>=this._thinInstanceDataStorage.instancesCount)return!1;const r=this._thinInstanceDataStorage.matrixData;return t.copyToArray(r,16*e),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[e]=t),i&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},r.e.prototype.thinInstanceSetAttributeAt=function(e,t,i,r=!0){return e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[e]||t>=this._thinInstanceDataStorage.instancesCount||(this._thinInstanceUpdateBufferSize(e,0),this._userThinInstanceBuffersStorage.data[e].set(i,t*this._userThinInstanceBuffersStorage.strides[e]),r&&this.thinInstanceBufferUpdated(e),0))},Object.defineProperty(r.e.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(e){const t=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData;e<=(t?t.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=e)},enumerable:!0,configurable:!0}),r.e.prototype._thinInstanceCreateMatrixBuffer=function(e,t,i=!0){const r=new n.h(this.getEngine(),t,!i,16,!1,!0);for(let t=0;t<4;t++)this.setVerticesBuffer(r.createVertexBuffer(e+t,4*t,4));return r},r.e.prototype.thinInstanceSetBuffer=function(e,t,i=0,r=!0){i=i||16,"matrix"===e?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=t?t.length:32*i,this._thinInstanceDataStorage.matrixData=t,this._thinInstanceDataStorage.worldMatrices=null,null!==t?(this._thinInstanceDataStorage.instancesCount=t.length/i,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",t,r),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===e?(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=t,null!==t&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",t,r))):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),null===t?this._userThinInstanceBuffersStorage?.data[e]&&(this.removeVerticesData(e),delete this._userThinInstanceBuffersStorage.data[e],delete this._userThinInstanceBuffersStorage.strides[e],delete this._userThinInstanceBuffersStorage.sizes[e],delete this._userThinInstanceBuffersStorage.vertexBuffers[e]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[e]=t,this._userThinInstanceBuffersStorage.strides[e]=i,this._userThinInstanceBuffersStorage.sizes[e]=t.length,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),t,e,!r,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])))},r.e.prototype.thinInstanceBufferUpdated=function(e){"matrix"===e?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):"previousMatrix"===e?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[e]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[e].isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(this._userThinInstanceBuffersStorage.data[e],0)))},r.e.prototype.thinInstancePartialBufferUpdate=function(e,t,i){"matrix"===e?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(t,i):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[e]&&this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(t,i))},r.e.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const e=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t)this._thinInstanceDataStorage.worldMatrices[t]=s.uq.FromArray(e,16*t)}return this._thinInstanceDataStorage.worldMatrices},r.e.prototype.thinInstanceRefreshBoundingInfo=function(e=!1,t=!1,i=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const r=this._thinInstanceDataStorage.boundingVectors;if(e||!this.rawBoundingInfo){r.length=0,this.refreshBoundingInfo(t,i);const e=this.getBoundingInfo();this.rawBoundingInfo=new o.j(e.minimum,e.maximum)}const n=this.getBoundingInfo(),a=this._thinInstanceDataStorage.matrixData;if(0===r.length)for(let e=0;e<n.boundingBox.vectors.length;++e)r.push(n.boundingBox.vectors[e].clone());s.AA.Vector3[0].setAll(Number.POSITIVE_INFINITY),s.AA.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e){s.uq.FromArrayToRef(a,16*e,s.AA.Matrix[0]);for(let e=0;e<r.length;++e)s.Pq.TransformCoordinatesToRef(r[e],s.AA.Matrix[0],s.AA.Vector3[2]),s.AA.Vector3[0].minimizeInPlace(s.AA.Vector3[2]),s.AA.Vector3[1].maximizeInPlace(s.AA.Vector3[2])}n.reConstruct(s.AA.Vector3[0],s.AA.Vector3[1]),this._updateBoundingInfo()},r.e.prototype._thinInstanceRecreateBuffer=function(e,t=!0){"matrix"===e?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,t)):"previousMatrix"===e?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,t)):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[e]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!t,!1,this._userThinInstanceBuffersStorage.strides[e],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))},r.e.prototype._thinInstanceUpdateBufferSize=function(e,t=1){e===n.R.ColorKind&&(e=n.R.ColorInstanceKind);const i="matrix"===e;if(!(i||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[e]))return;const r=i?16:this._userThinInstanceBuffersStorage.strides[e],s=i?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[e];let a=i?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[e];const o=(this._thinInstanceDataStorage.instancesCount+t)*r;let l=s;for(;l<o;)l*=2;if(!a||s!=l){if(a){const e=new Float32Array(l);e.set(a,0),a=e}else a=new Float32Array(l);i?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",a,!1),this._thinInstanceDataStorage.matrixData=a,this._thinInstanceDataStorage.matrixBufferSize=l,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",a,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[e]?.dispose(),this._userThinInstanceBuffersStorage.data[e]=a,this._userThinInstanceBuffersStorage.sizes[e]=l,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),a,e,!0,!1,r,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))}},r.e.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},r.e.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)}},60554:(e,t,i)=>{i.d(t,{I9:()=>h,LT:()=>l,NK:()=>a,VH:()=>o});var r=i(76531);function n(e,t,i,r,n,s){n>0?(n=function(e,t){return t>1023?1*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?1*Math.pow(2,-1074)*Math.pow(2,t+1074):1*Math.pow(2,t)}(0,n-136),e[s+0]=t*n,e[s+1]=i*n,e[s+2]=r*n):(e[s+0]=0,e[s+1]=0,e[s+2]=0)}function s(e,t){let i="",r="";for(let n=t;n<e.length-t&&(r=String.fromCharCode(e[n]),"\n"!=r);n++)i+=r;return i}function a(e){let t=0,i=0,r=s(e,0);if("#"!=r[0]||"?"!=r[1])throw"Bad HDR Format.";let n=!1,a=!1,o=0;do{o+=r.length+1,r=s(e,o),"FORMAT=32-bit_rle_rgbe"==r?a=!0:0==r.length&&(n=!0)}while(!n);if(!a)throw"HDR Bad header format, unsupported FORMAT";o+=r.length+1,r=s(e,o);const l=/^-Y (.*) \+X (.*)$/g.exec(r);if(!l||l.length<3)throw"HDR Bad header format, no size";if(i=parseInt(l[2]),t=parseInt(l[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return o+=r.length+1,{height:t,width:i,dataPosition:o}}function o(e,t,i=!1){const n=new Uint8Array(e),s=a(n),o=l(n,s);return r.D.ConvertPanoramaToCubemap(o,s.width,s.height,t,i)}function l(e,t){return function(e,t){let i=t.height;const r=t.width;let s,a,o,l,h,u=t.dataPosition,d=0,p=0,f=0;const m=new ArrayBuffer(4*r),_=new Uint8Array(m),g=new ArrayBuffer(t.width*t.height*4*3),v=new Float32Array(g);for(;i>0;){if(s=e[u++],a=e[u++],o=e[u++],l=e[u++],2!=s||2!=a||128&o||t.width<8||t.width>32767)return c(e,t);if((o<<8|l)!=r)throw"HDR Bad header format, wrong scan line width";for(d=0,f=0;f<4;f++)for(p=(f+1)*r;d<p;)if(s=e[u++],a=e[u++],s>128){if(h=s-128,0==h||h>p-d)throw"HDR Bad Format, bad scanline data (run)";for(;h-- >0;)_[d++]=a}else{if(h=s,0==h||h>p-d)throw"HDR Bad Format, bad scanline data (non-run)";if(_[d++]=a,--h>0)for(let t=0;t<h;t++)_[d++]=e[u++]}for(f=0;f<r;f++)s=_[f],a=_[f+r],o=_[f+2*r],l=_[f+3*r],n(v,s,a,o,l,(t.height-i)*r*3+3*f);i--}return v}(e,t)}function c(e,t){let i=t.height;const r=t.width;let s,a,o,l,c,h=t.dataPosition;const u=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(u);for(;i>0;){for(c=0;c<t.width;c++)s=e[h++],a=e[h++],o=e[h++],l=e[h++],n(d,s,a,o,l,(t.height-i)*r*3+3*c);i--}return d}const h={RGBE_ReadHeader:a,GetCubeMapTextureData:o,RGBE_ReadPixels:l}},76531:(e,t,i)=>{i.d(t,{D:()=>n});var r=i(54983);class n{static ConvertPanoramaToCubemap(e,t,i,r,n=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,i,n),back:this.CreateCubemapTexture(r,this.FACE_BACK,e,t,i,n),left:this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,i,n),right:this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,i,n),up:this.CreateCubemapTexture(r,this.FACE_UP,e,t,i,n),down:this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,i,n),size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,r,n,s=!1){const a=new ArrayBuffer(e*e*4*3),o=new Float32Array(a),l=s?Math.max(1,Math.round(r/4/e)):1,c=1/l,h=c*c,u=t[1].subtract(t[0]).scale(c/e),d=t[3].subtract(t[2]).scale(c/e),p=1/e;let f=0;for(let s=0;s<e;s++)for(let a=0;a<l;a++){let a=t[0],m=t[2];for(let t=0;t<e;t++)for(let c=0;c<l;c++){const l=m.subtract(a).scale(f).add(a);l.normalize();const c=this.CalcProjectionSpherical(l,i,r,n);o[s*e*3+3*t+0]+=c.r*h,o[s*e*3+3*t+1]+=c.g*h,o[s*e*3+3*t+2]+=c.b*h,a=a.add(u),m=m.add(d)}f+=p*c}return o}static CalcProjectionSpherical(e,t,i,r){let n=Math.atan2(e.z,e.x);const s=Math.acos(e.y);for(;n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;let a=n/Math.PI;const o=s/Math.PI;a=.5*a+.5;let l=Math.round(a*i);l<0?l=0:l>=i&&(l=i-1);let c=Math.round(o*r);c<0?c=0:c>=r&&(c=r-1);const h=r-c-1;return{r:t[h*i*3+3*l+0],g:t[h*i*3+3*l+1],b:t[h*i*3+3*l+2]}}}n.FACE_LEFT=[new r.Pq(-1,-1,-1),new r.Pq(1,-1,-1),new r.Pq(-1,1,-1),new r.Pq(1,1,-1)],n.FACE_RIGHT=[new r.Pq(1,-1,1),new r.Pq(-1,-1,1),new r.Pq(1,1,1),new r.Pq(-1,1,1)],n.FACE_FRONT=[new r.Pq(1,-1,-1),new r.Pq(1,-1,1),new r.Pq(1,1,-1),new r.Pq(1,1,1)],n.FACE_BACK=[new r.Pq(-1,-1,1),new r.Pq(-1,-1,-1),new r.Pq(-1,1,1),new r.Pq(-1,1,-1)],n.FACE_DOWN=[new r.Pq(1,1,-1),new r.Pq(1,1,1),new r.Pq(-1,1,-1),new r.Pq(-1,1,1)],n.FACE_UP=[new r.Pq(-1,-1,-1),new r.Pq(-1,-1,1),new r.Pq(1,-1,-1),new r.Pq(1,-1,1)]},71689:(e,t,i)=>{i.d(t,{J:()=>o,X:()=>a});var r=i(23077),n=i(68642);let s=0;const a=e=>{if(!e.environmentBRDFTexture){const t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;const i=e._blockEntityCollection;e._blockEntityCollection=!1;const a=r.g.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+s++,e,!0,!1,r.g.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=i;const o=e.getEngine().getLoadedTexturesCache(),l=o.indexOf(a.getInternalTexture());-1!==l&&o.splice(l,1),a.isRGBD=!0,a.wrapU=r.g.CLAMP_ADDRESSMODE,a.wrapV=r.g.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=a,e.useDelayedTextureLoading=t,n.G.ExpandRGBDTexture(a);const c=e.getEngine().onContextRestoredObservable.add((()=>{a.isRGBD=!0;const t=e.onBeforeRenderObservable.add((()=>{a.isReady()&&(e.onBeforeRenderObservable.remove(t),n.G.ExpandRGBDTexture(a))}))}));e.onDisposeObservable.add((()=>{e.getEngine().onContextRestoredObservable.remove(c)}))}return e.environmentBRDFTexture},o={GetEnvironmentBRDFTexture:a}},74450:(e,t,i)=>{i.d(t,{s:()=>n});var r=i(56953);class n{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then((e=>{this._dataView=new DataView(e.buffer,e.byteOffset,e.byteLength),this._dataByteOffset=0}))}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return(0,r.Tq)(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}},57646:(e,t,i)=>{i.d(t,{c:()=>r});class r{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}}},18458:(e,t,i)=>{i.d(t,{G:()=>n});var r=i(54983);class n{static _RemoveAndStorePivotPoint(e){e&&0===n._PivotCached&&(e.getPivotPointToRef(n._OldPivotPoint),n._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,n._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(r.uq.IdentityReadOnly),n._OldPivotPoint.subtractToRef(e.getPivotPoint(),n._PivotTranslation),n._PivotTmpVector.copyFromFloats(1,1,1),n._PivotTmpVector.subtractInPlace(e.scaling),n._PivotTmpVector.multiplyInPlace(n._PivotTranslation),e.position.addInPlace(n._PivotTmpVector))),n._PivotCached++}static _RestorePivotPoint(e){e&&!n._OldPivotPoint.equalsToFloats(0,0,0)&&1===n._PivotCached&&(e.setPivotPoint(n._OldPivotPoint),e._postMultiplyPivotMatrix=n._PivotPostMultiplyPivotMatrix,n._PivotTmpVector.copyFromFloats(1,1,1),n._PivotTmpVector.subtractInPlace(e.scaling),n._PivotTmpVector.multiplyInPlace(n._PivotTranslation),e.position.subtractInPlace(n._PivotTmpVector)),this._PivotCached--}}n._PivotCached=0,n._OldPivotPoint=new r.Pq,n._PivotTranslation=new r.Pq,n._PivotTmpVector=new r.Pq,n._PivotPostMultiplyPivotMatrix=!1},63665:(e,t,i)=>{i.d(t,{FA:()=>g,O_:()=>_,uT:()=>v});var r=i(70461);const n=1,s=2,a=3,o=9,l=10,c=11,h=48,u=4,d=0,p=1,f=2,m=3;function _(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function g(e,t){if(t.length<19)return void r.V.Error("Unable to load TGA file - Not enough data to contain header");let i=18;const g=_(t);if(g.id_length+i>t.length)return void r.V.Error("Unable to load TGA file - Not enough data");i+=g.id_length;let S,x=!1,T=!1,E=!1;switch(g.image_type){case o:x=!0;case n:T=!0;break;case l:x=!0;case s:break;case c:x=!0;case a:E=!0}const C=g.pixel_size>>3,b=g.width*g.height*C;let P,y,A,R,I,M,O;if(T&&(P=t.subarray(i,i+=g.colormap_length*(g.colormap_size>>3))),x){let e,r,n;S=new Uint8Array(b);let s=0;const a=new Uint8Array(C);for(;i<b&&s<b;)if(e=t[i++],r=1+(127&e),128&e){for(n=0;n<C;++n)a[n]=t[i++];for(n=0;n<r;++n)S.set(a,s+n*C);s+=C*r}else{for(r*=C,n=0;n<r;++n)S[s+n]=t[i++];s+=r}}else S=t.subarray(i,i+=T?g.width*g.height:b);switch((g.flags&h)>>u){default:case f:y=0,R=1,O=g.width,A=0,I=1,M=g.height;break;case d:y=0,R=1,O=g.width,A=g.height-1,I=-1,M=-1;break;case m:y=g.width-1,R=-1,O=-1,A=0,I=1,M=g.height;break;case p:y=g.width-1,R=-1,O=-1,A=g.height-1,I=-1,M=-1}const N="_getImageData"+(E?"Grey":"")+g.pixel_size+"bits",D=v[N](g,P,S,A,I,M,y,R,O);e.getEngine()._uploadDataToTextureDirectly(e,D)}const v={GetTGAHeader:_,UploadContent:g,_getImageData8bits:function(e,t,i,r,n,s,a,o,l){const c=i,h=t,u=e.width,d=e.height;let p,f,m,_=0;const g=new Uint8Array(u*d*4);for(m=r;m!==s;m+=n)for(f=a;f!==l;f+=o,_++)p=c[_],g[4*(f+u*m)+3]=255,g[4*(f+u*m)+2]=h[3*p+0],g[4*(f+u*m)+1]=h[3*p+1],g[4*(f+u*m)+0]=h[3*p+2];return g},_getImageData16bits:function(e,t,i,r,n,s,a,o,l){const c=i,h=e.width,u=e.height;let d,p,f,m=0;const _=new Uint8Array(h*u*4);for(f=r;f!==s;f+=n)for(p=a;p!==l;p+=o,m+=2){d=c[m+0]+(c[m+1]<<8);const e=255*((31744&d)>>10)/31|0,t=255*((992&d)>>5)/31|0,i=255*(31&d)/31|0;_[4*(p+h*f)+0]=e,_[4*(p+h*f)+1]=t,_[4*(p+h*f)+2]=i,_[4*(p+h*f)+3]=32768&d?0:255}return _},_getImageData24bits:function(e,t,i,r,n,s,a,o,l){const c=i,h=e.width,u=e.height;let d,p,f=0;const m=new Uint8Array(h*u*4);for(p=r;p!==s;p+=n)for(d=a;d!==l;d+=o,f+=3)m[4*(d+h*p)+3]=255,m[4*(d+h*p)+2]=c[f+0],m[4*(d+h*p)+1]=c[f+1],m[4*(d+h*p)+0]=c[f+2];return m},_getImageData32bits:function(e,t,i,r,n,s,a,o,l){const c=i,h=e.width,u=e.height;let d,p,f=0;const m=new Uint8Array(h*u*4);for(p=r;p!==s;p+=n)for(d=a;d!==l;d+=o,f+=4)m[4*(d+h*p)+2]=c[f+0],m[4*(d+h*p)+1]=c[f+1],m[4*(d+h*p)+0]=c[f+2],m[4*(d+h*p)+3]=c[f+3];return m},_getImageDataGrey8bits:function(e,t,i,r,n,s,a,o,l){const c=i,h=e.width,u=e.height;let d,p,f,m=0;const _=new Uint8Array(h*u*4);for(f=r;f!==s;f+=n)for(p=a;p!==l;p+=o,m++)d=c[m],_[4*(p+h*f)+0]=d,_[4*(p+h*f)+1]=d,_[4*(p+h*f)+2]=d,_[4*(p+h*f)+3]=255;return _},_getImageDataGrey16bits:function(e,t,i,r,n,s,a,o,l){const c=i,h=e.width,u=e.height;let d,p,f=0;const m=new Uint8Array(h*u*4);for(p=r;p!==s;p+=n)for(d=a;d!==l;d+=o,f+=2)m[4*(d+h*p)+0]=c[f+0],m[4*(d+h*p)+1]=c[f+0],m[4*(d+h*p)+2]=c[f+0],m[4*(d+h*p)+3]=c[f+1];return m}}},18988:(e,t,i)=>{i.d(t,{Qz:()=>a,R$:()=>r,fj:()=>s});var r,n=i(6740);function s(e){let t=0;const i=Date.now();e.observableParameters=e.observableParameters??{};const r=e.contextObservable.add((n=>{const s=Date.now();t=s-i;const a={startTime:i,currentTime:s,deltaTime:t,completeRate:t/e.timeout,payload:n};e.onTick&&e.onTick(a),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(r),e.onAborted&&e.onAborted(a)),t>=e.timeout&&(e.contextObservable.remove(r),e.onEnded&&e.onEnded(a))}),e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return r}!function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(r||(r={}));class a{constructor(e){this.onEachCountObservable=new n.cP,this.onTimerAbortedObservable=new n.cP,this.onTimerEndedObservable=new n.cP,this.onStateChangedObservable=new n.cP,this._observer=null,this._breakOnNextTick=!1,this._tick=e=>{const t=Date.now();this._timer=t-this._startTime;const i={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},r=this._breakOnNextTick||this._breakCondition(i);r||this._timer>=this._timeToEnd?this._stop(i,r):this.onEachCountObservable.notifyObservers(i)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(1===this._state)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){1===this._state&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}},16734:(e,t,i)=>{i.d(t,{M:()=>h});var r=i(90576),n=i(6740),s=i(69583),a=i(59396),o=i(96631),l=i(16265),c=i(88252);class h{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new n.cP,this._onDataLayoutChanged=new n.cP,this._animationPropertiesOverride=null,this.id=e,this._scene=i||s.q.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=l.p.Clone((()=>new h(this.name,this.influence,this._scene)),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),l.p.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new h(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let t=0;t<e.animations.length;t++){const r=e.animations[t],n=(0,c.n9)("BABYLON.Animation");n&&i.animations.push(n.Parse(r))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const r=new h(t,i,e.getScene());return r.setPositions(e.getVerticesData(a.R.PositionKind)),e.isVerticesDataPresent(a.R.NormalKind)&&r.setNormals(e.getVerticesData(a.R.NormalKind)),e.isVerticesDataPresent(a.R.TangentKind)&&r.setTangents(e.getVerticesData(a.R.TangentKind)),e.isVerticesDataPresent(a.R.UVKind)&&r.setUVs(e.getVerticesData(a.R.UVKind)),r}}(0,r.Cg)([(0,o.lK)()],h.prototype,"id",void 0)},44211:(e,t,i)=>{i.d(t,{j:()=>l});var r=i(94975),n=i(70461),s=i(69583),a=i(16734),o=i(41930);class l{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new r.L(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=s.q.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._syncActiveTargets(!0))}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){return l.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add((e=>{this._syncActiveTargets(e)}))),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add((()=>{this._syncActiveTargets(!0)}))),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setInt("morphTargetCount",this.numInfluencers)}clone(){const e=new l(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const e of this._targets){if(i++,0===e.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=l.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=e.influence,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs;const r=e.getPositions();if(r){const e=r.length/3;if(0===this._vertexCount)this._vertexCount=e;else if(this._vertexCount!==e)return void n.V.Error("Incompatible target. Targets must all have the same vertices count.")}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(let e=0;e<t;e++)this._influences[e]=this._tempInfluences[e];e&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&(this._vertexCount||this.numMaxInfluencers>0)){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const e=this._targetStoreTexture.getSize();e.width===this._textureWidth&&e.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const e=this._targets.length,t=new Float32Array(e*this._textureWidth*this._textureHeight*4);let i=0;for(let r=0;r<e;r++){const e=this._targets[r],s=e.getPositions(),a=e.getNormals(),o=e.getUVs(),l=e.getTangents();if(!s)return void(0===r&&n.V.Error("Invalid morph target. Target must have positions."));i=r*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)t[i]=s[3*e],t[i+1]=s[3*e+1],t[i+2]=s[3*e+2],i+=4,this._supportsNormals&&a&&(t[i]=a[3*e],t[i+1]=a[3*e+1],t[i+2]=a[3*e+2],i+=4),this._supportsUVs&&o&&(t[i]=o[2*e],t[i+1]=o[2*e+1],i+=4),this._supportsTangents&&l&&(t[i]=l[3*e],t[i+1]=l[3*e+1],t[i+2]=l[3*e+2],i+=4)}this._targetStoreTexture=o.L.CreateRGBATexture(t,this._textureWidth,this._textureHeight,e,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new l(t);for(const r of e.targets)i.addTarget(a.M.Parse(r,t));return i}}l.EnableTextureStorage=!0,l.MaxActiveMorphTargetsInVertexAttributeMode=8},77583:(e,t,i)=>{i.d(t,{M:()=>n,x:()=>s});var r=i(89529);class n{constructor(e,t,i,n,s){this.idx=0,this.color=new r.ov(1,1,1,1),this.position=r.Pq.Zero(),this.rotation=r.Pq.Zero(),this.uv=new r.I9(0,0),this.velocity=r.Pq.Zero(),this.pivot=r.Pq.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=r.Pq.Zero(),this.idx=e,this._group=t,this.groupId=i,this.idxInGroup=n,this._pcs=s}get size(){return this.size}set size(e){this.size=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e,t){if(!e.hasBoundingInfo)return!1;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(t)return e.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));const i=e.getBoundingInfo().boundingBox,r=i.maximumWorld.x,n=i.minimumWorld.x,s=i.maximumWorld.y,a=i.minimumWorld.y,o=i.maximumWorld.z,l=i.minimumWorld.z,c=this.position.x+this._pcs.mesh.position.x,h=this.position.y+this._pcs.mesh.position.y,u=this.position.z+this._pcs.mesh.position.z;return n<=c&&c<=r&&a<=h&&h<=s&&l<=u&&u<=o}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=r.AA.Quaternion[0];const e=this.rotation;r.PT.RotationYawPitchRollToRef(e.y,e.x,e.z,t)}t.toRotationMatrix(e)}}class s{get groupID(){return this.groupId}set groupID(e){this.groupId=e}constructor(e,t){this.groupId=e,this._positionFunction=t}}},47501:(e,t,i)=>{i.d(t,{q:()=>r,y:()=>_});var r,n=i(89529),s=i(54983),a=i(70461),o=i(59396),l=i(33543),c=i(9191),h=i(69583),u=i(77583),d=i(1675),p=i(78065),f=i(85682),m=i(49111);!function(e){e[e.Color=2]="Color",e[e.UV=1]="UV",e[e.Random=0]="Random",e[e.Stated=3]="Stated"}(r||(r={}));class _{get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}constructor(e,t,i,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=e,this._size=t,this._scene=i||h.q.LastCreatedScene,r&&void 0!==r.updatable?this._updatable=r.updatable:this._updatable=!0}buildMeshAsync(e){return Promise.all(this._promises).then((()=>(this._isReady=!0,this._buildMesh(e))))}_buildMesh(e){0===this.nbParticles&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);const t=new l.P;t.set(this._positions32,o.R.PositionKind),this._uvs32.length>0&&t.set(this._uvs32,o.R.UVKind);let i=0;this._colors32.length>0&&(i=1,t.set(this._colors32,o.R.ColorKind));const r=new c.e(this.name,this._scene);t.applyToMesh(r,this._updatable),this.mesh=r,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let s=e;return s||(s=new p.F("point cloud material",this._scene),s.emissiveColor=new n.v9(i,i,i),s.disableLighting=!0,s.pointsCloud=!0,s.pointSize=this._size),r.material=s,new Promise((e=>e(r)))}_addParticle(e,t,i,r){const n=new u.M(e,t,i,r,this);return this.particles.push(n),n}_randomUnitVector(e){e.position=new s.Pq(Math.random(),Math.random(),Math.random()),e.color=new n.ov(1,1,1,1)}_getColorIndicesForCoord(e,t,i,r){const s=e._groupImageData,a=i*(4*r)+4*t,o=[a,a+1,a+2,a+3],l=o[1],c=o[2],h=o[3],u=s[o[0]],d=s[l],p=s[c],f=s[h];return new n.ov(u/255,d/255,p/255,f)}_setPointsColorOrUV(e,t,i,r,a,l,c,h){h=h??0,i&&e.updateFacetData();const u=2*e.getBoundingInfo().boundingSphere.radius;let p=e.getVerticesData(o.R.PositionKind);const f=e.getIndices(),_=e.getVerticesData(o.R.UVKind+(h?h+1:"")),g=e.getVerticesData(o.R.ColorKind),v=s.Pq.Zero();e.computeWorldMatrix();const S=e.getWorldMatrix();if(!S.isIdentity()){p=p.slice(0);for(let e=0;e<p.length/3;e++)s.Pq.TransformCoordinatesFromFloatsToRef(p[3*e],p[3*e+1],p[3*e+2],S,v),p[3*e]=v.x,p[3*e+1]=v.y,p[3*e+2]=v.z}let x=0,T=0,E=0,C=0,b=0,P=0,y=0,A=0,R=0,I=0,M=0,O=0,N=0;const D=s.Pq.Zero(),F=s.Pq.Zero(),L=s.Pq.Zero(),w=s.Pq.Zero(),B=s.Pq.Zero();let V=0,k=0,G=0,U=0,z=0,W=0;const H=s.I9.Zero(),Y=s.I9.Zero(),X=s.I9.Zero(),q=s.I9.Zero(),$=s.I9.Zero();let j=0,K=0,Z=0,Q=0,J=0,ee=0,te=0,ie=0,re=0,ne=0,se=0,ae=0;const oe=s.IU.Zero(),le=s.IU.Zero(),ce=s.IU.Zero(),he=s.IU.Zero(),ue=s.IU.Zero();let de,pe,fe=0,me=0;c=c||0;let _e=new s.IU(0,0,0,0),ge=s.Pq.Zero(),ve=s.Pq.Zero(),Se=s.Pq.Zero(),xe=0,Te=s.Pq.Zero(),Ee=0,Ce=0;const be=new d.Rl(s.Pq.Zero(),new s.Pq(1,0,0));let Pe,ye=s.Pq.Zero();for(let o=0;o<f.length/3;o++){let h,d,v,S,Ae,Re,Ie,Me;T=f[3*o],E=f[3*o+1],C=f[3*o+2],b=p[3*T],P=p[3*T+1],y=p[3*T+2],A=p[3*E],R=p[3*E+1],I=p[3*E+2],M=p[3*C],O=p[3*C+1],N=p[3*C+2],D.set(b,P,y),F.set(A,R,I),L.set(M,O,N),F.subtractToRef(D,w),L.subtractToRef(F,B),_&&(V=_[2*T],k=_[2*T+1],G=_[2*E],U=_[2*E+1],z=_[2*C],W=_[2*C+1],H.set(V,k),Y.set(G,U),X.set(z,W),Y.subtractToRef(H,q),X.subtractToRef(Y,$)),g&&r&&(j=g[4*T],K=g[4*T+1],Z=g[4*T+2],Q=g[4*T+3],J=g[4*E],ee=g[4*E+1],te=g[4*E+2],ie=g[4*E+3],re=g[4*C],ne=g[4*C+1],se=g[4*C+2],ae=g[4*C+3],oe.set(j,K,Z,Q),le.set(J,ee,te,ie),ce.set(re,ne,se,ae),le.subtractToRef(oe,he),ce.subtractToRef(le,ue));const Oe=new n.v9(0,0,0),Ne=new n.v9(0,0,0);let De,Fe;for(let p=0;p<t._groupDensity[o];p++)x=this.particles.length,this._addParticle(x,t,this._groupCounter,o+p),Fe=this.particles[x],fe=Math.sqrt((0,m.RandomRange)(0,1)),me=(0,m.RandomRange)(0,1),de=D.add(w.scale(fe)).add(B.scale(fe*me)),i&&(ge=e.getFacetNormal(o).normalize().scale(-1),ve=w.clone().normalize(),Se=s.Pq.Cross(ge,ve),xe=(0,m.RandomRange)(0,2*Math.PI),Te=ve.scale(Math.cos(xe)).add(Se.scale(Math.sin(xe))),xe=(0,m.RandomRange)(.1,Math.PI/2),ye=Te.scale(Math.cos(xe)).add(ge.scale(Math.sin(xe))),be.origin=de.add(ye.scale(1e-5)),be.direction=ye,be.length=u,Pe=be.intersectsMesh(e),Pe.hit&&(Ce=Pe.pickedPoint.subtract(de).length(),Ee=(0,m.RandomRange)(0,1)*Ce,de.addInPlace(ye.scale(Ee)))),Fe.position=de.clone(),this._positions.push(Fe.position.x,Fe.position.y,Fe.position.z),void 0!==r?_&&(pe=H.add(q.scale(fe)).add($.scale(fe*me)),r?a&&null!==t._groupImageData?(h=t._groupImgWidth,d=t._groupImgHeight,De=this._getColorIndicesForCoord(t,Math.round(pe.x*h),Math.round(pe.y*d),h),Fe.color=De,this._colors.push(De.r,De.g,De.b,De.a)):g?(_e=oe.add(he.scale(fe)).add(ue.scale(fe*me)),Fe.color=new n.ov(_e.x,_e.y,_e.z,_e.w),this._colors.push(_e.x,_e.y,_e.z,_e.w)):(_e=oe.set(Math.random(),Math.random(),Math.random(),1),Fe.color=new n.ov(_e.x,_e.y,_e.z,_e.w),this._colors.push(_e.x,_e.y,_e.z,_e.w)):(Fe.uv=pe.clone(),this._uvs.push(Fe.uv.x,Fe.uv.y))):(l?(Oe.set(l.r,l.g,l.b),v=(0,m.RandomRange)(-c,c),S=(0,m.RandomRange)(-c,c),Me=Oe.toHSV(),Ae=Me.r,Re=Me.g+v,Ie=Me.b+S,Re<0&&(Re=0),Re>1&&(Re=1),Ie<0&&(Ie=0),Ie>1&&(Ie=1),n.v9.HSVtoRGBToRef(Ae,Re,Ie,Ne),_e.set(Ne.r,Ne.g,Ne.b,1)):_e=oe.set(Math.random(),Math.random(),Math.random(),1),Fe.color=new n.ov(_e.x,_e.y,_e.z,_e.w),this._colors.push(_e.x,_e.y,_e.z,_e.w))}}_colorFromTexture(e,t,i){if(null===e.material)return a.V.Warn(e.name+"has no material."),t._groupImageData=null,void this._setPointsColorOrUV(e,t,i,!0,!1);const r=e.material.getActiveTextures();if(0===r.length)return a.V.Warn(e.name+"has no usable texture."),t._groupImageData=null,void this._setPointsColorOrUV(e,t,i,!0,!1);const n=e.clone();n.setEnabled(!1),this._promises.push(new Promise((e=>{f.t.WhenAllReady(r,(()=>{let s=t._textureNb;s<0&&(s=0),s>r.length-1&&(s=r.length-1);const a=()=>{t._groupImgWidth=r[s].getSize().width,t._groupImgHeight=r[s].getSize().height,this._setPointsColorOrUV(n,t,i,!0,!0,void 0,void 0,r[s].coordinatesIndex),n.dispose(),e()};t._groupImageData=null;const o=r[s].readPixels();o?o.then((e=>{t._groupImageData=e,a()})):a()}))})))}_calculateDensity(e,t,i){let r,n,a,o,l,c,h,u,d,p,f,m;const _=s.Pq.Zero(),g=s.Pq.Zero(),v=s.Pq.Zero(),S=s.Pq.Zero(),x=s.Pq.Zero(),T=s.Pq.Zero();let E;const C=[];let b=0;const P=i.length/3;for(let e=0;e<P;e++)r=i[3*e],n=i[3*e+1],a=i[3*e+2],o=t[3*r],l=t[3*r+1],c=t[3*r+2],h=t[3*n],u=t[3*n+1],d=t[3*n+2],p=t[3*a],f=t[3*a+1],m=t[3*a+2],_.set(o,l,c),g.set(h,u,d),v.set(p,f,m),g.subtractToRef(_,S),v.subtractToRef(g,x),s.Pq.CrossToRef(S,x,T),E=.5*T.length(),b+=E,C[e]=b;const y=new Array(P);let A=e;for(let e=P-1;e>0;e--){const t=C[e];if(0===t)y[e]=0;else{const i=(t-C[e-1])/t*A,r=Math.floor(i),n=i-r,s=r+Number(Math.random()<n);y[e]=s,A-=s}}return y[0]=A,y}addPoints(e,t=this._randomUnitVector){const i=new u.x(this._groupCounter,t);let r,n=this.nbParticles;for(let t=0;t<e;t++)r=this._addParticle(n,i,this._groupCounter,t),i&&i._positionFunction&&i._positionFunction(r,n,t),this._positions.push(r.position.x,r.position.y,r.position.z),r.color&&this._colors.push(r.color.r,r.color.g,r.color.b,r.color.a),r.uv&&this._uvs.push(r.uv.x,r.uv.y),n++;return this.nbParticles+=e,this._groupCounter++,this._groupCounter}addSurfacePoints(e,t,i,r,s){let a=i||0;(isNaN(a)||a<0||a>3)&&(a=0);const l=e.getVerticesData(o.R.PositionKind),c=e.getIndices();this._groups.push(this._groupCounter);const h=new u.x(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(t,l,c),2===a?h._textureNb=r||0:r=r||new n.ov(1,1,1,1),a){case 2:this._colorFromTexture(e,h,!1);break;case 1:this._setPointsColorOrUV(e,h,!1,!1,!1);break;case 0:this._setPointsColorOrUV(e,h,!1);break;case 3:this._setPointsColorOrUV(e,h,!1,void 0,void 0,r,s)}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}addVolumePoints(e,t,i,r,s){let a=i||0;(isNaN(a)||a<0||a>3)&&(a=0);const l=e.getVerticesData(o.R.PositionKind),c=e.getIndices();this._groups.push(this._groupCounter);const h=new u.x(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(t,l,c),2===a?h._textureNb=r||0:r=r||new n.ov(1,1,1,1),a){case 2:this._colorFromTexture(e,h,!0);break;case 1:this._setPointsColorOrUV(e,h,!0,!1,!1);break;case 0:this._setPointsColorOrUV(e,h,!0);break;case 3:this._setPointsColorOrUV(e,h,!0,void 0,void 0,r,s)}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}setParticles(e=0,t=this.nbParticles-1,i=!0){if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(e,t,i);const r=s.AA.Matrix[0],n=this.mesh,a=this._colors32,l=this._positions32,c=this._uvs32,h=s.AA.Vector3,u=h[5].copyFromFloats(1,0,0),d=h[6].copyFromFloats(0,1,0),p=h[7].copyFromFloats(0,0,1),f=h[8].setAll(Number.MAX_VALUE),m=h[9].setAll(-Number.MAX_VALUE);s.uq.IdentityToRef(r);let _=0;if(this.mesh?.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){const e=this.mesh?.getBoundingInfo();e&&(f.copyFrom(e.minimum),m.copyFrom(e.maximum))}_=0;let g=0,v=0,S=0;for(let i=e;i<=t;i++){const e=this.particles[i];_=e.idx,g=3*_,v=4*_,S=2*_,this.updateParticle(e);const t=e._rotationMatrix,n=e.position,s=e._globalPosition;if(this._computeParticleRotation&&e.getRotationMatrix(r),null!==e.parentId){const i=this.particles[e.parentId],a=i._rotationMatrix,o=i._globalPosition,l=n.x*a[1]+n.y*a[4]+n.z*a[7],c=n.x*a[0]+n.y*a[3]+n.z*a[6],h=n.x*a[2]+n.y*a[5]+n.z*a[8];if(s.x=o.x+c,s.y=o.y+l,s.z=o.z+h,this._computeParticleRotation){const e=r.m;t[0]=e[0]*a[0]+e[1]*a[3]+e[2]*a[6],t[1]=e[0]*a[1]+e[1]*a[4]+e[2]*a[7],t[2]=e[0]*a[2]+e[1]*a[5]+e[2]*a[8],t[3]=e[4]*a[0]+e[5]*a[3]+e[6]*a[6],t[4]=e[4]*a[1]+e[5]*a[4]+e[6]*a[7],t[5]=e[4]*a[2]+e[5]*a[5]+e[6]*a[8],t[6]=e[8]*a[0]+e[9]*a[3]+e[10]*a[6],t[7]=e[8]*a[1]+e[9]*a[4]+e[10]*a[7],t[8]=e[8]*a[2]+e[9]*a[5]+e[10]*a[8]}}else if(s.x=0,s.y=0,s.z=0,this._computeParticleRotation){const e=r.m;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10]}const a=h[11];e.translateFromPivot?a.setAll(0):a.copyFrom(e.pivot);const o=h[0];o.copyFrom(e.position);const c=o.x-e.pivot.x,x=o.y-e.pivot.y,T=o.z-e.pivot.z;let E=c*t[0]+x*t[3]+T*t[6],C=c*t[1]+x*t[4]+T*t[7],b=c*t[2]+x*t[5]+T*t[8];E+=a.x,C+=a.y,b+=a.z;const P=l[g]=s.x+u.x*E+d.x*C+p.x*b,y=l[g+1]=s.y+u.y*E+d.y*C+p.y*b,A=l[g+2]=s.z+u.z*E+d.z*C+p.z*b;if(this._computeBoundingBox&&(f.minimizeInPlaceFromFloats(P,y,A),m.maximizeInPlaceFromFloats(P,y,A)),this._computeParticleColor&&e.color){const t=e.color,i=this._colors32;i[v]=t.r,i[v+1]=t.g,i[v+2]=t.b,i[v+3]=t.a}if(this._computeParticleTexture&&e.uv){const t=e.uv,i=this._uvs32;i[S]=t.x,i[S+1]=t.y}}return n&&(i&&(this._computeParticleColor&&n.updateVerticesData(o.R.ColorKind,a,!1,!1),this._computeParticleTexture&&n.updateVerticesData(o.R.UVKind,c,!1,!1),n.updateVerticesData(o.R.PositionKind,l,!1,!1)),this._computeBoundingBox&&(n.hasBoundingInfo?n.getBoundingInfo().reConstruct(f,m,n._worldMatrix):n.buildBoundingInfo(f,m,n._worldMatrix))),this.afterUpdateParticles(e,t,i),this}dispose(){this.mesh?.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh?.refreshBoundingInfo(),this}setVisibilityBox(e){if(!this.mesh)return;const t=e/2;this.mesh.buildBoundingInfo(new s.Pq(-t,-t,-t),new s.Pq(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this.mesh&&(this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e)}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(e){this._computeBoundingBox=e}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}},51478:(e,t,i)=>{i.d(t,{d:()=>n});var r=i(54983);class n{constructor(){this._hasHit=!1,this._hitNormal=r.Pq.Zero(),this._hitPoint=r.Pq.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}},51446:(e,t,i)=>{var r=i(70461),n=i(6740),s=i(43981),a=i(86521),o=i(61529),l=i(83852);a.Z.prototype.getPhysicsEngine=function(){return this._physicsEngine},a.Z.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(s.v.NAME_PHYSICSENGINE);i||(i=new c(this),this._addComponent(i));try{if(t&&1!==t?.getPluginVersion()){if(2!==t?.getPluginVersion())throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new l.A(e,t)}else this._physicsEngine=new o.A(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return r.V.Error(e.message),!1}},a.Z.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},a.Z.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},a.Z.prototype.deleteCompoundImpostor=function(e){const t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},a.Z.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){const t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class c{constructor(e){this.name=s.v.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new n.cP,this.scene.onAfterPhysicsObservable=new n.cP,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}i(15470);var h=i(34116);Object.defineProperty(h.V.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)}))))},enumerable:!0,configurable:!0}),h.V.prototype.getPhysicsBody=function(){return this.physicsBody},h.V.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this},h.V.prototype.applyAngularImpulse=function(e){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(e),this}},13493:(e,t,i)=>{i.d(t,{G:()=>s});var r=i(54983),n=i(51478);class s extends n.d{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=r.Pq.Zero(),this._rayToWorld=r.Pq.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=r.Pq.Distance(this._rayFromWorld,this._hitPoint)}reset(e=r.Pq.Zero(),t=r.Pq.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}}},88403:(e,t,i)=>{i.d(t,{v:()=>f});var r=i(54983),n=i(70461),s=i(29206),a=i(28567),o=i(59396),l=i(33543),c=i(32725),h=i(96487),u=i(13493),d=i(49111),p=i(50507);class f{constructor(e=!0,t=Ammo,i=null){this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new r.PT,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new r.Pq,this._tmpContactNormal=new r.Pq,this._tmpVec3=new r.Pq,this._tmpMatrix=new r.uq,"function"!=typeof t?(this.bjsAMMO=t,this.isSupported()?(this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=e=>{const t=(e=this.bjsAMMO.wrapPointer(e,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),i=e.m_normalWorldOnB;this._tmpContactPoint.x=t.x(),this._tmpContactPoint.y=t.y(),this._tmpContactPoint.z=t.z(),this._tmpContactNormal.x=i.x(),this._tmpContactNormal.y=i.y(),this._tmpContactNormal.z=i.z(),this._tmpContactImpulse=e.getAppliedImpulse(),this._tmpContactDistance=e.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new u.G,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)):n.V.Error("AmmoJS is not available. Please make sure you included the js file.")):n.V.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.")}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(0==t)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const e of t)e.soft||e.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const e of t)if(e.soft?this._afterSoftStep(e):e.afterStep(),e._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(e))for(const t of e._onPhysicsCollideCallbacks)for(const i of t.otherImpostors)(e.physicsBody.isActive()||i.physicsBody.isActive())&&this._isImpostorPairInContact(e,i)&&(e.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),i.onCollide({body:e.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===s.j.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let n,s,a,o,l;const u=new Array;for(let e=0;e<i;e++)n=t.at(e),s=n.get_m_x(),a=s.x(),o=s.y(),l=s.z(),u.push(new r.Pq(a,o,l));const d=e.object,p=e.getParam("shape");e._isFromLine?e.object=(0,h.sh)("lines",{points:u,instance:d}):e.object=(0,c.tF)("ext",{shape:p,path:u,instance:d})}_softbodyOrClothStep(e){const t=e.type===s.j.ClothImpostor?1:-1,i=e.object;let r=i.getVerticesData(o.R.PositionKind);r||(r=[]);let n=i.getVerticesData(o.R.NormalKind);n||(n=[]);const a=r.length/3,c=e.physicsBody.get_m_nodes();let h,u,d,p,f,m,_,g;for(let e=0;e<a;e++){h=c.at(e),u=h.get_m_x(),d=u.x(),p=u.y(),f=u.z()*t;const i=h.get_m_n();m=i.x(),_=i.y(),g=i.z()*t,r[3*e]=d,r[3*e+1]=p,r[3*e+2]=f,n[3*e]=m,n[3*e+1]=_,n[3*e+2]=g}const v=new l.P;v.positions=r,v.normals=n,v.uvs=i.getVerticesData(o.R.UVKind),v.colors=i.getVerticesData(o.R.ColorKind),i&&i.getIndices&&(v.indices=i.getIndices()),v.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)n.V.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,n=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),n.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(n,r)}}applyForce(e,t,i){if(e.soft)n.V.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,n=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const t=e.object.getWorldMatrix().getTranslation();r.setValue(i.x-t.x,i.y-t.y,i.z-t.z)}else r.setValue(i.x,i.y,i.z);n.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(n,r)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(f._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===s.j.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const r=new this.bjsAMMO.btVector3(0,0,0),n=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),n.setIdentity(),0!==i&&t.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),n.setOrigin(this._tmpAmmoVectorA),n.setRotation(this._tmpAmmoQuaternion);const a=new this.bjsAMMO.btDefaultMotionState(n),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,a,t,r),l=new this.bjsAMMO.btRigidBody(o);if(0===i&&(l.setCollisionFlags(l.getCollisionFlags()|f._KINEMATIC_FLAG),l.setActivationState(f._DISABLE_DEACTIVATION_FLAG)),e.type!=s.j.NoImpostor||t.getChildShape||l.setCollisionFlags(l.getCollisionFlags()|f._DISABLE_COLLISION_FLAG),e.type!==s.j.MeshImpostor&&e.type!==s.j.NoImpostor){const t=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(t.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const c=e.getParam("group"),h=e.getParam("mask");c&&h?this.world.addRigidBody(l,c,h):this.world.addRigidBody(l),e.physicsBody=l,e._pluginData.toDispose=e._pluginData.toDispose.concat([l,o,a,n,r,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach((e=>{this.bjsAMMO.destroy(e)})),e._pluginData.toDispose=[]))}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;if(e.joint.physicsJoint)return;const s=e.joint.jointData;let o;switch(s.mainPivot||(s.mainPivot=new r.Pq(0,0,0)),s.connectedPivot||(s.connectedPivot=new r.Pq(0,0,0)),e.joint.type){case a.W$.DistanceJoint:{const e=s.maxDistance;e&&(s.mainPivot=new r.Pq(0,-e/2,0),s.connectedPivot=new r.Pq(0,e/2,0));const n=this._tmpAmmoVectorA;n.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);const a=this._tmpAmmoVectorB;a.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(t,i,n,a);break}case a.W$.HingeJoint:{s.mainAxis||(s.mainAxis=new r.Pq(0,0,0)),s.connectedAxis||(s.connectedAxis=new r.Pq(0,0,0));const e=this._tmpAmmoVectorA;e.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);const n=this._tmpAmmoVectorB;n.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z);const a=this._tmpAmmoVectorC;a.setValue(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z);const l=this._tmpAmmoVectorD;l.setValue(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z),o=new this.bjsAMMO.btHingeConstraint(t,i,e,n,a,l);break}case a.W$.BallAndSocketJoint:{const e=this._tmpAmmoVectorA;e.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);const r=this._tmpAmmoVectorB;r.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(t,i,e,r);break}default:{n.V.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");const e=this._tmpAmmoVectorA;e.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);const r=this._tmpAmmoVectorB;r.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(t,i,e,r);break}}this.world.addConstraint(o,!e.joint.jointData.collision),e.joint.physicsJoint=o}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint),this.bjsAMMO.destroy(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let n=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let a,l=i.getVerticesData(o.R.PositionKind);if(l||(l=[]),t&&t!==i){let e;e=t.rotationQuaternion?t.rotationQuaternion:t.rotation?r.PT.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):r.PT.Identity(),r.uq.Compose(r.Pq.One(),e,t.position).invertToRef(this._tmpMatrix),a=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else r.uq.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),a=this._tmpMatrix;const c=s.length/3;for(let t=0;t<c;t++){const i=[];for(let e=0;e<3;e++){let n,o=new r.Pq(l[3*s[3*t+e]+0],l[3*s[3*t+e]+1],l[3*s[3*t+e]+2]);o=r.Pq.TransformCoordinates(o,a),n=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC,n.setValue(o.x,o.y,o.z),i.push(n)}e.addTriangle(i[0],i[1],i[2]),n++}i.getChildMeshes().forEach((i=>{n+=this._addMeshVerts(e,t,i)}))}return n}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){let e=t.getIndices();e||(e=[]);let i=t.getVerticesData(o.R.PositionKind);i||(i=[]);let n=t.getVerticesData(o.R.NormalKind);n||(n=[]),t.computeWorldMatrix(!1);const s=[],a=[];for(let e=0;e<i.length;e+=3){let o=new r.Pq(i[e],i[e+1],i[e+2]),l=new r.Pq(n[e],n[e+1],n[e+2]);o=r.Pq.TransformCoordinates(o,t.getWorldMatrix()),l=r.Pq.TransformNormal(l,t.getWorldMatrix()),s.push(o.x,o.y,o.z),a.push(l.x,l.y,l.z)}const c=new l.P;return c.positions=s,c.normals=a,c.uvs=t.getVerticesData(o.R.UVKind),c.colors=t.getVerticesData(o.R.ColorKind),t&&t.getIndices&&(c.indices=t.getIndices()),c.applyToMesh(t),t.position=r.Pq.Zero(),t.rotationQuaternion=null,t.rotation=r.Pq.Zero(),t.computeWorldMatrix(!0),c}return l.P.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const n=this._softVertexData(e),s=n.positions,a=n.normals;if(null===s||null===a)return new this.bjsAMMO.btCompoundShape;{const e=[],n=[];for(let t=0;t<s.length;t+=3){const i=new r.Pq(s[t],s[t+1],s[t+2]),o=new r.Pq(a[t],a[t+1],a[t+2]);e.push(i.x,i.y,-i.z),n.push(o.x,o.y,-o.z)}const o=(new this.bjsAMMO.btSoftBodyHelpers).CreateFromTriMesh(this.world.getWorldInfo(),e,t.getIndices(),i.length/3,!0),l=s.length/3,c=o.get_m_nodes();let h,u;for(let e=0;e<l;e++)h=c.at(e),u=h.get_m_n(),u.setX(n[3*e]),u.setY(n[3*e+1]),u.setZ(n[3*e+2]);return o}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const r=this._softVertexData(e),n=r.positions,s=r.normals;if(null===n||null===s)return new this.bjsAMMO.btCompoundShape;{const t=n.length,i=Math.sqrt(t/3);e.segments=i;const r=i-1;return this._tmpAmmoVectorA.setValue(n[0],n[1],n[2]),this._tmpAmmoVectorB.setValue(n[3*r],n[3*r+1],n[3*r+2]),this._tmpAmmoVectorD.setValue(n[t-3],n[t-2],n[t-1]),this._tmpAmmoVectorC.setValue(n[t-3-3*r],n[t-2-3*r],n[t-1-3*r]),(new this.bjsAMMO.btSoftBodyHelpers).CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,i,i,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const r=this._softVertexData(e),s=r.positions,a=r.normals;if(null===s||null===a)return new this.bjsAMMO.btCompoundShape;if(r.applyToMesh(e.object,!0),e._isFromLine=!0,0===a.map((e=>e*e)).reduce(((e,t)=>e+t)))t=s.length,i=t/3-1,this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[t-3],s[t-2],s[t-1]);else{e._isFromLine=!1;const r=e.getParam("path");if(null===e.getParam("shape"))return n.V.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=r.length,i=t-1,this._tmpAmmoVectorA.setValue(r[0].x,r[0].y,r[0].z),this._tmpAmmoVectorB.setValue(r[t-1].x,r[t-1].y,r[t-1].z)}e.segments=i;let o=e.getParam("fixedPoints");o=o>3?3:o;const l=(new this.bjsAMMO.btSoftBodyHelpers).CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,o);return l.get_m_cfg().set_collisions(17),l}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),null==t&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let n=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let a=i.getVerticesData(o.R.PositionKind);a||(a=[]),i.computeWorldMatrix(!1);const l=s.length/3;for(let t=0;t<l;t++){const o=[];for(let e=0;e<3;e++){let n,l=new r.Pq(a[3*s[3*t+e]+0],a[3*s[3*t+e]+1],a[3*s[3*t+e]+2]);r.uq.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),l=r.Pq.TransformCoordinates(l,this._tmpMatrix),n=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC,n.setValue(l.x,l.y,l.z),o.push(n)}e.addPoint(o[0],!0),e.addPoint(o[1],!0),e.addPoint(o[2],!0),n++}i.getChildMeshes().forEach((i=>{n+=this._addHullVerts(e,t,i)}))}return n}_createShape(e,t=!1){const i=e.object;let a;const o=e.getObjectExtents();if(!t){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];a=new this.bjsAMMO.btCompoundShape;let i=0;if(t.forEach((e=>{const t=e.getPhysicsImpostor();if(t){if(t.type==s.j.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const n=this._createShape(t),o=e.parent.getWorldMatrix().clone(),l=new r.Pq;o.decompose(l),this._tmpAmmoTransform.getOrigin().setValue(e.position.x*l.x,e.position.y*l.y,e.position.z*l.z),this._tmpAmmoQuaternion.setValue(e.rotationQuaternion.x,e.rotationQuaternion.y,e.rotationQuaternion.z,e.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),a.addChildShape(this._tmpAmmoTransform,n),t.dispose(),i++}})),i>0){if(e.type!=s.j.NoImpostor){const t=this._createShape(e,!0);t&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),a.addChildShape(this._tmpAmmoTransform,t))}return a}this.bjsAMMO.destroy(a),a=null}switch(e.type){case s.j.SphereImpostor:if((0,d.WithinEpsilon)(o.x,o.y,1e-4)&&(0,d.WithinEpsilon)(o.x,o.z,1e-4))a=new this.bjsAMMO.btSphereShape(o.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);const e=[this._tmpAmmoVectorA],t=[1];a=new this.bjsAMMO.btMultiSphereShape(e,t,1),this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),a.setLocalScaling(this._tmpAmmoVectorA)}break;case s.j.CapsuleImpostor:{const e=o.x/2;a=new this.bjsAMMO.btCapsuleShape(e,o.y-2*e)}break;case s.j.CylinderImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),a=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case s.j.PlaneImpostor:case s.j.BoxImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),a=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case s.j.MeshImpostor:if(0==e.getParam("mass")){if(this.onCreateCustomMeshImpostor)a=this.onCreateCustomMeshImpostor(e);else{const t=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(t);const r=this._addMeshVerts(t,i,i);a=0==r?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(t)}break}case s.j.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)a=this.onCreateCustomConvexHullImpostor(e);else{const t=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(t,i,i)?(e._pluginData.toDispose.push(t),a=new this.bjsAMMO.btCompoundShape):a=t}break;case s.j.NoImpostor:a=new this.bjsAMMO.btSphereShape(o.x/2);break;case s.j.CustomImpostor:a=this._createCustom(e);break;case s.j.SoftbodyImpostor:a=this._createSoftbody(e);break;case s.j.ClothImpostor:a=this._createCloth(e);break;case s.j.RopeImpostor:a=this._createRope(e);break;default:n.V.Warn("The impostor type is not currently supported by the ammo plugin.")}return a}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-t.x)>p.bH||Math.abs(r.getOrigin().y()-t.y)>p.bH||Math.abs(r.getOrigin().z()-t.z)>p.bH||Math.abs(r.getRotation().x()-i.x)>p.bH||Math.abs(r.getRotation().y()-i.y)>p.bH||Math.abs(r.getRotation().z()-i.z)>p.bH||Math.abs(r.getRotation().w()-i.w)>p.bH)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),0==e.mass){const t=e.physicsBody.getMotionState();t&&t.setWorldTransform(r)}else e.physicsBody.activate()}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(t=e.soft?e.physicsBody.linearVelocity():e.physicsBody.getLinearVelocity(),!t)return null;const i=new r.Pq(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(t=e.soft?e.physicsBody.angularVelocity():e.physicsBody.getAngularVelocity(),!t)return null;const i=new r.Pq(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(n.V.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===s.j.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):n.V.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(n.V.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=(t=t<0?0:t)>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):n.V.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(n.V.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):n.V.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(n.V.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):n.V.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,r,n=1,s=!1){const a=e.segments,o=Math.round((a-1)*i)+a*(a-1-Math.round((a-1)*r));e.physicsBody.appendAnchor(o,t.physicsBody,s,n)}appendHook(e,t,i,r=1,n=!1){const s=Math.round(e.segments*i);e.physicsBody.appendAnchor(s,t.physicsBody,n,r)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){n.V.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){n.V.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(e,t),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}f._DISABLE_COLLISION_FLAG=4,f._KINEMATIC_FLAG=2,f._DISABLE_DEACTIVATION_FLAG=4},61529:(e,t,i)=>{i.d(t,{A:()=>s});var r=i(54983),n=i(60299);class s{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,n.n)("CannonJSPlugin")}constructor(e,t=s.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new r.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach((function(e){e.dispose()})),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){const r=this._joints.filter((function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===e}));r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){this._impostors.forEach((e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)})),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}},15470:(e,t,i)=>{var r=i(45413),n=i(28567);Object.defineProperty(r.u.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)}))))},enumerable:!0,configurable:!0}),r.u.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},r.u.prototype.applyImpulse=function(e,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(e,t),this):this},r.u.prototype.setPhysicsLinkWith=function(e,t,i,r){return this.physicsImpostor&&e.physicsImpostor?(this.physicsImpostor.createJoint(e.physicsImpostor,n.W$.HingeJoint,{mainPivot:t,connectedPivot:i,nativeParams:r}),this):this}},83852:(e,t,i)=>{i.d(t,{A:()=>a});var r=i(54983),n=i(13493),s=i(60299);class a{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,s.n)("")}constructor(e,t=a.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new r.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){const r=new n.G;return this._physicsPlugin.raycast(e,t,r,i),r}}},87733:(e,t,i)=>{i.d(t,{b:()=>_});var r=i(86521),n=i(59396),s=i(45413),a=i(54983),o=i(94975),l=i(43981),c=i(93803),h=i(27225),u=i(39341),d=i(6740),p=i(95776),f=i(55179),m=i(18917);Object.defineProperty(r.Z.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(e){this._forceShowBoundingBoxes=e,e&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),r.Z.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new _(this)),this._boundingBoxRenderer},Object.defineProperty(s.u.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(e){this._showBoundingBox=e,e&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class _{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=l.v.NAME_BOUNDINGBOXRENDERER,this.frontColor=new u.v9(1,1,1),this.backColor=new u.v9(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new d.cP,this.onAfterBoxRenderingObservable=new d.cP,this.onResourcesReadyObservable=new d.cP,this.enabled=!0,this._shaderLanguage=0,this.renderList=new o.L(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,this.scene.getEngine().isWebGPU&&(this._shaderLanguage=1),e._addComponent(this),this._uniformBufferFront=new f.D(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!0),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new f.D(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!0),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(l.v.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(l.v.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(l.v.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(l.v.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new h.B("colorShader",this.scene,"boundingBoxRenderer",{attributes:[n.R.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,59752)),Promise.resolve().then(i.bind(i,77938))]):await Promise.all([Promise.resolve().then(i.bind(i,12726)),Promise.resolve().then(i.bind(i,56125))])}},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new h.B("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[n.R.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,59752)),Promise.resolve().then(i.bind(i,77938))]):await Promise.all([Promise.resolve().then(i.bind(i,12726)),Promise.resolve().then(i.bind(i,56125))])}},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=(0,m.KA)({size:1});this._vertexBuffers[n.R.PositionKind]=new n.R(e,t.positions,n.R.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[n.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){if(0===this.renderList.length||!this.enabled)return;if(this._prepareResources(),!this._colorShader.isReady())return;const t=this.scene.getEngine();t.setDepthWrite(!1);const i=this.scene.getTransformMatrix();for(let r=0;r<this.renderList.length;r++){const n=this.renderList.data[r];if(n._tag!==e)continue;this._createWrappersForBoundingBox(n),this.onBeforeBoxRenderingObservable.notifyObservers(n);const s=n.minimum,o=n.maximum.subtract(s),l=s.add(o.scale(.5)),h=a.uq.Scaling(o.x,o.y,o.z).multiply(a.uq.Translation(l.x,l.y,l.z)).multiply(n.getWorldMatrix()),u=t.useReverseDepthBuffer;if(this.showBackLines){const e=n._drawWrapperBack??this._colorShader._getDrawWrapper();this._colorShader._preBind(e),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?t.setDepthFunctionToLessOrEqual():t.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(e.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",h),this._uniformBufferBack.updateMatrix("viewProjection",i),this._uniformBufferBack.update(),t.drawElementsType(c.i.LineListDrawMode,0,24)}const d=n._drawWrapperFront??this._colorShader._getDrawWrapper();this._colorShader._preBind(d),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",h),this._uniformBufferFront.updateMatrix("viewProjection",i),this._uniformBufferFront.update(),t.drawElementsType(c.i.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(n)}this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new p.E(t),e._drawWrapperBack=new p.E(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const r=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,r)||!e.hasBoundingInfo)return void(t.currentRenderPassId=i);this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const n=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const s=e.getBoundingInfo().boundingBox,o=s.minimum,l=s.maximum.subtract(o),h=o.add(l.scale(.5)),u=a.uq.Scaling(l.x,l.y,l.z).multiply(a.uq.Translation(h.x,h.y,h.z)).multiply(s.getWorldMatrix()),d=r._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),n?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(c.i.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[n.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[n.R.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}},35881:(e,t,i)=>{i.d(t,{j:()=>u});var r=i(86521),n=i(6740),s=i(31780),a=i(40475),o=i(69583),l=i(57069),c=i(54983),h=i(39341);class u{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new l.g("shared gizmo light",new c.Pq(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=h.v9.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==u._DefaultUtilityLayer?u._CreateDefaultUtilityLayerFromScene(o.q.LastCreatedScene):u._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return u._DefaultUtilityLayer=new u(e),u._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{u._DefaultUtilityLayer=null})),u._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==u._DefaultKeepDepthUtilityLayer&&(u._DefaultKeepDepthUtilityLayer=new u(o.q.LastCreatedScene),u._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,u._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{u._DefaultKeepDepthUtilityLayer=null}))),u._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new n.cP,this.utilityLayerScene=new r.Z(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add((t=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&t.type!==s.Zp.POINTERMOVE&&t.type!==s.Zp.POINTERUP&&t.type!==s.Zp.POINTERDOWN&&t.type!==s.Zp.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const i=t.event;if(e.isPointerCaptured(i.pointerId))return void(this._pointerCaptures[i.pointerId]=!1);const r=i=>{let r=null;if(t.nearInteractionPickingInfo)r=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new a.G;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)r=t.originalPickingInfo;else{let n=null;this._renderCamera&&(n=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),r=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),n&&(i._activeCamera=n)}return r},n=r(this.utilityLayerScene);if(!t.ray&&n&&(t.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=s.Zp.POINTERDOWN)return t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new s.mx(t.type,t.event,n),t.type),void(t.type===s.Zp.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new s.mx(t.type,t.event,n),t.type),t.skipOnPointerObservable=!0);else{const i=r(e),a=t.event;i&&n&&(0===n.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,a),t.skipOnPointerObservable=!0):t.type===s.Zp.POINTERDOWN?this._pointerCaptures[a.pointerId]=!0:t.type!==s.Zp.POINTERMOVE&&t.type!==s.Zp.POINTERUP||(this._lastPointerEvents[a.pointerId]&&(this.onPointerOutObservable.notifyObservers(a.pointerId),delete this._lastPointerEvents[a.pointerId]),this._notifyObservers(t,i,a)):!this._pointerCaptures[a.pointerId]&&(n.distance<i.distance||0===i.distance)?(this._notifyObservers(t,n,a),t.skipOnPointerObservable||(t.skipOnPointerObservable=n.distance>0)):!this._pointerCaptures[a.pointerId]&&n.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,a),t.skipOnPointerObservable=!0):(t.type!==s.Zp.POINTERMOVE&&t.type!==s.Zp.POINTERUP||this._lastPointerEvents[a.pointerId]&&(this.onPointerOutObservable.notifyObservers(a.pointerId),delete this._lastPointerEvents[a.pointerId]),this._notifyObservers(t,n,a))),t.type===s.Zp.POINTERUP&&this._pointerCaptures[a.pointerId]&&(this._pointerCaptures[a.pointerId]=!1))}})),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add((e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add((()=>{this.dispose()})),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new s.mx(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}u._DefaultUtilityLayer=null,u._DefaultKeepDepthUtilityLayer=null},78390:(e,t,i)=>{var r=i(43862);i(12392);r.l.IncludesShadersStore.backgroundUboDeclaration="layout(std140,column_major) uniform;uniform Material\n{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};\n#include<sceneUboDeclaration>\n"},99274:(e,t,i)=>{i(43862).l.IncludesShadersStore.boundingBoxRendererUboDeclaration="#ifdef WEBGL2\nuniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#else\nlayout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};\n#endif\n"},86731:(e,t,i)=>{i.d(t,{Q:()=>s});const r="gaussianSplattingVertexDeclaration",n="attribute vec2 position;uniform mat4 view;uniform mat4 projection;uniform mat4 world;uniform vec4 vEyePosition;";i(43862).l.IncludesShadersStore[r]=n;const s={name:r,shader:n}},69291:(e,t,i)=>{i(43862).l.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}\n#endif\n#endif\n"},85793:(e,t,i)=>{i(43862).l.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }\nvec2 hammersley(uint i,uint N)\n{return vec2(float(i)/float(N),radicalInverse_VdC(i));}\n#else\nfloat vanDerCorpus(int n,int base)\n{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)\n{if(n>0)\n{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}\nreturn result;}\nvec2 hammersley(int i,int N)\n{return vec2(float(i)/float(N),vanDerCorpus(i,2));}\n#endif\nfloat log4(float x) {return log2(x)/2.;}\nvec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo\n#ifdef IBL_CDF_FILTERING\n,sampler2D icdfxSampler,sampler2D icdfySampler\n#endif\n)\n{vec3 n=normalize(inputN);vec3 result=vec3(0.0);\n#ifndef IBL_CDF_FILTERING\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);\n#endif\nfloat maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);\n#ifdef IBL_CDF_FILTERING\nvec2 T;T.x=textureCubeLodEXT(icdfxSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureCubeLodEXT(icdfySampler,vec2(T.x,Xi.y),0.0).x;T.x=1.0-fract(T.x+0.25);vec3 Ls=uv_to_normal(T);float NoL=dot(n,Ls);\n#else\nvec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);\n#endif\nif (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);\n#ifdef IBL_CDF_FILTERING\nvec3 c=textureCubeLodEXT(inputTexture,Ls,mipLevel).rgb;\n#else\nvec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#endif\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\n#ifdef IBL_CDF_FILTERING\nresult+=c*NoL;\n#else\nresult+=c;\n#endif\n}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#endif\n#endif\n"},4748:(e,t,i)=>{i(43862).l.IncludesShadersStore.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n"},53985:(e,t,i)=>{i(43862).l.IncludesShadersStore.importanceSampling="vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}"},7597:(e,t,i)=>{i(43862).l.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};"},98282:(e,t,i)=>{i.r(t),i.d(t,{packingFunctions:()=>s});const r="packingFunctions",n="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";i(43862).l.IncludesShadersStore[r]=n;const s={name:r,shader:n}},61713:(e,t,i)=>{i(43862).l.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}\nfloat getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}\nvec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nfloat cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)\n{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}\nreturn max(I,vec3(0.0));}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}\n#endif\n"},10212:(e,t,i)=>{var r=i(43862);i(12392),i(60719);r.l.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n"},85927:(e,t,i)=>{i(43862).l.IncludesShadersStore.screenSpaceRayTrace="float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nfloat linearizeDepth(float depth,float near,float far) {\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nreturn -(near*far)/(far-depth*(far-near));\n#else\nreturn (near*far)/(far-depth*(far-near));\n#endif\n}\n#endif\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera\nparam stride Step in horizontal or vertical pixels between samples. This is a float\nbecause integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPoint Camera space location of the ray hit\n*/\n#define inline\nbool traceScreenSpaceRay1(\nvec3 csOrigin,\nvec3 csDirection,\nmat4 projectToPixelMatrix,\nsampler2D csZBuffer,\nvec2 csZBufferSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nsampler2D csZBackBuffer,\nfloat csZBackSizeFactor,\n#endif\nfloat csZThickness,\nfloat nearPlaneZ,\nfloat farPlaneZ,\nfloat stride,\nfloat jitterFraction,\nfloat maxSteps,\nfloat maxRayTraceDistance,\nfloat selfCollisionNumSkip,\nout vec2 startPixel,\nout vec2 hitPixel,\nout vec3 csHitPoint,\nout float numIterations\n#ifdef SSRAYTRACE_DEBUG\n,out vec3 debugColor\n#endif\n)\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#else\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#endif\nvec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nfloat xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||\n(pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0; \npqk+=dPQK,++stepCount)\n{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nfloat t=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\n}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n(refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef ORTHOGRAPHIC_CAMERA\nndc.z=-projection[2].z*depth+projection[3].z;\n#else\nndc.z=-projection[2].z-projection[3].z/depth;\n#endif\n#else\n#ifdef ORTHOGRAPHIC_CAMERA\nndc.z=projection[2].z*depth+projection[3].z;\n#else\nndc.z=projection[2].z+projection[3].z/depth;\n#endif\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\n"},58230:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragment:()=>s});const r="shadowMapFragment",n="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";i(43862).l.IncludesShadersStore[r]=n;const s={name:r,shader:n}},11110:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragmentSoftTransparentShadow:()=>s});const r="shadowMapFragmentSoftTransparentShadow",n="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;\n#endif\n";i(43862).l.IncludesShadersStore[r]=n;const s={name:r,shader:n}},11728:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexMetric:()=>s});const r="shadowMapVertexMetric",n="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";i(43862).l.IncludesShadersStore[r]=n;const s={name:r,shader:n}},15096:(e,t,i)=>{i(43862).l.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{return diffusionProfile<1.;}"},59527:(e,t,i)=>{i.r(t),i.d(t,{anaglyphPixelShader:()=>s});const r="anaglyphPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},91724:(e,t,i)=>{i.r(t),i.d(t,{backgroundPixelShader:()=>a});var r=i(43862);r.l.IncludesShadersStore.backgroundFragmentDeclaration="uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;uniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef PROJECTED_GROUND\nuniform vec2 projectedGroundInfos;\n#endif\n",i(78390),i(60201),i(1139),i(85204),i(16802),i(6492),i(52182),i(75520),i(94021),i(38857),i(77630),i(69586),i(71288),i(10948),i(97529),i(99668);const n="backgroundPixelShader",s="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\nfloat diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }\nvec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}\nfloat sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }\nh=sqrt(h);return-b+h;}\nvec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},62841:(e,t,i)=>{i.r(t),i.d(t,{backgroundVertexShader:()=>a});var r=i(43862);r.l.IncludesShadersStore.backgroundVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",i(78390),i(60201),i(50143),i(28939),i(99966),i(70624),i(63316),i(13292),i(83034),i(38857),i(66038),i(95581),i(75159),i(85046),i(30834),i(29523),i(56403);const n="backgroundVertexShader",s="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}\nelse\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},61584:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurPixelShader:()=>s});const r="bilateralBlurPixelShader",n="uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}\nvec3 normal=textureLod(normalSampler,vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nfloat sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec3 sampleColor=textureLod(textureSampler,vUV+coords*blurDir,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords*blurDir,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords*blurDir,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nfloat r=dot(coords,coords);float w=exp(-r/two_sigma2);float depthDelta=abs(sampleDepth-depth);float wd=step(depthDelta,depthThreshold);vec3 normalDelta=abs(sampleNormal-normal);float wn=step(normalDelta.x+normalDelta.y+normalDelta.z,normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}\nglFragColor=vec4(sum/wsum,1.);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},86497:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurQualityPixelShader:()=>s});const r="bilateralBlurQualityPixelShader",n="uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}\nvec3 normal=textureLod(normalSampler,vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nfloat sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {for (int y=-filterSize; y<=filterSize; ++y) {vec2 coords=vec2(x,y)*blurDir;vec3 sampleColor=textureLod(textureSampler,vUV+coords,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nfloat r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepth-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);float rNormal=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);float wn=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}\nglFragColor=vec4(sum/wsum,1.);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},43816:(e,t,i)=>{i.r(t),i.d(t,{blackAndWhitePixelShader:()=>s});const r="blackAndWhitePixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},7180:(e,t,i)=>{i.r(t),i.d(t,{bloomMergePixelShader:()=>s});const r="bloomMergePixelShader",n="uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},56125:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererPixelShader:()=>a});var r=i(43862);r.l.IncludesShadersStore.boundingBoxRendererFragmentDeclaration="uniform vec4 color;\n",i(99274);const n="boundingBoxRendererPixelShader",s="#include<__decl__boundingBoxRendererFragment>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},12726:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererVertexShader:()=>a});var r=i(43862);r.l.IncludesShadersStore.boundingBoxRendererVertexDeclaration="uniform mat4 world;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n",i(99274);const n="boundingBoxRendererVertexShader",s="attribute vec3 position;\n#include<__decl__boundingBoxRendererVertex>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec4 worldPos=world*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},89524:(e,t,i)=>{i.r(t),i.d(t,{chromaticAberrationPixelShader:()=>s});const r="chromaticAberrationPixelShader",n="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);vec4 r=texture2D(textureSampler,ref_coords_r);vec4 g=texture2D(textureSampler,ref_coords_g);vec4 b=texture2D(textureSampler,ref_coords_b);float a=clamp(r.a+g.a+b.a,0.,1.);gl_FragColor=vec4(r.r,g.g,b.b,a);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},56650:(e,t,i)=>{i.r(t),i.d(t,{circleOfConfusionPixelShader:()=>s});const r="circleOfConfusionPixelShader",n="uniform sampler2D depthSampler;varying vec2 vUV;\n#ifndef COC_DEPTH_NOT_NORMALIZED\nuniform vec2 cameraMinMaxZ;\n#endif\nuniform float focusDistance;uniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\n#ifdef COC_DEPTH_NOT_NORMALIZED\nfloat pixelDistance=depth*1000.0;\n#else\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#endif\n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},97310:(e,t,i)=>{i.r(t),i.d(t,{colorPixelShader:()=>a});var r=i(43862);i(77630),i(69586),i(71288),i(99668);const n="colorPixelShader",s="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#include<fogFragment>(color,gl_FragColor)\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},88468:(e,t,i)=>{i.r(t),i.d(t,{colorVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(70624),i(63316),i(99966),i(66038),i(95581),i(75159),i(85046),i(30834),i(50199);const n="colorVertexShader",s="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#ifdef FOG\nuniform mat4 view;\n#endif\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},48146:(e,t,i)=>{i.r(t),i.d(t,{colorCorrectionPixelShader:()=>s});const r="colorCorrectionPixelShader",n="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;const float SLICE_COUNT=16.0; \n#define inline\nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},66229:(e,t,i)=>{i.r(t),i.d(t,{convolutionPixelShader:()=>s});const r="convolutionPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},52083:(e,t,i)=>{i.r(t),i.d(t,{copyTexture3DLayerToTexturePixelShader:()=>s});const r="copyTexture3DLayerToTexturePixelShader",n="precision highp sampler3D;uniform sampler3D textureSampler;uniform int layerNum;varying vec2 vUV;void main(void) {vec3 coord=vec3(0.0,0.0,float(layerNum));coord.xy=vec2(vUV.x,vUV.y)*vec2(textureSize(textureSampler,0).xy);vec3 color=texelFetch(textureSampler,ivec3(coord),0).rgb;gl_FragColor=vec4(color,1);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},69335:(e,t,i)=>{i.r(t),i.d(t,{copyTextureToTexturePixelShader:()=>a});var r=i(43862);i(60201);const n="copyTextureToTexturePixelShader",s="uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;\n#include<helperFunctions>\nvoid main(void) \n{vec4 color=texture2D(textureSampler,vUV);\n#ifdef DEPTH_TEXTURE\ngl_FragDepth=color.r;\n#else\nif (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}\ngl_FragColor=color;\n#endif\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},79144:(e,t,i)=>{i.r(t),i.d(t,{depthPixelShader:()=>a});var r=i(43862);i(77630),i(98282),i(71288);const n="depthPixelShader",s="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},47901:(e,t,i)=>{i.r(t),i.d(t,{depthVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(70624),i(99966);r.l.IncludesShadersStore.pointCloudVertexDeclaration="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",i(41375),i(58176),i(66038),i(95581),i(75159),i(85046),i(91999);const n="depthVertexShader",s="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},7518:(e,t,i)=>{i.r(t),i.d(t,{depthBoxBlurPixelShader:()=>s});const r="depthBoxBlurPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},4151:(e,t,i)=>{i.r(t),i.d(t,{depthOfFieldMergePixelShader:()=>s});const r="depthOfFieldMergePixelShader",n="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;\n#if BLUR_LEVEL==0\nvec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},14674:(e,t,i)=>{i.r(t),i.d(t,{displayPassPixelShader:()=>s});const r="displayPassPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(passSampler,vUV);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},91991:(e,t,i)=>{i.r(t),i.d(t,{extractHighlightsPixelShader:()=>a});var r=i(43862);i(60201);const n="extractHighlightsPixelShader",s="#include<helperFunctions>\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},25197:(e,t,i)=>{i.r(t),i.d(t,{filterPixelShader:()=>s});const r="filterPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},66984:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingBilateralBlurPixelShader:()=>s});const r="fluidRenderingBilateralBlurPixelShader",n="uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}\nint filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}\nglFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},69418:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthPixelShader:()=>s});const r="fluidRenderingParticleDepthPixelShader",n="uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying float velocityNorm;\n#endif\nvoid main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);\n#ifndef FLUIDRENDERING_RHS\nnormal.z=-normal.z;\n#endif\nvec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;\n#ifdef WEBGPU\ngl_FragDepth=clipSpacePos.z/clipSpacePos.w;\n#else\ngl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;\n#endif\n#ifdef FLUIDRENDERING_RHS\nrealViewPos.z=-realViewPos.z;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nglFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);\n#else\nglFragColor=vec4(realViewPos.z,0.,0.,1.);\n#endif\n}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},62960:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthVertexShader:()=>s});const r="fluidRenderingParticleDepthVertexShader",n="attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute vec3 velocity;varying float velocityNorm;\n#endif\nvoid main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvelocityNorm=length(velocity);\n#endif\n}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},68647:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDiffusePixelShader:()=>s});const r="fluidRenderingParticleDiffusePixelShader",n="uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},61139:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessPixelShader:()=>s});const r="fluidRenderingParticleThicknessPixelShader",n="uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},77517:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessVertexShader:()=>s});const r="fluidRenderingParticleThicknessVertexShader",n="attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},52667:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingRenderPixelShader:()=>s});const r="fluidRenderingRenderPixelShader",n="#define DISABLE_UNIFORMITY_ANALYSIS\n#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nuniform sampler2D textureSampler;uniform sampler2D depthSampler;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nuniform sampler2D diffuseSampler;\n#else\nuniform vec3 diffuseColor;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform float thickness;uniform sampler2D bgDepthSampler;\n#else\nuniform float minimumThickness;uniform sampler2D thicknessSampler;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nuniform samplerCube reflectionSampler;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nuniform sampler2D debugSampler;\n#endif\nuniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef FLUIDRENDERING_RHS\nndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#else\nndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\nvec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}\nvoid main(void) {vec2 texCoord=vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvec4 color=texture2D(debugSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nglFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}\n#else\nglFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}\n#endif\nreturn;\n#endif\nvec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nfloat thickness=texture2D(thicknessSampler,texCoord).x;\n#else\nfloat bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvec4 backColor=texture2D(textureSampler,texCoord);\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {\n#else\nif (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nglFragColor.rgb=backColor.rgb*backColor.a;glFragColor.a=backColor.a;\n#else\nglFragColor=backColor;\n#endif\nreturn;}\nvec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}\nvec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}\nvec3 normal=normalize(cross(ddy,ddx));\n#ifdef FLUIDRENDERING_RHS\nnormal=-normal;\n#endif\n#ifndef WEBGPU\nif(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nglFragColor=vec4(normal*0.5+0.5,1.0);return;\n#endif\nvec3 rayDir=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;\n#endif\nvec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nfloat diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;\n#endif\nvec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nif (transmitted.a==0.) transmitted.a=thickness;\n#endif\nvec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); \nvec3 refractionColor=transmitted.rgb*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvec3 finalColor=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfloat velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nglFragColor=vec4(finalColor,transmitted.a);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},30019:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingStandardBlurPixelShader:()=>s});const r="fluidRenderingStandardBlurPixelShader",n="uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}\nfloat sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}\nsum/=wsum;glFragColor=vec4(sum.rgb,1.);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},24295:(e,t,i)=>{i.r(t),i.d(t,{fxaaPixelShader:()=>s});const r="fxaaPixelShader",n="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;return;}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=texelSize.y;}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nfloat gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nbool doneNP=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}\nfloat dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;}\nelse\n{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},73697:(e,t,i)=>{i.r(t),i.d(t,{fxaaVertexShader:()=>s});const r="fxaaVertexShader",n="attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},26803:(e,t,i)=>{i.r(t),i.d(t,{gaussianSplattingPixelShader:()=>a});var r=i(43862);i(77630),i(38857),i(69586),i(97529),i(99668);r.l.IncludesShadersStore.gaussianSplattingFragmentDeclaration="vec4 gaussianColor(vec4 inColor)\n{float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*inColor.a;\n#include<logDepthFragment>\nvec3 color=inColor.rgb;\n#ifdef FOG\n#include<fogFragment>\n#endif\nreturn vec4(color,B);}\n",i(71288);const n="gaussianSplattingPixelShader",s="#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvarying vec4 vColor;varying vec2 vPosition;\n#include<gaussianSplattingFragmentDeclaration>\nvoid main () { \n#include<clipPlaneFragment>\ngl_FragColor=gaussianColor(vColor);}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},74092:(e,t,i)=>{i.r(t),i.d(t,{gaussianSplattingVertexShader:()=>a});var r=i(43862);i(86731),i(12392),i(60719);r.l.IncludesShadersStore.gaussianSplattingUboDeclaration="#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\nattribute vec2 position;",i(70624),i(63316),i(38857);r.l.IncludesShadersStore.gaussianSplatting="#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)\nmat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],\nmatrix[0][1],matrix[1][1],matrix[2][1],\nmatrix[0][2],matrix[1][2],matrix[2][2]);}\n#endif\nvec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}\n#if SH_DEGREE>0\nivec2 getDataUVint(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return ivec2(uint(x+0.5),uint(y+0.5));}\n#endif\nstruct Splat {vec4 center;vec4 color;vec4 covA;vec4 covB;\n#if SH_DEGREE>0\nuvec4 sh0; \n#endif\n#if SH_DEGREE>1\nuvec4 sh1;\n#endif\n#if SH_DEGREE>2\nuvec4 sh2;\n#endif\n};Splat readSplat(float splatIndex)\n{Splat splat;vec2 splatUV=getDataUV(splatIndex,dataTextureSize);splat.center=texture2D(centersTexture,splatUV);splat.color=texture2D(colorsTexture,splatUV);splat.covA=texture2D(covariancesATexture,splatUV)*splat.center.w;splat.covB=texture2D(covariancesBTexture,splatUV)*splat.center.w;\n#if SH_DEGREE>0\nivec2 splatUVint=getDataUVint(splatIndex,dataTextureSize);splat.sh0=texelFetch(shTexture0,splatUVint,0);\n#endif\n#if SH_DEGREE>1\nsplat.sh1=texelFetch(shTexture1,splatUVint,0);\n#endif\n#if SH_DEGREE>2\nsplat.sh2=texelFetch(shTexture2,splatUVint,0);\n#endif\nreturn splat;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nvec3 computeColorFromSHDegree(vec3 dir,const vec3 sh[16])\n{const float SH_C0=0.28209479;const float SH_C1=0.48860251;float SH_C2[5];SH_C2[0]=1.092548430;SH_C2[1]=-1.09254843;SH_C2[2]=0.315391565;SH_C2[3]=-1.09254843;SH_C2[4]=0.546274215;float SH_C3[7];SH_C3[0]=-0.59004358;SH_C3[1]=2.890611442;SH_C3[2]=-0.45704579;SH_C3[3]=0.373176332;SH_C3[4]=-0.45704579;SH_C3[5]=1.445305721;SH_C3[6]=-0.59004358;vec3 result=/*SH_C0**/sh[0];\n#if SH_DEGREE>0\nfloat x=dir.x;float y=dir.y;float z=dir.z;result+=- SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];\n#if SH_DEGREE>1\nfloat xx=x*x,yy=y*y,zz=z*z;float xy=x*y,yz=y*z,xz=x*z;result+=\nSH_C2[0]*xy*sh[4] +\nSH_C2[1]*yz*sh[5] +\nSH_C2[2]*(2.0f*zz-xx-yy)*sh[6] +\nSH_C2[3]*xz*sh[7] +\nSH_C2[4]*(xx-yy)*sh[8];\n#if SH_DEGREE>2\nresult+=\nSH_C3[0]*y*(3.0f*xx-yy)*sh[9] +\nSH_C3[1]*xy*z*sh[10] +\nSH_C3[2]*y*(4.0f*zz-xx-yy)*sh[11] +\nSH_C3[3]*z*(2.0f*zz-3.0f*xx-3.0f*yy)*sh[12] +\nSH_C3[4]*x*(4.0f*zz-xx-yy)*sh[13] +\nSH_C3[5]*z*(xx-yy)*sh[14] +\nSH_C3[6]*x*(xx-3.0f*yy)*sh[15];\n#endif\n#endif\n#endif\nreturn result;}\nvec4 decompose(uint value)\n{vec4 components=vec4(\nfloat((value ) & 255u),\nfloat((value>>uint( 8)) & 255u),\nfloat((value>>uint(16)) & 255u),\nfloat((value>>uint(24)) & 255u));return components*vec4(2./255.)-vec4(1.);}\nvec3 computeSH(Splat splat,vec3 color,vec3 dir)\n{vec3 sh[16];sh[0]=color;\n#if SH_DEGREE>0\nvec4 sh00=decompose(splat.sh0.x);vec4 sh01=decompose(splat.sh0.y);vec4 sh02=decompose(splat.sh0.z);sh[1]=vec3(sh00.x,sh00.y,sh00.z);sh[2]=vec3(sh00.w,sh01.x,sh01.y);sh[3]=vec3(sh01.z,sh01.w,sh02.x);\n#endif\n#if SH_DEGREE>1\nvec4 sh03=decompose(splat.sh0.w);vec4 sh04=decompose(splat.sh1.x);vec4 sh05=decompose(splat.sh1.y);sh[4]=vec3(sh02.y,sh02.z,sh02.w);sh[5]=vec3(sh03.x,sh03.y,sh03.z);sh[6]=vec3(sh03.w,sh04.x,sh04.y);sh[7]=vec3(sh04.z,sh04.w,sh05.x);sh[8]=vec3(sh05.y,sh05.z,sh05.w);\n#endif\n#if SH_DEGREE>2\nvec4 sh06=decompose(splat.sh1.z);vec4 sh07=decompose(splat.sh1.w);vec4 sh08=decompose(splat.sh2.x);vec4 sh09=decompose(splat.sh2.y);vec4 sh10=decompose(splat.sh2.z);vec4 sh11=decompose(splat.sh2.w);sh[9]=vec3(sh06.x,sh06.y,sh06.z);sh[10]=vec3(sh06.w,sh07.x,sh07.y);sh[11]=vec3(sh07.z,sh07.w,sh08.x);sh[12]=vec3(sh08.y,sh08.z,sh08.w);sh[13]=vec3(sh09.x,sh09.y,sh09.z);sh[14]=vec3(sh09.w,sh10.x,sh10.y);sh[15]=vec3(sh10.z,sh10.w,sh11.x); \n#endif\nreturn computeColorFromSHDegree(dir,sh);}\n#else\nvec3 computeSH(Splat splat,vec3 color,vec3 dir)\n{return color;}\n#endif\nvec4 gaussianSplatting(vec2 meshPos,vec3 worldPos,vec2 scale,vec3 covA,vec3 covB,mat4 worldMatrix,mat4 viewMatrix,mat4 projectionMatrix)\n{mat4 modelView=viewMatrix*worldMatrix;vec4 camspace=viewMatrix*vec4(worldPos,1.);vec4 pos2d=projectionMatrix*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds\n|| pos2d.y<-bounds || pos2d.y>bounds) {return vec4(0.0,0.0,2.0,1.0);}\nmat3 Vrk=mat3(\ncovA.x,covA.y,covA.z,\ncovA.y,covB.x,covB.y,\ncovA.z,covB.y,covB.z\n);mat3 J=mat3(\nfocal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),\n0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),\n0.,0.,0.\n);mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float lambda1=mid+radius,lambda2=mid-radius;if (lambda2<0.0)\n{return vec4(0.0,0.0,2.0,1.0);}\nvec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vec2 vCenter=vec2(pos2d);return vec4(\nvCenter \n+ ((meshPos.x*majorAxis\n+ meshPos.y*minorAxis)*invViewport*pos2d.w)*scale,pos2d.zw);}",i(85046),i(30834),i(56403);const n="gaussianSplattingVertexShader",s="#include<__decl__gaussianSplattingVertex>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\nattribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;\n#if SH_DEGREE>0\nuniform highp usampler2D shTexture0;\n#endif\n#if SH_DEGREE>1\nuniform highp usampler2D shTexture1;\n#endif\n#if SH_DEGREE>2\nuniform highp usampler2D shTexture2;\n#endif\nvarying vec4 vColor;varying vec2 vPosition;\n#include<gaussianSplatting>\nvoid main () {Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPos=world*vec4(splat.center.xyz,1.0);vColor=splat.color;vPosition=position;\n#if SH_DEGREE>0\nvec3 dir=normalize(worldPos.xyz-vEyePosition.xyz);vColor.xyz=computeSH(splat,splat.color.xyz,dir);\n#endif\ngl_Position=gaussianSplatting(position,worldPos.xyz,vec2(1.,1.),covA,covB,world,view,projection);\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},73423:(e,t,i)=>{i.r(t),i.d(t,{geometryPixelShader:()=>a});var r=i(43862);i(77630);r.l.IncludesShadersStore.mrtFragmentDeclaration="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n",i(37418),i(10305),i(60201),i(71288),i(55574);const n="geometryPixelShader",s="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\n#ifdef DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\ngl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -\n(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},75646:(e,t,i)=>{i.r(t),i.d(t,{geometryVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(99966);r.l.IncludesShadersStore.geometryVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;",i(12392);r.l.IncludesShadersStore.geometryUboDeclaration="#include<sceneUboDeclaration>\n",i(70624),i(41375),i(58176),i(66038),i(95581),i(75159),i(85046),i(6428);const n="geometryVertexShader",s="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;mat3 normalWorld=mat3(finalWorld);vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uv;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#else\nvUV=uv2;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},1938:(e,t,i)=>{i.r(t),i.d(t,{glowBlurPostProcessPixelShader:()=>s});const r="glowBlurPostProcessPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)\n{return dot(color,vec3(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)\n{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}\ngl_FragColor=baseColor;}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},72206:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationPixelShader:()=>a});var r=i(43862);i(60201),i(77630),i(71288);const n="glowMapGenerationPixelShader",s="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;uniform float glowIntensity;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor*glowIntensity;\n#else\ngl_FragColor=finalColor*glowIntensity;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},45764:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(70624),i(99966),i(41375),i(58176),i(66038),i(95581),i(75159),i(85046);const n="glowMapGenerationVertexShader",s="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;varying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;varying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;gl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},58750:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergePixelShader:()=>s});const r="glowMapMergePixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},93172:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergeVertexShader:()=>s});const r="glowMapMergeVertexShader",n="attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},29494:(e,t,i)=>{i.r(t),i.d(t,{grainPixelShader:()=>a});var r=i(43862);i(60201);const n="grainPixelShader",s="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;uniform float animatedSeed;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},76175:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringPixelShader:()=>a});var r=i(43862);i(60201),i(53985),i(61713),i(85793);const n="hdrFilteringPixelShader",s="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},12409:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringVertexShader:()=>s});const r="hdrFilteringVertexShader",n="attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nmat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},85676:(e,t,i)=>{i.r(t),i.d(t,{highlightsPixelShader:()=>s});const r="highlightsPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},82283:(e,t,i)=>{i.r(t),i.d(t,{iblCdfxPixelShader:()=>s});const r="iblCdfxPixelShader",n="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;void main(void) {ivec2 cdfyRes=textureSize(cdfy,0);ivec2 currentPixel=ivec2(gl_FragCoord.xy);float cdfx=0.0;for (int x=1; x<=currentPixel.x; x++) {cdfx+=texelFetch(cdfy,ivec2(x-1,cdfyRes.y-1),0).x;}\ngl_FragColor=vec4(vec3(cdfx),1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},31858:(e,t,i)=>{i.r(t),i.d(t,{iblCdfyPixelShader:()=>s});const r="iblCdfyPixelShader",n="precision highp sampler2D;precision highp samplerCube;\n#define PI 3.1415927\nvarying vec2 vUV;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform int iblHeight;\n#ifdef IBL_USE_CUBE_MAP\nvec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfloat fetchCube(vec2 uv) {vec3 direction=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureCubeLodEXT(iblSource,direction,0.0).rgb,\nvec3(0.3,0.6,0.1));}\n#else\nfloat fetchPanoramic(ivec2 Coords,float envmapHeight) {return sin(PI*(float(Coords.y)+0.5)/envmapHeight) *\ndot(texelFetch(iblSource,Coords,0).rgb,vec3(0.3,0.6,0.1));}\n#endif\nvoid main(void) {ivec2 coords=ivec2(gl_FragCoord.x,gl_FragCoord.y);float cdfy=0.0;for (int y=1; y<=coords.y; y++) {\n#ifdef IBL_USE_CUBE_MAP\nvec2 uv=vec2(vUV.x,(float(y-1)+0.5)/float(iblHeight));cdfy+=fetchCube(uv);\n#else\ncdfy+=fetchPanoramic(ivec2(coords.x,y-1),float(iblHeight));\n#endif\n}\ngl_FragColor=vec4(cdfy,0.0,0.0,1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},78:(e,t,i)=>{i.r(t),i.d(t,{iblCombineVoxelGridsPixelShader:()=>s});const r="iblCombineVoxelGridsPixelShader",n="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelXaxisSampler;uniform sampler3D voxelYaxisSampler;uniform sampler3D voxelZaxisSampler;uniform float layer;void main(void) {vec3 coordZ=vec3(vUV.x,vUV.y,layer);float voxelZ=texture(voxelZaxisSampler,coordZ).r;vec3 coordX=vec3(1.0-layer,vUV.y,vUV.x);float voxelX=texture(voxelXaxisSampler,coordX).r;vec3 coordY=vec3(layer,vUV.x,vUV.y);float voxelY=texture(voxelYaxisSampler,coordY).r;float voxel=(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0) ? 1.0 : 0.0;glFragColor=vec4(vec3(voxel),1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},38279:(e,t,i)=>{i.r(t),i.d(t,{iblGenerateVoxelMipPixelShader:()=>s});const r="iblGenerateVoxelMipPixelShader",n="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D srcMip;uniform int layerNum;void main(void) {ivec3 Coords=ivec3(2)*ivec3(gl_FragCoord.x,gl_FragCoord.y,layerNum);uint tex =\nuint(texelFetch(srcMip,Coords+ivec3(0,0,0),0).x>0.0f ? 1u : 0u)\n<< 0u |\nuint(texelFetch(srcMip,Coords+ivec3(1,0,0),0).x>0.0f ? 1u : 0u)\n<< 1u |\nuint(texelFetch(srcMip,Coords+ivec3(0,1,0),0).x>0.0f ? 1u : 0u)\n<< 2u |\nuint(texelFetch(srcMip,Coords+ivec3(1,1,0),0).x>0.0f ? 1u : 0u)\n<< 3u |\nuint(texelFetch(srcMip,Coords+ivec3(0,0,1),0).x>0.0f ? 1u : 0u)\n<< 4u |\nuint(texelFetch(srcMip,Coords+ivec3(1,0,1),0).x>0.0f ? 1u : 0u)\n<< 5u |\nuint(texelFetch(srcMip,Coords+ivec3(0,1,1),0).x>0.0f ? 1u : 0u)\n<< 6u |\nuint(texelFetch(srcMip,Coords+ivec3(1,1,1),0).x>0.0f ? 1u : 0u)\n<< 7u;glFragColor.rgb=vec3(float(tex)/255.0f,0.0f,0.0f);glFragColor.a=1.0;}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},35088:(e,t,i)=>{i.r(t),i.d(t,{iblIcdfxPixelShader:()=>s});const r="iblIcdfxPixelShader",n="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfx;float fetchCDF(int x) {return texelFetch(cdfx,ivec2(x,0),0).x;}\nfloat bisect(int size,float targetValue)\n{int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDF(c)<targetValue)\na=c;else\nb=c;}\nreturn mix(float(a),float(b),(targetValue-fetchCDF(a))/(fetchCDF(b)-fetchCDF(a)))/float(size-1);}\nvoid main(void) {ivec2 cdfSize=textureSize(cdfx,0);int cdfWidth=cdfSize.x;int icdfWidth=cdfWidth-1;ivec2 currentPixel=ivec2(gl_FragCoord.xy);if (currentPixel.x==0)\n{gl_FragColor=vec4(0.0);}\nelse if (currentPixel.x==icdfWidth-1) {gl_FragColor=vec4(1.0);} else {float targetValue=fetchCDF(cdfWidth-1)*vUV.x;gl_FragColor=vec4(vec3(bisect(cdfWidth,targetValue)),1.0);}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},66649:(e,t,i)=>{i.r(t),i.d(t,{iblIcdfyPixelShader:()=>s});const r="iblIcdfyPixelShader",n="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;float fetchCDF(int y,int invocationId) {return texelFetch(cdfy,ivec2(invocationId,y),0).x;}\nfloat bisect(int size,float targetValue,int invocationId)\n{int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDF(c,invocationId)<targetValue)\na=c;else\nb=c;}\nreturn mix(float(a),float(b),(targetValue-fetchCDF(a,invocationId))/(fetchCDF(b,invocationId)-fetchCDF(a,invocationId)))/float(size-1);}\nvoid main(void) {ivec2 cdfSize=textureSize(cdfy,0);int cdfHeight=cdfSize.y;ivec2 currentPixel=ivec2(gl_FragCoord.xy);if (currentPixel.y==0)\n{gl_FragColor=vec4(0.0);}\nelse if (currentPixel.y==cdfHeight-2) {gl_FragColor=vec4(1.0);} else {float targetValue=fetchCDF(cdfHeight-1,currentPixel.x)*vUV.y;gl_FragColor=vec4(vec3(bisect(cdfHeight,targetValue,currentPixel.x)),1.0);}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},69301:(e,t,i)=>{i.r(t),i.d(t,{iblShadowAccumulationPixelShader:()=>s});const r="iblShadowAccumulationPixelShader",n="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform vec4 accumulationParameters;\n#define remanence accumulationParameters.x\n#define resetb accumulationParameters.y\n#define sceneSize accumulationParameters.z\nuniform sampler2D motionSampler;uniform sampler2D positionSampler;uniform sampler2D spatialBlurSampler;uniform sampler2D oldAccumulationSampler;uniform sampler2D prevPositionSampler;vec2 max2(vec2 v,vec2 w) { return vec2(max(v.x,w.x),max(v.y,w.y)); }\nvoid main(void) {bool reset=bool(resetb);vec2 gbufferRes=vec2(textureSize(motionSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(spatialBlurSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec4 LP=texelFetch(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {gl_FragColor=vec4(1.0,0.0,0.0,1.0);return;}\nvec2 velocityColor=texelFetch(motionSampler,gbufferPixelCoord,0).xy;vec2 prevCoord=vUV+velocityColor;vec3 PrevLP=texture(prevPositionSampler,prevCoord).xyz;vec3 PrevShadows=texture(oldAccumulationSampler,prevCoord).xyz;vec2 newShadows=texelFetch(spatialBlurSampler,shadowPixelCoord,0).xy;PrevShadows.z =\n!reset && all(lessThan(abs(prevCoord-vec2(0.5)),vec2(0.5))) &&\ndistance(LP.xyz,PrevLP)<5e-2*sceneSize\n? max(PrevShadows.z/(1.0+PrevShadows.z),1.0-remanence)\n: 1.0;PrevShadows=max(vec3(0.0),PrevShadows);gl_FragColor =\nvec4(mix(PrevShadows.x,newShadows.x,PrevShadows.z),\nmix(PrevShadows.y,newShadows.y,PrevShadows.z),PrevShadows.z,1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},95859:(e,t,i)=>{i.r(t),i.d(t,{iblShadowDebugPixelShader:()=>s});const r="iblShadowDebugPixelShader",n="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D debugSampler;uniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nvoid main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 debugColour=texture2D(debugSampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {gl_FragColor.rgb=mix(debugColour.rgb,background.rgb,0.0);gl_FragColor.a=1.0;}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},22390:(e,t,i)=>{i.r(t),i.d(t,{iblShadowGBufferDebugPixelShader:()=>s});const r="iblShadowGBufferDebugPixelShader",n="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;uniform sampler2D velocitySampler;uniform vec4 sizeParams;uniform float maxDepth;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nvoid main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 backgroundColour=texture2D(textureSampler,vUV).rgba;vec4 depth=texture2D(depthSampler,vUV);vec4 worldNormal=texture2D(normalSampler,vUV);vec4 worldPosition=texture2D(positionSampler,vUV);vec4 velocityLinear=texture2D(velocitySampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=backgroundColour;} else {gl_FragColor.a=1.0;if (uv.x<=0.25) {gl_FragColor.rgb=depth.rgb;gl_FragColor.a=1.0;} else if (uv.x<=0.5) {velocityLinear.rg=velocityLinear.rg*0.5+0.5;gl_FragColor.rgb=velocityLinear.rgb;} else if (uv.x<=0.75) {gl_FragColor.rgb=worldPosition.rgb;} else {gl_FragColor.rgb=worldNormal.rgb;}}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},41025:(e,t,i)=>{i.r(t),i.d(t,{iblShadowSpatialBlurPixelShader:()=>s});const r="iblShadowSpatialBlurPixelShader",n="precision highp sampler2D;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D voxelTracingSampler;uniform vec4 blurParameters;\n#define stridef blurParameters.x\n#define worldScale blurParameters.y\nconst float weights[5]=float[5](0.0625,0.25,0.375,0.25,0.0625);const int nbWeights=5;vec2 max2(vec2 v,vec2 w) {return vec2(max(v.x,w.x),max(v.y,w.y));}\nvoid main(void)\n{vec2 gbufferRes=vec2(textureSize(depthSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(voxelTracingSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec3 N=texelFetch(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}\nfloat depth=-texelFetch(depthSampler,gbufferPixelCoord,0).x;vec3 X=vec3(0.0);for(int y=0; y<nbWeights; ++y) {for(int x=0; x<nbWeights; ++x) {ivec2 gBufferCoords=gbufferPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));ivec2 shadowCoords=shadowPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));vec2 T=texelFetch(voxelTracingSampler,shadowCoords,0).xy;float ddepth=-texelFetch(depthSampler,gBufferCoords,0).x-depth;vec3 dN=texelFetch(worldNormalSampler,gBufferCoords,0).xyz-N;float w=weights[x]*weights[y] *\nexp2(max(-1000.0/(worldScale*worldScale),-0.5) *\n(ddepth*ddepth) -\n1e1*dot(dN,dN));X+=vec3(w*T.x,w*T.y,w);}}\ngl_FragColor=vec4(X.x/X.z,X.y/X.z,1.0,1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},66674:(e,t,i)=>{i.r(t),i.d(t,{iblShadowVoxelTracingPixelShader:()=>s});const r="iblShadowVoxelTracingPixelShader",n="precision highp sampler2D;precision highp sampler3D;\n#define PI 3.1415927\nvarying vec2 vUV;\n#define DISABLE_UNIFORMITY_ANALYSIS\nuniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D blueNoiseSampler;uniform sampler2D icdfxSampler;uniform sampler2D icdfySampler;uniform sampler3D voxelGridSampler;uniform vec4 shadowParameters;\n#define SHADOWdirs shadowParameters.x\n#define SHADOWframe shadowParameters.y\n#define SHADOWenvRot shadowParameters.w\nuniform vec4 voxelBiasParameters;\n#define highestMipLevel voxelBiasParameters.z\nuniform vec4 sssParameters;\n#define SSSsamples sssParameters.x\n#define SSSstride sssParameters.y\n#define SSSmaxDistance sssParameters.z\n#define SSSthickness sssParameters.w\nuniform vec4 shadowOpacity;uniform mat4 projMtx;uniform mat4 viewMtx;uniform mat4 invProjMtx;uniform mat4 invViewMtx;uniform mat4 wsNormalizationMtx;uniform mat4 invVPMtx;\n#define PI 3.1415927\n#define GOLD 0.618034\nstruct AABB3f {vec3 m_min;vec3 m_max;};struct Ray {vec3 orig;vec3 dir;vec3 dir_rcp;float t_min;float t_max;};Ray make_ray(const vec3 origin,const vec3 direction,const float tmin,\nconst float tmax) {Ray ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}\nbool ray_box_intersection(const in AABB3f aabb,const in Ray ray,\nout float distance_near,out float distance_far) {vec3 tbot=ray.dir_rcp*(aabb.m_min-ray.orig);vec3 ttop=ray.dir_rcp*(aabb.m_max-ray.orig);vec3 tmin=min(ttop,tbot);vec3 tmax=max(ttop,tbot);distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return distance_near<=distance_far;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nstruct VoxelMarchDiagnosticInfo {float heat;ivec3 voxel_intersect_coords;};\n#endif\nuint hash(uint i) {i ^= i>>16u;i*=0x7FEB352Du;i ^= i>>15u;i*=0x846CA68Bu;i ^= i>>16u;return i;}\nfloat uint2float(uint i) {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}\nvec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nvec2 plasticSequence(const uint rstate) {return vec2(uint2float(rstate*3242174889u),\nuint2float(rstate*2447445414u));}\nfloat goldenSequence(const uint rstate) {return uint2float(rstate*2654435769u);}\nfloat distanceSquared(vec2 a,vec2 b) {vec2 diff=a-b;return dot(diff,diff);}\nvoid genTB(const vec3 N,out vec3 T,out vec3 B) {float s=N.z<0.0 ? -1.0 : 1.0;float a=-1.0/(s+N.z);float b=N.x*N.y*a;T=vec3(1.0+s*N.x*N.x*a,s*b,-s*N.x);B=vec3(b,s+N.y*N.y*a,-N.y);}\nint stack[24]; \n#define PUSH(i) stack[stackLevel++]=i; \n#define POP() stack[--stackLevel] \n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nbool anyHitVoxels(const Ray ray_vs,\nout VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {\n#else\nbool anyHitVoxels(const Ray ray_vs) {\n#endif\nvec3 invD=ray_vs.dir_rcp;vec3 D=ray_vs.dir;vec3 O=ray_vs.orig;ivec3 negD=ivec3(lessThan(D,vec3(0,0,0)));int voxel0=negD.x | negD.y<<1 | negD.z<<2;vec3 t0=-O*invD,t1=(vec3(1.0)-O)*invD;int maxLod=int(highestMipLevel);int stackLevel=0;\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nuint steps=0u;\n#endif\nPUSH(maxLod<<24);while (stackLevel>0) {int elem=POP();ivec4 Coords =\nivec4(elem & 0xFF,elem>>8 & 0xFF,elem>>16 & 0xFF,elem>>24);if (Coords.w==0) {\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvoxel_march_diagnostic_info.heat=float(steps)/24.0;\n#endif\nreturn true;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n++steps;\n#endif\nfloat invRes=exp2(float(Coords.w-maxLod));vec3 bbmin=invRes*vec3(Coords.xyz+negD);vec3 bbmax=invRes*vec3(Coords.xyz-negD+ivec3(1));vec3 mint=mix(t0,t1,bbmin);vec3 maxt=mix(t0,t1,bbmax);vec3 midt=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);int nodeMask=int(\nround(texelFetch(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;int voxelBit=voxel0;Coords.xyz=(Coords.xyz<<1)+negD;int packedCoords =\nCoords.x | Coords.y<<8 | Coords.z<<16 | Coords.w<<24;if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&\n(1<<voxelBit & nodeMask) != 0)\nPUSH(packedCoords);}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvoxel_march_diagnostic_info.heat=float(steps)/24.0;\n#endif\nreturn false;}\nfloat linearizeDepth(float depth,float near,float far) {return (near*far)/(far-depth*(far-near));}\nfloat screenSpaceShadow(vec3 csOrigin,vec3 csDirection,vec2 csZBufferSize,\nfloat nearPlaneZ,float farPlaneZ,float noise) {\n#ifdef RIGHT_HANDED\nfloat csZDir=-1.0;\n#else \nfloat csZDir=1.0;\n#endif\nfloat ssSamples=SSSsamples;float ssMaxDist=SSSmaxDistance;float ssStride=SSSstride;float ssThickness=SSSthickness;float rayLength =\ncsZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ\n? \n(nearPlaneZ-csOrigin.z)/csDirection.z\n: ssMaxDist;vec3 csEndPoint=csOrigin+rayLength*csDirection;vec4 H0=projMtx*vec4(csOrigin,1.0);vec4 H1=projMtx*vec4(csEndPoint,1.0);vec2 Z0=vec2(csOrigin.z ,1.0)/H0.w;vec2 Z1=vec2(csEndPoint.z,1.0)/H1.w;vec2 P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);vec2 P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+=vec2(distanceSquared(P0,P1)<0.0001 ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=ssStride*vec2(stepDirection,invdx*delta.y);vec2 dZ=ssStride*invdx*(Z1-Z0);float opacity=0.0;vec2 P=P0+noise*dP;vec2 Z=Z0+noise*dZ;float end=P1.x*stepDirection;float rayZMax=csZDir*Z.x/Z.y;float sceneDepth=rayZMax;Z+=dZ;for (float stepCount=0.0;opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount++,P+=dP,\nZ+=dZ) { \nivec2 coords=ivec2(permute ? P.yx : P);sceneDepth=texelFetch(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}\nfloat rayZMin=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));}\nreturn opacity;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfloat voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,\nvec2 DitherNoise,\nout VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {\n#else\nfloat voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,\nvec2 DitherNoise) {\n#endif\nfloat vxResolution=float(textureSize(voxelGridSampler,0).x);vec3 T,B;genTB(wsDirection,T,B);vec2 DitherXY=sqrt(DitherNoise.x)*vec2(cos(2.0*PI*DitherNoise.y),\nsin(2.0*PI*DitherNoise.y));float sceneScale=wsNormalizationMtx[0][0];vec3 Dithering =\n(voxelBiasParameters.x*wsNormal+voxelBiasParameters.y*wsDirection +\nDitherXY.x*T+DitherXY.y*B) /\nvxResolution;vec3 O=0.5*wsOrigin+0.5+Dithering;Ray ray_vs=make_ray(O,wsDirection,0.0,10.0);AABB3f voxel_aabb;voxel_aabb.m_min=vec3(0);voxel_aabb.m_max=vec3(1);float near,far;if (!ray_box_intersection(voxel_aabb,ray_vs,near,far))\nreturn 0.0;ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nreturn anyHitVoxels(ray_vs,voxel_march_diagnostic_info) ? 1.0f : 0.0f;\n#else\nreturn anyHitVoxels(ray_vs) ? 1.0f : 0.0f;\n#endif\n}\nvoid main(void) {uint nbDirs=uint(SHADOWdirs);uint frameId=uint(SHADOWframe);float envRot=SHADOWenvRot;vec2 Resolution=vec2(textureSize(depthSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);uint GlobalIndex=(frameId*uint(Resolution.y)+uint(currentPixel.y)) *\nuint(Resolution.x) +\nuint(currentPixel.x);vec3 N=texelFetch(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}\nfloat normalizedRotation=envRot/(2.0*PI);float depth=texelFetch(depthSampler,currentPixel,0).x;\n#ifndef IS_NDC_HALF_ZRANGE\ndepth=depth*2.0-1.0;\n#endif\nvec2 temp=(vec2(currentPixel)+vec2(0.5))*2.0/Resolution-vec2(1.0);vec4 VP=invProjMtx*vec4(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);vec3 noise=texelFetch(blueNoiseSampler,currentPixel & 0xFF,0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfloat heat=0.0f;\n#endif\nfloat shadowAccum=0.0;float specShadowAccum=0.0;float sampleWeight=0.0;for (uint i=0u; i<nbDirs; i++) {uint dirId=nbDirs*GlobalIndex+i;vec4 L;{vec2 r=plasticSequence(frameId*nbDirs+i);r=fract(r+vec2(2.0)*abs(noise.xy-vec2(0.5)));vec2 T;T.x=textureLod(icdfxSampler,vec2(r.x,0.0),0.0).x;T.y=textureLod(icdfySampler,vec2(T.x,r.y),0.0).x;T.x-=normalizedRotation;L=vec4(uv_to_normal(T),0);\n#ifndef RIGHT_HANDED\nL.z*=-1.0;\n#endif\n}\nfloat edge_tint_const=-0.001;float cosNL=dot(N,L.xyz);float opacity=cosNL<edge_tint_const ? 1.0 : 0.0;if (cosNL>edge_tint_const) {vec4 VP2=VP;VP2.y*=-1.0;vec4 unormWP=invViewMtx*VP2;vec3 WP=(wsNormalizationMtx*unormWP).xyz;vec2 vxNoise =\nvec2(uint2float(hash(dirId*2u)),uint2float(hash(dirId*2u+1u)));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nVoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,\nshadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,\nvoxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;\n#else\nopacity =\nmax(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));\n#endif\nvec3 VL=(viewMtx*L).xyz;\n#ifdef RIGHT_HANDED\nfloat nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0); \nfloat farPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0);\n#else\nfloat nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0); \nfloat farPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0);\n#endif\nfloat ssShadow=shadowOpacity.y *\nscreenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,\nabs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);shadowAccum+=min(1.0-opacity,cosNL);sampleWeight+=cosNL;vec3 VR=-(viewMtx*vec4(reflect(-L.xyz,N),0.0)).xyz;specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);}\nnoise.z=fract(noise.z+GOLD);}\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\ngl_FragColor=vec4(shadowAccum/float(sampleWeight),\nspecShadowAccum/float(sampleWeight),heat/float(sampleWeight),1.0);\n#else\ngl_FragColor=vec4(shadowAccum/float(sampleWeight),specShadowAccum/float(sampleWeight),0.0,1.0);\n#endif\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},31826:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridPixelShader:()=>s});const r="iblVoxelGridPixelShader",n="precision highp float;layout(location=0) out highp float glFragData[MAX_DRAW_BUFFERS];varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;if (normPos.z<nearPlane || normPos.z>farPlane) {discard;}\nglFragData[0]=normPos.z<nearPlane+stepSize ? 1.0 : 0.0;glFragData[1]=normPos.z>=nearPlane+stepSize && normPos.z<nearPlane+2.0*stepSize ? 1.0 : 0.0;glFragData[2]=normPos.z>=nearPlane+2.0*stepSize && normPos.z<nearPlane+3.0*stepSize ? 1.0 : 0.0;glFragData[3]=normPos.z>=nearPlane+3.0*stepSize && normPos.z<nearPlane+4.0*stepSize ? 1.0 : 0.0;\n#if MAX_DRAW_BUFFERS>4\nglFragData[4]=normPos.z>=nearPlane+4.0*stepSize && normPos.z<nearPlane+5.0*stepSize ? 1.0 : 0.0;glFragData[5]=normPos.z>=nearPlane+5.0*stepSize && normPos.z<nearPlane+6.0*stepSize ? 1.0 : 0.0;glFragData[6]=normPos.z>=nearPlane+6.0*stepSize && normPos.z<nearPlane+7.0*stepSize ? 1.0 : 0.0;glFragData[7]=normPos.z>=nearPlane+7.0*stepSize && normPos.z<nearPlane+8.0*stepSize ? 1.0 : 0.0;\n#endif\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},37224:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridVertexShader:()=>s});const r="iblVoxelGridVertexShader",n="attribute vec3 position;attribute vec3 normal;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 viewMatrix;void main(void) {gl_Position=viewMatrix*invWorldScale*world*vec4(position,1.);vNormalizedPosition.xyz=gl_Position.xyz*0.5+0.5;\n#ifdef IS_NDC_HALF_ZRANGE\ngl_Position.z=gl_Position.z*0.5+0.5;\n#endif\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},59776:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid2dArrayDebugPixelShader:()=>s});const r="iblVoxelGrid2dArrayDebugPixelShader",n="precision highp sampler2DArray;varying vec2 vUV;uniform sampler2DArray voxelTexture;uniform sampler2D textureSampler;uniform int slice;void main(void) {ivec3 size=textureSize(voxelTexture,0);float dimension=sqrt(float(size.z));vec2 samplePos=fract(vUV.xy*vec2(dimension));int sampleIndex=int(floor(vUV.x*float(dimension))+floor(vUV.y*float(dimension))*dimension);glFragColor.rgb=texture(voxelTexture,vec3(samplePos.xy,sampleIndex)).rrr;glFragColor.a=1.0;glFragColor.rgb+=texture(textureSampler,vUV.xy).rgb;}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},89346:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid3dDebugPixelShader:()=>s});const r="iblVoxelGrid3dDebugPixelShader",n="precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelTexture;uniform sampler2D voxelSlabTexture;uniform sampler2D textureSampler;uniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\nuniform float mipNumber;void main(void) {vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 voxelSlab=texture2D(voxelSlabTexture,vUV);ivec3 size=textureSize(voxelTexture,int(mipNumber));float dimension=ceil(sqrt(float(size.z)));vec2 samplePos=fract(uv.xy*vec2(dimension));int sampleIndex=int(floor(uv.x*float(dimension)) +\nfloor(uv.y*float(dimension))*dimension);float mip_separator=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}\nbool outBounds=sampleIndex>size.z-1 ? true : false;sampleIndex=clamp(sampleIndex,0,size.z-1);ivec2 samplePosInt=ivec2(samplePos.xy*vec2(size.xy));vec3 voxel=texelFetch(voxelTexture,\nivec3(samplePosInt.x,samplePosInt.y,sampleIndex),\nint(mipNumber))\n.rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {if (outBounds) {voxel=vec3(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}\nvoxel.r+=mip_separator;}\nglFragColor.rgb=mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel;glFragColor.a=1.0;}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},11589:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugPixelShader:()=>s});const r="iblVoxelSlabDebugPixelShader",n="precision highp float;varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;float chunkSize=stepSize*float(MAX_DRAW_BUFFERS);float numChunks=1.0/chunkSize;float positionInChunk=fract(normPos.z/chunkSize);float slab=floor(positionInChunk*float(MAX_DRAW_BUFFERS)) /\nfloat(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||\nnormPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {gl_FragColor=vec4(0.0,0.0,0.0,0.0);} else {gl_FragColor=vec4(slab,0.0,0.0,0.75);}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},70287:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugVertexShader:()=>s});const r="iblVoxelSlabDebugVertexShader",n="attribute vec3 position;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 cameraViewMatrix;uniform mat4 projection;uniform mat4 viewMatrix;void main(void) {vec4 worldPosition=(world*vec4(position,1.));gl_Position=projection*cameraViewMatrix*worldPosition;vNormalizedPosition=(viewMatrix*invWorldScale*worldPosition).rgb;vNormalizedPosition.xyz=vNormalizedPosition.xyz*vec3(0.5)+vec3(0.5);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},16213:(e,t,i)=>{i.r(t),i.d(t,{imageProcessingPixelShader:()=>a});var r=i(43862);i(85204),i(60201),i(94021);const n="imageProcessingPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},5481:(e,t,i)=>{i.r(t),i.d(t,{importanceSamplingDebugPixelShader:()=>s});const r="importanceSamplingDebugPixelShader",n="precision highp samplerCube;\n#define PI 3.1415927\nvarying vec2 vUV;uniform sampler2D cdfy;uniform sampler2D icdfy;uniform sampler2D cdfx;uniform sampler2D icdfx;\n#ifdef IBL_USE_CUBE_MAP\nuniform samplerCube iblSource;\n#else\nuniform sampler2D iblSource;\n#endif\nuniform sampler2D textureSampler;\n#define cdfyVSize 0.4\n#define cdfxVSize 0.1\n#define cdfyHSize 0.5\nuniform vec4 sizeParams;\n#define offsetX sizeParams.x\n#define offsetY sizeParams.y\n#define widthScale sizeParams.z\n#define heightScale sizeParams.w\n#ifdef IBL_USE_CUBE_MAP\nvec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\n#endif\nvoid main(void) {vec3 colour=vec3(0.0);vec2 uv =\nvec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec3 backgroundColour=texture2D(textureSampler,vUV).rgb;const float iblStart=1.0-cdfyVSize;const float cdfyStart=1.0-2.0*cdfyVSize;const float cdfxStart=1.0-2.0*cdfyVSize-cdfxVSize;const float icdfxStart=1.0-2.0*cdfyVSize-2.0*cdfxVSize;\n#ifdef IBL_USE_CUBE_MAP\nvec3 direction=equirectangularToCubemapDirection(\n(uv-vec2(0.0,iblStart))*vec2(1.0,1.0/cdfyVSize));vec3 iblColour=textureCubeLodEXT(iblSource,direction,0.0).rgb;\n#else\nvec3 iblColour=texture2D(iblSource,(uv-vec2(0.0,iblStart)) *\nvec2(1.0,1.0/cdfyVSize))\n.rgb;\n#endif\nfloat cdfyColour =\ntexture2D(cdfy,(uv-vec2(0.0,cdfyStart))*vec2(2.0,1.0/cdfyVSize))\n.r;float icdfyColour =\ntexture2D(icdfy,(uv-vec2(0.5,cdfyStart))*vec2(2.0,1.0/cdfyVSize))\n.r;float cdfxColour =\ntexture2D(cdfx,(uv-vec2(0.0,cdfxStart))*vec2(1.0,1.0/cdfxVSize))\n.r;float icdfxColour=texture2D(icdfx,(uv-vec2(0.0,icdfxStart)) *\nvec2(1.0,1.0/cdfxVSize))\n.r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=0.003*cdfyColour;} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=0.00003*cdfxColour;} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}\ngl_FragColor=vec4(colour,1.0);glFragColor.rgb=mix(gl_FragColor.rgb,backgroundColour,0.5);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},27905:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurPixelShader:()=>a});var r=i(43862);i(7597),i(98282);r.l.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";r.l.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";const n="kernelBlurPixelShader",s="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},27627:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurVertexShader:()=>a});var r=i(43862);i(7597);r.l.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";const n="kernelBlurVertexShader",s="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},96996:(e,t,i)=>{i.r(t),i.d(t,{layerPixelShader:()=>a});var r=i(43862);i(60201);const n="layerPixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#if defined(CONVERT_TO_GAMMA)\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#elif defined(CONVERT_TO_LINEAR)\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},25890:(e,t,i)=>{i.r(t),i.d(t,{layerVertexShader:()=>s});const r="layerVertexShader",n="attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},12155:(e,t,i)=>{i.r(t),i.d(t,{lensFlarePixelShader:()=>s});const r="lensFlarePixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);gl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},61637:(e,t,i)=>{i.r(t),i.d(t,{lensFlareVertexShader:()=>s});const r="lensFlareVertexShader",n="attribute vec2 position;uniform mat4 viewportMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=viewportMatrix*vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},83833:(e,t,i)=>{i.r(t),i.d(t,{linePixelShader:()=>a});var r=i(43862);i(77630),i(38857),i(97529),i(71288);const n="linePixelShader",s="#include<clipPlaneFragmentDeclaration>\nuniform vec4 color;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<logDepthFragment>\n#include<clipPlaneFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},64151:(e,t,i)=>{i.r(t),i.d(t,{lineVertexShader:()=>a});var r=i(43862);r.l.IncludesShadersStore.lineVertexDeclaration="uniform mat4 viewProjection;\n#define ADDITIONAL_VERTEX_DECLARATION\n",i(12392),i(60719);r.l.IncludesShadersStore.lineUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n",i(99966),i(70624),i(38857),i(66038),i(85046),i(56403);const n="lineVertexShader",s="#include<__decl__lineVertex>\n#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec4 normal;uniform float width;uniform float aspectRatio;\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nmat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#include<clipPlaneVertex>\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},98130:(e,t,i)=>{i.r(t),i.d(t,{lodPixelShader:()=>s});const r="lodPixelShader",n="#extension GL_EXT_shader_texture_lod : enable\nprecision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform sampler2D textureSampler;uniform float lod;uniform vec2 texSize;uniform int gamma;void main(void)\n{gl_FragColor=texture2DLodEXT(textureSampler,vUV,lod);if (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},88973:(e,t,i)=>{i.r(t),i.d(t,{lodCubePixelShader:()=>s});const r="lodCubePixelShader",n="precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform samplerCube textureSampler;uniform float lod;uniform int gamma;void main(void)\n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x),lod);\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x),lod);\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x),lod);\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x),lod);\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001),lod);\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001),lod);\n#endif\nif (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},12714:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererPixelShader:()=>s});const r="meshUVSpaceRendererPixelShader",n="precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}\ngl_FragColor=texture2D(textureSampler,vDecalTC);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},17808:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(99966),i(41375),i(58176),i(66038),i(95581),i(75159);const n="meshUVSpaceRendererVertexShader",s="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nvoid main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},27637:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserPixelShader:()=>s});const r="meshUVSpaceRendererFinaliserPixelShader",n="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}\nif (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}\nif (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}\nif (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}\nif (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},52511:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserVertexShader:()=>s});const r="meshUVSpaceRendererFinaliserVertexShader",n="precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},95171:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerPixelShader:()=>s});const r="meshUVSpaceRendererMaskerPixelShader",n="varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},63325:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerVertexShader:()=>s});const r="meshUVSpaceRendererMaskerVertexShader",n="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},14018:(e,t,i)=>{i.r(t),i.d(t,{motionBlurPixelShader:()=>s});const r="motionBlurPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)\n{if (i>=samplesCount)\nbreak;vec2 offset=vUV+velocity*(hlim+float(i));\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset,0.0);\n#else\nresult+=texture2D(textureSampler,offset);\n#endif\n}\ngl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset1,0.0);\n#else\nresult+=texture2D(textureSampler,offset1);\n#endif\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},47509:(e,t,i)=>{i.r(t),i.d(t,{oitBackBlendPixelShader:()=>s});const r="oitBackBlendPixelShader",n="precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { \ndiscard;}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},35075:(e,t,i)=>{i.r(t),i.d(t,{oitFinalPixelShader:()=>s});const r="oitFinalPixelShader",n="precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},47725:(e,t,i)=>{i.r(t),i.d(t,{outlinePixelShader:()=>a});var r=i(43862);i(77630),i(38857),i(71288),i(97529);const n="outlinePixelShader",s="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},57447:(e,t,i)=>{i.r(t),i.d(t,{outlineVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(70624),i(99966),i(38857),i(41375),i(58176),i(66038),i(95581),i(75159),i(85046),i(56403);const n="outlineVertexShader",s="attribute vec3 position;attribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvec3 offsetPosition=positionUpdated+(normalUpdated*offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},66726:(e,t,i)=>{i.r(t),i.d(t,{particlesPixelShader:()=>a});var r=i(43862);i(77630),i(85204),i(38857),i(60201),i(94021),i(69586),i(71288),i(97529),i(99668);const n="particlesPixelShader",s="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;uniform sampler2D rampSampler;\n#endif\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n#ifdef RAMPGRADIENT\nfloat alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nfloat sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>(color,baseColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor.rgb=toLinearSpace(baseColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);\n#endif\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},28044:(e,t,i)=>{i.r(t),i.d(t,{particlesVertexShader:()=>a});var r=i(43862);i(70624),i(63316),i(38857),i(85046),i(30834),i(56403);const n="particlesVertexShader",s="attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\n#ifndef BILLBOARD\nattribute vec3 direction;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\n#ifdef RAMPGRADIENT\nattribute vec4 remapData;\n#endif\nattribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;\n#ifdef ANIMATESHEET\nuniform vec3 particlesInfos; \n#endif\nvarying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;\n#ifdef RAMPGRADIENT\nvarying vec4 remapRanges;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvec3 row1=direction;\n#else\nvec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nmat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;\n#ifdef BILLBOARD\nvec3 rotatedCorner;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nremapRanges=remapData;\n#endif\ngl_Position=projection*vec4(viewPos,1.0);\n#else\nvec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);\n#endif\nvColor=color;\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},38752:(e,t,i)=>{i.r(t),i.d(t,{passPixelShader:()=>s});const r="passPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},18691:(e,t,i)=>{i.r(t),i.d(t,{passCubePixelShader:()=>s});const r="passCubePixelShader",n="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},85773:(e,t,i)=>{i.r(t),i.d(t,{pbrPixelShader:()=>a});var r=i(43862);i(35674),i(17390),i(70737);r.l.IncludesShadersStore.pbrFragmentDeclaration="uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#ifdef SS_DISPERSION\nuniform float dispersion;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n",i(10212),i(29544);r.l.IncludesShadersStore.pbrFragmentExtraDeclaration="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n",i(16802),i(6492),i(54370);r.l.IncludesShadersStore.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";r.l.IncludesShadersStore.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)\n#endif\n#ifdef IBL_CDF_FILTERING\nuniform sampler2D icdfxSampler;uniform sampler2D icdfySampler;\n#endif\n",i(85204),i(77630),i(38857),i(69586),i(60201),i(15096),i(53985);r.l.IncludesShadersStore.pbrHelperFunctions="#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{return square(roughness)+MINIMUMVARIANCE;}\nfloat fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#else\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}\n#endif\n",i(94021),i(75520),i(69291);r.l.IncludesShadersStore.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}";r.l.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{return max(0.,1.0-length(lightOffset)/range);}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{return 1.0/maxEps(lightDistanceSquared);}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}",i(61713),i(85793);r.l.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n";r.l.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n",i(37418),i(10305),i(1139),i(38673);r.l.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{vec3 surfaceAlbedo;float alpha;};\n#define pbr_inline\nalbedoOpacityOutParams albedoOpacityBlock(\nin vec4 vAlbedoColor\n#ifdef ALBEDO\n,in vec4 albedoTexture\n,in vec2 albedoInfos\n#endif\n#ifdef OPACITY\n,in vec4 opacityMap\n,in vec2 vOpacityInfos\n#endif\n#ifdef DETAIL\n,in vec4 detailColor\n,in vec4 vDetailInfos\n#endif\n#ifdef DECAL\n,in vec4 decalColor\n,in vec4 vDecalInfos\n#endif \n)\n{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST \n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}\n";r.l.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{float microSurface;float roughness;vec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap;\n#endif\n#ifndef FROSTBITE_REFLECTANCE\nvec3 metallicF0;\n#endif\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nreflectivityOutParams reflectivityBlock(\nin vec4 vReflectivityColor\n#ifdef METALLICWORKFLOW\n,in vec3 surfaceAlbedo\n,in vec4 metallicReflectanceFactors\n#endif\n#ifdef REFLECTIVITY\n,in vec3 reflectivityInfos\n,in vec4 surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,in vec3 ambientOcclusionColorIn\n#endif\n#ifdef MICROSURFACEMAP\n,in vec4 microSurfaceTexel\n#endif\n#ifdef DETAIL\n,in vec4 detailColor\n,in vec4 vDetailInfos\n#endif\n)\n{reflectivityOutParams outParams;float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}\n";r.l.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{vec3 ambientOcclusionColor;\n#if DEBUGMODE>0 && defined(AMBIENT)\nvec3 ambientOcclusionColorMap;\n#endif\n};ambientOcclusionOutParams ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos\n#endif\n)\n{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n";r.l.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{float alpha;};\n#define pbr_inline\nalphaFresnelOutParams alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface\n)\n{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\nreturn outParams;}\n#endif\n#endif\n";r.l.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nanisotropicOutParams anisotropicBlock(\nin vec3 vAnisotropy,\nin float roughness,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW\n)\n{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\nanisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection.rg*=anisotropyMapData.rg;\n#else\nanisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}\n#endif\n";r.l.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{vec4 environmentRadiance;vec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}\n#define pbr_inline\n#define inline\nreflectionOutParams reflectionBlock(\nin vec3 vPositionW\n,in vec3 normalW\n,in float alphaG\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,in float NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,in float roughness\n#endif\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,in vec3 vEnvironmentIrradiance\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,in mat4 reflectionMatrix\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfxSampler\n,in sampler2D icdfySampler\n#endif\n#endif\n)\n{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);sampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);vec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler,icdfySampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}\n#endif\n";r.l.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{float sheenIntensity;vec3 sheenColor;float sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 sheenEnvironmentReflectance;\n#endif\n#endif\n};\n#define pbr_inline\n#define inline\nsheenOutParams sheenBlock(\nin vec4 vSheenColor\n#ifdef SHEEN_ROUGHNESS\n,in float vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,in vec4 sheenMapRoughnessData\n#endif\n#endif\n,in float roughness\n#ifdef SHEEN_TEXTURE\n,in vec4 sheenMapData\n,in float sheenMapLevel\n#endif\n,in float reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,in vec3 baseColor\n,in vec3 surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,in float NdotV\n,in vec3 environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,in vec2 AARoughnessFactors\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n,in vec4 vLightingIntensity\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n,in vec3 reflectionCoords\n#else\n,in sampler2D reflectionSampler\n,in vec2 reflectionCoords\n#endif\n,in float NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,in float seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,in float eho\n#endif\n#endif\n)\n{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}\n#endif\n";r.l.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nmat3 TBNClearCoat;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData;\n#endif\n#ifdef REFLECTION\nvec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;\n#endif\nfloat clearCoatNdotV;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nclearcoatOutParams clearcoatBlock(\nin vec3 vPositionW\n,in vec3 geometricNormalW\n,in vec3 viewDirectionW\n,in vec2 vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,in vec4 clearCoatMapRoughnessData\n#endif\n,in vec3 specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,in vec2 clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,in vec4 vClearCoatTintParams\n,in float clearCoatColorAtDistance\n,in vec4 vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,in vec4 clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,in vec2 vClearCoatBumpInfos\n,in vec4 clearCoatBumpMapData\n,in vec2 vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,in mat3 vTBN\n#else\n,in vec2 vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,in mat4 normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,in vec3 faceNormal\n#endif\n#ifdef REFLECTION\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n,in vec4 vLightingIntensity\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,in float frontFacingMultiplier\n#endif\n)\n{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\nreturn outParams;}\n#endif\n";r.l.IncludesShadersStore.pbrBlockIridescence="struct iridescenceOutParams\n{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\niridescenceOutParams iridescenceBlock(\nin vec4 vIridescenceParams\n,in float viewAngle\n,in vec3 specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,in vec2 iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,in vec2 iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,in float NdotVUnclamped\n#ifdef CLEARCOAT_TEXTURE\n,in vec2 clearCoatMapData\n#endif\n#endif\n)\n{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}\n#endif\n";r.l.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{vec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;vec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;float translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction;vec3 refractionTransmittance;\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\n#define inline\nvec4 sampleEnvironmentRefraction(\nin float ior\n,in float thickness\n,in float refractionLOD\n,in vec3 normalW\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nreturn environmentRefraction;}\n#endif\n#define pbr_inline\n#define inline\nsubSurfaceOutParams subSurfaceBlock(\nin vec3 vSubSurfaceIntensity\n,in vec2 vThicknessParam\n,in vec4 vTintColor\n,in vec3 normalW\n,in vec3 specularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,in vec4 thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,in vec4 refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,in vec4 translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,in mat4 reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,in vec3 irradianceVector_\n#endif\n#if defined(REALTIME_FILTERING)\n,in samplerCube reflectionSampler\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfxSampler\n,in sampler2D icdfySampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,in vec3 surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in vec4 vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,in float alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,in float NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,in float roughness\n#endif\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n#ifdef SS_DISPERSION\n,in float dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,in vec3 vDiffusionDistance\n,in vec4 vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,in vec4 translucencyColorMap\n#endif\n#endif\n)\n{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=thicknessMap.a;\n#else\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=translucencyIntensityMap.a;\n#else\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\ntranslucencyColor*=translucencyColorMap;\n#endif\nvec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nfloat refraction_ior=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nfloat realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#else\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler,icdfySampler\n#endif\n);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\nreturn outParams;}\n#endif\n",i(71288);r.l.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n",i(55574);r.l.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n",i(27849);r.l.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";r.l.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";r.l.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";r.l.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";r.l.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;lightingInfo info;float shadow=1.; \nfloat aggShadow=0.;float numLights=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n",i(10948);r.l.IncludesShadersStore.pbrBlockFinalLitComponents="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";r.l.IncludesShadersStore.pbrBlockFinalUnlitComponents="vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n";r.l.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n",i(97529),i(99668);r.l.IncludesShadersStore.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";r.l.IncludesShadersStore.pbrBlockPrePass="float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\ngl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);\n#endif\n#if defined(PREPASS_VELOCITY)\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); \n#endif\nirradiance/=sqAlbedo;\n#else\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=finalColor; \n#endif\nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#elif defined(PREPASS_COLOR)\ngl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\ngl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);\n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\ngl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n",i(64040);r.l.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ngl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ngl_FragColor.rgb=vec3(microSurface);\n#elif DEBUGMODE==73\ngl_FragColor.rgb=vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ngl_FragColor.rgb=vEmissiveColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ngl_FragColor.rgb=vec3(albedoTexture.a);\n#elif DEBUGMODE==89\ngl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;\n#else\nfloat stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn;\n#endif\n}\n#endif\n";const n="pbrPixelShader",s="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityOut=albedoOpacityBlock(\nvAlbedoColor\n#ifdef ALBEDO\n,albedoTexture\n,vAlbedoInfos\n#endif\n#ifdef OPACITY\n,opacityMap\n,vOpacityInfos\n#endif\n#ifdef DETAIL\n,detailColor\n,vDetailInfos\n#endif\n#ifdef DECAL\n,decalColor\n,vDecalInfos\n#endif\n);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos\n#endif \n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\nvec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityOut=reflectivityBlock(\nvReflectivityColor\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo\n,metallicReflectanceFactors\n#endif\n#ifdef REFLECTIVITY\n,vReflectivityInfos\n,surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,aoOut.ambientOcclusionColor\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel\n#endif\n#ifdef DETAIL\n,detailColor\n,vDetailInfos\n#endif\n);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicOut=anisotropicBlock(\nvAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW \n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionOut=reflectionBlock(\nvPositionW\n,normalW\n,alphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n,reflectionSampler\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionMatrix\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler\n,icdfySampler\n#endif\n#endif\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenOut=sheenBlock(\nvSheenColor\n#ifdef SHEEN_ROUGHNESS\n,vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData\n#endif\n#endif\n,roughness\n#ifdef SHEEN_TEXTURE\n,sheenMapData\n,vSheenInfos.y\n#endif\n,reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor\n,surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV\n,environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n,vLightingIntensity\n,reflectionSampler\n,reflectionOut.reflectionCoords\n,NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho\n#endif\n#endif\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceOut=iridescenceBlock(\nvIridescenceParams\n,NdotV\n,specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#endif\n);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatOut=clearcoatBlock(\nvPositionW\n,geometricNormalW\n,viewDirectionW\n,vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData\n#endif\n,specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,vClearCoatTintParams\n,clearCoatColorAtDistance\n,vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,vClearCoatBumpInfos\n,clearCoatBumpMapData\n,vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN\n#else\n,vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal\n#endif\n#ifdef REFLECTION\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n,vLightingIntensity\n,reflectionSampler\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,(gl_FrontFacing ? 1. : -1.)\n#endif\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nvec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);\n#endif\nsubSurfaceOut=subSurfaceBlock(\nvSubSurfaceIntensity\n,vThicknessParam\n,vTintColor\n,normalW\n,specularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionOut.irradianceVector\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler\n,icdfySampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,vPositionW\n,viewDirectionW\n,view\n,vRefractionInfos\n,refractionMatrix\n,vRefractionMicrosurfaceInfos\n,vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness\n#endif\n,alphaG\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,vRefractionPosition\n,vRefractionSize\n#endif\n#ifdef SS_DISPERSION\n,dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,vDiffusionDistance\n,vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap\n#endif\n#endif\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},78979:(e,t,i)=>{i.r(t),i.d(t,{pbrVertexShader:()=>a});var r=i(43862);i(45639);r.l.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \n#ifdef ALBEDO\nuniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n",i(10212),i(92049),i(29544),i(60201),i(50143),i(28939),i(99966),i(69324),i(16612),i(69291),i(66250),i(70624),i(63316),i(13292),i(83034),i(4835),i(88822),i(38857),i(41375),i(58176),i(66038),i(95581),i(75159),i(5818),i(23729),i(42720),i(6428),i(85046),i(30834),i(29523),i(50199),i(56403);const n="pbrVertexShader",s="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},11950:(e,t,i)=>{i.r(t),i.d(t,{pickingPixelShader:()=>s});const r="pickingPixelShader",n="#if defined(INSTANCES)\nvarying vec4 vMeshID;\n#else\nuniform vec4 meshID;\n#endif\nvoid main(void) {\n#if defined(INSTANCES)\ngl_FragColor=vMeshID;\n#else\ngl_FragColor=meshID;\n#endif\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},44548:(e,t,i)=>{i.r(t),i.d(t,{pickingVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(99966),i(41375),i(58176),i(66038),i(95581),i(75159);const n="pickingVertexShader",s="attribute vec3 position;\n#if defined(INSTANCES)\nattribute vec4 instanceMeshID;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#if defined(INSTANCES)\nvarying vec4 vMeshID;\n#endif\nvoid main(void) {\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;\n#if defined(INSTANCES)\nvMeshID=instanceMeshID;\n#endif\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},53328:(e,t,i)=>{i.r(t),i.d(t,{proceduralVertexShader:()=>s});const r="proceduralVertexShader",n="attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},28606:(e,t,i)=>{i.r(t),i.d(t,{rgbdDecodePixelShader:()=>a});var r=i(43862);i(60201);const n="rgbdDecodePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},59058:(e,t,i)=>{i.r(t),i.d(t,{rgbdEncodePixelShader:()=>a});var r=i(43862);i(60201);const n="rgbdEncodePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},45198:(e,t,i)=>{i.r(t),i.d(t,{rsmFullGlobalIlluminationPixelShader:()=>s});const r="rsmFullGlobalIlluminationPixelShader",n="/**\n* The implementation is a direct application of the formula found in http:\n*/\nprecision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;\n#ifdef TRANSFORM_NORMAL\nuniform mat4 invView;\n#endif\nvec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;int width=int(rsmInfo.x);int height=int(rsmInfo.y);for (int j=0; j<height; j++) {for (int i=0; i<width; i++) {ivec2 uv=ivec2(i,j);vec3 vplPositionW=texelFetch(rsmPositionW,uv,0).xyz;vec3 vplNormalW=texelFetch(rsmNormalW,uv,0).xyz*2.0-1.0;vec3 vplFlux=texelFetch(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nfloat dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}\nreturn clamp(indirectDiffuse*intensity,0.0,1.0);}\nvoid main(void) \n{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(invView*vec4(normalW,0.)).xyz;\n#endif\ngl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},66857:(e,t,i)=>{i.r(t),i.d(t,{rsmGlobalIlluminationPixelShader:()=>s});const r="rsmGlobalIlluminationPixelShader",n="/**\n* The implementation is an application of the formula found in http:\n* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).\n*/\nprecision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform vec4 rsmInfo2;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;uniform sampler2D rsmSamples;\n#ifdef TRANSFORM_NORMAL\nuniform mat4 invView;\n#endif\nfloat mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}\nvec4 perm(vec4 x){return mod289(((x*34.0)+1.0)*x);}\nfloat noise(vec3 p){vec3 a=floor(p);vec3 d=p-a;d=d*d*(3.0-2.0*d);vec4 b=a.xxyy+vec4(0.0,1.0,0.0,1.0);vec4 k1=perm(b.xyxy);vec4 k2=perm(k1.xyxy+b.zzww);vec4 c=k2+a.zzzz;vec4 k3=perm(c);vec4 k4=perm(c+1.0);vec4 o1=fract(k3*(1.0/41.0));vec4 o2=fract(k4*(1.0/41.0));vec4 o3=o2*d.z+o1*(1.0-d.z);vec2 o4=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}\nvec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);int numSamples=int(rsmInfo.x);float radius=rsmInfo.y;float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;float angle=noise(p*rsmInfo2.x);float c=cos(angle);float s=sin(angle);for (int i=0; i<numSamples; i++) {vec3 rsmSample=texelFetch(rsmSamples,ivec2(i,0),0).xyz;float weightSquare=rsmSample.z;if (rsmInfo2.y==1.0) rsmSample.xy=vec2(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c);vec2 uv=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) continue;vec3 vplPositionW=textureLod(rsmPositionW,uv,0.).xyz;vec3 vplNormalW=textureLod(rsmNormalW,uv,0.).xyz*2.0-1.0;vec3 vplFlux=textureLod(rsmFlux,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nfloat dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}\nreturn clamp(indirectDiffuse*intensity,0.0,1.0);}\nvoid main(void) \n{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(invView*vec4(normalW,0.)).xyz;\n#endif\ngl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},27902:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2PixelShader:()=>a});var r=i(43862);i(60201),i(61713),i(85927);const n="screenSpaceReflection2PixelShader",s="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nuniform sampler2D backDepthSampler;uniform float backSizeFactor;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nuniform samplerCube envCubeSampler;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\nuniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float farPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\nfloat computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\ngl_FragColor=vec4(0.);\n#else\ngl_FragColor=colorFull;\n#endif\nreturn;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; \n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(view*vec4(csNormal,0.0)).xyz;\n#endif\nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);\n#endif\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);\n#ifdef ORTHOGRAPHIC_CAMERA\nvec3 csViewDirection=vec3(0.,0.,1.);\n#else\nvec3 csViewDirection=normalize(csPosition);\n#endif\nvec3 csReflectedVector=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpace(envColor);\n#endif\n#else\nvec3 envColor=color;\n#endif\nfloat reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;\n#ifdef SSRAYTRACE_DEBUG\nvec3 debugColor;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvec3 jitt=vec3(0.);\n#else\nfloat roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; \n#endif\nvec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nprojectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nbackSizeFactor,\n#endif\nthickness,\nnearPlaneZ,\nfarPlaneZ,\nstepSize,\njitter,\nmaxSteps,\nmaxDistance,\nselfCollisionNumSkip,\nstartPixel,\nhitPixel,\nhitPoint,\nnumIterations\n#ifdef SSRAYTRACE_DEBUG\n,debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=vec4(debugColor,1.);return;\n#endif\nvec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpace(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nfloat blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; \nfloat a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\ngl_FragColor=vec4(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,colorFull.a);\n#endif\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);\n#endif\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},7953:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShader:()=>s});const r="screenSpaceReflection2BlurPixelShader",n="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)\n{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}\nvoid main()\n{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}\nfloat blurRadius=colorFull.a*255.0; \nvec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},48746:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShader:()=>a});var r=i(43862);i(60201),i(61713),i(85927);const n="screenSpaceReflection2BlurCombinerPixelShader",s="uniform sampler2D textureSampler; \nuniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform mat4 projection;uniform mat4 invProjectionMatrix;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nuniform float nearPlaneZ;uniform float farPlaneZ;\n#endif\n#endif\nvoid main()\n{\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=texture2D(textureSampler,vUV);\n#else\nvec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);\n#endif\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,color.a);\n#endif\n}\n";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},50463:(e,t,i)=>{i.r(t),i.d(t,{shadowMapPixelShader:()=>a});var r=i(43862);i(98282);r.l.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}\nfloat bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfloat bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";r.l.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform vec2 softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;varying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n",i(77630),i(71288),i(58230);const n="shadowMapPixelShader",s="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},62697:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexShader:()=>a});var r=i(43862);i(50143),i(28939),i(4835),i(88822),i(60201);r.l.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;\n";r.l.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;uniform float visibility;\n";r.l.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n",i(12392),i(60719);r.l.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";r.l.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n",i(70624),i(41375),i(58176),i(66038),i(95581),i(75159);r.l.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n",i(11728),i(85046);const n="shadowMapVertexShader",s="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},1442:(e,t,i)=>{i.r(t),i.d(t,{sharpenPixelShader:()=>s});const r="sharpenPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},49481:(e,t,i)=>{i.r(t),i.d(t,{spritesPixelShader:()=>a});var r=i(43862);i(69586),i(38857),i(97529),i(99668),i(4748);const n="spritesPixelShader",s="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;\n#include<fogFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#ifdef PIXEL_PERFECT\nvec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}\n#endif\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#ifdef PIXEL_PERFECT\nvec2 uv=uvPixelPerfect(vUV);\n#else\nvec2 uv=vUV;\n#endif\nvec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)\n{if (color.a<0.95)\ndiscard;}\ncolor*=vColor;\n#include<logDepthFragment>\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},18467:(e,t,i)=>{i.r(t),i.d(t,{spritesVertexShader:()=>a});var r=i(43862);i(63316),i(38857),i(56403);const n="spritesVertexShader",s="attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); \nvColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStore[n]=s;const a={name:n,shader:s}},30327:(e,t,i)=>{i.r(t),i.d(t,{ssao2PixelShader:()=>s});const r="ssao2PixelShader",n="precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()\n{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}\n#endif\n#ifdef BLUR\nuniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\n#define inline\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\nvoid main()\n{float result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)\n{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}\n#endif\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},31134:(e,t,i)=>{i.r(t),i.d(t,{ssaoCombinePixelShader:()=>s});const r="ssaoCombinePixelShader",n="uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},37489:(e,t,i)=>{i.r(t),i.d(t,{taaPixelShader:()=>s});const r="taaPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;uniform float factor;void main() {vec4 c=texelFetch(textureSampler,ivec2(gl_FragCoord.xy),0);vec4 h=texelFetch(historySampler,ivec2(gl_FragCoord.xy),0);gl_FragColor=mix(h,c,factor);}\n";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},44053:(e,t,i)=>{i.r(t),i.d(t,{tonemapPixelShader:()=>s});const r="tonemapPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{return dot(c,vec3(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},18842:(e,t,i)=>{i.r(t),i.d(t,{vrDistortionCorrectionPixelShader:()=>s});const r="vrDistortionCorrectionPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}";i(43862).l.ShadersStore[r]=n;const s={name:r,shader:n}},47447:(e,t,i)=>{var r=i(43862);i(31371);r.l.IncludesShadersStoreWGSL.backgroundUboDeclaration="uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos: vec2f;uniform vReflectionInfos: vec2f;uniform diffuseMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;\n#include<sceneUboDeclaration>\n"},98374:(e,t,i)=>{i(43862).l.IncludesShadersStoreWGSL.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nfn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00\n+ uniforms.vSphericalL1_1*(normal.y)\n+ uniforms.vSphericalL10*(normal.z)\n+ uniforms.vSphericalL11*(normal.x)\n+ uniforms.vSphericalL2_2*(normal.y*normal.x)\n+ uniforms.vSphericalL2_1*(normal.y*normal.z)\n+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ uniforms.vSphericalL21*(normal.z*normal.x)\n+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nfn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}\n#endif\n#endif\n"},97670:(e,t,i)=>{i(43862).l.IncludesShadersStoreWGSL.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\nfn radicalInverse_VdC(value: u32)->f32 \n{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }\nfn hammersley(i: u32,N: u32)->vec2f\n{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}\nfn log4(x: f32)->f32 {return log2(x)/2.;}\nconst NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler: texture_2d<f32>,icdfxSamplerSampler: sampler,icdfySampler: texture_2d<f32>,icdfySamplerSampler: sampler\n#endif\n)->vec3f\n{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);\n#ifndef IBL_CDF_FILTERING\nvar tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);\n#endif\nvar maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);\n#ifdef IBL_CDF_FILTERING\nvar T: vec2f;T.x=textureSampleLevel(icdfxSampler,icdfxSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfySampler,icdfySamplerSampler,vec2(T.x,Xi.y),0.0).x;T.x=1.0-fract(T.x+0.25);vec3 Ls=uv_to_normal(T);float NoL=dot(n,Ls);\n#else\nvar Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);\n#endif\nif (NoL>0.) {var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);\n#ifdef IBL_CDF_FILTERING\nvar c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,mipLevel).rgb;\n#else\nvar c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;\n#endif\n#ifdef GAMMA_INPUT\nc=toLinearSpaceVec3(c);\n#endif\n#ifdef IBL_CDF_FILTERING\nresult+=c*NoL;\n#else\nresult+=c;\n#endif\n}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}\nfn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f\n{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#endif\n#endif\n"},14892:(e,t,i)=>{i(43862).l.IncludesShadersStoreWGSL.importanceSampling="fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nfn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nfn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { \nvar phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}"},28843:(e,t,i)=>{i(43862).l.IncludesShadersStoreWGSL.kernelBlurVaryingDeclaration="varying sampleCoord{X}: vec2f;"},79643:(e,t,i)=>{i.r(t),i.d(t,{packingFunctionsWGSL:()=>s});const r="packingFunctions",n="fn pack(depth: f32)->vec4f\n{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";i(43862).l.IncludesShadersStoreWGSL[r]=n;const s={name:r,shader:n}},20192:(e,t,i)=>{i(43862).l.IncludesShadersStoreWGSL.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nfn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nfn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);\n#endif\nreturn brdfLookup.rgb;}\nfn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nfn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32\n{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nfn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nfn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nfn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nfn getR0RemappedForClearCoat(f0: vec3f)->vec3f {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvar s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst XYZ_TO_REC709: mat3x3f= mat3x3f(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nfn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}\nfn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}\nfn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}\nfn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nvar cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}\nvar phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); \nvar R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}\nif (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}\nif (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}\nvar opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)\n{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}\nreturn max(I, vec3f(0.0));}\n#endif\nfn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32\n{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32\n{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {\n#ifdef MOBILE\nvar GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nvar a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nvar alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfn l(x: f32,alphaG: f32)->f32\n{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfn lambdaSheen(cosTheta: f32,alphaG: f32)->f32\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nfn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}\n#endif\n"},23391:(e,t,i)=>{var r=i(43862);i(31371),i(90270);r.l.IncludesShadersStoreWGSL.pbrUboDeclaration="uniform vAlbedoInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionColor: vec3f;uniform vAlbedoColor: vec4f;uniform vLightingIntensity: vec4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n"},38520:(e,t,i)=>{i(43862).l.IncludesShadersStoreWGSL.screenSpaceRayTrace="fn distanceSquared(a: vec2f,b: vec2f)->f32 { \nvar temp=a-b; \nreturn dot(temp,temp); }\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nfn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nreturn -(near*far)/(far-depth*(far-near));\n#else\nreturn (near*far)/(far-depth*(far-near));\n#endif\n}\n#endif\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera. Should be the actual near plane if screen-space depth is enabled.\nparam farPlaneZ The far plane for the camera. Used when screen-space depth is enabled.\nparam stride Step in horizontal or vertical pixels between samples. This is a var because: f32 integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avar self: voidnull collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPovar Camera: i32 space location of the ray hit\n*/\nfn traceScreenSpaceRay1(\ncsOrigin: vec3f,\ncsDirection: vec3f,\nprojectToPixelMatrix: mat4x4f,\ncsZBuffer: texture_2d<f32>,\ncsZBufferSize: vec2f,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\ncsZBackBuffer: texture_2d<f32>,\ncsZBackSizeFactor: f32,\n#endif\ncsZThickness: f32,\nnearPlaneZ: f32,\nfarPlaneZ: f32,\nstride: f32,\njitterFraction: f32,\nmaxSteps: f32,\nmaxRayTraceDistance: f32,\nselfCollisionNumSkip: f32,\nstartPixel: ptr<function,vec2f>,\nhitPixel: ptr<function,vec2f>,\ncsHitPoint: ptr<function,vec3f>,\nnumIterations: ptr<function,f32>\n#ifdef SSRAYTRACE_DEBUG\n,debugColor: ptr<function,vec3f>\n#endif\n)->bool\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nvar rayLength: f32=select(maxRayTraceDistance,(-nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ);\n#else\nvar rayLength: f32=select(maxRayTraceDistance,(nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ);\n#endif\nvar csEndPoint: vec3f=csOrigin+csDirection*rayLength;*hitPixel= vec2f(-1.0,-1.0);var H0: vec4f=projectToPixelMatrix* vec4f(csOrigin,1.0);var H1: vec4f=projectToPixelMatrix* vec4f(csEndPoint,1.0);var k0: f32=1.0/H0.w;var k1: f32=1.0/H1.w;var Q0: vec3f=csOrigin*k0;var Q1: vec3f=csEndPoint*k1;var P0: vec2f=H0.xy*k0;var P1: vec2f=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nvar xMax: f32=csZBufferSize.x-0.5;var xMin=0.5;var yMax=csZBufferSize.y-0.5;var yMin=0.5;var alpha: f32=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-select(yMin,yMax,(P1.y>yMax)))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-select(xMin,xMax,(P1.x>xMax)))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nvar stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f= vec2f(stepDirection,delta.y*invdx);var dQ: vec3f=(Q1-Q0)*invdx;var dk: f32=(k1-k0)*invdx;var zMin: f32=min(csEndPoint.z,csOrigin.z);var zMax: f32=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;var pqk: vec4f= vec4f(P0,Q0.z,k0);var dPQK: vec4f= vec4f(dP,dQ.z,dk);*startPixel=select(P0.xy,P0.yx,permute);var prevZMaxEstimate: f32=csOrigin.z;var rayZMin: f32=prevZMaxEstimate;var rayZMax=prevZMaxEstimate;var sceneZMax: f32=rayZMax+1e4;var end: f32=P1.x*stepDirection;var hit: bool=false;var stepCount: f32;for (stepCount=0.0;(stepCount<=selfCollisionNumSkip) ||\n((pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0);pqk+=dPQK \n)\n{*hitPixel=select(pqk.xy,pqk.yx,permute);rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nvar t: f32=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\nstepCount+=1.0;}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;var invStride: f32=1.0/stride;dPQK*=invStride;var refinementStepCount: f32=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n((refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0));pqk+=dPQK)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);*hitPixel=select(pqk.xy,pqk.yx,permute);sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\nrefinementStepCount+=1.0;}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0=vec3f(Q0.xy+dQ.xy*stepCount,pqk.z);*csHitPoint=Q0/pqk.w;*numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {*debugColor= vec3f(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {*debugColor= vec3f(1,0,0);} else if (sceneZMax==0.0) {*debugColor= vec3f(1,1,0);} else {*debugColor= vec3f(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nfn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32,projection: mat4x4f,invProjectionMatrix: mat4x4f)->vec3f {var xy=texCoord*2.0-1.0;var z: f32;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef ORTHOGRAPHIC_CAMERA\nz=-projection[2].z*depth+projection[3].z;\n#else\nz=-projection[2].z-projection[3].z/depth;\n#endif\n#else\n#ifdef ORTHOGRAPHIC_CAMERA\nz=projection[2].z*depth+projection[3].z;\n#else\nz=projection[2].z+projection[3].z/depth;\n#endif\n#endif\nvar w=1.0;var ndc=vec4f(xy,z,w);var eyePos: vec4f=invProjectionMatrix*ndc;var result=eyePos.xyz/eyePos.w;return result;}\n"},43605:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragmentWGSL:()=>s});const r="shadowMapFragment",n="var depthSM: f32=fragmentInputs.vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\ndepthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nfragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\nfragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\nfragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);\n#else\nfragmentOutputs.color=pack(depthSM);\n#endif\n";i(43862).l.IncludesShadersStoreWGSL[r]=n;const s={name:r,shader:n}},94563:(e,t,i)=>{i.r(t),i.d(t,{shadowMapFragmentSoftTransparentShadowWGSL:()=>s});const r="shadowMapFragmentSoftTransparentShadow",n="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}\n#endif\n";i(43862).l.IncludesShadersStoreWGSL[r]=n;const s={name:r,shader:n}},81635:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexMetricWGSL:()=>s});const r="shadowMapVertexMetric",n="#if SM_USEDISTANCE==1\nvertexOutputs.vPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#else\nvertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\nvertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n";i(43862).l.IncludesShadersStoreWGSL[r]=n;const s={name:r,shader:n}},42054:(e,t,i)=>{i.r(t),i.d(t,{anaglyphPixelShaderWGSL:()=>s});const r="anaglyphPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var leftSamplerSampler: sampler;var leftSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var leftFrag: vec4f=textureSample(leftSampler,leftSamplerSampler,input.vUV);leftFrag= vec4f(1.0,leftFrag.g,leftFrag.b,1.0);var rightFrag: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);rightFrag= vec4f(rightFrag.r,1.0,1.0,1.0);fragmentOutputs.color= vec4f(rightFrag.rgb*leftFrag.rgb,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},8846:(e,t,i)=>{i.r(t),i.d(t,{backgroundPixelShaderWGSL:()=>a});var r=i(43862);i(47447),i(68458),i(44338),i(93673),i(10879),i(6529),i(32889),i(76224),i(26774),i(24595),i(59939),i(72207),i(49979),i(46112),i(71743);const n="backgroundPixelShader",s="#include<backgroundUboDeclaration>\n#include<helperFunctions>\nvarying vPositionW: vec3f;\n#ifdef MAINUV1\nvarying vMainUV1: vec2f;\n#endif \n#ifdef MAINUV2 \nvarying vMainUV2: vec2f; \n#endif \n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vDiffuseUV: vec2f;\n#endif\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef TEXTURELODSUPPORT\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef TEXTURELODSUPPORT\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nfn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\nfn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }\nvar o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}\nfn sphereIntersect(ro: vec3f,rd: vec3f,ra: f32)->f32 {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return -1.0; }\nh=sqrt(h);return-b+h;}\nfn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersect(eyePosition,camDir,radius);var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersect(upEyePosition,p,radius);var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);\n#ifdef NORMAL\nvar normalW: vec3f=normalize(fragmentInputs.vNormalW);\n#else\nvar normalW: vec3f= vec3f(0.0,1.0,0.0);\n#endif\nvar shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvar reflectionColor: vec4f= vec4f(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvar reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;\n#else\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f=reflectionVector;\n#else\nvar reflectionCoords: vec2f=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nvar reflectionLOD: f32=uniforms.vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#else\nvar lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\ntextureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\ntextureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvar reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);\n#endif\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);\n#endif\nvar diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;\n#ifdef DIFFUSE\nvar diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);\n#endif\ndiffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvar colorBase: vec3f=diffuseColor;\n#else\nvar colorBase: vec3f=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,vec3f(0.0));\n#ifdef USERGBCOLOR\nvar finalColor: vec3f=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvar mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);\n#else\nvar mainColor: vec3f=uniforms.vPrimaryColor.rgb;\n#endif\nvar finalColor: vec3f=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvar reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nvar reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nvar viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);\n#endif\nvar color: vec4f= vec4f(finalColor,finalAlpha);\n#else\nvar color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor=vec4f(color.rgb *color.a,color.a);\n#endif\n#ifdef NOISE\ncolor=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));\n#endif\nfragmentOutputs.color=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},93220:(e,t,i)=>{i.r(t),i.d(t,{backgroundVertexShaderWGSL:()=>a});var r=i(43862);i(47447),i(68458),i(97346),i(82600),i(90483),i(45737),i(96601),i(46225),i(26774),i(9929),i(36674),i(32910),i(22713),i(78025),i(95988),i(98830);const n="backgroundVertexShader",s="#include<backgroundUboDeclaration>\n#include<helperFunctions>\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#ifdef MAINUV1\nvarying vMainUV1: vec2f;\n#endif\n#ifdef MAINUV2\nvarying vMainUV2: vec2f;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vDiffuseUV: vec2f;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=input.position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}\n#else\nvertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);\n#endif\nvar worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef NORMAL\nvar normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*input.normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nvar screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvar uv: vec2f=vec2f(0.,0.);\n#else\nvar uv=input.uv;\n#endif\n#ifndef UV2\nvar uv2: vec2f=vec2f(0.,0.);\n#else\nvar uv2=input.uv2;\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (uniforms.vDiffuseInfos.x==0.)\n{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}\nelse\n{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvertexOutputs.vColor=vertexInputs.color;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},1747:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurPixelShaderWGSL:()=>s});const r="bilateralBlurPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}\nvar normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nvar sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords=vec2f(f32(x));var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nvar r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var depthDelta: f32=abs(sampleDepth-depth);var wd: f32=step(depthDelta,uniforms.depthThreshold);var normalDelta: vec3f=abs(sampleNormal-normal);var wn: f32=step(normalDelta.x+normalDelta.y+normalDelta.z,uniforms.normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}\nfragmentOutputs.color= vec4f(sum/wsum,1.);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},18272:(e,t,i)=>{i.r(t),i.d(t,{bilateralBlurQualityPixelShaderWGSL:()=>s});const r="bilateralBlurQualityPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}\nvar normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;\n#ifdef DECODE_NORMAL\nnormal=normal*2.0-1.0;\n#endif\nvar sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {for (var y: i32=-uniforms.filterSize; y<=uniforms.filterSize; y++) {var coords: vec2f= vec2f(f32(x),f32(y))*uniforms.blurDir;var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords,0.).rgb;\n#ifdef DECODE_NORMAL\nsampleNormal=sampleNormal*2.0-1.0;\n#endif\nvar r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepth-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);var rNormal: f32=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);var wn: f32=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}\nfragmentOutputs.color= vec4f(sum/wsum,1.);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},34203:(e,t,i)=>{i.r(t),i.d(t,{blackAndWhitePixelShaderWGSL:()=>s});const r="blackAndWhitePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform degree: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var luminance: f32=dot(color, vec3f(0.3,0.59,0.11)); \nvar blackAndWhite: vec3f= vec3f(luminance,luminance,luminance);fragmentOutputs.color= vec4f(color-((color-blackAndWhite)*uniforms.degree),1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},96561:(e,t,i)=>{i.r(t),i.d(t,{bloomMergePixelShaderWGSL:()=>s});const r="bloomMergePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var bloomBlurSampler: sampler;var bloomBlur: texture_2d<f32>;uniform bloomWeight: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var blurred: vec3f=textureSample(bloomBlur,bloomBlurSampler,input.vUV).rgb;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+(blurred.rgb*uniforms.bloomWeight),fragmentOutputs.color.a);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},77938:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererPixelShaderWGSL:()=>s});const r="boundingBoxRendererPixelShader",n="uniform color: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},59752:(e,t,i)=>{i.r(t),i.d(t,{boundingBoxRendererVertexShaderWGSL:()=>s});const r="boundingBoxRendererVertexShader",n="attribute position: vec3f;uniform world: mat4x4f;uniform viewProjection: mat4x4f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar worldPos: vec4f=uniforms.world* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},80223:(e,t,i)=>{i.r(t),i.d(t,{chromaticAberrationPixelShaderWGSL:()=>s});const r="chromaticAberrationPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform chromatic_aberration: f32;uniform radialIntensity: f32;uniform direction: vec2f;uniform centerPosition: vec2f;uniform screen_width: f32;uniform screen_height: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var centered_screen_pos: vec2f= vec2f(input.vUV.x-uniforms.centerPosition.x,input.vUV.y-uniforms.centerPosition.y);var directionOfEffect: vec2f=uniforms.direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nvar radius2: f32=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;var radius: f32=sqrt(radius2);var ref_indices: vec3f= vec3f(-0.3,0.0,0.3);var ref_shiftX: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.x/uniforms.screen_width;var ref_shiftY: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.y/uniforms.screen_height;var ref_coords_r: vec2f=vec2f(input.vUV.x+ref_indices.r*ref_shiftX,input.vUV.y+ref_indices.r*ref_shiftY*0.5);var ref_coords_g: vec2f=vec2f(input.vUV.x+ref_indices.g*ref_shiftX,input.vUV.y+ref_indices.g*ref_shiftY*0.5);var ref_coords_b: vec2f=vec2f(input.vUV.x+ref_indices.b*ref_shiftX,input.vUV.y+ref_indices.b*ref_shiftY*0.5);var r=textureSample(textureSampler,textureSamplerSampler,ref_coords_r);var g=textureSample(textureSampler,textureSamplerSampler,ref_coords_g);var b=textureSample(textureSampler,textureSamplerSampler,ref_coords_b);var a=clamp(r.a+g.a+b.a,0.,1.);fragmentOutputs.color=vec4f(r.r,g.g,b.b,a);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},61565:(e,t,i)=>{i.r(t),i.d(t,{circleOfConfusionPixelShaderWGSL:()=>s});const r="circleOfConfusionPixelShader",n="varying vUV: vec2f;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifndef COC_DEPTH_NOT_NORMALIZED\nuniform cameraMinMaxZ: vec2f;\n#endif\nuniform focusDistance: f32;uniform cocPrecalculation: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;\n#define CUSTOM_COC_DEPTH\n#ifdef COC_DEPTH_NOT_NORMALIZED\nlet pixelDistance=depth*1000.0;\n#else\nlet pixelDistance: f32=(uniforms.cameraMinMaxZ.x+uniforms.cameraMinMaxZ.y*depth)*1000.0; \n#endif\n#define CUSTOM_COC_PIXELDISTANCE\nvar coc: f32=abs(uniforms.cocPrecalculation*((uniforms.focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);fragmentOutputs.color= vec4f(coc,coc,coc,1.0);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},90201:(e,t,i)=>{i.r(t),i.d(t,{colorPixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(59939),i(72207),i(71743);const n="colorPixelShader",s="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vColor: vec4f;\n#else\nuniform color: vec4f;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nfragmentOutputs.color=input.vColor;\n#else\nfragmentOutputs.color=uniforms.color;\n#endif\n#include<fogFragment>(color,fragmentOutputs.color)\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},88723:(e,t,i)=>{i.r(t),i.d(t,{colorVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(45737),i(96601),i(90483),i(9929),i(36674),i(32910),i(22713),i(78025),i(18144);const n="colorVertexShader",s="attribute position: vec3f;\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#ifdef FOG\nuniform view: mat4x4f;\n#endif\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},41993:(e,t,i)=>{i.r(t),i.d(t,{colorCorrectionPixelShaderWGSL:()=>s});const r="colorCorrectionPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;var colorTableSampler: sampler;var colorTable: texture_2d<f32>;const SLICE_COUNT: f32=16.0; \nfn sampleAs3DTexture(uv: vec3f,width: f32)->vec4f {var sliceSize: f32=1.0/width; \nvar slicePixelSize: f32=sliceSize/width; \nvar sliceInnerSize: f32=slicePixelSize*(width-1.0); \nvar zSlice0: f32=min(floor(uv.z*width),width-1.0);var zSlice1: f32=min(zSlice0+1.0,width-1.0);var xOffset: f32=slicePixelSize*0.5+uv.x*sliceInnerSize;var s0: f32=xOffset+(zSlice0*sliceSize);var s1: f32=xOffset+(zSlice1*sliceSize);var slice0Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s0,uv.y));var slice1Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s1,uv.y));var zOffset: f32=((uv.z*width)%(1.0));return mix(slice0Color,slice1Color,zOffset);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var screen_color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=sampleAs3DTexture(screen_color.rgb,SLICE_COUNT);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},15062:(e,t,i)=>{i.r(t),i.d(t,{convolutionPixelShaderWGSL:()=>s});const r="convolutionPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform kernel: array<f32,9>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var colorSum: vec4f =\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,-1))*uniforms.kernel[0] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,-1))*uniforms.kernel[1] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,-1))*uniforms.kernel[2] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,0))*uniforms.kernel[3] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,0))*uniforms.kernel[4] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,0))*uniforms.kernel[5] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,1))*uniforms.kernel[6] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,1))*uniforms.kernel[7] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,1))*uniforms.kernel[8];var kernelWeight: f32 =\nuniforms.kernel[0] +\nuniforms.kernel[1] +\nuniforms.kernel[2] +\nuniforms.kernel[3] +\nuniforms.kernel[4] +\nuniforms.kernel[5] +\nuniforms.kernel[6] +\nuniforms.kernel[7] +\nuniforms.kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\nfragmentOutputs.color= vec4f((colorSum/kernelWeight).rgb,1);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},42220:(e,t,i)=>{i.r(t),i.d(t,{copyTexture3DLayerToTexturePixelShaderWGSL:()=>s});const r="copyTexture3DLayerToTexturePixelShader",n="var textureSampler: texture_3d<f32>;uniform layerNum: i32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let coord=vec3f(vec2f(input.vUV.x,input.vUV.y)*vec2f(textureDimensions(textureSampler,0).xy),f32(uniforms.layerNum));let color=textureLoad(textureSampler,vec3i(coord),0).rgb;fragmentOutputs.color= vec4f(color,1);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},32350:(e,t,i)=>{i.r(t),i.d(t,{copyTextureToTexturePixelShaderWGSL:()=>a});var r=i(43862);i(68458);const n="copyTextureToTexturePixelShader",s="uniform conversion: f32;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;\n#include<helperFunctions>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef DEPTH_TEXTURE\nfragmentOutputs.fragDepth=color.r;\n#else\nif (uniforms.conversion==1.) {color=toLinearSpaceVec4(color);} else if (uniforms.conversion==2.) {color=toGammaSpace(color);}\nfragmentOutputs.color=color;\n#endif\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},24567:(e,t,i)=>{i.r(t),i.d(t,{depthPixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(79643),i(72207);const n="depthPixelShader",s="#ifdef ALPHATEST\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying vDepthMetric: f32;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vViewPos: vec4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vViewPos.z);\n#else\nfragmentOutputs.color= vec4f(input.vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\nfragmentOutputs.color=pack(input.position.z);\n#else\nfragmentOutputs.color= vec4f(input.position.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vDepthMetric);\n#else\nfragmentOutputs.color= vec4f(input.vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},93105:(e,t,i)=>{i.r(t),i.d(t,{depthVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(45737),i(90483),i(95030),i(56205),i(9929),i(36674),i(32910),i(22713);const n="depthVertexShader",s="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;uniform depthValues: vec2f;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform view: mat4x4f;varying vViewPos: vec4f;\n#endif\nvarying vDepthMetric: f32;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\nvertexOutputs.position=uniforms.viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvertexOutputs.vViewPos=uniforms.view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric=((-vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#else\nvertexOutputs.vDepthMetric=((vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},61583:(e,t,i)=>{i.r(t),i.d(t,{depthBoxBlurPixelShaderWGSL:()=>s});const r="depthBoxBlurPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}\nfragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},96340:(e,t,i)=>{i.r(t),i.d(t,{depthOfFieldMergePixelShaderWGSL:()=>s});const r="depthOfFieldMergePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;var blurStep0Sampler: sampler;var blurStep0: texture_2d<f32>;\n#if BLUR_LEVEL>0\nvar blurStep1Sampler: sampler;var blurStep1: texture_2d<f32>;\n#endif\n#if BLUR_LEVEL>1\nvar blurStep2Sampler: sampler;var blurStep2: texture_2d<f32>;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coc: f32=textureSampleLevel(circleOfConfusionSampler,circleOfConfusionSamplerSampler,input.vUV,0.0).r;\n#if BLUR_LEVEL==0\nvar original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred1,coc/0.5);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred2,coc/0.33);}else if(coc<0.66){var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},52361:(e,t,i)=>{i.r(t),i.d(t,{displayPassPixelShaderWGSL:()=>s});const r="displayPassPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var passSamplerSampler: sampler;var passSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(passSampler,passSamplerSampler,input.vUV);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},81192:(e,t,i)=>{i.r(t),i.d(t,{extractHighlightsPixelShaderWGSL:()=>a});var r=i(43862);i(68458);const n="extractHighlightsPixelShader",s="#include<helperFunctions>\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform threshold: f32;uniform exposure: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var luma: f32=dot(LuminanceEncodeApprox,fragmentOutputs.color.rgb*uniforms.exposure);fragmentOutputs.color=vec4f(step(uniforms.threshold,luma)*fragmentOutputs.color.rgb,fragmentOutputs.color.a);}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},77572:(e,t,i)=>{i.r(t),i.d(t,{filterPixelShaderWGSL:()=>s});const r="filterPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform kernelMatrix: mat4x4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var baseColor: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var updatedColor: vec3f=(uniforms.kernelMatrix* vec4f(baseColor,1.0)).rgb;fragmentOutputs.color= vec4f(updatedColor,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},74351:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingBilateralBlurPixelShaderWGSL:()=>s});const r="fluidRenderingBilateralBlurPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform maxFilterSize: i32;uniform blurDir: vec2f;uniform projectedParticleConstant: f32;uniform depthThreshold: f32;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color=vec4f(vec3f(depth),1.);return fragmentOutputs;}\nvar filterSize: i32=min(uniforms.maxFilterSize,i32(ceil(uniforms.projectedParticleConstant/depth)));var sigma: f32=f32(filterSize)/3.0;var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold/3.0;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sum: f32=0.;var wsum: f32=0.;var sumVel: f32=0.;for (var x: i32=-filterSize; x<=filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampleDepthVel: vec2f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rg;var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepthVel.r-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}\nfragmentOutputs.color=vec4f(sum/wsum,sumVel/wsum,0.,1.);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},45973:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthPixelShaderWGSL:()=>s});const r="fluidRenderingParticleDepthPixelShader",n="uniform projection: mat4x4f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;\n#ifdef FLUIDRENDERING_VELOCITY\nvarying velocityNorm: f32;\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}\nvar normal: vec3f=vec3f(normalxy,sqrt(1.0-r2));\n#ifndef FLUIDRENDERING_RHS\nnormal.z=-normal.z;\n#endif\nvar realViewPos: vec4f=vec4f(input.viewPos+normal*input.sphereRadius,1.0);var clipSpacePos: vec4f=uniforms.projection*realViewPos;fragmentOutputs.fragDepth=clipSpacePos.z/clipSpacePos.w;\n#ifdef FLUIDRENDERING_RHS\nrealViewPos.z=-realViewPos.z;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nfragmentOutputs.color=vec4f(realViewPos.z,input.velocityNorm,0.,1.);\n#else\nfragmentOutputs.color=vec4f(realViewPos.z,0.,0.,1.);\n#endif\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},17887:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDepthVertexShaderWGSL:()=>s});const r="fluidRenderingParticleDepthVertexShader",n="attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;\n#ifdef FLUIDRENDERING_VELOCITY\nattribute velocity: vec3f;varying velocityNorm: f32;\n#endif\n@vertex\nfn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(\nvec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,\n0.0\n);vertexOutputs.viewPos=(uniforms.view*vec4f(input.position,1.0)).xyz;vertexOutputs.position=uniforms.projection*vec4f(vertexOutputs.viewPos+cornerPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.sphereRadius=uniforms.size.x/2.0;\n#ifdef FLUIDRENDERING_VELOCITY\nvertexOutputs.velocityNorm=length(velocity);\n#endif\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},51080:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleDiffusePixelShaderWGSL:()=>s});const r="fluidRenderingParticleDiffusePixelShader",n="uniform particleAlpha: f32;varying uv: vec2f;varying diffuseColor: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}\nfragmentOutputs.color=vec4f(input.diffuseColor,1.0);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},77584:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessPixelShaderWGSL:()=>s});const r="fluidRenderingParticleThicknessPixelShader",n="uniform particleAlpha: f32;varying uv: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}\nvar thickness: f32=sqrt(1.0-r2);fragmentOutputs.color=vec4f(vec3f(uniforms.particleAlpha*thickness),1.0);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},5662:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingParticleThicknessVertexShaderWGSL:()=>s});const r="fluidRenderingParticleThicknessVertexShader",n="attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;@vertex\nfn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(\nvec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,\n0.0\n);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},5282:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingRenderPixelShaderWGSL:()=>s});const r="fluidRenderingRenderPixelShader",n="#define DISABLE_UNIFORMITY_ANALYSIS\n#define IOR 1.333\n#define ETA 1.0/IOR\n#define F0 0.02\nvar textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#else\nuniform diffuseColor: vec3f;\n#endif\n#ifdef FLUIDRENDERING_FIXED_THICKNESS\nuniform thickness: f32;var bgDepthSamplerSampler: sampler;var bgDepthSampler: texture_2d<f32>;\n#else\nuniform minimumThickness: f32;var thicknessSamplerSampler: sampler;var thicknessSampler: texture_2d<f32>;\n#endif\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvar debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;\n#endif\nuniform viewMatrix: mat4x4f;uniform projectionMatrix: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform texelSize: vec2f;uniform dirLight: vec3f;uniform cameraFar: f32;uniform density: f32;uniform refractionStrength: f32;uniform fresnelClamp: f32;uniform specularPower: f32;varying vUV: vec2f;fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32)->vec3f {var ndc: vec4f=vec4f(texCoord*2.0-1.0,0.0,1.0);\n#ifdef FLUIDRENDERING_RHS\nndc.z=-uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;\n#else\nndc.z=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;\n#endif\nndc.w=1.0;var eyePos: vec4f=uniforms.invProjectionMatrix*ndc;return eyePos.xyz/eyePos.w;}\nfn getViewPosFromTexCoord(texCoord: vec2f)->vec3f {var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var texCoord: vec2f=input.vUV;\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)\nvar color: vec4f=textureSample(debugSampler,debugSamplerSampler,texCoord);\n#ifdef FLUIDRENDERING_DEBUG_DEPTH\nfragmentOutputs.color=vec4f(color.rgb/vec3f(2.0),1.);if (color.r>0.999 && color.g>0.999) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}\n#else\nfragmentOutputs.color=vec4f(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}\n#endif\nreturn fragmentOutputs;\n#endif\nvar depthVel: vec2f=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).rg;var depth: f32=depthVel.r;\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nvar thickness: f32=textureSample(thicknessSampler,thicknessSamplerSampler,texCoord).x;\n#else\nvar thickness: f32=uniforms.thickness;var bgDepth: f32=textureSample(bgDepthSampler,bgDepthSamplerSampler,texCoord).x;var depthNonLinear: f32=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;\n#endif\nvar backColor: vec4f=textureSample(textureSampler,textureSamplerSampler,texCoord);\n#ifndef FLUIDRENDERING_FIXED_THICKNESS\nif (depth>=uniforms.cameraFar || depth<=0. || thickness<=uniforms.minimumThickness) {\n#else\nif (depth>=uniforms.cameraFar || depth<=0. || bgDepth<=depthNonLinear) {\n#endif\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nfragmentOutputs.color=vec4f(backColor.rgb*backColor.a,backColor.a);\n#else\nfragmentOutputs.color=backColor;\n#endif\nreturn fragmentOutputs;}\nvar viewPos: vec3f=computeViewPosFromUVDepth(texCoord,depth);var ddx: vec3f=getViewPosFromTexCoord(texCoord+vec2f(uniforms.texelSize.x,0.))-viewPos;var ddy: vec3f=getViewPosFromTexCoord(texCoord+vec2f(0.,uniforms.texelSize.y))-viewPos;var ddx2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(-uniforms.texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}\nvar ddy2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(0.,-uniforms.texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}\nvar normal: vec3f=normalize(cross(ddy,ddx));\n#ifdef FLUIDRENDERING_RHS\nnormal=-normal;\n#endif\n#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)\nfragmentOutputs.color=vec4f(normal*0.5+0.5,1.0);return fragmentOutputs;\n#endif\nvar rayDir: vec3f=normalize(viewPos); \n#ifdef FLUIDRENDERING_DIFFUSETEXTURE\nvar diffuseColor: vec3f=textureSampleLevel(diffuseSampler,diffuseSamplerSampler,texCoord,0.0).rgb;\n#else\nvar diffuseColor: vec3f=uniforms.diffuseColor;\n#endif\nvar lightDir: vec3f=normalize((uniforms.viewMatrix*vec4f(-uniforms.dirLight,0.)).xyz);var H: vec3f =normalize(lightDir-rayDir);var specular: f32 =pow(max(0.0,dot(H,normal)),uniforms.specularPower);\n#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING\nvar diffuse: f32 =max(0.0,dot(lightDir,normal))*1.0;fragmentOutputs.color=vec4f(vec3f(0.1) /*ambient*/+vec3f(0.42,0.50,1.00)*diffuse+vec3f(0,0,0.2)+specular,1.);return fragmentOutputs;\n#endif\nvar refractionDir: vec3f=refract(rayDir,normal,ETA);var transmitted: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,vec2f(texCoord+refractionDir.xy*thickness*uniforms.refractionStrength),0.0);\n#ifdef FLUIDRENDERING_COMPOSITE_MODE\nif (transmitted.a==0.) {transmitted.a=thickness;}\n#endif\nvar transmittance: vec3f=exp(-uniforms.density*thickness*(1.0-diffuseColor)); \nvar refractionColor: vec3f=transmitted.rgb*transmittance;\n#ifdef FLUIDRENDERING_ENVIRONMENT\nvar reflectionDir: vec3f=reflect(rayDir,normal);var reflectionColor: vec3f=(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionDir).rgb);var fresnel: f32=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,uniforms.fresnelClamp);var finalColor: vec3f=mix(refractionColor,reflectionColor,fresnel)+specular;\n#else\nvar finalColor: vec3f=refractionColor+specular;\n#endif\n#ifdef FLUIDRENDERING_VELOCITY\nvar velocity: f32=depthVel.g;finalColor=mix(finalColor,vec3f(1.0),smoothstep(0.3,1.0,velocity/6.0));\n#endif\nfragmentOutputs.color=vec4f(finalColor,transmitted.a);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},86318:(e,t,i)=>{i.r(t),i.d(t,{fluidRenderingStandardBlurPixelShaderWGSL:()=>s});const r="fluidRenderingStandardBlurPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var s: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.);if (s.r==0.) {fragmentOutputs.color=vec4f(0.,0.,0.,1.);return fragmentOutputs;}\nvar sigma: f32=f32(uniforms.filterSize)/3.0;var twoSigma2: f32=2.0*sigma*sigma;var sum: vec4f=vec4f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampl: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.);var w: f32=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}\nsum/=wsum;fragmentOutputs.color=vec4f(sum.rgb,1.);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},72358:(e,t,i)=>{i.r(t),i.d(t,{fxaaPixelShaderWGSL:()=>s});const r="fxaaPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform texelSize: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const fxaaQualitySubpix: f32=1.0;const fxaaQualityEdgeThreshold: f32=0.166;const fxaaQualityEdgeThresholdMin: f32=0.0833;const kLumaCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);fn FxaaLuma(rgba: vec4f)->f32 {return dot(rgba.rgb,kLumaCoefficients);} \n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var posM: vec2f;posM.x=input.vUV.x;posM.y=input.vUV.y;var rgbyM: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var lumaM: f32=FxaaLuma(rgbyM);var lumaS: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordS,0.0));var lumaE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordE,0.0));var lumaN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordN,0.0));var lumaW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordW,0.0));var maxSM: f32=max(lumaS,lumaM);var minSM: f32=min(lumaS,lumaM);var maxESM: f32=max(lumaE,maxSM);var minESM: f32=min(lumaE,minSM);var maxWN: f32=max(lumaN,lumaW);var minWN: f32=min(lumaN,lumaW);var rangeMax: f32=max(maxWN,maxESM);var rangeMin: f32=min(minWN,minESM);var rangeMaxScaled: f32=rangeMax*fxaaQualityEdgeThreshold;var range: f32=rangeMax-rangeMin;var rangeMaxClamped: f32=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{fragmentOutputs.color=rgbyM;return fragmentOutputs;}\n#endif\nvar lumaNW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNW,0.0));var lumaSE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSE,0.0));var lumaNE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNE,0.0));var lumaSW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSW,0.0));var lumaNS: f32=lumaN+lumaS;var lumaWE: f32=lumaW+lumaE;var subpixRcpRange: f32=1.0/range;var subpixNSWE: f32=lumaNS+lumaWE;var edgeHorz1: f32=(-2.0*lumaM)+lumaNS;var edgeVert1: f32=(-2.0*lumaM)+lumaWE;var lumaNESE: f32=lumaNE+lumaSE;var lumaNWNE: f32=lumaNW+lumaNE;var edgeHorz2: f32=(-2.0*lumaE)+lumaNESE;var edgeVert2: f32=(-2.0*lumaN)+lumaNWNE;var lumaNWSW: f32=lumaNW+lumaSW;var lumaSWSE: f32=lumaSW+lumaSE;var edgeHorz4: f32=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);var edgeVert4: f32=(abs(edgeVert1)*2.0)+abs(edgeVert2);var edgeHorz3: f32=(-2.0*lumaW)+lumaNWSW;var edgeVert3: f32=(-2.0*lumaS)+lumaSWSE;var edgeHorz: f32=abs(edgeHorz3)+edgeHorz4;var edgeVert: f32=abs(edgeVert3)+edgeVert4;var subpixNWSWNESE: f32=lumaNWSW+lumaNESE;var lengthSign: f32=uniforms.texelSize.x;var horzSpan: bool=edgeHorz>=edgeVert;var subpixA: f32=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=uniforms.texelSize.y;}\nvar subpixB: f32=(subpixA*(1.0/12.0))-lumaM;var gradientN: f32=lumaN-lumaM;var gradientS: f32=lumaS-lumaM;var lumaNN: f32=lumaN+lumaM;var lumaSS: f32=lumaS+lumaM;var pairN: bool=abs(gradientN)>=abs(gradientS);var gradient: f32=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nvar subpixC: f32=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);var posB: vec2f;posB.x=posM.x;posB.y=posM.y;var offNP: vec2f;offNP.x=select(uniforms.texelSize.x,0.0,(!horzSpan));offNP.y=select(uniforms.texelSize.y,0.0,(horzSpan));if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvar posN: vec2f;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;var posP: vec2f;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;var subpixD: f32=((-2.0)*subpixC)+3.0;var lumaEndN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN,0.0));var subpixE: f32=subpixC*subpixC;var lumaEndP: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nvar gradientScaled: f32=gradient*1.0/4.0;var lumaMM: f32=lumaM-lumaNN*0.5;var subpixF: f32=subpixD*subpixE;var lumaMLTZero: bool=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;var doneN: bool=abs(lumaEndN)>=gradientScaled;var doneP: bool=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nvar doneNP: bool=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) {lumaEndN=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN.xy,0.0));}\nif (!doneP) {lumaEndP=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP.xy,0.0));}\nif (!doneN) {lumaEndN=lumaEndN-lumaNN*0.5;}\nif (!doneP) {lumaEndP=lumaEndP-lumaNN*0.5;}\ndoneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) {posN.x-=offNP.x*12.0;}\nif (!doneN) {posN.y-=offNP.y*12.0;}\ndoneNP=(!doneN) || (!doneP);if (!doneP) {posP.x+=offNP.x*12.0;}\nif (!doneP) {posP.y+=offNP.y*12.0;}}\nvar dstN: f32=posM.x-posN.x;var dstP: f32=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nvar goodSpanN: bool=(lumaEndN<0.0) != lumaMLTZero;var spanLength: f32=(dstP+dstN);var goodSpanP: bool=(lumaEndP<0.0) != lumaMLTZero;var spanLengthRcp: f32=1.0/spanLength;var directionN: bool=dstN<dstP;var dst: f32=min(dstN,dstP);var goodSpan: bool=select(goodSpanP,goodSpanN,directionN);var subpixG: f32=subpixF*subpixF;var pixelOffset: f32=(dst*(-spanLengthRcp))+0.5;var subpixH: f32=subpixG*fxaaQualitySubpix;var pixelOffsetGood: f32=select(0.0,pixelOffset,goodSpan);var pixelOffsetSubpix: f32=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{fragmentOutputs.color=rgbyM;}\nelse\n{fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);}\n#else\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);\n#endif\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},34444:(e,t,i)=>{i.r(t),i.d(t,{fxaaVertexShaderWGSL:()=>s});const r="fxaaVertexShader",n="attribute position: vec2f;uniform texelSize: vec2f;varying vUV: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(input.position*madd+madd);vertexOutputs.sampleCoordS=vertexOutputs.vUV+ vec2f( 0.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordE=vertexOutputs.vUV+ vec2f( 1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordN=vertexOutputs.vUV+ vec2f( 0.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordW=vertexOutputs.vUV+ vec2f(-1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordNW=vertexOutputs.vUV+ vec2f(-1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSE=vertexOutputs.vUV+ vec2f( 1.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordNE=vertexOutputs.vUV+ vec2f( 1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSW=vertexOutputs.vUV+ vec2f(-1.0,1.0)*uniforms.texelSize;vertexOutputs.position=vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},79986:(e,t,i)=>{i.r(t),i.d(t,{gaussianSplattingPixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(26774),i(59939),i(46112),i(71743);r.l.IncludesShadersStoreWGSL.gaussianSplattingFragmentDeclaration="fn gaussianColor(inColor: vec4f,inPosition: vec2f)->vec4f\n{var A : f32=-dot(inPosition,inPosition);if (A>-4.0)\n{var B: f32=exp(A)*inColor.a;\n#include<logDepthFragment>\nvar color: vec3f=inColor.rgb;\n#ifdef FOG\n#include<fogFragment>\n#endif\nreturn vec4f(color,B);} else {return vec4f(0.0);}}\n",i(72207);const n="gaussianSplattingPixelShader",s="#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvarying vColor: vec4f;varying vPosition: vec2f;\n#include<gaussianSplattingFragmentDeclaration>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\nfragmentOutputs.color=gaussianColor(input.vColor,input.vPosition);}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},92430:(e,t,i)=>{i.r(t),i.d(t,{gaussianSplattingVertexShaderWGSL:()=>a});var r=i(43862);i(31371),i(90270),i(45737),i(96601),i(26774);r.l.IncludesShadersStoreWGSL.gaussianSplatting="fn getDataUV(index: f32,dataTextureSize: vec2f)->vec2<f32> {let y: f32=floor(index/dataTextureSize.x);let x: f32=index-y*dataTextureSize.x;return vec2f((x+0.5),(y+0.5));}\nstruct Splat {center: vec4f,\ncolor: vec4f,\ncovA: vec4f,\ncovB: vec4f,\n#if SH_DEGREE>0\nsh0: vec4<u32>,\n#endif\n#if SH_DEGREE>1\nsh1: vec4<u32>,\n#endif\n#if SH_DEGREE>2\nsh2: vec4<u32>,\n#endif\n};fn readSplat(splatIndex: f32,dataTextureSize: vec2f)->Splat {var splat: Splat;let splatUV=getDataUV(splatIndex,dataTextureSize);let splatUVi32=vec2<i32>(i32(splatUV.x),i32(splatUV.y));splat.center=textureLoad(centersTexture,splatUVi32,0);splat.color=textureLoad(colorsTexture,splatUVi32,0);splat.covA=textureLoad(covariancesATexture,splatUVi32,0)*splat.center.w;splat.covB=textureLoad(covariancesBTexture,splatUVi32,0)*splat.center.w;\n#if SH_DEGREE>0\nsplat.sh0=textureLoad(shTexture0,splatUVi32,0);\n#endif\n#if SH_DEGREE>1\nsplat.sh1=textureLoad(shTexture1,splatUVi32,0);\n#endif\n#if SH_DEGREE>2\nsplat.sh2=textureLoad(shTexture2,splatUVi32,0);\n#endif\nreturn splat;}\nfn computeColorFromSHDegree(dir: vec3f,sh: array<vec3<f32>,16>)->vec3f\n{let SH_C0: f32=0.28209479;let SH_C1: f32=0.48860251;var SH_C2: array<f32,5>=array<f32,5>(\n1.092548430,\n-1.09254843,\n0.315391565,\n-1.09254843,\n0.546274215\n);var SH_C3: array<f32,7>=array<f32,7>(\n-0.59004358,\n2.890611442,\n-0.45704579,\n0.373176332,\n-0.45704579,\n1.445305721,\n-0.59004358\n);var result: vec3f=/*SH_C0**/sh[0];\n#if SH_DEGREE>0\nlet x: f32=dir.x;let y: f32=dir.y;let z: f32=dir.z;result+=-SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];\n#if SH_DEGREE>1\nlet xx: f32=x*x;let yy: f32=y*y;let zz: f32=z*z;let xy: f32=x*y;let yz: f32=y*z;let xz: f32=x*z;result+=\nSH_C2[0]*xy*sh[4] +\nSH_C2[1]*yz*sh[5] +\nSH_C2[2]*(2.0f*zz-xx-yy)*sh[6] +\nSH_C2[3]*xz*sh[7] +\nSH_C2[4]*(xx-yy)*sh[8];\n#if SH_DEGREE>2\nresult+=\nSH_C3[0]*y*(3.0f*xx-yy)*sh[9] +\nSH_C3[1]*xy*z*sh[10] +\nSH_C3[2]*y*(4.0f*zz-xx-yy)*sh[11] +\nSH_C3[3]*z*(2.0f*zz-3.0f*xx-3.0f*yy)*sh[12] +\nSH_C3[4]*x*(4.0f*zz-xx-yy)*sh[13] +\nSH_C3[5]*z*(xx-yy)*sh[14] +\nSH_C3[6]*x*(xx-3.0f*yy)*sh[15];\n#endif\n#endif\n#endif\nreturn result;}\nfn decompose(value: u32)->vec4f\n{let components : vec4f=vec4f(\nf32((value ) & 255u),\nf32((value>>u32( 8)) & 255u),\nf32((value>>u32(16)) & 255u),\nf32((value>>u32(24)) & 255u));return components*vec4f(2./255.)-vec4f(1.);}\nfn computeSH(splat: Splat,color: vec3f,dir: vec3f)->vec3f\n{var sh: array<vec3<f32>,16>;sh[0]=color;\n#if SH_DEGREE>0\nlet sh00: vec4f=decompose(splat.sh0.x);let sh01: vec4f=decompose(splat.sh0.y);let sh02: vec4f=decompose(splat.sh0.z);sh[1]=vec3f(sh00.x,sh00.y,sh00.z);sh[2]=vec3f(sh00.w,sh01.x,sh01.y);sh[3]=vec3f(sh01.z,sh01.w,sh02.x);\n#endif\n#if SH_DEGREE>1\nlet sh03: vec4f=decompose(splat.sh0.w);let sh04: vec4f=decompose(splat.sh1.x);let sh05: vec4f=decompose(splat.sh1.y);sh[4]=vec3f(sh02.y,sh02.z,sh02.w);sh[5]=vec3f(sh03.x,sh03.y,sh03.z);sh[6]=vec3f(sh03.w,sh04.x,sh04.y);sh[7]=vec3f(sh04.z,sh04.w,sh05.x);sh[8]=vec3f(sh05.y,sh05.z,sh05.w);\n#endif\n#if SH_DEGREE>2\nlet sh06: vec4f=decompose(splat.sh1.z);let sh07: vec4f=decompose(splat.sh1.w);let sh08: vec4f=decompose(splat.sh2.x);let sh09: vec4f=decompose(splat.sh2.y);let sh10: vec4f=decompose(splat.sh2.z);let sh11: vec4f=decompose(splat.sh2.w);sh[9]=vec3f(sh06.x,sh06.y,sh06.z);sh[10]=vec3f(sh06.w,sh07.x,sh07.y);sh[11]=vec3f(sh07.z,sh07.w,sh08.x);sh[12]=vec3f(sh08.y,sh08.z,sh08.w);sh[13]=vec3f(sh09.x,sh09.y,sh09.z);sh[14]=vec3f(sh09.w,sh10.x,sh10.y);sh[15]=vec3f(sh10.z,sh10.w,sh11.x); \n#endif\nreturn computeColorFromSHDegree(dir,sh);}\nfn gaussianSplatting(\nmeshPos: vec2<f32>,\nworldPos: vec3<f32>,\nscale: vec2<f32>,\ncovA: vec3<f32>,\ncovB: vec3<f32>,\nworldMatrix: mat4x4<f32>,\nviewMatrix: mat4x4<f32>,\nprojectionMatrix: mat4x4<f32>,\nfocal: vec2f,\ninvViewport: vec2f\n)->vec4f {let modelView=viewMatrix*worldMatrix;let camspace=viewMatrix*vec4f(worldPos,1.0);let pos2d=projectionMatrix*camspace;let bounds=1.2*pos2d.w;if (pos2d.z<0. || pos2d.x<-bounds || pos2d.x>bounds || pos2d.y<-bounds || pos2d.y>bounds) {return vec4f(0.0,0.0,2.0,1.0);}\nlet Vrk=mat3x3<f32>(\ncovA.x,covA.y,covA.z,\ncovA.y,covB.x,covB.y,\ncovA.z,covB.y,covB.z\n);let J=mat3x3<f32>(\nfocal.x/camspace.z,0.0,-(focal.x*camspace.x)/(camspace.z*camspace.z),\n0.0,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),\n0.0,0.0,0.0\n);let invy=mat3x3<f32>(\n1.0,0.0,0.0,\n0.0,-1.0,0.0,\n0.0,0.0,1.0\n);let T=invy*transpose(mat3x3<f32>(\nmodelView[0].xyz,\nmodelView[1].xyz,\nmodelView[2].xyz))*J;let cov2d=transpose(T)*Vrk*T;let mid=(cov2d[0][0]+cov2d[1][1])/2.0;let radius=length(vec2<f32>((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));let lambda1=mid+radius;let lambda2=mid-radius;if (lambda2<0.0) {return vec4f(0.0,0.0,2.0,1.0);}\nlet diagonalVector=normalize(vec2<f32>(cov2d[0][1],lambda1-cov2d[0][0]));let majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;let minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2<f32>(diagonalVector.y,-diagonalVector.x);let vCenter=vec2<f32>(pos2d.x,pos2d.y);return vec4f(\nvCenter+((meshPos.x*majorAxis+meshPos.y*minorAxis)*invViewport*pos2d.w)*scale,\npos2d.z,\npos2d.w\n);}\n",i(22713),i(78025),i(98830);const n="gaussianSplattingVertexShader",s="#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\nattribute splatIndex: f32;attribute position: vec2f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;\n#if SH_DEGREE>0\nvar shTexture0: texture_2d<u32>;\n#endif\n#if SH_DEGREE>1\nvar shTexture1: texture_2d<u32>;\n#endif\n#if SH_DEGREE>2\nvar shTexture2: texture_2d<u32>;\n#endif\nvarying vColor: vec4f;varying vPosition: vec2f;\n#include<gaussianSplatting>\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var splat: Splat=readSplat(input.splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position;\n#if SH_DEGREE>0\nlet dir: vec3f=normalize(worldPos.xyz-scene.vEyePosition.xyz);vertexOutputs.vColor=vec4f(computeSH(splat,splat.color.xyz,dir),1.0);\n#else\nvertexOutputs.vColor=splat.color;\n#endif\nvertexOutputs.position=gaussianSplatting(input.position,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport);\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},29610:(e,t,i)=>{i.r(t),i.d(t,{geometryPixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(54013),i(44806),i(68458),i(72207),i(41627);const n="geometryPixelShader",s="#ifdef BUMP\nvarying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;varying vNormalW: vec3f;\n#else\nvarying vNormalV: vec3f;\n#endif\nvarying vViewPos: vec4f;\n#if defined(POSITION) || defined(BUMP)\nvarying vPositionW: vec3f;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nvarying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#ifdef NEED_UV\nvarying vUV: vec2f;\n#endif\n#ifdef BUMP\nuniform vBumpInfos: vec3f;uniform vTangentSpaceParams: vec2f;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nvar reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;varying vReflectivityUV: vec2f;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vAlbedoUV: vec2f;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform reflectivityColor: vec3f;\n#endif\n#ifdef ALBEDOCOLOR\nuniform albedoColor: vec3f;\n#endif\n#ifdef METALLIC\nuniform metallic: f32;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform glossiness: f32;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nvar diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\nvar normalOutput: vec3f;\n#ifdef BUMP\nvar normalW: vec3f=normalize(input.vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize( vec3f(mat4x4f(input.vWorldView0,input.vWorldView0,input.vWorldView2,input.vWorldView3)* vec4f(normalW,0.0)));\n#endif\n#else\nnormalOutput=normalize(input.vNormalV);\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\nvar fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef DEPTH\nfragData[DEPTH_INDEX]=vec4f(input.vViewPos.z/input.vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\nfragData[NORMAL_INDEX]=vec4f(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\nfragData[SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\nfragData[POSITION_INDEX]= vec4f(input.vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvar a: vec2f=(input.vCurrentPosition.xy/input.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(input.vPreviousPosition.xy/input.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[VELOCITY_INDEX]= vec4f(velocity,0.0,1.0);\n#endif\n#ifdef VELOCITY_LINEAR\nvar velocity : vec2f=vec2f(0.5)*((input.vPreviousPosition.xy /\ninput.vPreviousPosition.w) -\n(input.vCurrentPosition.xy /\ninput.vCurrentPosition.w));fragData[VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvar reflectivity: vec4f= vec4f(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nvar metal: f32=1.0;var roughness: f32=1.0;\n#ifdef ORMTEXTURE\nmetal*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).b;roughness*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=uniforms.metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-uniforms.glossiness); \n#endif\nreflectivity=vec4f(reflectivity.rgb,reflectivity.a-roughness);var color: vec3f= vec3f(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=textureSample(albedoSampler,albedoSamplerSampler,input.vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpaceVec4(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=uniforms.albedoColor.xyz;\n#endif\nreflectivity=vec4f(mix( vec3f(0.04),color,metal),reflectivity.a);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity=vec4f(toLinearSpaceVec3(reflectivity.rgb),reflectivity.a);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity=vec4f(toLinearSpaceVec3(uniforms.reflectivityColor.xyz),1.0);\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity=vec4f(reflectivity.rgb,reflectivity.a*glossiness); \n#endif\n#endif\nfragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},30672:(e,t,i)=>{i.r(t),i.d(t,{geometryVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(90483),i(31371),i(45737),i(95030),i(56205),i(9929),i(36674),i(32910),i(22713),i(5541);const n="geometryVertexShader",s="#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<sceneUboDeclaration>\n#include<clipPlaneVertexDeclaration>\nattribute position: vec3f;attribute normal: vec3f;\n#ifdef NEED_UV\nvarying vUV: vec2f;\n#ifdef ALPHATEST\nuniform diffuseMatrix: mat4x4f;\n#endif\n#ifdef BUMP\nuniform bumpMatrix: mat4x4f;varying vBumpUV: vec2f;\n#endif\n#ifdef REFLECTIVITY\nuniform reflectivityMatrix: mat4x4f;uniform albedoMatrix: mat4x4f;varying vReflectivityUV: vec2f;varying vAlbedoUV: vec2f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef BUMP\nvarying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;\n#endif\n#ifdef BUMP\nvarying vNormalW: vec3f;\n#else\nvarying vNormalV: vec3f;\n#endif\nvarying vViewPos: vec4f;\n#if defined(POSITION) || defined(BUMP)\nvarying vPositionW: vec3f;\n#endif\n#if defined(VELOCITY) || defined(VELOCITY_LINEAR)\nuniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f= vec4f(finalWorld* vec4f(positionUpdated,1.0));\n#ifdef BUMP\nlet vWorldView=scene.view*finalWorld;vertexOutputs.vWorldView0=vWorldView[0];vertexOutputs.vWorldView1=vWorldView[1];vertexOutputs.vWorldView2=vWorldView[2];vertexOutputs.vWorldView3=vWorldView[3];let normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#else\n#ifdef NORMAL_WORLDSPACE\nvertexOutputs.vNormalV=normalize((finalWorld* vec4f(normalUpdated,0.0)).xyz);\n#else\nvertexOutputs.vNormalV=normalize(((scene.view*finalWorld)* vec4f(normalUpdated,0.0)).xyz);\n#endif\n#endif\nvertexOutputs.vViewPos=scene.view*worldPos;\n#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nvar previousInfluence: mat4x4f;previousInfluence=mPreviousBones[ i32(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);\n#else\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvertexOutputs.vPositionW=worldPos.xyz/worldPos.w;\n#endif\nvertexOutputs.position=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#else\nvertexOutputs.vUV=input.uv;\n#endif\n#ifdef BUMP_UV1\nvertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef REFLECTIVITY_UV1\nvertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef ALBEDO_UV1\nvertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#else\nvertexOutputs.vUV=input.uv2;\n#endif\n#ifdef BUMP_UV2\nvertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#ifdef REFLECTIVITY_UV2\nvertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#ifdef ALBEDO_UV2\nvertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},93341:(e,t,i)=>{i.r(t),i.d(t,{glowBlurPostProcessPixelShaderWGSL:()=>s});const r="glowBlurPostProcessPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32\n{return dot(color, vec3f(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)\n{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}\nfragmentOutputs.color=baseColor;}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},63205:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationPixelShaderWGSL:()=>a});var r=i(43862);i(68458),i(24595),i(72207);const n="glowMapGenerationPixelShader",s="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vUVDiffuse: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#ifdef OPACITY\nvarying vUVOpacity: vec2f;var opacitySamplerSampler: sampler;var opacitySampler: texture_2d<f32>;uniform opacityIntensity: f32;\n#endif\n#ifdef EMISSIVE\nvarying vUVEmissive: vec2f;var emissiveSamplerSampler: sampler;var emissiveSampler: texture_2d<f32>;\n#endif\n#ifdef VERTEXALPHA\nvarying vColor: vec4f;\n#endif\nuniform glowColor: vec4f;uniform glowIntensity: f32;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\nvar finalColor: vec4f=uniforms.glowColor;\n#ifdef DIFFUSE\nvar albedoTexture: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor=vec4f(finalColor.rgb,finalColor.a*albedoTexture.a);\n#endif\n#ifdef HIGHLIGHT\nfinalColor=vec4f(finalColor.rgb,albedoTexture.a);\n#endif\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor=vec4f(finalColor.rgb,finalColor.a*getLuminance(opacityMap.rgb));\n#else\nfinalColor=vec4f(finalColor.rgb,finalColor.a*opacityMap.a);\n#endif\nfinalColor=vec4f(finalColor.rgb,finalColor.a*uniforms.opacityIntensity);\n#endif\n#ifdef VERTEXALPHA\nfinalColor=vec4f(finalColor.rgb,finalColor.a*fragmentInputs.vColor.a);\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvar emissive: vec4f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\nfragmentOutputs.color=emissive*finalColor*uniforms.glowIntensity;\n#else\nfragmentOutputs.color=finalColor*uniforms.glowIntensity;\n#endif\n#ifdef HIGHLIGHT\nfragmentOutputs.color=vec4f(fragmentOutputs.color.rgb,uniforms.glowColor.a);\n#endif\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},66031:(e,t,i)=>{i.r(t),i.d(t,{glowMapGenerationVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(45737),i(90483),i(95030),i(56205),i(9929),i(36674),i(32910),i(22713);const n="glowMapGenerationVertexShader",s="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;varying vPosition: vec4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#ifdef DIFFUSE\nvarying vUVDiffuse: vec2f;uniform diffuseMatrix: mat4x4f;\n#endif\n#ifdef OPACITY\nvarying vUVOpacity: vec2f;uniform opacityMatrix: mat4x4f;\n#endif\n#ifdef EMISSIVE\nvarying vUVEmissive: vec2f;uniform emissiveMatrix: mat4x4f;\n#endif\n#ifdef VERTEXALPHA\nattribute color: vec4f;varying vColor: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef CUBEMAP\nvertexOutputs.vPosition=worldPos;vertexOutputs.position=uniforms.viewProjection*finalWorld* vec4f(input.position,1.0);\n#else\nvertexOutputs.vPosition=uniforms.viewProjection*worldPos;vertexOutputs.position=vertexOutputs.vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef DIFFUSEUV2\nvertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef OPACITYUV2\nvertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef EMISSIVEUV2\nvertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef VERTEXALPHA\nvertexOutputs.vColor=vertexInputs.color;\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},46679:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergePixelShaderWGSL:()=>s});const r="glowMapMergePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef EMISSIVE\nvar textureSampler2Sampler: sampler;var textureSampler2: texture_2d<f32>;\n#endif\nuniform offset: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef EMISSIVE\nbaseColor+=textureSample(textureSampler2,textureSampler2Sampler,input.vUV);baseColor*=uniforms.offset;\n#else\nbaseColor=vec4f(baseColor.rgb,abs(uniforms.offset-baseColor.a));\n#ifdef STROKE\nvar alpha: f32=smoothstep(.0,.1,baseColor.a);baseColor=vec4f(baseColor.rgb*alpha,alpha);\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\nfragmentOutputs.color=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},61297:(e,t,i)=>{i.r(t),i.d(t,{glowMapMergeVertexShaderWGSL:()=>s});const r="glowMapMergeVertexShader",n="attribute position: vec2f;varying vUV: vec2f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},45221:(e,t,i)=>{i.r(t),i.d(t,{grainPixelShaderWGSL:()=>a});var r=i(43862);i(68458);const n="grainPixelShader",s="#include<helperFunctions>\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform intensity: f32;uniform animatedSeed: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var seed: vec2f=input.vUV*uniforms.animatedSeed;var grain: f32=dither(seed,uniforms.intensity);var lum: f32=getLuminance(fragmentOutputs.color.rgb);var grainAmount: f32=(cos(-PI+(lum*PI*2.))+1.)/2.;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+grain*grainAmount,fragmentOutputs.color.a);fragmentOutputs.color=vec4f(max(fragmentOutputs.color.rgb,vec3f(0.0)),fragmentOutputs.color.a);}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},37110:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringPixelShaderWGSL:()=>a});var r=i(43862);i(68458),i(14892),i(20192),i(97670);const n="hdrFilteringPixelShader",s="#include<helperFunctions>\n#include<importanceSampling>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\nuniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},43644:(e,t,i)=>{i.r(t),i.d(t,{hdrFilteringVertexShaderWGSL:()=>s});const r="hdrFilteringVertexShader",n="attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},7749:(e,t,i)=>{i.r(t),i.d(t,{highlightsPixelShaderWGSL:()=>s});const r="highlightsPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;const RGBLuminanceCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var tex: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var c: vec3f=tex.rgb;var luma: f32=dot(c.rgb,RGBLuminanceCoefficients);fragmentOutputs.color= vec4f(pow(c, vec3f(25.0-luma*15.0)),tex.a); }";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},51568:(e,t,i)=>{i.r(t),i.d(t,{iblCdfxPixelShaderWGSL:()=>s});const r="iblCdfxPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;var cdfy: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfyRes=textureDimensions(cdfy,0);var currentPixel=vec2u(fragmentInputs.position.xy);var cdfx: f32=0.0;for (var x: u32=1; x<=currentPixel.x; x++) {cdfx+=textureLoad(cdfy, vec2u(x-1,cdfyRes.y-1),0).x;}\nfragmentOutputs.color= vec4f( vec3f(cdfx),1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},29145:(e,t,i)=>{i.r(t),i.d(t,{iblCdfyPixelShaderWGSL:()=>s});const r="iblCdfyPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nuniform iblHeight: i32;\n#ifdef IBL_USE_CUBE_MAP\nfn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfn fetchCube(uv: vec2f)->f32 {var direction: vec3f=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb,\nvec3f(0.3,0.6,0.1));}\n#else\nfn fetchPanoramic(Coords: vec2i,envmapHeight: f32)->f32 {return sin(PI*( f32(Coords.y)+0.5)/envmapHeight) *\ndot(textureLoad(iblSource,Coords,0).rgb, vec3f(0.3,0.6,0.1));}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coords: vec2i= vec2i(fragmentInputs.position.xy);var cdfy: f32=0.0;for (var y: i32=1; y<=coords.y; y++) {\n#ifdef IBL_USE_CUBE_MAP\nvar uv: vec2f= vec2f(input.vUV.x,( f32(y-1)+0.5)/ f32(uniforms.iblHeight));cdfy+=fetchCube(uv);\n#else\ncdfy+=fetchPanoramic( vec2i(coords.x,y-1), f32(uniforms.iblHeight));\n#endif\n}\nfragmentOutputs.color= vec4f(cdfy,0.0,0.0,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},15691:(e,t,i)=>{i.r(t),i.d(t,{iblCombineVoxelGridsPixelShaderWGSL:()=>s});const r="iblCombineVoxelGridsPixelShader",n="varying vUV: vec2f;var voxelXaxisSamplerSampler: sampler;var voxelXaxisSampler: texture_3d<f32>;var voxelYaxisSamplerSampler: sampler;var voxelYaxisSampler: texture_3d<f32>;var voxelZaxisSamplerSampler: sampler;var voxelZaxisSampler: texture_3d<f32>;uniform layer: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coordZ: vec3f= vec3f(fragmentInputs.vUV.x,fragmentInputs.vUV.y,uniforms.layer);var voxelZ: f32=textureSample(voxelZaxisSampler,voxelZaxisSamplerSampler,coordZ).r;var coordX: vec3f= vec3f(1.0-uniforms.layer,fragmentInputs.vUV.y,fragmentInputs.vUV.x);var voxelX: f32=textureSample(voxelXaxisSampler,voxelXaxisSamplerSampler,coordX).r;var coordY: vec3f= vec3f(uniforms.layer,fragmentInputs.vUV.x,fragmentInputs.vUV.y);var voxelY: f32=textureSample(voxelYaxisSampler,voxelYaxisSamplerSampler,coordY).r;var voxel=select(0.0,1.0,(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0));fragmentOutputs.color= vec4f( vec3f(voxel),1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},76132:(e,t,i)=>{i.r(t),i.d(t,{iblGenerateVoxelMipPixelShaderWGSL:()=>s});const r="iblGenerateVoxelMipPixelShader",n="varying vUV: vec2f;var srcMip: texture_3d<f32>;uniform layerNum: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var Coords=vec3i(2)*vec3i(vec2i(fragmentInputs.position.xy),uniforms.layerNum);var tex =\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,0),0).x>0.0f))\n<< 0u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,0),0).x>0.0f))\n<< 1u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,0),0).x>0.0f))\n<< 2u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,0),0).x>0.0f))\n<< 3u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,1),0).x>0.0f))\n<< 4u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,1),0).x>0.0f))\n<< 5u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,1),0).x>0.0f))\n<< 6u) |\n(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,1),0).x>0.0f))\n<< 7u);fragmentOutputs.color=vec4f( f32(tex)/255.0f,0.0f,0.0f,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},2785:(e,t,i)=>{i.r(t),i.d(t,{iblIcdfxPixelShaderWGSL:()=>s});const r="iblIcdfxPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;var cdfx: texture_2d<f32>;fn fetchCDF(x: u32)->f32 {return textureLoad(cdfx, vec2u(x,0),0).x;}\nfn bisect(size: u32,targetValue: f32)->f32\n{var a: u32=0;var b=size-1;while (b-a>1) {var c: u32=(a+b)>>1;if (fetchCDF(c)<targetValue) {a=c;}\nelse {b=c;}}\nreturn mix( f32(a), f32(b),(targetValue-fetchCDF(a))/(fetchCDF(b)-fetchCDF(a)))/ f32(size-1);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfSize: vec2u=textureDimensions(cdfx,0);var cdfWidth: u32=cdfSize.x;var icdfWidth: u32=cdfWidth-1;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);if (currentPixel.x==0)\n{fragmentOutputs.color= vec4f(0.0);}\nelse if (currentPixel.x==icdfWidth-1) {fragmentOutputs.color= vec4f(1.0);} else {var targetValue: f32=fetchCDF(cdfWidth-1)*input.vUV.x;fragmentOutputs.color= vec4f( vec3f(bisect(cdfWidth,targetValue)),1.0);}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},25880:(e,t,i)=>{i.r(t),i.d(t,{iblIcdfyPixelShaderWGSL:()=>s});const r="iblIcdfyPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;var cdfy: texture_2d<f32>;fn fetchCDF(y: u32,invocationId: u32)->f32 {return textureLoad(cdfy, vec2u(invocationId,y),0).x;}\nfn bisect(size: u32,targetValue: f32,invocationId: u32)->f32\n{var a: u32=0;var b=size-1;while (b-a>1) {var c=(a+b)>>1;if (fetchCDF(c,invocationId)<targetValue) {a=c;}\nelse {b=c;}}\nreturn mix( f32(a), f32(b),(targetValue-fetchCDF(a,invocationId))/(fetchCDF(b,invocationId)-fetchCDF(a,invocationId)))/ f32(size-1);}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var cdfSize: vec2u=textureDimensions(cdfy,0);var cdfHeight: u32=cdfSize.y;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);if (currentPixel.y==0) {fragmentOutputs.color= vec4f(0.0);}\nelse if (currentPixel.y==cdfHeight-2) {fragmentOutputs.color= vec4f(1.0);} else {var targetValue: f32=fetchCDF(cdfHeight-1,currentPixel.x)*input.vUV.y;fragmentOutputs.color= vec4f( vec3f(bisect(cdfHeight,targetValue,currentPixel.x)),1.0);}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},94078:(e,t,i)=>{i.r(t),i.d(t,{iblShadowAccumulationPixelShaderWGSL:()=>s});const r="iblShadowAccumulationPixelShader",n="varying vUV: vec2f;uniform accumulationParameters: vec4f;\n#define remanence uniforms.accumulationParameters.x\n#define resetb uniforms.accumulationParameters.y\n#define sceneSize uniforms.accumulationParameters.z\nvar motionSampler: texture_2d<f32>;var positionSampler: texture_2d<f32>;var spatialBlurSampler : texture_2d<f32>;var oldAccumulationSamplerSampler: sampler;var oldAccumulationSampler: texture_2d<f32>;var prevPositionSamplerSampler: sampler;var prevPositionSampler: texture_2d<f32>;fn max2(v: vec2f,w: vec2f)->vec2f { \nreturn vec2f(max(v.x,w.x),max(v.y,w.y)); }\nfn lessThan(x: vec2f,y: vec2f)->vec2<bool> {return x<y;}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var reset: bool= bool(resetb);var gbufferRes : vec2f=vec2f(textureDimensions(positionSampler,0));var gbufferPixelCoord: vec2i= vec2i(input.vUV*gbufferRes);var shadowRes : vec2f=vec2f(textureDimensions(spatialBlurSampler,0));var shadowPixelCoord: vec2i= vec2i(input.vUV*shadowRes);var LP: vec4f=textureLoad(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {fragmentOutputs.color=vec4f(1.0,0.0,0.0,1.0);return fragmentOutputs;}\nvar velocityColor: vec2f=textureLoad(motionSampler,gbufferPixelCoord,0).xy;var prevCoord: vec2f=input.vUV+velocityColor;var PrevLP: vec3f=textureSampleLevel(prevPositionSampler,prevPositionSamplerSampler,prevCoord,0.0).xyz;var PrevShadows: vec3f=textureSampleLevel(oldAccumulationSampler,oldAccumulationSamplerSampler,prevCoord,0.0).xyz;var newShadows : vec2f=textureLoad(spatialBlurSampler,shadowPixelCoord,0).xy;PrevShadows.z=select(1.0,max(PrevShadows.z/(1.0+PrevShadows.z),1.0-remanence),!reset && all(lessThan(abs(prevCoord- vec2f(0.5)), vec2f(0.5))) &&\ndistance(LP.xyz,PrevLP)<5e-2*sceneSize);PrevShadows=max( vec3f(0.0),PrevShadows);fragmentOutputs.color= vec4f(mix(PrevShadows.x,newShadows.x,PrevShadows.z),\nmix(PrevShadows.y,newShadows.y,PrevShadows.z),PrevShadows.z,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},74550:(e,t,i)=>{i.r(t),i.d(t,{iblShadowDebugPixelShaderWGSL:()=>s});const r="iblShadowDebugPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;uniform sizeParams: vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+fragmentInputs.vUV.x)*widthScale,(offsetY+fragmentInputs.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV);var debugColour: vec4f=textureSample(debugSampler,debugSamplerSampler,fragmentInputs.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {fragmentOutputs.color=vec4f(mix(debugColour.rgb,background.rgb,0.0),1.0);}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},15465:(e,t,i)=>{i.r(t),i.d(t,{iblShadowGBufferDebugPixelShaderWGSL:()=>s});const r="iblShadowGBufferDebugPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var depthSampler: sampler;var depthTexture: texture_2d<f32>;var normalSampler: sampler;var normalTexture: texture_2d<f32>;var positionSampler: sampler;var positionTexture: texture_2d<f32>;var velocitySampler: sampler;var velocityTexture: texture_2d<f32>;uniform sizeParams: vec4f;uniform maxDepth: f32;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var backgroundColour: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgba;var depth: vec4f=textureSample(depthTexture,depthSampler,input.vUV);var worldNormal: vec4f=textureSample(normalTexture,normalSampler,input.vUV);var worldPosition: vec4f=textureSample(positionTexture,positionSampler,input.vUV);var velocityLinear: vec4f=textureSample(velocityTexture,velocitySampler,input.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=backgroundColour;} else {if (uv.x<=0.25) {fragmentOutputs.color=vec4f(depth.rgb,1.0);} else if (uv.x<=0.5) {velocityLinear=vec4f(velocityLinear.r*0.5+0.5,velocityLinear.g*0.5+0.5,velocityLinear.b,velocityLinear.a);fragmentOutputs.color=vec4f(velocityLinear.rgb,1.0);} else if (uv.x<=0.75) {fragmentOutputs.color=vec4f(worldPosition.rgb,1.0);} else {fragmentOutputs.color=vec4f(worldNormal.rgb,1.0);}}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},93632:(e,t,i)=>{i.r(t),i.d(t,{iblShadowSpatialBlurPixelShaderWGSL:()=>s});const r="iblShadowSpatialBlurPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;var depthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var voxelTracingSampler : texture_2d<f32>;uniform blurParameters: vec4f;\n#define stridef uniforms.blurParameters.x\n#define worldScale uniforms.blurParameters.y\nconst weights=array<f32,5>(0.0625,0.25,0.375,0.25,0.0625);const nbWeights: i32=5;fn max2(v: vec2f,w: vec2f)->vec2f {return vec2f(max(v.x,w.x),max(v.y,w.y));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var gbufferRes=vec2f(textureDimensions(depthSampler,0));var gbufferPixelCoord= vec2i(fragmentInputs.vUV*gbufferRes);var shadowRes=vec2f(textureDimensions(voxelTracingSampler,0));var shadowPixelCoord= vec2i(fragmentInputs.vUV*shadowRes);var N: vec3f=textureLoad(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}\nvar depth: f32=-textureLoad(depthSampler,gbufferPixelCoord,0).x;var X: vec3f= vec3f(0.0);for(var y: i32=0; y<nbWeights; y++) {for(var x: i32=0; x<nbWeights; x++) {var gBufferCoords: vec2i=gbufferPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var shadowCoords: vec2i=shadowPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var T : vec2f=textureLoad(voxelTracingSampler,shadowCoords,0).xy;var ddepth: f32=-textureLoad(depthSampler,gBufferCoords,0).x-depth;var dN: vec3f=textureLoad(worldNormalSampler,gBufferCoords,0).xyz-N;var w: f32=weights[x]*weights[y] *\nexp2(max(-1000.0/(worldScale*worldScale),-0.5) *\n(ddepth*ddepth) -\n1e1*dot(dN,dN));X+= vec3f(w*T.x,w*T.y,w);}}\nfragmentOutputs.color= vec4f(X.x/X.z,X.y/X.z,0.0,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},68225:(e,t,i)=>{i.r(t),i.d(t,{iblShadowVoxelTracingPixelShaderWGSL:()=>s});const r="iblShadowVoxelTracingPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;\n#define DISABLE_UNIFORMITY_ANALYSIS\nvar depthSampler: texture_2d<f32>;var worldNormalSampler : texture_2d<f32>;var blueNoiseSampler: texture_2d<f32>;var icdfxSamplerSampler: sampler;var icdfxSampler: texture_2d<f32>;var icdfySamplerSampler: sampler;var icdfySampler: texture_2d<f32>;var voxelGridSamplerSampler: sampler;var voxelGridSampler: texture_3d<f32>;uniform shadowParameters: vec4f;\n#define SHADOWdirs uniforms.shadowParameters.x\n#define SHADOWframe uniforms.shadowParameters.y\n#define SHADOWenvRot uniforms.shadowParameters.w\nuniform voxelBiasParameters : vec4f;\n#define highestMipLevel uniforms.voxelBiasParameters.z\nuniform sssParameters: vec4f;\n#define SSSsamples uniforms.sssParameters.x\n#define SSSstride uniforms.sssParameters.y\n#define SSSmaxDistance uniforms.sssParameters.z\n#define SSSthickness uniforms.sssParameters.w\nuniform shadowOpacity: vec4f;uniform projMtx: mat4x4f;uniform viewMtx: mat4x4f;uniform invProjMtx: mat4x4f;uniform invViewMtx: mat4x4f;uniform wsNormalizationMtx: mat4x4f;uniform invVPMtx: mat4x4f;\n#define PI 3.1415927\n#define GOLD 0.618034\nstruct AABB3f {m_min: vec3f,\nm_max: vec3f,};struct Ray {orig: vec3f,\ndir: vec3f,\ndir_rcp: vec3f,\nt_min: f32,\nt_max: f32,};fn make_ray(origin: vec3f,direction: vec3f,tmin: f32,\ntmax: f32)->Ray {var ray: Ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}\nfn ray_box_intersection(aabb: AABB3f,ray: Ray ,\ndistance_near: ptr<function,f32>,distance_far: ptr<function,f32>)->bool{var tbot: vec3f=ray.dir_rcp*(aabb.m_min-ray.orig);var ttop: vec3f=ray.dir_rcp*(aabb.m_max-ray.orig);var tmin: vec3f=min(ttop,tbot);var tmax: vec3f=max(ttop,tbot);*distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));*distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return *distance_near<=*distance_far;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nstruct VoxelMarchDiagnosticInfo {heat: f32,\nvoxel_intersect_coords: vec3i,};\n#endif\nfn hash(i: u32)->u32 {var temp=i ^ (i>>16u);temp*=0x7FEB352Du;temp ^= temp>>15u;temp*=0x846CA68Bu;temp ^= temp>>16u;return temp;}\nfn uintBitsToFloat(x: u32)->f32 {return bitcast<f32>(x);}\nfn uint2float(i: u32)->f32 {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}\nfn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nfn plasticSequence(rstate: u32)->vec2f {return vec2f(uint2float(rstate*3242174889u),\nuint2float(rstate*2447445414u));}\nfn goldenSequence(rstate: u32)->f32 {return uint2float(rstate*2654435769u);}\nfn distanceSquared(a: vec2f,b: vec2f)->f32 {var diff: vec2f=a-b;return dot(diff,diff);}\nfn genTB(N: vec3f,T: ptr<function,vec3f>,B: ptr<function,vec3f>) {var s: f32=select(1.0,-1.0,N.z<0.0);var a: f32=-1.0/(s+N.z);var b: f32=N.x*N.y*a;*T= vec3f(1.0+s*N.x*N.x*a,s*b,-s*N.x);*B= vec3f(b,s+N.y*N.y*a,-N.y);}\nfn lessThan(x: vec3f,y: vec3f)->vec3<bool> {return x<y;}\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfn anyHitVoxels(ray_vs: Ray,\nvoxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->bool {\n#else\nfn anyHitVoxels(ray_vs: Ray)->bool {\n#endif\nvar stack=array<i32,24>(); \nvar invD: vec3f=ray_vs.dir_rcp;var D: vec3f=ray_vs.dir;var O: vec3f=ray_vs.orig;var negD=vec3i(lessThan(D, vec3f(0,0,0)));var voxel0: i32=negD.x | (negD.y<<1) | (negD.z<<2);var t0: vec3f=-O*invD;var t1=(vec3f(1.0)-O)*invD;var maxLod: i32= i32(highestMipLevel);var stackLevel: i32=0;\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvar steps: u32=0u;\n#endif\nstack[stackLevel]=maxLod<<24;stackLevel++;while (stackLevel>0) {stackLevel=stackLevel-1;var elem: i32=stack[stackLevel];var Coords: vec4i =\nvec4i(elem & 0xFF,(elem>>8) & 0xFF,(elem>>16) & 0xFF,elem>>24);if (Coords.w==0) {\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n*voxel_march_diagnostic_info.heat= f32(steps)/24.0;\n#endif\nreturn true;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n++steps;\n#endif\nvar invRes: f32=exp2(f32(Coords.w-maxLod));var bbmin: vec3f=invRes*vec3f(Coords.xyz+negD);var bbmax: vec3f=invRes*vec3f(Coords.xyz-negD+vec3i(1));var mint: vec3f=mix(t0,t1,bbmin);var maxt: vec3f=mix(t0,t1,bbmax);var midt: vec3f=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);var nodeMask: u32= u32(\nround(textureLoad(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;var voxelBit: u32=u32(voxel0);Coords=vec4i((Coords.xyz<<vec3u(1))+negD,Coords.w);var packedCoords: i32 =\nCoords.x | (Coords.y<<8) | (Coords.z<<16) | (Coords.w<<24);if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}\nvoxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&\n((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\n*voxel_march_diagnostic_info.heat= f32(steps)/24.0;\n#endif\nreturn false;}\nfn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {return (near*far)/(far-depth*(far-near));}\nfn screenSpaceShadow(csOrigin: vec3f,csDirection: vec3f,csZBufferSize: vec2f,\nnearPlaneZ: f32,farPlaneZ: f32,noise: f32)->f32 {\n#ifdef RIGHT_HANDED\nvar csZDir : f32=-1.0;\n#else \nvar csZDir : f32=1.0;\n#endif\nvar ssSamples: f32=SSSsamples;var ssMaxDist: f32=SSSmaxDistance;var ssStride: f32=SSSstride;var ssThickness: f32=SSSthickness;var rayLength: f32 =\nselect(ssMaxDist,(nearPlaneZ-csOrigin.z)/csDirection.z,\ncsZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ);var csEndPoint: vec3f=csOrigin+rayLength*csDirection;var H0: vec4f=uniforms.projMtx*vec4f(csOrigin,1.0);var H1: vec4f=uniforms.projMtx*vec4f(csEndPoint,1.0);var Z0=vec2f(csOrigin.z ,1.0)/H0.w;var Z1=vec2f(csEndPoint.z,1.0)/H1.w;var P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);var P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}\nvar stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f=ssStride* vec2f(stepDirection,invdx*delta.y);var dZ: vec2f=ssStride*invdx*(Z1-Z0);var opacity: f32=0.0;var P: vec2f=P0+noise*dP;var Z: vec2f=Z0+noise*dZ;var end: f32=P1.x*stepDirection;var rayZMax=csZDir*Z.x/Z.y;var sceneDepth=rayZMax;Z+=dZ;for (var stepCount: f32=0.0; \nopacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount+=1) { \nvar coords=vec2i(select(P,P.yx,permute));sceneDepth=textureLoad(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}\nvar rayZMin: f32=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));P+=dP;Z+=dZ;}\nreturn opacity;}\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,\nDitherNoise: vec2f,\nvoxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->f32 {\n#else\nfn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,\nDitherNoise: vec2f)->f32 {\n#endif\nvar vxResolution: f32=f32(textureDimensions(voxelGridSampler,0).x);var T: vec3f;var B: vec3f;genTB(wsDirection,&T,&B);var DitherXY: vec2f=sqrt(DitherNoise.x)* vec2f(cos(2.0*PI*DitherNoise.y),\nsin(2.0*PI*DitherNoise.y));var Dithering : vec3f=(uniforms.voxelBiasParameters.x*wsNormal +\nuniforms.voxelBiasParameters.y*wsDirection +\nDitherXY.x*T+DitherXY.y*B) /\nvxResolution;var O: vec3f=0.5*wsOrigin+0.5+Dithering;var ray_vs=make_ray(O,wsDirection,0.0,10.0);var voxel_aabb: AABB3f;voxel_aabb.m_min=vec3f(0);voxel_aabb.m_max=vec3f(1);var near: f32=0;var far: f32=0;if (!ray_box_intersection(voxel_aabb,ray_vs,&near,&far)) {return 0.0;}\nray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);\n#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nreturn select(0.0f,1.0f,anyHitVoxels(ray_vs,voxel_march_diagnostic_info));\n#else\nreturn select(0.0f,1.0f,anyHitVoxels(ray_vs));\n#endif\n}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var nbDirs=u32(SHADOWdirs);var frameId=u32(SHADOWframe);var envRot: f32=SHADOWenvRot;var Resolution: vec2f= vec2f(textureDimensions(depthSampler,0));var currentPixel=vec2i(fragmentInputs.vUV*Resolution);var GlobalIndex =\n(frameId*u32(Resolution.y)+u32(currentPixel.y))*u32(Resolution.x) +\nu32(currentPixel.x);var N : vec3f=textureLoad(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}\nvar normalizedRotation: f32=envRot/(2.0*PI);var depth : f32=textureLoad(depthSampler,currentPixel,0).x;\n#ifndef IS_NDC_HALF_ZRANGE\ndepth=depth*2.0-1.0;\n#endif\nvar temp : vec2f=(vec2f(currentPixel)+vec2f(0.5))*2.0/Resolution -\nvec2f(1.0);var VP : vec4f=uniforms.invProjMtx*vec4f(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);var noise\n: vec3f =\ntextureLoad(blueNoiseSampler,currentPixel & vec2i(0xFF),0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nvar heat: f32=0.0f;\n#endif\nvar shadowAccum: f32=0.0;var specShadowAccum: f32=0.0;var sampleWeight : f32=0;for (var i: u32=0; i<nbDirs; i++) {var dirId: u32=nbDirs*GlobalIndex+i;var L: vec4f;{var r: vec2f=plasticSequence(frameId*nbDirs+i);r=fract(r+ vec2f(2.0)*abs(noise.xy- vec2f(0.5)));var T: vec2f;T.x=textureSampleLevel(icdfxSampler,icdfxSamplerSampler,vec2f(r.x,0.0),0.0).x;T.y=textureSampleLevel(icdfySampler,icdfySamplerSampler,vec2f(T.x,r.y),0.0).x;T.x-=normalizedRotation;L= vec4f(uv_to_normal(T),0);\n#ifndef RIGHT_HANDED\nL.z*=-1.0;\n#endif\n}\nvar edge_tint_const=-0.001;var cosNL: f32=dot(N,L.xyz);var opacity: f32=select(0.0,1.0,cosNL<edge_tint_const);if (cosNL>edge_tint_const) {var VP2: vec4f=VP;VP2.y*=-1.0;var unormWP : vec4f=uniforms.invViewMtx*VP2;var WP: vec3f=(uniforms.wsNormalizationMtx*unormWP).xyz;var vxNoise: vec2f =\nvec2f(uint2float(hash(dirId*2)),uint2float(hash(dirId*2+1)));\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nVoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,\nuniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,\nvoxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;\n#else\nopacity =\nmax(opacity,uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));\n#endif\nvar VL : vec3f=(uniforms.viewMtx*L).xyz;\n#ifdef RIGHT_HANDED\nvar nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0); \nvar farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0);\n#else\nvar nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0); \nvar farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0);\n#endif\nvar ssShadow: f32=uniforms.shadowOpacity.y *\nscreenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,\nabs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);shadowAccum+=min(1.0-opacity,cosNL);sampleWeight+=cosNL;var VR : vec3f=-(uniforms.viewMtx*vec4f(reflect(-L.xyz,N),0.0)).xyz;specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);}\nnoise.z=fract(noise.z+GOLD);}\n#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION\nfragmentOutputs.color =\nvec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,heat/sampleWeight,1.0);\n#else\nfragmentOutputs.color=vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,0.0,1.0);\n#endif\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},72439:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridPixelShaderWGSL:()=>s});const r="iblVoxelGridPixelShader",n="varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;if (normPos.z<uniforms.nearPlane || normPos.z>uniforms.farPlane) {discard;}\nfragmentOutputs.fragData0=select(vec4f(0.0),vec4f(1.0),normPos.z<uniforms.nearPlane+uniforms.stepSize);fragmentOutputs.fragData1=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+uniforms.stepSize && normPos.z<uniforms.nearPlane+2.0*uniforms.stepSize);fragmentOutputs.fragData2=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+2.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+3.0*uniforms.stepSize);fragmentOutputs.fragData3=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+3.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+4.0*uniforms.stepSize);\n#if MAX_DRAW_BUFFERS>4\nfragmentOutputs.fragData4=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+4.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+5.0*uniforms.stepSize);fragmentOutputs.fragData5=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+5.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+6.0*uniforms.stepSize);fragmentOutputs.fragData6=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+6.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+7.0*uniforms.stepSize);fragmentOutputs.fragData7=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+7.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+8.0*uniforms.stepSize);\n#endif\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},69553:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGridVertexShaderWGSL:()=>s});const r="iblVoxelGridVertexShader",n="attribute position: vec3f;attribute normal: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform viewMatrix: mat4x4f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.viewMatrix*uniforms.invWorldScale*uniforms.world* vec4f(input.position,1.);vertexOutputs.vNormalizedPosition=vertexOutputs.position.xyz*0.5+0.5;\n#ifdef IS_NDC_HALF_ZRANGE\nvertexOutputs.position=vec4f(vertexOutputs.position.x,vertexOutputs.position.y,vertexOutputs.position.z*0.5+0.5,vertexOutputs.position.w);\n#endif\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},2765:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid2dArrayDebugPixelShaderWGSL:()=>s});const r="iblVoxelGrid2dArrayDebugPixelShader",n="varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform slice: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var size: vec3u=textureDimensions(voxelTexture,0);var dimension: f32=sqrt( f32(size.z));var samplePos: vec2f=fract(input.vUV.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(input.vUV.x* f32(dimension))+floor(input.vUV.y* f32(dimension))*dimension);var color=textureSample(voxelTexture,voxelTextureSampler, vec3f(samplePos.xy,sampleIndex)).rrr;color+=textureSample(textureSampler,textureSamplerSampler,input.vUV.xy).rgb;fragmentOutputs.color=vec4f(color,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},5025:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelGrid3dDebugPixelShaderWGSL:()=>s});const r="iblVoxelGrid3dDebugPixelShader",n="varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var voxelSlabTextureSampler: sampler;var voxelSlabTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform sizeParams: vec4f;\n#define offsetX uniforms.sizeParams.x\n#define offsetY uniforms.sizeParams.y\n#define widthScale uniforms.sizeParams.z\n#define heightScale uniforms.sizeParams.w\nuniform mipNumber: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =\nvec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var voxelSlab: vec4f=textureSample(voxelSlabTexture,voxelSlabTextureSampler,input.vUV);var size: vec3u=textureDimensions(voxelTexture, i32(uniforms.mipNumber));var dimension: f32=ceil(sqrt( f32(size.z)));var samplePos: vec2f=fract(uv.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(uv.x* f32(dimension)) +\nfloor(uv.y* f32(dimension))*dimension);var mip_separator: f32=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}\nvar outBounds: bool=select(false,true,sampleIndex>size.z-1);sampleIndex=clamp(sampleIndex,0,size.z-1);var samplePosInt: vec2i= vec2i(samplePos.xy* vec2f(size.xy));var voxel: vec3f=textureLoad(voxelTexture,\nvec3i(i32(samplePosInt.x),i32(samplePosInt.y),i32(sampleIndex)),\ni32(uniforms.mipNumber)).rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {if (outBounds) {voxel= vec3f(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}\nvoxel.r+=mip_separator;}\nfragmentOutputs.color=vec4f(mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel,1.0);}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},50342:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugPixelShaderWGSL:()=>s});const r="iblVoxelSlabDebugPixelShader",n="varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;var chunkSize: f32=uniforms.stepSize* f32(MAX_DRAW_BUFFERS);var numChunks: f32=1.0/chunkSize;var positionInChunk: f32=fract(normPos.z/chunkSize);var slab: f32=floor(positionInChunk* f32(MAX_DRAW_BUFFERS)) /\nf32(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||\nnormPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {fragmentOutputs.color= vec4f(0.0,0.0,0.0,0.0);} else {fragmentOutputs.color= vec4f(slab,0.0,0.0,0.75);}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},77356:(e,t,i)=>{i.r(t),i.d(t,{iblVoxelSlabDebugVertexShaderWGSL:()=>s});const r="iblVoxelSlabDebugVertexShader",n="attribute position: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform cameraViewMatrix: mat4x4f;uniform projection: mat4x4f;uniform viewMatrix: mat4x4f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {var worldPosition: vec4f=(uniforms.world* vec4f(input.position,1.));vertexOutputs.position=uniforms.projection*uniforms.cameraViewMatrix*worldPosition;vertexOutputs.vNormalizedPosition=(uniforms.viewMatrix*uniforms.invWorldScale*worldPosition).rgb;vertexOutputs.vNormalizedPosition=vertexOutputs.vNormalizedPosition* vec3f(0.5)+ vec3f(0.5);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},55898:(e,t,i)=>{i.r(t),i.d(t,{imageProcessingPixelShaderWGSL:()=>a});var r=i(43862);i(93673),i(68458),i(76224);const n="imageProcessingPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult=vec4f(toLinearSpaceVec3(result.rgb),result.a);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\nfragmentOutputs.color=result;}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},70730:(e,t,i)=>{i.r(t),i.d(t,{importanceSamplingDebugPixelShaderWGSL:()=>s});const r="importanceSamplingDebugPixelShader",n="#define PI 3.1415927\nvarying vUV: vec2f;var cdfySampler: sampler;var cdfy: texture_2d<f32>;var icdfySampler: sampler;var icdfy: texture_2d<f32>;var cdfxSampler: sampler;var cdfx: texture_2d<f32>;var icdfxSampler: sampler;var icdfx: texture_2d<f32>;\n#ifdef IBL_USE_CUBE_MAP\nvar iblSourceSampler: sampler;var iblSource: texture_cube<f32>;\n#else\nvar iblSourceSampler: sampler;var iblSource: texture_2d<f32>;\n#endif\nvar textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define cdfyVSize 0.4\n#define cdfxVSize 0.1\n#define cdfyHSize 0.5\nuniform sizeParams: vec4f;\n#ifdef IBL_USE_CUBE_MAP\nfn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs { \nvar colour: vec3f= vec3f(0.0);var uv: vec2f =\nvec2f((uniforms.sizeParams.x+input.vUV.x)*uniforms.sizeParams.z,(uniforms.sizeParams.y+input.vUV.y)*uniforms.sizeParams.w);var backgroundColour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;const iblStart: f32=1.0-cdfyVSize;const cdfyStart: f32=1.0-2.0*cdfyVSize;const cdfxStart: f32=1.0-2.0*cdfyVSize-cdfxVSize;const icdfxStart: f32=1.0-2.0*cdfyVSize-2.0*cdfxVSize;\n#ifdef IBL_USE_CUBE_MAP\nvar direction: vec3f=equirectangularToCubemapDirection(\n(uv- vec2f(0.0,iblStart))* vec2f(1.0,1.0/cdfyVSize));var iblColour: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;\n#else\nvar iblColour: vec3f=textureSample(iblSource,iblSourceSampler,(uv- vec2f(0.0,iblStart)) *\nvec2f(1.0,1.0/cdfyVSize))\n.rgb;\n#endif\nvar cdfyColour: f32 =\ntextureSample(cdfy,cdfySampler,(uv- vec2f(0.0,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var icdfyColour: f32 =\ntextureSample(icdfy,icdfySampler,(uv- vec2f(0.5,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var cdfxColour: f32 =\ntextureSample(cdfx,cdfxSampler,(uv- vec2f(0.0,cdfxStart))* vec2f(1.0,1.0/cdfxVSize)).r;var icdfxColour: f32=textureSample(icdfx,icdfxSampler,(uv- vec2f(0.0,icdfxStart)) *\nvec2f(1.0,1.0/cdfxVSize)).r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=0.003*cdfyColour;} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=0.00003*cdfxColour;} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}\nfragmentOutputs.color =vec4(mix(colour,backgroundColour,0.5),1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},17374:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurPixelShaderWGSL:()=>a});var r=i(43862);i(28843),i(79643);r.l.IncludesShadersStoreWGSL.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;\n#endif\n";r.l.IncludesShadersStoreWGSL.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";const n="kernelBlurPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;\n#ifdef DOF\nvar circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;\n#ifdef PACKEDFLOAT\nvar blend: f32=0.;\n#else\nvar blend: vec4f= vec4f(0.);\n#endif\n#ifdef DOF\nvar sumOfWeights: f32=CENTER_WEIGHT; \nvar factor: f32=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\nfragmentOutputs.color=pack(blend);\n#else\nfragmentOutputs.color=blend;\n#endif\n#ifdef DOF\nfragmentOutputs.color/=sumOfWeights;\n#endif\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},40932:(e,t,i)=>{i.r(t),i.d(t,{kernelBlurVertexShaderWGSL:()=>a});var r=i(43862);i(28843);r.l.IncludesShadersStoreWGSL.kernelBlurVertex="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";const n="kernelBlurVertexShader",s="attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.sampleCenter=(input.position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\nvertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},32379:(e,t,i)=>{i.r(t),i.d(t,{layerPixelShaderWGSL:()=>a});var r=i(43862);i(68458);const n="layerPixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#if defined(CONVERT_TO_GAMMA)\nbaseColor=toGammaSpace(baseColor);\n#elif defined(CONVERT_TO_LINEAR)\nbaseColor=toLinearSpaceVec4(baseColor);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\nfragmentOutputs.color=baseColor*uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},31333:(e,t,i)=>{i.r(t),i.d(t,{layerVertexShaderWGSL:()=>s});const r="layerVertexShader",n="attribute position: vec2f;uniform scale: vec2f;uniform offset: vec2f;uniform textureMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar shiftedPosition: vec2f=input.position*uniforms.scale+uniforms.offset;vertexOutputs.vUV=(uniforms.textureMatrix* vec4f(shiftedPosition*madd+madd,1.0,0.0)).xy;vertexOutputs.position= vec4f(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},31660:(e,t,i)=>{i.r(t),i.d(t,{lensFlarePixelShaderWGSL:()=>s});const r="lensFlarePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=baseColor*uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},38682:(e,t,i)=>{i.r(t),i.d(t,{lensFlareVertexShaderWGSL:()=>s});const r="lensFlareVertexShader",n="attribute position: vec2f;uniform viewportMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position=uniforms.viewportMatrix* vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},16996:(e,t,i)=>{i.r(t),i.d(t,{linePixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(26774),i(46112),i(72207);const n="linePixelShader",s="#include<clipPlaneFragmentDeclaration>\nuniform color: vec4f;\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<logDepthFragment>\n#include<clipPlaneFragment>\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},88034:(e,t,i)=>{i.r(t),i.d(t,{lineVertexShaderWGSL:()=>a});var r=i(43862);i(90483),i(45737),i(31371),i(90270),i(26774),i(9929),i(22713),i(98830);const n="lineVertexShader",s="#define ADDITIONAL_VERTEX_DECLARATION\n#include<instancesDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\nattribute position: vec3f;attribute normal: vec4f;uniform width: f32;uniform aspectRatio: f32;\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\nvar worldViewProjection: mat4x4f=scene.viewProjection*finalWorld;var viewPosition: vec4f=worldViewProjection* vec4f(input.position,1.0);var viewPositionNext: vec4f=worldViewProjection* vec4f(input.normal.xyz,1.0);var currentScreen: vec2f=viewPosition.xy/viewPosition.w;var nextScreen: vec2f=viewPositionNext.xy/viewPositionNext.w;currentScreen=vec2f(currentScreen.x*uniforms.aspectRatio,currentScreen.y);nextScreen=vec2f(nextScreen.x*uniforms.aspectRatio,nextScreen.y);var dir: vec2f=normalize(nextScreen-currentScreen);var normalDir: vec2f= vec2f(-dir.y,dir.x);normalDir*=uniforms.width/2.0;normalDir=vec2f(normalDir.x/uniforms.aspectRatio,normalDir.y);var offset: vec4f= vec4f(normalDir*input.normal.w,0.0,0.0);vertexOutputs.position=viewPosition+offset;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nvar worldPos: vec4f=finalWorld*vec4f(input.position,1.0);\n#include<clipPlaneVertex>\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},46153:(e,t,i)=>{i.r(t),i.d(t,{lodPixelShaderWGSL:()=>s});const r="lodPixelShader",n="const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform lod: f32;uniform gamma: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,fragmentInputs.vUV,uniforms.lod);if (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},4894:(e,t,i)=>{i.r(t),i.d(t,{lodCubePixelShaderWGSL:()=>s});const r="lodCubePixelShader",n="const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;uniform lod: f32;uniform gamma: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let uv=fragmentInputs.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x),uniforms.lod);\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x),uniforms.lod);\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x),uniforms.lod);\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x),uniforms.lod);\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,1.001),uniforms.lod);\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,-1.001),uniforms.lod);\n#endif\nif (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},84613:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererPixelShaderWGSL:()=>s});const r="meshUVSpaceRendererPixelShader",n="varying vDecalTC: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {if (input.vDecalTC.x<0. || input.vDecalTC.x>1. || input.vDecalTC.y<0. || input.vDecalTC.y>1.) {discard;}\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vDecalTC);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},34863:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(90483),i(95030),i(56205),i(9929),i(36674),i(32910);const n="meshUVSpaceRendererVertexShader",s="attribute position: vec3f;attribute normal: vec3f;attribute uv: vec2f;uniform projMatrix: mat4x4f;varying vDecalTC: vec2f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);var vNormalW: vec3f;\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvNormalW=normalize(normWorldSM*normalUpdated);\n#endif\nvar normalView: vec3f=normalize((uniforms.projMatrix* vec4f(vNormalW,0.0)).xyz);var decalTC: vec3f=(uniforms.projMatrix*worldPos).xyz;vertexOutputs.vDecalTC=decalTC.xy;vertexOutputs.position=vec4f(input.uv*2.0-1.0,select(decalTC.z,2.,normalView.z>0.0),1.0);}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},95552:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserPixelShaderWGSL:()=>s});const r="meshUVSpaceRendererFinaliserPixelShader",n="#define DISABLE_UNIFORMITY_ANALYSIS\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var maskTextureSamplerSampler: sampler;var maskTextureSampler: texture_2d<f32>;uniform textureSize: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var mask: vec4f=textureSample(maskTextureSampler,maskTextureSamplerSampler,input.vUV).rgba;if (mask.r>0.5) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);} else {var texelSize: vec2f=4.0/uniforms.textureSize;var uv_p01: vec2f=input.vUV+ vec2f(-1.0,0.0)*texelSize;var uv_p21: vec2f=input.vUV+ vec2f(1.0,0.0)*texelSize;var uv_p10: vec2f=input.vUV+ vec2f(0.0,-1.0)*texelSize;var uv_p12: vec2f=input.vUV+ vec2f(0.0,1.0)*texelSize;var mask_p01: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p01).r;var mask_p21: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p21).r;var mask_p10: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p10).r;var mask_p12: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p12).r;var col: vec4f= vec4f(0.0,0.0,0.0,0.0);var total_weight: f32=0.0;if (mask_p01>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p01);total_weight+=1.0;}\nif (mask_p21>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p21);total_weight+=1.0;}\nif (mask_p10>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p10);total_weight+=1.0;}\nif (mask_p12>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p12);total_weight+=1.0;}\nif (total_weight>0.0) {fragmentOutputs.color=col/total_weight;} else {fragmentOutputs.color=col;}}}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},6286:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererFinaliserVertexShaderWGSL:()=>s});const r="meshUVSpaceRendererFinaliserVertexShader",n="attribute position: vec3f;attribute uv: vec2f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection* vec4f(input.position,1.0);vertexOutputs.positionvUV=input.uv;}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},69536:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerPixelShaderWGSL:()=>s});const r="meshUVSpaceRendererMaskerPixelShader",n="varying vUV: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color= vec4f(1.0,1.0,1.0,1.0);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},58990:(e,t,i)=>{i.r(t),i.d(t,{meshUVSpaceRendererMaskerVertexShaderWGSL:()=>s});const r="meshUVSpaceRendererMaskerVertexShader",n="attribute uv: vec2f;varying vUV: vec2f;@vertex\nfn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position= vec4f( vec2f(input.uv.x,input.uv.y)*2.0-1.0,0.,1.0);vertexOutputs.vUV=input.uv;}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},11071:(e,t,i)=>{i.r(t),i.d(t,{motionBlurPixelShaderWGSL:()=>s});const r="motionBlurPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform motionStrength: f32;uniform motionScale: f32;uniform screenSize: vec2f;\n#ifdef OBJECT_BASED\nvar velocitySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;\n#else\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform inverseViewProjection: mat4x4f;uniform prevViewProjection: mat4x4f;uniform projection: mat4x4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvar texelSize: vec2f=1.0/uniforms.screenSize;var velocityColor: vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);velocityColor=vec4f(velocityColor.rg*2.0- vec2f(1.0),velocityColor.b,velocityColor.a);var velocity: vec2f= vec2f(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var samplesCount: i32= i32(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;var hlim: f32= f32(-samplesCount)*0.5+0.5;var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++)\n{if (i>=samplesCount) {break;}\nvar offset: vec2f=input.vUV+velocity*(hlim+ f32(i));\n#if defined(WEBGPU)\nresult+=textureSampleLevel(textureSampler,textureSamplerSampler, offset,0.0);\n#else\nresult+=textureSample(textureSampler,textureSamplerSampler, offset);\n#endif\n}\nfragmentOutputs.color=vec4f(result.rgb/ f32(samplesCount),1.0);\n#else\nvar texelSize: vec2f=1.0/uniforms.screenSize;var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;depth=uniforms.projection[2].z+uniforms.projection[3].z/depth; \nvar cpos: vec4f= vec4f(input.vUV*2.0-1.0,depth,1.0);cpos=uniforms.inverseViewProjection*cpos;cpos/=cpos.w;var ppos: vec4f=uniforms.prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;var velocity: vec2f=(ppos.xy-input.vUV)*uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var nSamples: i32= i32(clamp(speed,1.0,SAMPLES));var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++) {if (i>=nSamples) {break;}\nvar offset1: vec2f=input.vUV+velocity*( f32(i)/ f32(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=textureSampleLevel(textureSampler,textureSamplerSampler, offset1,0.0);\n#else\nresult+=textureSample(textureSampler,textureSamplerSampler, offset1);\n#endif\n}\nfragmentOutputs.color=result/ f32(nSamples);\n#endif\n#else\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler, input.vUV);\n#endif\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},58540:(e,t,i)=>{i.r(t),i.d(t,{oitBackBlendPixelShaderWGSL:()=>s});const r="oitBackBlendPixelShader",n="var uBackColor: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureLoad(uBackColor,vec2i(fragmentInputs.position.xy),0);if (fragmentOutputs.color.a==0.0) {discard;}}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},66930:(e,t,i)=>{i.r(t),i.d(t,{oitFinalPixelShaderWGSL:()=>s});const r="oitFinalPixelShader",n="var uFrontColor: texture_2d<f32>;var uBackColor: texture_2d<f32>;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var frontColor: vec4f=textureLoad(uFrontColor,fragCoord,0);var backColor: vec4f=textureLoad(uBackColor,fragCoord,0);var alphaMultiplier: f32=1.0-frontColor.a;fragmentOutputs.color=vec4f(\nfrontColor.rgb+alphaMultiplier*backColor.rgb,\nfrontColor.a+backColor.a\n);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},76398:(e,t,i)=>{i.r(t),i.d(t,{outlinePixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(26774),i(72207),i(46112);const n="outlinePixelShader",s="uniform color: vec4f;\n#ifdef ALPHATEST\nvarying vUV: vec2;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV).a<0.4) {discard;}\n#endif\n#include<logDepthFragment>\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},29860:(e,t,i)=>{i.r(t),i.d(t,{outlineVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(45737),i(90483),i(26774),i(95030),i(56205),i(9929),i(36674),i(32910),i(22713),i(98830);const n="outlineVertexShader",s="attribute position: vec3f;attribute normal: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform offset: f32;\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;\n#ifdef ALPHATEST\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f; \n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input: VertexInputs)->FragmentInputs {var positionUpdated: vec3f=vertexInputs.position;var normalUpdated: vec3f=vertexInputs.normal;\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\nvar offsetPosition: vec3f=positionUpdated+(normalUpdated*uniforms.offset);\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(offsetPosition,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#ifdef ALPHATEST\n#ifdef UV1\nvertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(vertexInputs.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},18269:(e,t,i)=>{i.r(t),i.d(t,{particlesPixelShaderWGSL:()=>a});var r=i(43862);i(24595),i(93673),i(26774),i(68458),i(76224),i(59939),i(72207),i(46112),i(71743);const n="particlesPixelShader",s="varying vUV: vec2f;varying vColor: vec4f;uniform textureMask: vec4f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#include<clipPlaneFragmentDeclaration>\n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#ifdef RAMPGRADIENT\nvarying remapRanges: vec4f;var rampSamplerSampler: sampler;var rampSampler: texture_2d<f32>;\n#endif\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar textureColor: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV);var baseColor: vec4f=(textureColor*uniforms.textureMask+( vec4f(1.,1.,1.,1.)-uniforms.textureMask))*input.vColor;\n#ifdef RAMPGRADIENT\nvar alpha: f32=baseColor.a;var remappedColorIndex: f32=clamp((alpha-input.remapRanges.x)/input.remapRanges.y,0.0,1.0);var rampColor: vec4f=textureSample(rampSampler,rampSamplerSampler,vec2f(1.0-remappedColorIndex,0.));baseColor=vec4f(baseColor.rgb*rampColor.rgb,baseColor.a);var finalAlpha: f32=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-input.remapRanges.z)/input.remapRanges.w,0.0,1.0);\n#endif\n#ifdef BLENDMULTIPLYMODE\nvar sourceAlpha: f32=input.vColor.a*textureColor.a;baseColor=vec4f(baseColor.rgb*sourceAlpha+ vec3f(1.0)*(1.0-sourceAlpha),baseColor.a);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>(color,baseColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\nbaseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);\n#else\n#ifdef IMAGEPROCESSING\nbaseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);baseColor=applyImageProcessing(baseColor);\n#endif\n#endif\nfragmentOutputs.color=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},60887:(e,t,i)=>{i.r(t),i.d(t,{particlesVertexShaderWGSL:()=>a});var r=i(43862);i(45737),i(96601),i(26774),i(22713),i(78025),i(98830);const n="particlesVertexShader",s="attribute position: vec3f;attribute color: vec4f;attribute angle: f32;attribute size: vec2f;\n#ifdef ANIMATESHEET\nattribute cellIndex: f32;\n#endif\n#ifndef BILLBOARD\nattribute direction: vec3f;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute direction: vec3f;\n#endif\n#ifdef RAMPGRADIENT\nattribute remapData: vec4f;\n#endif\nattribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform translationPivot: vec2f;\n#ifdef ANIMATESHEET\nuniform particlesInfos: vec3f; \n#endif\nvarying vUV: vec2f;varying vColor: vec4f;varying vPositionW: vec3f;\n#ifdef RAMPGRADIENT\nvarying remapRanges: vec4f;\n#endif\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform invView: mat4x4f;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef BILLBOARD\nuniform eyePosition: vec3f;\n#endif\nfn rotate(yaxis: vec3f,rotatedCorner: vec3f)->vec3f {var xaxis: vec3f=normalize(cross( vec3f(0.,1.0,0.),yaxis));var zaxis: vec3f=normalize(cross(yaxis,xaxis));var row0: vec3f= vec3f(xaxis.x,xaxis.y,xaxis.z);var row1: vec3f= vec3f(yaxis.x,yaxis.y,yaxis.z);var row2: vec3f= vec3f(zaxis.x,zaxis.y,zaxis.z);var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}\n#ifdef BILLBOARDSTRETCHED\nfn rotateAlign(toCamera: vec3f,rotatedCorner: vec3f)->vec3f {var normalizedToCamera: vec3f=normalize(toCamera);var normalizedCrossDirToCamera: vec3f=normalize(cross(normalize(vertexInputs.direction),normalizedToCamera));var row0: vec3f= vec3f(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);var row2: vec3f= vec3f(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);\n#ifdef BILLBOARDSTRETCHED_LOCAL\nvar row1: vec3f=vertexInputs.direction;\n#else\nvar crossProduct: vec3f=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));var row1: vec3f= vec3f(crossProduct.x,crossProduct.y,crossProduct.z);\n#endif\nvar rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return input.position+alignedCorner;}\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar cornerPos: vec2f;cornerPos=( vec2f(input.offset.x-0.5,input.offset.y -0.5)-uniforms.translationPivot)*input.size;\n#ifdef BILLBOARD\nvar rotatedCorner: vec3f;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=input.position-uniforms.eyePosition;yaxis.y=0.;vertexOutputs.vPositionW=rotate(normalize(yaxis),rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var toCamera: vec3f=input.position-uniforms.eyePosition;vertexOutputs.vPositionW=rotateAlign(toCamera,rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;\n#else\nrotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var viewPos: vec3f=(uniforms.view* vec4f(input.position,1.0)).xyz+rotatedCorner;vertexOutputs.vPositionW=(uniforms.invView* vec4f(viewPos,1)).xyz;\n#endif\n#ifdef RAMPGRADIENT\nvertexOutputs.remapRanges=input.remapData;\n#endif\nvertexOutputs.position=uniforms.projection* vec4f(viewPos,1.0);\n#else\nvar rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=normalize(vertexInputs.direction);vertexOutputs.vPositionW=rotate(yaxis,rotatedCorner);vertexOutputs.position=uniforms.projection*uniforms.view* vec4f(vertexOutputs.vPositionW,1.0);\n#endif\nvertexOutputs.vColor=input.color;\n#ifdef ANIMATESHEET\nvar rowOffset: f32=floor(input.cellIndex*uniforms.particlesInfos.z);var columnOffset: f32=input.cellIndex-rowOffset/uniforms.particlesInfos.z;var uvScale: vec2f=uniforms.particlesInfos.xy;var uvOffset: vec2f= vec2f(input.offset.x ,1.0-input.offset.y);vertexOutputs.vUV=(uvOffset+ vec2f(columnOffset,rowOffset))*uvScale;\n#else\nvertexOutputs.vUV=input.offset;\n#endif\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)\nvar worldPos: vec4f= vec4f(vertexOutputs.vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},35385:(e,t,i)=>{i.r(t),i.d(t,{passPixelShaderWGSL:()=>s});const r="passPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},70542:(e,t,i)=>{i.r(t),i.d(t,{passCubePixelShaderWGSL:()=>s});const r="passCubePixelShader",n="varying var vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));\n#endif\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},21800:(e,t,i)=>{i.r(t),i.d(t,{pbrPixelShaderWGSL:()=>a});var r=i(43862);i(47151),i(9139),i(23391),i(32657);r.l.IncludesShadersStoreWGSL.pbrFragmentExtraDeclaration="varying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n",i(10879),i(38659);r.l.IncludesShadersStoreWGSL.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nvar clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)\nvar sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nvar environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\nvar refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;\n#endif\n#else\nvar refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)\n#endif\n#ifdef IBL_CDF_FILTERING\nvar icdfxSamplerSampler: sampler;var icdfxSampler: texture_2d<f32>;var icdfySamplerSampler: sampler;var icdfySampler: texture_2d<f32>;\n#endif\n",i(93673),i(24595),i(26774),i(59939),i(68458);r.l.IncludesShadersStoreWGSL.subSurfaceScatteringFunctions="fn testLightingForSSS(diffusionProfile: f32)->bool\n{return diffusionProfile<1.;}",i(14892);r.l.IncludesShadersStoreWGSL.pbrHelperFunctions="#define MINIMUMVARIANCE 0.0005\nfn convertRoughnessToAverageSlope(roughness: f32)->f32\n{return roughness*roughness+MINIMUMVARIANCE;}\nfn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}\nfn getAARoughnessFactors(normalVector: vec3f)->vec2f {\n#ifdef SPECULARAA\nvar nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2f(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\nfn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#else\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\nfn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nfn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}\nfn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nfn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}\nfn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32\n{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}\n#endif\n",i(76224),i(32889),i(98374);r.l.IncludesShadersStoreWGSL.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{lightOffset: vec3f,\nlightDistanceSquared: f32,\nlightDistance: f32,\nattenuation: f32,\nL: vec3f,\nH: vec3f,\nNdotV: f32,\nNdotLUnclamped: f32,\nNdotL: f32,\nVdotH: f32,\nroughness: f32,\n#ifdef IRIDESCENCE\niridescenceIntensity: f32\n#endif\n};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\nfn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\nfn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}";r.l.IncludesShadersStoreWGSL.pbrDirectLightingFalloffFunctions="fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32\n{return max(0.,1.0-length(lightOffset)/range);}\nfn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32\n{return 1.0/maxEps(lightDistanceSquared);}\nfn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32\n{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32\n{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32\n{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; \nvar concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32\n{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}",i(20192),i(97670);r.l.IncludesShadersStoreWGSL.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{diffuse: vec3f,\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef CLEARCOAT\nclearCoat: vec4f,\n#endif\n#ifdef SHEEN\nsheen: vec3f\n#endif\n};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nvar lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}\nfn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: f32=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}\n#ifdef SS_TRANSLUCENCY\nfn computeDiffuseAndTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var NdotL: f32=absEps(info.NdotLUnclamped);var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);var transmittanceNdotL: vec3f=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);var diffuseTerm: f32=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nfn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nvar distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nvar smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvar specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef ANISOTROPIC\nfn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nvar distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nfn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nfn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nfn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nvar visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nvar visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nvar sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}\nfn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\nfn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}\nfn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n",i(54013),i(44806),i(44338),i(96734);r.l.IncludesShadersStoreWGSL.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{surfaceAlbedo: vec3f,\nalpha: f32};\n#define pbr_inline\nfn albedoOpacityBlock(\nvAlbedoColor: vec4f\n#ifdef ALBEDO\n,albedoTexture: vec4f\n,albedoInfos: vec2f\n#endif\n#ifdef OPACITY\n,opacityMap: vec4f\n,vOpacityInfos: vec2f\n#endif\n#ifdef DETAIL\n,detailColor: vec4f\n,vDetailInfos: vec4f\n#endif\n#ifdef DECAL\n,decalColor: vec4f\n,vDecalInfos: vec4f\n#endif\n)->albedoOpacityOutParams\n{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=fragmentInputs.vColor.rgb;\n#endif\n#ifdef DETAIL\nvar detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST \n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE) {discard;}\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}\n";r.l.IncludesShadersStoreWGSL.pbrBlockReflectivity="struct reflectivityOutParams\n{microSurface: f32,\nroughness: f32,\nsurfaceReflectivityColor: vec3f,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo: vec3f,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nambientOcclusionColor: vec3f,\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\nmetallicRoughness: vec2f,\n#ifdef REFLECTIVITY\nsurfaceMetallicColorMap: vec4f,\n#endif\n#ifndef FROSTBITE_REFLECTANCE\nmetallicF0: vec3f,\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColorMap: vec4f,\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nfn reflectivityBlock(\nvReflectivityColor: vec4f\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo: vec3f\n,metallicReflectanceFactors: vec4f\n#endif\n#ifdef REFLECTIVITY\n,reflectivityInfos: vec3f\n,surfaceMetallicOrReflectivityColorMap: vec4f\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,ambientOcclusionColorIn: vec3f\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel: vec4f\n#endif\n#ifdef DETAIL\n,detailColor: vec4f\n,vDetailInfos: vec4f\n#endif\n)->reflectivityOutParams\n{var outParams: reflectivityOutParams;var microSurface: f32=vReflectivityColor.a;var surfaceReflectivityColor: vec3f=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvar metallicRoughness: vec2f=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvar aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nvar detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvar metallicF0: vec3f=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0), vec3f(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);var roughness: f32=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}\n";r.l.IncludesShadersStoreWGSL.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{ambientOcclusionColor: vec3f,\n#if DEBUGMODE>0 && defined(AMBIENT)\nambientOcclusionColorMap: vec3f\n#endif\n};\n#define pbr_inline\nfn ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap_: vec3f,\nvAmbientInfos: vec4f\n#endif\n)->ambientOcclusionOutParams\n{ \nvar outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT\nvar ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n";r.l.IncludesShadersStoreWGSL.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}\n#define pbr_inline\nfn alphaFresnelBlock(\nnormalW: vec3f,\nviewDirectionW: vec3f,\nalpha: f32,\nmicroSurface: f32\n)->alphaFresnelOutParams\n{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;\n#ifdef LINEARALPHAFRESNEL\nvar opacity0: f32=opacityPerceptual;\n#else\nvar opacity0: f32=opacityPerceptual*opacityPerceptual;\n#endif\nvar opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE) {discard;}\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\nreturn outParams;}\n#endif\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{anisotropy: f32,\nanisotropicTangent: vec3f,\nanisotropicBitangent: vec3f,\nanisotropicNormal: vec3f,\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nanisotropyMapData: vec3f\n#endif\n};\n#define pbr_inline\nfn anisotropicBlock(\nvAnisotropy: vec3f,\nroughness: f32,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData: vec3f,\n#endif\nTBN: mat3x3f,\nnormalW: vec3f,\nviewDirectionW: vec3f\n)->anisotropicOutParams\n{ \nvar outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nvar amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\namd=amd*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);\n#else\nanisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);\n#endif\n#endif\nvar anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{environmentRadiance: vec4f\n,environmentIrradiance: vec3f\n#ifdef REFLECTIONMAP_3D\n,reflectionCoords: vec3f\n#else\n,reflectionCoords: vec2f\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,irradianceVector: vec3f\n#endif\n#endif\n#endif\n};\n#define pbr_inline\n#ifdef REFLECTIONMAP_3D\nfn createReflectionCoords(\nvPositionW: vec3f,\nnormalW: vec3f,\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n)->vec3f\n{var reflectionCoords: vec3f;\n#else\nfn createReflectionCoords(\nvPositionW: vec3f,\nnormalW: vec3f,\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n)->vec2f\n{ \nvar reflectionCoords: vec2f;\n#endif\n#ifdef ANISOTROPIC\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\nreturn reflectionCoords;}\n#define pbr_inline\nfn sampleReflectionTexture(\nalphaG: f32\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped: f32\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness: f32\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler\n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler\n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler\n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif \n)->vec4f\n{var environmentRadiance: vec4f;\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nvar reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nvar reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nvar reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nvar automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);\n#else\nvar requestedReflectionLOD: f32=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nvar lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\ntextureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\ntextureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\nvar envRadiance=environmentRadiance.rgb;\n#ifdef RGBDREFLECTION\nenvRadiance=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvRadiance=toLinearSpaceVec3(environmentRadiance.rgb);\n#endif\nenvRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}\n#define pbr_inline\nfn reflectionBlock(\nvPositionW: vec3f\n,normalW: vec3f\n,alphaG: f32\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped: f32\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness: f32\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance: vec3f\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionMatrix: mat4x4f\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler \n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler \n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler: texture_2d<f32>\n,icdfxSamplerSampler: sampler\n,icdfySampler: texture_2d<f32>\n,icdfySamplerSampler: sampler\n#endif\n#endif\n)->reflectionOutParams\n{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f= vec3f(0.);\n#else\nvar reflectionCoords: vec2f= vec2f(0.);\n#endif\nreflectionCoords=createReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif \n);environmentRadiance=sampleReflectionTexture(\nalphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#else\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif \n);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler\n,icdfxSamplerSampler\n,icdfySampler\n,icdfySamplerSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvar environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{sheenIntensity: f32\n,sheenColor: vec3f\n,sheenRoughness: f32\n#ifdef SHEEN_LINKWITHALBEDO\n,surfaceAlbedo: vec3f\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\n,sheenAlbedoScaling: f32\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,finalSheenRadianceScaled: vec3f\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\n,sheenMapData: vec4f\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,sheenEnvironmentReflectance: vec3f\n#endif\n#endif\n};\n#define pbr_inline\nfn sheenBlock(\nvSheenColor: vec4f\n#ifdef SHEEN_ROUGHNESS\n,vSheenRoughness: f32\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData: vec4f\n#endif\n#endif\n,roughness: f32\n#ifdef SHEEN_TEXTURE\n,sheenMapData: vec4f\n,sheenMapLevel: f32\n#endif\n,reflectance: f32\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor: vec3f\n,surfaceAlbedo: vec3f\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV: f32\n,environmentBrdf: vec3f\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors: vec2f\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n,vLightingIntensity: vec4f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n,NdotVUnclamped: f32\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo: f32\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho: f32\n#endif\n#endif\n)->sheenOutParams\n{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nvar sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvar sheenColor: vec3f=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor*=toLinearSpaceVec3(sheenMapData.rgb);\n#else\nsheenColor*=sheenMapData.rgb;\n#endif\nsheenColor*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nvar sheenRoughness: f32=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#else\nvar sheenRoughness: f32=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvar environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvar environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvar environmentSheenBrdf: vec3f=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvar sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvar environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(\nsheenAlphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,sheenRoughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockClearcoat="struct clearcoatOutParams\n{specularEnvironmentR0: vec3f,\nconservationFactor: f32,\nclearCoatNormalW: vec3f,\nclearCoatAARoughnessFactors: vec2f,\nclearCoatIntensity: f32,\nclearCoatRoughness: f32,\n#ifdef REFLECTION\nfinalClearCoatRadianceScaled: vec3f,\n#endif\n#ifdef CLEARCOAT_TINT\nabsorption: vec3f,\nclearCoatNdotVRefract: f32,\nclearCoatColor: vec3f,\nclearCoatThickness: f32,\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nenergyConservationFactorClearCoat: vec3f,\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nTBNClearCoat: mat3x3f,\n#endif\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData: vec2f,\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nclearCoatTintMapData: vec4f,\n#endif\n#ifdef REFLECTION\nenvironmentClearCoatRadiance: vec4f,\nclearCoatEnvironmentReflectance: vec3f,\n#endif\nclearCoatNdotV: f32\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\nfn clearcoatBlock(\nvPositionW: vec3f\n,geometricNormalW: vec3f\n,viewDirectionW: vec3f\n,vClearCoatParams: vec2f\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData: vec4f\n#endif\n,specularEnvironmentR0: vec3f\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData: vec2f\n#endif\n#ifdef CLEARCOAT_TINT\n,vClearCoatTintParams: vec4f\n,clearCoatColorAtDistance: f32\n,vClearCoatRefractionParams: vec4f\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData: vec4f\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,vClearCoatBumpInfos: vec2f\n,clearCoatBumpMapData: vec4f\n,vClearCoatBumpUV: vec2f\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN: mat3x3f\n#else\n,vClearCoatTangentSpaceParams: vec2f\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,normalMatrix: mat4x4f\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal: vec3f\n#endif\n#ifdef REFLECTION\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n,vLightingIntensity: vec4f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,frontFacingMultiplier: f32\n#endif \n)->clearcoatOutParams\n{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvar clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvar specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvar specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nvar clearCoatNormalScale: f32=1.0;\n#else\nvar clearCoatNormalScale: f32=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBNClearCoat: mat3x3f=vTBN;\n#else\nvar TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvar clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvar environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nvar clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvar environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;\n#else\nvar clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nenvironmentClearCoatRadiance=sampleReflectionTexture(\nclearCoatAlphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,clearCoatNdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,clearCoatRoughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n,clearCoatReflectionCoords\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif \n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvar clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nvar clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvar clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nvar fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\nreturn outParams;}\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockIridescence="struct iridescenceOutParams\n{iridescenceIntensity: f32,\niridescenceIOR: f32,\niridescenceThickness: f32,\nspecularEnvironmentR0: vec3f};\n#ifdef IRIDESCENCE\nfn iridescenceBlock(\nvIridescenceParams: vec4f\n,viewAngle: f32\n,specularEnvironmentR0: vec3f\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData: vec2f\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData: vec2f\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped: f32\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData: vec2f\n#endif\n#endif\n)->iridescenceOutParams\n{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nvar iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; \n#ifdef CLEARCOAT\nvar clearCoatIntensity: f32=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));\n#endif\nvar iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockSubSurface="struct subSurfaceOutParams\n{specularEnvironmentReflectance: vec3f,\n#ifdef SS_REFRACTION\nfinalRefraction: vec3f,\nsurfaceAlbedo: vec3f,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha: f32,\n#endif\n#ifdef REFLECTION\nrefractionFactorForIrradiance: f32,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\ntransmittance: vec3f,\ntranslucencyIntensity: f32,\n#ifdef REFLECTION\nrefractionIrradiance: vec3f,\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap: vec4f,\n#endif\n#ifdef SS_REFRACTION\nenvironmentRefraction: vec4f,\nrefractionTransmittance: vec3f\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\nfn sampleEnvironmentRefraction(\nior: f32\n,thickness: f32\n,refractionLOD: f32\n,normalW: vec3f\n,vPositionW: vec3f\n,viewDirectionW: vec3f\n,view: mat4x4f\n,vRefractionInfos: vec4f\n,refractionMatrix: mat4x4f\n,vRefractionMicrosurfaceInfos: vec4f\n,alphaG: f32\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler: texture_cube<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_cube<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_cube<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#else\n,refractionSampler: texture_2d<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_2d<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_2d<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo: vec2f\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition: vec3f\n,refractionSize: vec3f\n#endif\n)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvar refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvar refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvar vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;\n#else\nvar vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;\n#endif\nvar refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nvar lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nvar automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);\n#else\nvar requestedRefractionLOD: f32=lod;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nvar lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\ntextureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\ntextureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\nvar refraction=environmentRefraction.rgb;\n#ifdef SS_RGBDREFRACTION\nrefraction=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nrefraction=toLinearSpaceVec3(environmentRefraction.rgb);\n#endif\nreturn vec4f(refraction,environmentRefraction.a);}\n#endif\n#define pbr_inline\nfn subSurfaceBlock(\nvSubSurfaceIntensity: vec3f\n,vThicknessParam: vec2f\n,vTintColor: vec4f\n,normalW: vec3f\n,specularEnvironmentReflectance: vec3f\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap: vec4f\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap: vec4f\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap: vec4f\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,reflectionMatrix: mat4x4f\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,irradianceVector_: vec3f\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,vReflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler: texture_2d<f32>\n,icdfxSamplerSampler: sampler\n,icdfySampler: texture_2d<f32>\n,icdfySamplerSampler: sampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler\n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo: vec3f\n#endif\n#ifdef SS_REFRACTION\n,vPositionW: vec3f\n,viewDirectionW: vec3f\n,view: mat4x4f\n,vRefractionInfos: vec4f\n,refractionMatrix: mat4x4f\n,vRefractionMicrosurfaceInfos: vec4f\n,vLightingIntensity: vec4f\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha: f32\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped: f32\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness: f32\n#endif\n,alphaG: f32\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler: texture_cube<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_cube<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_cube<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#else\n,refractionSampler: texture_2d<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_2d<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_2d<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo: vec2f\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition: vec3f\n,refractionSize: vec3f\n#endif\n#ifdef SS_DISPERSION\n,dispersion: f32\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,vDiffusionDistance: vec3f\n,vTranslucencyColor: vec4f\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap: vec4f\n#endif\n#endif\n)->subSurfaceOutParams\n{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvar refractionIntensity: f32=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvar translucencyIntensity: f32=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nvar thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nvar thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=thicknessMap.a;\n#else\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nvar thickness: f32=vThicknessParam.y;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=translucencyIntensityMap.a;\n#else\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\ntranslucencyColor*=translucencyColorMap;\n#endif\nvar transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvar environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nvar ior: f32=vRefractionInfos.y;\n#else\nvar ior: f32=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nvar refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nvar refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nvar refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nvar refraction_ior: f32=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nvar realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvar envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#else\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);\n#endif\n#ifdef SS_REFRACTION\nvar refractionTransmittance: vec3f= vec3f(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvar volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nvar maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);\n#else\nvar volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvar bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvar irradianceVector: vec3f=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvar refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfxSampler\n,icdfxSamplerSampler\n,icdfySampler\n,icdfySamplerSampler\n#endif\n);\n#else\nvar refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvar irradianceCoords: vec3f=irradianceVector;\n#else\nvar irradianceCoords: vec2f=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvar temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;\n#ifdef RGBDREFLECTION\nrefractionIrradiance=fromRGBD(temp).rgb;\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance=toLinearSpaceVec3(refractionIrradiance);\n#endif\n#else\nvar refractionIrradiance: vec3f= vec3f(0.);\n#endif\nrefractionIrradiance*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance;\n#endif\nreturn outParams;}\n#endif\n",i(72207);r.l.IncludesShadersStoreWGSL.pbrBlockNormalGeometric="var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);\n#ifdef NORMAL\nvar normalW: vec3f=normalize(input.vNormalW);\n#else\nvar normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;\n#endif\nvar geometricNormalW: vec3f=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);\n#endif\n",i(41627);r.l.IncludesShadersStoreWGSL.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvar faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);\n#endif\n",i(81044);r.l.IncludesShadersStoreWGSL.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvar lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);\n#endif\nlightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockGeometryInfo="var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvar environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nvar ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;\n#else\nvar ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nvar seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nvar eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockReflectance0="var reflectance: f32=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);var specularEnvironmentR0: vec3f=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvar specularEnvironmentR90: vec3f= vec3f(metallicReflectanceFactors.a);\n#else \nvar specularEnvironmentR90: vec3f= vec3f(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nvar reflectance90: f32=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvar specularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvar specularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockDirectLighting="var diffuseBase: vec3f=vec3f(0.,0.,0.);\n#ifdef SPECULARTERM\nvar specularBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvar clearCoatBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvar sheenBase: vec3f=vec3f(0.,0.,0.);\n#endif\nvar preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; \nvar aggShadow: f32=0.;var numLights: f32=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvar absorption: vec3f=vec3f(0.);\n#endif\n",i(49979);r.l.IncludesShadersStoreWGSL.pbrBlockFinalLitComponents="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvar energyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvar finalIrradiance: vec3f=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvar finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvar finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvar finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvar finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nvar luminanceOverAlpha: f32=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockFinalUnlitComponents="var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;\n#ifdef EMISSIVE\nvar emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= uniforms.vEmissiveInfos.y;\n#endif\nfinalEmissive*=uniforms.vLightingIntensity.y;\n#ifdef AMBIENT\nvar ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);\n#else\nvar ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n";r.l.IncludesShadersStoreWGSL.pbrBlockFinalColorComposition="var finalColor: vec4f= vec4f(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);\n#else\nfinalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);\n#endif\n#endif\n#endif\nfinalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,vec4f(0.0));\n",i(46112),i(71743);r.l.IncludesShadersStoreWGSL.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);\n#ifdef PREMULTIPLYALPHA\nfinalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;\n#endif\n";r.l.IncludesShadersStoreWGSL.pbrBlockPrePass="var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef PREPASS_POSITION\nfragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nfragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvar a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvar velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -\n(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\nfragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvar sqAlbedo : vec3f=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvar irradiance : vec3f=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); \n#endif\nirradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); \n#else\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=finalColor; \n#endif\nfragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); \n#endif\n#elif defined(PREPASS_COLOR)\nfragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\nfragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\nfragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);\n#else\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\nfragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nfragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n",i(99999);r.l.IncludesShadersStoreWGSL.pbrDebug="#if DEBUGMODE>0\nif (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;\n#if DEBUGMODE==1\ncolor=fragmentInputs.vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ncolor=fragmentInputs.vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ncolor=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ncolor=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ncolor=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ncolor= vec3f(input.vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ncolor= vec3f(input.vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ncolor=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ncolor=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ncolor=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ncolor=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ncolor=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ncolor=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ncolor=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ncolor=lightmapColor;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ncolor=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ncolor=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ncolor= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ncolor=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ncolor=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ncolor=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ncolor=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ncolor=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ncolor=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ncolor=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ncolor=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ncolor=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ncolor=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ncolor=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ncolor=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ncolor=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ncolor=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ncolor=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ncolor= vec3f(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ncolor=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ncolor= vec3f(roughness);\n#elif DEBUGMODE==64\ncolor= vec3f(alphaG);\n#elif DEBUGMODE==65\ncolor= vec3f(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ncolor=clearcoatOut.clearCoatColor;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ncolor= vec3f(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ncolor= vec3f(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ncolor=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ncolor=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ncolor= vec3f(microSurface);\n#elif DEBUGMODE==73\ncolor=uniforms.vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ncolor=uniforms.vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ncolor=uniforms.vEmissiveColor;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ncolor= vec3f(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\ncolor= vec3f(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ncolor= vec3f(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ncolor=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ncolor=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ncolor=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ncolor= vec3f(luminanceOverAlpha);\n#elif DEBUGMODE==87\ncolor= vec3f(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ncolor= vec3f(albedoTexture.a);\n#elif DEBUGMODE==89\ncolor=aoOut.ambientOcclusionColor;\n#else\nvar stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);\n#endif\ncolor*=uniforms.vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ncolor=normalize(color)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ncolor=toGammaSpaceVec3(color);\n#endif\nfragmentOutputs.color=vec4f(color,1.0);\n#ifdef PREPASS\nfragmentOutputs.fragData0=toLinearSpaceVec3(color); \nfragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn fragmentOutputs;\n#endif\n}\n#endif\n";const n="pbrPixelShader",s="#define CUSTOM_FRAGMENT_BEGIN\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<pbrUboDeclaration>\n#include<pbrFragmentExtraDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nvar albedoOpacityOut: albedoOpacityOutParams;\n#ifdef ALBEDO\nvar albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#endif\nalbedoOpacityOut=albedoOpacityBlock(\nuniforms.vAlbedoColor\n#ifdef ALBEDO\n,albedoTexture\n,uniforms.vAlbedoInfos\n#endif\n#ifdef OPACITY\n,opacityMap\n,uniforms.vOpacityInfos\n#endif\n#ifdef DETAIL\n,detailColor\n,uniforms.vDetailInfos\n#endif\n#ifdef DECAL\n,decalColor\n,uniforms.vDecalInfos\n#endif\n);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar aoOut: ambientOcclusionOutParams;\n#ifdef AMBIENT\nvar ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nuniforms.vAmbientInfos\n#endif \n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvar diffuseBase: vec3f= vec3f(1.,1.,1.);\n#else\nvar baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;\n#if defined(REFLECTIVITY)\nvar surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvar microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvar metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvar reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);\n#endif\n#ifdef METALLIC_REFLECTANCE\nvar metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityOut=reflectivityBlock(\nuniforms.vReflectivityColor\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo\n,metallicReflectanceFactors\n#endif\n#ifdef REFLECTIVITY\n,uniforms.vReflectivityInfos\n,surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,aoOut.ambientOcclusionColor\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel\n#endif\n#ifdef DETAIL\n,detailColor\n,uniforms.vDetailInfos\n#endif\n);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nvar alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nvar anisotropicOut: anisotropicOutParams;\n#ifdef ANISOTROPIC_TEXTURE\nvar anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;\n#endif\nanisotropicOut=anisotropicBlock(\nuniforms.vAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW \n);\n#endif\n#ifdef REFLECTION\nvar reflectionOut: reflectionOutParams;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionOut=reflectionBlock(\nfragmentInputs.vPositionW\n,normalW\n,alphaG\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,fragmentInputs.vEnvironmentIrradiance\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,uniforms.reflectionMatrix\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,uniforms.icdfxSampler\n,uniforms.icdfxSamplerSampler\n,uniforms.icdfySampler\n,uniforms.icdfySamplerSampler\n#endif\n#endif\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nvar sheenOut: sheenOutParams;\n#ifdef SHEEN_TEXTURE\nvar sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvar sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;\n#endif\nsheenOut=sheenBlock(\nuniforms.vSheenColor\n#ifdef SHEEN_ROUGHNESS\n,uniforms.vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData\n#endif\n#endif\n,roughness\n#ifdef SHEEN_TEXTURE\n,sheenMapData\n,uniforms.vSheenInfos.y\n#endif\n,reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor\n,surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV\n,environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n,uniforms.vLightingIntensity\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionOut.reflectionCoords\n,NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho\n#endif\n#endif\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvar clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\nvar iridescenceOut: iridescenceOutParams;\n#ifdef IRIDESCENCE_TEXTURE\nvar iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*uniforms.vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvar iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*uniforms.vIridescenceInfos.w;\n#endif\niridescenceOut=iridescenceBlock(\nuniforms.vIridescenceParams\n,NdotV\n,specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#endif\n);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nvar clearcoatOut: clearcoatOutParams;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvar clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvar clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvar clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatOut=clearcoatBlock(\nfragmentInputs.vPositionW\n,geometricNormalW\n,viewDirectionW\n,uniforms.vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData\n#endif\n,specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,uniforms.vClearCoatTintParams\n,uniforms.clearCoatColorAtDistance\n,uniforms.vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,uniforms.vClearCoatBumpInfos\n,clearCoatBumpMapData\n,fragmentInputs.vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN\n#else\n,uniforms.vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,uniforms.normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal\n#endif\n#ifdef REFLECTION\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n,uniforms.vLightingIntensity\n,reflectionSampler\n,reflectionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,select(-1.,1.,fragmentInputs.frontFacing)\n#endif\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nvar subSurfaceOut: subSurfaceOutParams;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvar thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvar refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvar translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nvar translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);\n#endif\nsubSurfaceOut=subSurfaceBlock(\nuniforms.vSubSurfaceIntensity\n,uniforms.vThicknessParam\n,uniforms.vTintColor\n,normalW\n,specularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,uniforms.reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionOut.irradianceVector\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler\n,reflectionSamplerSampler\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,uniforms.icdfxSampler\n,uniforms.icdfxSamplerSampler\n,uniforms.icdfySampler\n,uniforms.icdfySamplerSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,fragmentInputs.vPositionW\n,viewDirectionW\n,scene.view\n,uniforms.vRefractionInfos\n,uniforms.refractionMatrix\n,uniforms.vRefractionMicrosurfaceInfos\n,uniforms.vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness\n#endif\n,alphaG\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,uniforms.vRefractionPosition\n,uniforms.vRefractionSize\n#endif\n#ifdef SS_DISPERSION\n,dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,uniforms.vDiffusionDistance\n,uniforms.vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap\n#endif\n#endif\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},46602:(e,t,i)=>{i.r(t),i.d(t,{pbrVertexShaderWGSL:()=>a});var r=i(43862);i(23391),i(35676),i(32657),i(68458),i(97346),i(82600),i(90483),i(82693),i(67673),i(98374),i(1453),i(45737),i(96601),i(46225),i(22400),i(15909),i(26774),i(95030),i(56205),i(9929),i(36674),i(32910),i(5709),i(64746),i(12075),i(5541),i(22713),i(78025),i(95988),i(18144),i(98830);const n="pbrVertexShader",s="#include<pbrUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvar reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvertexOutputs.vClipSpacePosition=vertexOutputs.position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},60961:(e,t,i)=>{i.r(t),i.d(t,{pickingPixelShaderWGSL:()=>s});const r="pickingPixelShader",n="#if defined(INSTANCES)\nvarying vMeshID: vec4f;\n#else\nuniform meshID: vec4f;\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#if defined(INSTANCES)\nfragmentOutputs.color=input.vMeshID;\n#else\nfragmentOutputs.color=uniforms.meshID;\n#endif\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},22123:(e,t,i)=>{i.r(t),i.d(t,{pickingVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(90483),i(95030),i(56205),i(9929),i(36674),i(32910);const n="pickingVertexShader",s="attribute position: vec3f;\n#if defined(INSTANCES)\nattribute instanceMeshID: vec4f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;\n#if defined(INSTANCES)\nvarying vMeshID: vec4f;\n#endif\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;\n#if defined(INSTANCES)\nvertexOutputs.vMeshID=input.instanceMeshID;\n#endif\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},30535:(e,t,i)=>{i.r(t),i.d(t,{postprocessVertexShaderWGSL:()=>s});const r="postprocessVertexShader",n="attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},37177:(e,t,i)=>{i.r(t),i.d(t,{proceduralVertexShaderWGSL:()=>s});const r="proceduralVertexShader",n="attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},55143:(e,t,i)=>{i.r(t),i.d(t,{rgbdDecodePixelShaderWGSL:()=>a});var r=i(43862);i(68458);const n="rgbdDecodePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},37007:(e,t,i)=>{i.r(t),i.d(t,{rgbdEncodePixelShaderWGSL:()=>a});var r=i(43862);i(68458);const n="rgbdEncodePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},23785:(e,t,i)=>{i.r(t),i.d(t,{rsmFullGlobalIlluminationPixelShaderWGSL:()=>s});const r="rsmFullGlobalIlluminationPixelShader",n="/**\n* The implementation is a direct application of the formula found in http:\n*/\nvarying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionW: texture_2d<f32>;var rsmNormalW: texture_2d<f32>;var rsmFlux: texture_2d<f32>;\n#ifdef TRANSFORM_NORMAL\nuniform invView: mat4x4f;\n#endif\nfn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var width: i32= i32(uniforms.rsmInfo.x);var height: i32= i32(uniforms.rsmInfo.y);for (var j: i32=0; j<height; j++) {for (var i: i32=0; i<width; i++) {var uv=vec2<i32>(i,j);var vplPositionW: vec3f=textureLoad(rsmPositionW,uv,0).xyz;var vplNormalW: vec3f=textureLoad(rsmNormalW,uv,0).xyz*2.0-1.0;var vplFlux: vec3f=textureLoad(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nvar dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}\nreturn clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,fragmentInputs.vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(uniforms.invView* vec4f(normalW,0.)).xyz;\n#endif\nfragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},42570:(e,t,i)=>{i.r(t),i.d(t,{rsmGlobalIlluminationPixelShaderWGSL:()=>s});const r="rsmGlobalIlluminationPixelShader",n="/**\n* The implementation is an application of the formula found in http:\n* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).\n*/\nvarying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;uniform rsmInfo2: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionWSampler: sampler;var rsmPositionW: texture_2d<f32>;var rsmNormalWSampler: sampler;var rsmNormalW: texture_2d<f32>;var rsmFluxSampler: sampler;var rsmFlux: texture_2d<f32>;var rsmSamples: texture_2d<f32>;\n#ifdef TRANSFORM_NORMAL\nuniform invView: mat4x4f;\n#endif\nfn mod289(x: f32)->f32{return x-floor(x*(1.0/289.0))*289.0;}\nfn mod289Vec4(x: vec4f)->vec4f {return x-floor(x*(1.0/289.0))* 289.0;}\nfn perm(x: vec4f)->vec4f {return mod289Vec4(((x*34.0)+1.0)*x) ;}\nfn noise(p: vec3f)->f32{var a: vec3f=floor(p);var d: vec3f=p-a;d=d*d*(3.0-2.0*d);var b: vec4f=a.xxyy+ vec4f(0.0,1.0,0.0,1.0);var k1: vec4f=perm(b.xyxy);var k2: vec4f=perm(k1.xyxy+b.zzww);var c: vec4f=k2+a.zzzz;var k3: vec4f=perm(c);var k4: vec4f=perm(c+1.0);var o1: vec4f=fract(k3*(1.0/41.0));var o2: vec4f=fract(k4*(1.0/41.0));var o3: vec4f=o2*d.z+o1*(1.0-d.z);var o4: vec2f=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}\nfn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var numSamples: i32= i32(uniforms.rsmInfo.x);var radius: f32=uniforms.rsmInfo.y;var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var angle: f32=noise(p*uniforms.rsmInfo2.x);var c: f32=cos(angle);var s: f32=sin(angle);for (var i: i32=0; i<numSamples; i++) {var rsmSample: vec3f=textureLoad(rsmSamples,vec2<i32>(i,0),0).xyz;var weightSquare: f32=rsmSample.z;if (uniforms.rsmInfo2.y==1.0){rsmSample=vec3f(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c,rsmSample.z);}\nvar uv: vec2f=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) {continue;}\nvar vplPositionW: vec3f=textureSampleLevel(rsmPositionW,rsmPositionWSampler,uv,0.).xyz;var vplNormalW: vec3f=textureSampleLevel(rsmNormalW,rsmNormalWSampler,uv,0.).xyz*2.0-1.0;var vplFlux: vec3f=textureSampleLevel(rsmFlux,rsmFluxSampler,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; \nvar dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}\nreturn clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,input.vUV).xyz;\n#ifdef DECODE_NORMAL\nnormalW=normalW*2.0-1.0;\n#endif\n#ifdef TRANSFORM_NORMAL\nnormalW=(uniforms.invView* vec4f(normalW,0.)).xyz;\n#endif\nfragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},66707:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2PixelShaderWGSL:()=>a});var r=i(43862);i(68458),i(20192),i(38520);const n="screenSpaceReflection2PixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;\n#ifdef SSR_SUPPORTED\nvar reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar backDepthSampler: texture_2d<f32>;uniform backSizeFactor: f32;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvar envCubeSamplerSampler: sampler;var envCubeSampler: texture_cube<f32>;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;\n#endif\n#endif\nuniform view: mat4x4f;uniform invView: mat4x4f;uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform projectionPixel: mat4x4f;uniform nearPlaneZ: f32;uniform farPlaneZ: f32;uniform stepSize: f32;uniform maxSteps: f32;uniform strength: f32;uniform thickness: f32;uniform roughnessFactor: f32;uniform reflectionSpecularFalloffExponent: f32;uniform maxDistance: f32;uniform selfCollisionNumSkip: f32;uniform reflectivityThreshold: f32;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nfn hash(a: vec3f)->vec3f\n{var result=fract(a*0.8);result+=dot(result,result.yxz+19.19);return fract((result.xxy+result.yxx)*result.zyx);}\nfn computeAttenuationForIntersection(ihitPixel: vec2f,hitUV: vec2f,vsRayOrigin: vec3f,vsHitPoint: vec3f,reflectionVector: vec3f,maxRayDistance: f32,numIterations: f32)->f32 {var attenuation: f32=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvar dCoords: vec2f=smoothstep(vec2f(0.2),vec2f(0.6),abs( vec2f(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/uniforms.maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvar reflectionNormal: vec3f=texelFetch(normalSampler,hitPixel,0).xyz;var directionBasedAttenuation: f32=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef SSR_SUPPORTED\nvar colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var color: vec3f=colorFull.rgb;var reflectivity: vec4f=textureSampleLevel(reflectivitySampler,reflectivitySamplerSampler,input.vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\nfragmentOutputs.color= vec4f(0.);\n#else\nfragmentOutputs.color=colorFull;\n#endif\nreturn fragmentOutputs;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpaceVec3(color);\n#endif\nvar texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz; \n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(uniforms.view* vec4f(csNormal,0.0)).xyz;\n#endif\nvar depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);\n#endif\nvar csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);\n#ifdef ORTHOGRAPHIC_CAMERA\nvar csViewDirection: vec3f= vec3f(0.,0.,1.);\n#else\nvar csViewDirection: vec3f=normalize(csPosition);\n#endif\nvar csReflectedVector: vec3f=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvar wReflectedVector: vec3f=(uniforms.invView* vec4f(csReflectedVector,0.0)).xyz;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvar worldPos: vec4f=uniforms.invView* vec4f(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),uniforms.vReflectionSize,uniforms.vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvar envColor: vec3f=textureSampleLevel(envCubeSampler,envCubeSamplerSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpaceVec3(envColor);\n#endif\n#else\nvar envColor: vec3f=color;\n#endif\nvar reflectionAttenuation: f32=1.0;var rayHasHit: bool=false;var startPixel: vec2f;var hitPixel: vec2f;var hitPoint: vec3f;var numIterations: f32;\n#ifdef SSRAYTRACE_DEBUG\nvar debugColor: vec3f;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvar jitt: vec3f= vec3f(0.);\n#else\nvar roughness: f32=1.0-reflectivity.a;var jitt: vec3f=mix( vec3f(0.0),hash(csPosition)- vec3f(0.5),roughness)*uniforms.roughnessFactor; \n#endif\nvar uv2: vec2f=input.vUV*texSize;var c: f32=(uv2.x+uv2.y)*0.25;var jitter: f32=((c)%(1.0)); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nuniforms.projectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nuniforms.backSizeFactor,\n#endif\nuniforms.thickness,\nuniforms.nearPlaneZ,\nuniforms.farPlaneZ,\nuniforms.stepSize,\njitter,\nuniforms.maxSteps,\nuniforms.maxDistance,\nuniforms.selfCollisionNumSkip,\n&startPixel,\n&hitPixel,\n&hitPoint,\n&numIterations\n#ifdef SSRAYTRACE_DEBUG\n,&debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\nfragmentOutputs.color= vec4f(debugColor,1.);return fragmentOutputs;\n#endif\nvar F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var SSR: vec3f=envColor;if (rayHasHit) {var reflectedColor: vec3f=textureLoad(textureSampler,vec2<i32>(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpaceVec3(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(hitPixel,hitPixel/texSize,csPosition,hitPoint,csReflectedVector,uniforms.maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nvar blur_radius: f32=0.0;var roughness: f32=1.0-reflectivity.a*(1.0-uniforms.roughnessFactor);if (roughness>0.001) {var cone_angle: f32=min(roughness,0.999)*3.14159265*0.5;var cone_len: f32=distance(startPixel,hitPixel);var op_len: f32=2.0*tan(cone_angle)*cone_len; \nvar a: f32=op_len;var h: f32=cone_len;var a2: f32=a*a;var fh2: f32=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\nfragmentOutputs.color= vec4f(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvar reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#else\nvar reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#endif\nvar colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpaceVec3(finalColor);\n#endif\nfragmentOutputs.color= vec4f(finalColor,colorFull.a);\n#endif\n#else\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);\n#endif\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},74700:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShaderWGSL:()=>s});const r="screenSpaceReflection2BlurPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;uniform texelOffsetScale: vec2f;const weights: array<f32,8>=array<f32,8>(0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);fn processSample(uv: vec2f,i: f32,stepSize: vec2f,accumulator: ptr<function,vec4f>,denominator: ptr<function,f32>)\n{var offsetUV: vec2f=stepSize*i+uv;var coefficient: f32=weights[ i32(2.0-abs(i))];*accumulator+=textureSampleLevel(textureSampler,textureSamplerSampler,offsetUV,0.0)*coefficient;*denominator+=coefficient;}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);if (dot(colorFull, vec4f(1.0))==0.0) {fragmentOutputs.color=colorFull;return fragmentOutputs;}\nvar blurRadius: f32=colorFull.a*255.0; \nvar stepSize: vec2f=uniforms.texelOffsetScale.xy*blurRadius;var accumulator: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0)*0.214607;var denominator: f32=0.214607;processSample(input.vUV,1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*2.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*2.0,stepSize,&accumulator,&denominator);fragmentOutputs.color= vec4f(accumulator.rgb/denominator,colorFull.a);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},99491:(e,t,i)=>{i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShaderWGSL:()=>a});var r=i(43862);i(68458),i(20192),i(38520);const n="screenSpaceReflection2BlurCombinerPixelShader",s="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>; \nvar mainSamplerSampler: sampler;var mainSampler: texture_2d<f32>;var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;uniform strength: f32;uniform reflectionSpecularFalloffExponent: f32;uniform reflectivityThreshold: f32;varying vUV: vec2f;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nuniform nearPlaneZ: f32;uniform farPlaneZ: f32;\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef SSRAYTRACE_DEBUG\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#else\nvar SSR: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var color: vec4f=textureSample(mainSampler,textureSamplerSampler,input.vUV);var reflectivity: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {fragmentOutputs.color=color;return fragmentOutputs;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpaceVec4(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvar texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz;var depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);\n#endif\nvar csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);var csViewDirection: vec3f=normalize(csPosition);var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#else\nvar reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#endif\nvar colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpaceVec3(finalColor);\n#endif\nfragmentOutputs.color= vec4f(finalColor,color.a);\n#endif\n}\n";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},9082:(e,t,i)=>{i.r(t),i.d(t,{shadowMapPixelShaderWGSL:()=>a});var r=i(43862);i(79643);r.l.IncludesShadersStoreWGSL.bayerDitherFunctions="fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}\nfn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5*((_P)%(4.0))); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5 *((_P)%(4.0))); \nvar P4: vec2f=floor(0.25*((_P)%(8.0))); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";r.l.IncludesShadersStoreWGSL.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform softTransparentShadowSM: vec2f;\n#endif\nvarying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nuniform lightDataSM: vec3f;varying vPositionWSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n",i(24595),i(72207),i(43605);const n="shadowMapPixelShader",s="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvar opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}\n#else\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} \n#endif\n#endif\n#include<shadowMapFragment>\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},31065:(e,t,i)=>{i.r(t),i.d(t,{shadowMapVertexShaderWGSL:()=>a});var r=i(43862);i(97346),i(82600),i(22400),i(15909),i(68458),i(31371),i(90270);r.l.IncludesShadersStoreWGSL.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform lightDataSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nvarying vPositionWSM: vec3f;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n",i(45737),i(95030),i(56205),i(9929),i(36674),i(32910);r.l.IncludesShadersStoreWGSL.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvar worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);\n#else\nvar directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);\n#endif\nvar ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);\n#endif\n",i(81635),i(22713);const n="shadowMapVertexShader",s="attribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;\n#endif\n#include<helperFunctions>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef NORMAL\nvar normalUpdated: vec3f=input.normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvar vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvar vNormalW: vec3f=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\nvertexOutputs.position=scene.viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},96841:(e,t,i)=>{i.r(t),i.d(t,{sharpenPixelShaderWGSL:()=>s});const r="sharpenPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform sharpnessAmounts: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var edgeDetection: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,-1)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(-1,0)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(1,0)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,1)) -\ncolor*4.0;fragmentOutputs.color=max(vec4f(color.rgb*uniforms.sharpnessAmounts.y,color.a)-(uniforms.sharpnessAmounts.x* vec4f(edgeDetection.rgb,0)),vec4f(0.));}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},75393:(e,t,i)=>{i.r(t),i.d(t,{spritesPixelShaderWGSL:()=>a});var r=i(43862);i(59939),i(26774),i(46112),i(71743);r.l.IncludesShadersStoreWGSL.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\nfragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb, vec3f(2.2)),fragmentOutputs.color.a);\n#endif\n";const n="spritesPixelShader",s="uniform alphaTest: i32;varying vColor: vec4f;varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#include<fogFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#ifdef PIXEL_PERFECT\nfn uvPixelPerfect(uv: vec2f)->vec2f {var res: vec2f= vec2f(textureDimensions(diffuseSampler,0));var uvTemp=uv*res;var seam: vec2f=floor(uvTemp+0.5);uvTemp=seam+clamp((uvTemp-seam)/fwidth(uvTemp),vec2f(-0.5),vec2f(0.5));return uvTemp/res;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#ifdef PIXEL_PERFECT\nvar uv: vec2f=uvPixelPerfect(input.vUV);\n#else\nvar uv: vec2f=input.vUV;\n#endif\nvar color: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,uv);var fAlphaTest: f32= f32(uniforms.alphaTest);if (fAlphaTest != 0.)\n{if (color.a<0.95) {discard;}}\ncolor*=input.vColor;\n#include<logDepthFragment>\n#include<fogFragment>\nfragmentOutputs.color=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},20468:(e,t,i)=>{i.r(t),i.d(t,{spritesVertexShaderWGSL:()=>a});var r=i(43862);i(96601),i(26774),i(98830);const n="spritesVertexShader",s="attribute position: vec4f;attribute options: vec2f;attribute offsets: vec2f;attribute inverts: vec2f;attribute cellInfo: vec4f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;varying vUV: vec2f;varying vColor: vec4f;\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar viewPos: vec3f=(uniforms.view* vec4f(input.position.xyz,1.0)).xyz; \nvar cornerPos: vec2f;var angle: f32=input.position.w;var size: vec2f= vec2f(input.options.x,input.options.y);var offset: vec2f=input.offsets.xy;cornerPos= vec2f(offset.x-0.5,offset.y -0.5)*size;var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0); \nvertexOutputs.vColor=input.color;var uvOffset: vec2f= vec2f(abs(offset.x-input.inverts.x),abs(1.0-offset.y-input.inverts.y));var uvPlace: vec2f=input.cellInfo.xy;var uvSize: vec2f=input.cellInfo.zw;vertexOutputs.vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vertexOutputs.vUV.y=uvPlace.y+uvSize.y*uvOffset.y;\n#ifdef FOG\nvertexOutputs.vFogDistance=viewPos;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";r.l.ShadersStoreWGSL[n]=s;const a={name:n,shader:s}},37152:(e,t,i)=>{i.r(t),i.d(t,{ssao2PixelShaderWGSL:()=>s});const r="ssao2PixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef SSAO\nconst scales: array<f32,16>=array<f32,16>(\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform near: f32;uniform radius: f32;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var randomSamplerSampler: sampler;var randomSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;uniform randTextureTiles: f32;uniform samplesFactor: f32;uniform sampleSphere: array<vec3f,SAMPLES>;uniform totalStrength: f32;uniform base: f32;uniform xViewport: f32;uniform yViewport: f32;uniform depthProjection: mat3x3f;uniform maxZ: f32;uniform minZAspect: f32;uniform texelSize: vec2f;uniform projection: mat4x4f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var random: vec3f=textureSampleLevel(randomSampler,randomSamplerSampler,input.vUV*uniforms.randTextureTiles,0.0).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;var depthSign: f32=sign(depth);depth=depth*depthSign;var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.0).rgb;var occlusion: f32=0.0;var correctedRadius: f32=min(uniforms.radius,uniforms.minZAspect*depth/uniforms.near);var vViewRay: vec3f= vec3f((input.vUV.x*2.0-1.0)*uniforms.xViewport,(input.vUV.y*2.0-1.0)*uniforms.yViewport,depthSign);var vDepthFactor: vec3f=uniforms.depthProjection* vec3f(1.0,1.0,depth);var origin: vec3f=vViewRay*vDepthFactor;var rvec: vec3f=random*2.0-1.0;rvec.z=0.0;var dotProduct: f32=dot(rvec,normal);rvec=select( vec3f(-rvec.y,0.0,rvec.x),rvec,1.0-abs(dotProduct)>1e-2);var tangent: vec3f=normalize(rvec-normal*dot(rvec,normal));var bitangent: vec3f=cross(normal,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,normal);var difference: f32;for (var i: i32=0; i<SAMPLES; i++) {var samplePosition: vec3f=scales[(i+ i32(random.x*16.0)) % 16]*tbn*uniforms.sampleSphere[(i+ i32(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;var offset: vec4f= vec4f(samplePosition,1.0);offset=uniforms.projection*offset;offset=vec4f(offset.xyz/offset.w,offset.w);offset=vec4f(offset.xy*0.5+0.5,offset.z,offset.w);if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nvar sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;var rangeCheck: f32=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(uniforms.maxZ*0.75,uniforms.maxZ,depth));var ao: f32=1.0-uniforms.totalStrength*occlusion*uniforms.samplesFactor;var result: f32=clamp(ao+uniforms.base,0.0,1.0);fragmentOutputs.color= vec4f( vec3f(result),1.0);}\n#else\n#ifdef BLUR\nuniform outSize: f32;uniform soften: f32;uniform tolerance: f32;uniform samples: i32;\n#ifndef BLUR_BYPASS\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifdef BLUR_LEGACY\nfn blur13Bilateral(image: texture_2d<f32>,imageSampler: sampler,uv: vec2f,step: vec2f)->f32 {var result: f32=0.0;var off1: vec2f= vec2f(1.411764705882353)*step;var off2: vec2f= vec2f(3.2941176470588234)*step;var off3: vec2f= vec2f(5.176470588235294)*step;var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv,0.0).r);var sampleDepth: f32;var weight: f32;var weightSum: f32=30.0;result+=textureSampleLevel(image,imageSampler,uv,0.0).r*30.0;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv+off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv-off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off3,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: f32=0.0;\n#ifdef BLUR_BYPASS\nresult=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvar step: vec2f= vec2f(1.0/uniforms.outSize,0.0);\n#else\nvar step: vec2f= vec2f(0.0,1.0/uniforms.outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,textureSamplerSampler,input.vUV,step);\n#else\nvar compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r);var weightSum: f32=0.0;for (var i: i32=-uniforms.samples; i<uniforms.samples; i+=2)\n{var samplePos: vec2f=input.vUV+step*( f32(i)+0.5);var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,samplePos,0.0).r);var falloff: f32=smoothstep(0.0,\nf32(uniforms.samples),\nf32(uniforms.samples)-abs( f32(i))*uniforms.soften);var minDivider: f32=uniforms.tolerance*0.5+0.003;var weight: f32=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureSampleLevel(textureSampler,textureSamplerSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\nfragmentOutputs.color=vec4f(result,result,result,1.0);}\n#endif\n#endif\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},4725:(e,t,i)=>{i.r(t),i.d(t,{ssaoCombinePixelShaderWGSL:()=>s});const r="ssaoCombinePixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var originalColorSampler: sampler;var originalColor: texture_2d<f32>;uniform viewport: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar ssaoColor: vec4f=textureSample(textureSampler,textureSamplerSampler,uniforms.viewport.xy+input.vUV*uniforms.viewport.zw);var sceneColor: vec4f=textureSample(originalColor,originalColorSampler,input.vUV);fragmentOutputs.color=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},6422:(e,t,i)=>{i.r(t),i.d(t,{taaPixelShaderWGSL:()=>s});const r="taaPixelShader",n="var textureSampler: texture_2d<f32>;var historySampler: texture_2d<f32>;uniform factor: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let c=textureLoad(textureSampler,vec2<i32>(fragmentInputs.position.xy),0);let h=textureLoad(historySampler,vec2<i32>(fragmentInputs.position.xy),0);fragmentOutputs.color= mix(h,c,uniforms.factor);}\n";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},85790:(e,t,i)=>{i.r(t),i.d(t,{tonemapPixelShaderWGSL:()=>s});const r="tonemapPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform _ExposureAdjustment: f32;\n#if defined(HABLE_TONEMAPPING)\nconst A: f32=0.15;const B: f32=0.50;const C: f32=0.10;const D: f32=0.20;const E: f32=0.02;const F: f32=0.30;const W: f32=11.2;\n#endif\nfn Luminance(c: vec3f)->f32\n{return dot(c, vec3f(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nvar lum: f32=Luminance(colour.rgb); \nvar lumTm: f32=lum*uniforms._ExposureAdjustment;var scale: f32=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=uniforms._ExposureAdjustment;const ExposureBias: f32=2.0;var x: vec3f=ExposureBias*colour;var curr: vec3f=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x= vec3f(W,W,W);var whiteScale: vec3f=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=uniforms._ExposureAdjustment;var X: vec3f=max( vec3f(0.0,0.0,0.0),colour-0.004);var retColor: vec3f=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3f(1.0,1.0,1.0)-exp2(-uniforms._ExposureAdjustment*colour);\n#endif\nfragmentOutputs.color= vec4f(colour.rgb,1.0);}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},68479:(e,t,i)=>{i.r(t),i.d(t,{vrDistortionCorrectionPixelShaderWGSL:()=>s});const r="vrDistortionCorrectionPixelShader",n="#define DISABLE_UNIFORMITY_ANALYSIS\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform LensCenter: vec2f;uniform Scale: vec2f;uniform ScaleIn: vec2f;uniform HmdWarpParam: vec4f;fn HmdWarp(in01: vec2f)->vec2f {var theta: vec2f=(in01-uniforms.LensCenter)*uniforms.ScaleIn; \nvar rSq: f32=theta.x*theta.x+theta.y*theta.y;var rvector: vec2f=theta*(uniforms.HmdWarpParam.x+uniforms.HmdWarpParam.y*rSq+uniforms.HmdWarpParam.z*rSq*rSq+uniforms.HmdWarpParam.w*rSq*rSq*rSq);return uniforms.LensCenter+uniforms.Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var tc: vec2f=HmdWarp(input.vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0) {fragmentOutputs.color=vec4f(0.0,0.0,0.0,0.0);}\nelse{fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,tc);}}";i(43862).l.ShadersStoreWGSL[r]=n;const s={name:r,shader:n}},39653:(e,t,i)=>{i.d(t,{_:()=>n,n:()=>s});var r=i(90066);class n{}n.ANCHOR_SYSTEM="xr-anchor-system",n.BACKGROUND_REMOVER="xr-background-remover",n.HIT_TEST="xr-hit-test",n.MESH_DETECTION="xr-mesh-detection",n.PHYSICS_CONTROLLERS="xr-physics-controller",n.PLANE_DETECTION="xr-plane-detection",n.POINTER_SELECTION="xr-controller-pointer-selection",n.TELEPORTATION="xr-controller-teleportation",n.FEATURE_POINTS="xr-feature-points",n.HAND_TRACKING="xr-hand-tracking",n.IMAGE_TRACKING="xr-image-tracking",n.NEAR_INTERACTION="xr-near-interaction",n.DOM_OVERLAY="xr-dom-overlay",n.MOVEMENT="xr-controller-movement",n.LIGHT_ESTIMATION="xr-light-estimation",n.EYE_TRACKING="xr-eye-tracking",n.WALKING_LOCOMOTION="xr-walking-locomotion",n.LAYERS="xr-layers",n.DEPTH_SENSING="xr-depth-sensing",n.SPACE_WARP="xr-space-warp",n.RAW_CAMERA_ACCESS="xr-raw-camera-access";class s{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];!t.enabled||t.featureImplementation.attached||t.featureImplementation.disableAutoAttach||this.attachFeature(e)}))})),this._xrSessionManager.onXRSessionEnded.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];t.enabled&&t.featureImplementation.attached&&this.detachFeature(e)}))}))}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){const n=this._AvailableFeatures[e][t];if(!n)throw new Error("feature not found");return n(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||r.S0.Warn(`Feature ${e} failed to attach`))}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||r.S0.Warn(`Feature ${e} failed to detach`))}disableFeature(e){const t="string"==typeof e?e:e.Name,i=this._features[t];return!(!i||!i.enabled||(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],0))}dispose(){this.getEnabledFeatures().forEach((e=>{this.disableFeature(e)}))}enableFeature(e,t="latest",i={},n=!0,a=!0){const o="string"==typeof e?e:e.Name;let l=0;if("string"==typeof t){if(!t)throw new Error(`Error in provided version - ${o} (${t})`);if(l="stable"===t?s.GetStableVersionOfFeature(o):"latest"===t?s.GetLatestVersionOfFeature(o):+t,-1===l||isNaN(l))throw new Error(`feature not found - ${o} (${t})`)}else l=t;const c=s._ConflictingFeatures[o];if(void 0!==c&&-1!==this.getEnabledFeatures().indexOf(c))throw new Error(`Feature ${o} cannot be enabled while ${c} is enabled.`);const h=this._features[o],u=s.ConstructFeature(o,l,this._xrSessionManager,i);if(!u)throw new Error(`feature not found - ${o}`);h&&this.disableFeature(o);const d=u();if(d.dependsOn){const e=d.dependsOn.every((e=>!!this._features[e]));if(!e)throw new Error(`Dependant features missing. Make sure the following features are enabled - ${d.dependsOn.join(", ")}`)}if(d.isCompatible())return this._features[o]={featureImplementation:d,enabled:!0,version:l,required:a},n?this._xrSessionManager.session&&!this._features[o].featureImplementation.attached&&this.attachFeature(o):this._features[o].featureImplementation.disableAutoAttach=!0,this._features[o].featureImplementation;if(a)throw new Error("required feature not compatible");return r.S0.Warn(`Feature ${o} not compatible with the current environment/browser and was not enabled.`),d}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const t=this._features[i],r=t.featureImplementation.xrNativeFeatureName;if(r&&(t.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(r)&&e.requiredFeatures.push(r)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(r)&&e.optionalFeatures.push(r))),t.featureImplementation.getXRSessionInitExtension){const i=await t.featureImplementation.getXRSessionInitExtension();e={...e,...i}}}return e}}s._AvailableFeatures={},s._ConflictingFeatures={[n.TELEPORTATION]:n.MOVEMENT,[n.MOVEMENT]:n.TELEPORTATION}},85685:(e,t,i)=>{i.d(t,{CA:()=>d,Nx:()=>f,WZ:()=>m,hA:()=>p});var r=i(9191),n=i(34116),s=i(45413),a=i(70461),o=i(69583),l=i(28900),c=i(75556),h=i(63832),u=i(90066);class d{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach((t=>e=e.concat(t.bones))),e}}class p extends d{}class f{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach((e=>{e.dispose()})),this.rootNodes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0}}class m extends d{constructor(e){super(),this._wasAddedToScene=!1,(e=e||o.q.LastCreatedScene)&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add((()=>{this._wasAddedToScene||this.dispose()})),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild()})))}_topologicalSort(e){const t=new Map;for(const i of e)t.set(i.uniqueId,i);const i={dependsOn:new Map,dependedBy:new Map};for(const t of e){const e=t.uniqueId;i.dependsOn.set(e,new Set),i.dependedBy.set(e,new Set)}for(const r of e){const e=r.uniqueId,n=i.dependsOn.get(e);if(r instanceof l.Z){const s=r.sourceMesh;t.has(s.uniqueId)&&(n.add(s.uniqueId),i.dependedBy.get(s.uniqueId).add(e))}const s=i.dependedBy.get(e);for(const n of r.getDescendants()){const r=n.uniqueId;t.has(r)&&(s.add(r),i.dependsOn.get(r).add(e))}}const r=[],n=[];for(const r of e){const e=r.uniqueId;0===i.dependsOn.get(e).size&&(n.push(r),t.delete(e))}const s=n;for(;s.length>0;){const e=s.shift();r.push(e);const n=i.dependedBy.get(e.uniqueId);for(const r of Array.from(n.values())){const n=i.dependsOn.get(r);n.delete(e.uniqueId),0===n.size&&t.get(r)&&(s.push(t.get(r)),t.delete(r))}}return t.size>0&&(a.V.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach((e=>a.V.Error(e.name)))),r}_addNodeAndDescendantsToList(e,t,i,r){if(i&&(!r||r(i))&&!t.has(i.uniqueId)){e.push(i),t.add(i.uniqueId);for(const n of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,n,r)}}_isNodeInContainer(e){return e instanceof s.u&&-1!==this.meshes.indexOf(e)||e instanceof n.V&&-1!==this.transformNodes.indexOf(e)||e instanceof c.v&&-1!==this.lights.indexOf(e)||e instanceof h.i&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return a.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return a.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return a.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return a.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||u.S0.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const n={},s={},a=new f,o=[],l=[],c={doNotInstantiate:!0,...i},h=[],d=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(h,d,e,c.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(h,d,e,c.predicate);const p=this._topologicalSort(h),m=(i,o)=>{if(((t,i)=>{if(n[t.uniqueId]=i.uniqueId,s[i.uniqueId]=i,e&&(i.name=e(t.name)),i instanceof r.e){const e=i;if(e.morphTargetManager){const i=t.morphTargetManager;e.morphTargetManager=i.clone();for(let t=0;t<i.numTargets;t++){const r=i.getTarget(t),a=e.morphTargetManager.getTarget(t);n[r.uniqueId]=a.uniqueId,s[a.uniqueId]=a}}}})(i,o),i.parent){const e=n[i.parent.uniqueId],t=s[e];o.parent=t||i.parent}if(o.position&&i.position&&o.position.copyFrom(i.position),o.rotationQuaternion&&i.rotationQuaternion&&o.rotationQuaternion.copyFrom(i.rotationQuaternion),o.rotation&&i.rotation&&o.rotation.copyFrom(i.rotation),o.scaling&&i.scaling&&o.scaling.copyFrom(i.scaling),o.material){const r=o;if(r.material)if(t){const t=i.material;if(-1===l.indexOf(t)){let i=t.clone(e?e(t.name):"Clone of "+t.name);if(l.push(t),n[t.uniqueId]=i.uniqueId,s[i.uniqueId]=i,"MultiMaterial"===t.getClassName()){const r=t;for(const t of r.subMaterials)t&&(i=t.clone(e?e(t.name):"Clone of "+t.name),l.push(t),n[t.uniqueId]=i.uniqueId,s[i.uniqueId]=i);r.subMaterials=r.subMaterials.map((e=>e&&s[n[e.uniqueId]]))}}"InstancedMesh"!==r.getClassName()&&(r.material=s[n[t.uniqueId]])}else"MultiMaterial"===r.material.getClassName()?-1===this.scene.multiMaterials.indexOf(r.material)&&this.scene.addMultiMaterial(r.material):-1===this.scene.materials.indexOf(r.material)&&this.scene.addMaterial(r.material)}null===o.parent&&a.rootNodes.push(o)};return p.forEach((e=>{if("InstancedMesh"===e.getClassName()){const t=e,i=t.sourceMesh,r=n[i.uniqueId],a=("number"==typeof r?s[r]:i).createInstance(t.name);m(t,a)}else{let t=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=!1:c.doNotInstantiate&&(t="function"==typeof c.doNotInstantiate?!c.doNotInstantiate(e):!c.doNotInstantiate);const i=t?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,!0);if(!i)throw new Error(`Could not clone or instantiate node on Asset Container ${e.name}`);m(e,i)}})),this.skeletons.forEach((t=>{if(c.predicate&&!c.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name);for(const e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){const t=s[n[e.uniqueId]];if(!t||t.isAnInstance)continue;if(t.skeleton=i,-1!==o.indexOf(i))continue;o.push(i);for(const e of i.bones)e._linkedTransformNode&&(e._linkedTransformNode=s[n[e._linkedTransformNode.uniqueId]])}a.skeletons.push(i)})),this.animationGroups.forEach((t=>{if(c.predicate&&!c.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name,(e=>s[n[e.uniqueId]]||e));a.animationGroups.push(i)})),a}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||u.S0.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach((i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))})),this.lights.forEach((i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))})),this.meshes.forEach((i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.addSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.addAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.addAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.addMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.addMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.addGeometry(t)})),this.transformNodes.forEach((i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.addActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.addTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.addReflectionProbe(t)}));for(const e of t)e.parent&&-1===this.scene.getNodes().indexOf(e.parent)&&(e.setParent?e.setParent(null):e.parent=null)}removeAllFromScene(){this._isValidHierarchy()||u.S0.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach((t=>{e&&!e(t)||this.scene.removeCamera(t)})),this.lights.forEach((t=>{e&&!e(t)||this.scene.removeLight(t)})),this.meshes.forEach((t=>{e&&!e(t)||this.scene.removeMesh(t,!0)})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.removeSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.removeAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.removeMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.removeGeometry(t)})),this.transformNodes.forEach((t=>{e&&!e(t)||this.scene.removeTransformNode(t)})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.removeActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.removeTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)}))}dispose(){this.cameras.slice(0).forEach((e=>{e.dispose()})),this.cameras.length=0,this.lights.slice(0).forEach((e=>{e.dispose()})),this.lights.length=0,this.meshes.slice(0).forEach((e=>{e.dispose()})),this.meshes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach((e=>{e.dispose()})),this.multiMaterials.length=0,this.materials.slice(0).forEach((e=>{e.dispose()})),this.materials.length=0,this.geometries.slice(0).forEach((e=>{e.dispose()})),this.geometries.length=0,this.transformNodes.slice(0).forEach((e=>{e.dispose()})),this.transformNodes.length=0,this.actionManagers.slice(0).forEach((e=>{e.dispose()})),this.actionManagers.length=0,this.textures.slice(0).forEach((e=>{e.dispose()})),this.textures.length=0,this.reflectionProbes.slice(0).forEach((e=>{e.dispose()})),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach((e=>{e.dispose()})),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(const r of e){let e=!0;if(i)for(const t of i)if(r===t){e=!1;break}e&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new p);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new r.e("assetContainerRootMesh",this.scene);return this.meshes.forEach((t=>{t.parent||e.addChild(t)})),this.meshes.unshift(e),e}mergeAnimationsTo(e=o.q.LastCreatedScene,t,i=null){if(!e)return a.V.Error("No scene available to merge animations to"),[];const r=i||(t=>{let i=null;const r=t.animations.length?t.animations[0].targetProperty:"",n=t.name.split(".").join("").split("_primitive")[0];switch(r){case"position":case"rotationQuaternion":i=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(n);break;case"influence":i=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(n);break;default:i=e.getNodeByName(t.name)||e.getNodeByName(n)}return i});this.getNodes().forEach((e=>{const t=r(e);if(null!==t){for(const i of e.animations){const e=t.animations.filter((e=>e.targetProperty===i.targetProperty));for(const i of e){const e=t.animations.indexOf(i,0);e>-1&&t.animations.splice(e,1)}}t.animations=t.animations.concat(e.animations)}}));const n=[];return this.animationGroups.slice().forEach((e=>{n.push(e.clone(e.name,r)),e.animatables.forEach((e=>{e.stop()}))})),t.forEach((t=>{const i=r(t.target);i&&(e.beginAnimation(i,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))})),n}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.transformNodes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.lights.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.cameras.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}))}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const e=t.pop();if(e instanceof r.e?(e.geometry&&-1===this.geometries.indexOf(e.geometry)&&this.geometries.push(e.geometry),this.meshes.push(e)):e instanceof n.V?this.transformNodes.push(e):e instanceof c.v?this.lights.push(e):e instanceof h.i&&this.cameras.push(e),e instanceof s.u){if(e.material&&-1===this.materials.indexOf(e.material)){this.materials.push(e.material);for(const t of e.material.getActiveTextures())-1===this.textures.indexOf(t)&&this.textures.push(t)}e.skeleton&&-1===this.skeletons.indexOf(e.skeleton)&&this.skeletons.push(e.skeleton),e.morphTargetManager&&-1===this.morphTargetManagers.indexOf(e.morphTargetManager)&&this.morphTargetManagers.push(e.morphTargetManager)}for(const r of e.getChildren())i.has(r)||t.push(r);i.add(e)}this.populateRootNodes()}}},65694:(e,t,i)=>{i.r(t),i.d(t,{AbstractActionManager:()=>r.G,AbstractAssetContainer:()=>ie.CA,AbstractAssetTask:()=>NS,AbstractEngine:()=>ne.$,AbstractMesh:()=>Er.u,AcquireNativeObjectAsync:()=>hn,Action:()=>l,ActionEvent:()=>c.X,ActionManager:()=>A,AddAnimationExtensions:()=>N.SM,AddBlock:()=>af,AddIndividualParser:()=>Dc.cf,AddParser:()=>Dc.ji,AddRayExtensions:()=>Ii.Oj,AddressMode:()=>Cn.Ap,AdvancedTimer:()=>Tc.Qz,Aggregations:()=>Gg,AggregatorBlock:()=>fS,AlignBlock:()=>Mv,AlphaState:()=>$A.i,AmmoJSPlugin:()=>qh.v,AnaglyphArcRotateCamera:()=>Qt,AnaglyphFreeCamera:()=>Jt,AnaglyphGamepadCamera:()=>ei,AnaglyphPostProcess:()=>Kt,AnaglyphUniversalCamera:()=>ti,Analyser:()=>se,AndOrNotEvaluator:()=>OS.Z,Angle:()=>wo.uM,Animatable:()=>N.rT,AnimatedInputBlockTypes:()=>Rl,Animation:()=>M.X5,AnimationAssetTask:()=>wS,AnimationEvent:()=>K.p,AnimationGroup:()=>Z.AnimationGroup,AnimationGroupMask:()=>te,AnimationGroupMaskMode:()=>Q,AnimationKeyInterpolation:()=>$,AnimationPropertiesOverride:()=>D,AnimationRange:()=>J.K,AnisotropyBlock:()=>qf,ApplyLut:()=>ju.Kq,ApplyPostProcess:()=>kh.Qs,Arc2:()=>wo.Xy,ArcFollowCamera:()=>Bt.n,ArcRotateCamera:()=>It,ArcRotateCameraGamepadInput:()=>Ze,ArcRotateCameraInputsManager:()=>st,ArcRotateCameraKeyboardMoveInput:()=>Je,ArcRotateCameraMouseWheelInput:()=>rt,ArcRotateCameraPointersInput:()=>nt,ArcRotateCameraVRDeviceOrientationInput:()=>at,ArcTan2Block:()=>If,AssetContainer:()=>ie.WZ,AssetTaskState:()=>mS,AssetsManager:()=>HS,AssetsProgressEvent:()=>DS,AsyncLock:()=>wT,AsyncLoop:()=>re.LV,AttachToBoxBehavior:()=>Ae,AudioEngine:()=>ae.L,AudioSceneComponent:()=>oe.Y,AutoLayoutMode:()=>Cn.$_,AutoReleaseWorkerPool:()=>Cx.h,AutoRotationBehavior:()=>Ce,AxesViewer:()=>br.AxesViewer,Axis:()=>wo._0,AxisDragGizmo:()=>lo.e,AxisScaleGizmo:()=>fo,BRDFTextureTools:()=>Xf.J,BabylonFileLoaderConfiguration:()=>iu,BackEase:()=>B,BackgroundMaterial:()=>jo,BakedVertexAnimationManager:()=>fe,BallAndSocketConstraint:()=>BE,BaseCameraMouseWheelInput:()=>Ye.l,BaseCameraPointersInput:()=>Xe.R,BaseError:()=>en.Cf,BaseParticleSystem:()=>$l,BaseSixDofDragBehavior:()=>De.D,BaseTexture:()=>Vo.t,BasisFileInfo:()=>YS.$e,BasisTools:()=>YS.ED,BasisToolsOptions:()=>YS.Sl,BasisTranscodeConfiguration:()=>YS.SV,BezierCurve:()=>wo.vr,BezierCurveEase:()=>q,BiPlanarBlock:()=>um,BinaryFileAssetTask:()=>VS,BindBonesParameters:()=>qo.f$,BindFogParameters:()=>qo.Yy,BindLight:()=>qo.Kd,BindLightProperties:()=>qo.L0,BindLights:()=>qo.RL,BindLogDepth:()=>qo.DL,BindMorphTargetParameters:()=>qo.nR,BindSceneUniformBuffer:()=>qo._8,BindTextureMatrix:()=>qo.mA,BlackAndWhitePostProcess:()=>dC,BlendFactor:()=>Cn.dn,BlendOperation:()=>Cn.Tb,BloomEffect:()=>_C,BloomMergePostProcess:()=>mC,BlurPostProcess:()=>ko,Bone:()=>we.$,BoneAxesViewer:()=>br.BoneAxesViewer,BoneIKController:()=>Be,BoneLookController:()=>Ge,BonesBlock:()=>Ad,BooleanGeometryBlock:()=>jv,BooleanGeometryOperations:()=>Vg,BounceEase:()=>V,BouncingBehavior:()=>be,BoundingBlock:()=>$v,BoundingBox:()=>pr.I,BoundingBoxGizmo:()=>vo,BoundingBoxRenderer:()=>hP.b,BoundingInfo:()=>fr.j,BoundingInfoHelper:()=>mr,BoundingSphere:()=>vr.i,BoxBlock:()=>Xg,BoxBuilder:()=>co.Jo,BoxParticleEmitter:()=>Hx,Buffer:()=>Ue.h,BufferBindingType:()=>Cn.Yl,BufferMapState:()=>Cn.GU,BufferUsage:()=>Cn.Sd,CSG:()=>P_,CSG2:()=>yg,Camera:()=>Ct.i,CameraGizmo:()=>Bo,CameraInputTypes:()=>qe.H,CameraInputsManager:()=>qe._,CannonJSPlugin:()=>Yh,CanvasAlphaMode:()=>Cn.Qb,CanvasToneMappingMode:()=>Cn.Ag,CapsuleBlock:()=>iv,CapsuleBuilder:()=>ug.H4,CascadedShadowGenerator:()=>Eh,ChromaticAberrationPostProcess:()=>gC,CircleEase:()=>w,CircleOfConfusionPostProcess:()=>vC,ClampBlock:()=>lf,CleanGeometryBlock:()=>gv,ClearCoatBlock:()=>jf,ClipPlanesBlock:()=>Rp,ClipboardEventTypes:()=>wn.G,ClipboardInfo:()=>wn.f,CloudBlock:()=>om,CloudPoint:()=>_E.M,Collider:()=>Zi,Color3:()=>wo.v9,Color3Gradient:()=>Bx,Color4:()=>wo.ov,ColorConverterBlock:()=>_m,ColorCorrectionPostProcess:()=>SC,ColorCurves:()=>vu.Q,ColorGradient:()=>wx,ColorGradingTexture:()=>Vu,ColorMergerBlock:()=>pf,ColorSplitterBlock:()=>jl,ColorWrite:()=>Cn.Vz,CombineAction:()=>E,CompareFunction:()=>Cn.MT,CompatibilityOptions:()=>cr.p9,CompilationMessageType:()=>Cn.$s,CompleteGreasedLineColorTable:()=>Sg,CompleteGreasedLineWidthTable:()=>vg,CompressionCodes:()=>Qu.he,ComputeBindingType:()=>zr,ComputeEffect:()=>ur,ComputeNormalsBlock:()=>Sv,ComputePassTimestampLocation:()=>Cn.MW,ComputeShader:()=>dr.H,ComputeShaderBoundingHelper:()=>gr.ComputeShaderBoundingHelper,ComputeShaderParticleSystem:()=>jT,Condition:()=>h,ConditionBlock:()=>dv,ConditionBlockTests:()=>Fg,ConditionalBlock:()=>am,ConditionalBlockConditions:()=>rm,ConeDirectedParticleEmitter:()=>nT,ConeParticleEmitter:()=>rT,Constants:()=>Rr.Y,ContainerAssetTask:()=>FS,ConversionMode:()=>Hs,ConvolutionPostProcess:()=>xC,Coordinate:()=>wo.xp,CopyFloatData:()=>ze.g,CopyTextureToTexture:()=>Zs,CopyTools:()=>ET.D8,CreateBox:()=>co.an,CreateBoxVertexData:()=>co.KA,CreateCapsule:()=>ug._S,CreateCapsuleVertexData:()=>ug.yD,CreateCylinder:()=>ho.zk,CreateCylinderVertexData:()=>ho.ZS,CreateDashedLines:()=>_o.NX,CreateDashedLinesVertexData:()=>_o.nP,CreateDecal:()=>hg.m,CreateDecoderAsync:()=>Ju.d,CreateDisc:()=>Oo.WA,CreateDiscVertexData:()=>Oo.OD,CreateEnvTextureAsync:()=>Xr.Hx,CreateGeodesic:()=>lg.M,CreateGoldberg:()=>cg.R,CreateGoldbergVertexData:()=>cg.z,CreateGreasedLine:()=>_g,CreateGreasedLineMaterial:()=>mg,CreateGround:()=>Hi.km,CreateGroundFromHeightMap:()=>Hi.RI,CreateGroundFromHeightMapVertexData:()=>Hi.r_,CreateGroundVertexData:()=>Hi.EH,CreateHemisphere:()=>No,CreateHotSpotQueryForPickingInfo:()=>f_,CreateIcoSphere:()=>_c.Ds,CreateIcoSphereVertexData:()=>_c.F,CreateImageBitmapFromSource:()=>Ln.kF,CreateImageDataArrayBufferViews:()=>Xr.$h,CreateLathe:()=>sg.p,CreateLineSystem:()=>_o.uz,CreateLineSystemVertexData:()=>_o.e8,CreateLines:()=>_o.sh,CreatePickingRay:()=>Ii.ui,CreatePickingRayInCameraSpace:()=>Ii.AU,CreatePickingRayInCameraSpaceToRef:()=>Ii.oZ,CreatePickingRayToRef:()=>Ii.Gz,CreatePlane:()=>xo.x,CreatePlaneVertexData:()=>xo.LG,CreatePolygon:()=>rg.v1,CreatePolygonVertexData:()=>rg.To,CreatePolyhedron:()=>Po.D6,CreatePolyhedronVertexData:()=>Po.dc,CreateResizedCopy:()=>kh.EE,CreateRibbon:()=>tg.fv,CreateRibbonVertexData:()=>tg.X,CreateScreenshot:()=>Ax,CreateScreenshotAsync:()=>Rx,CreateScreenshotUsingRenderTarget:()=>Mx,CreateScreenshotUsingRenderTargetAsync:()=>Ox,CreateScreenshotWithResizeAsync:()=>Ix,CreateSegmentedBoxVertexData:()=>co.G$,CreateSphere:()=>Mo._6,CreateSphereVertexData:()=>Mo.W$,CreateText:()=>Hm.c,CreateTextShapePaths:()=>Hm.r,CreateTiledBox:()=>eg.uk,CreateTiledBoxVertexData:()=>eg.UY,CreateTiledGround:()=>Hi.ol,CreateTiledGroundVertexData:()=>Hi.k,CreateTiledPlane:()=>ag.HU,CreateTiledPlaneVertexData:()=>ag.jR,CreateTorus:()=>Yi.YA,CreateTorusKnot:()=>ig.sF,CreateTorusKnotVertexData:()=>ig.Mi,CreateTorusVertexData:()=>Yi.qq,CreateTube:()=>og.V,CrossBlock:()=>cf,CubeMapToSphericalPolynomialTools:()=>Bh.d,CubeTexture:()=>Uo.b,CubeTextureAssetTask:()=>US,CubicEase:()=>k,CullMode:()=>Cn.Ac,CurrentScreenBlock:()=>Vl,Curve3:()=>wo.jj,CurveBlock:()=>mm,CurveBlockTypes:()=>sm,CustomBlock:()=>hf,CustomOptimization:()=>ax,CustomParticleEmitter:()=>Kx,CustomProceduralTexture:()=>nd,CylinderBlock:()=>tv,CylinderBuilder:()=>ho.og,CylinderDirectedParticleEmitter:()=>iT,CylinderParticleEmitter:()=>tT,DDSTools:()=>XS.DDSTools,DataBuffer:()=>We.n,DataReader:()=>Ux.s,DataStorage:()=>zx,Database:()=>XT,DebugBlock:()=>Gv,DebugLayer:()=>br.DebugLayer,DebugLayerTab:()=>br.DebugLayerTab,DecalBuilder:()=>hg.f,DecalMapConfiguration:()=>Fm,DecalMapDefines:()=>Dm,Decode:()=>ge.Tq,DecodeBase64ToBinary:()=>ge.yS,DecodeBase64ToString:()=>ge.AV,DecodeBase64UrlToBinary:()=>Gu.rz,DecodeBase64UrlToString:()=>Gu.dy,DecodeFloat32:()=>Qu.Sn,DecodeRunLength:()=>Ku._,DeepCopier:()=>y.r,DefaultCollisionCoordinator:()=>Qi,DefaultKTX2DecoderOptions:()=>_T.$,DefaultLoadingScreen:()=>Dh,DefaultRenderingPipeline:()=>zC,Deferred:()=>qS.c,DepthCullingState:()=>jA.N,DepthOfFieldBlurPostProcess:()=>TC,DepthOfFieldEffect:()=>CC,DepthOfFieldEffectBlurLevel:()=>lC,DepthOfFieldMergePostProcess:()=>EC,DepthPeelingRenderer:()=>pP,DepthPeelingSceneComponent:()=>fP,DepthReducer:()=>_h,DepthRenderer:()=>ph,DepthRendererSceneComponent:()=>uP,DepthSortedParticle:()=>tE,DerivativeBlock:()=>$d,DesaturateBlock:()=>Hf,DetailMapConfiguration:()=>Nm.c,DeviceInputEventType:()=>tt.b,DeviceLostReason:()=>Cn.Ld,DeviceOrientationCamera:()=>Mt,DeviceSource:()=>yr.c,DeviceSourceManager:()=>Ar.Z,DeviceType:()=>Pr.bq,DirectionalLight:()=>Io.Z,DirectionalLightFrustumViewer:()=>br.DirectionalLightFrustumViewer,DiscBlock:()=>rv,DiscBuilder:()=>Oo.x3,DiscardBlock:()=>Xd,DisplayPassPostProcess:()=>bC,DistanceBlock:()=>bf,DistanceConstraint:()=>VE,DistanceJoint:()=>zh.G3,DivideBlock:()=>_f,DoNothingAction:()=>T,DomManagement:()=>Ut.Az,DotBlock:()=>uf,DracoCompression:()=>g_.g,DragOperation:()=>mo,DrawWrapper:()=>ec.E,DualSenseInput:()=>Pr.pI,DualShockButton:()=>Lt,DualShockDpad:()=>wt,DualShockInput:()=>Pr.h8,DualShockPad:()=>Wt,DumpTools:()=>Px.DumpTools,DynamicFloat32Array:()=>PT,DynamicTexture:()=>Ni.R,EXROutputType:()=>Zu.V,EasingFunction:()=>L,EdgesRenderer:()=>_P,Effect:()=>So.M,EffectFallbacks:()=>Yo.J,EffectLayer:()=>Nc,EffectLayerSceneComponent:()=>Fc,EffectRenderer:()=>Ks.J,EffectWrapper:()=>Ks.$,ElasticEase:()=>G,ElbowBlock:()=>cm,EncodeArrayBufferToBase64:()=>ge.EL,EndsWith:()=>ge.jq,Engine:()=>_i.N,EngineFactory:()=>Fn,EngineFormat:()=>fd.GQ,EngineInstrumentation:()=>Ic,EngineStore:()=>P.q,EngineView:()=>wr,EnvironmentHelper:()=>Ko,EnvironmentTextureTools:()=>Xr.qY,Epsilon:()=>wo.bH,EquiRectangularCubeTexture:()=>Uu,EquiRectangularCubeTextureAssetTask:()=>WS,ErrorCodes:()=>en.tG,ErrorFilter:()=>Cn.fw,EventConstants:()=>tt.s,EventState:()=>n.qO,ExecuteCodeAction:()=>C,ExitFullscreen:()=>Ln.g7,ExitPointerlock:()=>Ln.rT,ExponentialEase:()=>U,ExrLoaderGlobalConfiguration:()=>Zu.u,ExternalTexture:()=>zu.r,ExtractHighlightsPostProcess:()=>fC,ExtrudePolygon:()=>rg.sV,ExtrudeShape:()=>ng.tF,ExtrudeShapeCustom:()=>ng.ei,FactorGradient:()=>Vx,FadeInOutBehavior:()=>Re._,FeatureName:()=>Cn.SD,FileTools:()=>Gu.wS,FileToolsOptions:()=>Gu.eC,FilesInput:()=>KS,FilesInputStore:()=>jS.T,FilterMode:()=>Cn.U7,FilterPostProcess:()=>PC,FixFlippedFaces:()=>o_.Y4,FlowGraph:()=>Bn.$,FlowGraphAbsBlock:()=>Ns.IC,FlowGraphAcosBlock:()=>Ns.eR,FlowGraphAcoshBlock:()=>Ns.c5,FlowGraphAddBlock:()=>Ns.nm,FlowGraphAsinBlock:()=>Ns.P3,FlowGraphAsinhBlock:()=>Ns.dm,FlowGraphAtan2Block:()=>Ns.CN,FlowGraphAtanBlock:()=>Ns.Q6,FlowGraphAtanhBlock:()=>Ns.yq,FlowGraphBitwiseAndBlock:()=>Ns.EX,FlowGraphBitwiseLeftShiftBlock:()=>Ns.Mq,FlowGraphBitwiseNotBlock:()=>Ns.uk,FlowGraphBitwiseOrBlock:()=>Ns.YT,FlowGraphBitwiseRightShiftBlock:()=>Ns.xi,FlowGraphBitwiseXorBlock:()=>Ns.w1,FlowGraphBlock:()=>Vn.e,FlowGraphBranchBlock:()=>Qn,FlowGraphCeilBlock:()=>Ns.Bz,FlowGraphClampBlock:()=>Ns.FZ,FlowGraphConditionalDataBlock:()=>gs,FlowGraphConnection:()=>Xn.X,FlowGraphConnectionType:()=>Xn.H,FlowGraphConsoleLogBlock:()=>$n.B,FlowGraphConstantBlock:()=>Ts,FlowGraphContext:()=>Wn.Y,FlowGraphContextLogger:()=>Yn,FlowGraphCoordinateTransformBlock:()=>Ss,FlowGraphCoordinator:()=>Hn.x,FlowGraphCosBlock:()=>Ns.fk,FlowGraphCoshBlock:()=>Ns.ro,FlowGraphCountLeadingZerosBlock:()=>Ns._I,FlowGraphCountOneBitsBlock:()=>Ns.j,FlowGraphCountTrailingZerosBlock:()=>Ns.KJ,FlowGraphCounterBlock:()=>os,FlowGraphCrossBlock:()=>Ns.M,FlowGraphCubeRootBlock:()=>Ns.T2,FlowGraphDataConnection:()=>qn.l,FlowGraphDebounceBlock:()=>cs,FlowGraphDegToRadBlock:()=>Ns.i2,FlowGraphDeterminantBlock:()=>Ns.Rl,FlowGraphDivideBlock:()=>Ns.VZ,FlowGraphDoNBlock:()=>Jn.V,FlowGraphDotBlock:()=>Ns.xv,FlowGraphEBlock:()=>Ns.nc,FlowGraphEqBlock:()=>Ns.ud,FlowGraphEventBlock:()=>Un.i,FlowGraphExecutionBlock:()=>Gn.u,FlowGraphExpBlock:()=>Ns.B5,FlowGraphFlipFlopBlock:()=>hs,FlowGraphFloorBlock:()=>Ns.my,FlowGraphForLoopBlock:()=>ts,FlowGraphFractBlock:()=>Ns._L,FlowGraphGetPropertyBlock:()=>Es.v,FlowGraphGetVariableBlock:()=>vs.g,FlowGraphGreaterThanBlock:()=>Ns.Vu,FlowGraphGreaterThanOrEqualBlock:()=>Ns.ct,FlowGraphInfBlock:()=>Ns.vs,FlowGraphInterpolateBlock:()=>Ns.rY,FlowGraphInvertMatrixBlock:()=>Ns.P_,FlowGraphIsInfBlock:()=>Ns.hH,FlowGraphIsNanBlock:()=>Ns.JA,FlowGraphLengthBlock:()=>Ns.EF,FlowGraphLessThanBlock:()=>Ns.ws,FlowGraphLessThanOrEqualBlock:()=>Ns.dq,FlowGraphLog10Block:()=>Ns.l9,FlowGraphLog2Block:()=>Ns.w$,FlowGraphLogBlock:()=>Ns.uE,FlowGraphLogicAndBlock:()=>Is,FlowGraphLogicNotBlock:()=>Os,FlowGraphLogicOrBlock:()=>Ms,FlowGraphMatMulBlock:()=>Ns.Ix,FlowGraphMaxBlock:()=>Ns.OK,FlowGraphMeshPickEventBlock:()=>Ds.i,FlowGraphMinBlock:()=>Ns.WR,FlowGraphMultiGateBlock:()=>ns,FlowGraphMultiplyBlock:()=>Ns.yW,FlowGraphNaNBlock:()=>Ns.pg,FlowGraphNegBlock:()=>Ns.Oi,FlowGraphNormalizeBlock:()=>Ns.TK,FlowGraphPauseAnimationBlock:()=>_s,FlowGraphPiBlock:()=>Ns.L7,FlowGraphPlayAnimationBlock:()=>fs,FlowGraphPowBlock:()=>Ns.sV,FlowGraphRadToDegBlock:()=>Ns.Qe,FlowGraphRandomBlock:()=>Ns.Je,FlowGraphReceiveCustomEventBlock:()=>Ls.W,FlowGraphRemainderBlock:()=>Ns.fG,FlowGraphRotate2DBlock:()=>Ns.z6,FlowGraphRotate3DBlock:()=>Ns.g1,FlowGraphSaturateBlock:()=>Ns.ns,FlowGraphSceneReadyEventBlock:()=>Fs.b,FlowGraphSceneTickEventBlock:()=>ws.B,FlowGraphSendCustomEventBlock:()=>Zn.z,FlowGraphSequenceBlock:()=>us.v,FlowGraphSetPropertyBlock:()=>Kn.L,FlowGraphSetVariableBlock:()=>jn.U,FlowGraphSignBlock:()=>Ns.Fz,FlowGraphSignalConnection:()=>kn.R,FlowGraphSinBlock:()=>Ns.sR,FlowGraphSinhBlock:()=>Ns.Mk,FlowGraphSqrtBlock:()=>Ns.qJ,FlowGraphState:()=>Bn.I,FlowGraphStopAnimationBlock:()=>ms,FlowGraphSubtractBlock:()=>Ns.Cu,FlowGraphSwitchBlock:()=>ss,FlowGraphTanBlock:()=>Ns.Vb,FlowGraphTanhBlock:()=>Ns.Vl,FlowGraphThrottleBlock:()=>is,FlowGraphTimerBlock:()=>rs.B,FlowGraphTransposeBlock:()=>Ns.F9,FlowGraphTruncBlock:()=>Ns.CM,FlowGraphWaitAllBlock:()=>as,FlowGraphWhileLoopBlock:()=>ls.J,FluidRenderer:()=>YP,FluidRendererSceneComponent:()=>HP,FluidRenderingDebug:()=>FP,FluidRenderingObject:()=>wP,FluidRenderingObjectCustomParticles:()=>GP,FluidRenderingObjectParticleSystem:()=>BP,FluidRenderingTargetRenderer:()=>kP,FlyCamera:()=>Nt,FlyCameraInputsManager:()=>Ot,FlyCameraKeyboardInput:()=>ot,FlyCameraMouseInput:()=>lt,FogBlock:()=>Tp,FollowBehavior:()=>Fe.S,FollowCamera:()=>Bt.p,FollowCameraInputsManager:()=>Vt.r,FollowCameraKeyboardMoveInput:()=>ct.F,FollowCameraMouseWheelInput:()=>ht.t,FollowCameraPointersInput:()=>ut.p,FragCoordBlock:()=>jd,FragDepthBlock:()=>ep,FragmentOutputBlock:()=>Dl,FragmentOutputBlockColorSpace:()=>yl,FrameGraph:()=>na,FrameGraphBlackAndWhiteTask:()=>va,FrameGraphBloomTask:()=>Aa,FrameGraphBlurTask:()=>ya,FrameGraphCircleOfConfusionTask:()=>Oa,FrameGraphClearTextureTask:()=>ca,FrameGraphContext:()=>Qs,FrameGraphCopyToBackbufferColorTask:()=>zs,FrameGraphCopyToTextureTask:()=>ro,FrameGraphCullObjectsTask:()=>Ua,FrameGraphDepthOfFieldTask:()=>Va,FrameGraphExtractHighlightsTask:()=>Pa,FrameGraphGeometryRendererTask:()=>Xa,FrameGraphObjectList:()=>oo,FrameGraphObjectRendererTask:()=>$a,FrameGraphPass:()=>qs.X,FrameGraphPostProcessTask:()=>ga,FrameGraphRenderContext:()=>Js,FrameGraphRenderPass:()=>$s.p,FrameGraphRenderTarget:()=>ia,FrameGraphTAAObjectRendererTask:()=>Ja,FrameGraphTask:()=>Us.L,FrameGraphTextureManager:()=>ra,FramingBehavior:()=>Pe,FreeCamera:()=>Pt.S,FreeCameraDeviceOrientationInput:()=>pt,FreeCameraGamepadInput:()=>ft,FreeCameraInputsManager:()=>dt.s,FreeCameraKeyboardMoveInput:()=>_t.i,FreeCameraMouseInput:()=>gt.h,FreeCameraMouseWheelInput:()=>vt.m,FreeCameraTouchInput:()=>St.Z,FreeCameraVirtualJoystickInput:()=>Et,FresnelBlock:()=>Tf,FresnelParameters:()=>Su,FromHalfFloat:()=>kh.SX,FrontFace:()=>Cn.x_,FrontFacingBlock:()=>qd,Frustum:()=>wo.PP,FxaaPostProcess:()=>bx,GIRSM:()=>gy,GIRSMManager:()=>vy,GIRSMRenderPluginMaterial:()=>xy,GPUParticleSystem:()=>KT,GPUPicker:()=>nr,GUID:()=>ym.S,Gamepad:()=>je,GamepadCamera:()=>qt,GamepadManager:()=>Ht,GamepadSystemSceneComponent:()=>Yt,GaussianBlock:()=>Cd,GaussianSplattingBlock:()=>Ed,GaussianSplattingMaterial:()=>bd.b,GaussianSplattingMesh:()=>_S.t,GenerateBase64StringFromPixelData:()=>ET.c9,GenerateBase64StringFromTexture:()=>ET.lP,GenerateBase64StringFromTextureAsync:()=>ET.nh,GenericPad:()=>Ke,GeodesicData:()=>Y_.M6,Geometry:()=>Fh.V,GeometryArcTan2Block:()=>Kv,GeometryBufferRenderer:()=>NC,GeometryBufferRendererSceneComponent:()=>FC,GeometryClampBlock:()=>rS,GeometryCollectionBlock:()=>_v,GeometryCrossBlock:()=>nS,GeometryCurveBlock:()=>sS,GeometryCurveBlockTypes:()=>kg,GeometryDesaturateBlock:()=>aS,GeometryDistanceBlock:()=>cS,GeometryDotBlock:()=>hS,GeometryElbowBlock:()=>vv,GeometryInfoBlock:()=>Uv,GeometryInputBlock:()=>Yg,GeometryInterceptorBlock:()=>pS,GeometryLengthBlock:()=>uS,GeometryLerpBlock:()=>Zv,GeometryModBlock:()=>tS,GeometryNLerpBlock:()=>Qv,GeometryOptimizeBlock:()=>$g,GeometryOutputBlock:()=>Wg,GeometryPosterizeBlock:()=>oS,GeometryPowBlock:()=>iS,GeometryRenderingTextureClearType:()=>Wa.Z,GeometryReplaceColorBlock:()=>lS,GeometryRotate2dBlock:()=>dS,GeometrySmoothStepBlock:()=>eS,GeometryStepBlock:()=>Jv,GeometryTextureBlock:()=>Xv,GeometryTextureFetchBlock:()=>qv,GeometryTransformBlock:()=>Pv,GeometryTrigonometryBlock:()=>bv,GeometryTrigonometryBlockOperations:()=>wg,GetClass:()=>o.n9,GetClassName:()=>o.Uu,GetDOMTextContent:()=>Ut.Zl,GetEnvInfo:()=>Xr.cU,GetEnvironmentBRDFTexture:()=>Xf.X,GetExrHeader:()=>ed.V,GetFogState:()=>qo.qL,GetFontOffset:()=>Ln.PR,GetForwardRay:()=>Ii.KI,GetForwardRayToRef:()=>Ii.m9,GetHotSpotToRef:()=>__,GetIndividualParser:()=>Dc.LO,GetInternalFormatFromBasisFormat:()=>YS.yT,GetParser:()=>Dc.Iz,GetPointsCount:()=>gg,GetTGAHeader:()=>Tx.O_,GetTextureDataAsync:()=>kh.Oz,GetTransformedPosition:()=>m_,GetTypeForDepthTexture:()=>gi.GX,Gizmo:()=>uo.Fq,GizmoAnchorPoint:()=>uo.oO,GizmoCoordinatesMode:()=>uo.ry,GizmoManager:()=>Ao,GlowLayer:()=>Lc,GoldbergMesh:()=>R_.U,GradientBlock:()=>wf,GradientBlockColorStep:()=>Lf,GradientHelper:()=>kx,GrainPostProcess:()=>yC,GreasedLineBaseMesh:()=>dg,GreasedLineMaterialDefaults:()=>Wm,GreasedLineMesh:()=>pg,GreasedLineMeshColorDistribution:()=>Z_,GreasedLineMeshColorDistributionType:()=>Zm,GreasedLineMeshColorMode:()=>Km,GreasedLineMeshMaterialType:()=>jm,GreasedLineMeshWidthDistribution:()=>Q_,GreasedLinePluginMaterial:()=>qm,GreasedLineRibbonAutoDirectionMode:()=>K_,GreasedLineRibbonFacesMode:()=>j_,GreasedLineRibbonMesh:()=>fg,GreasedLineRibbonPointsMode:()=>$_,GreasedLineSimpleMaterial:()=>$m,GreasedLineTools:()=>Ym,GridBlock:()=>Jg,GroundBuilder:()=>Hi.LL,GroundMesh:()=>A_.f,HDRCubeTexture:()=>Gh,HDRCubeTextureAssetTask:()=>zS,HDRFiltering:()=>Vh,HDRTools:()=>wh.I9,Halton2DSequence:()=>Za,HandConstraintBehavior:()=>Le.Re,HandConstraintOrientation:()=>Le.d9,HandConstraintVisibility:()=>Le.VF,HandConstraintZone:()=>Le.rf,HandPart:()=>pc,HandleFallbacksForShadows:()=>qo.c4,HardwareScalingOptimization:()=>ix,HasStencilAspect:()=>gi.$l,HavokPlugin:()=>QE,HeightToNormalBlock:()=>Jd,HemisphereBuilder:()=>Do,HemisphericLight:()=>Ro.g,HemisphericParticleEmitter:()=>Qx,HighlightLayer:()=>Bc,HighlightsPostProcess:()=>AC,Hinge2Joint:()=>zh.EE,HingeConstraint:()=>kE,HingeJoint:()=>zh.m6,HtmlElementTexture:()=>Wu,HufUncompress:()=>ju.ZR,IWebXRControllerPhysicsOptions:()=>nR,IblCdfGenerator:()=>vP,IblCdfGeneratorSceneComponent:()=>SP,IblShadowsRenderPipeline:()=>yP,IcoSphereBlock:()=>Zg,IcoSphereBuilder:()=>_c.o4,ImageAssetTask:()=>kS,ImageProcessingBlock:()=>Wd,ImageProcessingConfiguration:()=>Mi.p,ImageProcessingPostProcess:()=>RC,ImageSourceBlock:()=>Cp,IncrementValueAction:()=>v,IndexFormat:()=>Cn.uK,InitializeCSG2Async:()=>Rg,InputBlock:()=>Bl,InspectableType:()=>Fx,InstancedLinesMesh:()=>N_.Q,InstancedMesh:()=>O_.Z,InstancesBlock:()=>Rd,InstantiateBlock:()=>wv,InstantiateLinearBlock:()=>Bv,InstantiateOnFacesBlock:()=>Dv,InstantiateOnVerticesBlock:()=>Nv,InstantiateOnVolumeBlock:()=>Fv,InstantiateRadialBlock:()=>Vv,InstantiatedEntries:()=>ie.Nx,IntFloatConverterBlock:()=>kv,InterleaveScalar:()=>Qu.KA,InternalTexture:()=>gi.hV,InternalTextureSource:()=>gi.GV,InterpolateValueAction:()=>O,IntersectionInfo:()=>er.w,IsBase64DataUrl:()=>Gu.f2,IsCSG2Ready:()=>Ag,IsDepthTexture:()=>gi.vl,IsDocumentAvailable:()=>Ut.Nf,IsFileURL:()=>Gu.my,IsNavigatorAvailable:()=>Ut.XD,IsWindowObjectExist:()=>Ut.BA,IsWrapper:()=>Nr.E,JoystickAxis:()=>mt,KeepAssets:()=>ie.hA,KeyboardEventTypes:()=>Qe.TB,KeyboardInfo:()=>Qe.W0,KeyboardInfoPre:()=>Qe.Bu,KhronosTextureContainer:()=>ZS.H,KhronosTextureContainer2:()=>_T.Z,LatheBuilder:()=>sg.O,Lattice:()=>X_,LatticeBlock:()=>Cv,LatticePluginMaterial:()=>q_,Layer:()=>Vc.W,LayerSceneComponent:()=>kc.b,LengthBlock:()=>Pf,LensFlare:()=>eh,LensFlareSystem:()=>th,LensFlareSystemSceneComponent:()=>ih,LensFlaresOptimization:()=>sx,LensRenderingPipeline:()=>HC,LerpBlock:()=>mf,Light:()=>oh.v,LightBlock:()=>Ep,LightGizmo:()=>Lo,LightInformationBlock:()=>Md,LineEdgesRenderer:()=>gP,LinesBuilder:()=>_o.dT,LinesMesh:()=>N_.l,LoadFile:()=>Gu.zU,LoadFileError:()=>Gu.hX,LoadImage:()=>Gu.W$,LoadImageConfiguration:()=>Gu.qc,LoadOp:()=>Cn.UU,LoadTextureFromTranscodeResult:()=>YS.aB,LockConstraint:()=>UE,Logger:()=>f.V,LoopBlock:()=>gm,MapMode:()=>Cn.iR,MapRangeBlock:()=>uv,MappingBlock:()=>zv,MappingTypes:()=>Bg,Material:()=>Zl.i,MaterialAnisotropicDefines:()=>bu.v,MaterialClearCoatDefines:()=>Au.a,MaterialDefines:()=>zo.M,MaterialDetailMapDefines:()=>Nm.H,MaterialFlags:()=>Ho.h,MaterialGreasedLineDefines:()=>Xm,MaterialHelper:()=>xu,MaterialHelperGeometryRendering:()=>Wa.m,MaterialIridescenceDefines:()=>Ru.m,MaterialPluginBase:()=>Mm.y,MaterialPluginEvent:()=>Im,MaterialPluginManager:()=>Om.uZ,MaterialSheenDefines:()=>Nu.Z,MaterialSubSurfaceDefines:()=>Du.p,MathBlock:()=>hv,MathBlockOperations:()=>Dg,Matrix:()=>wo.uq,MatrixBuilderBlock:()=>im,MatrixComposeBlock:()=>Wv,MatrixDeterminantBlock:()=>dm,MatrixSplitterBlock:()=>xm,MatrixTransposeBlock:()=>pm,MaxBlock:()=>Ef,MergeGeometryBlock:()=>mv,MergeMeshesOptimization:()=>cx,Mesh:()=>Rt.e,MeshAssetTask:()=>LS,MeshAttributeExistsBlock:()=>fm,MeshAttributeExistsBlockTypes:()=>nm,MeshBlock:()=>Kg,MeshBuilder:()=>D_.P,MeshDebugMode:()=>Jm,MeshDebugPluginMaterial:()=>t_,MeshExploder:()=>$S,MeshLODLevel:()=>J_.L,MeshParticleEmitter:()=>jx,MeshUVSpaceRenderer:()=>y_,MeshoptCompression:()=>v_.v,MinBlock:()=>Cf,MinMaxReducer:()=>mh,MipmapFilterMode:()=>Cn.Wy,MirrorTexture:()=>Go,ModBlock:()=>tm,ModelShape:()=>eE,MorphTarget:()=>WT.M,MorphTargetManager:()=>Uh.j,MorphTargetsBlock:()=>Id,MotionBlurPostProcess:()=>LC,MotorEnabledJoint:()=>zh.bB,MultiMaterial:()=>Lh.F,MultiObserver:()=>QS,MultiPick:()=>Ii.DY,MultiPickWithRay:()=>Ii.TR,MultiPointerScaleBehavior:()=>Me,MultiRenderTarget:()=>td,MultiplyBlock:()=>Yl,NLerpBlock:()=>Bf,NativeDataStream:()=>Yr,NativeEngine:()=>mn,NativePointerInput:()=>Pr.Ze,NativeXRFrame:()=>zR,NativeXRLayerRenderTargetTextureProvider:()=>Ui,NativeXRLayerWrapper:()=>Gi,NativeXRRenderTarget:()=>zi,NegateBlock:()=>yf,Node:()=>yt.b,NodeGeometry:()=>qg,NodeGeometryBlock:()=>zg,NodeGeometryBlockConnectionPointTypes:()=>Ig,NodeGeometryBuildState:()=>Hg,NodeGeometryConnectionPoint:()=>Ug,NodeGeometryConnectionPointCompatibilityStates:()=>Mg,NodeGeometryConnectionPointDirection:()=>Og,NodeGeometryContextualSources:()=>Ng,NodeMaterial:()=>sc,NodeMaterialBlock:()=>Ml,NodeMaterialBlockConnectionPointMode:()=>pd,NodeMaterialBlockConnectionPointTypes:()=>Sl,NodeMaterialBlockTargets:()=>xl,NodeMaterialConnectionPoint:()=>Pl,NodeMaterialConnectionPointCompatibilityStates:()=>Tl,NodeMaterialConnectionPointCustomObject:()=>Td,NodeMaterialConnectionPointDirection:()=>El,NodeMaterialDefines:()=>nc,NodeMaterialModes:()=>Xl,NodeMaterialOptimizer:()=>Pm,NodeMaterialSystemValues:()=>Al,NodeMaterialTeleportInBlock:()=>nf,NodeMaterialTeleportOutBlock:()=>sf,NodeRenderGraph:()=>da,NodeRenderGraphBlackAndWhitePostProcessBlock:()=>Sa,NodeRenderGraphBlock:()=>Bs.E,NodeRenderGraphBlockConnectionPointTypes:()=>Vs.tp,NodeRenderGraphBloomPostProcessBlock:()=>Ra,NodeRenderGraphBlurPostProcessBlock:()=>Ia,NodeRenderGraphBuildState:()=>ua,NodeRenderGraphCircleOfConfusionPostProcessBlock:()=>Na,NodeRenderGraphClearBlock:()=>ha,NodeRenderGraphConnectionPoint:()=>fa.t,NodeRenderGraphConnectionPointCompatibilityStates:()=>Vs.X_,NodeRenderGraphConnectionPointDirection:()=>Vs.Kc,NodeRenderGraphCopyTextureBlock:()=>no,NodeRenderGraphCullObjectsBlock:()=>za,NodeRenderGraphDepthOfFieldPostProcessBlock:()=>ka,NodeRenderGraphElbowBlock:()=>ma,NodeRenderGraphExtractHighlightsPostProcessBlock:()=>Ga,NodeRenderGraphGenerateMipmapsBlock:()=>ao,NodeRenderGraphGeometryRendererBlock:()=>qa,NodeRenderGraphInputBlock:()=>la,NodeRenderGraphObjectRendererBlock:()=>Ka,NodeRenderGraphOutputBlock:()=>Ws,NodeRenderGraphTAAObjectRendererBlock:()=>eo,NodeRenderGraphTeleportInBlock:()=>to,NodeRenderGraphTeleportOutBlock:()=>io,NoiseBlock:()=>fv,NoiseProceduralTexture:()=>sd,NormalBlendBlock:()=>Gf,NormalizeBlock:()=>df,NormalizeVectorBlock:()=>Tv,NullBlock:()=>nv,NullEngine:()=>Fr,NullEngineOptions:()=>Dr,ObjectRenderer:()=>Ha.P,Observable:()=>n.cP,Observer:()=>n.nu,OcclusionMaterial:()=>Cu,Octree:()=>Tr,OctreeBlock:()=>xr,OctreeSceneComponent:()=>Cr,OimoJSPlugin:()=>Xh,OnAfterEnteringVRObservableEvent:()=>$i,OneMinusBlock:()=>Sf,Orientation:()=>wo.t4,OutlineRenderer:()=>DP,PBRAnisotropicConfiguration:()=>bu.i,PBRBaseMaterial:()=>Pu.d,PBRBaseSimpleMaterial:()=>yu,PBRClearCoatConfiguration:()=>Au.t,PBRIridescenceConfiguration:()=>Ru.z,PBRMaterial:()=>Jo.Y,PBRMaterialDefines:()=>Pu.g,PBRMetallicRoughnessBlock:()=>em,PBRMetallicRoughnessMaterial:()=>Iu,PBRSheenConfiguration:()=>Nu.C,PBRSpecularGlossinessMaterial:()=>Mu,PBRSubSurfaceConfiguration:()=>Du.I,PHI:()=>wo.a6,PadNumber:()=>ge.LW,PanoramaToCubeMapTools:()=>ku.D,Parse:()=>Dc.oj,ParseFloat16:()=>Qu.LD,ParseFloat32:()=>Qu.Ff,ParseInt32:()=>Qu.cL,ParseInt64:()=>Qu.tB,ParseNullTerminatedString:()=>Qu.T$,ParseUint16:()=>Qu.Jn,ParseUint32:()=>Qu.PX,ParseUint8:()=>Qu._S,ParseUint8Array:()=>Qu.fz,ParseValue:()=>Qu.zX,Particle:()=>Wx,ParticleBlendMultiplyBlock:()=>Ul,ParticleHelper:()=>QT,ParticleRampGradientBlock:()=>Gl,ParticleSystem:()=>pT,ParticleSystemSet:()=>ZT,ParticleTextureBlock:()=>kl,ParticlesOptimization:()=>ox,PassCubePostProcess:()=>$t.s,PassPostProcess:()=>$t.v,Path2:()=>wo.Cu,Path3D:()=>wo.tO,PathCursor:()=>ee,PerfCollectionStrategy:()=>NT,PerfCounter:()=>Gr.A,PerformanceConfigurator:()=>Mr.I,PerformanceMonitor:()=>JS.r,PerformanceViewerCollector:()=>MT,PerturbNormalBlock:()=>Yd,PhotoDome:()=>Qo,Physics6DoFConstraint:()=>wE,Physics6DoFLimit:()=>LE,PhysicsActivationControl:()=>dE,PhysicsAggregate:()=>HE,PhysicsBody:()=>CE,PhysicsConstraint:()=>FE,PhysicsConstraintAxis:()=>sE,PhysicsConstraintAxisLimitMode:()=>nE,PhysicsConstraintMotorType:()=>lE,PhysicsConstraintType:()=>aE,PhysicsEngine:()=>Hh.A,PhysicsEngineV2:()=>EE.A,PhysicsEventType:()=>cE,PhysicsHelper:()=>eC,PhysicsImpostor:()=>mc.j,PhysicsJoint:()=>zh.W$,PhysicsMaterialCombineMode:()=>pE,PhysicsMotionType:()=>hE,PhysicsPrestepType:()=>uE,PhysicsRadialExplosionEventOptions:()=>sC,PhysicsRadialImpulseFalloff:()=>fE,PhysicsRaycastResult:()=>Wh.G,PhysicsShape:()=>bE,PhysicsShapeBox:()=>RE,PhysicsShapeCapsule:()=>yE,PhysicsShapeContainer:()=>OE,PhysicsShapeConvexHull:()=>IE,PhysicsShapeCylinder:()=>AE,PhysicsShapeGroundMesh:()=>DE,PhysicsShapeHeightField:()=>NE,PhysicsShapeMesh:()=>ME,PhysicsShapeSphere:()=>PE,PhysicsShapeType:()=>oE,PhysicsUpdraftEventOptions:()=>aC,PhysicsUpdraftMode:()=>mE,PhysicsViewer:()=>br.PhysicsViewer,PhysicsVortexEventOptions:()=>oC,Pick:()=>Ii.mc,PickWithBoundingInfo:()=>Ii.uW,PickWithRay:()=>Ii.S,PickingCustomization:()=>Ii.R0,PickingInfo:()=>Ji.G,PipelineErrorReason:()=>Cn.Xk,PivotTools:()=>go.G,Plane:()=>wo.Zc,PlaneBlock:()=>jg,PlaneBuilder:()=>xo.QX,PlaneDragGizmo:()=>Co,PlaneRotationGizmo:()=>To,PlayAnimationAction:()=>S,PlaySoundAction:()=>R,PointColor:()=>gE.q,PointLight:()=>Nh.H,PointParticleEmitter:()=>Zx,PointerDragBehavior:()=>Ie.C,PointerEventTypes:()=>xe.Zp,PointerInfo:()=>xe.mx,PointerInfoBase:()=>xe.Vn,PointerInfoPre:()=>xe.tT,PointerInput:()=>Pr.ST,PointsCloudSystem:()=>gE.y,PointsGroup:()=>_E.x,Polar:()=>l_,Polygon:()=>H_.t,PolygonBuilder:()=>rg.qg,PolygonMeshBuilder:()=>H_.L,PolyhedronBuilder:()=>Po.Ei,PolyhedronData:()=>Y_.HS,PositionGizmo:()=>bo,PositionNormalTextureVertex:()=>wo.k0,PositionNormalVertex:()=>wo.B5,PostProcess:()=>jt.w,PostProcessManager:()=>fh.X,PostProcessRenderEffect:()=>pC,PostProcessRenderPipeline:()=>kC,PostProcessRenderPipelineManager:()=>GC,PostProcessRenderPipelineManagerSceneComponent:()=>UC,PostProcessesOptimization:()=>nx,PosterizeBlock:()=>Df,PowBlock:()=>Af,PowerEase:()=>z,PowerPreference:()=>Cn.TK,PrePassOutputBlock:()=>ip,PrePassRenderer:()=>RP,PrePassRendererSceneComponent:()=>IP,PrePassTextureBlock:()=>rf,PrecisionDate:()=>Te.j,PredicateCondition:()=>d,Predictor:()=>Qu.XE,PrepareAttributesForBakedVertexAnimation:()=>qo.J2,PrepareAttributesForBones:()=>qo.ni,PrepareAttributesForInstances:()=>qo.ER,PrepareAttributesForMorphTargets:()=>qo.IF,PrepareAttributesForMorphTargetsInfluencers:()=>qo.MF,PrepareDefinesForAttributes:()=>qo.qB,PrepareDefinesForBakedVertexAnimation:()=>qo.wu,PrepareDefinesForBones:()=>qo.IC,PrepareDefinesForCamera:()=>qo.Y7,PrepareDefinesForFrameBoundValues:()=>qo.OR,PrepareDefinesForLight:()=>qo.lo,PrepareDefinesForLights:()=>qo.az,PrepareDefinesForMergedUV:()=>qo.YT,PrepareDefinesForMisc:()=>qo.fm,PrepareDefinesForMorphTargets:()=>qo.Jz,PrepareDefinesForMultiview:()=>qo.VO,PrepareDefinesForOIT:()=>qo.Nc,PrepareDefinesForPrePass:()=>qo.N4,PrepareUniformsAndSamplersForLight:()=>qo.GD,PrepareUniformsAndSamplersList:()=>qo.Bb,PressureObserverWrapper:()=>bT,PrimitiveTopology:()=>Cn.P8,PrismaticConstraint:()=>zE,ProceduralTexture:()=>tc,ProceduralTextureSceneComponent:()=>Ql,PropertyTypeForEdition:()=>sa,ProximityCastResult:()=>hC,PushAttributesForInstances:()=>qo.te,PushMaterial:()=>Wo.E,QuadraticEase:()=>W,QuadraticErrorSimplification:()=>G_,QuarticEase:()=>H,Quaternion:()=>wo.PT,QueryType:()=>Cn.bO,QueueNewFrame:()=>ne.r,QuinticEase:()=>Y,RGBDTextureTools:()=>Lx.G,RSMCreatePluginMaterial:()=>_y,Ragdoll:()=>XE,RagdollBoneProperties:()=>YE,RandomBlock:()=>pv,RandomBlockLocks:()=>Lg,RandomGUID:()=>ym.z,RandomNumberBlock:()=>Rf,RawCubeTexture:()=>ad.p,RawTexture:()=>me.I,RawTexture2DArray:()=>od.L,RawTexture3D:()=>ld,Ray:()=>Ii.Rl,RayHelper:()=>br.RayHelper,ReadFile:()=>Gu.NJ,ReadFileError:()=>Gu.VB,RecastJSCrowd:()=>YT,RecastJSPlugin:()=>HT,ReciprocalBlock:()=>Of,ReflectBlock:()=>zf,ReflectionBlock:()=>$f,ReflectionProbe:()=>$h,ReflectionTextureBaseBlock:()=>Pp,ReflectionTextureBlock:()=>yp,ReflectiveShadowMap:()=>fy,Reflector:()=>CT,RefractBlock:()=>Wf,RefractionBlock:()=>Zf,RefractionPostProcess:()=>wC,RefractionTexture:()=>cd,RegisterClass:()=>o.Y5,RegisterMaterialPlugin:()=>Om.YC,RegisterNativeTypeAsync:()=>un,RegisterTargetForLateAnimationBinding:()=>N.BT,RemapBlock:()=>Wl,RenderPassTimestampLocation:()=>Cn.xf,RenderTargetTexture:()=>Si.$,RenderTargetWrapper:()=>Or.v,RenderTargetsOptimization:()=>lx,RenderingGroup:()=>LP.U,RenderingGroupInfo:()=>ch.o,RenderingManager:()=>ch.m,ReplaceColorBlock:()=>Nf,RequestFile:()=>Gu.sh,RequestFileError:()=>Gu.Mi,RequestFullscreen:()=>Ln.tl,RequestPointerlock:()=>Ln.eG,ResizeImageBitmap:()=>Ln.jf,RetryStrategy:()=>Gx.a,ReverseLutFromBitmap:()=>ju.FG,RibbonBuilder:()=>tg.Er,RichType:()=>zn.D,RichTypeAny:()=>zn.Vv,RichTypeBoolean:()=>zn.RI,RichTypeColor3:()=>zn.Nf,RichTypeColor4:()=>zn.Gx,RichTypeFlowGraphInteger:()=>zn.x2,RichTypeMatrix:()=>zn.Sp,RichTypeNumber:()=>zn.Es,RichTypeQuaternion:()=>zn.P_,RichTypeString:()=>zn.KV,RichTypeVector2:()=>zn.K$,RichTypeVector3:()=>zn.Dx,RichTypeVector4:()=>zn.Ko,RollingAverage:()=>JS.K,Rotate2dBlock:()=>Uf,RotationGizmo:()=>Eo,RotationXBlock:()=>yv,RotationYBlock:()=>Av,RotationZBlock:()=>Rv,RuntimeAnimation:()=>j.x,RuntimeError:()=>en.bu,SSAO2RenderingPipeline:()=>XC,SSAORenderingPipeline:()=>$C,SSRRenderingPipeline:()=>tb,SamplerBindingType:()=>Cn.G8,Scalar:()=>a_.X,ScaleBlock:()=>of,ScaleGizmo:()=>yo,ScalingBlock:()=>Iv,ScanData:()=>Ju.u,Scene:()=>kt.Z,SceneComponentConstants:()=>Gt.v,SceneDepthBlock:()=>Ap,SceneInstrumentation:()=>Mc,SceneLoader:()=>ol.cn,SceneLoaderAnimationGroupLoadingMode:()=>ol.gD,SceneLoaderFlags:()=>pu.B,SceneOptimization:()=>ex,SceneOptimizer:()=>ux,SceneOptimizerOptions:()=>hx,ScenePerformancePriority:()=>kt.F,SceneRecorder:()=>fT,SceneSerializer:()=>mx,ScreenSizeBlock:()=>Kd,ScreenSpaceBlock:()=>Zd,ScreenSpaceCurvaturePostProcess:()=>mb,ScreenSpaceReflectionPostProcess:()=>KC,ScreenshotTools:()=>Dx,SerializationHelper:()=>pe.p,SetBasisTranscoderWorker:()=>YS.af,SetColorsBlock:()=>lv,SetCorsBehavior:()=>Gu.M1,SetMaterialIDBlock:()=>Ev,SetNormalsBlock:()=>av,SetParentAction:()=>b,SetPositionsBlock:()=>sv,SetStateAction:()=>_,SetTangentsBlock:()=>cv,SetToDefaultGaussianSplatting:()=>yd,SetUVsBlock:()=>ov,SetValueAction:()=>g,ShaderCodeInliner:()=>qr.Y,ShaderLanguage:()=>Ou,ShaderMaterial:()=>ir.B,ShaderStage:()=>Cn.qd,ShaderStore:()=>ri.l,ShadowDepthWrapper:()=>Rm,ShadowGenerator:()=>hh,ShadowGeneratorSceneComponent:()=>Ch,ShadowLight:()=>lh.p,ShadowMapBlock:()=>tp,ShadowsOptimization:()=>rx,ShapeBuilder:()=>ng.Vc,ShapeCastResult:()=>uC,SharpenPostProcess:()=>VC,SheenBlock:()=>Yf,SimplexPerlin3DBlock:()=>kf,SimplicationQueueSceneComponent:()=>U_,SimplificationQueue:()=>L_,SimplificationSettings:()=>F_,SimplificationType:()=>M_,SineEase:()=>X,SixDofDragBehavior:()=>Oe.Y,Size:()=>wo.or,Skeleton:()=>ve.E,SkeletonViewer:()=>br.SkeletonViewer,SliderConstraint:()=>GE,SmartArray:()=>Sr.L,SmartArrayNoDuplicate:()=>Sr.b,SmoothStepBlock:()=>Mf,SnapshotRenderingHelper:()=>FT,SolidParticle:()=>JT,SolidParticleSystem:()=>rE,SolidParticleVertex:()=>iE,Sound:()=>le.A,SoundTrack:()=>ce.j,SourceTextureFormat:()=>fd.Ok,Space:()=>wo.$x,SphereBlock:()=>Qg,SphereBuilder:()=>Mo.z2,SphereDirectedParticleEmitter:()=>eT,SphereParticleEmitter:()=>Jx,Spherical:()=>c_,SphericalHarmonics:()=>h_.O,SphericalPolynomial:()=>h_.Q,SplatReaderBlock:()=>Pd,SpotLight:()=>Fo.n,SpringConstraint:()=>WE,Sprite:()=>Kh,SpriteManager:()=>eu,SpriteMap:()=>GA,SpriteMapFrameRotationDirection:()=>kA,SpritePackedManager:()=>UA,SpriteSceneComponent:()=>Qh,Stage:()=>Gt.B,StandardMaterial:()=>Oi.F,StandardMaterialDefines:()=>Oi.f,StandardRenderingPipeline:()=>ZC,StartsWith:()=>ge.UH,StateCondition:()=>p,StencilOperation:()=>Cn.eA,StencilState:()=>KA.K,StencilStateComposer:()=>ZA.u,StepBlock:()=>vf,StereoscopicArcRotateCamera:()=>oi,StereoscopicFreeCamera:()=>li,StereoscopicGamepadCamera:()=>ci,StereoscopicInterlacePostProcess:()=>si,StereoscopicInterlacePostProcessI:()=>ni,StereoscopicScreenUniversalCamera:()=>di,StereoscopicUniversalCamera:()=>hi,StickValues:()=>$e,StopAnimationAction:()=>x,StopSoundAction:()=>I,StorageBuffer:()=>He.K,StorageReadBlock:()=>vm,StorageTextureAccess:()=>Cn.ne,StorageWriteBlock:()=>Sm,StoreOp:()=>Cn.$r,StringDictionary:()=>xt.w,StringTools:()=>ge.nQ,SubEmitter:()=>$x,SubEmitterType:()=>Yx,SubMesh:()=>lc.K,SubSurfaceBlock:()=>Qf,SubSurfaceSceneComponent:()=>NP,SubtractBlock:()=>gf,SurfaceMagnetismBehavior:()=>Ne.B,SwitchBooleanAction:()=>m,SwitchInput:()=>Pr.dR,TAARenderingPipeline:()=>ib,TBNBlock:()=>Hd,TGATools:()=>Tx.uT,Tags:()=>_x.Y,TargetCamera:()=>bt.F,TargetedAnimation:()=>Z.TargetedAnimation,TeleportInBlock:()=>Hv,TeleportOutBlock:()=>Yv,TestBase64DataUrl:()=>Gu.ZP,TextFileAssetTask:()=>BS,Texture:()=>_e.g,TextureAspect:()=>Cn.y2,TextureAssetTask:()=>GS,TextureBlock:()=>bp,TextureDimension:()=>Cn.gZ,TextureFormat:()=>Cn.nC,TextureOptimization:()=>tx,TexturePacker:()=>rd,TexturePackerFrame:()=>id,TextureSampleType:()=>Cn.Kz,TextureSampler:()=>hd.u,TextureTools:()=>kh.LO,TextureUsage:()=>Cn.tT,TextureViewDimension:()=>Cn.dL,ThinBlackAndWhitePostProcess:()=>_a,ThinBloomEffect:()=>ba,ThinBlurPostProcess:()=>Ea,ThinCircleOfConfusionPostProcess:()=>Ma,ThinDepthOfFieldEffect:()=>Ba,ThinDepthOfFieldEffectBlurLevel:()=>pa,ThinEngine:()=>Ir.ThinEngine,ThinExtractHighlightsPostProcess:()=>Ca,ThinRenderTargetTexture:()=>dd,ThinTexture:()=>ud.D,TiledBoxBuilder:()=>eg.Xk,TiledPlaneBuilder:()=>ag.wA,TimerState:()=>Tc.R$,TmpColors:()=>wo.IG,TmpVectors:()=>wo.AA,ToGammaSpace:()=>wo.rv,ToHalfFloat:()=>kh.LZ,ToLinearSpace:()=>wo.tk,TonemapPostProcess:()=>pb,TonemappingOperator:()=>rb,Tools:()=>re.S0,TorusBlock:()=>ev,TorusBuilder:()=>Yi.vt,TorusKnotBuilder:()=>ig.VR,TouchCamera:()=>At,TrailMesh:()=>I_,Trajectory:()=>gT,TrajectoryClassifier:()=>TT,TranscodeAsync:()=>YS.yk,TranscodeTarget:()=>fd.Xl,TransformBlock:()=>Ol,TransformFeedbackBoundingHelper:()=>_r.TransformFeedbackBoundingHelper,TransformNode:()=>ui.V,TranslationBlock:()=>Ov,TriPlanarBlock:()=>hm,TrigonometryBlock:()=>ic,TrigonometryBlockOperations:()=>Jl,TubeBuilder:()=>og.a,TwirlBlock:()=>Qd,UncompressPIZ:()=>$u.tg,UncompressPXR:()=>$u._k,UncompressRAW:()=>$u.S4,UncompressRLE:()=>$u.r,UncompressZIP:()=>$u.VE,UniformBuffer:()=>vi.D,UniversalCamera:()=>Xt,UnregisterAllMaterialPlugins:()=>Om.tC,UnregisterMaterialPlugin:()=>Om.lM,UploadContent:()=>Tx.FA,UploadEnvLevelsAsync:()=>Xr.o5,UploadEnvSpherical:()=>Xr.ow,UploadLevelsAsync:()=>Xr.bv,UtilityLayerRenderer:()=>po.j,VRCameraMetrics:()=>fi,VRDeviceOrientationArcRotateCamera:()=>yi,VRDeviceOrientationFreeCamera:()=>Ai,VRDeviceOrientationGamepadCamera:()=>Ri,VRDistortionCorrectionPostProcess:()=>mi,VRExperienceHelper:()=>ji,VRMultiviewToSingleviewPostProcess:()=>bi,ValidatedNativeDataStream:()=>_n,ValueCondition:()=>u,Vector2:()=>wo.I9,Vector2ToFixed:()=>u_,Vector3:()=>wo.Pq,Vector3ToFixed:()=>d_,Vector4:()=>wo.IU,Vector4ToFixed:()=>p_,VectorConverterBlock:()=>xv,VectorMergerBlock:()=>zl,VectorSplitterBlock:()=>ff,VertexAnimationBaker:()=>Se,VertexBuffer:()=>Ue.R,VertexData:()=>S_.P,VertexDataMaterialInfo:()=>S_.o,VertexFormat:()=>Cn.ym,VertexOutputBlock:()=>Nl,VertexStepMode:()=>Cn.ab,VideoDome:()=>Rc,VideoRecorder:()=>Ex,VideoTexture:()=>Ac,ViewDirectionBlock:()=>xf,Viewport:()=>wo.LM,VirtualJoystick:()=>Tt,VirtualJoysticksCamera:()=>pi,VolumetricLightScatteringPostProcess:()=>fb,VoronoiNoiseBlock:()=>lm,Wav2Decode:()=>ju.tb,WaveBlock:()=>Ff,WaveBlockKind:()=>Ip,WebGL2ParticleSystem:()=>$T,WebGL2ShaderProcessor:()=>Dn.B,WebGLDataBuffer:()=>xg.A,WebGLHardwareTexture:()=>Fi.d,WebGLPipelineContext:()=>En.x,WebGPUCacheBindGroups:()=>yn.k,WebGPUCacheRenderPipeline:()=>bn.D,WebGPUCacheRenderPipelineTree:()=>Pn.V,WebGPUCacheSampler:()=>An.R,WebGPUDataBuffer:()=>Tg.p,WebGPUDrawContext:()=>Rn.O,WebGPUEngine:()=>gn.$,WebGPUPipelineContext:()=>In.s,WebGPURenderTargetWrapper:()=>Mn.H,WebGPUShaderProcessor:()=>On.q,WebGPUTintWASM:()=>Nn.g,WebRequest:()=>aa.u,WebXRAbstractFeature:()=>gl,WebXRAbstractMotionController:()=>ll,WebXRAnchorSystem:()=>eR,WebXRBackgroundRemover:()=>rR,WebXRCamera:()=>rl,WebXRControllerComponent:()=>al,WebXRControllerMovement:()=>pR,WebXRControllerPhysics:()=>sR,WebXRControllerPointerSelection:()=>vl,WebXRDefaultExperience:()=>bc,WebXRDefaultExperienceOptions:()=>Cc,WebXRDepthSensing:()=>IR,WebXRDomOverlay:()=>dR,WebXREnterExitUI:()=>dc,WebXREnterExitUIButton:()=>hc,WebXREnterExitUIOptions:()=>uc,WebXRExperienceHelper:()=>sl,WebXREyeTracking:()=>_R,WebXRFeatureName:()=>nl._,WebXRFeaturePointSystem:()=>oR,WebXRFeaturesManager:()=>nl.n,WebXRGenericHandController:()=>FR,WebXRGenericTriggerMotionController:()=>cl,WebXRHTCViveMotionController:()=>GR,WebXRHand:()=>Sc,WebXRHandJoint:()=>fc,WebXRHandTracking:()=>xc,WebXRHitTest:()=>aR,WebXRHitTestLegacy:()=>QA,WebXRImageTracking:()=>uR,WebXRInput:()=>_l,WebXRInputSource:()=>ml,WebXRLayerRenderTargetTextureProvider:()=>Li,WebXRLayers:()=>RR,WebXRLightEstimation:()=>mR,WebXRManagedOutputCanvas:()=>ki,WebXRManagedOutputCanvasOptions:()=>Vi,WebXRMeshDetector:()=>cR,WebXRMicrosoftMixedRealityController:()=>wR,WebXRMotionControllerManager:()=>pl,WebXRMotionControllerTeleportation:()=>Ec,WebXRNearControllerMode:()=>oc,WebXRNearInteraction:()=>cc,WebXROculusTouchMotionController:()=>VR,WebXRPlaneDetector:()=>iR,WebXRProfiledMotionController:()=>ul,WebXRRawCameraAccess:()=>DR,WebXRSessionManager:()=>Wi,WebXRSpaceWarp:()=>NR,WebXRSpaceWarpRenderTargetTextureProvider:()=>OR,WebXRState:()=>zA,WebXRTrackingState:()=>WA,WebXRWalkingLocomotion:()=>TR,WeightedSound:()=>he.r,WorkerPool:()=>Cx.T,WorleyNoise3DBlock:()=>Vf,XRSpaceWarpRenderTarget:()=>MR,Xbox360Button:()=>Dt,Xbox360Dpad:()=>Ft,Xbox360Pad:()=>zt,XboxInput:()=>Pr.sZ,_BabylonLoaderRegistered:()=>tu,_BasisTextureLoader:()=>Xu._BasisTextureLoader,_CommonDispose:()=>Ln.kX,_CommonInit:()=>Ln.BG,_CreationDataStorage:()=>Rt.Ez,_DDSTextureLoader:()=>el._DDSTextureLoader,_ENVTextureLoader:()=>tl._ENVTextureLoader,_ExrTextureLoader:()=>qu._ExrTextureLoader,_GetCompatibleTextureLoader:()=>ln.gT,_HDRTextureLoader:()=>Yu._HDRTextureLoader,_InstancesBatch:()=>Rt._h,_KTXTextureLoader:()=>il._KTXTextureLoader,_MeshCollisionData:()=>tr.j,_OcclusionDataStorage:()=>Lr.W,_PrimaryIsoTriangle:()=>Y_.nZ,_TGATextureLoader:()=>Hu._TGATextureLoader,_TimeToken:()=>kr,_UpdateRGBDAsync:()=>Xr.gW,_forceSceneHelpersToBundle:()=>Pc,_forceTransformFeedbackToBundle:()=>Ur,_injectLTSFileTools:()=>Gu.rh,_staticOffsetValueColor3:()=>M.eA,_staticOffsetValueColor4:()=>M.nl,_staticOffsetValueQuaternion:()=>M.s$,_staticOffsetValueSize:()=>M.vF,_staticOffsetValueVector2:()=>M.rq,_staticOffsetValueVector3:()=>M.y4,addClipPlaneUniforms:()=>Xo.TV,allocateAndCopyTypedBuffer:()=>Wr.k,anaglyphPixelShader:()=>$b.anaglyphPixelShader,anaglyphPixelShaderWGSL:()=>jb.anaglyphPixelShaderWGSL,appendSceneAsync:()=>ol.VU,backbufferColorTextureHandle:()=>ks,backbufferDepthStencilTextureHandle:()=>Gs,backgroundPixelShader:()=>gu.backgroundPixelShader,backgroundPixelShaderWGSL:()=>mu.backgroundPixelShaderWGSL,backgroundVertexShader:()=>_u.backgroundVertexShader,backgroundVertexShaderWGSL:()=>fu.backgroundVertexShaderWGSL,bilateralBlurPixelShader:()=>Ty.bilateralBlurPixelShader,bilateralBlurPixelShaderWGSL:()=>Py.bilateralBlurPixelShaderWGSL,bilateralBlurQualityPixelShader:()=>Ey.bilateralBlurQualityPixelShader,bilateralBlurQualityPixelShaderWGSL:()=>yy.bilateralBlurQualityPixelShaderWGSL,bindClipPlane:()=>Xo.gS,blackAndWhitePixelShader:()=>Xb.blackAndWhitePixelShader,blackAndWhitePixelShaderWGSL:()=>qb.blackAndWhitePixelShaderWGSL,bloomMergePixelShader:()=>Vb.bloomMergePixelShader,bloomMergePixelShaderWGSL:()=>kb.bloomMergePixelShaderWGSL,bonesDeclaration:()=>Dd.bonesDeclaration,bonesDeclarationWGSL:()=>Od.bonesDeclarationWGSL,bonesVertex:()=>Fd.bonesVertex,bonesVertexWGSL:()=>Nd.bonesVertexWGSL,boundingBoxRendererPixelShader:()=>Dy.boundingBoxRendererPixelShader,boundingBoxRendererPixelShaderWGSL:()=>Ly.boundingBoxRendererPixelShaderWGSL,boundingBoxRendererVertexShader:()=>Fy.boundingBoxRendererVertexShader,boundingBoxRendererVertexShaderWGSL:()=>wy.boundingBoxRendererVertexShaderWGSL,bumpFragment:()=>dp.bumpFragment,bumpFragmentFunctions:()=>fp.bumpFragmentFunctions,bumpFragmentFunctionsWGSL:()=>up.bumpFragmentFunctionsWGSL,bumpFragmentMainFunctions:()=>pp.bumpFragmentMainFunctions,bumpFragmentMainFunctionsWGSL:()=>hp.bumpFragmentMainFunctionsWGSL,bumpFragmentWGSL:()=>cp.bumpFragmentWGSL,captureEquirectangularFromScene:()=>LT,chromaticAberrationPixelShader:()=>WC.chromaticAberrationPixelShader,chromaticAberrationPixelShaderWGSL:()=>Db.chromaticAberrationPixelShaderWGSL,circleOfConfusionPixelShader:()=>wb.circleOfConfusionPixelShader,circleOfConfusionPixelShaderWGSL:()=>Bb.circleOfConfusionPixelShaderWGSL,className:()=>re.s7,clipPlaneFragment:()=>Fp.clipPlaneFragment,clipPlaneFragmentDeclaration:()=>Lp.clipPlaneFragmentDeclaration,clipPlaneFragmentDeclarationWGSL:()=>Op.clipPlaneFragmentDeclarationWGSL,clipPlaneFragmentWGSL:()=>Mp.clipPlaneFragmentWGSL,clipPlaneVertex:()=>wp.clipPlaneVertex,clipPlaneVertexDeclaration:()=>Bp.clipPlaneVertexDeclaration,clipPlaneVertexDeclarationWGSL:()=>Dp.clipPlaneVertexDeclarationWGSL,clipPlaneVertexWGSL:()=>Np.clipPlaneVertexWGSL,colorCorrectionPixelShader:()=>Qb.colorCorrectionPixelShader,colorCorrectionPixelShaderWGSL:()=>Jb.colorCorrectionPixelShaderWGSL,colorPixelShader:()=>Tu.colorPixelShader,colorPixelShaderWGSL:()=>gS.colorPixelShaderWGSL,colorVertexShader:()=>Eu.colorVertexShader,colorVertexShaderWGSL:()=>vS.colorVertexShaderWGSL,computeMaxExtents:()=>W_,convolutionPixelShader:()=>Kb.convolutionPixelShader,convolutionPixelShaderWGSL:()=>Zb.convolutionPixelShaderWGSL,copyTexture3DLayerToTexturePixelShader:()=>Yy.copyTexture3DLayerToTexturePixelShader,copyTexture3DLayerToTexturePixelShaderWGSL:()=>Xy.copyTexture3DLayerToTexturePixelShaderWGSL,copyTextureToTexturePixelShader:()=>UT.copyTextureToTexturePixelShader,copyTextureToTexturePixelShaderWGSL:()=>zT.copyTextureToTexturePixelShaderWGSL,createDetailMapPlugin:()=>zm,createPBRAnisotropicPlugin:()=>wm,createPBRBRDFPlugin:()=>Bm,createPBRClearCoatPlugin:()=>Vm,createPBRIridescencePlugin:()=>km,createPBRSheenPlugin:()=>Gm,createPBRSubSurfacePlugin:()=>Um,createYieldingScheduler:()=>DT.VP,defaultPixelShader:()=>i_.defaultPixelShader,defaultPixelShaderWGSL:()=>n_.defaultPixelShaderWGSL,defaultVertexShader:()=>r_.defaultVertexShader,defaultVertexShaderWGSL:()=>s_.defaultVertexShaderWGSL,depthBoxBlurPixelShader:()=>Mh.depthBoxBlurPixelShader,depthBoxBlurPixelShaderWGSL:()=>yh.depthBoxBlurPixelShaderWGSL,depthOfFieldMergePixelShader:()=>Fb.depthOfFieldMergePixelShader,depthOfFieldMergePixelShaderWGSL:()=>Lb.depthOfFieldMergePixelShaderWGSL,depthPixelShader:()=>uh.depthPixelShader,depthPixelShaderWGSL:()=>Iy.depthPixelShaderWGSL,depthVertexShader:()=>dh.depthVertexShader,depthVertexShaderWGSL:()=>My.depthVertexShaderWGSL,displayPassPixelShader:()=>aP.displayPassPixelShader,displayPassPixelShaderWGSL:()=>oP.displayPassPixelShaderWGSL,editableInPropertyPage:()=>oa,expandToProperty:()=>de.$z,extractHighlightsPixelShader:()=>Gb.extractHighlightsPixelShader,extractHighlightsPixelShaderWGSL:()=>Ub.extractHighlightsPixelShaderWGSL,extractMinAndMax:()=>o_.b8,extractMinAndMaxIndexed:()=>o_.cD,filterPixelShader:()=>iP.filterPixelShader,filterPixelShaderWGSL:()=>rP.filterPixelShaderWGSL,fluidRenderingBilateralBlurPixelShader:()=>ey.fluidRenderingBilateralBlurPixelShader,fluidRenderingBilateralBlurPixelShaderWGSL:()=>uy.fluidRenderingBilateralBlurPixelShaderWGSL,fluidRenderingParticleDepthPixelShader:()=>qP.fluidRenderingParticleDepthPixelShader,fluidRenderingParticleDepthPixelShaderWGSL:()=>ny.fluidRenderingParticleDepthPixelShaderWGSL,fluidRenderingParticleDepthVertexShader:()=>XP.fluidRenderingParticleDepthVertexShader,fluidRenderingParticleDepthVertexShaderWGSL:()=>ry.fluidRenderingParticleDepthVertexShaderWGSL,fluidRenderingParticleDiffusePixelShader:()=>JP.fluidRenderingParticleDiffusePixelShader,fluidRenderingParticleDiffusePixelShaderWGSL:()=>hy.fluidRenderingParticleDiffusePixelShaderWGSL,fluidRenderingParticleDiffuseVertexShader:()=>QP,fluidRenderingParticleDiffuseVertexShaderWGSL:()=>cy,fluidRenderingParticleThicknessPixelShader:()=>jP.fluidRenderingParticleThicknessPixelShader,fluidRenderingParticleThicknessPixelShaderWGSL:()=>ay.fluidRenderingParticleThicknessPixelShaderWGSL,fluidRenderingParticleThicknessVertexShader:()=>$P.fluidRenderingParticleThicknessVertexShader,fluidRenderingParticleThicknessVertexShaderWGSL:()=>sy.fluidRenderingParticleThicknessVertexShaderWGSL,fluidRenderingRenderPixelShader:()=>iy.fluidRenderingRenderPixelShader,fluidRenderingRenderPixelShaderWGSL:()=>py.fluidRenderingRenderPixelShaderWGSL,fluidRenderingStandardBlurPixelShader:()=>ty.fluidRenderingStandardBlurPixelShader,fluidRenderingStandardBlurPixelShaderWGSL:()=>dy.fluidRenderingStandardBlurPixelShaderWGSL,fogFragmentDeclaration:()=>kp.fogFragmentDeclaration,fogFragmentDeclarationWGSL:()=>Vp.fogFragmentDeclarationWGSL,fxaaPixelShader:()=>zb.fxaaPixelShader,fxaaPixelShaderWGSL:()=>Hb.fxaaPixelShaderWGSL,fxaaVertexShader:()=>Wb.fxaaVertexShader,fxaaVertexShaderWGSL:()=>Yb.fxaaVertexShaderWGSL,gaussianSplattingVertexDeclaration:()=>bm.Q,gaussianSplattingVertexDeclarationWGSL:()=>Cm,geometryPixelShader:()=>IC.geometryPixelShader,geometryPixelShaderWGSL:()=>Oy.geometryPixelShaderWGSL,geometryVertexShader:()=>MC.geometryVertexShader,geometryVertexShaderWGSL:()=>Ny.geometryVertexShaderWGSL,getDimensionsFromTextureSize:()=>ta,getRichTypeFromValue:()=>zn.k4,glowBlurPostProcessPixelShader:()=>Xc.glowBlurPostProcessPixelShader,glowBlurPostProcessPixelShaderWGSL:()=>jc.glowBlurPostProcessPixelShaderWGSL,glowMapGenerationPixelShader:()=>Gc.glowMapGenerationPixelShader,glowMapGenerationPixelShaderWGSL:()=>zc.glowMapGenerationPixelShaderWGSL,glowMapGenerationVertexShader:()=>Uc.glowMapGenerationVertexShader,glowMapGenerationVertexShaderWGSL:()=>Wc.glowMapGenerationVertexShaderWGSL,glowMapMergePixelShader:()=>Hc.glowMapMergePixelShader,glowMapMergePixelShaderWGSL:()=>qc.glowMapMergePixelShaderWGSL,glowMapMergeVertexShader:()=>Yc.glowMapMergeVertexShader,glowMapMergeVertexShaderWGSL:()=>$c.glowMapMergeVertexShaderWGSL,grainPixelShader:()=>Ob.grainPixelShader,grainPixelShaderWGSL:()=>Nb.grainPixelShaderWGSL,hdrFilteringPixelShader:()=>vd.hdrFilteringPixelShader,hdrFilteringPixelShaderWGSL:()=>xd.hdrFilteringPixelShaderWGSL,hdrFilteringVertexShader:()=>gd.hdrFilteringVertexShader,hdrFilteringVertexShaderWGSL:()=>Sd.hdrFilteringVertexShaderWGSL,helperFunctions:()=>ap.helperFunctions,helperFunctionsWGSL:()=>rp.helperFunctionsWGSL,highlightsPixelShader:()=>nP.highlightsPixelShader,highlightsPixelShaderWGSL:()=>sP.highlightsPixelShaderWGSL,iblCdfxPixelShader:()=>fA.iblCdfxPixelShader,iblCdfxPixelShaderWGSL:()=>pA.iblCdfxPixelShaderWGSL,iblCdfyPixelShader:()=>_A.iblCdfyPixelShader,iblCdfyPixelShaderWGSL:()=>mA.iblCdfyPixelShaderWGSL,iblCombineVoxelGridsPixelShader:()=>lA.iblCombineVoxelGridsPixelShader,iblCombineVoxelGridsPixelShaderWGSL:()=>oA.iblCombineVoxelGridsPixelShaderWGSL,iblGenerateVoxelMipPixelShader:()=>cA.iblGenerateVoxelMipPixelShader,iblGenerateVoxelMipPixelShaderWGSL:()=>hA.iblGenerateVoxelMipPixelShaderWGSL,iblIcdfxPixelShader:()=>vA.iblIcdfxPixelShader,iblIcdfxPixelShaderWGSL:()=>gA.iblIcdfxPixelShaderWGSL,iblIcdfyPixelShader:()=>xA.iblIcdfyPixelShader,iblIcdfyPixelShaderWGSL:()=>SA.iblIcdfyPixelShaderWGSL,iblShadowAccumulationPixelShader:()=>eA.iblShadowAccumulationPixelShader,iblShadowAccumulationPixelShaderWGSL:()=>Jy.iblShadowAccumulationPixelShaderWGSL,iblShadowDebugPixelShader:()=>jy.iblShadowDebugPixelShader,iblShadowDebugPixelShaderWGSL:()=>Ky.iblShadowDebugPixelShaderWGSL,iblShadowGBufferDebugPixelShader:()=>uA.iblShadowGBufferDebugPixelShader,iblShadowGBufferDebugPixelShaderWGSL:()=>dA.iblShadowGBufferDebugPixelShaderWGSL,iblShadowSpatialBlurPixelShader:()=>Qy.iblShadowSpatialBlurPixelShader,iblShadowSpatialBlurPixelShaderWGSL:()=>Zy.iblShadowSpatialBlurPixelShaderWGSL,iblShadowVoxelTracingPixelShader:()=>qy.iblShadowVoxelTracingPixelShader,iblShadowVoxelTracingPixelShaderWGSL:()=>$y.iblShadowVoxelTracingPixelShaderWGSL,iblShadowsCombinePixelShader:()=>rA,iblShadowsCombinePixelShaderWGSL:()=>aA,iblVoxelGrid2dArrayDebugPixelShader:()=>CA.iblVoxelGrid2dArrayDebugPixelShader,iblVoxelGrid2dArrayDebugPixelShaderWGSL:()=>bA.iblVoxelGrid2dArrayDebugPixelShaderWGSL,iblVoxelGrid3dDebugPixelShader:()=>IA.iblVoxelGrid3dDebugPixelShader,iblVoxelGrid3dDebugPixelShaderWGSL:()=>MA.iblVoxelGrid3dDebugPixelShaderWGSL,iblVoxelGridPixelShader:()=>PA.iblVoxelGridPixelShader,iblVoxelGridPixelShaderWGSL:()=>AA.iblVoxelGridPixelShaderWGSL,iblVoxelGridVertexShader:()=>yA.iblVoxelGridVertexShader,iblVoxelGridVertexShaderWGSL:()=>RA.iblVoxelGridVertexShaderWGSL,iblVoxelSlabDebugPixelShader:()=>NA.iblVoxelSlabDebugPixelShader,iblVoxelSlabDebugPixelShaderWGSL:()=>FA.iblVoxelSlabDebugPixelShaderWGSL,iblVoxelSlabDebugVertexShader:()=>OA.iblVoxelSlabDebugVertexShader,iblVoxelSlabDebugVertexShaderWGSL:()=>DA.iblVoxelSlabDebugVertexShaderWGSL,imageProcessingDeclaration:()=>op.imageProcessingDeclaration,imageProcessingDeclarationWGSL:()=>np.imageProcessingDeclarationWGSL,imageProcessingFunctions:()=>lp.imageProcessingFunctions,imageProcessingFunctionsWGSL:()=>sp.imageProcessingFunctionsWGSL,imageProcessingPixelShader:()=>Ib.imageProcessingPixelShader,imageProcessingPixelShaderWGSL:()=>Rb.imageProcessingPixelShaderWGSL,importAnimationsAsync:()=>ol.fV,importanceSamplingDebugPixelShader:()=>EA.importanceSamplingDebugPixelShader,importanceSamplingDebugPixelShaderWGSL:()=>TA.importanceSamplingDebugPixelShaderWGSL,inlineScheduler:()=>DT.FE,kernelBlurPixelShader:()=>vb.kernelBlurPixelShader,kernelBlurPixelShaderWGSL:()=>xb.kernelBlurPixelShaderWGSL,kernelBlurVertexShader:()=>Sb.kernelBlurVertexShader,kernelBlurVertexShaderWGSL:()=>Tb.kernelBlurVertexShaderWGSL,layerPixelShader:()=>Kc.layerPixelShader,layerPixelShaderWGSL:()=>Qc.layerPixelShaderWGSL,layerVertexShader:()=>Zc.layerVertexShader,layerVertexShaderWGSL:()=>Jc.layerVertexShaderWGSL,lensFlarePixelShader:()=>rh.lensFlarePixelShader,lensFlarePixelShaderWGSL:()=>sh.lensFlarePixelShaderWGSL,lensFlareVertexShader:()=>nh.lensFlareVertexShader,lensFlareVertexShaderWGSL:()=>ah.lensFlareVertexShaderWGSL,lightFragment:()=>qp.lightFragment,lightFragmentDeclaration:()=>Xp.lightFragmentDeclaration,lightFragmentWGSL:()=>Gp.lightFragmentWGSL,lightUboDeclaration:()=>$p.lightUboDeclaration,lightUboDeclarationWGSL:()=>Up.lightUboDeclarationWGSL,lightVxFragmentDeclaration:()=>Kp.lightVxFragmentDeclaration,lightVxUboDeclaration:()=>jp.lightVxUboDeclaration,lightVxUboDeclarationWGSL:()=>zp.lightVxUboDeclarationWGSL,lightsFragmentFunctions:()=>Zp.lightsFragmentFunctions,lightsFragmentFunctionsWGSL:()=>Wp.lightsFragmentFunctionsWGSL,linePixelShader:()=>By.linePixelShader,linePixelShaderWGSL:()=>ky.linePixelShaderWGSL,lineVertexShader:()=>Vy.lineVertexShader,lineVertexShaderWGSL:()=>Gy.lineVertexShaderWGSL,loadAssetContainerAsync:()=>ol.kS,loadSceneAsync:()=>ol.VA,lodCubePixelShader:()=>gx.lodCubePixelShader,lodCubePixelShaderWGSL:()=>Sx.lodCubePixelShaderWGSL,lodPixelShader:()=>vx.lodPixelShader,lodPixelShaderWGSL:()=>xx.lodPixelShaderWGSL,makeAsyncFunction:()=>DT.xu,makeSyncFunction:()=>DT.Aj,meshUVSpaceRendererFinaliserPixelShader:()=>CS.meshUVSpaceRendererFinaliserPixelShader,meshUVSpaceRendererFinaliserPixelShaderWGSL:()=>IS.meshUVSpaceRendererFinaliserPixelShaderWGSL,meshUVSpaceRendererFinaliserVertexShader:()=>bS.meshUVSpaceRendererFinaliserVertexShader,meshUVSpaceRendererFinaliserVertexShaderWGSL:()=>MS.meshUVSpaceRendererFinaliserVertexShaderWGSL,meshUVSpaceRendererMaskerPixelShader:()=>ES.meshUVSpaceRendererMaskerPixelShader,meshUVSpaceRendererMaskerPixelShaderWGSL:()=>RS.meshUVSpaceRendererMaskerPixelShaderWGSL,meshUVSpaceRendererMaskerVertexShader:()=>TS.meshUVSpaceRendererMaskerVertexShader,meshUVSpaceRendererMaskerVertexShaderWGSL:()=>AS.meshUVSpaceRendererMaskerVertexShaderWGSL,meshUVSpaceRendererPixelShader:()=>xS.meshUVSpaceRendererPixelShader,meshUVSpaceRendererPixelShaderWGSL:()=>yS.meshUVSpaceRendererPixelShaderWGSL,meshUVSpaceRendererVertexShader:()=>SS.meshUVSpaceRendererVertexShader,meshUVSpaceRendererVertexShaderWGSL:()=>PS.meshUVSpaceRendererVertexShaderWGSL,morphTargetsVertex:()=>kd.morphTargetsVertex,morphTargetsVertexDeclaration:()=>Gd.morphTargetsVertexDeclaration,morphTargetsVertexDeclarationWGSL:()=>wd.morphTargetsVertexDeclarationWGSL,morphTargetsVertexGlobal:()=>Ud.morphTargetsVertexGlobal,morphTargetsVertexGlobalDeclaration:()=>zd.morphTargetsVertexGlobalDeclaration,morphTargetsVertexGlobalDeclarationWGSL:()=>Vd.morphTargetsVertexGlobalDeclarationWGSL,morphTargetsVertexGlobalWGSL:()=>Bd.morphTargetsVertexGlobalWGSL,morphTargetsVertexWGSL:()=>Ld.morphTargetsVertexWGSL,motionBlurPixelShader:()=>eP.motionBlurPixelShader,motionBlurPixelShaderWGSL:()=>tP.motionBlurPixelShaderWGSL,nativeOverride:()=>de.Cx,normalizeEnvInfo:()=>Xr.RZ,oitBackBlendPixelShader:()=>LA.oitBackBlendPixelShader,oitBackBlendPixelShaderWGSL:()=>BA.oitBackBlendPixelShaderWGSL,oitFinalPixelShader:()=>wA.oitFinalPixelShader,oitFinalPixelShaderWGSL:()=>VA.oitFinalPixelShaderWGSL,outlinePixelShader:()=>Uy.outlinePixelShader,outlinePixelShaderWGSL:()=>Wy.outlinePixelShaderWGSL,outlineVertexShader:()=>zy.outlineVertexShader,outlineVertexShaderWGSL:()=>Hy.outlineVertexShaderWGSL,packingFunctions:()=>Sp.packingFunctions,packingFunctionsWGSL:()=>_p.packingFunctionsWGSL,particlesPixelShader:()=>vE.particlesPixelShader,particlesPixelShaderWGSL:()=>xE.particlesPixelShaderWGSL,particlesVertexShader:()=>SE.particlesVertexShader,particlesVertexShaderWGSL:()=>TE.particlesVertexShaderWGSL,passCubePixelShader:()=>Cb.passCubePixelShader,passCubePixelShaderWGSL:()=>Pb.passCubePixelShaderWGSL,passPixelShader:()=>Eb.passPixelShader,passPixelShaderWGSL:()=>bb.passPixelShaderWGSL,pbrPixelShader:()=>Bu.pbrPixelShader,pbrPixelShaderWGSL:()=>Lu.pbrPixelShaderWGSL,pbrVertexShader:()=>wu.pbrVertexShader,pbrVertexShaderWGSL:()=>Fu.pbrVertexShaderWGSL,pickingPixelShader:()=>sr.pickingPixelShader,pickingPixelShaderWGSL:()=>or.pickingPixelShaderWGSL,pickingVertexShader:()=>ar.pickingVertexShader,pickingVertexShaderWGSL:()=>lr.pickingVertexShaderWGSL,postprocessVertexShader:()=>_b.postprocessVertexShader,postprocessVertexShaderWGSL:()=>gb.postprocessVertexShaderWGSL,prepareDefinesForClipPlanes:()=>Xo.Eq,prepareStringDefinesForClipPlanes:()=>Xo.tv,proceduralVertexShader:()=>_d.proceduralVertexShader,proceduralVertexShaderWGSL:()=>md.proceduralVertexShaderWGSL,reflectionFunction:()=>tf.reflectionFunction,reflectionFunctionWGSL:()=>ef.reflectionFunctionWGSL,registerSceneLoaderPlugin:()=>ol.cH,registerTextureLoader:()=>ln.kf,rgbdDecodePixelShader:()=>BT.rgbdDecodePixelShader,rgbdDecodePixelShaderWGSL:()=>kT.rgbdDecodePixelShaderWGSL,rgbdEncodePixelShader:()=>VT.rgbdEncodePixelShader,rgbdEncodePixelShaderWGSL:()=>GT.rgbdEncodePixelShaderWGSL,rsmFullGlobalIlluminationPixelShader:()=>by.rsmFullGlobalIlluminationPixelShader,rsmFullGlobalIlluminationPixelShaderWGSL:()=>Ry.rsmFullGlobalIlluminationPixelShaderWGSL,rsmGlobalIlluminationPixelShader:()=>Cy.rsmGlobalIlluminationPixelShader,rsmGlobalIlluminationPixelShaderWGSL:()=>Ay.rsmGlobalIlluminationPixelShaderWGSL,runCoroutine:()=>DT.aw,runCoroutineAsync:()=>DT.kj,runCoroutineSync:()=>DT.V1,screenSpaceReflection2BlurCombinerPixelShader:()=>cb.screenSpaceReflection2BlurCombinerPixelShader,screenSpaceReflection2BlurCombinerPixelShaderWGSL:()=>db.screenSpaceReflection2BlurCombinerPixelShaderWGSL,screenSpaceReflection2BlurPixelShader:()=>lb.screenSpaceReflection2BlurPixelShader,screenSpaceReflection2BlurPixelShaderWGSL:()=>ub.screenSpaceReflection2BlurPixelShaderWGSL,screenSpaceReflection2PixelShader:()=>ob.screenSpaceReflection2PixelShader,screenSpaceReflection2PixelShaderWGSL:()=>hb.screenSpaceReflection2PixelShaderWGSL,serialize:()=>de.lK,serializeAsCameraReference:()=>de.fW,serializeAsColor3:()=>de.jT,serializeAsColor4:()=>de.qK,serializeAsColorCurves:()=>de.wL,serializeAsFresnelParameters:()=>de.Y9,serializeAsImageProcessingConfiguration:()=>de.n1,serializeAsMatrix:()=>de.GG,serializeAsMeshReference:()=>de.xG,serializeAsQuaternion:()=>de.bR,serializeAsTexture:()=>de.uM,serializeAsVector2:()=>de.WM,serializeAsVector3:()=>de.P_,setAndStartTimer:()=>Tc.fj,setOpenGLOrientationForUV:()=>cr.ge,setStereoscopicAnaglyphRigMode:()=>Zt,setStereoscopicRigMode:()=>ai,setVRRigMode:()=>Pi,shadowMapFragment:()=>xp.shadowMapFragment,shadowMapFragmentSoftTransparentShadow:()=>Oh.shadowMapFragmentSoftTransparentShadow,shadowMapFragmentSoftTransparentShadowWGSL:()=>Ah.shadowMapFragmentSoftTransparentShadowWGSL,shadowMapFragmentWGSL:()=>gp.shadowMapFragmentWGSL,shadowMapPixelShader:()=>Rh.shadowMapPixelShader,shadowMapPixelShaderWGSL:()=>bh.shadowMapPixelShaderWGSL,shadowMapVertexMetric:()=>vp.shadowMapVertexMetric,shadowMapVertexMetricWGSL:()=>mp.shadowMapVertexMetricWGSL,shadowMapVertexShader:()=>Ih.shadowMapVertexShader,shadowMapVertexShaderWGSL:()=>Ph.shadowMapVertexShaderWGSL,shadowsFragmentFunctions:()=>Qp.shadowsFragmentFunctions,shadowsFragmentFunctionsWGSL:()=>Hp.shadowsFragmentFunctionsWGSL,shadowsVertex:()=>Jp.shadowsVertex,shadowsVertexWGSL:()=>Yp.shadowsVertexWGSL,sharpenPixelShader:()=>BC.sharpenPixelShader,sharpenPixelShaderWGSL:()=>Mb.sharpenPixelShaderWGSL,spritesPixelShader:()=>HA.spritesPixelShader,spritesPixelShaderWGSL:()=>XA.spritesPixelShaderWGSL,spritesVertexShader:()=>YA.spritesVertexShader,spritesVertexShaderWGSL:()=>qA.spritesVertexShaderWGSL,ssao2PixelShader:()=>nb.ssao2PixelShader,ssao2PixelShaderWGSL:()=>sb.ssao2PixelShaderWGSL,ssaoCombinePixelShader:()=>qC.ssaoCombinePixelShader,ssaoCombinePixelShaderWGSL:()=>ab.ssaoCombinePixelShaderWGSL,textureSizeIsObject:()=>ea,tonemapPixelShader:()=>lP.tonemapPixelShader,tonemapPixelShaderWGSL:()=>cP.tonemapPixelShaderWGSL,unregisterTextureLoader:()=>ln.hy,useOpenGLOrientationForUV:()=>cr.rX,vrDistortionCorrectionPixelShader:()=>yb.vrDistortionCorrectionPixelShader,vrDistortionCorrectionPixelShaderWGSL:()=>Ab.vrDistortionCorrectionPixelShaderWGSL});var r=i(89095),n=i(6740),s=i(54983),a=i(39341),o=i(88252);class l{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new n.cP,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){return null}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const e=this._condition.serialize();return e.children.push(i),t&&t.children.push(e),e}return t&&t.children.push(i),i}}l._SerializeValueAsString=e=>"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof s.I9?e.x+", "+e.y:e instanceof s.Pq?e.x+", "+e.y+", "+e.z:e instanceof a.v9?e.r+", "+e.g+", "+e.b:e instanceof a.ov?e.r+", "+e.g+", "+e.b+", "+e.a:e,l._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),(0,o.Y5)("BABYLON.Action",l);var c=i(94734);class h{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class u extends h{static get IsEqual(){return u._IsEqual}static get IsDifferent(){return u._IsDifferent}static get IsGreater(){return u._IsGreater}static get IsLesser(){return u._IsLesser}constructor(e,t,i,r,n=u.IsEqual){super(e),this.propertyPath=i,this.value=r,this.operator=n,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case u.IsGreater:return this._effectiveTarget[this._property]>this.value;case u.IsLesser:return this._effectiveTarget[this._property]<this.value;case u.IsEqual:case u.IsDifferent:{let e;return e=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===u.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)},{name:"operator",value:u.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case u._IsEqual:return"IsEqual";case u._IsDifferent:return"IsDifferent";case u._IsGreater:return"IsGreater";case u._IsLesser:return"IsLesser";default:return""}}}u._IsEqual=0,u._IsDifferent=1,u._IsGreater=2,u._IsLesser=3;class d extends h{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class p extends h{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[l._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}(0,o.Y5)("BABYLON.ValueCondition",u),(0,o.Y5)("BABYLON.PredicateCondition",d),(0,o.Y5)("BABYLON.StateCondition",p);var f=i(70461);class m extends l{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class _ extends l{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[l._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class g extends l{constructor(e,t,i,r,n){super(e,n),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)}]},e)}}class v extends l{constructor(e,t,i,r,n){super(e,n),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&f.V.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)}]},e)}}class S extends l{constructor(e,t,i,r,n,s){super(e,s),this.from=i,this.to=r,this.loop=n,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[l._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:l._SerializeValueAsString(this.loop)||!1}]},e)}}class x extends l{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[l._GetTargetProperty(this._target)]},e)}}class T extends l{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class E extends l{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)this.enableChildrenConditions&&!t._evaluateConditionForCurrentFrame()||t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let e=0;e<this.children.length;e++)t.combine.push(this.children[e].serialize(null));return t}}class C extends l{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class b extends l{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=s.Pq.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[l._GetTargetProperty(this._target),l._GetTargetProperty(this._parent)]},e)}}(0,o.Y5)("BABYLON.SetParentAction",b),(0,o.Y5)("BABYLON.ExecuteCodeAction",C),(0,o.Y5)("BABYLON.DoNothingAction",T),(0,o.Y5)("BABYLON.StopAnimationAction",x),(0,o.Y5)("BABYLON.PlayAnimationAction",S),(0,o.Y5)("BABYLON.IncrementValueAction",v),(0,o.Y5)("BABYLON.SetValueAction",g),(0,o.Y5)("BABYLON.SetStateAction",_),(0,o.Y5)("BABYLON.SetParentAction",b),(0,o.Y5)("BABYLON.SwitchBooleanAction",m),(0,o.Y5)("BABYLON.CombineAction",E);var P=i(69583),y=i(34829);class A extends r.G{constructor(e){super(),(e=e||P.q.LastCreatedScene)&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let e=0;e<this.actions.length;e++){const t=this.actions[e];A.Triggers[t.trigger]--,0===A.Triggers[t.trigger]&&delete A.Triggers[t.trigger]}this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1);const t=this._scene.meshes.filter((e=>e.actionManager===this));for(const e of t)e.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(e==r.trigger||t==r.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(!t)return!0;if(t(r.getTriggerParameter()))return!0}}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=A.OnPickTrigger&&t.trigger<=A.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=A.OnPickTrigger&&t.trigger<=A.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===A.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(f.V.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,A.Triggers[e.trigger]?A.Triggers[e.trigger]++:A.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return-1!==t&&(this.actions.splice(t,1),A.Triggers[e.trigger]-=1,0===A.Triggers[e.trigger]&&delete A.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0)}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(t&&(e===A.OnKeyUpTrigger||e===A.OnKeyDownTrigger)){const e=r.getTriggerParameter();if("function"==typeof e){if(!e(t))continue}else if(e&&e!==t.sourceEvent.keyCode){if(!e.toLowerCase)continue;const i=e.toLowerCase();if(i!==t.sourceEvent.key){const e=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(e).toLowerCase()!==i)continue}}}r._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let t=0;t<i.length-1;t++)e=e[i[t]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let e=0;e<this.actions.length;e++){const i={type:0,children:new Array,name:A.GetTriggerName(this.actions[e].trigger),properties:new Array},r=this.actions[e].triggerOptions;if(r&&"number"!=typeof r)if(r.parameter instanceof Node)i.properties.push(l._GetTargetProperty(r.parameter));else if("object"==typeof r.parameter){const e={};y.r.DeepCopy(r.parameter,e,["mesh"]),r.parameter&&r.parameter.mesh&&(e._meshId=r.parameter.mesh.id),i.properties.push({name:"parameter",targetType:null,value:e})}else i.properties.push({name:"parameter",targetType:null,value:r.parameter});this.actions[e].serialize(i),t.children.push(i)}return t}static Parse(e,t,i){const r=new A(i);null===t?i.actionManager=r:t.actionManager=r;const n=(e,t,i,r)=>{if(null===r){const e=parseFloat(t);return"true"===t||"false"===t?"true"===t:isNaN(e)?t:e}const n=r.split("."),o=t.split(",");for(let e=0;e<n.length;e++)i=i[n[e]];if("boolean"==typeof i)return"true"===o[0];if("string"==typeof i)return o[0];const l=[];for(let e=0;e<o.length;e++)l.push(parseFloat(o[e]));return i instanceof s.Pq?s.Pq.FromArray(l):i instanceof s.IU?s.IU.FromArray(l):i instanceof a.v9?a.v9.FromArray(l):i instanceof a.ov?a.ov.FromArray(l):parseFloat(o[0])},l=(e,t,s,a,c=null)=>{if(e.detached)return;const d=[];let p=null,f=null;const m=e.combine&&e.combine.length>0;if(2===e.type?d.push(r):d.push(t),m){const t=[];for(let i=0;i<e.combine.length;i++)l(e.combine[i],A.NothingTrigger,s,a,t);d.push(t)}else for(let t=0;t<e.properties.length;t++){let r=e.properties[t].value;const s=e.properties[t].name,a=e.properties[t].targetType;"target"===s?r=p="SceneProperties"===a?i:"MaterialProperties"===a?i.getMaterialByName(r):i.getNodeByName(r):"parent"===s?r=i.getNodeByName(r):"sound"===s?i.getSoundByName&&(r=i.getSoundByName(r)):"propertyPath"!==s?r=2===e.type&&"operator"===s?u[r]:n(0,r,p,"value"===s?f:null):f=r,d.push(r)}if(null===c?d.push(s):d.push(null),"InterpolateValueAction"===e.name){const e=d[d.length-2];d[d.length-1]=e,d[d.length-2]=s}let _=((e,t)=>{const i=(0,o.n9)("BABYLON."+e);return i&&new i(...t)})(e.name,d);if(_ instanceof h&&null!==s){const e=new T(t,s);a?a.then(e):r.registerAction(e),a=e}null===c?_ instanceof h?(s=_,_=a):(s=null,a?a.then(_):r.registerAction(_)):c.push(_);for(let i=0;i<e.children.length;i++)l(e.children[i],t,s,_,null)};for(let t=0;t<e.children.length;t++){let r;const n=e.children[t];if(n.properties.length>0){const e=n.properties[0].value,t=null===n.properties[0].targetType?e:i.getMeshByName(e);t._meshId&&(t.mesh=i.getMeshById(t._meshId)),r={trigger:A[n.name],parameter:t}}else r=A[n.name];for(let e=0;e<n.children.length;e++)n.detached||l(n.children[e],r,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}A.NothingTrigger=0,A.OnPickTrigger=1,A.OnLeftPickTrigger=2,A.OnRightPickTrigger=3,A.OnCenterPickTrigger=4,A.OnPickDownTrigger=5,A.OnDoublePickTrigger=6,A.OnPickUpTrigger=7,A.OnPickOutTrigger=16,A.OnLongPressTrigger=8,A.OnPointerOverTrigger=9,A.OnPointerOutTrigger=10,A.OnEveryFrameTrigger=11,A.OnIntersectionEnterTrigger=12,A.OnIntersectionExitTrigger=13,A.OnKeyDownTrigger=14,A.OnKeyUpTrigger=15;class R extends l{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class I extends l{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}(0,o.Y5)("BABYLON.PlaySoundAction",R),(0,o.Y5)("BABYLON.StopSoundAction",I);var M=i(13528);class O extends l{constructor(e,t,i,r,s=1e3,a,o,l){super(e,a),this.duration=1e3,this.onInterpolationDoneObservable=new n.cP,this.propertyPath=i,this.value=r,this.duration=s,this.stopOtherAnimations=o,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if("number"==typeof this.value)i=M.X5.ANIMATIONTYPE_FLOAT;else if(this.value instanceof a.v9)i=M.X5.ANIMATIONTYPE_COLOR3;else if(this.value instanceof s.Pq)i=M.X5.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof s.uq)i=M.X5.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof s.PT))return void f.V.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");i=M.X5.ANIMATIONTYPE_QUATERNION}const r=new M.X5("InterpolateValueAction",this._property,1e3/this.duration*100,i,M.X5.ANIMATIONLOOPMODE_CONSTANT);r.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget),e.beginDirectAnimation(this._effectiveTarget,[r],0,100,!1,1,(()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()}))}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[l._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:l._SerializeValueAsString(this.value)},{name:"duration",value:l._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:l._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}(0,o.Y5)("BABYLON.InterpolateValueAction",O);var N=i(46077);class D{constructor(){this.enableBlending=!1,this.blendingSpeed=.01,this.loopMode=M.X5.ANIMATIONLOOPMODE_CYCLE}}var F=i(74539);class L{constructor(){this._easingMode=L.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case L.EASINGMODE_EASEIN:return this.easeInCore(e);case L.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)}}L.EASINGMODE_EASEIN=0,L.EASINGMODE_EASEOUT=1,L.EASINGMODE_EASEINOUT=2;class w extends L{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class B extends L{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class V extends L{constructor(e=3,t=2){super(),this.bounces=e,this.bounciness=t}easeInCore(e){const t=Math.max(0,this.bounces);let i=this.bounciness;i<=1&&(i=1.001);const r=Math.pow(i,t),n=1-i,s=(1-r)/n+.5*r,a=e*s,o=Math.log(-a*(1-i)+1)/Math.log(i),l=Math.floor(o),c=l+1,h=(1-Math.pow(i,l))/(n*s),u=.5*(h+(1-Math.pow(i,c))/(n*s)),d=e-u,p=u-h;return-Math.pow(1/i,t-l)/(p*p)*(d-p)*(d+p)}}class k extends L{easeInCore(e){return e*e*e}}class G extends L{constructor(e=3,t=3){super(),this.oscillations=e,this.springiness=t}easeInCore(e){let t;const i=Math.max(0,this.oscillations),r=Math.max(0,this.springiness);return t=0==r?e:(Math.exp(r*e)-1)/(Math.exp(r)-1),t*Math.sin((6.283185307179586*i+1.5707963267948966)*e)}}class U extends L{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class z extends L{constructor(e=2){super(),this.power=e}easeInCore(e){const t=Math.max(0,this.power);return Math.pow(e,t)}}class W extends L{easeInCore(e){return e*e}}class H extends L{easeInCore(e){return e*e*e*e}}class Y extends L{easeInCore(e){return e*e*e*e*e}}class X extends L{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}class q extends L{constructor(e=0,t=0,i=1,r=1){super(),this.x1=e,this.y1=t,this.x2=i,this.y2=r}easeInCore(e){return F.vr.Interpolate(e,this.x1,this.y1,this.x2,this.y2)}}var $,j=i(30966),K=i(25530),Z=i(5933);!function(e){e[e.NONE=0]="NONE",e[e.STEP=1]="STEP"}($||($={}));var Q,J=i(82423);class ee{constructor(e){this._path=e,this._onchange=new Array,this.value=0,this.animations=[]}getPoint(){const e=this._path.getPointAtLengthPosition(this.value);return new s.Pq(e.x,0,e.y)}moveAhead(e=.002){return this.move(e),this}moveBack(e=.002){return this.move(-e),this}move(e){if(Math.abs(e)>1)throw"step size should be less than 1.";return this.value+=e,this._ensureLimits(),this._raiseOnChange(),this}_ensureLimits(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this}_raiseOnChange(){return this._onchange.forEach((e=>e(this))),this}onchange(e){return this._onchange.push(e),this}}!function(e){e[e.Include=0]="Include",e[e.Exclude=1]="Exclude"}(Q||(Q={}));class te{constructor(e,t=0){this.mode=t,this.disabled=!1,this._targetNames=new Set,e&&this.addTargetName(e)}addTargetName(e){if(Array.isArray(e))for(const t of e)this._targetNames.add(t);else this._targetNames.add(e)}removeTargetName(e){if(Array.isArray(e))for(const t of e)this._targetNames.delete(t);else this._targetNames.delete(e)}hasTarget(e){return this._targetNames.has(e)}retainsTarget(e){return this._targetNames.has(e)===(0===this.mode)}}var ie=i(85685),re=i(90066),ne=i(80770);class se{constructor(e){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},(e=e||P.q.LastCreatedScene)&&(this._scene=e,ne.$.audioEngine?(this._audioEngine=ne.$.audioEngine,this._audioEngine.canUseWebAudio&&this._audioEngine.audioContext&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))):re.S0.Warn("No audio engine initialized, failed to create an audio analyser"))}getFrequencyBinCount(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0}getByteFrequencyData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs}getByteTimeDomainData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime}getFloatFrequencyData(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs}drawDebugCanvas(){if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=()=>{this.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc&&this._debugCanvasContext)){const e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(let t=0;t<this.getFrequencyBinCount();t++){const i=e[t]/this.BARGRAPHAMPLITUDE,r=this.DEBUGCANVASSIZE.height*i,n=this.DEBUGCANVASSIZE.height-r-1,s=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),a=t/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+a+", 100%, 50%)",this._debugCanvasContext.fillRect(t*s,n,s,r)}}}stopDebugCanvas(){this._debugCanvas&&(this._registerFunc&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null),document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)}connectAudioNodes(e,t){this._audioEngine.canUseWebAudio&&(e.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(t))}dispose(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()}}var ae=i(26421),oe=i(36908),le=i(25494),ce=i(4483),he=i(15265),ue=i(90576),de=i(96631),pe=i(16265);class fe{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,(e=e||P.q.LastCreatedScene)&&(this._scene=e,this.animationParameters=new s.IU(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new fe(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,r=30){this.animationParameters=new s.IU(e,t,i,r)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){pe.p.Clone((()=>e),this)}serialize(){return pe.p.Serialize(this)}parse(e,t,i){pe.p.Parse((()=>this),e,t,i)}}(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markSubMeshesAsAttributesDirty")],fe.prototype,"texture",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markSubMeshesAsAttributesDirty")],fe.prototype,"isEnabled",void 0),(0,ue.Cg)([(0,de.lK)()],fe.prototype,"animationParameters",void 0),(0,ue.Cg)([(0,de.lK)()],fe.prototype,"time",void 0);var me=i(18645),_e=i(23077),ge=i(56953),ve=i(90321);class Se{constructor(e,t){this._scene=e,t instanceof ve.E?(this._skeleton=t,this._mesh=null):(this._mesh=t,this._skeleton=t.skeleton)}async bakeVertexData(e){if(!this._skeleton)throw new Error("No skeleton provided.");const t=this._skeleton.bones.length,i=e.reduce(((e,t)=>e+t.to-t.from+1),0);if(isNaN(i))throw new Error("Invalid animation ranges.");let r=0;const n=new Float32Array(4*(t+1)*4*i);this._scene.stopAnimation(this._skeleton),this._skeleton.returnToRest();for(const t of e)for(let e=t.from;e<=t.to;e++)await this._executeAnimationFrame(n,e,r++);return n}async _executeAnimationFrame(e,t,i){return new Promise(((r,n)=>{this._scene.beginAnimation(this._skeleton,t,t,!1,1,(()=>{const t=this._skeleton.getTransformMatrices(this._mesh);e.set(t,i*t.length),r()}))}))}textureFromBakedVertexData(e){if(!this._skeleton)throw new Error("No skeleton provided.");const t=this._skeleton.bones.length,i=me.I.CreateRGBATexture(e,4*(t+1),e.length/(4*(t+1)*4),this._scene,!1,!1,_e.g.NEAREST_NEAREST,1);return i.name="VAT"+this._skeleton.name,i}serializeBakedVertexDataToObject(e){if(!this._skeleton)throw new Error("No skeleton provided.");const t=this._skeleton.bones.length,i=4*(t+1),r=e.length/(4*(t+1)*4);return{vertexData:(0,ge.EL)(e),width:i,height:r}}loadBakedVertexDataFromObject(e){return new Float32Array((0,ge.yS)(e.vertexData))}serializeBakedVertexDataToJSON(e){return JSON.stringify(this.serializeBakedVertexDataToObject(e))}loadBakedVertexDataFromJSON(e){return this.loadBakedVertexDataFromObject(JSON.parse(e))}}var xe=i(31780),Te=i(40505),Ee=i(50507);class Ce{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==xe.Zp.POINTERDOWN?e.type===xe.Zp.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{if(this._reachTargetAlpha())return;const e=Te.j.Now;let t=0;null!=this._lastFrameTime&&(t=e-this._lastFrameTime),this._lastFrameTime=e,this._applyUserInteraction();const i=e-this._lastInteractionTime-this._idleRotationWaitTime,r=Math.max(Math.min(i/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*r,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(t/1e3))}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Te.j.Now}_reachTargetAlpha(){return!(!this._attachedCamera||!this.targetAlpha)&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<Ee.bH}_userIsZooming(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Te.j.Now)}_userIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}class be{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add((e=>{if(e&&(e.computeWorldMatrix(!0),e.getBoundingInfo)){const t=e.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*t,this.upperRadiusTransitionRange=.05*t}})):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))}))}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return!!this._attachedCamera&&this._attachedCamera.radius===e&&!this._radiusIsAnimating}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(be.EasingFunction.setEasingMode(be.EasingMode),this._radiusBounceTransition=M.X5.CreateAnimation("radius",M.X5.ANIMATIONTYPE_FLOAT,60,be.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=M.X5.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,(()=>this._clearAnimationLocks()));t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}be.EasingFunction=new B(.3),be.EasingMode=L.EASINGMODE_EASEOUT;class Pe{constructor(){this.onTargetFramingAnimationEndObservable=new n.cP,this._mode=Pe.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Pe.EasingFunction.setEasingMode(Pe.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==xe.Zp.POINTERDOWN?e.type===xe.Zp.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add((e=>{e&&e.getBoundingInfo&&this.zoomOnMesh(e,void 0,(()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()}))})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const r=new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new s.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let t=0;t<e.length;t++){const i=e[t].getHierarchyBoundingVectors(!0);s.Pq.CheckExtends(i.min,r,n),s.Pq.CheckExtends(i.max,r,n)}this.zoomOnBoundingInfo(r,n,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let n;if(!this._attachedCamera)return!1;const a=e.y,o=a+(t.y-a)*this._positionScale,l=t.subtract(e).scale(.5);if(i)n=new s.Pq(0,o,0);else{const t=e.add(l);n=new s.Pq(t.x,o,t.z)}this._vectorTransition||(this._vectorTransition=M.X5.CreateAnimation("target",M.X5.ANIMATIONTYPE_VECTOR3,60,Pe.EasingFunction)),this._betaIsAnimating=!0;let c=M.X5.TransitionTo("target",n,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);c&&this._animatables.push(c);let h=0;if(this._mode===Pe.FitFrustumSidesMode){const i=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=l.length()+this._attachedCamera.minZ),h=i}else this._mode===Pe.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const i=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/i,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=M.X5.CreateAnimation("radius",M.X5.ANIMATIONTYPE_FLOAT,60,Pe.EasingFunction)),c=M.X5.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,(()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()})),c&&this._animatables.push(c),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===Pe.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Te.j.Now-this._lastInteractionTime,t=.5*Math.PI-this._defaultElevation,i=.5*Math.PI;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=M.X5.CreateAnimation("beta",M.X5.ANIMATIONTYPE_FLOAT,60,Pe.EasingFunction));const e=M.X5.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,(()=>{this._clearAnimationLocks(),this.stopAllAnimations()}));e&&this._animatables.push(e)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Te.j.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}Pe.EasingFunction=new U,Pe.EasingMode=L.EASINGMODE_EASEINOUT,Pe.IgnoreBoundsSizeMode=0,Pe.FitFrustumSidesMode=1;class ye{constructor(e,t=new s.Pq,i=0,r=!1){this.direction=e,this.rotatedDirection=t,this.diff=i,this.ignore=r}}class Ae{constructor(e){this._ui=e,this.name="AttachToBoxBehavior",this.distanceAwayFromFace=.15,this.distanceAwayFromBottomOfFace=.15,this._faceVectors=[new ye(s.Pq.Up()),new ye(s.Pq.Down()),new ye(s.Pq.Left()),new ye(s.Pq.Right()),new ye(s.Pq.Forward()),new ye(s.Pq.Forward().scaleInPlace(-1))],this._tmpMatrix=new s.uq,this._tmpVector=new s.Pq,this._zeroVector=s.Pq.Zero(),this._lookAtTmpMatrix=new s.uq}init(){}_closestFace(e){return this._faceVectors.forEach((t=>{this._target.rotationQuaternion||(this._target.rotationQuaternion=s.PT.RotationYawPitchRoll(this._target.rotation.y,this._target.rotation.x,this._target.rotation.z)),this._target.rotationQuaternion.toRotationMatrix(this._tmpMatrix),s.Pq.TransformCoordinatesToRef(t.direction,this._tmpMatrix,t.rotatedDirection),t.diff=s.Pq.GetAngleBetweenVectors(t.rotatedDirection,e,s.Pq.Cross(t.rotatedDirection,e))})),this._faceVectors.reduce(((e,t)=>e.ignore?t:t.ignore||e.diff<t.diff?e:t),this._faceVectors[0])}_lookAtToRef(e,t=new s.Pq(0,1,0),i){s.uq.LookAtLHToRef(this._zeroVector,e,t,this._lookAtTmpMatrix),this._lookAtTmpMatrix.invert(),s.PT.FromRotationMatrixToRef(this._lookAtTmpMatrix,i)}attach(e){this._target=e,this._scene=this._target.getScene(),this._onRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(!this._scene.activeCamera)return;let t=this._scene.activeCamera.position;this._scene.activeCamera.devicePosition&&(t=this._scene.activeCamera.devicePosition);const i=this._closestFace(t.subtract(e.position));this._scene.activeCamera.leftCamera?this._scene.activeCamera.leftCamera.computeWorldMatrix().getRotationMatrixToRef(this._tmpMatrix):this._scene.activeCamera.computeWorldMatrix().getRotationMatrixToRef(this._tmpMatrix),s.Pq.TransformCoordinatesToRef(s.Pq.Up(),this._tmpMatrix,this._tmpVector),this._faceVectors.forEach((e=>{i.direction.x&&e.direction.x&&(e.ignore=!0),i.direction.y&&e.direction.y&&(e.ignore=!0),i.direction.z&&e.direction.z&&(e.ignore=!0)}));const r=this._closestFace(this._tmpVector);this._faceVectors.forEach((e=>{e.ignore=!1})),this._ui.position.copyFrom(e.position),i.direction.x&&(i.rotatedDirection.scaleToRef(e.scaling.x/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),i.direction.y&&(i.rotatedDirection.scaleToRef(e.scaling.y/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),i.direction.z&&(i.rotatedDirection.scaleToRef(e.scaling.z/2+this.distanceAwayFromFace,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)),this._ui.rotationQuaternion||(this._ui.rotationQuaternion=s.PT.RotationYawPitchRoll(this._ui.rotation.y,this._ui.rotation.x,this._ui.rotation.z)),i.rotatedDirection.scaleToRef(-1,this._tmpVector),this._lookAtToRef(this._tmpVector,r.rotatedDirection,this._ui.rotationQuaternion),r.direction.x&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.x/2,this._tmpVector),r.direction.y&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.y/2,this._tmpVector),r.direction.z&&this._ui.up.scaleToRef(this.distanceAwayFromBottomOfFace-e.scaling.z/2,this._tmpVector),this._ui.position.addInPlace(this._tmpVector)}))}detach(){this._scene.onBeforeRenderObservable.remove(this._onRenderObserver)}}var Re=i(54321),Ie=i(2073);class Me{constructor(){this._startDistance=0,this._initialScale=new s.Pq(0,0,0),this._targetScale=new s.Pq(0,0,0),this._sceneRenderObserver=null,this._dragBehaviorA=new Ie.C({}),this._dragBehaviorA.moveAttached=!1,this._dragBehaviorB=new Ie.C({}),this._dragBehaviorB.moveAttached=!1}get name(){return"MultiPointerScale"}init(){}_getCurrentDistance(){return this._dragBehaviorA.lastDragPosition.subtract(this._dragBehaviorB.lastDragPosition).length()}attach(e){this._ownerNode=e,this._dragBehaviorA.onDragStartObservable.add((()=>{this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging&&(this._dragBehaviorA.currentDraggingPointerId==this._dragBehaviorB.currentDraggingPointerId?this._dragBehaviorA.releaseDrag():(this._initialScale.copyFrom(e.scaling),this._startDistance=this._getCurrentDistance()))})),this._dragBehaviorB.onDragStartObservable.add((()=>{this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging&&(this._dragBehaviorA.currentDraggingPointerId==this._dragBehaviorB.currentDraggingPointerId?this._dragBehaviorB.releaseDrag():(this._initialScale.copyFrom(e.scaling),this._startDistance=this._getCurrentDistance()))})),[this._dragBehaviorA,this._dragBehaviorB].forEach((e=>{e.onDragObservable.add((()=>{if(this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging){const e=this._getCurrentDistance()/this._startDistance;this._initialScale.scaleToRef(e,this._targetScale)}}))})),e.addBehavior(this._dragBehaviorA),e.addBehavior(this._dragBehaviorB),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(this._dragBehaviorA.dragging&&this._dragBehaviorB.dragging){const t=this._targetScale.subtract(e.scaling).scaleInPlace(.1);t.length()>.01&&e.scaling.addInPlace(t)}}))}detach(){this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),[this._dragBehaviorA,this._dragBehaviorB].forEach((e=>{e.onDragStartObservable.clear(),e.onDragObservable.clear(),this._ownerNode.removeBehavior(e)}))}}var Oe=i(73395),Ne=i(39500),De=i(16318),Fe=i(39485),Le=i(90594),we=i(93420);class Be{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=s.Pq.Zero(),this.poleTargetPosition=s.Pq.Zero(),this.poleTargetLocalOffset=s.Pq.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=s.PT.Identity(),this._bone1Mat=s.uq.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=s.Pq.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;const r=t.getParent();if(!r)return this._notEnoughInformation=!0,void f.V.Error("BoneIKController: bone must have a parent for IK to work.");if(this._bone1=r,0===this._bone2.children.length&&!this._bone2.length)return this._notEnoughInformation=!0,void f.V.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");this.mesh=e,t.getSkeleton().computeAbsoluteMatrices();const n=t.getPosition();if(t.getAbsoluteMatrix().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,n.x>n.y&&n.x>n.z&&(this._adjustRoll=.5*Math.PI,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){const e=this._bone1.getScale(),t=this._bone2.getScale();this._bone1Length=this._bone1.length*e.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);const t=this._bone2.children[0].getAbsolutePosition(e),i=this._bone2.getAbsolutePosition(e),r=this._bone1.getAbsolutePosition(e);this._bone2Length=s.Pq.Distance(t,i),this._bone1Length=s.Pq.Distance(i,r)}else{e.computeWorldMatrix(!0);const t=this._bone2.getScale();this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y;const i=this._bone2.getAbsolutePosition(e),r=this._bone1.getAbsolutePosition(e);this._bone1Length=s.Pq.Distance(i,r)}this._bone1.getRotationMatrixToRef(1,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||null==e)&&(e=Math.PI),this._maxAngle=e;const t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;const e=this.targetPosition,t=this.poleTargetPosition,i=Be._TmpMats[0],r=Be._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&s.Pq.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);const n=Be._TmpVecs[0],a=Be._TmpVecs[1],o=Be._TmpVecs[2],l=Be._TmpVecs[3],c=Be._TmpVecs[4],h=Be._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,n),t.subtractToRef(n,c),0==c.x&&0==c.y&&0==c.z?c.y=1:c.normalize(),e.subtractToRef(n,l),l.normalize(),s.Pq.CrossToRef(l,c,a),a.normalize(),s.Pq.CrossToRef(l,a,o),o.normalize(),s.uq.FromXYZAxesToRef(o,l,a,i);const u=this._bone1Length,d=this._bone2Length;let p=s.Pq.Distance(n,e);this._maxReach>0&&(p=Math.min(this._maxReach,p));let f=(d*d+p*p-u*u)/(2*d*p),m=(p*p+u*u-d*d)/(2*p*u);f>1&&(f=1),m>1&&(m=1),f<-1&&(f=-1),m<-1&&(m=-1);const _=Math.acos(f),g=Math.acos(m);let v=-_-g;if(this._rightHandedSystem)s.uq.RotationYawPitchRollToRef(0,0,this._adjustRoll,r),r.multiplyToRef(i,i),s.uq.RotationAxisToRef(this._bendAxis,g,r),r.multiplyToRef(i,i);else{const e=Be._TmpVecs[5];e.copyFrom(this._bendAxis),e.x*=-1,s.uq.RotationAxisToRef(e,-g,r),r.multiplyToRef(i,i)}this.poleAngle&&(s.uq.RotationAxisToRef(l,this.poleAngle,r),i.multiplyToRef(r,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||s.PT.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),s.PT.FromRotationMatrixToRef(i,h),s.PT.SlerpToRef(this._bone1Quat,h,this.slerpAmount,this._bone1Quat),v=this._bone2Ang*(1-this.slerpAmount)+v*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,1,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,1,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,v,0),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=v}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new s.PT),e.getRotationQuaternionToRef(0,null,e._linkedTransformNode.rotationQuaternion))}}Be._TmpVecs=[s.Pq.Zero(),s.Pq.Zero(),s.Pq.Zero(),s.Pq.Zero(),s.Pq.Zero(),s.Pq.Zero()],Be._TmpQuat=s.PT.Identity(),Be._TmpMats=[s.uq.Identity(),s.uq.Identity()];var Ve=i(87649),ke=i(73537);class Ge{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,r){if(this.upAxis=s.Pq.Up(),this.upAxisSpace=0,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=s.PT.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=s.Pq.Forward(),this.useAbsoluteValueForYaw=!1,this.mesh=e,this.bone=t,this.target=i,r){if(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),null!=r.maxYaw?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,null!=r.minYaw?this.minYaw=r.minYaw:this.minYaw=-Math.PI,null!=r.maxPitch?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,null!=r.minPitch?this.minPitch=r.minPitch:this.minPitch=-Math.PI,null!=r.slerpAmount&&(this.slerpAmount=r.slerpAmount),null!=r.upAxis&&(this.upAxis=r.upAxis),null!=r.upAxisSpace&&(this.upAxisSpace=r.upAxisSpace),null!=r.yawAxis||null!=r.pitchAxis){let e=ke._0.Y,t=ke._0.X;null!=r.yawAxis&&(e=r.yawAxis.clone(),e.normalize()),null!=r.pitchAxis&&(t=r.pitchAxis.clone(),t.normalize());const i=s.Pq.Cross(t,e);this._transformYawPitch=s.uq.Identity(),s.uq.FromXYZAxesToRef(t,e,i,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}void 0!==r.useAbsoluteValueForYaw&&(this.useAbsoluteValueForYaw=r.useAbsoluteValueForYaw)}t.getParent()||2!=this.upAxisSpace||(this.upAxisSpace=0)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped)return void(this._firstFrameSkipped=!0);const e=this.bone,t=Ge._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target;const r=Ge._TmpMats[0],n=Ge._TmpMats[1],a=this.mesh,o=e.getParent(),l=Ge._TmpVecs[1];l.copyFrom(this.upAxis),2==this.upAxisSpace&&o?(this._transformYawPitch&&s.Pq.TransformCoordinatesToRef(l,this._transformYawPitchInv,l),o.getDirectionToRef(l,this.mesh,l)):0==this.upAxisSpace&&(a.getDirectionToRef(l,l),1==a.scaling.x&&1==a.scaling.y&&1==a.scaling.z||l.normalize());let c=!1,h=!1;if(this._maxYaw==Math.PI&&this._minYaw==-Math.PI||(c=!0),this._maxPitch==Math.PI&&this._minPitch==-Math.PI||(h=!0),c||h){const e=Ge._TmpMats[2],r=Ge._TmpMats[3];if(2==this.upAxisSpace&&1==l.y&&o)o.getRotationMatrixToRef(1,this.mesh,e);else if(0!=this.upAxisSpace||1!=l.y||o){let t=Ge._TmpVecs[2];t.copyFrom(this._fowardAxis),this._transformYawPitch&&s.Pq.TransformCoordinatesToRef(t,this._transformYawPitchInv,t),o?o.getDirectionToRef(t,this.mesh,t):a.getDirectionToRef(t,t);const i=s.Pq.Cross(l,t);i.normalize(),t=s.Pq.Cross(i,l),s.uq.FromXYZAxesToRef(i,l,t,e)}else e.copyFrom(a.getWorldMatrix());e.invertToRef(r);let n=null;if(h){const a=Ge._TmpVecs[3];i.subtractToRef(t,a),s.Pq.TransformCoordinatesToRef(a,r,a),n=Math.sqrt(a.x*a.x+a.z*a.z);const o=Math.atan2(a.y,n);let l=o;o>this._maxPitch?(a.y=this._maxPitchTan*n,l=this._maxPitch):o<this._minPitch&&(a.y=this._minPitchTan*n,l=this._minPitch),o!=l&&(s.Pq.TransformCoordinatesToRef(a,e,a),a.addInPlace(t),i=a)}if(c){const a=Ge._TmpVecs[4];i.subtractToRef(t,a),s.Pq.TransformCoordinatesToRef(a,r,a);const o=Math.atan2(a.x,a.z),l=this.useAbsoluteValueForYaw?Math.abs(o):o;let c=o;if((l>this._maxYaw||l<this._minYaw)&&(null==n&&(n=Math.sqrt(a.x*a.x+a.z*a.z)),this._yawRange>Math.PI?this._isAngleBetween(o,this._maxYaw,this._midYawConstraint)?(a.z=this._maxYawCos*n,a.x=this._maxYawSin*n,c=this._maxYaw):this._isAngleBetween(o,this._midYawConstraint,this._minYaw)&&(a.z=this._minYawCos*n,a.x=this._minYawSin*n,c=this._minYaw):l>this._maxYaw?(a.z=this._maxYawCos*n,a.x=this._maxYawSin*n,o<0&&this.useAbsoluteValueForYaw&&(a.x*=-1),c=this._maxYaw):l<this._minYaw&&(a.z=this._minYawCos*n,a.x=this._minYawSin*n,o<0&&this.useAbsoluteValueForYaw&&(a.x*=-1),c=this._minYaw)),this._slerping&&this._yawRange>Math.PI){const e=Ge._TmpVecs[8];e.copyFrom(ke._0.Z),this._transformYawPitch&&s.Pq.TransformCoordinatesToRef(e,this._transformYawPitchInv,e);const t=Ge._TmpMats[4];this._boneQuat.toRotationMatrix(t),this.mesh.getWorldMatrix().multiplyToRef(t,t),s.Pq.TransformCoordinatesToRef(e,t,e),s.Pq.TransformCoordinatesToRef(e,r,e);const i=Math.atan2(e.x,e.z);if(this._getAngleBetween(i,o)>this._getAngleBetween(i,this._midYawConstraint)){null==n&&(n=Math.sqrt(a.x*a.x+a.z*a.z));const e=this._getAngleBetween(i,this._maxYaw);this._getAngleBetween(i,this._minYaw)<e?(c=i+.75*Math.PI,a.z=Math.cos(c)*n,a.x=Math.sin(c)*n):(c=i-.75*Math.PI,a.z=Math.cos(c)*n,a.x=Math.sin(c)*n)}}o!=c&&(s.Pq.TransformCoordinatesToRef(a,e,a),a.addInPlace(t),i=a)}}const u=Ge._TmpVecs[5],d=Ge._TmpVecs[6],p=Ge._TmpVecs[7],f=Ge._TmpQuat,m=Ge._TmpVecs[9];i.subtractToRef(t,u),u.normalize(),s.Pq.CrossToRef(l,u,d),d.normalize(),s.Pq.CrossToRef(u,d,p),p.normalize(),s.uq.FromXYZAxesToRef(d,p,u,r),0===d.x&&0===d.y&&0===d.z||0===p.x&&0===p.y&&0===p.z||0===u.x&&0===u.y&&0===u.z||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(s.uq.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,n),n.multiplyToRef(r,r)),m.copyFrom(this.bone.getScale()),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(1,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),s.PT.FromRotationMatrixToRef(r,f),s.PT.SlerpToRef(this._boneQuat,f,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,1,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,1,this.mesh),this._slerping=!1),this.bone.setScale(m),this._updateLinkedTransformRotation())}_getAngleDiff(e,t){let i=t-e;return i%=2*Math.PI,i>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),i}_getAngleBetween(e,t){let i=0;return i=(e=(e%=2*Math.PI)<0?e+2*Math.PI:e)<(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)?t-e:e-t,i>Math.PI&&(i=2*Math.PI-i),i}_isAngleBetween(e,t,i){if(e=(e%=2*Math.PI)<0?e+2*Math.PI:e,(t=(t%=2*Math.PI)<0?t+2*Math.PI:t)<(i=(i%=2*Math.PI)<0?i+2*Math.PI:i)){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){const e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new s.PT),e.getRotationQuaternionToRef(0,null,e._linkedTransformNode.rotationQuaternion))}}Ge._TmpVecs=(0,Ve.mI)(10,s.Pq.Zero),Ge._TmpQuat=s.PT.Identity(),Ge._TmpMats=(0,Ve.mI)(5,s.uq.Identity);var Ue=i(59396),ze=i(74863),We=i(55812),He=i(43027),Ye=(i(8303),i(58001)),Xe=i(31125),qe=i(16374);class $e{constructor(e,t){this.x=e,this.y=t}}class je{get isConnected(){return this._isConnected}constructor(e,t,i,r=0,n=1,s=2,a=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=je.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=n,this._rightStickAxisX=s,this._rightStickAxisY=a,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}je.GAMEPAD=0,je.GENERIC=1,je.XBOX=2,je.POSE_ENABLED=3,je.DUALSHOCK=4;class Ke extends je{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new n.cP,this.onButtonUpObservable=new n.cP,this.type=je.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Ze{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==je.POSE_ENABLED&&(this.gamepad&&e.type!==je.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(je.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const i=t.x/this.gamepadRotationSensibility;0!=i&&Math.abs(i)>.005&&(e.inertialAlphaOffset+=i)}if(0!=t.y){const i=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=i&&Math.abs(i)>.005&&(e.inertialBetaOffset+=i)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const e=i.y/this.gamepadMoveSensibility;0!=e&&Math.abs(e)>.005&&(this.camera.inertialRadiusOffset-=e)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}(0,ue.Cg)([(0,de.lK)()],Ze.prototype,"gamepadRotationSensibility",void 0),(0,ue.Cg)([(0,de.lK)()],Ze.prototype,"gamepadMoveSensibility",void 0),qe.H.ArcRotateCameraGamepadInput=Ze;var Qe=i(79046);class Je{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=re.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===Qe.TB.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault())}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}(0,ue.Cg)([(0,de.lK)()],Je.prototype,"keysUp",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"keysDown",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"keysLeft",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"keysRight",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"keysReset",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"panningSensibility",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"zoomingSensibility",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"useAltToZoom",void 0),(0,ue.Cg)([(0,de.lK)()],Je.prototype,"angularSpeed",void 0),qe.H.ArcRotateCameraKeyboardMoveInput=Je;var et=i(84712),tt=i(35927),it=i(49111);class rt{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new s.Pq(0,0,0),this._globalOffset=new s.Pq(0,0,0),this._inertialPanning=s.Pq.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const r=.01*e*this.wheelDeltaPercentage*t;return i=e>0?r/(1+this.wheelDeltaPercentage):r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=re.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==xe.Zp.POINTERWHEEL)return;const i=t.event;let r=0;const n=i.deltaMode===tt.s.DOM_DELTA_LINE?40:1,s=-i.deltaY*n;if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(s,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(s,this.camera.radius),r>0){let e=this.camera.radius,t=this.camera.inertialRadiusOffset+r;for(let i=0;i<20&&Math.abs(t)>.001;i++)e-=t,t*=this.camera.inertia;e=(0,it.Clamp)(e,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(s,e)}}else r=s/(40*this.wheelPrecision);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,xe.Zp.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=et.Z.FromPositionAndNormal(e.target,t)}_getPosition(){const e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,s.uq.Identity(),e,!1);0===e.targetScreenOffset.x&&0===e.targetScreenOffset.y||(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=s.Pq.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(r))}_zoomToMouse(e){const t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){const r=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<r&&(e=(t.radius-r)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){const r=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>r&&(e=(t.radius-r)*i-t.inertialRadiusOffset)}const r=e/i/t.radius,n=this._getPosition(),a=s.AA.Vector3[6];n.subtractToRef(t.target,a),a.scaleInPlace(r),a.scaleInPlace(i),this._inertialPanning.addInPlace(a),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<Ee.bH&&(e.x=0),Math.abs(e.y)<Ee.bH&&(e.y=0),Math.abs(e.z)<Ee.bH&&(e.z=0)}}(0,ue.Cg)([(0,de.lK)()],rt.prototype,"wheelPrecision",void 0),(0,ue.Cg)([(0,de.lK)()],rt.prototype,"zoomToMouseLocation",void 0),(0,ue.Cg)([(0,de.lK)()],rt.prototype,"wheelDeltaPercentage",void 0),qe.H.ArcRotateCameraMouseWheelInput=rt;class nt extends Xe.R{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||nt.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(t-e)*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,n,s){0===i&&null===n||0===r&&null===s||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(n,s)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(n,s)):this.multiTouchPanning?this._computeMultiTouchPanning(n,s):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}nt.MinimumRadiusForPinch=.001,(0,ue.Cg)([(0,de.lK)()],nt.prototype,"buttons",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"angularSensibilityX",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"angularSensibilityY",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"pinchPrecision",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"pinchDeltaPercentage",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"useNaturalPinchZoom",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"pinchZoom",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"panningSensibility",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"multiTouchPanning",void 0),(0,ue.Cg)([(0,de.lK)()],nt.prototype,"multiTouchPanAndZoom",void 0),qe.H.ArcRotateCameraPointersInput=nt;class st extends qe._{constructor(e){super(e)}addMouseWheel(){return this.add(new rt),this}addPointers(){return this.add(new nt),this}addKeyboard(){return this.add(new Je),this}}st.prototype.addVRDeviceOrientation=function(){return this.add(new at),this};class at{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=re.S0.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t.addEventListener("deviceorientation",this._deviceOrientationHandler):re.S0.Warn("Permission not granted.")})).catch((e=>{re.S0.Error(e)})):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|+e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|+e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}qe.H.ArcRotateCameraVRDeviceOrientationInput=at;class ot{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=re.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(t.type===Qe.TB.KEYDOWN)-1===this.keysForward.indexOf(i.keyCode)&&-1===this.keysBackward.indexOf(i.keyCode)&&-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();-1!==this.keysForward.indexOf(i)?e._localDirection.copyFromFloats(0,0,r):-1!==this.keysBackward.indexOf(i)?e._localDirection.copyFromFloats(0,0,-r):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,r,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,-r,0):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(r,0,0):-1!==this.keysLeft.indexOf(i)&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),s.Pq.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}(0,ue.Cg)([(0,de.lK)()],ot.prototype,"keysForward",void 0),(0,ue.Cg)([(0,de.lK)()],ot.prototype,"keysBackward",void 0),(0,ue.Cg)([(0,de.lK)()],ot.prototype,"keysUp",void 0),(0,ue.Cg)([(0,de.lK)()],ot.prototype,"keysDown",void 0),(0,ue.Cg)([(0,de.lK)()],ot.prototype,"keysRight",void 0),(0,ue.Cg)([(0,de.lK)()],ot.prototype,"keysLeft",void 0),qe.H.FlyCameraKeyboardInput=ot;class lt{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=re.S0.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver((e=>{this._pointerInput(e)}),xe.Zp.POINTERDOWN|xe.Zp.POINTERUP|xe.Zp.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add((()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)}))}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,i=this.camera.getEngine();if(!this.touchEnabled&&"touch"===t.pointerType)return;if(e.type!==xe.Zp.POINTERMOVE&&-1===this.buttons.indexOf(t.button))return;const r=t.target;if(e.type===xe.Zp.POINTERDOWN){try{r?.setPointerCapture(t.pointerId)}catch(t){}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||t.preventDefault(),i.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===xe.Zp.POINTERUP){try{r?.releasePointerCapture(t.pointerId)}catch(t){}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===xe.Zp.POINTERMOVE){if(!this._previousPosition)return void(i.isPointerLock&&this._onMouseMove(e.event));const r=t.clientX-this._previousPosition.x,n=t.clientY-this._previousPosition.y;this._rotateCamera(r,n),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;const t=e.movementX,i=e.movementY;this._rotateCamera(t,i),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera,r=(e*=i._calculateHandednessMultiplier())/this.angularSensibility,n=t/this.angularSensibility,a=s.PT.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let o;if(this.buttonsPitch.some((e=>e===this.activeButton))&&(o=s.PT.RotationAxis(ke._0.X,n),a.multiplyInPlace(o)),this.buttonsYaw.some((e=>e===this.activeButton))){o=s.PT.RotationAxis(ke._0.Y,r),a.multiplyInPlace(o);const e=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-e<i.rotation.z&&i.rotation.z<e){const e=i.bankedTurnMultiplier*-r;o=s.PT.RotationAxis(ke._0.Z,e),a.multiplyInPlace(o)}}this.buttonsRoll.some((e=>e===this.activeButton))&&(o=s.PT.RotationAxis(ke._0.Z,-r),i._trackRoll-=r,a.multiplyInPlace(o)),a.toEulerAnglesToRef(i.rotation)}}(0,ue.Cg)([(0,de.lK)()],lt.prototype,"buttons",void 0),(0,ue.Cg)([(0,de.lK)()],lt.prototype,"angularSensibility",void 0),qe.H.FlyCameraMouseInput=lt;var ct=i(70983),ht=i(50681),ut=i(95149),dt=i(90392);dt.s.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new pt,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class pt{static WaitForOrientationChangeAsync(e){return new Promise(((t,i)=>{let r=!1;const n=()=>{window.removeEventListener("deviceorientation",n),r=!0,t()};e&&setTimeout((()=>{r||(window.removeEventListener("deviceorientation",n),i("WaitForOrientationChangeAsync timed out"))}),e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e?window.addEventListener("deviceorientation",n):re.S0.Warn("Permission not granted.")})).catch((e=>{re.S0.Error(e)})):window.addEventListener("deviceorientation",n)}))}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new s.PT,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new n.cP,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-re.S0.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?re.S0.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?re.S0.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?re.S0.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new s.PT(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new s.PT),this._camera&&this._camera.onDisposeObservable.add((()=>{this._onDeviceOrientationChangedObservable.clear()}))}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t():re.S0.Warn("Permission not granted.")})).catch((e=>{re.S0.Error(e)})):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(s.PT.RotationYawPitchRollToRef(re.S0.ToRadians(this._alpha),re.S0.ToRadians(this._beta),-re.S0.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}qe.H.FreeCameraDeviceOrientationInput=pt;class ft{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=s.uq.Identity(),this._deltaTransform=s.Pq.Zero(),this._vector3=s.Pq.Zero(),this._vector2=s.I9.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==je.POSE_ENABLED&&(this.gamepad&&e.type!==je.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(je.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):s.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const r=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*r,0,-t.y*r),s.Pq.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}(0,ue.Cg)([(0,de.lK)()],ft.prototype,"gamepadAngularSensibility",void 0),(0,ue.Cg)([(0,de.lK)()],ft.prototype,"gamepadMoveSensibility",void 0),qe.H.FreeCameraGamepadInput=ft;var mt,_t=i(29978),gt=i(64081),vt=i(20548),St=i(46797),xt=i(91132);!function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(mt||(mt={}));class Tt{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;const i={...Tt._GetDefaultOptions(),...t};if(this._leftJoystick=!!e,Tt._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new xt.w,this.deltaPosition=s.Pq.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{Tt._VJCanvasWidth=window.innerWidth,Tt._VJCanvasHeight=window.innerHeight,Tt.Canvas&&(Tt.Canvas.width=Tt._VJCanvasWidth,Tt.Canvas.height=Tt._VJCanvasHeight),Tt._HalfWidth=Tt._VJCanvasWidth/2},!Tt.Canvas){window.addEventListener("resize",this._onResize,!1),Tt.Canvas=document.createElement("canvas"),Tt._VJCanvasWidth=window.innerWidth,Tt._VJCanvasHeight=window.innerHeight,Tt.Canvas.width=window.innerWidth,Tt.Canvas.height=window.innerHeight,Tt.Canvas.style.width="100%",Tt.Canvas.style.height="100%",Tt.Canvas.style.position="absolute",Tt.Canvas.style.backgroundColor="transparent",Tt.Canvas.style.top="0px",Tt.Canvas.style.left="0px",Tt.Canvas.style.zIndex="5",Tt.Canvas.style.touchAction="none",Tt.Canvas.setAttribute("touch-action","none");const e=Tt.Canvas.getContext("2d");if(!e)throw new Error("Unable to create canvas for virtual joystick");Tt._VJCanvasContext=e,Tt._VJCanvasContext.strokeStyle="#ffffff",Tt._VJCanvasContext.lineWidth=2,document.body.appendChild(Tt.Canvas)}Tt._HalfWidth=Tt.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&Tt._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new s.I9(0,0),this._joystickPreviousPointerPos=new s.I9(0,0),this._joystickPointerStartPos=new s.I9(0,0),this._deltaJoystickVector=new s.I9(0,0),this._onPointerDownHandlerRef=e=>{this._onPointerDown(e)},this._onPointerMoveHandlerRef=e=>{this._onPointerMove(e)},this._onPointerUpHandlerRef=e=>{this._onPointerUp(e)},Tt.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),Tt.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),Tt.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),Tt.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),Tt.Canvas.addEventListener("pointercancel",this._onPointerUpHandlerRef,!1),Tt.Canvas.addEventListener("contextmenu",(e=>{e.preventDefault()}),!1),requestAnimationFrame((()=>{this._drawVirtualJoystick()}))}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),t=!0===this._leftJoystick?e.clientX<Tt._HalfWidth:e.clientX>Tt._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):Tt._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const t=new s.I9(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),i=t.length();i>this.containerSize&&t.scaleInPlace(this.containerSize/i),this._joystickPointerPos.x=this._joystickPointerStartPos.x+t.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+t.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<Tt._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(Tt._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(Tt._HalfWidth,this._joystickPointerPos.x));const t=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,t));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,t));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,t))}const i=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&Tt._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(2.1*this._joystickContainerSize),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(2.1*this._joystickPuckSize),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(Tt._AlwaysVisibleSticks++,this._alwaysVisible=!0):(Tt._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new s.I9(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=0}}setAxisForUpDown(e){switch(e){case 0:case 1:case 2:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=1}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;Tt._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),Tt._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?Tt._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,2*this.containerSize,2*this.containerSize):(Tt._VJCanvasContext.beginPath(),Tt._VJCanvasContext.strokeStyle=this._joystickColor,Tt._VJCanvasContext.lineWidth=2,Tt._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,2*Math.PI,!0),Tt._VJCanvasContext.stroke(),Tt._VJCanvasContext.closePath(),Tt._VJCanvasContext.beginPath(),Tt._VJCanvasContext.lineWidth=6,Tt._VJCanvasContext.strokeStyle=this._joystickColor,Tt._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,2*Math.PI,!0),Tt._VJCanvasContext.stroke(),Tt._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?Tt._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,2*this.puckSize,2*this.puckSize):(Tt._VJCanvasContext.beginPath(),Tt._VJCanvasContext.strokeStyle=this._joystickColor,Tt._VJCanvasContext.lineWidth=2,Tt._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,2*Math.PI,!0),Tt._VJCanvasContext.stroke(),Tt._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach(((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(Tt._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),Tt._VJCanvasContext.beginPath(),Tt._VJCanvasContext.fillStyle="white",Tt._VJCanvasContext.beginPath(),Tt._VJCanvasContext.strokeStyle="red",Tt._VJCanvasContext.lineWidth=6,Tt._VJCanvasContext.arc(t.x,t.y,40,0,2*Math.PI,!0),Tt._VJCanvasContext.stroke(),Tt._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)})),requestAnimationFrame((()=>{this._drawVirtualJoystick()})))}releaseCanvas(){Tt.Canvas&&(Tt.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),Tt.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),Tt.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),Tt.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),Tt.Canvas.removeEventListener("pointercancel",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(Tt.Canvas),Tt.Canvas=null),this._released=!0}}Tt._GlobalJoystickIndex=0,Tt._AlwaysVisibleSticks=0,dt.s.prototype.addVirtualJoystick=function(){return this.add(new Et),this};class Et{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=50*e._computeLocalCameraSpeed(),i=s.uq.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=s.Pq.TransformCoordinates(new s.Pq(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new Tt(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new Tt(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}qe.H.FreeCameraVirtualJoystickInput=Et;var Ct=i(63832),bt=i(63825),Pt=i(87562),yt=i(69346);yt.b.AddNodeConstructor("TouchCamera",((e,t)=>()=>new At(e,s.Pq.Zero(),t)));class At extends Pt.S{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}}var Rt=i(9191);yt.b.AddNodeConstructor("ArcRotateCamera",((e,t)=>()=>new It(e,0,0,1,s.Pq.Zero(),t)));class It extends bt.F{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new s.uq,this._upToYMatrix=new s.uq,this._upVector=s.Pq.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){s.uq.RotationAlignToRef(s.Pq.UpReadOnly,this._upVector,this._yToUpMatrix),s.uq.RotationAlignToRef(this._upVector,s.Pq.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return!!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return!!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new be,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Pe,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new Ce,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,a,o,l=!0){super(e,s.Pq.Zero(),o,l),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=s.Pq.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=s.I9.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._currentInterpolationFactor=0,this._viewMatrix=new s.uq,this.panningAxis=new s.Pq(1,1,0),this._transformedDirection=new s.Pq,this.mapPanning=!1,this._progressiveRestore=!1,this.onMeshTargetChangedObservable=new n.cP,this.checkCollisions=!1,this.collisionRadius=new s.Pq(.5,.5,.5),this._previousPosition=s.Pq.Zero(),this._collisionVelocity=s.Pq.Zero(),this._newPosition=s.Pq.Zero(),this._computationVector=s.Pq.Zero(),this._onCollisionPositionChange=(e,t,i=null)=>{i?(this.setPosition(t),this.onCollide&&this.onCollide(i)):this._previousPosition.copyFrom(this._position);const r=Math.cos(this.alpha),n=Math.sin(this.alpha),s=Math.cos(this.beta);let a=Math.sin(this.beta);0===a&&(a=1e-4);const o=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*r*a,this.radius*s,this.radius*n*a),o.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let l=this.upVector;this.allowUpsideDown&&this.beta<0&&(l=l.clone(),l=l.negate()),this._computeViewMatrix(this._position,o,l),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=s.Pq.Zero(),a&&this.setTarget(a),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new st(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=s.I9.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const e=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?e.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(e)}return this._getLockedTargetPosition()||this._target}storeState(){return this._storedAlpha=this._goalAlpha=this.alpha,this._storedBeta=this._goalBeta=this.beta,this._storedRadius=this._goalRadius=this.radius,this._storedTarget=this._goalTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this._goalTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>Ee.bH&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset,this.restoreStateInterpolationFactor),!0):!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}interpolateTo(e=this.alpha,t=this.beta,i=this.radius,r=this.target,n=this.targetScreenOffset,s){this._progressiveRestore=!0,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,null!=s?this._currentInterpolationFactor=s:0!==this.restoreStateInterpolationFactor?this._currentInterpolationFactor=this.restoreStateInterpolationFactor:this._currentInterpolationFactor=.1,e=(0,it.Clamp)(e,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),t=(0,it.Clamp)(t,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),i=(0,it.Clamp)(i,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),this._goalAlpha=e,this._goalBeta=t,this._goalRadius=i,this._goalTarget=r,this._goalTargetScreenOffset=n}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)}attachControl(e,t,i=!0,r=2){const n=arguments;t=re.S0.BackCompatCameraNoPreventDefault(n),this._useCtrlForPanning=i,this._panningMouseButton=r,"boolean"==typeof n[0]&&(n.length>1&&(this._useCtrlForPanning=n[1]),n.length>2&&(this._panningMouseButton=n[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this._progressiveRestore){const e=this._scene.getEngine().getDeltaTime()/1e3,t=1-Math.pow(2,-e/this._currentInterpolationFactor);this.setTarget(s.Pq.Lerp(this.getTarget(),this._goalTarget,t)),s.PT.RotationAlphaBetaGammaToRef(this._goalAlpha,this._goalBeta,0,s.AA.Quaternion[0]),s.PT.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,s.AA.Quaternion[1]),s.PT.SlerpToRef(s.AA.Quaternion[1],s.AA.Quaternion[0],t,s.AA.Quaternion[2]),s.AA.Quaternion[2].normalize(),s.AA.Quaternion[2].toAlphaBetaGammaToRef(s.AA.Vector3[0]),this.alpha=s.AA.Vector3[0].x,this.beta=s.AA.Vector3[0].y,this.radius+=(this._goalRadius-this.radius)*t,s.I9.LerpToRef(this.targetScreenOffset,this._goalTargetScreenOffset,t,this.targetScreenOffset),(s.Pq.DistanceSquared(this.getTarget(),this._goalTarget)<Ee.bH&&s.AA.Quaternion[2].equalsWithEpsilon(s.AA.Quaternion[0])&&Math.pow(this._goalRadius-this.radius,2)<Ee.bH&&s.I9.Distance(this.targetScreenOffset,this._goalTargetScreenOffset)<Ee.bH||0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset||0!==this.inertialPanningX||0!==this.inertialPanningY)&&(this._progressiveRestore=!1)}if(0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<Ee.bH&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<Ee.bH&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*Ee.bH&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){const e=new s.Pq(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),s.Pq.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const e=this.upVector,t=s.Pq.CrossToRef(this._transformedDirection,e,this._transformedDirection);s.Pq.CrossToRef(e,t,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),s.Pq.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){const e=s.AA.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(e),e.transposeToRef(e),s.Pq.TransformCoordinatesToRef(this._transformedDirection,e,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*Ee.bH&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*Ee.bH&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||s.Pq.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);const e=this.alpha;0===this._computationVector.x&&0===this._computationVector.z?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const t=e,r=this._getTargetPosition();if(r&&!i&&r.equals(t))return;this._targetHost=null,this._target=t,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let r=Math.sin(this.beta);0===r&&(r=1e-4),0===this.radius&&(this.radius=1e-4);const n=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||s.Pq.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),n.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const e=this.getScene().collisionCoordinator;this._collider||(this._collider=e.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,e.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let e=this.upVector;this.allowUpsideDown&&r<0&&(e=e.negate()),this._computeViewMatrix(this._position,n,e),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=n,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=Rt.e.MinMax(e);let r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(void 0===e.min){const t=e||this.getScene().meshes;i=Rt.e.MinMax(t),r=s.Pq.Distance(i.min,i.max)}else i=e,r=e.distance;this._target=Rt.e.Center(i),t||(this.maxZ=2*r)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Ct.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ct.i.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ct.i.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ct.i.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1)}const r=new It(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Ct.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ct.i.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ct.i.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ct.i.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const r=s.Pq.Distance(e,t),n=this.getScene().getEngine().getAspectRatio(this),a=Math.tan(this.fov/2),o=a*n,l=.5*r*i,c=l*Math.sqrt(1+1/(o*o)),h=l*Math.sqrt(1+1/(a*a));return Math.max(c,h)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}(0,ue.Cg)([(0,de.lK)()],It.prototype,"alpha",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"beta",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"radius",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"overrideCloneAlphaBetaRadius",void 0),(0,ue.Cg)([(0,de.P_)("target")],It.prototype,"_target",void 0),(0,ue.Cg)([(0,de.xG)("targetHost")],It.prototype,"_targetHost",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"inertialAlphaOffset",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"inertialBetaOffset",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"inertialRadiusOffset",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"lowerAlphaLimit",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"upperAlphaLimit",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"lowerBetaLimit",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"upperBetaLimit",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"lowerRadiusLimit",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"upperRadiusLimit",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"inertialPanningX",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"inertialPanningY",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"pinchToPanMaxDistance",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"panningDistanceLimit",void 0),(0,ue.Cg)([(0,de.P_)()],It.prototype,"panningOriginTarget",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"panningInertia",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"zoomToMouseLocation",null),(0,ue.Cg)([(0,de.lK)()],It.prototype,"zoomOnFactor",void 0),(0,ue.Cg)([(0,de.WM)()],It.prototype,"targetScreenOffset",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"allowUpsideDown",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"useInputToRestoreState",void 0),(0,ue.Cg)([(0,de.lK)()],It.prototype,"restoreStateInterpolationFactor",void 0),(0,o.Y5)("BABYLON.ArcRotateCamera",It),yt.b.AddNodeConstructor("DeviceOrientationCamera",((e,t)=>()=>new Mt(e,s.Pq.Zero(),t)));class Mt extends Pt.S{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new s.PT,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new s.PT,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce((()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add((e=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new s.PT),s.PT.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))})))}))}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=ke._0.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new s.PT),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach((t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0})),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Ot extends qe._{constructor(e){super(e)}addKeyboard(){return this.add(new ot),this}addMouse(){return this.add(new lt),this}}class Nt extends bt.F{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new s.Pq(1,1,1),this.ellipsoidOffset=new s.Pq(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=s.Pq.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=s.Pq.Zero(),this._diffPosition=s.Pq.Zero(),this._newPosition=s.Pq.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{(e=>{this._newPosition.copyFrom(e),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>ne.$.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&i&&this.onCollide(i))})(t)},this.inputs=new Ot(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=re.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new s.Pq(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?s.Pq.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=s.Pq.Zero(),this._transformedDirection=s.Pq.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=t-this.rotation.z;Math.abs(i)>=.001&&(this.rotation.z+=i/e,Math.abs(t-this.rotation.z)<=.001&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}(0,ue.Cg)([(0,de.P_)()],Nt.prototype,"ellipsoid",void 0),(0,ue.Cg)([(0,de.P_)()],Nt.prototype,"ellipsoidOffset",void 0),(0,ue.Cg)([(0,de.lK)()],Nt.prototype,"checkCollisions",void 0),(0,ue.Cg)([(0,de.lK)()],Nt.prototype,"applyGravity",void 0),(0,o.Y5)("BABYLON.FlyCamera",Nt);var Dt,Ft,Lt,wt,Bt=i(85709),Vt=i(16425),kt=i(86521),Gt=i(43981),Ut=i(38474);!function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(Dt||(Dt={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(Ft||(Ft={}));class zt extends je{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new n.cP,this.onButtonUpObservable=new n.cP,this.onPadDownObservable=new n.cP,this.onPadUpObservable=new n.cP,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=je.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,4)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}!function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(Lt||(Lt={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(wt||(wt={}));class Wt extends je{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new n.cP,this.onButtonUpObservable=new n.cP,this.onPadDownObservable=new n.cP,this.onPadUpObservable=new n.cP,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=je.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class Ht{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new n.cP,(0,Ut.BA)()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new n.cP((e=>{for(const t in this._babylonGamepads){const i=this._babylonGamepads[t];i&&i._isConnected&&this.onGamepadConnectedObservable.notifyObserver(e,i)}})),this._onGamepadConnectedEvent=e=>{const t=e.gamepad;if(t.index in this._babylonGamepads&&this._babylonGamepads[t.index].isConnected)return;let i;this._babylonGamepads[t.index]?(i=this._babylonGamepads[t.index],i.browserGamepad=t,i._isConnected=!0):i=this._addNewGamepad(t),this.onGamepadConnectedObservable.notifyObservers(i),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=e=>{const t=e.gamepad;for(const e in this._babylonGamepads)if(this._babylonGamepads[e].index===t.index){const t=this._babylonGamepads[e];t._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(t),t.dispose&&t.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const e=this._scene?this._scene.getEngine().getHostWindow():window;e&&(e.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),e.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=je.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach((e=>{e.dispose()})),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),r=-1!==e.id.search("Xbox One");return t=r||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new zt(e.id,e.index,e,r):i?new Wt(e.id,e.index,e):new Ke(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch{-1===this._loggedErrors.indexOf(t.index)&&(re.S0.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&ne.$.QueueNewFrame((()=>{this._checkGamepadsStatus()}))}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const e=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(e)}}}}Object.defineProperty(kt.Z.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Ht(this);let e=this._getComponent(Gt.v.NAME_GAMEPAD);e||(e=new Yt(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),dt.s.prototype.addGamepad=function(){return this.add(new ft),this},st.prototype.addGamepad=function(){return this.add(new Ze),this};class Yt{constructor(e){this.name=Gt.v.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}}yt.b.AddNodeConstructor("FreeCamera",((e,t)=>()=>new Xt(e,s.Pq.Zero(),t)));class Xt extends At{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}Ct.i._CreateDefaultParsedCamera=(e,t)=>new Xt(e,s.Pq.Zero(),t),yt.b.AddNodeConstructor("GamepadCamera",((e,t)=>()=>new qt(e,s.Pq.Zero(),t)));class qt extends Xt{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}var $t=i(63176),jt=i(71015);class Kt extends jt.w{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,n,s){super(e,"anaglyph",null,["leftSampler"],t,i[1],r,n,s),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,42054)))):t.push(Promise.resolve().then(i.bind(i,59527))),super._gatherImports(e,t)}}function Zt(e){e._rigCameras[0]._rigPostProcess=new $t.v(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new Kt(e.name+"_anaglyph",1,e._rigCameras)}(0,o.Y5)("BABYLON.AnaglyphPostProcess",Kt),yt.b.AddNodeConstructor("AnaglyphArcRotateCamera",((e,t,i)=>()=>new Qt(e,0,0,1,s.Pq.Zero(),i.interaxial_distance,t)));class Qt extends It{constructor(e,t,i,r,n,s,a){super(e,t,i,r,n,a),this._setRigMode=()=>Zt(this),this.interaxialDistance=s,this.setCameraRigMode(Ct.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:s})}getClassName(){return"AnaglyphArcRotateCamera"}}yt.b.AddNodeConstructor("AnaglyphFreeCamera",((e,t,i)=>()=>new Jt(e,s.Pq.Zero(),i.interaxial_distance,t)));class Jt extends Pt.S{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Zt(this),this.interaxialDistance=i,this.setCameraRigMode(Ct.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}yt.b.AddNodeConstructor("AnaglyphGamepadCamera",((e,t,i)=>()=>new ei(e,s.Pq.Zero(),i.interaxial_distance,t)));class ei extends qt{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Zt(this),this.interaxialDistance=i,this.setCameraRigMode(Ct.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}yt.b.AddNodeConstructor("AnaglyphUniversalCamera",((e,t,i)=>()=>new ti(e,s.Pq.Zero(),i.interaxial_distance,t)));class ti extends Xt{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Zt(this),this.interaxialDistance=i,this.setCameraRigMode(Ct.i.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}var ii=i(94554),ri=i(43862);ri.l.ShadersStore.stereoscopicInterlacePixelShader="const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);}\n";class ni extends jt.w{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,n,a,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],n,a,o,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new s.I9(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new s.I9(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}class si extends jt.w{getClassName(){return"StereoscopicInterlacePostProcess"}constructor(e,t,i,r,n,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],r,n,a,i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new s.I9(1/this.width,1/this.height),this.onSizeChangedObservable.add((()=>{this._stepSize=new s.I9(1/this.width,1/this.height)})),this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)}))}}function ai(e){const t=e.cameraRigMode===Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||e.cameraRigMode===Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,i=e.cameraRigMode===Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;e.cameraRigMode===Ct.i.RIG_MODE_STEREOSCOPIC_INTERLACED?(e._rigCameras[0]._rigPostProcess=new $t.v(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new ni(e.name+"_stereoInterlace",e._rigCameras,!1,!0)):(e._rigCameras[i?1:0].viewport=new ii.L(0,0,t?.5:1,t?1:.5),e._rigCameras[i?0:1].viewport=new ii.L(t?.5:0,t?0:.5,t?.5:1,t?1:.5))}yt.b.AddNodeConstructor("StereoscopicArcRotateCamera",((e,t,i)=>()=>new oi(e,0,0,1,s.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class oi extends It{constructor(e,t,i,r,n,s,a,o){super(e,t,i,r,n,o),this._setRigMode=()=>ai(this),this.interaxialDistance=s,this.isStereoscopicSideBySide=a,this.setCameraRigMode(a?Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ct.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:s})}getClassName(){return"StereoscopicArcRotateCamera"}}yt.b.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new li(e,s.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class li extends Pt.S{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>ai(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ct.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}yt.b.AddNodeConstructor("StereoscopicGamepadCamera",((e,t,i)=>()=>new ci(e,s.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class ci extends qt{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>ai(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ct.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}yt.b.AddNodeConstructor("StereoscopicFreeCamera",((e,t,i)=>()=>new hi(e,s.Pq.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t)));class hi extends Xt{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>ai(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ct.i.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}var ui=i(34116);class di extends Xt{set distanceBetweenEyes(e){this._distanceBetweenEyes=e}get distanceBetweenEyes(){return this._distanceBetweenEyes}set distanceToProjectionPlane(e){this._distanceToProjectionPlane=e}get distanceToProjectionPlane(){return this._distanceToProjectionPlane}constructor(e,t,i,r=1,n=.065){super(e,t,i),this._distanceBetweenEyes=n,this._distanceToProjectionPlane=r,this.setCameraRigMode(Ct.i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL,{stereoHalfAngle:0}),this._cameraRigParams.stereoHalfAngle=0,this._cameraRigParams.interaxialDistance=n}getClassName(){return"StereoscopicUniversalCamera"}createRigCamera(e){const t=new bt.F(e,s.Pq.Zero(),this.getScene()),i=new ui.V("tm_"+e,this.getScene());return t.parent=i,i.setPivotMatrix(s.uq.Identity(),!1),t.isRigCamera=!0,t.rigParent=this,t}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++){const t=this._rigCameras[e];t.minZ=this.minZ,t.maxZ=this.maxZ,t.fov=this.fov,t.upVector.copyFrom(this.upVector),t.rotationQuaternion?t.rotationQuaternion.copyFrom(this.rotationQuaternion):t.rotation.copyFrom(this.rotation),this._updateCamera(this._rigCameras[e],e)}}_updateCamera(e,t){const i=this.distanceBetweenEyes/2,r=i/this.distanceToProjectionPlane;e.position.copyFrom(this.position),e.position.addInPlaceFromFloats(0===t?-i:i,0,-this._distanceToProjectionPlane);const n=e.parent,s=n.getPivotMatrix();s.setTranslationFromFloats(0===t?i:-i,0,0),s.setRowFromFloats(2,0===t?r:-r,0,1,0),n.setPivotMatrix(s,!1)}_setRigMode(){this._rigCameras[0].viewport=new ii.L(0,0,.5,1),this._rigCameras[1].viewport=new ii.L(.5,0,.5,1);for(let e=0;e<this._rigCameras.length;e++)this._updateCamera(this._rigCameras[e],e)}}yt.b.AddNodeConstructor("VirtualJoysticksCamera",((e,t)=>()=>new pi(e,s.Pq.Zero(),t)));class pi extends Pt.S{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class fi{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return s.uq.Translation(e,0,0)}get rightHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return s.uq.Translation(-e,0,0)}get leftPreViewMatrix(){return s.uq.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return s.uq.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new fi;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class mi extends jt.w{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,_e.g.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this._scaleIn=new s.I9(2,2/this.aspectRatio),this._scaleFactor=new s.I9(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new s.I9(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)})),this.onApplyObservable.add((e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,68479)))):t.push(Promise.resolve().then(i.bind(i,18842))),super._gatherImports(e,t)}}ri.l.ShadersStore.vrMultiviewToSingleviewPixelShader="precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}";var _i=i(74084),gi=i(58478),vi=i(55179),Si=i(36590);class xi extends Si.${set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}var Ti=i(75184);function Ei(e,t){const i=new vi.D(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}_i.N.prototype.createMultiviewRenderTargetTexture=function(e,t,i,r){const n=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const s=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});s._framebuffer=n.createFramebuffer();const a=new gi.hV(this,0,!0);return a.width=e,a.height=t,a.isMultiview=!0,i||(i=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,i),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.RGBA8,e,t,2)),s._colorTextureArray=i,r||(r=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,r),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.DEPTH24_STENCIL8,e,t,2)),s._depthStencilTextureArray=r,a.isReady=!0,s.setTextures(a),s._depthStencilTexture=a,s},_i.N.prototype.bindMultiviewFramebuffer=function(e){const t=e,i=this._gl,r=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(r.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,t.samples,0,2),r.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,t.samples,0,2)):(r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,0,2))},_i.N.prototype.bindSpaceWarpFramebuffer=function(e){const t=e,i=this._gl,r=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw new Error("Invalid Space Warp framebuffer");r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),r.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_ATTACHMENT,t._depthStencilTextureArray,0,0,2)},Ct.i.prototype._useMultiviewToSingleView=!1,Ct.i.prototype._multiviewTexture=null,Ct.i.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?this._multiviewTexture.getRenderWidth()==e&&this._multiviewTexture.getRenderHeight()==t||(this._multiviewTexture.dispose(),this._multiviewTexture=new xi(this.getScene(),{width:e,height:t})):this._multiviewTexture=new xi(this.getScene(),{width:e,height:t})};const Ci=kt.Z.prototype.createSceneUniformBuffer;kt.Z.prototype._transformMatrixR=s.uq.Zero(),kt.Z.prototype._multiviewSceneUbo=null,kt.Z.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=Ei(this.getEngine(),"scene_multiview")},kt.Z.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?Ei(this.getEngine(),e):Ci.bind(this)(e)},kt.Z.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,s.AA.Matrix[0]),Ti.P.GetRightPlaneToRef(s.AA.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},kt.Z.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){const i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class bi extends jt.w{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,_e.g.BILINEAR_SAMPLINGMODE);const r=t??this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((e=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",r._multiviewTexture)}))}}function Pi(e,t){const i=t.vrCameraMetrics||fi.GetDefault();e._rigCameras[0]._cameraRigParams.vrMetrics=i,e._rigCameras[0].viewport=new ii.L(0,0,.5,1),e._rigCameras[0]._cameraRigParams.vrWorkMatrix=new s.uq,e._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,e._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,e._rigCameras[0].getProjectionMatrix=e._rigCameras[0]._getVRProjectionMatrix,e._rigCameras[1]._cameraRigParams.vrMetrics=i,e._rigCameras[1].viewport=new ii.L(.5,0,.5,1),e._rigCameras[1]._cameraRigParams.vrWorkMatrix=new s.uq,e._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,e._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,e._rigCameras[1].getProjectionMatrix=e._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(e.getScene().getEngine().getCaps().multiview?(e._useMultiviewToSingleView=!0,e._rigPostProcess=new bi("VRMultiviewToSingleview",e,i.postProcessScaleFactor)):(f.V.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(e._rigCameras[0]._rigPostProcess=new mi("VR_Distort_Compensation_Left",e._rigCameras[0],!1,i),e._rigCameras[1]._rigPostProcess=new mi("VR_Distort_Compensation_Right",e._rigCameras[1],!0,i))}yt.b.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",((e,t)=>()=>new yi(e,0,0,1,s.Pq.Zero(),t)));class yi extends It{constructor(e,t,i,r,n,s,a=!0,o=fi.GetDefault()){super(e,t,i,r,n,s),this._setRigMode=e=>Pi(this,e),o.compensateDistortion=a,this.setCameraRigMode(Ct.i.RIG_MODE_VR,{vrCameraMetrics:o}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}yt.b.AddNodeConstructor("VRDeviceOrientationFreeCamera",((e,t)=>()=>new Ai(e,s.Pq.Zero(),t)));class Ai extends Mt{constructor(e,t,i,r=!0,n=fi.GetDefault()){super(e,t,i),this._setRigMode=e=>Pi(this,e),n.compensateDistortion=r,this.setCameraRigMode(Ct.i.RIG_MODE_VR,{vrCameraMetrics:n})}getClassName(){return"VRDeviceOrientationFreeCamera"}}yt.b.AddNodeConstructor("VRDeviceOrientationGamepadCamera",((e,t)=>()=>new Ri(e,s.Pq.Zero(),t)));class Ri extends Ai{constructor(e,t,i,r=!0,n=fi.GetDefault()){super(e,t,i,r,n),this._setRigMode=e=>Pi(this,e),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}var Ii=i(1675),Mi=i(53005),Oi=i(78065),Ni=i(41e3);class Di{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,n){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=n,this._rttWrapper=null}}var Fi=i(19976);class Li{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new gi.hV(this._engine,0,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new Fi.d(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,n,s){if(!this._engine)throw new Error("Engine is disposed");const a={width:e,height:t},o=s?new xi(this._scene,a):new Si.$("XR renderTargetTexture",a,this._scene),l=o.renderTarget;if(l._samples=o.samples,!i&&r||(l._framebuffer=i),r)if(s)l._colorTextureArray=r;else{const e=this._createInternalTexture(a,r);l.setTexture(e,0),o._texture=e}return n&&(s?l._depthStencilTextureArray=n:l._depthStencilTexture=this._createInternalTexture(a,n)),o.disableRescaling(),this._renderTargetTextures.push(o),o}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.length=0}}class wi extends Di{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Bi(e.scene,this))),this.layer=e}}class Bi extends Li{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const r=this._framebufferDimensions.framebufferWidth,n=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/n,e.width=i.width/r,e.height=i.height/n,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return this._rtt&&t===this._framebufferDimensions.framebufferWidth&&i===this._framebufferDimensions.framebufferHeight&&r===this._framebuffer||(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Vi{static GetDefaults(e){const t=new Vi;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class ki{constructor(e,t=Vi.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new n.cP,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const e=document.createElement("canvas");e.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(e)}e.onXRSessionInit.add((()=>{this._addCanvas()})),e.onXRSessionEnded.add((()=>{this._removeCanvas()})),this._makeCanvasCompatibleAsync()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null),this.onXRLayerInitObservable.clear()}_makeCanvasCompatibleAsync(){this._canvasCompatiblePromise=new Promise(((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then((()=>{e()}),(()=>{re.S0.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()})):e()}catch(e){t(e)}}))}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new wi(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this._canvasCompatiblePromise.then((()=>{}),(()=>{})).then((()=>t()))}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce((()=>{this._setCanvasSize(!0)}))}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){this._canvas&&this._engine&&(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class Gi extends Di{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Ui(e,this))),this.layer=e}}class Ui extends Li{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class zi{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class Wi{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){const t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new n.cP,this.onXRReferenceSpaceChanged=new n.cP,this.onXRSessionEnded=new n.cP,this.onXRSessionInit=new n.cP,this.onXRReferenceSpaceInitialized=new n.cP,this.onXRReady=new n.cP,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new n.cP(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRReady.clear(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}async exitXRAsync(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return await this.session.end()}catch{f.V.Warn("Could not end XR session.")}}return Promise.resolve()}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new zi(this):((e=e||Vi.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new ki(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then((t=>(this.session=t,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(t),this.session.addEventListener("end",(()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null}),{once:!0}),this.session)))}isSessionSupportedAsync(e){return Wi.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){this.inXRSession&&this._engine&&(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(this.inXRSession&&this._engine&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;const e=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==e&&(this._engine.framebufferDimensionsObject=e),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce((()=>{this.onXRReady.notifyObservers(this)})),"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then((e=>e),(e=>(f.V.Error("XR.requestReferenceSpace failed for the following reason: "),f.V.Error(e),f.V.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then((e=>{const t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)}),(e=>{throw f.V.Error(e),'XR initialization failed: required "viewer" reference space type not supported.'}))))).then((e=>this.session.requestReferenceSpace("viewer").then((t=>(this.viewerReferenceSpace=t,e))))).then((e=>(this.referenceSpace=this.baseReferenceSpace=e,this.onXRReferenceSpaceInitialized.notifyObservers(e),this.referenceSpace)))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new Gi(e.baseLayer):new wi(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then((e=>{const t=void 0===e||e;return Promise.resolve(t)})).catch((e=>(f.V.Warn(e),Promise.resolve(!1)))):Promise.resolve(!1)}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():!this.inXRSession&&t||this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){return this.session?.enabledFeatures??null}}var Hi=i(92411),Yi=i(84285);class Xi{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=Xi._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=(0,Yi.YA)("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const t=new Oi.F("targetMat",e);t.specularColor=a.v9.Black(),t.emissiveColor=new a.v9(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new Ii.Rl(s.Pq.Zero(),new s.Pq(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}Xi._IdCounter=0;class qi extends Xi{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new Ii.Rl(s.Pq.Zero(),s.Pq.Forward())}}class $i{}class ji{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new n.cP,this.onAfterEnteringVRObservable=new n.cP,this.onExitingVRObservable=new n.cP,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=ji.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new s.Pq(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new s.Pq(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new a.v9(.2,.2,1),this._pickedGazeColor=new a.v9(0,0,1),this.onNewMeshSelected=new n.cP,this.onNewMeshPicked=new n.cP,this.onBeforeCameraTeleport=new n.cP,this.onAfterCameraTeleport=new n.cP,this.onSelectedMeshUnselected=new n.cP,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=e=>{e.type!==je.POSE_ENABLED&&(e.leftStick&&e.onleftstickchanged((e=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))})),e.rightStick&&e.onrightstickchanged((e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)})),e.type===je.XBOX&&(e.onbuttondown((e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerDown()})),e.onbuttonup((e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerUp()}))))},this._workingVector=s.Pq.Zero(),this._workingQuaternion=s.PT.Identity(),this._workingMatrix=s.uq.Identity(),f.V.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),"getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new s.Pq(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Mt("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof bt.F&&this._scene.activeCamera.rotation)){const e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(s.PT.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Wi.IsSessionSupportedAsync("immersive-vr").then((i=>{i?(f.V.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then((t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new qi((()=>this.xr.baseExperience.camera),e),this.xr.baseExperience.onStateChangedObservable.add((e=>{switch(e){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1}}))}))):this._completeVRInit(e,t)})):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new Ai("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new qi((()=>this.currentVRCamera),e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",(()=>{this.isInVRMode||this.enterVR()}));const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add((()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())}),xe.Zp.POINTERDOUBLETAP,!1),e.onDisposeObservable.add((()=>{this.dispose()})),this._updateButtonVisibility(),this._circleEase=new w,this._circleEase.setEasingMode(L.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add((t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===xe.Zp.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===xe.Zp.POINTERUP&&this._cameraGazer._selectionPointerUp())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&2===this.xr.baseExperience.state||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){f.V.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=s.PT.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){f.V.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr)return void(2===this.xr.baseExperience.state&&this.xr.pointerSelection.attach());this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>!!(this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!(!this._floorMeshName||e.name!==this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const t=e.floorMeshes||[];if(!t.length){const i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr)return t.forEach((e=>{this.xr.teleportation.addFloorMesh(e)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};return void this._scene.registerBeforeRender(t)}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction);const t=new Mi.p;t.vignetteColor=new a.ov(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const e=s.PT.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,s.PT.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),s.Pq.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const r=new Ii.Rl(i,this._workingVector),n=this._scene.pickWithRay(r,this._raySelectionPredicate);n&&n.pickedPoint&&n.pickedMesh&&this._isTeleportationFloor(n.pickedMesh)&&n.distance<5&&this.teleportCamera(n.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=(0,Hi.km)("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=new Ni.R("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;const t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();const i=new Oi.F("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;const r=(0,Yi.YA)("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);r.isPickable=!1,r.parent=this._teleportationTarget;const n=new M.X5("animationInnerCircle","position.y",30,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CYCLE),s=[];s.push({frame:0,value:0}),s.push({frame:30,value:.4}),s.push({frame:60,value:0}),n.setKeys(s);const a=new X;a.setEasingMode(L.EASINGMODE_EASEINOUT),n.setEasingFunction(a),r.animations=[],r.animations.push(n),this._scene.beginAnimation(r,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof Pt.S))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=s.PT.FromRotationMatrix(s.uq.RotationY(Math.PI/4*this._rotationAngle)),i=new M.X5("animationRotation","rotationQuaternion",90,M.X5.ANIMATIONTYPE_QUATERNION,M.X5.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),r.push({frame:6,value:t}),i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const n=new M.X5("animationPP","vignetteWeight",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:4}),a.push({frame:6,value:0}),n.setKeys(a),n.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(n);const o=new M.X5("animationPP2","vignetteStretch",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),o.setKeys(l),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof Pt.S))return;let t,i;if(this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==ji.TELEPORTATIONMODE_CONSTANTSPEED){i=90;const e=s.Pq.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];const r=new M.X5("animationCameraTeleportation","position",90,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),n=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];r.setKeys(n),r.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];const a=Math.round(i/2),o=new M.X5("animationPP","vignetteWeight",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:a,value:8}),l.push({frame:i,value:0}),o.setKeys(l),this._postProcessMove.animations.push(o);const c=new M.X5("animationPP2","vignetteStretch",90,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:a,value:10}),h.push({frame:i,value:0}),c.setKeys(h),this._postProcessMove.animations.push(c),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,(()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)})),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}ji.TELEPORTATIONMODE_CONSTANTTIME=0,ji.TELEPORTATIONMODE_CONSTANTSPEED=1;const Ki=function(){const e={root:0,found:!1};return function(t,i,r,n){e.root=0,e.found=!1;const s=i*i-4*t*r;if(s<0)return e;const a=Math.sqrt(s);let o=(-i-a)/(2*t),l=(-i+a)/(2*t);if(o>l){const e=l;l=o,o=e}return o>0&&o<n?(e.root=o,e.found=!0,e):l>0&&l<n?(e.root=l,e.found=!0,e):e}}();class Zi{constructor(){this._collisionPoint=s.Pq.Zero(),this._planeIntersectionPoint=s.Pq.Zero(),this._tempVector=s.Pq.Zero(),this._tempVector2=s.Pq.Zero(),this._tempVector3=s.Pq.Zero(),this._tempVector4=s.Pq.Zero(),this._edge=s.Pq.Zero(),this._baseToVertex=s.Pq.Zero(),this._destinationPoint=s.Pq.Zero(),this._slidePlaneNormal=s.Pq.Zero(),this._displacementVector=s.Pq.Zero(),this._radius=s.Pq.One(),this._retry=0,this._basePointWorld=s.Pq.Zero(),this._velocityWorld=s.Pq.Zero(),this._normalizedVelocity=s.Pq.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const r=Math.sqrt(this._velocitySquaredLength);0===r||1===r?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,n){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),s.Pq.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let a=s.Pq.Dot(this._tempVector4,n);return!(a<0)&&(r.subtractToRef(e,this._tempVector3),s.Pq.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=s.Pq.Dot(this._tempVector4,n),!(a<0)&&(s.Pq.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=s.Pq.Dot(this._tempVector4,n),a>=0))}_canDoCollision(e,t,i,r){const n=s.Pq.Distance(this._basePointWorld,e),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(n>this._velocityWorldLength+a+t||!((e,t,i,r)=>!(e.x>i.x+r||i.x-r>t.x||e.y>i.y+r||i.y-r>t.y||e.z>i.z+r||i.z-r>t.z))(i,r,this._basePointWorld,this._velocityWorldLength+a))}_testTriangle(e,t,i,r,n,a,o){let l,c=!1;t||(t=[]),t[e]||(t[e]=new et.Z(0,0,0,0),t[e].copyFromPoints(i,r,n));const h=t[e];if(!a&&!h.isFrontFacingTo(this._normalizedVelocity,0))return;const u=h.signedDistanceTo(this._basePoint),d=s.Pq.Dot(h.normal,this._velocity);if(Zi.DoubleSidedCheck&&d>1e-4)return;if(0==d){if(Math.abs(u)>=1)return;c=!0,l=0}else{l=(-1-u)/d;let e=(1-u)/d;if(l>e){const t=e;e=l,l=t}if(l>1||e<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let p=!1,f=1;if(c||(this._basePoint.subtractToRef(h.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,n,h.normal)&&(p=!0,f=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!p){let e=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let t=2*s.Pq.Dot(this._velocity,this._tempVector),a=this._tempVector.lengthSquared()-1,o=Ki(e,t,a,f);o.found&&(f=o.root,p=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),t=2*s.Pq.Dot(this._velocity,this._tempVector),a=this._tempVector.lengthSquared()-1,o=Ki(e,t,a,f),o.found&&(f=o.root,p=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(n,this._tempVector),t=2*s.Pq.Dot(this._velocity,this._tempVector),a=this._tempVector.lengthSquared()-1,o=Ki(e,t,a,f),o.found&&(f=o.root,p=!0,this._collisionPoint.copyFrom(n)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let l=this._edge.lengthSquared(),c=s.Pq.Dot(this._edge,this._velocity),h=s.Pq.Dot(this._edge,this._baseToVertex);if(e=l*-this._velocitySquaredLength+c*c,t=2*(l*s.Pq.Dot(this._velocity,this._baseToVertex)-c*h),a=l*(1-this._baseToVertex.lengthSquared())+h*h,o=Ki(e,t,a,f),o.found){const e=(c*o.root-h)/l;e>=0&&e<=1&&(f=o.root,p=!0,this._edge.scaleInPlace(e),i.addToRef(this._edge,this._collisionPoint))}if(n.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),l=this._edge.lengthSquared(),c=s.Pq.Dot(this._edge,this._velocity),h=s.Pq.Dot(this._edge,this._baseToVertex),e=l*-this._velocitySquaredLength+c*c,t=2*(l*s.Pq.Dot(this._velocity,this._baseToVertex)-c*h),a=l*(1-this._baseToVertex.lengthSquared())+h*h,o=Ki(e,t,a,f),o.found){const e=(c*o.root-h)/l;e>=0&&e<=1&&(f=o.root,p=!0,this._edge.scaleInPlace(e),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(n,this._edge),n.subtractToRef(this._basePoint,this._baseToVertex),l=this._edge.lengthSquared(),c=s.Pq.Dot(this._edge,this._velocity),h=s.Pq.Dot(this._edge,this._baseToVertex),e=l*-this._velocitySquaredLength+c*c,t=2*(l*s.Pq.Dot(this._velocity,this._baseToVertex)-c*h),a=l*(1-this._baseToVertex.lengthSquared())+h*h,o=Ki(e,t,a,f),o.found){const e=(c*o.root-h)/l;e>=0&&e<=1&&(f=o.root,p=!0,this._edge.scaleInPlace(e),n.addToRef(this._edge,this._collisionPoint))}}if(p){const e=f*f*this._velocitySquaredLength;(!this.collisionFound||e<this._nearestDistanceSquared)&&(o.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=e,this._nearestDistance=Math.sqrt(e),this.collisionFound=!0),this.collidedMesh=o)}}_collide(e,t,i,r,n,s,a,o,l,c=!1){if(c)if(i&&0!==i.length)for(let s=r;s<n-2;s+=1){const r=i[s],n=i[s+1],c=i[s+2];if(4294967295===c){s+=2;continue}const h=t[r],u=t[n],d=t[c];h&&u&&d&&((l?1:0)^s%2?this._testTriangle(s,e,h,u,d,a,o):this._testTriangle(s,e,u,h,d,a,o))}else for(let i=0;i<t.length-2;i+=1){const r=t[i],n=t[i+1],s=t[i+2];r&&n&&s&&((l?1:0)^i%2?this._testTriangle(i,e,r,n,s,a,o):this._testTriangle(i,e,n,r,s,a,o))}else if(i&&0!==i.length)for(let c=r;c<n;c+=3){const r=t[i[c]-s],n=t[i[c+1]-s],h=t[i[c+2]-s];l?this._testTriangle(c,e,r,n,h,a,o):this._testTriangle(c,e,h,n,r,a,o)}else for(let i=0;i<t.length;i+=3){const r=t[i],n=t[i+1],s=t[i+2];l?this._testTriangle(i,e,r,n,s,a,o):this._testTriangle(i,e,s,n,r,a,o)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(et.Z.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}Zi.DoubleSidedCheck=!1;class Qi{constructor(){this._scaledPosition=s.Pq.Zero(),this._scaledVelocity=s.Pq.Zero(),this._finalPosition=s.Pq.Zero()}getNewPosition(e,t,i,r,n,s,a){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,n),this._finalPosition.multiplyInPlace(i._radius),s(a,this._finalPosition,i.collidedMesh)}createCollider(){return new Zi}init(e){this._scene=e}_collideWithWorld(e,t,i,r,n,s=null){const a=10*ne.$.CollisionsEpsilon;if(i._retry>=r)return void n.copyFrom(e);const o=s?s.collisionMask:i.collisionMask;i._initialize(e,t,a);const l=s&&s.surroundingMeshes||this._scene.meshes;for(let e=0;e<l.length;e++){const t=l[e];t.isEnabled()&&t.checkCollisions&&t.subMeshes&&t!==s&&o&t.collisionGroup&&t._checkCollision(i)}i.collisionFound?(0===t.x&&0===t.y&&0===t.z||i._getResponse(e,t),t.length()<=a?n.copyFrom(e):(i._retry++,this._collideWithWorld(e,t,i,r,n,s))):e.addToRef(t,n)}}kt.Z.CollisionCoordinatorFactory=()=>new Qi;var Ji=i(40475),er=i(92371),tr=i(66667),ir=i(27225),rr=i(50004);class nr{constructor(){this._pickingTexture=null,this._idMap=[],this._thinIdMap=[],this._idColors=[],this._meshMaterialMap=new Map,this._meshRenderingCount=0,this._attributeName="instanceMeshID",this._shaderLanguage=0,this._pickingInProgress=!1}get shaderLanguage(){return this._shaderLanguage}get pickingInProgress(){return this._pickingInProgress}static _IdToRgb(e){nr._TempColor.r=(16711680&e)>>16,nr._TempColor.g=(65280&e)>>8,nr._TempColor.b=255&e}_getColorIdFromReadBuffer(e){return(this._readbuffer[e]<<16)+(this._readbuffer[e+1]<<8)+this._readbuffer[e+2]}static _SetColorData(e,t,i,r,n){e[t]=i/255,e[t+1]=r/255,e[t+2]=n/255,e[t+3]=1}_createRenderTarget(e,t,i){this._pickingTexture&&this._pickingTexture.dispose(),this._pickingTexture=new Si.$("pickingTexure",{width:t,height:i},e,!1,void 0,0,!1,1)}async _createColorMaterialAsync(e){this._defaultRenderMaterial&&this._defaultRenderMaterial.dispose(),this._defaultRenderMaterial=null,e.getEngine().isWebGPU&&(this._shaderLanguage=1);const t={attributes:[rr.R.PositionKind,this._attributeName,"bakedVertexAnimationSettingsInstanced"],uniforms:["world","viewProjection","meshID"],needAlphaBlending:!1,defines:[],useClipPlane:null,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,60961)),Promise.resolve().then(i.bind(i,22123))]):await Promise.all([Promise.resolve().then(i.bind(i,11950)),Promise.resolve().then(i.bind(i,44548))])}};this._defaultRenderMaterial=new ir.B("pickingShader",e,"picking",t,!1),this._defaultRenderMaterial.onBindObservable.add(this._materialBindCallback,void 0,void 0,this)}_materialBindCallback(e){if(!e)return;const t=this._meshMaterialMap.get(e).getEffect();e.hasInstances||e.isAnInstance||e.hasThinInstances||t.setColor4("meshID",this._idColors[e.uniqueId],1),this._meshRenderingCount++}_generateColorData(e,t,i,r,n,s,a){const o=new Float32Array(4*(e+1));nr._SetColorData(o,0,r,n,s);for(let i=0;i<e;i++)nr._IdToRgb(t),a(i,t),nr._SetColorData(o,4*(i+1),nr._TempColor.r,nr._TempColor.g,nr._TempColor.b),t++;return o}_generateThinInstanceColorData(e,t,i){const r=new Float32Array(4*e);for(let n=0;n<e;n++)nr._IdToRgb(t),i(n,t),nr._SetColorData(r,4*n,nr._TempColor.r,nr._TempColor.g,nr._TempColor.b),t++;return r}setPickingList(e){if(this._pickableMeshes){for(let e=0;e<this._pickableMeshes.length;e++){const t=this._pickableMeshes[e];t.hasInstances&&t.removeVerticesData(this._attributeName),t.hasThinInstances&&t.thinInstanceSetBuffer(this._attributeName,null),this._pickingTexture&&this._pickingTexture.setMaterialForRendering(t,void 0);const i=this._meshMaterialMap.get(t);i!==this._defaultRenderMaterial&&i.onBindObservable.removeCallback(this._materialBindCallback)}this._pickableMeshes.length=0,this._meshMaterialMap.clear(),this._idMap.length=0,this._thinIdMap.length=0,this._idColors.length=0,this._pickingTexture&&(this._pickingTexture.renderList=[])}if(!e||0===e.length)return;this._pickableMeshes=e;const t=("mesh"in e[0]?e[0].mesh:e[0]).getScene(),i=t.getEngine(),r=i.getRenderWidth(),n=i.getRenderHeight();if(this._pickingTexture){const e=this._pickingTexture.getSize();e.width===r&&e.height===n&&this._cachedScene===t||this._createRenderTarget(t,r,n)}else this._createRenderTarget(t,r,n);this._cachedScene&&this._cachedScene===t||this._createColorMaterialAsync(t),this._cachedScene=t,this._engine=t.getEngine();for(let t=0;t<e.length;t++){const i=e[t];"mesh"in i?(this._meshMaterialMap.set(i.mesh,i.material),e[t]=i.mesh):this._meshMaterialMap.set(i,this._defaultRenderMaterial)}this._pickingTexture.renderList=[];let s=1;for(let e=0;e<this._pickableMeshes.length;e++){const t=this._pickableMeshes[e],i=this._meshMaterialMap.get(t);if(i!==this._defaultRenderMaterial&&i.onBindObservable.add(this._materialBindCallback,void 0,void 0,this),this._pickingTexture.setMaterialForRendering(t,i),this._pickingTexture.renderList.push(t),!t.isAnInstance)if(nr._IdToRgb(s),t.hasThinInstances){const i=this._generateThinInstanceColorData(t.thinInstanceCount,s,((t,i)=>{this._thinIdMap[i]={meshId:e,thinId:t}}));s+=t.thinInstanceCount,t.thinInstanceSetBuffer(this._attributeName,i,4)}else if(this._idMap[s]=e,s++,t.hasInstances){const i=t.instances,r=this._generateColorData(i.length,s,e,nr._TempColor.r,nr._TempColor.g,nr._TempColor.b,((e,t)=>{const r=i[e];this._idMap[t]=this._pickableMeshes.indexOf(r)}));s+=i.length;const n=t.getEngine(),a=new rr.R(n,r,this._attributeName,!1,!1,4,!0);t.setVerticesBuffer(a,!0)}else this._idColors[t.uniqueId]=a.v9.FromInts(nr._TempColor.r,nr._TempColor.g,nr._TempColor.b)}}async pickAsync(e,t,i=!1){if(this._pickingInProgress)return null;if(!this._pickableMeshes||0===this._pickableMeshes.length)return null;const{x:r,y:n,rttSizeW:s,rttSizeH:a}=this._prepareForPicking(e,t);if(r<0||n<0||r>=s||n>=a)return null;this._pickingInProgress=!0;const o=a-n-1;return this._preparePickingBuffer(this._engine,s,a,r,o),this._executePicking(r,o,i)}async multiPickAsync(e,t=!1){if(this._pickingInProgress)return null;if(!this._pickableMeshes||0===this._pickableMeshes.length||0===e.length)return null;if(1===e.length){const i=await this.pickAsync(e[0].x,e[0].y,t);return{meshes:[i?.mesh??null],thinInstanceIndexes:i?.thinInstanceIndex?[i.thinInstanceIndex]:void 0}}this._pickingInProgress=!0;let i=e[0].x,r=e[0].x,n=e[0].y,s=e[0].y;for(let t=1;t<e.length;t++){const{x:a,y:o}=e[t];i=Math.min(i,a),r=Math.max(r,a),n=Math.min(n,o),s=Math.max(s,o)}const{rttSizeW:a,rttSizeH:o}=this._prepareForPicking(i,n),l=Math.max(r-i,1),c=Math.max(s-n,1),h=o-s-1;return this._preparePickingBuffer(this._engine,a,o,i,h,l,c),this._executeMultiPicking(e,i,s,o,l,c,t)}_prepareForPicking(e,t){const i=this._cachedScene.getEngine(),r=i.getRenderWidth(),n=i.getRenderHeight(),s=1/i._hardwareScalingLevel;return{x:s*e|0,y:s*t|0,rttSizeW:r,rttSizeH:n}}_preparePickingBuffer(e,t,i,r,n,s=1,o=1){this._meshRenderingCount=0;const l=e.isWebGPU?4*s*o+255&-256:4*s*o;(!this._readbuffer||this._readbuffer.length<l)&&(this._readbuffer=new Uint8Array(l));const c=this._pickingTexture.getSize();c.width===t&&c.height===i||(this._createRenderTarget(this._cachedScene,t,i),this._updateRenderList()),this._pickingTexture.clearColor=new a.ov(0,0,0,0),this._pickingTexture.onBeforeRender=()=>{this._enableScissor(r,n,s,o)},this._cachedScene.customRenderTargets.push(this._pickingTexture)}_executePicking(e,t,i){return new Promise(((r,n)=>{if(!this._pickingTexture)return this._pickingInProgress=!1,void n();this._pickingTexture.onAfterRender=async()=>{if(this._disableScissor(),this._checkRenderStatus()){this._pickingTexture.onAfterRender=null;let n,s=null;const a=this._cachedScene.customRenderTargets.indexOf(this._pickingTexture);if(a>-1&&this._cachedScene.customRenderTargets.splice(a,1),await this._readTexturePixelsAsync(e,t)){const e=this._getColorIdFromReadBuffer(0);this._thinIdMap[e]?(s=this._pickableMeshes[this._thinIdMap[e].meshId],n=this._thinIdMap[e].thinId):s=this._pickableMeshes[this._idMap[e]]}i&&this.dispose(),this._pickingInProgress=!1,r(s?{mesh:s,thinInstanceIndex:n}:null)}}}))}_executeMultiPicking(e,t,i,r,n,s,a){return new Promise(((o,l)=>{if(!this._pickingTexture)return this._pickingInProgress=!1,void l();this._pickingTexture.onAfterRender=async()=>{if(this._disableScissor(),this._checkRenderStatus()){this._pickingTexture.onAfterRender=null;const l=[],c=[];if(await this._readTexturePixelsAsync(t,r-i-1,n,s))for(let r=0;r<e.length;r++){const{pickedMesh:s,thinInstanceIndex:a}=this._getMeshFromMultiplePoints(e[r].x,e[r].y,t,i,n);l.push(s),c.push(a??0)}a&&this.dispose(),this._pickingInProgress=!1,o({meshes:l,thinInstanceIndexes:c})}}}))}_enableScissor(e,t,i=1,r=1){this._engine.enableScissor&&this._engine.enableScissor(e,t,i,r)}_disableScissor(){this._engine.disableScissor&&this._engine.disableScissor()}_checkRenderStatus(){if(this._meshRenderingCount>0){const e=this._cachedScene.customRenderTargets.indexOf(this._pickingTexture);return e>-1&&this._cachedScene.customRenderTargets.splice(e,1),!0}return this._meshRenderingCount=0,!1}_getMeshFromMultiplePoints(e,t,i,r,n){let s=4*(e-i-1),a=(r-t-1)*n*4;s=Math.max(s,0),a=Math.max(a,0);const o=this._getColorIdFromReadBuffer(s+a);let l,c=null;return o>0&&(this._thinIdMap[o]?(c=this._pickableMeshes[this._thinIdMap[o].meshId],l=this._thinIdMap[o].thinId):c=this._pickableMeshes[this._idMap[o]]),{pickedMesh:c,thinInstanceIndex:l}}_updateRenderList(){this._pickingTexture.renderList=[];for(const e of this._pickableMeshes)this._pickingTexture.setMaterialForRendering(e,this._meshMaterialMap.get(e)),this._pickingTexture.renderList.push(e)}async _readTexturePixelsAsync(e,t,i=1,r=1){if(!this._cachedScene||!this._pickingTexture?._texture)return!1;const n=this._cachedScene.getEngine();return await n._readTexturePixels(this._pickingTexture._texture,i,r,-1,0,this._readbuffer,!0,!0,e,t),!0}dispose(){this.setPickingList(null),this._cachedScene=null,this._pickingTexture?.dispose(),this._pickingTexture=null,this._defaultRenderMaterial?.dispose(),this._defaultRenderMaterial=null}}nr._TempColor={r:0,g:0,b:0};var sr=i(11950),ar=i(44548),or=i(60961),lr=i(22123),cr=i(28509),hr=i(23469);class ur{constructor(e,t,i,r=""){let s;this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new n.cP,this.onErrorObservable=new n.cP,this.onBindObservable=new n.cP,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=1,this.name=e,this._key=r,this._engine=i,this.uniqueId=ur._UniqueIdSeed++,this.defines=t.defines??"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=t.entryPoint??"main",this._shaderStore=ri.l.GetShadersStore(this._shaderLanguage),this._shaderRepository=ri.l.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=ri.l.GetIncludesShadersStore(this._shaderLanguage);const a=(0,Ut.BA)()?this._engine.getHostDocument():null;s="string"==typeof e?e:e.computeSource?"source:"+e.computeSource:e.computeElement?a?.getElementById(e.computeElement)||e.computeElement:e.compute||e;const o={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(e,t,i)=>{if(!i)return t;for(const e of i){const i=e.replace("#define","").replace(";","").trim().split(" ");if(2===i.length){const e=i[0],r=i[1];isNaN(parseInt(r))&&isNaN(parseFloat(r))||(t=`const ${e} = ${r};\n`+t)}}return t}};this._loadShader(s,"Compute","",(i=>{(0,hr.pB)(o),(0,hr.jC)(i,o,(r=>{this._rawComputeSourceCode=i,t.processFinalCode&&(r=t.processFinalCode(r));const n=(0,hr.nO)(r,"",o);this._useFinalCode(n.vertexCode,e)}),this._engine)}))}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+"\n"+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((()=>{this._checkIsReady(null)}),16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}setTimeout((()=>{this._checkIsReady(e)}),16)}_loadShader(e,t,i,r){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void r((0,Ut.Zl)(e));if("source:"===e.substring(0,7))return void r(e.substring(7));if("base64:"===e.substring(0,7))return void r(window.atob(e.substring(7)));if(this._shaderStore[e+t+"Shader"])return void r(this._shaderStore[e+t+"Shader"]);if(i&&this._shaderStore[e+i+"Shader"])return void r(this._shaderStore[e+i+"Shader"]);let n;n="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:this._shaderRepository+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",r)}get computeSourceCode(){return this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._pipelineContext?._getComputeShaderCode()??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,(e=>{e&&e.numErrors>0?this._processCompilationErrors(e,t):(this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t))})),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_processCompilationErrors(e,t=null){if(this._compilationError="",f.V.Error("Unable to compile compute effect:"),this.defines&&f.V.Error("Defines:\n"+this.defines),ur.LogShaderCodeOnCompilationError){const e=this._pipelineContext?._getComputeShaderCode();e&&(f.V.Error("Compute code:"),f.V.Error(e))}if("string"==typeof e)this._compilationError=e,f.V.Error("Error: "+this._compilationError);else for(const t of e.messages){let e="";void 0!==t.line&&(e+="Line "+t.line+", "),void 0!==t.offset&&(e+="Offset "+t.offset+", "),void 0!==t.length&&(e+="Length "+t.length+", "),e+=t.type+": "+t.text,this._compilationError&&(this._compilationError+="\n"),this._compilationError+=e,f.V.Error(e)}t&&(this._pipelineContext=t,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){ri.l.GetShadersStore(1)[`${e}ComputeShader`]=t}}ur._UniqueIdSeed=0,ur.LogShaderCodeOnCompilationError=!0;var dr=i(63414),pr=i(32378),fr=i(54611);class mr{constructor(e){this._engine=e}async _initializePlatform(){if(!this._platform)if(this._engine.getCaps().supportComputeShaders){const e=await Promise.resolve().then(i.bind(i,51519));this._platform=new e.ComputeShaderBoundingHelper(this._engine)}else{if(!this._engine.getCaps().supportTransformFeedbacks)throw new Error("Your engine does not support Compute Shaders or Transform Feedbacks");{const e=await Promise.resolve().then(i.bind(i,39501));this._platform=new e.TransformFeedbackBoundingHelper(this._engine)}}}async computeAsync(e){return await this._initializePlatform(),this._platform.processAsync(e)}async batchInitializeAsync(e){return await this._initializePlatform(),this._platform.registerMeshListAsync(e)}batchProcess(){this._platform.processMeshList()}async batchFetchResultsAsync(){return this._platform.fetchResultsForMeshListAsync()}dispose(){this._platform.dispose()}}var _r=i(39501),gr=i(51519),vr=i(17246),Sr=i(94975);class xr{constructor(e,t,i,r,n,s){this.entries=[],this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=n,this._creationFunc=s,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks)for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);else this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(pr.I.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(pr.I.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let n=0;n<this.blocks.length;n++)this.blocks[n].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){xr._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,n,a,o,l){o.blocks=new Array;const c=new s.Pq((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let t=0;t<2;t++)for(let s=0;s<2;s++)for(let h=0;h<2;h++){const u=e.add(c.multiplyByFloats(t,s,h)),d=e.add(c.multiplyByFloats(t+1,s+1,h+1)),p=new xr(u,d,r,n+1,a,l);p.addEntries(i),o.blocks.push(p)}}}class Tr{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=t||64,this._selectionContent=new Sr.b(1024),this._creationFunc=e}update(e,t,i){xr._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}Tr.CreationFuncForMeshes=(e,t)=>{const i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},Tr.CreationFuncForSubMeshes=(e,t)=>{e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)};var Er=i(45413);kt.Z.prototype.createOrUpdateSelectionOctree=function(e=64,t=2){let i=this._getComponent(Gt.v.NAME_OCTREE);i||(i=new Cr(this),this._addComponent(i)),this._selectionOctree||(this._selectionOctree=new Tr(Tr.CreationFuncForMeshes,e,t));const r=this.getWorldExtends();return this._selectionOctree.update(r.min,r.max,this.meshes),this._selectionOctree},Object.defineProperty(kt.Z.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Er.u.prototype.createOrUpdateSubmeshesOctree=function(e=64,t=2){const i=this.getScene();let r=i._getComponent(Gt.v.NAME_OCTREE);r||(r=new Cr(i),i._addComponent(r)),this._submeshesOctree||(this._submeshesOctree=new Tr(Tr.CreationFuncForSubMeshes,e,t)),this.computeWorldMatrix(!0);const n=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(n.minimumWorld,n.maximumWorld,this.subMeshes),this._submeshesOctree};class Cr{constructor(e){this.name=Gt.v.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new Ii.Rl(s.Pq.Zero(),new s.Pq(1,1,1)),(e=e||P.q.LastCreatedScene)&&(this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=e=>this.getActiveSubMeshCandidates(e),this.scene.getCollidingSubMeshCandidates=(e,t)=>this.getCollidingSubMeshCandidates(e,t),this.scene.getIntersectingSubMeshCandidates=(e,t)=>this.getIntersectingSubMeshCandidates(e,t))}register(){this.scene.onMeshRemovedObservable.add((e=>{const t=this.scene.selectionOctree;if(null!=t){const i=t.dynamicContent.indexOf(e);-1!==i&&t.dynamicContent.splice(i,1)}})),this.scene.onMeshImportedObservable.add((e=>{const t=this.scene.selectionOctree;null!=t&&t.addMesh(e)}))}getActiveMeshCandidates(){return this.scene._selectionOctree?.select(this.scene.frustumPlanes)||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(Ii.Rl.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}var br=i(28425),Pr=i(78053),yr=i(39198),Ar=i(64051),Rr=i(10793),Ir=i(30418),Mr=i(1283),Or=i(25892),Nr=i(64787);class Dr{constructor(){this.renderWidth=512,this.renderHeight=256,this.textureSize=512,this.deterministicLockstep=!1,this.lockstepMaxSteps=4}}class Fr extends _i.N{isDeterministicLockStep(){return this._options.deterministicLockstep}getLockstepMaxSteps(){return this._options.lockstepMaxSteps}getHardwareScalingLevel(){return 1}constructor(e=new Dr){super(null),void 0===e.deterministicLockstep&&(e.deterministicLockstep=!1),void 0!==e.timeStep&&(this._timeStep=e.timeStep),void 0===e.lockstepMaxSteps&&(e.lockstepMaxSteps=4),this._options=e,Mr.I.SetMatrixPrecision(!!e.useHighPrecisionMatrix),this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:512,maxCubemapTextureSize:512,maxDrawBuffers:0,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!1,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:0,uintIndices:!1,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!1,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!1,instancedArrays:!1,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,maxMSAASamples:1,blendMinMax:!1,canUseGLInstanceID:!1,canUseGLVertexID:!1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:128,disableMorphTargetTexture:!1,textureNorm16:!1},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},e.renderingCanvas&&(this._renderingCanvas=e.renderingCanvas),f.V.Log(`Babylon.js v${_i.N.Version} - Null engine`);const t="undefined"!=typeof self?self:"undefined"!=typeof global?global:window;"undefined"==typeof URL&&(t.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(t.Blob=function(){})}createVertexBuffer(e){const t=new We.n;return t.references=1,t}createIndexBuffer(e){const t=new We.n;return t.references=1,t}clear(e,t,i,r=!1){}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._options.renderWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._options.renderHeight}setViewport(e,t,i){this._cachedViewport=e}createShaderProgram(e,t,i,r,n){return{__SPECTOR_rebuildProgram:null}}getUniforms(e,t){return[]}getAttributes(e,t){return[]}bindSamplers(e){this._currentEffect=null}enableEffect(e){e=null!==e&&(0,Nr.E)(e)?e.effect:e,this._currentEffect=e,e&&(e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setState(e,t=0,i,r=!1,n,s,a=0){}setIntArray(e,t){return!0}setIntArray2(e,t){return!0}setIntArray3(e,t){return!0}setIntArray4(e,t){return!0}setFloatArray(e,t){return!0}setFloatArray2(e,t){return!0}setFloatArray3(e,t){return!0}setFloatArray4(e,t){return!0}setArray(e,t){return!0}setArray2(e,t){return!0}setArray3(e,t){return!0}setArray4(e,t){return!0}setMatrices(e,t){return!0}setMatrix3x3(e,t){return!0}setMatrix2x2(e,t){return!0}setFloat(e,t){return!0}setFloat2(e,t,i){return!0}setFloat3(e,t,i,r){return!0}setBool(e,t){return!0}setFloat4(e,t,i,r,n){return!0}setAlphaMode(e,t=!1){this._alphaMode!==e&&(this.alphaState.alphaBlend=0!==e,t||this.setDepthWrite(0===e),this._alphaMode=e)}bindBuffers(e,t,i){}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this.depthCullingState.reset(),this.alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}draw(e,t,i,r){}drawElementsType(e,t,i,r){}drawArraysType(e,t,i,r){}_createTexture(){return{}}_releaseTexture(e){}createTexture(e,t,i,r,n=3,s=null,a=null,o=null,l=null,c=null,h=null,u){const d=new gi.hV(this,1),p=String(e);return d.url=p,d.generateMipMaps=!t,d.samplingMode=n,d.invertY=i,d.baseWidth=this._options.textureSize,d.baseHeight=this._options.textureSize,d.width=this._options.textureSize,d.height=this._options.textureSize,c&&(d.format=c),d.isReady=!0,s&&setTimeout((()=>{s(d)})),this._internalTexturesCache.push(d),d}_createHardwareRenderTargetWrapper(e,t,i){const r=new Or.v(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e),r={};void 0!==t&&"object"==typeof t?(r.generateMipMaps=t.generateMipMaps,r.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&t.generateStencilBuffer,r.type=void 0===t.type?0:t.type,r.samplingMode=void 0===t.samplingMode?3:t.samplingMode):(r.generateMipMaps=t,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.type=0,r.samplingMode=3);const n=new gi.hV(this,5),s=e.width||e,a=e.height||e;return i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=!!r.generateStencilBuffer,n.baseWidth=s,n.baseHeight=a,n.width=s,n.height=a,n.isReady=!0,n.samples=1,n.generateMipMaps=!!r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,this._internalTexturesCache.push(n),i}createRenderTargetCubeTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...t};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(1!==r.type||this._caps.textureFloatLinearFiltering)&&(2!==r.type||this._caps.textureHalfFloatLinearFiltering)||(r.samplingMode=1),i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=!!r.generateStencilBuffer;const n=new gi.hV(this,5);return n.baseWidth=e,n.baseHeight=e,n.width=e,n.height=e,n.isReady=!0,n.isCube=!0,n.samples=1,n.generateMipMaps=!!r.generateMipMaps,n.samplingMode=r.samplingMode,n.type=r.type,this._internalTexturesCache.push(n),i}updateTextureSamplingMode(e,t){t.samplingMode=e}createRawTexture(e,t,i,r,n,s,a,o=null,l=0,c=0,h=!1){const u=new gi.hV(this,3);return u.baseWidth=t,u.baseHeight=i,u.width=t,u.height=i,u.format=r,u.generateMipMaps=n,u.samplingMode=a,u.invertY=s,u._compression=o,u.type=l,u._useSRGBBuffer=h,this._doNotHandleContextLost||(u._bufferView=e),u}updateRawTexture(e,t,i,r,n=null,s=0,a=!1){e&&(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n,e.type=s,e._useSRGBBuffer=a)}bindFramebuffer(e,t,i,r,n){this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._currentFramebuffer=null,this._cachedViewport&&!n&&this.setViewport(this._cachedViewport,i,r)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._currentFramebuffer=null}createDynamicVertexBuffer(e){const t=new We.n;return t.references=1,t.capacity=1,t}updateDynamicTexture(e,t,i,r=!1,n){}areAllEffectsReady(){return!0}getError(){return 0}_getUnpackAlignement(){return 1}_unpackFlipY(e){}updateDynamicIndexBuffer(e,t,i=0){}updateDynamicVertexBuffer(e,t,i,r){}_bindTextureDirectly(e,t){return this._boundTexturesCache[this._activeChannel]!==t&&(this._boundTexturesCache[this._activeChannel]=t,!0)}_bindTexture(e,t){e<0||this._bindTextureDirectly(0,t)}_deleteBuffer(e){}releaseEffects(){}displayLoadingUI(){}hideLoadingUI(){}set loadingUIText(e){}flushFramebuffer(){}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,s=0,a=0){}_uploadDataToTextureDirectly(e,t,i=0,r=0){}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){}_uploadImageToTexture(e,t,i=0,r=0){}}i(7191),i(56467),i(4975),i(39777);var Lr=i(6679);i(54638),i(53948),i(67207);class wr{}const Br=new n.cP,Vr=new n.cP;Object.defineProperty(ne.$.prototype,"onBeforeViewRenderObservable",{get:function(){return Br}}),Object.defineProperty(ne.$.prototype,"onAfterViewRenderObservable",{get:function(){return Vr}}),Object.defineProperty(ne.$.prototype,"inputElement",{get:function(){return this._inputElement},set:function(e){this._inputElement!==e&&(this._inputElement=e,this._onEngineViewChanged?.())}}),ne.$.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},ne.$.prototype.registerView=function(e,t,i){this.views||(this.views=[]);for(const t of this.views)if(t.target===e)return t;const r=this.getRenderingCanvas();r&&(e.width=r.width,e.height=r.height);const n={target:e,camera:t,clearBeforeCopy:i,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(n),t&&!Array.isArray(t)&&t.onDisposeObservable.add((()=>{this.unRegisterView(e)})),n},ne.$.prototype.unRegisterView=function(e){if(!this.views||0===this.views.length)return this;for(const t of this.views)if(t.target===e){const e=this.views.indexOf(t);-1!==e&&this.views.splice(e,1);break}return this},ne.$.prototype._renderViewStep=function(e){const t=e.target,i=t.getContext("2d");if(!i)return!0;const r=this.getRenderingCanvas();Br.notifyObservers(e);const n=e.camera;let s=null,a=null,o=null;if(n&&(o=Array.isArray(n)?n[0].getScene():n.getScene(),s=o.activeCamera,a=o.activeCameras,Array.isArray(n)?o.activeCameras=n:(o.activeCamera=n,o.activeCameras=null)),this.activeView=e,e.customResize)e.customResize(t);else{const e=Math.floor(t.clientWidth/this._hardwareScalingLevel),i=Math.floor(t.clientHeight/this._hardwareScalingLevel),n=e!==t.width||r.width!==t.width||i!==t.height||r.height!==t.height;t.clientWidth&&t.clientHeight&&n&&(t.width=e,t.height=i,this.setSize(e,i))}return!(!r.width||!r.height||(this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,r.width,r.height),i.drawImage(r,0,0),o&&(o.activeCameras=a,o.activeCamera=s),Vr.notifyObservers(e),0))},ne.$.prototype._renderViews=function(){if(!this.views||0===this.views.length)return!1;if(!this.getRenderingCanvas())return!1;let e;for(const t of this.views)if(t.enabled)if(t.target!==this.inputElement){if(!this._renderViewStep(t))return!1}else e=t;return!(e&&!this._renderViewStep(e)||(this.activeView=null,0))},i(39543),ne.$.prototype._debugPushGroup=function(e,t){},ne.$.prototype._debugPopGroup=function(e){},ne.$.prototype._debugInsertMarker=function(e,t){},ne.$.prototype._debugFlushPendingCommands=function(){};class kr{constructor(){this._timeElapsedQueryEnded=!1}}var Gr=i(99724);_i.N.prototype.createQuery=function(){const e=this._gl.createQuery();if(!e)throw new Error("Unable to create Occlusion Query");return e},_i.N.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},_i.N.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},_i.N.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},_i.N.prototype.beginOcclusionQuery=function(e,t){const i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},_i.N.prototype.endOcclusionQuery=function(e){const t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},_i.N.prototype._createTimeQuery=function(){const e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},_i.N.prototype._deleteTimeQuery=function(e){const t=this.getCaps().timerQuery;t.deleteQueryEXT?t.deleteQueryEXT(e):this.deleteQuery(e)},_i.N.prototype._getTimeQueryResult=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},_i.N.prototype._getTimeQueryAvailability=function(e){const t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},_i.N.prototype.startTimeQuery=function(){const e=this.getCaps(),t=e.timerQuery;if(!t)return null;const i=new kr;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),i._startTimeQuery&&t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),i._timeElapsedQuery&&(t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery)),this._currentNonTimestampToken=i}return i},_i.N.prototype.endTimeQuery=function(e){const t=this.getCaps(),i=t.timerQuery;if(!i||!e)return-1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return-1;e._endTimeQuery||(e._endTimeQuery=this._createTimeQuery(),e._endTimeQuery&&i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return-1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}const r=this._gl.getParameter(i.GPU_DISJOINT_EXT);let n=!1;if(e._endTimeQuery?n=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(n=this._getTimeQueryAvailability(e._timeElapsedQuery)),n&&!r){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return-1;const t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return-1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return-1},_i.N.prototype._captureGPUFrameTime=!1,_i.N.prototype._gpuFrameTime=new Gr.A,_i.N.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},_i.N.prototype.captureGPUFrameTime=function(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,e?(this._onBeginFrameObserver=this.onBeginFrameObservable.add((()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())})),this._onEndFrameObserver=this.onEndFrameObservable.add((()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))}))):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},_i.N.prototype._getGlAlgorithmType=function(e){return e===Er.u.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};var Ur=!0;_i.N.prototype.createTransformFeedback=function(){const e=this._gl.createTransformFeedback();if(!e)throw new Error("Unable to create Transform Feedback");return e},_i.N.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},_i.N.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},_i.N.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},_i.N.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},_i.N.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},_i.N.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)},_i.N.prototype.readTransformFeedbackBuffer=function(e){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e)},i(64190),i(81499),Ir.ThinEngine.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;const r=this._getInternalFormat(e.format),n=this._getRGBABufferInternalSizedFormat(0,e.format),s=this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0);this._unpackFlipY(!i);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=this.createCanvas(e.width,e.height);const t=e._workingCanvas.getContext("2d");if(!t)throw new Error("Unable to get 2d context");e._workingContext=t,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.clearRect(0,0,e.width,e.height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),s||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}},Ir.ThinEngine.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},Ir.ThinEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},Ir.ThinEngine.prototype.buildTextureLayout=function(e){const t=this._gl,i=[];for(let r=0;r<e.length;r++)e[r]?i.push(t["COLOR_ATTACHMENT"+r]):i.push(t.NONE);return i},Ir.ThinEngine.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},Ir.ThinEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null,e.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(e),t||this.generateMipMapsMultiFramebuffer(e),i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},Ir.ThinEngine.prototype.createMultipleRenderTarget=function(e,t,i=!0){let r,n=!1,s=!0,a=!1,o=!1,l=1,c=1,h=[],u=[],d=[],p=[],m=[],_=[],g=[],v=[],S=[],x=!1;const T=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(n=void 0!==t.generateMipMaps&&t.generateMipMaps,s=void 0===t.generateDepthBuffer||t.generateDepthBuffer,a=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,o=void 0!==t.generateDepthTexture&&t.generateDepthTexture,l=t.textureCount??1,c=t.samples??c,h=t.types||h,u=t.samplingModes||u,d=t.useSRGBBuffers||d,p=t.formats||p,m=t.targetTypes||m,_=t.faceIndex||_,g=t.layerIndex||g,v=t.layerCounts||v,S=t.labels||S,x=t.dontCreateTextures??!1,this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(r=t.depthTextureFormat)),void 0===r&&(r=a?13:14);const E=this._gl,C=E.createFramebuffer();this._bindUnboundFramebuffer(C);const b=e.width??e,P=e.height??e,y=[],A=[],R=this.webGLVersion>1&&(13===r||17===r||18===r);T.label=t?.label??"MultiRenderTargetWrapper",T._framebuffer=C,T._generateDepthBuffer=o||s,T._generateStencilBuffer=o?R:a,T._depthStencilBuffer=this._setupFramebufferDepthAttachments(T._generateStencilBuffer,T._generateDepthBuffer,b,P,1,r),T._attachments=A;for(let e=0;e<l;e++){let t=u[e]||3,i=h[e]||0,r=d[e]||!1;const s=p[e]||5,a=m[e]||3553,o=v[e]??1;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);const l=this._getSamplingParameters(t,n);1!==i||this._caps.textureFloat||(i=0,f.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),r=r&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const c=this.webGLVersion>1,_=E[c?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(A.push(_),-1===a||x)continue;const g=new gi.hV(this,6);y[e]=g,E.activeTexture(E["TEXTURE"+e]),E.bindTexture(a,g._hardwareTexture.underlyingResource),E.texParameteri(a,E.TEXTURE_MAG_FILTER,l.mag),E.texParameteri(a,E.TEXTURE_MIN_FILTER,l.min),E.texParameteri(a,E.TEXTURE_WRAP_S,E.CLAMP_TO_EDGE),E.texParameteri(a,E.TEXTURE_WRAP_T,E.CLAMP_TO_EDGE);const C=this._getRGBABufferInternalSizedFormat(i,s,r),R=this._getInternalFormat(s),I=this._getWebGLTextureType(i);if(!c||35866!==a&&32879!==a)if(34067===a){for(let e=0;e<6;e++)E.texImage2D(E.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,C,b,P,0,R,I,null);g.isCube=!0}else E.texImage2D(E.TEXTURE_2D,0,C,b,P,0,R,I,null);else 35866===a?g.is2DArray=!0:g.is3D=!0,g.baseDepth=g.depth=o,E.texImage3D(a,0,C,b,P,o,0,R,I,null);n&&E.generateMipmap(a),this._bindTextureDirectly(a,null),g.baseWidth=b,g.baseHeight=P,g.width=b,g.height=P,g.isReady=!0,g.samples=1,g.generateMipMaps=n,g.samplingMode=t,g.type=i,g._useSRGBBuffer=r,g.format=s,g.label=S[e]??T.label+"-Texture"+e,this._internalTexturesCache.push(g)}if(o&&this._caps.depthTextureExtension&&!x){const e=new gi.hV(this,14);let t=5,i=E.DEPTH_COMPONENT16,s=E.DEPTH_COMPONENT,a=E.UNSIGNED_SHORT,o=E.DEPTH_ATTACHMENT;this.webGLVersion<2?i=E.DEPTH_COMPONENT:14===r?(t=1,a=E.FLOAT,i=E.DEPTH_COMPONENT32F):18===r?(t=0,a=E.FLOAT_32_UNSIGNED_INT_24_8_REV,i=E.DEPTH32F_STENCIL8,s=E.DEPTH_STENCIL,o=E.DEPTH_STENCIL_ATTACHMENT):16===r?(t=0,a=E.UNSIGNED_INT,i=E.DEPTH_COMPONENT24,o=E.DEPTH_ATTACHMENT):13!==r&&17!==r||(t=12,a=E.UNSIGNED_INT_24_8,i=E.DEPTH24_STENCIL8,s=E.DEPTH_STENCIL,o=E.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(E.TEXTURE_2D,e,!0),E.texParameteri(E.TEXTURE_2D,E.TEXTURE_MAG_FILTER,E.NEAREST),E.texParameteri(E.TEXTURE_2D,E.TEXTURE_MIN_FILTER,E.NEAREST),E.texParameteri(E.TEXTURE_2D,E.TEXTURE_WRAP_S,E.CLAMP_TO_EDGE),E.texParameteri(E.TEXTURE_2D,E.TEXTURE_WRAP_T,E.CLAMP_TO_EDGE),E.texImage2D(E.TEXTURE_2D,0,i,b,P,0,s,a,null),E.framebufferTexture2D(E.FRAMEBUFFER,o,E.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(E.TEXTURE_2D,null),T._depthStencilTexture=e,T._depthStencilTextureWithStencil=R,e.baseWidth=b,e.baseHeight=P,e.width=b,e.height=P,e.isReady=!0,e.samples=1,e.generateMipMaps=n,e.samplingMode=1,e.format=r,e.type=t,e.label=T.label+"-DepthStencil",y[l]=e,this._internalTexturesCache.push(e)}if(T.setTextures(y),i&&E.drawBuffers(A),this._bindUnboundFramebuffer(null),T.setLayerAndFaceIndices(g,_),this.resetTextureCache(),x){if(c>1){const e=E.createFramebuffer();if(!e)throw new Error("Unable to create multi sampled framebuffer");T._samples=c,T._MSAAFramebuffer=e,l>0&&i&&(this._bindUnboundFramebuffer(e),E.drawBuffers(A),this._bindUnboundFramebuffer(null))}}else this.updateMultipleRenderTargetTextureSampleCount(T,c,i);return T},Ir.ThinEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const r=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const n=e._attachments.length;for(let t=0;t<n;t++){const i=e.textures[t]._hardwareTexture;i?.releaseMSAARenderBuffers()}if(t>1&&"function"==typeof r.renderbufferStorageMultisample){const s=r.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=s,this._bindUnboundFramebuffer(s);const a=[];for(let i=0;i<n;i++){const n=e.textures[i],s=n._hardwareTexture,o=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(n.width,n.height,t,-1,this._getRGBABufferInternalSizedFormat(n.type,n.format,n._useSRGBBuffer),o);if(!l)throw new Error("Unable to create multi sampled framebuffer");s.addMSAARenderBuffer(l),n.samples=t,a.push(o)}i&&r.drawBuffers(a)}else this._bindUnboundFramebuffer(e._framebuffer);const s=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,s),this._bindUnboundFramebuffer(null),e._samples=t,t},Ir.ThinEngine.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e,i=this._gl;if(t.isMulti)for(let e=0;e<t._attachments.length;e++){const r=t.textures[e];!r?.generateMipMaps||r?.isCube||r?.is3D||(this._bindTextureDirectly(i.TEXTURE_2D,r,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}},Ir.ThinEngine.prototype.resolveMultiFramebuffer=function(e){const t=e,i=this._gl;if(!t._MSAAFramebuffer||!t.isMulti)return;let r=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;r|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,r|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0;const n=t._attachments,s=n.length;i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer);for(let e=0;e<s;e++){const a=t.textures[e];for(let e=0;e<s;e++)n[e]=i.NONE;n[e]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"],i.readBuffer(n[e]),i.drawBuffers(n),i.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,r,i.NEAREST)}for(let e=0;e<s;e++)n[e]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];i.drawBuffers(n)},i(7),i(90749),i(57996),i(56631),i(9971),i(849),i(72272);var zr,Wr=i(60136);function Hr(e){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some((t=>{const i="\\b"+t+"\\b";return e&&(e===t||e.match(new RegExp(i,"g")))})))return e;const t=e.lastIndexOf("."),i=e.lastIndexOf("?"),r=i>-1?e.substring(i,e.length):"";return(t>-1?e.substring(0,t):e)+this._textureFormatInUse+r}!function(e){e[e.Texture=0]="Texture",e[e.StorageTexture=1]="StorageTexture",e[e.UniformBuffer=2]="UniformBuffer",e[e.StorageBuffer=3]="StorageBuffer",e[e.TextureWithoutSampler=4]="TextureWithoutSampler",e[e.Sampler=5]="Sampler",e[e.ExternalTexture=6]="ExternalTexture",e[e.DataBuffer=7]="DataBuffer"}(zr||(zr={})),Ir.ThinEngine.prototype.createComputeEffect=function(e,t){throw new Error("createComputeEffect: This engine does not support compute shaders!")},Ir.ThinEngine.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")},Ir.ThinEngine.prototype.createComputeContext=function(){},Ir.ThinEngine.prototype.computeDispatch=function(e,t,i,r,n,s,a){throw new Error("computeDispatch: This engine does not support compute shaders!")},Ir.ThinEngine.prototype.computeDispatchIndirect=function(e,t,i,r,n,s){throw new Error("computeDispatchIndirect: This engine does not support compute shaders!")},Ir.ThinEngine.prototype.areAllComputeEffectsReady=function(){return!0},Ir.ThinEngine.prototype.releaseComputeEffects=function(){},Ir.ThinEngine.prototype._prepareComputePipelineContext=function(e,t,i,r,n){},Ir.ThinEngine.prototype._rebuildComputeEffects=function(){},ne.$.prototype._executeWhenComputeStateIsCompiled=function(e,t){t(null)},Ir.ThinEngine.prototype._releaseComputeEffect=function(e){},Ir.ThinEngine.prototype._deleteComputePipelineContext=function(e){},Object.defineProperty(_i.N.prototype,"texturesSupported",{get:function(){const e=[];return this._caps.astc&&e.push("-astc.ktx"),this._caps.s3tc&&e.push("-dxt.ktx"),this._caps.pvrtc&&e.push("-pvrtc.ktx"),this._caps.etc2&&e.push("-etc2.ktx"),this._caps.etc1&&e.push("-etc1.ktx"),e},enumerable:!0,configurable:!0}),Object.defineProperty(_i.N.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),_i.N.prototype.setCompressedTextureExclusions=function(e){this._excludedCompressedTextures=e},_i.N.prototype.setTextureFormatToUse=function(e){const t=this.texturesSupported;for(let i=0,r=t.length;i<r;i++)for(let r=0,n=e.length;r<n;r++)if(t[i]===e[r].toLowerCase())return this._transformTextureUrl=Hr.bind(this),this._textureFormatInUse=t[i];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class Yr{constructor(){const e=new ArrayBuffer(Yr.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=Yr.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream((()=>{this._flush()}))}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}Yr.DEFAULT_BUFFER_SIZE=65536;var Xr=i(82942),qr=i(18461),$r=i(72118);const jr=/(flat\s)?\s*varying\s*.*/;class Kr{constructor(){this.shaderLanguage=0}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");const t=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==t){const i=t[1],r=t[2],n=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[r];if(void 0!==n){const s=n<0?-1===n?"int":"ivec"+-n:1===n?"uint":"uvec"+n,a=`_int_${r}_`;e=e.replace(t[0],`in ${s} ${a}; ${i} ${r};`),this._nativeProcessingContext.injectInVertexMain+=`${r} = ${i}(${a});\n`,this._nativeProcessingContext.remappedAttributeNames[r]=a}else e=e.replace(t[0],`in ${i} ${r};`)}return e}varyingCheck(e,t){return jr.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(this._nativeProcessingContext?.injectInVertexMain&&(e=(0,$r.bI)(e,"void main",this._nativeProcessingContext.injectInVertexMain)),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}class Zr{get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,n,s,a,o){const l=this._engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let c;for(this._engine.getUniforms(this,i).forEach(((e,t)=>{r[i[t]]=e})),this._uniforms=r,c=0;c<n.length;c++)null==e.getUniform(n[c])&&(n.splice(c,1),c--);n.forEach(((e,t)=>{s[e]=t})),o.push(...l.getAttributes(this,a))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(e,t,i,r){let n=this._valueCache[e];if(!n)return n=[t,i,r],this._valueCache[e]=n,!0;let s=!1;return n[0]!==t&&(n[0]=t,s=!0),n[1]!==i&&(n[1]=i,s=!0),n[2]!==r&&(n[2]=r,s=!0),s}_cacheFloat4(e,t,i,r,n){let s=this._valueCache[e];if(!s)return s=[t,i,r,n],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==i&&(s[1]=i,a=!0),s[2]!==r&&(s[2]=r,a=!0),s[3]!==n&&(s[3]=n,a=!0),a}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class Qr extends Or.v{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class Jr{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}var en=i(85647);function tn(e,t){switch(e){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break;case 5:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break;case 6:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break;case 7:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break;case 12:if(0===t)return _native.Engine.TEXTURE_FORMAT_BGRA8}throw new en.bu(`Unsupported texture format or type: format ${e}, type ${t}.`,en.tG.UnsupportedTextureError)}function rn(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${e}.`)}}function nn(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}}function sn(e){switch(e){case Ue.R.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case Ue.R.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case Ue.R.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case Ue.R.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case Ue.R.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${e}.`)}}var an=i(96642);class on{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}}var ln=i(84306);const cn=new n.cP;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let e;Object.defineProperty(self,"_native",{get:()=>e,set:t=>{e=t,e&&cn.notifyObservers(e)}})}function hn(){return new Promise((e=>{"undefined"==typeof _native?cn.addOnce((t=>e(t))):e(_native)}))}async function un(e,t){(await hn())[e]=t}class dn extends We.n{}class pn{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=mn._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}const fn=[];class mn extends _i.N{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine({version:_i.N.Version,nonFloatVertexBuffers:!0}),this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new pn(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,this._fillModeWarningDisplayed=!1,_native.Engine.PROTOCOL_VERSION!==mn.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${mn.PROTOCOL_VERSION} (JS)`);this._engine.setDeviceLostCallback&&this._engine.setDeviceLostCallback((()=>{this.onContextLostObservable.notifyObservers(this),this._contextWasLost=!0,this._restoreEngineAfterContextLost()})),this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxDrawBuffers:8,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1,parallelShaderCompile:{COMPLETION_STATUS_KHR:0},textureNorm16:!1},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},re.S0.Log("Babylon Native (v"+_i.N.Version+") launched"),re.S0.LoadScript=function(e,t,i,r){re.S0.LoadFile(e,(e=>{Function(e).apply(null),t&&t()}),void 0,void 0,!1,((e,t)=>{i&&i("LoadScript Error",t)}))},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(e){return e}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){const t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(i,r){return Array.isArray(r)?i.push.apply(i,e.call(r,t-1)):i.push(r),i}),[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new Kr,this.onNewSceneAddedObservable.add((e=>{const t=e.render;e.render=(...i)=>{this._commandBufferEncoder.beginCommandScope(),t.apply(e,i),this._commandBufferEncoder.endCommandScope()}}))}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new Yr}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_restoreEngineAfterContextLost(){this._clearEmptyResources();const e=this._depthCullingState.depthTest,t=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;this._rebuildGraphicsResources(),this._depthCullingState.depthTest=e,this._depthCullingState.depthFunc=t,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=r,this._flagContextRestored()}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,r=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t,i){const r=this._normalizeIndexData(e),n=new dn;return n.references=1,n.is32Bits=4===r.BYTES_PER_ELEMENT,r.byteLength&&(n.nativeIndexBuffer=this._engine.createIndexBuffer(r.buffer,r.byteOffset,r.byteLength,n.is32Bits,t??!1)),n}createVertexBuffer(e,t,i){const r=ArrayBuffer.isView(e)?e:new Float32Array(e),n=new dn;return n.references=1,r.byteLength&&(n.nativeVertexBuffer=this._engine.createVertexBuffer(r.buffer,r.byteOffset,r.byteLength,t??!1)),n}_recordVertexArrayObject(e,t,i,r,n){r._checkedNonFloatVertexBuffers||((0,an.z)(t,r),r._checkedNonFloatVertexBuffers=!0),i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const s=r.getAttributesNames();for(let i=0;i<s.length;i++){const a=r.getAttributeLocation(i);if(a>=0){const r=s[i];let o=null;if(n&&(o=n[r]),o||(o=t[r]),o){const t=o.effectiveBuffer;t&&t.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,t.nativeVertexBuffer,a,o.effectiveByteOffset,o.effectiveByteStride,o.getSize(),sn(o.type),o.normalized,o.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,r){const n=this._engine.createVertexArray();return this._recordVertexArrayObject(n,e,t,i,r),n}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e,r=i.shaderProcessingContext;fn.length=0;for(let e=0;e<t.length;e++){const i=t[e],n=r.remappedAttributeNames[i]??i;fn[e]=n}return this._engine.getAttributes(i.program,fn)}_checkSupportedFillMode(e){return 5!=e&&8!=e||(this._fillModeWarningDisplayed||(f.V.Warn("Line Loop and Triangle Fan are not supported fill modes with Babylon Native. Elements with these fill mode will not be visible."),this._fillModeWarningDisplayed=!0),!1)}drawElementsType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINDEXEDINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}drawArraysType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}createPipelineContext(e){const t=!(!this._caps.parallelShaderCompile||!this._engine.createProgramAsync);return new Zr(this,t,e)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,r,n,s,a,o,l,c,h){r?this.createRawShaderProgram():this.createShaderProgram(e,t,i,o),h()}_getShaderProcessingContext(e){return new on}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(i.isAsync)if(i.onCompiled){const e=i.onCompiled;i.onCompiled=()=>{e(),t()}}else i.onCompiled=t;else t()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,r){const n=e;this.onBeforeShaderCompilationObservable.notifyObservers(this);const s=new qr.Y(t);s.processCode(),t=s.code;const a=new qr.Y(i);a.processCode(),i=a.code,t=Ir.ThinEngine._ConcatenateShader(t,r),i=Ir.ThinEngine._ConcatenateShader(i,r);const o=()=>{n.isCompiled=!0,n.onCompiled?.(),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(e.isAsync)n.program=this._engine.createProgramAsync(t,i,o,(e=>{n.compilationError=e}));else try{n.program=this._engine.createProgram(t,i),o()}catch(e){const t=e?.message;throw new Error("SHADER ERROR"+("string"==typeof t?"\n"+t:""))}return n.program}inlineShaderCode(e){const t=new qr.Y(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.program&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.program),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.program,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const r=e.getUniform(i[t]);r&&(this._boundUniforms[t]=r)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setState(e,t=0,i,r=!1,n,s,a=0){this._zOffset=t,this._zOffsetUnits=a,0!==this._zOffset&&re.S0.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(a),this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces??n??1?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${e}.`)}}(this._stencilOpStencilFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${e}.`)}}(this._stencilOpDepthFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${e}.`)}}(this._stencilOpStencilDepthPass),function(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${e}.`)}}(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,r,n,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,r){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=function(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${e}.`)}}(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(0===e),this._alphaMode=e}setInt(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(e,t){return!!e&&this.setFloatArray(e,new Float32Array(t))}setArray2(e,t){return!!e&&this.setFloatArray2(e,new Float32Array(t))}setArray3(e,t){return!!e&&this.setFloatArray3(e,new Float32Array(t))}setArray4(e,t){return!!e&&this.setFloatArray4(e,new Float32Array(t))}setMatrices(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(e,t,i){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(e,t,i,r){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(e,t,i,r,n){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(e,t){return!!e&&(this.setFloat3(e,t.r,t.g,t.b),!0)}setColor4(e,t,i){return!!e&&(this.setFloat4(e,t.r,t.g,t.b,i),!0)}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e.underlyingResource)}updateDynamicTexture(e,t,i,r=!1,n){if(void 0===r&&(r=!1),e&&e._hardwareTexture){const i=t.getCanvasTexture(),r=e._hardwareTexture.underlyingResource;this._engine.copyTexture(r,i),e.isReady=!0}}createDynamicTexture(e,t,i,r){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,r)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const r=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(r,t,i)}}createRawTexture(e,t,i,r,n,s,a,o=null,l=0,c=0,h=!1){const u=new gi.hV(this,3);if(u.format=r,u.generateMipMaps=n,u.samplingMode=a,u.invertY=s,u.baseWidth=t,u.baseHeight=i,u.width=u.baseWidth,u.height=u.baseHeight,u._compression=o,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(h,!n),this.updateRawTexture(u,e,r,s,o,l,u._useSRGBBuffer),u._hardwareTexture){const e=u._hardwareTexture.underlyingResource,t=rn(a);this._setTextureSampling(e,t)}return this._internalTexturesCache.push(u),u}createRawTexture2DArray(e,t,i,r,n,s,a,o,l=null,c=0){const h=new gi.hV(this,11);if(h.baseWidth=t,h.baseHeight=i,h.baseDepth=r,h.width=t,h.height=i,h.depth=r,h.format=n,h.type=c,h.generateMipMaps=s,h.samplingMode=o,h.is2DArray=!0,h._hardwareTexture){const l=h._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(l,e,t,i,r,tn(n,c),s,a);const u=rn(o);this._setTextureSampling(l,u)}return h.isReady=!0,this._internalTexturesCache.push(h),h}updateRawTexture(e,t,i,r,n=null,s=0,a=!1){if(e){if(t&&e._hardwareTexture){const r=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(r,t,e.width,e.height,tn(i,s),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,r,n=3,s=null,a=null,o=null,l=null,c=null,h=null,u,d,p,m=!1){const _="data:"===(e=e||"").substring(0,5),g=_&&-1!==e.indexOf(";base64,"),v=l||new gi.hV(this,1),S=e;!this._transformTextureUrl||g||l||o||(e=this._transformTextureUrl(e));const x=e.lastIndexOf("."),T=h||(x>-1?e.substring(x).toLowerCase():"");let E=null;(T.endsWith(".basis")||T.endsWith(".ktx")||T.endsWith(".ktx2")||"image/ktx"===u||"image/ktx2"===u)&&(E=(0,ln.gT)(T)),r&&r.addPendingData(v),v.url=e,v.generateMipMaps=!t,v.samplingMode=n,v.invertY=i,v._useSRGBBuffer=this._getUseSRGBBuffer(m,t),this.doNotHandleContextLost||(v._buffer=o);let C=null;s&&!l&&(C=v.onLoadedObservable.add(s)),l||this._internalTexturesCache.push(v);const b=(i,l)=>{r&&r.removePendingData(v),e===S?(C&&v.onLoadedObservable.remove(C),P.q.UseFallbackTexture&&this.createTexture(P.q.FallbackTexture,t,v.invertY,r,n,null,a,o,v),a&&a((i||"Unknown error")+(P.q.UseFallbackTexture?" - Fallback texture was used":""),l)):(f.V.Warn(`Failed to load ${e}, falling back to ${S}`),this.createTexture(S,t,v.invertY,r,n,s,a,o,v,c,h,u,d))};if(E)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const s=e=>{if(!v._hardwareTexture)return void(r&&r.removePendingData(v));const s=v._hardwareTexture.underlyingResource;this._engine.loadTexture(s,e,!t,i,v._useSRGBBuffer,(()=>{v.baseWidth=this._engine.getTextureWidth(s),v.baseHeight=this._engine.getTextureHeight(s),v.width=v.baseWidth,v.height=v.baseHeight,v.isReady=!0;const e=rn(n);this._setTextureSampling(s,e),r&&r.removePendingData(v),v.onLoadedObservable.notifyObservers(v),v.onLoadedObservable.clear()}),(()=>{throw new Error("Could not load a native texture.")}))};if(_&&o)if(o instanceof ArrayBuffer)s(new Uint8Array(o));else if(ArrayBuffer.isView(o))s(o);else{if("string"!=typeof o)throw new Error("Unsupported buffer type");s(new Uint8Array(re.S0.DecodeBase64(o)))}else g?s(new Uint8Array(re.S0.DecodeBase64(e))):this._loadFile(e,(e=>s(new Uint8Array(e))),void 0,void 0,!0,((e,t)=>{b("Unable to load "+(e&&e.responseURL,t))}))}return v}wrapNativeTexture(e,t=!1,i=3){const r=new Jr(e,this._engine),n=new gi.hV(this,0,!0);return n._hardwareTexture=r,n.baseWidth=this._engine.getTextureWidth(e),n.baseHeight=this._engine.getTextureHeight(e),n.width=n.baseWidth,n.height=n.baseHeight,n.isReady=!0,n.useMipMaps=t,this.updateTextureSamplingMode(i,n),n}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){const r=t.generateStencil||!1,n=t.samples||1,s=i,a=new gi.hV(this,12),o=e.width??e,l=e.height??e,c=this._engine.createFrameBuffer(a._hardwareTexture.underlyingResource,o,l,r,!0,n);return s._framebufferDepthStencil=c,a}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){const i=new Promise(((t,i)=>{const r=this.createCanvasImage();r.onload=()=>{try{const e=this._engine.createImageBitmap(r);t(e)}catch(e){i(`Error loading image ${r.src} with exception: ${e}`)}},r.onerror=e=>{i(`Error loading image ${r.src} with exception: ${e}`)},r.src=e}));return i}createImageBitmap(e,t){return new Promise(((t,i)=>{if(Array.isArray(e)){const i=e;if(i.length){const e=this._engine.createImageBitmap(i[0]);if(e)return void t(e)}}i("Unsupported data for createImageBitmap.")}))}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,r,n=null,s=null,a,o=null,l=!1,c=0,h=0,u=null,d,p=!1,f=null){const m=u||new gi.hV(this,7);m.isCube=!0,m.url=e,m.generateMipMaps=!r,m._lodGenerationScale=c,m._lodGenerationOffset=h,m._useSRGBBuffer=this._getUseSRGBBuffer(p,!!r),this._doNotHandleContextLost||(m._extension=o,m._files=i,m._buffer=f);const _=e.lastIndexOf(".");if(".env"===(o||(_>-1?e.substring(_).toLowerCase():""))){const t=e=>{const t=(0,Xr.cU)(e);m.width=t.width,m.height=t.width,(0,Xr.ow)(m,t);const i=t.specular;if(!i)throw new Error("Nothing else parsed so far");m._lodGenerationScale=i.lodGenerationScale;const r=(0,Xr.$h)(e,t);m.format=5,m.type=0,m.generateMipMaps=!0,m.getEngine().updateTextureSamplingMode(_e.g.TRILINEAR_SAMPLINGMODE,m),m._isRGBD=!0,m.invertY=!0,this._engine.loadCubeTextureWithMips(m._hardwareTexture.underlyingResource,r,!1,m._useSRGBBuffer,(()=>{m.isReady=!0,n&&n()}),(()=>{throw new Error("Could not load a native cube texture.")}))};if(f)t(f);else{if(i&&6===i.length)throw new Error("Multi-file loading not allowed on env files.");{const i=(e,t)=>{s&&e&&s(e.status+" "+e.statusText,t)};this._loadFile(e,(e=>{t(new Uint8Array(e,0,e.byteLength))}),void 0,void 0,!0,i)}}}else{if(!i||6!==i.length)throw new Error("Cannot load cubemap because 6 files were not defined");const e=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(e.map((e=>this._loadFileAsync(e,void 0,!0).then((e=>new Uint8Array(e,0,e.byteLength)))))).then((e=>new Promise(((t,i)=>{this._engine.loadCubeTexture(m._hardwareTexture.underlyingResource,e,!r,!0,m._useSRGBBuffer,t,i)})))).then((()=>{m.isReady=!0,n&&n()}),(e=>{s&&s(`Failed to load cubemap: ${e.message}`,e)}))}return this._internalTexturesCache.push(m),m}_createHardwareTexture(){return new Jr(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const r=new Qr(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}_createInternalTexture(e,t,i=!0,r=0){let n,s=!1,a=0,o=3,l=5,c=!1,h=1;void 0!==t&&"object"==typeof t?(s=!!t.generateMipMaps,a=void 0===t.type?0:t.type,o=void 0===t.samplingMode?3:t.samplingMode,l=void 0===t.format?5:t.format,c=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,h=t.samples??1,n=t.label):s=!!t,c=this._getUseSRGBBuffer(c,!s),(1!==a||this._caps.textureFloatLinearFiltering)&&(2!==a||this._caps.textureHalfFloatLinearFiltering)||(o=1),1!==a||this._caps.textureFloat||(a=0,f.V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const u=new gi.hV(this,r),d=e.width??e,p=e.height??e,m=e.layers||0;if(0!==m)throw new Error("Texture layers are not supported in Babylon Native");const _=u._hardwareTexture.underlyingResource,g=tn(l,a);return this._engine.initializeTexture(_,d,p,s,g,!0,c,h),this._setTextureSampling(_,rn(o)),u._useSRGBBuffer=c,u.baseWidth=d,u.baseHeight=p,u.width=d,u.height=p,u.depth=m,u.isReady=!0,u.samples=h,u.generateMipMaps=s,u.samplingMode=o,u.type=a,u.format=l,u.label=n,this._internalTexturesCache.push(u),u}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e);let r,n=!0,s=!1,a=!1,o=1;void 0!==t&&"object"==typeof t&&(n=t.generateDepthBuffer??!0,s=!!t.generateStencilBuffer,a=!!t.noColorAttachment,r=t.colorAttachment,o=t.samples??1);const l=r||(a?null:this._createInternalTexture(e,t,!0,5)),c=e.width??e,h=e.height??e,u=this._engine.createFrameBuffer(l?l._hardwareTexture.underlyingResource:null,c,h,s,n,o);return i._framebuffer=u,i._generateDepthBuffer=n,i._generateStencilBuffer=s,i._samples=o,i.setTextures(l),i}updateRenderTargetTextureSampleCount(e,t){return f.V.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=rn(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,r,n){const s=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||r)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");s._framebufferDepthStencil?this._bindUnboundFramebuffer(s._framebufferDepthStencil):this._bindUnboundFramebuffer(s._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const r=e,n=this._normalizeIndexData(t);r.is32Bits=4===n.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(r.nativeIndexBuffer,n.buffer,n.byteOffset,n.byteLength,i)}updateDynamicVertexBuffer(e,t,i=0,r){const n=e,s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,a=new Uint8Array(s.buffer,s.byteOffset,r??s.byteLength);this._engine.updateDynamicVertexBuffer(n.nativeVertexBuffer,a.buffer,a.byteOffset,a.byteLength,i)}_setTexture(e,t,i=!1,r=!1){const n=this._boundUniforms[e];if(!n)return!1;if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._boundTexturesCache[e]=null,this._unsetNativeTexture(n)),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let s;return s=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=e,!(!s||!s._hardwareTexture||(this._setTextureWrapMode(s._hardwareTexture.underlyingResource,nn(t.wrapU),nn(t.wrapV),nn(t.wrapR)),this._updateAnisotropicLevel(t),this._setNativeTexture(n,s._hardwareTexture.underlyingResource),0))}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand()}_setNativeTexture(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_unsetNativeTexture(e){_native.Engine.COMMAND_UNSETTEXTURE&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNSETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;t&&t._hardwareTexture&&t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_bindTexture(e,t){const i=this._boundUniforms[e];if(i)if(t&&t._hardwareTexture){const e=t._hardwareTexture.underlyingResource;this._setNativeTexture(i,e)}else this._unsetNativeTexture(i)}unbindAllTextures(){_native.Engine.COMMAND_DISCARDALLTEXTURES&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DISCARDALLTEXTURES),this._commandBufferEncoder.finishEncodingCommand())}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,r,n,s,a=0,o=0,l=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,s=0,a=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,r=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(e){return{ascent:0,height:0,descent:0}}flushFramebuffer(){}_readTexturePixels(e,t,i,r,n,s,a,o,l,c){if(void 0!==r&&-1!==r)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${r}.`);return this._engine.readTexture(e._hardwareTexture?.underlyingResource,n??0,l??0,c??0,t,i,s?.buffer??null,s?.byteOffset??0,s?.byteLength??0).then((e=>(s||(s=new Uint8Array(e)),s)))}}mn.PROTOCOL_VERSION=8,mn._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new _n:new Yr};class _n extends Yr{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}i(62038);var gn=i(22261);class vn{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){const r=this._bindGroupEntries.length>0;for(const t in e){const n=e[t],s=i[t],a=s.group,o=s.binding,l=n.type,c=n.object;let h=n.indexInGroupEntries,u=this._bindGroupEntries[a];switch(u||(u=this._bindGroupEntries[a]=[]),l){case 5:{const e=c;void 0!==h&&r?u[h].resource=this._cacheSampler.getSampler(e):(n.indexInGroupEntries=u.length,u.push({binding:o,resource:this._cacheSampler.getSampler(e)}));break}case 0:case 4:{const e=c,t=e._texture._hardwareTexture;void 0!==h&&r?(0===l&&(u[h++].resource=this._cacheSampler.getSampler(e._texture)),u[h].resource=t.view):(n.indexInGroupEntries=u.length,0===l&&u.push({binding:o-1,resource:this._cacheSampler.getSampler(e._texture)}),u.push({binding:o,resource:t.view}));break}case 1:{const e=c,t=e._texture._hardwareTexture;8&t.textureAdditionalUsages||f.V.Error(`computeDispatch: The texture (name=${e.name}, uniqueId=${e.uniqueId}) is not a storage texture!`,50),void 0!==h&&r?u[h].resource=t.viewForWriting:(n.indexInGroupEntries=u.length,u.push({binding:o,resource:t.viewForWriting}));break}case 6:{const e=c.underlyingResource;void 0!==h&&r?u[h].resource=this._device.importExternalTexture({source:e}):(n.indexInGroupEntries=u.length,u.push({binding:o,resource:this._device.importExternalTexture({source:e})}));break}case 2:case 3:case 7:{const e=7===l?c:c.getBuffer(),t=e.underlyingResource;void 0!==h&&r?(u[h].resource.buffer=t,u[h].resource.size=e.capacity):(n.indexInGroupEntries=u.length,u.push({binding:o,resource:{buffer:t,offset:0,size:e.capacity}}));break}}}for(let e=0;e<this._bindGroupEntries.length;++e){const i=this._bindGroupEntries[e];this._bindGroups[e]=i?this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:i}):void 0}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=vn._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}vn._Counter=0;class Sn{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}}const xn={};gn.$.prototype.createComputeContext=function(){return new vn(this._device,this._cacheSampler)},gn.$.prototype.createComputeEffect=function(e,t){const i=("string"==typeof e?e:e.computeToken||e.computeSource||e.computeElement||e.compute)+"@"+t.defines;if(this._compiledComputeEffects[i]){const e=this._compiledComputeEffects[i];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}const r=new ur(e,t,this,i);return this._compiledComputeEffects[i]=r,r},gn.$.prototype.createComputePipelineContext=function(){return new Sn(this)},gn.$.prototype.areAllComputeEffectsReady=function(){for(const e in this._compiledComputeEffects)if(!this._compiledComputeEffects[e].isReady())return!1;return!0},gn.$.prototype.computeDispatch=function(e,t,i,r,n=1,s=1,a,o){this._computeDispatch(e,t,i,r,n,s,void 0,void 0,a,o)},gn.$.prototype.computeDispatchIndirect=function(e,t,i,r,n=0,s,a){this._computeDispatch(e,t,i,void 0,void 0,void 0,r,n,s,a)},gn.$.prototype._computeDispatch=function(e,t,i,r,n,s,a,o,l,c){this._endCurrentRenderPass();const h=e._pipelineContext,u=t;h.computePipeline||(h.computePipeline=this._device.createComputePipeline({layout:"auto",compute:h.stage})),c&&this._timestampQuery.startPass(xn,this._timestampIndex);const d=this._renderEncoder.beginComputePass(xn);d.setPipeline(h.computePipeline);const p=u.getBindGroups(i,h.computePipeline,l);for(let e=0;e<p.length;++e){const t=p[e];t&&d.setBindGroup(e,t)}void 0!==a?d.dispatchWorkgroupsIndirect(a.underlyingResource,o):r+n+s>0&&d.dispatchWorkgroups(r,n,s),d.end(),c&&(this._timestampQuery.endPass(this._timestampIndex,c),this._timestampIndex+=2)},gn.$.prototype.releaseComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},gn.$.prototype._prepareComputePipelineContext=function(e,t,i,r,n){const s=e;this.dbgShowShaderCode&&(f.V.Log(r),f.V.Log(t)),s.sources={compute:t,rawCompute:i},s.stage=this._createComputePipelineStageDescriptor(t,r,n)},gn.$.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},gn.$.prototype._rebuildComputeEffects=function(){for(const e in this._compiledComputeEffects){const t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},gn.$.prototype._executeWhenComputeStateIsCompiled=function(e,t){e.stage.module.getCompilationInfo().then((e=>{const i={numErrors:0,messages:[]};for(const t of e.messages)"error"===t.type&&i.numErrors++,i.messages.push({type:t.type,text:t.message,line:t.lineNum,column:t.linePos,length:t.length,offset:t.offset});t(i)}))},gn.$.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},gn.$.prototype._createComputePipelineStageDescriptor=function(e,t,i){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:i}},i(2306),gn.$.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.pushDebugGroup(e)):this._currentRenderPass?(this._currentRenderPass.pushDebugGroup(e),this._debugStackRenderPass.push(e)):this._pendingDebugCommands.push(["push",e,t]))},gn.$.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?(1===e&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.popDebugGroup()):this._currentRenderPass?(this._currentRenderPass.popDebugGroup(),this._debugStackRenderPass.pop()):this._pendingDebugCommands.push(["pop",null,e]))},gn.$.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.insertDebugMarker(e)):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e,t]))},gn.$.prototype._debugFlushPendingCommands=function(){if(0!==this._debugStackRenderPass.length){const e=this._debugStackRenderPass.slice();this._debugStackRenderPass.length=0;for(let t=0;t<e.length;++t)this._debugPushGroup(e[t],2)}for(let e=0;e<this._pendingDebugCommands.length;++e){const[t,i,r]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(i,r);break;case"pop":this._debugPopGroup(r);break;case"insert":this._debugInsertMarker(i,r)}}this._pendingDebugCommands.length=0};var Tn=i(91585);gn.$.prototype.createDynamicTexture=function(e,t,i,r){const n=new gi.hV(this,4);return n.baseWidth=e,n.baseHeight=t,i&&(e=this.needPOTTextures?(0,Tn.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,Tn.R)(t,this._caps.maxTextureSize):t),n.width=e,n.height=t,n.isReady=!1,n.generateMipMaps=i,n.samplingMode=r,this.updateTextureSamplingMode(r,n),this._internalTexturesCache.push(n),e&&t&&this._textureHelper.createGPUTextureForInternalTexture(n,e,t),n},gn.$.prototype.updateDynamicTexture=function(e,t,i,r=!1,n,s,a){if(!e)return;const o=t.width,l=t.height;let c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e,o,l)),this._textureHelper.updateTexture(t,e,o,l,e.depth,c.format,0,0,i,r,0,0,a),e.generateMipMaps&&this._generateMipmaps(e),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0},gn.$.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){i&&i(),this._endCurrentRenderPass(),t||this.generateMipMapsMultiFramebuffer(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},gn.$.prototype.createMultipleRenderTarget=function(e,t,i){let r=!1,n=!0,s=!1,a=!1,o=15,l=1,c=1,h=[],u=[],d=[],p=[],m=[],_=[],g=[],v=[],S=[],x=[],T=!1;const E=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(r=t.generateMipMaps??!1,n=t.generateDepthBuffer??!0,s=t.generateStencilBuffer??!1,a=t.generateDepthTexture??!1,l=t.textureCount??1,o=t.depthTextureFormat??15,h=t.types||h,u=t.samplingModes||u,d=t.useSRGBBuffers||d,p=t.formats||p,m=t.targetTypes||m,_=t.faceIndex||_,g=t.layerIndex||g,v=t.layerCounts||v,S=t.labels||S,x=t.creationFlags||x,c=t.samples??c,T=t.dontCreateTextures??!1);const C=e.width??e,b=e.height??e,P=[],y=[],A=[];E.label=t?.label??"MultiRenderTargetWrapper",E._generateDepthBuffer=n,E._generateStencilBuffer=s,E._attachments=y,E._defaultAttachments=A;let R=null;(n||s||a)&&!T&&(a||(o=n&&s?13:n?14:19),R=E.createDepthStencilTexture(0,!1,s,1,o,E.label+"-DepthStencil"));const I=void 0!==t&&"object"==typeof t&&t.createMipMaps&&!r;for(let e=0;e<l;e++){let t=u[e]||3,n=h[e]||0;const s=p[e]||5,a=!!d[e]&&this._caps.supportSRGBBuffers,o=m[e]||3553,l=v[e]??1,c=x[e];if((1!==n||this._caps.textureFloatLinearFiltering)&&(2!==n||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==n||this._caps.textureFloat||(n=0,f.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),y.push(e+1),A.push(i?e+1:0===e?1:0),-1===o||T)continue;const _=new gi.hV(this,6);switch(P[e]=_,o){case 34067:_.isCube=!0;break;case 32879:_.is3D=!0,_.baseDepth=_.depth=l;break;case 35866:_.is2DArray=!0,_.baseDepth=_.depth=l}_.baseWidth=C,_.baseHeight=b,_.width=C,_.height=b,_.isReady=!0,_.samples=1,_.generateMipMaps=r,_.samplingMode=t,_.type=n,_._cachedWrapU=0,_._cachedWrapV=0,_._useSRGBBuffer=a,_.format=s,_.label=S[e]??E.label+"-Texture"+e,this._internalTexturesCache.push(_),I&&(_.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(_,void 0,void 0,void 0,c,!0),I&&(_.generateMipMaps=!1)}return R&&(R.incrementReferences(),P[l]=R,this._internalTexturesCache.push(R)),E.setTextures(P),E.setLayerAndFaceIndices(g,_),T?E._samples=c:this.updateMultipleRenderTargetTextureSampleCount(E,c),E},gn.$.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||0===e.textures.length||e.textures[0].samples===t)return t;const i=e.textures.length;if(0===i)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<i;++t){const i=e.textures[t]._hardwareTexture;i?.releaseMSAATexture(e.getBaseArrayLayer(t))}const r=e._depthStencilTexture===e.textures[i-1];for(let r=0;r<i;++r){const i=e.textures[r];this._textureHelper.createMSAATexture(i,t,!1,e.getBaseArrayLayer(r)),i.samples=t}return e._depthStencilTexture&&!r&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,t},gn.$.prototype.generateMipMapsMultiFramebuffer=function(e){const t=e;if(!t.isMulti)return;const i=t._attachments.length;for(let e=0;e<i;e++){const i=t.textures[e];!i.generateMipMaps||i.isCube||i.is3D||this._generateMipmaps(i)}},gn.$.prototype.resolveMultiFramebuffer=function(e){throw new Error("resolveMultiFramebuffer is not yet implemented in WebGPU!")},gn.$.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},gn.$.prototype.buildTextureLayout=function(e){const t=[];for(let i=0;i<e.length;i++)e[i]?t.push(i+1):t.push(0);return t},gn.$.prototype.restoreSingleAttachment=function(){},gn.$.prototype.restoreSingleAttachmentForRenderTarget=function(){},i(73346),i(29397),i(88945),i(6781),i(97476),i(49646),gn.$.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let r=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(r=this._textureHelper.createGPUTextureForInternalTexture(e)),function(e){return!(!e||void 0===e.underlyingResource)}(t)){if(t.isReady()){try{this._textureHelper.copyVideoToTexture(t,e,r.format,!i),e.generateMipMaps&&this._generateMipmaps(e)}catch(e){}e.isReady=!0}}else t&&this.createImageBitmap(t).then((t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,r.format,0,0,!i,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0})).catch((()=>{e.isReady=!0}))};var En=i(16058),Cn=i(24836),bn=i(42501),Pn=i(1377),yn=i(84960),An=i(76427),Rn=i(42200),In=i(17304),Mn=i(56709),On=i(39594),Nn=i(62796),Dn=i(82617);class Fn{static async CreateAsync(e,t){return await gn.$.IsSupportedAsync?gn.$.CreateAsync(e,t):_i.N.IsSupported?new _i.N(e,void 0,t):new Fr(t)}}var Ln=i(709),wn=i(4407),Bn=i(22479),Vn=i(41954),kn=i(26523),Gn=i(53496),Un=i(82106),zn=i(58628),Wn=i(80616),Hn=i(63217);class Yn{constructor(e){this._context=e,this._context.onNodeExecutedObservable.add((e=>{re.S0.Log(`Node executed: ${e.getClassName()}`)}))}}var Xn=i(58015),qn=i(55591),$n=i(59433),jn=i(48078),Kn=i(95437),Zn=i(73587);class Qn extends Gn.u{constructor(e){super(e),this.condition=this.registerDataInput("condition",zn.RI),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FGBranchBlock"}}(0,o.Y5)("FGBranchBlock",Qn);var Jn=i(45427),es=i(23234);class ts extends es.w{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",zn.Es),this.endIndex=this.registerDataInput("endIndex",zn.Es),this.step=this.registerDataInput("step",zn.Es),this.index=this.registerDataOutput("index",zn.Es),this.onLoop=this._registerSignalOutput("onLoop")}_executeLoop(e){let t=e._getExecutionVariable(this,"index");t<e._getExecutionVariable(this,"endIndex")?(this.index.setValue(t,e),this.onLoop._activateSignal(e),t+=e._getExecutionVariable(this,"step",1),e._setExecutionVariable(this,"index",t),this._executeLoop(e)):this.out._activateSignal(e)}_execute(e){const t=this.startIndex.getValue(e),i=this.endIndex.getValue(e),r=this.step.getValue(e);e._setExecutionVariable(this,"index",t),e._setExecutionVariable(this,"endIndex",i),e._setExecutionVariable(this,"step",r),this._executeLoop(e)}getClassName(){return"FGForLoopBlock"}}(0,o.Y5)("FGForLoopBlock",ts);class is extends es.w{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",zn.Es),this.timeRemaining=this.registerDataOutput("timeRemaining",zn.Es)}_execute(e,t){const i=e._getExecutionVariable(this,"lastExecutedTime"),r=this.duration.getValue(e),n=Date.now();if(t===this.reset||void 0===i||n-i>r)this.timeRemaining.setValue(0,e),this.out._activateSignal(e),e._setExecutionVariable(this,"lastExecutedTime",n);else{const t=r-(n-i);this.timeRemaining.setValue(t,e)}}getClassName(){return"FGThrottleBlock"}}(0,o.Y5)("FGThrottleBlock",is);var rs=i(34571);class ns extends Gn.u{constructor(e){super(e),this.config=e,this._cachedUnusedIndexes=[],this.reset=this._registerSignalInput("reset"),this.currentIndex=this.registerDataOutput("currentIndex",zn.Es),this.config.startIndex=void 0!==this.config.startIndex?this.config.startIndex:0,this.config.startIndex=Math.max(0,Math.min(this.config.startIndex,this.config.numberOutputFlows-1)),this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(`out${e}`))}_getUnusedIndexes(e){const t=this._cachedUnusedIndexes;if(t.length=0,e._hasExecutionVariable(this,"unusedIndexes")){const i=e._getExecutionVariable(this,"unusedIndexes");for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.numberOutputFlows;e++)t.push(e);return t}_getNextOutput(e,t){return this.config.isRandom?t[Math.floor(Math.random()*t.length)]:e+1}_execute(e,t){const i=e._getExecutionVariable(this,"currentIndex")??this.config.startIndex-1;let r=this._getUnusedIndexes(e);if(t===this.reset)return e._deleteExecutionVariable(this,"currentIndex"),void e._deleteExecutionVariable(this,"unusedIndexes");let n=this._getNextOutput(i,r);if(n>=this.config.numberOutputFlows&&this.config.loop)n=0;else if(n>=this.config.numberOutputFlows&&!this.config.loop)return;if(r=r.filter((e=>e!==n)),0===r.length)for(let e=0;e<this.config.numberOutputFlows;e++)r.push(e);e._setExecutionVariable(this,"unusedIndexes",r),e._setExecutionVariable(this,"currentIndex",n),this.currentIndex.setValue(n,e),this.outFlows[n]._activateSignal(e)}getClassName(){return"FGMultiGateBlock"}serialize(e){super.serialize(e),e.config.numberOutputFlows=this.config.numberOutputFlows,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.loop,e.config.startIndex=this.config.startIndex}}(0,o.Y5)("FGMultiGateBlock",ns);class ss extends Gn.u{constructor(e){super(e),this.config=e,this.selection=this.registerDataInput("selection",zn.Vv),this.outputFlows=[];for(let e=0;e<=this.config.cases.length;e++)this.outputFlows.push(this._registerSignalOutput(`out${e}`))}_execute(e,t){const i=this.selection.getValue(e);for(let t=0;t<this.config.cases.length;t++)if(i===this.config.cases[t])return void this.outputFlows[t]._activateSignal(e);this.outputFlows[this.outputFlows.length-1]._activateSignal(e)}getClassName(){return"FGSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}}(0,o.Y5)("FGSwitchBlock",ss);class as extends es.w{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset");for(let e=1;e<this.config.numberInputFlows;e++)this.inFlows.push(this._registerSignalInput(`in${e}`))}_getCurrentActivationState(e){const t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){const i=e._getExecutionVariable(this,"activationState");for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.numberInputFlows;e++)t.push(!1);return t}_execute(e,t){const i=this._getCurrentActivationState(e);if(t===this.reset)for(let e=0;e<this.config.numberInputFlows;e++)i[e]=!1;else if(t===this.in)i[0]=!0;else{const e=this.inFlows.indexOf(t);e>=0&&(i[e+1]=!0)}if(e._setExecutionVariable(this,"activationState",i.slice()),i.every((e=>e))){this.out._activateSignal(e);for(let e=0;e<this.config.numberInputFlows;e++)i[e]=!1}}getClassName(){return"FGWaitAllBlock"}serialize(e){super.serialize(e),e.config.numberInputFlows=this.config.numberInputFlows}}(0,o.Y5)("FGWaitAllBlock",as);class os extends es.w{constructor(e){super(e),this.count=this.registerDataOutput("count",zn.Es),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset)return e._setExecutionVariable(this,"count",0),void this.count.setValue(0,e);const i=(e._getExecutionVariable(this,"count")??0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FGCounterBlock"}}(0,o.Y5)("FGCounterBlock",os);var ls=i(12477);class cs extends es.w{constructor(e){super(e),this.count=this.registerDataInput("count",zn.Es),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",zn.Es)}_execute(e,t){if(t===this.reset)return void e._setExecutionVariable(this,"debounceCount",0);const i=this.count.getValue(e),r=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(r,e),e._setExecutionVariable(this,"debounceCount",r),r>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FGDebounceBlock"}}(0,o.Y5)("FGDebounceBlock",cs);class hs extends Gn.u{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.isOn=this.registerDataOutput("isOn",zn.RI)}_execute(e,t){let i=e._getExecutionVariable(this,"value",!1);i=!i,e._setExecutionVariable(this,"value",i),this.isOn.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FGFlipFlopBlock"}}(0,o.Y5)("FGFlipFlopBlock",hs);var us=i(7899),ds=i(59988),ps=i(99007);class fs extends ds.M{constructor(e){super(e),this.config=e,this.templateTargetComponent=new ps.H(e.targetPath,this),this.templateAnimationComponent=new ps.H(e.animationPath,this),this.speed=this.registerDataInput("speed",zn.Es),this.loop=this.registerDataInput("loop",zn.RI),this.from=this.registerDataInput("from",zn.Es),this.to=this.registerDataInput("to",zn.Es),this.runningAnimatable=this.registerDataOutput("runningAnimatable",zn.Vv)}_preparePendingTasks(e){const t=this.templateTargetComponent.getAccessor(this.config.pathConverter,e),i=t.info.getObject(t.object),r=this.templateAnimationComponent.getAccessor(this.config.pathConverter,e),n=r.info.get(r.object);if(!i||!n)throw new Error("Cannot play animation without target or animation");const s=e._getExecutionVariable(this,"runningAnimatables")??[],a=this.runningAnimatable.getValue(e);if(a&&a.paused)a.restart();else{const t=e.configuration.scene.beginDirectAnimation(i,[n],this.from.getValue(e),this.to.getValue(e),this.loop.getValue(e),this.speed.getValue(e),(()=>this._onAnimationEnd(t,e)));this.runningAnimatable.setValue(t,e),s.push(t)}e._setExecutionVariable(this,"runningAnimatables",s)}_execute(e){this._startPendingTasks(e),this.out._activateSignal(e)}_onAnimationEnd(e,t){const i=t._getExecutionVariable(this,"runningAnimatables")??[],r=i.indexOf(e);-1!==r&&i.splice(r,1),t._removePendingBlock(this),this.done._activateSignal(t)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"runningAnimatables")??[];for(const e of t)e.stop();e._deleteExecutionVariable(this,"runningAnimatables")}getClassName(){return fs.ClassName}serialize(e={}){super.serialize(e),e.config.targetPath=this.config.targetPath,e.config.animationPath=this.config.animationPath}}fs.ClassName="FGPlayAnimationBlock",(0,o.Y5)(fs.ClassName,fs);class ms extends es.w{constructor(e){super(e),this.animationToStop=this.registerDataInput("animationToStop",zn.Vv)}_execute(e){this.animationToStop.getValue(e).stop(),this.out._activateSignal(e)}getClassName(){return"FGStopAnimationBlock"}}(0,o.Y5)("FGStopAnimationBlock",ms);class _s extends es.w{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",zn.Vv)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FGPauseAnimationBlock"}}(0,o.Y5)("FGPauseAnimationBlock",_s);class gs extends Vn.e{constructor(e){super(e),this.condition=this.registerDataInput("condition",zn.RI),this.trueValue=this.registerDataInput("trueValue",zn.Vv),this.falseValue=this.registerDataInput("falseValue",zn.Vv),this.output=this.registerDataOutput("output",zn.Vv)}_updateOutputs(e){this.output.setValue(this.condition.getValue(e)?this.trueValue.getValue(e):this.falseValue.getValue(e),e)}getClassName(){return"FGConditionalDataBlock"}}(0,o.Y5)("FGConditionalDataBlock",gs);var vs=i(91210);class Ss extends Vn.e{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",zn.Vv),this.destinationSystem=this.registerDataInput("destinationSystem",zn.Vv),this.inputCoordinates=this.registerDataInput("inputCoordinates",zn.Dx),this.outputCoordinates=this.registerDataOutput("outputCoordinates",zn.Dx)}_updateOutputs(e){const t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),n=t.getWorldMatrix(),a=i.getWorldMatrix(),o=s.AA.Matrix[0].copyFrom(a);o.invert();const l=s.AA.Matrix[1];o.multiplyToRef(n,l);const c=this.outputCoordinates.getValue(e);s.Pq.TransformCoordinatesToRef(r,l,c)}getClassName(){return"FGCoordinateTransformBlock"}}(0,o.Y5)("FGCoordinateTransformBlock",Ss);var xs=i(97711);class Ts extends Vn.e{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",(0,zn.k4)(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FGConstantBlock"}serialize(e={},t=xs.X5){super.serialize(e),t("value",this.config.value,e.config)}}(0,o.Y5)("FGConstantBlock",Ts);var Es=i(96073),Cs=i(75892),bs=i(10338);const Ps="FGLogic",ys="AndBlock",As="OrBlock",Rs="NotBlock";class Is extends Cs.W{constructor(e){super(zn.RI,zn.RI,zn.RI,((e,t)=>e&&t),`${Ps}${ys}`,e)}}(0,o.Y5)(`${Ps}${ys}`,Is);class Ms extends Cs.W{constructor(e){super(zn.RI,zn.RI,zn.RI,((e,t)=>e||t),`${Ps}${As}`,e)}}(0,o.Y5)(`${Ps}${As}`,Ms);class Os extends bs.a{constructor(e){super(zn.RI,zn.RI,(e=>!e),`${Ps}${Rs}`,e)}}(0,o.Y5)(`${Ps}${Rs}`,Os);var Ns=i(83376),Ds=i(64012),Fs=i(47387),Ls=i(23182),ws=i(79325),Bs=i(2610),Vs=i(98552);const ks=0,Gs=1;var Us=i(10310);class zs extends Us.L{record(){if(void 0===this.sourceTexture)throw new Error(`FrameGraphCopyToBackbufferColorTask "${this.name}": sourceTexture is required`);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(ks),e.setExecuteFunc((e=>{e.isBackbuffer(this.sourceTexture)||e.copyTexture(this.sourceTexture)}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(ks),t.setExecuteFunc((e=>{}))}}class Ws extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this._isUnique=!0,this.registerInput("texture",Vs.tp.Texture),this.texture.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this._frameGraphTask=new zs(e,t)}getClassName(){return"NodeRenderGraphOutputBlock"}get texture(){return this._inputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name;const t=this.texture.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value)}}(0,o.Y5)("BABYLON.NodeRenderGraphOutputBlock",Ws);var Hs,Ys,Xs,qs=i(83445),$s=i(95873),js=i(97401),Ks=i(33155);!function(e){e[e.None=0]="None",e[e.ToLinearSpace=1]="ToLinearSpace",e[e.ToGammaSpace=2]="ToGammaSpace"}(Hs||(Hs={}));class Zs{get shaderLanguage(){return this._shaderLanguage}_textureIsInternal(e){return void 0===e.getInternalTexture}constructor(e,t=!1){this._shaderLanguage=0,this._shadersLoaded=!1,this._engine=e,this._isDepthTexture=t,this._renderer=new Ks.J(e),this._initShaderSourceAsync(t)}async _initShaderSourceAsync(e){const t=this._engine;t.isWebGPU?(this._shaderLanguage=1,await Promise.resolve().then(i.bind(i,32350))):await Promise.resolve().then(i.bind(i,69335)),this._shadersLoaded=!0,this._effectWrapper=new Ks.$({engine:t,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:e?["#define DEPTH_TEXTURE"]:[],shaderLanguage:this._shaderLanguage}),this._effectWrapper.onApplyObservable.add((()=>{e?(t.setState(!1),t.setDepthBuffer(!0),t.depthCullingState.depthMask=!0,t.depthCullingState.depthFunc=519):t.depthCullingState.depthMask=!1,this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)}))}isReady(){return this._shadersLoaded&&this._effectWrapper.effect.isReady()}copy(e,t=null,i=0){if(!this.isReady())return!1;this._source=e,this._conversion=i;const r=this._engine.getDepthFunction(),n=this._engine.getDepthWrite();return this._renderer.render(this._effectWrapper,t),this._engine.setDepthWrite(n),this._isDepthTexture&&r&&this._engine.setDepthFunction(r),!0}dispose(){this._effectWrapper?.dispose(),this._renderer.dispose()}}class Qs{}class Js extends Qs{static _IsObjectRenderer(e){return void 0!==e.initRender}constructor(e,t,i){super(),this._engine=e,this._textureManager=t,this._scene=i,this._debugMessageHasBeenPushed=!1,this._renderTargetIsBound=!0,this._effectRenderer=new Ks.J(this._engine),this._copyTexture=new Zs(this._engine)}isBackbuffer(e){return this._textureManager.isBackbuffer(e)}isBackbufferColor(e){return this._textureManager.isBackbufferColor(e)}isBackbufferDepthStencil(e){return this._textureManager.isBackbufferDepthStencil(e)}createRenderTarget(e,t,i){return this._textureManager.createRenderTarget(e,t,i)}clear(e,t,i,r){this._applyRenderTarget(),this._engine.clear(e,t,i,r)}clearColorAttachments(e,t){this._applyRenderTarget(),this._engine.bindAttachments(t),this._engine.clear(e,!0,!1,!1)}bindAttachments(e){this._applyRenderTarget(),this._engine.bindAttachments(e)}generateMipMaps(){if(void 0===this._currentRenderTarget?.renderTargetWrapper)return;this._renderTargetIsBound&&this._engine._currentRenderTarget&&(this._flushDebugMessages(),this._engine.unBindFramebuffer(this._engine._currentRenderTarget),this._renderTargetIsBound=!1);const e=this._currentRenderTarget.renderTargetWrapper.textures;if(e)for(const t of e)this._engine.generateMipmaps(t)}setTextureSamplingMode(e,t){const i=this._textureManager.getTextureFromHandle(e);i&&i.samplingMode!==t&&this._engine.updateTextureSamplingMode(t,i)}bindTextureHandle(e,t,i){let r;const n=this._textureManager._historyTextures.get(i);n?(r=n.textures[n.index],void 0!==this._currentRenderTarget&&void 0!==this._currentRenderTarget.renderTargetWrapper&&this._currentRenderTarget.renderTargetWrapper.textures.includes(r)&&(r=n.textures[1^n.index])):r=this._textureManager._textures.get(i).texture,e._bindTexture(t,r)}setDepthStates(e,t){this._engine.setDepthBuffer(e),this._engine.setDepthWrite(t)}applyFullScreenEffect(e,t){if(!e.effect?.isReady())return!1;this._applyRenderTarget();const i=this._engine.getDepthWrite();return this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._engine.enableEffect(e),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effectRenderer.bindBuffers(e.effect),t?.(),this._effectRenderer.draw(),this._effectRenderer.restoreStates(),this._engine.setDepthWrite(i),this._engine.setAlphaMode(0),!0}copyTexture(e,t=!1){t&&this.bindRenderTarget(),this._applyRenderTarget(),this._copyTexture.copy(this._textureManager.getTextureFromHandle(e))}render(e,t,i){Js._IsObjectRenderer(e)?e.shouldRender()&&(this._scene.incrementRenderId(),this._scene.resetCachedMaterial(),e.prepareRenderList(),e.initRender(t,i),this._applyRenderTarget(),e.render(),e.finishRender()):(this._applyRenderTarget(),e.render())}bindRenderTarget(e,t){if(void 0===e?.renderTargetWrapper&&void 0===this._currentRenderTarget||e&&this._currentRenderTarget&&e.equals(this._currentRenderTarget))return this._flushDebugMessages(),void(void 0!==t&&(this._engine._debugPushGroup?.(t,2),this._debugMessageWhenTargetBound=void 0,this._debugMessageHasBeenPushed=!0));this._currentRenderTarget=void 0===e?.renderTargetWrapper?void 0:e,this._debugMessageWhenTargetBound=t,this._renderTargetIsBound=!1}_flushDebugMessages(){this._debugMessageHasBeenPushed&&(this._engine._debugPopGroup?.(2),this._debugMessageHasBeenPushed=!1)}_applyRenderTarget(){if(this._renderTargetIsBound)return;this._flushDebugMessages();const e=this._currentRenderTarget?.renderTargetWrapper;void 0===e?this._engine.restoreDefaultFramebuffer():(this._engine._currentRenderTarget&&this._engine.unBindFramebuffer(this._engine._currentRenderTarget),this._engine.bindFramebuffer(e)),void 0!==this._debugMessageWhenTargetBound&&(this._engine._debugPushGroup?.(this._debugMessageWhenTargetBound,2),this._debugMessageWhenTargetBound=void 0,this._debugMessageHasBeenPushed=!0),this._renderTargetIsBound=!0}_isReady(){return this._copyTexture.isReady()}_dispose(){this._effectRenderer.dispose(),this._copyTexture.dispose()}}function ea(e){return void 0!==e.width}function ta(e){return ea(e)?{width:e.width,height:e.height}:{width:e,height:e}}class ia{constructor(e,t,i,r){this._isBackBuffer=!1,this.name=e,this._textureManager=t,this._renderTargets=void 0===i?void 0:Array.isArray(i)?i:[i],this._renderTargetDepth=r}get renderTargetWrapper(){if(!this._isBackBuffer){if(!this._renderTargetWrapper){const e=this._textureManager.engine,t=void 0===this._renderTargets?this._renderTargetDepth:this._renderTargets[0];if(this._textureManager.isBackbuffer(t))return void(this._isBackBuffer=!0);const i=this._textureManager.getTextureDescription(t),r={textureCount:this._renderTargets?.length??0,generateDepthBuffer:!1,label:this.name,samples:i.options.samples??1,dontCreateTextures:!0};this._renderTargetWrapper=e.createMultipleRenderTarget(i.size,r,!0);for(let e=0;e<r.textureCount;e++){const t=this._renderTargets[e],i=this._textureManager.getTextureFromHandle(t);if(!i)throw new Error(`FrameGraphRenderTarget.renderTargetWrapper: Failed to get texture from handle. handle: ${t}, name: ${this.name}, index: ${e}, renderTargets: ${this._renderTargets}`);this._renderTargetWrapper.setTexture(i,e,!1)}void 0!==this._renderTargetDepth&&this._renderTargetWrapper.setDepthStencilTexture(this._textureManager.getTextureFromHandle(this._renderTargetDepth),!1)}return this._renderTargetWrapper}}equals(e){const t=this._renderTargets,i=e._renderTargets;if(void 0!==t&&void 0!==i){if(t.length!==i.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!1}else if(void 0===t&&void 0!==i||void 0!==t&&void 0===i)return!1;return this._renderTargetDepth===e._renderTargetDepth}}!function(e){e[e.Task=0]="Task",e[e.Graph=1]="Graph",e[e.External=2]="External"}(Ys||(Ys={}));class ra{constructor(e,t=!1,i){this.engine=e,this._debugTextures=t,this._scene=i,this._textures=new Map,this._historyTextures=new Map,this._isRecordingTask=!1,this._addSystemTextures()}isBackbuffer(e){if(e===ks||e===Gs)return!0;const t=this._textures.get(e);return!!t&&(t.refHandle===ks||t.refHandle===Gs)}isBackbufferColor(e){if(e===ks)return!0;const t=this._textures.get(e);return!!t&&t.refHandle===ks}isBackbufferDepthStencil(e){if(e===Gs)return!0;const t=this._textures.get(e);return!!t&&t.refHandle===Gs}isHistoryTexture(e){const t=this._textures.get(e);return!!t&&(e=t.refHandle??e,this._historyTextures.has(e))}getTextureCreationOptions(e){const t=this._textures.get(e),i=t.creationOptions;return{size:ea(i.size)?{...i.size}:i.size,sizeIsPercentage:i.sizeIsPercentage,options:this._cloneTextureOptions(i.options,t.textureIndex),isHistoryTexture:i.isHistoryTexture}}getTextureDescription(e){const t=this.getTextureCreationOptions(e);return{size:t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):ea(t.size)?t.size:{width:t.size,height:t.size},options:t.options}}getTextureHandleOrCreateTexture(e,t,i){if(void 0===e){if(void 0===t||void 0===i)throw new Error("getTextureHandleOrCreateTexture: Either handle or newTextureName and creationOptions must be provided.");return this.createRenderTargetTexture(t,i)}return e}getTextureFromHandle(e){const t=this._historyTextures.get(e);return t?t.textures[1^t.index]:this._textures.get(e).texture}importTexture(e,t,i){void 0!==i&&this._freeEntry(i);const r={size:{width:t.width,height:t.height},sizeIsPercentage:!1,isHistoryTexture:!1,options:{createMipMaps:t.generateMipMaps,samples:t.samples,types:[t.type],formats:[t.format],useSRGBBuffers:[t._useSRGBBuffer],creationFlags:[t._creationFlags],labels:t.label?[t.label]:["imported"]}};return this._createHandleForTexture(e,t,r,Ys.External,i)}createRenderTargetTexture(e,t,i){return this._createHandleForTexture(e,null,{size:ea(t.size)?{...t.size}:t.size,sizeIsPercentage:t.sizeIsPercentage,isHistoryTexture:t.isHistoryTexture,options:this._cloneTextureOptions(t.options)},this._isRecordingTask?Ys.Task:Ys.Graph,i)}createRenderTarget(e,t,i){const r=new ia(e,this,t,i),n=r.renderTargetWrapper;if(void 0!==n&&t){const e=Array.isArray(t)?t:[t];for(let t=0;t<e.length;t++){let i=e[t];i=this._textures.get(i)?.refHandle??i;const r=this._historyTextures.get(i);r&&(r.references.push({renderTargetWrapper:n,textureIndex:t}),n.setTexture(r.textures[r.index],t,!1))}}return r}createDanglingHandle(){return ra._Counter++}resolveDanglingHandle(e,t,i,r){if(void 0===t){if(void 0===i||void 0===r)throw new Error("resolveDanglingHandle: Either handle or newTextureName and creationOptions must be provided.");return void this.createRenderTargetTexture(i,r,e)}const n=this._textures.get(t);if(void 0===n)throw new Error(`resolveDanglingHandle: Handle ${t} does not exist!`);this._textures.set(e,{texture:n.texture,refHandle:t,name:n.name,creationOptions:{size:{...n.creationOptions.size},options:this._cloneTextureOptions(n.creationOptions.options),sizeIsPercentage:n.creationOptions.sizeIsPercentage,isHistoryTexture:!1},namespace:n.namespace,textureIndex:n.textureIndex})}getAbsoluteDimensions(e,t=this.engine.getRenderWidth(!0),i=this.engine.getRenderHeight(!0)){const{width:r,height:n}=ta(e);return{width:Math.floor(r*t/100),height:Math.floor(n*i/100)}}_dispose(){this._releaseTextures()}_allocateTextures(){this._textures.forEach((e=>{if(!e.texture)if(void 0!==e.refHandle){const t=this._textures.get(e.refHandle);e.texture=t.texture,t.refHandle===ks&&(e.refHandle=ks),t.refHandle===Gs&&(e.refHandle=Gs)}else if(e.namespace!==Ys.External){const t=e.creationOptions,i=t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):t.size,r=e.textureIndex||0,n={createMipMaps:t.options.createMipMaps,samples:t.options.samples,type:t.options.types?.[r],format:t.options.formats?.[r],useSRGBBuffer:t.options.useSRGBBuffers?.[r],creationFlags:t.options.creationFlags?.[r],label:t.options.labels?.[r]??`${e.name}${r>0?"#"+r:""}`,samplingMode:1,createMSAATexture:t.options.samples>1},s=(0,gi.vl)(n.format),a=(0,gi.$l)(n.format),o=s&&a?12:s||a?14:5,l=this.engine._createInternalTexture(i,n,!1,o);s&&(l.type=(0,gi.GX)(l.format)),e.texture=l}e.texture&&void 0===e.refHandle&&(e.debug?.dispose(),e.debug=this._createDebugTexture(e.name,e.texture))})),this._historyTextures.forEach((e=>{for(let t=0;t<e.handles.length;t++)e.textures[t]=this._textures.get(e.handles[t]).texture}))}_releaseTextures(e=!0){this._textures.forEach(((t,i)=>{(e||t.namespace!==Ys.External)&&(t.debug?.dispose(),t.debug=void 0),t.namespace!==Ys.External&&(t.texture?.dispose(),t.texture=null,(e||t.namespace===Ys.Task)&&this._textures.delete(i))})),this._historyTextures.forEach((e=>{for(let t=0;t<e.handles.length;t++)e.textures[t]=null})),e&&(this._textures.clear(),this._historyTextures.clear(),this._addSystemTextures())}_updateHistoryTextures(){this._historyTextures.forEach((e=>{e.index=1^e.index;const t=e.textures[e.index];if(t)for(const{renderTargetWrapper:i,textureIndex:r}of e.references)i.setTexture(t,r,!1)}))}_addSystemTextures(){const e={width:this.engine.getRenderWidth(!0),height:this.engine.getRenderHeight(!0)};this._textures.set(ks,{name:"backbuffer color",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:!1},namespace:Ys.External}),this._textures.set(Gs,{name:"backbuffer depth/stencil",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[16],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:!1},namespace:Ys.External})}_createDebugTexture(e,t){if(!this._debugTextures)return;const i=new _e.g(null,this._scene);return i.name=e,i._texture=t,i._texture.incrementReferences(),i}_freeEntry(e){const t=this._textures.get(e);t&&(t.debug?.dispose(),this._textures.delete(e))}_createHandleForTexture(e,t,i,r,n,s){n=n??ra._Counter++,s=s||0;const a=i.isHistoryTexture?`${e} ping`:e,o=i.options.labels?.[s]??"",l={texture:t,name:`${a}${o?" "+o:""}`,creationOptions:{size:ea(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage,isHistoryTexture:i.isHistoryTexture},namespace:r,textureIndex:s};if(this._textures.set(n,l),r===Ys.External)return n;if(i.isHistoryTexture){const t={size:{...l.creationOptions.size},options:{...l.creationOptions.options},sizeIsPercentage:l.creationOptions.sizeIsPercentage,isHistoryTexture:!1},i=this._createHandleForTexture(`${e} pong`,null,t,r);return this._historyTextures.set(n,{textures:[null,null],handles:[n,i],index:0,references:[]}),n}if(i.options.types&&i.options.types.length>1&&0===s){const e=i.options.types.length,t={size:ea(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage};for(let i=1;i<e;i++)this._createHandleForTexture(a,null,t,r,n+i,i);ra._Counter+=e-1}return n}_cloneTextureOptions(e,t){return void 0!==t?{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[e.types[t]]:void 0,formats:e.formats?[e.formats[t]]:void 0,useSRGBBuffers:e.useSRGBBuffers?[e.useSRGBBuffers[t]]:void 0,creationFlags:e.creationFlags?[e.creationFlags[t]]:void 0,labels:e.labels?[e.labels[t]]:void 0}:{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[...e.types]:void 0,formats:e.formats?[...e.formats]:void 0,useSRGBBuffers:e.useSRGBBuffers?[...e.useSRGBBuffers]:void 0,creationFlags:e.creationFlags?[...e.creationFlags]:void 0,labels:e.labels?[...e.labels]:void 0}}}ra._Counter=2,function(e){e[e.Render=0]="Render",e[e.Cull=1]="Cull",e[e.Compute=2]="Compute"}(Xs||(Xs={}));class na{get engine(){return this._engine}constructor(e,t=!1,i){this._tasks=[],this._currentProcessedTask=null,this.onBuildObservable=new n.cP,this._engine=e,this.textureManager=new ra(this._engine,t,i),this._passContext=new Qs,this._renderContext=new Js(this._engine,this.textureManager,i)}getTaskByName(e){return this._tasks.find((t=>t.name===e))}addTask(e){if(null!==this._currentProcessedTask)throw new Error(`FrameGraph.addTask: Can't add the task "${e.name}" while another task is currently building (task: ${this._currentProcessedTask.name}).`);this._tasks.push(e)}addRenderPass(e,t=!1){return this._addPass(e,Xs.Render,t)}addCullPass(e,t=!1){return this._addPass(e,Xs.Cull,t)}_addPass(e,t,i=!1){if(!this._currentProcessedTask)throw new Error("FrameGraph: A pass must be created during a Task.record execution only.");let r;switch(t){case Xs.Render:r=new $s.p(e,this._currentProcessedTask,this._renderContext,this._engine);break;case Xs.Cull:r=new js.x(e,this._currentProcessedTask,this._passContext,this._engine);break;default:r=new qs.X(e,this._currentProcessedTask,this._passContext)}return this._currentProcessedTask._addPass(r,i),r}build(){this.textureManager._releaseTextures(!1);for(const e of this._tasks)e._reset(),this._currentProcessedTask=e,this.textureManager._isRecordingTask=!0,e.record(),this.textureManager._isRecordingTask=!1,this._currentProcessedTask=null;this.textureManager._allocateTextures();for(const e of this._tasks)e._checkTask();this.onBuildObservable.notifyObservers(this)}whenReadyAsync(e=16){return new Promise((t=>{const i=()=>{let r=this._renderContext._isReady();for(const e of this._tasks)r=e.isReady()&&r;r?t():setTimeout(i,e)};i()}))}execute(){this._renderContext.bindRenderTarget(),this.textureManager._updateHistoryTextures();for(const e of this._tasks){const t=e._getPasses();for(const e of t)e._execute()}}clear(){for(const e of this._tasks)e._reset();this._tasks.length=0,this.textureManager._releaseTextures(),this._currentProcessedTask=null}dispose(){this.clear(),this.textureManager._dispose(),this._renderContext._dispose()}}var sa,aa=i(17298);function oa(e,t=0,i="PROPERTIES",r){return(n,s)=>{let a=n._propStore;a||(a=[],n._propStore=a),a.push({propertyName:s,displayName:e,type:t,groupName:i,options:r??{},className:n.constructor.name})}}!function(e){e[e.Boolean=0]="Boolean",e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=3]="Vector2",e[e.List=4]="List",e[e.Color4=5]="Color4",e[e.SamplingMode=6]="SamplingMode",e[e.TextureFormat=7]="TextureFormat",e[e.TextureType=8]="TextureType"}(sa||(sa={}));class la extends Bs.E{get type(){return this._type}constructor(e,t,i,r=Vs.tp.Undefined){super(e,t,i),this._storedValue=null,this._type=Vs.tp.Undefined,this.onValueChangedObservable=new n.cP,this.isExternal=!1,this._type=r,this._isInput=!0,this.registerOutput("output",r),this.setDefaultValue()}setDefaultValue(){switch(this.type){case Vs.tp.Texture:case Vs.tp.TextureViewDepth:case Vs.tp.TextureScreenDepth:case Vs.tp.TextureViewNormal:case Vs.tp.TextureWorldNormal:case Vs.tp.TextureAlbedo:case Vs.tp.TextureReflectivity:case Vs.tp.TextureLocalPosition:case Vs.tp.TextureWorldPosition:case Vs.tp.TextureVelocity:case Vs.tp.TextureLinearVelocity:case Vs.tp.TextureIrradiance:case Vs.tp.TextureAlbedoSqrt:{const e={size:{width:100,height:100},options:{createMipMaps:!1,types:[0],formats:[5],samples:1,useSRGBBuffers:[!1]},sizeIsPercentage:!0};this.creationOptions=e;break}case Vs.tp.TextureDepthStencilAttachment:{const e={size:{width:100,height:100},options:{createMipMaps:!1,types:[0],formats:[13],useSRGBBuffers:[!1],labels:[this.name],samples:1},sizeIsPercentage:!0};this.creationOptions=e;break}case Vs.tp.ObjectList:this.value={meshes:[],particleSystems:[]},this.isExternal=!0;break;case Vs.tp.Camera:this.value=this._scene.cameras[0],this.isExternal=!0;break;default:this.isExternal=!0}}get value(){return this._storedValue}set value(e){this._storedValue=e,this.output.value=void 0,this.onValueChangedObservable.notifyObservers(this)}getTypedValue(){return this._storedValue}getInternalTextureFromValue(){return this._storedValue._swapAndDie?this._storedValue:null}getClassName(){return"NodeRenderGraphInputBlock"}get output(){return this._outputs[0]}isAnyTexture(){return!!(this.type&Vs.tp.TextureAll)}isBackBuffer(){return!!(this.type&Vs.tp.TextureBackBuffer)}isBackBufferDepthStencilAttachment(){return!!(this.type&Vs.tp.TextureBackBufferDepthStencilAttachment)}isCamera(){return!!(this.type&Vs.tp.Camera)}isObjectList(){return!!(this.type&Vs.tp.ObjectList)}_buildBlock(e){if(super._buildBlock(e),this.isExternal)if(this.isBackBuffer())this.output.value=ks;else if(this.isBackBufferDepthStencilAttachment())this.output.value=Gs;else if(this.isCamera())this.output.value=this.getTypedValue();else if(this.isObjectList())this.output.value=this.getTypedValue();else{if(void 0===this._storedValue||null===this._storedValue)throw new Error(`NodeRenderGraphInputBlock: External input "${this.name}" is not set`);const e=this.getInternalTextureFromValue();e&&(this.output.value=this._frameGraph.textureManager.importTexture(this.name,e,this.output.value))}else if(this.type&Vs.tp.TextureAllButBackBuffer){const e=this.creationOptions;if(!e)throw new Error(`NodeRenderGraphInputBlock: Creation options are missing for texture "${this.name}"`);this.output.value=this._frameGraph.textureManager.createRenderTargetTexture(this.name,e)}}dispose(){this._storedValue=null,this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.isExternal = ${this.isExternal};`),this.isAnyTexture()?this.isExternal?e.push(`${this._codeVariableName}.value = EXTERNAL_TEXTURE; // TODO: set the external texture`):e.push(`${this._codeVariableName}.creationOptions = ${JSON.stringify(this.creationOptions)};`):this.isCamera()?e.push(`${this._codeVariableName}.value = EXTERNAL_CAMERA; // TODO: set the external camera`):this.isObjectList()&&e.push(`${this._codeVariableName}.value = EXTERNAL_OBJECT_LIST; // TODO: set the external object list`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.type=this.type,e.isExternal=this.isExternal,this.creationOptions&&(e.creationOptions=this.creationOptions),e}_deserialize(e){super._deserialize(e),this._type=e.type,this.output.type=this._type,this.isExternal=e.isExternal,e.creationOptions&&(void 0!==e.creationOptions.options.depthTextureFormat&&(e.creationOptions.options.formats=[e.creationOptions.options.depthTextureFormat]),this.creationOptions=e.creationOptions)}}(0,ue.Cg)([oa("Is external",0,"PROPERTIES")],la.prototype,"isExternal",void 0),(0,o.Y5)("BABYLON.NodeRenderGraphInputBlock",la);class ca extends Us.L{constructor(e,t){super(e,t),this.color=new a.ov(.2,.2,.3,1),this.clearColor=!0,this.clearDepth=!1,this.clearStencil=!1,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.destinationTexture&&void 0===this.depthTexture)throw new Error(`FrameGraphClearTextureTask ${this.name}: destinationTexture and depthTexture can't both be undefined.`);void 0!==this.destinationTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.destinationTexture),e.setRenderTargetDepth(this.depthTexture),e.setExecuteFunc((e=>{e.clear(this.color,!!this.clearColor,!!this.clearDepth,!!this.clearStencil)}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.destinationTexture),t.setRenderTargetDepth(this.depthTexture),t.setExecuteFunc((e=>{}))}}class ha extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("texture",Vs.tp.Texture,!0),this.registerInput("depth",Vs.tp.TextureBackBufferDepthStencilAttachment,!0),this.registerOutput("output",Vs.tp.BasedOnInput),this.registerOutput("outputDepth",Vs.tp.BasedOnInput),this.texture.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.depth.addAcceptedConnectionPointTypes(Vs.tp.TextureDepthStencilAttachment),this.output._typeConnectionSource=this.texture,this.outputDepth._typeConnectionSource=this.depth,this._frameGraphTask=new ca(e,t)}get color(){return this._frameGraphTask.color}set color(e){this._frameGraphTask.color=e}get clearColor(){return!!this._frameGraphTask.clearColor}set clearColor(e){this._frameGraphTask.clearColor=e}get clearDepth(){return!!this._frameGraphTask.clearDepth}set clearDepth(e){this._frameGraphTask.clearDepth=e}get clearStencil(){return!!this._frameGraphTask.clearStencil}set clearStencil(e){this._frameGraphTask.clearStencil=e}getClassName(){return"NodeRenderGraphClearBlock"}get texture(){return this._inputs[0]}get depth(){return this._inputs[1]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this._propagateInputValueToOutput(this.texture,this.output),this._propagateInputValueToOutput(this.depth,this.outputDepth);const t=this.texture.connectedPoint;t&&(this._frameGraphTask.destinationTexture=t.value);const i=this.depth.connectedPoint;i&&(this._frameGraphTask.depthTexture=i.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.color = new BABYLON.Color4(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.color.a});`),e.push(`${this._codeVariableName}.clearColor = ${this.clearColor};`),e.push(`${this._codeVariableName}.clearDepth = ${this.clearDepth};`),e.push(`${this._codeVariableName}.clearStencil = ${this.clearStencil};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.color=this.color.asArray(),e.clearColor=this.clearColor,e.clearDepth=this.clearDepth,e.clearStencil=this.clearStencil,e}_deserialize(e){super._deserialize(e),this.color=a.ov.FromArray(e.color),this.clearColor=e.clearColor,this.clearDepth=e.clearDepth,this.clearStencil=e.clearStencil}}(0,ue.Cg)([oa("Color",5)],ha.prototype,"color",null),(0,ue.Cg)([oa("Clear color",0,void 0,{embedded:!0})],ha.prototype,"clearColor",null),(0,ue.Cg)([oa("Clear depth",0,void 0,{embedded:!0})],ha.prototype,"clearDepth",null),(0,ue.Cg)([oa("Clear stencil",0,void 0,{embedded:!0})],ha.prototype,"clearStencil",null),(0,o.Y5)("BABYLON.NodeRenderGraphClearBlock",ha);class ua{constructor(){this.verbose=!1,this._notConnectedNonOptionalInputs=[]}emitErrors(e=null){let t="";for(const e of this._notConnectedNonOptionalInputs)t+=`input "${e.name}" from block "${e.ownerBlock.name}"[${e.ownerBlock.getClassName()}] is not connected and is not optional.\n`;return!t||(e&&e.notifyObservers(t),f.V.Error("Build of node render graph failed:\n"+t),!1)}}class da{_getGlobalNodeRenderGraphEditor(){return"undefined"!=typeof NODERENDERGRAPHEDITOR?NODERENDERGRAPHEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeRenderGraphEditor?BABYLON:void 0}get frameGraph(){return this._frameGraph}getScene(){return this._scene}constructor(e,t,i){this._buildId=da._BuildIdGenerator++,this.BJSNODERENDERGRAPHEDITOR=this._getGlobalNodeRenderGraphEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new n.cP,this.onBuildErrorObservable=new n.cP,this.outputBlock=null,this._resizeObserver=null,this.name=e,this._scene=t,this._engine=t.getEngine(),i={debugTextures:!1,autoConfigure:!1,verbose:!1,rebuildGraphOnEngineResize:!0,autoFillExternalInputs:!0,...i},this._options=i,this._frameGraph=new na(this._engine,i.debugTextures,this._scene),i.rebuildGraphOnEngineResize&&(this._resizeObserver=this._engine.onResizeObservable.add((()=>{this.build()})))}getClassName(){return"NodeRenderGraph"}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return re.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getBlocksByPredicate(e){const t=[];for(const i of this.attachedBlocks)e(i)&&t.push(i);return t}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise((t=>{if(this.BJSNODERENDERGRAPHEDITOR=this.BJSNODERENDERGRAPHEDITOR||this._getGlobalNodeRenderGraphEditor(),void 0===this.BJSNODERENDERGRAPHEDITOR){const i=e&&e.editorURL?e.editorURL:da.EditorURL;re.S0.LoadBabylonScript(i,(()=>{this.BJSNODERENDERGRAPHEDITOR=this.BJSNODERENDERGRAPHEDITOR||this._getGlobalNodeRenderGraphEditor(),this._createNodeEditor(e?.nodeRenderGraphEditorConfig),t()}))}else this._createNodeEditor(e?.nodeRenderGraphEditorConfig),t()}))}_createNodeEditor(e){const t={nodeRenderGraph:this,...e};this.BJSNODERENDERGRAPHEDITOR.NodeRenderGraphEditor.Show(t)}build(){if(!this.outputBlock)throw new Error("You must define the outputBlock property before building the node render graph");this._initializeBlock(this.outputBlock),this._frameGraph.clear();const e=new ua;e.buildId=this._buildId,e.verbose=this._options.verbose,this._options.autoFillExternalInputs&&this._autoFillExternalInputs(),this.outputBlock.build(e),this._frameGraph.build(),this._buildId=da._BuildIdGenerator++,e.emitErrors(this.onBuildErrorObservable)&&this.onBuildObservable.notifyObservers(this)}_autoFillExternalInputs(){const e=this.getInputBlocks();let t=0;for(const i of e)if(i.isExternal&&i.isAnAncestorOfType("NodeRenderGraphOutputBlock"))if(i.type&Vs.tp.TextureAllButBackBuffer);else if(i.isCamera()){const e=this._scene.cameras[t++]||this._scene.cameras[0];this._scene.cameraToUseForPointers||(this._scene.cameraToUseForPointers=e),i.value=e}else i.isObjectList()&&(i.value={meshes:this._scene.meshes,particleSystems:this._scene.particleSystems})}whenReadyAsync(e=16){return this._frameGraph.whenReadyAsync(e)}execute(){this._frameGraph.execute()}_initializeBlock(e){e.initialize(),this._options.autoConfigure&&e.autoConfigure(),-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e);for(const t of e.inputs){const i=t.connectedPoint;if(i){const t=i.ownerBlock;t!==e&&this._initializeBlock(t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const t of e.blocks){const e=(0,o.n9)(t.customType);if(e){const r=t.additionalConstructionParameters,n=r?new e("",this._frameGraph,this._scene,...r):new e("",this._frameGraph,this._scene);n._deserialize(t),i[t.id]=n,this.attachedBlocks.push(n)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,r=t._tempEntryPointUniqueId;if(r){const e=i[r];e&&e.attachToEndpoint(t)}}for(let r=0;r<e.blocks.length;r++){const n=e.blocks[r],s=i[n.id];s&&(s.inputs.length&&n.inputs.some((e=>e.targetConnectionName))&&!t||this._restoreConnections(s,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const e of r)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const n=[];for(const e in i)n[e]=i[e].uniqueId;this.editorData.map=n}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const s=i[n.id];if(s)for(const a of n.inputs)if(i[a.targetBlockId]!==e||a.targetConnectionName!==r.name);else{const e=s.getInputByName(a.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(s,t,i)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);const r=JSON.stringify(this._options);let n=`let nodeRenderGraph = new BABYLON.NodeRenderGraph("${this.name||"render graph"}", scene, ${r});\n`;for(const r of t)r.isInput&&-1===e.indexOf(r)&&(n+=r._dumpCode(i,e)+"\n");return this.outputBlock&&(e=[],n+="// Connections\n",n+=this.outputBlock._dumpCodeForOutputConnections(e),n+="// Output nodes\n",n+=`nodeRenderGraph.outputBlock = ${this.outputBlock._codeVariableName};\n`,n+="nodeRenderGraph.build();\n"),n}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new la("BackBuffer color",this._frameGraph,this._scene,Vs.tp.TextureBackBuffer),t=new ha("Clear",this._frameGraph,this._scene);e.output.connectTo(t.texture);const i=new Ws("Output",this._frameGraph,this._scene);t.output.connectTo(i.texture),this.outputBlock=i}clone(e){const t=this.serialize(),i=pe.p.Clone((()=>new da(e,this._scene)),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(),i}serialize(e){const t=e?{}:pe.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeRenderGraph",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this._frameGraph.dispose(),this._frameGraph=void 0,this._engine.onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null,this.attachedBlocks.length=0,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear()}static CreateDefault(e,t,i){const r=new da(e,t,i);return r.setToDefault(),r.build(),r}static Parse(e,t,i,r=!0){const n=pe.p.Parse((()=>new da(e.name,t,i)),e,null);return n.parseSerializedObject(e),r||n.build(),n}static ParseFromSnippetAsync(e,t,i,r,n=!0){return"_BLANK"===e?Promise.resolve(da.CreateDefault("blank",t,i)):new Promise(((s,a)=>{const o=new aa.u;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const l=JSON.parse(JSON.parse(o.responseText).jsonPayload),c=JSON.parse(l.nodeRenderGraph);r||(r=pe.p.Parse((()=>new da(e,t,i)),c,null)),r.parseSerializedObject(c),r.snippetId=e;try{n||r.build(),s(r)}catch(e){a(e)}}else a("Unable to load the snippet "+e)})),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()}))}}da._BuildIdGenerator=0,da.EditorURL=`${re.S0._DefaultCdnUrl}/v${_i.N.Version}/NodeRenderGraph/babylon.nodeRenderGraph.js`,da.SnippetUrl="https://snippet.babylonjs.com",(0,ue.Cg)([(0,de.lK)()],da.prototype,"name",void 0),(0,ue.Cg)([(0,de.lK)("comment")],da.prototype,"comment",void 0);var pa,fa=i(4066);class ma extends Bs.E{constructor(e,t,i){super(e,t,i),this.registerInput("input",Vs.tp.AutoDetect),this.registerOutput("output",Vs.tp.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NodeRenderGraphElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];this._propagateInputValueToOutput(i,t)}}(0,o.Y5)("BABYLON.NodeRenderGraphElbowBlock",ma);class _a extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,34203)))):t.push(Promise.resolve().then(i.bind(i,43816)))}constructor(e,t=null,i){super({...i,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:_a.FragmentUrl,uniforms:_a.Uniforms}),this.degree=1}bind(){super.bind(),this._drawWrapper.effect.setFloat("degree",this.degree)}}_a.FragmentUrl="blackAndWhite",_a.Uniforms=["degree"];class ga extends Us.L{constructor(e,t,i){super(e,t),this.sourceSamplingMode=2,this.postProcess=i,this._postProcessDrawWrapper=this.postProcess.drawWrapper,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.postProcess.isReady()}record(e=!1,t,i){if(void 0===this.sourceTexture)throw new Error(`FrameGraphPostProcessTask "${this.name}": sourceTexture is required`);const r=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);r.options.samples=1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture,this.name,r);const n=this._frameGraph.textureManager.getTextureDescription(this.outputTexture);this._outputWidth=n.size.width,this._outputHeight=n.size.height;const s=this._frameGraph.addRenderPass(this.name);if(s.useTexture(this.sourceTexture),s.setRenderTarget(this.outputTexture),s.setExecuteFunc((e=>{e.setTextureSamplingMode(this.sourceTexture,this.sourceSamplingMode),t?.(e),e.applyFullScreenEffect(this._postProcessDrawWrapper,(()=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.sourceTexture),i?.(e),this.postProcess.bind()}))})),!e){const e=this._frameGraph.addRenderPass(this.name+"_disabled",!0);e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}return s}dispose(){this.postProcess.dispose(),super.dispose()}}class va extends ga{constructor(e,t,i){super(e,t,i||new _a(e,t.engine))}}class Sa extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",Vs.tp.Texture),this.registerInput("destination",Vs.tp.Texture,!0),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=()=>this.destination.isConnected?this.destination:this.source,this._frameGraphTask=new va(this.name,t,new _a(e,i.getEngine()))}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}get degree(){return this._frameGraphTask.postProcess.degree}set degree(e){this._frameGraphTask.postProcess.degree=e}getClassName(){return"NodeRenderGraphBlackAndWhitePostProcessBlock"}get source(){return this._inputs[0]}get destination(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.destination.connectedPoint;i&&(this._frameGraphTask.destinationTexture=i.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.degree = ${this.degree};`),e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.degree=this.degree,e.sourceSamplingMode=this.sourceSamplingMode,e}_deserialize(e){super._deserialize(e),this.degree=e.degree,this.sourceSamplingMode=e.sourceSamplingMode}}(0,ue.Cg)([oa("Source sampling mode",6,"PROPERTIES")],Sa.prototype,"sourceSamplingMode",null),(0,ue.Cg)([oa("Degree",1,"PROPERTIES",{min:0,max:1})],Sa.prototype,"degree",null),(0,o.Y5)("BABYLON.NodeRenderGraphBlackAndWhitePostProcessBlock",Sa);class xa extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,96561)))):t.push(Promise.resolve().then(i.bind(i,7180)))}constructor(e,t=null,i){super({...i,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:xa.FragmentUrl,uniforms:xa.Uniforms,samplers:xa.Samplers}),this.weight=1}bind(){super.bind(),this._drawWrapper.effect.setFloat("bloomWeight",this.weight)}}xa.FragmentUrl="bloomMerge",xa.Uniforms=["bloomWeight"],xa.Samplers=["bloomBlur"];class Ta extends ga{constructor(e,t,i){super(e,t,i||new xa(e,t.engine))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.blurTexture)throw new Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture and blurTexture are required`);const t=super.record(e,void 0,(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"bloomBlur",this.blurTexture)}));return t.useTexture(this.blurTexture),t}}class Ea extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,17374)),Promise.resolve().then(i.bind(i,40932))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,27905)),Promise.resolve().then(i.bind(i,27627))]))}constructor(e,t=null,i,r,n){const s=!!n?.blockCompilation;super({...n,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Ea.FragmentUrl,uniforms:Ea.Uniforms,samplers:Ea.Samplers,vertexUrl:Ea.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this.options.blockCompilation=s,void 0!==i&&(this.direction=i),void 0!==r&&(this.kernel=r)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(){super.bind(),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){const i=this._kernel,r=(i-1)/2;let n=[],s=[],a=0;for(let e=0;e<i;e++){const t=e/(i-1),o=this._gaussianWeight(2*t-1);n[e]=e-r,s[e]=o,a+=o}for(let e=0;e<s.length;e++)s[e]/=a;const o=[],l=[],c=[];for(let e=0;e<=r;e+=2){const t=Math.min(e+1,Math.floor(r));if(e===t)c.push({o:n[e],w:s[e]});else{const i=t===r,a=s[e]+s[t]*(i?.5:1),o=n[e]+1/(1+s[e]/s[t]);0===o?(c.push({o:n[e],w:s[e]}),c.push({o:n[e+1],w:s[e+1]})):(c.push({o,w:a}),c.push({o:-o,w:a}))}}for(let e=0;e<c.length;e++)l[e]=c[e].o,o[e]=c[e].w;n=l,s=o;const h=this.options.engine.getCaps().maxVaryingVectors-(1===this.options.shaderLanguage?1:0),u=Math.max(h,0)-1;let d=Math.min(n.length,u),p="";p+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(s[d-1])}\n`,d--);for(let e=0;e<d;e++)p+=`#define KERNEL_OFFSET${e} ${this._glslFloat(n[e])}\n`,p+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(s[e])}\n`;let f=0;for(let e=u;e<n.length;e++)p+=`#define KERNEL_DEP_OFFSET${f} ${this._glslFloat(n[e])}\n`,p+=`#define KERNEL_DEP_WEIGHT${f} ${this._glslFloat(s[e])}\n`,f++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(p,null,null,{varyingCount:d,depCount:f},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}Ea.VertexUrl="kernelBlur",Ea.FragmentUrl="kernelBlur",Ea.Uniforms=["delta","direction"],Ea.Samplers=["circleOfConfusionSampler"];class Ca extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,81192)))):t.push(Promise.resolve().then(i.bind(i,91991)))}constructor(e,t=null,i){super({...i,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Ca.FragmentUrl,uniforms:Ca.Uniforms}),this.threshold=.9,this._exposure=1}bind(){super.bind();const e=this._drawWrapper.effect;e.setFloat("threshold",Math.pow(this.threshold,Ee.rv)),e.setFloat("exposure",this._exposure)}}Ca.FragmentUrl="extractHighlights",Ca.Uniforms=["threshold","exposure"];class ba{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this.scale}set kernel(e){this._blurX.kernel=e*this.scale,this._blurY.kernel=e*this.scale}constructor(e,t,i,r=!1){this.scale=i,this._downscale=new Ca(e+"_downscale",t,{blockCompilation:r}),this._blurX=new Ea(e+"_blurX",t,new s.I9(1,0),10,{blockCompilation:r}),this._blurY=new Ea(e+"_blurY",t,new s.I9(0,1),10,{blockCompilation:r}),this._merge=new xa(e+"_merge",t,{blockCompilation:r})}isReady(){return this._downscale.isReady()&&this._blurX.isReady()&&this._blurY.isReady()&&this._merge.isReady()}}class Pa extends ga{constructor(e,t,i){super(e,t,i||new Ca(e,t.engine))}}class ya extends ga{constructor(e,t,i){super(e,t,i||new Ea(e,t.engine,new s.I9(1,0),10))}record(e=!1,t,i){const r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}}class Aa extends Us.L{get name(){return this._name}set name(e){this._name=e,this._downscale&&(this._downscale.name=`${e} Downscale`),this._blurX&&(this._blurX.name=`${e} Blur X`),this._blurY&&(this._blurY.name=`${e} Blur Y`),this._merge&&(this._merge.name=`${e} Merge`)}constructor(e,t,i,r,n,s,a=!1,o=.5){if(super(e,t),this.sourceSamplingMode=2,this.hdr=a,this._defaultPipelineTextureType=0,a){const e=i.getCaps();e.textureHalfFloatRender?this._defaultPipelineTextureType=2:e.textureFloatRender&&(this._defaultPipelineTextureType=1)}this.bloom=new ba(e,i,o),this.bloom.threshold=s,this.bloom.kernel=n,this.bloom.weight=r,this._downscale=new Pa(`${e} Downscale`,this._frameGraph,this.bloom._downscale),this._blurX=new ya(`${e} Blur X`,this._frameGraph,this.bloom._blurX),this._blurY=new ya(`${e} Blur Y`,this._frameGraph,this.bloom._blurY),this._merge=new Ta(`${e} Merge`,this._frameGraph,this.bloom._merge),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.bloom.isReady()}record(){if(void 0===this.sourceTexture)throw new Error("FrameGraphBloomTask: sourceTexture is required");const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture),t={size:{width:Math.floor(e.size.width*this.bloom.scale),height:Math.floor(e.size.height*this.bloom.scale)},options:{createMipMaps:!1,types:[this._defaultPipelineTextureType],formats:[5],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},i=this._frameGraph.textureManager.createRenderTargetTexture(this._downscale.name,t);this._downscale.sourceTexture=this.sourceTexture,this._downscale.sourceSamplingMode=2,this._downscale.destinationTexture=i,this._downscale.record(!0);const r=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX.name,t);this._blurX.sourceTexture=i,this._blurX.sourceSamplingMode=2,this._blurX.destinationTexture=r,this._blurX.record(!0);const n=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY.name,t);this._blurY.sourceTexture=r,this._blurY.sourceSamplingMode=2,this._blurY.destinationTexture=n,this._blurY.record(!0);const s=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture,this._merge.name,s),this._merge.sourceTexture=this.sourceTexture,this._merge.sourceSamplingMode=this.sourceSamplingMode,this._merge.blurTexture=n,this._merge.destinationTexture=this.outputTexture,this._merge.record(!0);const a=this._frameGraph.addRenderPass(this.name+"_disabled",!0);a.setRenderTarget(this.outputTexture),a.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}dispose(){this._downscale.dispose(),this._blurX.dispose(),this._blurY.dispose(),this._merge.dispose(),super.dispose()}}class Ra extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i,r=!1,n=.5){super(e,t,i),this._additionalConstructionParameters=[r,n],this.registerInput("source",Vs.tp.Texture),this.registerInput("destination",Vs.tp.Texture,!0),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=()=>this.destination.isConnected?this.destination:this.source,this._frameGraphTask=new Aa(this.name,t,i.getEngine(),.75,64,.2,r,n)}_createTask(e,t){const i=this._frameGraphTask.sourceSamplingMode,r=this._frameGraphTask.bloom.threshold,n=this._frameGraphTask.bloom.weight,s=this._frameGraphTask.bloom.kernel;this._frameGraphTask.dispose(),this._frameGraphTask=new Aa(this.name,this._frameGraph,this._scene.getEngine(),n,s,r,t,e),this._frameGraphTask.sourceSamplingMode=i,this._additionalConstructionParameters=[t,e]}get bloomScale(){return this._frameGraphTask.bloom.scale}set bloomScale(e){this._createTask(e,this._frameGraphTask.hdr)}get hdr(){return this._frameGraphTask.hdr}set hdr(e){this._createTask(this._frameGraphTask.bloom.scale,e)}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}get threshold(){return this._frameGraphTask.bloom.threshold}set threshold(e){this._frameGraphTask.bloom.threshold=e}get weight(){return this._frameGraphTask.bloom.weight}set weight(e){this._frameGraphTask.bloom.weight=e}get kernel(){return this._frameGraphTask.bloom.kernel}set kernel(e){this._frameGraphTask.bloom.kernel=e}getClassName(){return"NodeRenderGraphBloomPostProcessBlock"}get source(){return this._inputs[0]}get destination(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.destination.connectedPoint;i&&(this._frameGraphTask.destinationTexture=i.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.threshold = ${this.threshold};`),e.push(`${this._codeVariableName}.weight = ${this.weight};`),e.push(`${this._codeVariableName}.kernel = ${this.kernel};`),e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.threshold=this.threshold,e.weight=this.weight,e.kernel=this.kernel,e.sourceSamplingMode=this.sourceSamplingMode,e}_deserialize(e){super._deserialize(e),this.threshold=e.threshold,this.weight=e.weight,this.kernel=e.kernel,this.sourceSamplingMode=e.sourceSamplingMode}}(0,ue.Cg)([oa("Bloom scale",1,"PROPERTIES")],Ra.prototype,"bloomScale",null),(0,ue.Cg)([oa("HDR",0,"PROPERTIES")],Ra.prototype,"hdr",null),(0,ue.Cg)([oa("Source sampling mode",6)],Ra.prototype,"sourceSamplingMode",null),(0,ue.Cg)([oa("Threshold",1,"PROPERTIES",{min:0,max:2})],Ra.prototype,"threshold",null),(0,ue.Cg)([oa("Weight",1,"PROPERTIES",{min:0,max:3})],Ra.prototype,"weight",null),(0,ue.Cg)([oa("Kernel",2,"PROPERTIES",{min:1,max:128})],Ra.prototype,"kernel",null),(0,o.Y5)("BABYLON.NodeRenderGraphBloomPostProcessBlock",Ra);class Ia extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",Vs.tp.Texture),this.registerInput("destination",Vs.tp.Texture,!0),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=()=>this.destination.isConnected?this.destination:this.source,this._frameGraphTask=new ya(this.name,t,new Ea(e,i.getEngine(),new s.I9(1,0),32))}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}get direction(){return this._frameGraphTask.postProcess.direction}set direction(e){this._frameGraphTask.postProcess.direction=e}get kernel(){return this._frameGraphTask.postProcess.kernel}set kernel(e){this._frameGraphTask.postProcess.kernel=e}getClassName(){return"NodeRenderGraphBlurPostProcessBlock"}get source(){return this._inputs[0]}get destination(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.destination.connectedPoint;i&&(this._frameGraphTask.destinationTexture=i.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.direction = new BABYLON.Vector2(${this.direction.x}, ${this.direction.y});`),e.push(`${this._codeVariableName}.kernel = ${this.kernel};`),e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.direction=this.direction.asArray(),e.kernel=this.kernel,e.sourceSamplingMode=this.sourceSamplingMode,e}_deserialize(e){super._deserialize(e),this.direction.fromArray(e.direction),this.kernel=e.kernel,this.sourceSamplingMode=e.sourceSamplingMode}}(0,ue.Cg)([oa("Source sampling mode",6,"PROPERTIES")],Ia.prototype,"sourceSamplingMode",null),(0,ue.Cg)([oa("Direction",3,"PROPERTIES")],Ia.prototype,"direction",null),(0,ue.Cg)([oa("Kernel",2,"PROPERTIES",{min:1,max:256})],Ia.prototype,"kernel",null),(0,o.Y5)("BABYLON.NodeRenderGraphBlurPostProcessBlock",Ia);class Ma extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,61565)))):t.push(Promise.resolve().then(i.bind(i,56650)))}constructor(e,t=null,i){super({...i,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Ma.FragmentUrl,uniforms:Ma.Uniforms,samplers:Ma.Samplers,defines:i?.depthNotNormalized?Ma.DefinesDepthNotNormalized:void 0}),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50}bind(){super.bind();const e=this.options,t=this._drawWrapper.effect;e.depthNotNormalized||t.setFloat2("cameraMinMaxZ",this.camera.minZ,this.camera.maxZ-this.camera.minZ);const i=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);t.setFloat("focusDistance",this.focusDistance),t.setFloat("cocPrecalculation",i)}}Ma.FragmentUrl="circleOfConfusion",Ma.Uniforms=["cameraMinMaxZ","focusDistance","cocPrecalculation"],Ma.Samplers=["depthSampler"],Ma.DefinesDepthNotNormalized="#define COC_DEPTH_NOT_NORMALIZED";class Oa extends ga{constructor(e,t,i){super(e,t,i||new Ma(e,t.engine)),this.depthSamplingMode=2}record(e=!1){if(void 0===this.sourceTexture||void 0===this.depthTexture||void 0===this.camera)throw new Error(`FrameGraphCircleOfConfusionTask "${this.name}": sourceTexture, depthTexture and camera are required`);const t=super.record(e,(e=>{e.setTextureSamplingMode(this.depthTexture,this.depthSamplingMode)}),(e=>{this.postProcess.camera=this.camera,e.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture)}));return t.useTexture(this.depthTexture),t}}class Na extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",Vs.tp.Texture),this.registerInput("geomViewDepth",Vs.tp.TextureViewDepth),this.registerInput("destination",Vs.tp.Texture,!0),this.registerInput("camera",Vs.tp.Camera),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=()=>this.destination.isConnected?this.destination:this.source,this._frameGraphTask=new Oa(this.name,t,new Ma(e,i.getEngine(),{depthNotNormalized:!0}))}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}get depthSamplingMode(){return this._frameGraphTask.depthSamplingMode}set depthSamplingMode(e){this._frameGraphTask.depthSamplingMode=e}get lensSize(){return this._frameGraphTask.postProcess.lensSize}set lensSize(e){this._frameGraphTask.postProcess.lensSize=e}get fStop(){return this._frameGraphTask.postProcess.fStop}set fStop(e){this._frameGraphTask.postProcess.fStop=e}get focusDistance(){return this._frameGraphTask.postProcess.focusDistance}set focusDistance(e){this._frameGraphTask.postProcess.focusDistance=e}get focalLength(){return this._frameGraphTask.postProcess.focalLength}set focalLength(e){this._frameGraphTask.postProcess.focalLength=e}getClassName(){return"NodeRenderGraphCircleOfConfusionPostProcessBlock"}get source(){return this._inputs[0]}get geomViewDepth(){return this._inputs[1]}get destination(){return this._inputs[2]}get camera(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.geomViewDepth.connectedPoint;i&&(this._frameGraphTask.depthTexture=i.value);const r=this.destination.connectedPoint;r&&(this._frameGraphTask.destinationTexture=r.value);const n=this.camera.connectedPoint;n&&(this._frameGraphTask.camera=n.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.lensSize = ${this.lensSize};`),e.push(`${this._codeVariableName}.fStop = ${this.fStop};`),e.push(`${this._codeVariableName}.focusDistance = ${this.focusDistance};`),e.push(`${this._codeVariableName}.focalLength = ${this.focalLength};`),e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),e.push(`${this._codeVariableName}.depthSamplingMode = ${this.depthSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.lensSize=this.lensSize,e.fStop=this.fStop,e.focusDistance=this.focusDistance,e.focalLength=this.focalLength,e.sourceSamplingMode=this.sourceSamplingMode,e.depthSamplingMode=this.depthSamplingMode,e}_deserialize(e){super._deserialize(e),this.lensSize=e.lensSize,this.fStop=e.fStop,this.focusDistance=e.focusDistance,this.focalLength=e.focalLength,this.sourceSamplingMode=e.sourceSamplingMode,this.depthSamplingMode=e.depthSamplingMode}}(0,ue.Cg)([oa("Source sampling mode",6,"PROPERTIES")],Na.prototype,"sourceSamplingMode",null),(0,ue.Cg)([oa("Depth sampling mode",6,"PROPERTIES")],Na.prototype,"depthSamplingMode",null),(0,ue.Cg)([oa("Lens size",1,"PROPERTIES")],Na.prototype,"lensSize",null),(0,ue.Cg)([oa("F-Stop",1,"PROPERTIES")],Na.prototype,"fStop",null),(0,ue.Cg)([oa("Focus distance",1,"PROPERTIES")],Na.prototype,"focusDistance",null),(0,ue.Cg)([oa("Focal length",1,"PROPERTIES")],Na.prototype,"focalLength",null),(0,o.Y5)("BABYLON.NodeRenderGraphCircleOfConfusionPostProcessBlock",Na);class Da extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,96340)))):t.push(Promise.resolve().then(i.bind(i,4151)))}constructor(e,t=null,i){super({...i,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Da.FragmentUrl,samplers:Da.Samplers})}}Da.FragmentUrl="depthOfFieldMerge",Da.Samplers=["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"];class Fa extends ga{constructor(e,t,i){super(e,t,i||new Da(e,t.engine)),this.blurSteps=[]}record(e=!1){if(void 0===this.sourceTexture||void 0===this.circleOfConfusionTexture||0===this.blurSteps.length)throw new Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture, circleOfConfusionTexture and blurSteps are required`);this.postProcess.updateEffect("#define BLUR_LEVEL "+(this.blurSteps.length-1)+"\n");const t=super.record(e,void 0,(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture),this.blurSteps.forEach(((t,i)=>{i===this.blurSteps.length-1&&e.setTextureSamplingMode(t,2),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"blurStep"+(this.blurSteps.length-i-1),t)}))}));t.useTexture(this.circleOfConfusionTexture);for(const e of this.blurSteps)t.useTexture(e);return t}}class La extends Ea{constructor(e,t=null,i,r,n){super(e,t,i,r,{...n,defines:"#define DOF 1\n"})}}class wa extends ya{constructor(e,t,i){super(e,t,i||new La(e,t.engine,new s.I9(1,0),10)),this.circleOfConfusionSamplingMode=2}record(e=!1){if(void 0===this.sourceTexture||void 0===this.circleOfConfusionTexture)throw new Error(`FrameGraphDepthOfFieldBlurTask "${this.name}": sourceTexture and circleOfConfusionTexture are required`);const t=super.record(e,(e=>{e.setTextureSamplingMode(this.circleOfConfusionTexture,this.circleOfConfusionSamplingMode)}),(e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture)}));return t.useTexture(this.circleOfConfusionTexture),t}}!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(pa||(pa={}));class Ba{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=0,r=!1,n=!1){this._depthOfFieldBlurX=[],this._depthOfFieldBlurY=[],this._circleOfConfusion=new Ma(e,t,{depthNotNormalized:r,blockCompilation:n}),this.blurLevel=i;let a=1,o=15;switch(i){case 2:a=3,o=51;break;case 1:a=2,o=31;break;default:o=15,a=1}const l=o/Math.pow(2,a-1);let c=1;for(let i=0;i<a;i++)this._depthOfFieldBlurY.push([new Ea(e,t,new s.I9(0,1),l,{blockCompilation:n}),c]),c=.75/Math.pow(2,i),this._depthOfFieldBlurX.push([new Ea(e,t,new s.I9(1,0),l,{blockCompilation:n}),c]);this._dofMerge=new Da(e,t,{blockCompilation:n})}isReady(){let e=this._circleOfConfusion.isReady()&&this._dofMerge.isReady();for(let t=0;t<this._depthOfFieldBlurX.length;t++)e=e&&this._depthOfFieldBlurX[t][0].isReady()&&this._depthOfFieldBlurY[t][0].isReady();return e}}class Va extends Us.L{get name(){return this._name}set name(e){if(this._name=e,this._circleOfConfusion&&(this._circleOfConfusion.name=`${e} Circle of Confusion`),this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X`,this._blurY[t].name=`${e} Blur Y`;this._merge&&(this._merge.name=`${e} Merge`)}constructor(e,t,i,r=0,n=!1){if(super(e,t),this.sourceSamplingMode=2,this.depthSamplingMode=2,this._blurX=[],this._blurY=[],this._engine=i,this.hdr=n,this._defaultPipelineTextureType=0,n){const e=i.getCaps();e.textureHalfFloatRender?this._defaultPipelineTextureType=2:e.textureFloatRender&&(this._defaultPipelineTextureType=1)}this.depthOfField=new Ba(e,i,r,!0),this._circleOfConfusion=new Oa(`${e} Circle of Confusion`,this._frameGraph,this.depthOfField._circleOfConfusion);const s=this.depthOfField._depthOfFieldBlurX.length;for(let t=0;t<s;t++)this._blurX.push(new wa(`${e} Blur X`,this._frameGraph,this.depthOfField._depthOfFieldBlurX[t][0])),this._blurY.push(new wa(`${e} Blur Y`,this._frameGraph,this.depthOfField._depthOfFieldBlurY[t][0]));this._merge=new Fa(`${e} Merge`,this._frameGraph,this.depthOfField._dofMerge),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.depthOfField.isReady()}record(){if(void 0===this.sourceTexture||void 0===this.depthTexture||void 0===this.camera)throw new Error("FrameGraphDepthOfFieldTask: sourceTexture, depthTexture and camera are required");const e=this._frameGraph.textureManager.getTextureDescription(this.sourceTexture),t={width:e.size.width,height:e.size.height},i=this._engine.isWebGPU||this._engine.version>1?6:5,r={size:t,options:{createMipMaps:!1,types:[this._defaultPipelineTextureType],formats:[i],samples:1,useSRGBBuffers:[!1],labels:[""]},sizeIsPercentage:!1},n=this._frameGraph.textureManager.createRenderTargetTexture(this._circleOfConfusion.name,r);this._circleOfConfusion.sourceTexture=this.sourceTexture,this._circleOfConfusion.depthTexture=this.depthTexture,this._circleOfConfusion.depthSamplingMode=this.depthSamplingMode,this._circleOfConfusion.camera=this.camera,this._circleOfConfusion.destinationTexture=n,this._circleOfConfusion.record(!0),r.options.formats=[5];const s=[];for(let i=0;i<this._blurX.length;i++){const a=this.depthOfField._depthOfFieldBlurX[i][1];t.width=Math.floor(e.size.width*a),t.height=Math.floor(e.size.height*a),r.options.labels[0]="step "+(i+1);const o=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[i].name,r);this._blurY[i].sourceTexture=0===i?this.sourceTexture:this._blurX[i-1].outputTexture,this._blurY[i].sourceSamplingMode=2,this._blurY[i].circleOfConfusionTexture=n,this._blurY[i].destinationTexture=o,this._blurY[i].record(!0);const l=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[i].name,r);this._blurX[i].sourceTexture=this._blurY[i].outputTexture,this._blurX[i].sourceSamplingMode=2,this._blurX[i].circleOfConfusionTexture=n,this._blurX[i].destinationTexture=l,this._blurX[i].record(!0),s.push(l)}const a=this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture,this._merge.name,a),this._merge.sourceTexture=this.sourceTexture,this._merge.sourceSamplingMode=this.sourceSamplingMode,this._merge.circleOfConfusionTexture=n,this._merge.blurSteps=s,this._merge.destinationTexture=this.outputTexture,this._merge.record(!0);const o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);o.setRenderTarget(this.outputTexture),o.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}))}dispose(){this._circleOfConfusion.dispose();for(let e=0;e<this._blurX.length;e++)this._blurX[e].dispose(),this._blurY[e].dispose();this._merge.dispose(),super.dispose()}}class ka extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i,r=0,n=!1){super(e,t,i),this._additionalConstructionParameters=[r,n],this.registerInput("source",Vs.tp.Texture),this.registerInput("geomViewDepth",Vs.tp.TextureViewDepth),this.registerInput("destination",Vs.tp.Texture,!0),this.registerInput("camera",Vs.tp.Camera),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=()=>this.destination.isConnected?this.destination:this.source,this._frameGraphTask=new Va(this.name,t,i.getEngine(),r,n)}_createTask(e,t){const i=this._frameGraphTask.sourceSamplingMode,r=this._frameGraphTask.depthSamplingMode,n=this._frameGraphTask.depthOfField.focalLength,s=this._frameGraphTask.depthOfField.fStop,a=this._frameGraphTask.depthOfField.focusDistance,o=this._frameGraphTask.depthOfField.lensSize;this._frameGraphTask.dispose(),this._frameGraphTask=new Va(this.name,this._frameGraph,this._scene.getEngine(),e,t),this._frameGraphTask.sourceSamplingMode=i,this._frameGraphTask.depthSamplingMode=r,this._frameGraphTask.depthOfField.focalLength=n,this._frameGraphTask.depthOfField.fStop=s,this._frameGraphTask.depthOfField.focusDistance=a,this._frameGraphTask.depthOfField.lensSize=o,this._additionalConstructionParameters=[e,t]}get blurLevel(){return this._frameGraphTask.depthOfField.blurLevel}set blurLevel(e){this._createTask(e,this._frameGraphTask.hdr)}get hdr(){return this._frameGraphTask.hdr}set hdr(e){this._createTask(this._frameGraphTask.depthOfField.blurLevel,e)}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}get depthSamplingMode(){return this._frameGraphTask.depthSamplingMode}set depthSamplingMode(e){this._frameGraphTask.depthSamplingMode=e}get focalLength(){return this._frameGraphTask.depthOfField.focalLength}set focalLength(e){this._frameGraphTask.depthOfField.focalLength=e}get fStop(){return this._frameGraphTask.depthOfField.fStop}set fStop(e){this._frameGraphTask.depthOfField.fStop=e}get focusDistance(){return this._frameGraphTask.depthOfField.focusDistance}set focusDistance(e){this._frameGraphTask.depthOfField.focusDistance=e}get lensSize(){return this._frameGraphTask.depthOfField.lensSize}set lensSize(e){this._frameGraphTask.depthOfField.lensSize=e}getClassName(){return"NodeRenderGraphDepthOfFieldPostProcessBlock"}get source(){return this._inputs[0]}get geomViewDepth(){return this._inputs[1]}get destination(){return this._inputs[2]}get camera(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.geomViewDepth.connectedPoint;i&&(this._frameGraphTask.depthTexture=i.value);const r=this.destination.connectedPoint;r&&(this._frameGraphTask.destinationTexture=r.value);const n=this.camera.connectedPoint;n&&(this._frameGraphTask.camera=n.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.lensSize = ${this.lensSize};`),e.push(`${this._codeVariableName}.fStop = ${this.fStop};`),e.push(`${this._codeVariableName}.focusDistance = ${this.focusDistance};`),e.push(`${this._codeVariableName}.focalLength = ${this.focalLength};`),e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),e.push(`${this._codeVariableName}.depthSamplingMode = ${this.depthSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.lensSize=this.lensSize,e.fStop=this.fStop,e.focusDistance=this.focusDistance,e.focalLength=this.focalLength,e.sourceSamplingMode=this.sourceSamplingMode,e.depthSamplingMode=this.depthSamplingMode,e}_deserialize(e){super._deserialize(e),this.lensSize=e.lensSize,this.fStop=e.fStop,this.focusDistance=e.focusDistance,this.focalLength=e.focalLength,this.sourceSamplingMode=e.sourceSamplingMode,this.depthSamplingMode=e.depthSamplingMode}}(0,ue.Cg)([oa("Blur level",4,"PROPERTIES",{options:[{label:"Low",value:0},{label:"Medium",value:1},{label:"High",value:2}]})],ka.prototype,"blurLevel",null),(0,ue.Cg)([oa("HDR",0,"PROPERTIES")],ka.prototype,"hdr",null),(0,ue.Cg)([oa("Source sampling mode",6,"PROPERTIES")],ka.prototype,"sourceSamplingMode",null),(0,ue.Cg)([oa("Depth sampling mode",6,"PROPERTIES")],ka.prototype,"depthSamplingMode",null),(0,ue.Cg)([oa("Focal length",1,"PROPERTIES")],ka.prototype,"focalLength",null),(0,ue.Cg)([oa("F-Stop",1,"PROPERTIES")],ka.prototype,"fStop",null),(0,ue.Cg)([oa("Focus distance",1,"PROPERTIES")],ka.prototype,"focusDistance",null),(0,ue.Cg)([oa("Lens size",1,"PROPERTIES")],ka.prototype,"lensSize",null),(0,o.Y5)("BABYLON.NodeRenderGraphDepthOfFieldPostProcessBlock",ka);class Ga extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",Vs.tp.Texture),this.registerInput("destination",Vs.tp.Texture,!0),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=()=>this.destination.isConnected?this.destination:this.source,this._frameGraphTask=new Pa(this.name,t,new Ca(e,i.getEngine()))}get sourceSamplingMode(){return this._frameGraphTask.sourceSamplingMode}set sourceSamplingMode(e){this._frameGraphTask.sourceSamplingMode=e}get threshold(){return this._frameGraphTask.postProcess.threshold}set threshold(e){this._frameGraphTask.postProcess.threshold=e}getClassName(){return"NodeRenderGraphExtractHighlightsPostProcessBlock"}get source(){return this._inputs[0]}get destination(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.destination.connectedPoint;i&&(this._frameGraphTask.destinationTexture=i.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.threshold = ${this.threshold};`),e.push(`${this._codeVariableName}.sourceSamplingMode = ${this.sourceSamplingMode};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.threshold=this.threshold,e.sourceSamplingMode=this.sourceSamplingMode,e}_deserialize(e){super._deserialize(e),this.threshold=e.threshold,this.sourceSamplingMode=e.sourceSamplingMode}}(0,ue.Cg)([oa("Source sampling mode",6,"PROPERTIES")],Ga.prototype,"sourceSamplingMode",null),(0,ue.Cg)([oa("Threshold",1,"PROPERTIES",{min:0,max:1})],Ga.prototype,"threshold",null),(0,o.Y5)("BABYLON.NodeRenderGraphExtractHighlightsPostProcessBlock",Ga);class Ua extends Us.L{constructor(e,t,i){super(e,t),this._scene=i,this.outputObjectList={meshes:[],particleSystems:[]}}record(){if(void 0===this.objectList||void 0===this.camera)throw new Error(`FrameGraphCullObjectsTask ${this.name}: objectList and camera are required`);const e=this._frameGraph.addCullPass(this.name);e.setObjectList(this.outputObjectList),e.setExecuteFunc((e=>{this.outputObjectList.meshes=[],this.camera._updateFrustumPlanes();const t=this.camera._frustumPlanes,i=this.objectList.meshes||this._scene.meshes;for(let e=0;e<i.length;e++){const r=i[e];!r.isBlocked&&r.isReady()&&r.isEnabled()&&!r.scaling.hasAZeroComponent&&r.isVisible&&r.visibility>0&&r.layerMask&this.camera.layerMask&&(this._scene.skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.isInFrustum(t))&&this.outputObjectList.meshes.push(r)}}));const t=this._frameGraph.addCullPass(this.name+"_disabled",!0);t.setObjectList(this.outputObjectList),t.setExecuteFunc((e=>{this.outputObjectList.meshes=this.objectList.meshes,this.outputObjectList.particleSystems=this.objectList.particleSystems}))}}class za extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("camera",Vs.tp.Camera),this.registerInput("objects",Vs.tp.ObjectList),this.registerOutput("output",Vs.tp.ObjectList),this._frameGraphTask=new Ua(this.name,t,i)}getClassName(){return"NodeRenderGraphCullObjectsBlock"}get camera(){return this._inputs[0]}get objects(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputObjectList;const t=this.camera.connectedPoint;t&&(this._frameGraphTask.camera=t.value);const i=this.objects.connectedPoint;i&&(this._frameGraphTask.objectList=i.value)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+[].join("\n")}serialize(){return super.serialize()}_deserialize(e){super._deserialize(e)}}(0,o.Y5)("BABYLON.NodeRenderGraphCullObjectsBlock",za);var Wa=i(79130),Ha=i(14663);const Ya=[new a.ov(0,0,0,0),new a.ov(1,1,1,1),new a.ov(1e8,1e8,1e8,1e8)];class Xa extends Us.L{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}constructor(e,t,i,r){super(e,t),this.depthTest=!0,this.depthWrite=!0,this.size={width:100,height:100},this.sizeIsPercentage=!0,this.samples=1,this.textureDescriptions=[],this._scene=i,this._engine=this._scene.getEngine(),this._renderer=new Ha.P(e,i,r),this._renderer.renderSprites=!1,this._renderer.renderParticles=!1,this._renderer.onBeforeRenderingManagerRenderObservable.add((()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)})),this.name=e,this._clearAttachmentsLayout=new Map,this._allAttachmentsLayout=[],this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryScreenDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLocalPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryAlbedoTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryReflectivityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryVelocityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLinearVelocityTexture=this._frameGraph.textureManager.createDanglingHandle()}get excludedSkinnedMeshFromVelocityTexture(){return Wa.m.GetConfiguration(this._renderer.renderPassId).excludedSkinnedMesh}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(){if(0===this.textureDescriptions.length||void 0===this.objectList)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: object list and at least one geometry texture description must be provided`);const e=this._createMultiRenderTargetTexture(),t=this._checkDepthTextureCompatibility();this._buildClearAttachmentsLayout(),this._registerForRenderPassId(this._renderer.renderPassId);const i=this._frameGraph.textureManager.getTextureDescription(e[0]);this._textureWidth=i.size.width,this._textureHeight=i.size.height,Wa.m.MarkAsDirty(this._renderer.renderPassId,this.objectList.meshes||this._scene.meshes);const r=this._frameGraph.addRenderPass(this.name);r.setRenderTarget(e);for(let t=0;t<this.textureDescriptions.length;t++){const i=this.textureDescriptions[t],r=e[t],n=Wa.m.GeometryTextureDescriptions.findIndex((e=>e.type===i.type));switch(Wa.m.GeometryTextureDescriptions[n].type){case 5:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewDepthTexture,r);break;case 10:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryScreenDepthTexture,r);break;case 6:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewNormalTexture,r);break;case 8:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldNormalTexture,r);break;case 9:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLocalPositionTexture,r);break;case 1:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldPositionTexture,r);break;case 12:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryAlbedoTexture,r);break;case 3:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryReflectivityTexture,r);break;case 2:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryVelocityTexture,r);break;case 11:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLinearVelocityTexture,r)}}r.setRenderTargetDepth(this.depthTexture),r.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,e.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this._clearAttachmentsLayout.forEach(((t,i)=>{e.clearColorAttachments(Ya[i],t)})),e.bindAttachments(this._allAttachmentsLayout),e.render(this._renderer,this._textureWidth,this._textureHeight)}))}dispose(){Wa.m.DeleteConfiguration(this._renderer.renderPassId),this._renderer.dispose(),super.dispose()}_createMultiRenderTargetTexture(){const e=[],t=[],i=[],r=[];for(let n=0;n<this.textureDescriptions.length;n++){const s=this.textureDescriptions[n],a=Wa.m.GeometryTextureDescriptions.findIndex((e=>e.type===s.type));if(-1===a)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: unknown texture type ${s.type}`);e[n]=s.textureType,t[n]=s.textureFormat,i[n]=Wa.m.GeometryTextureDescriptions[a].name,r[n]=!1}const n=this._frameGraph.textureManager.createRenderTargetTexture(this.name,{size:this.size,sizeIsPercentage:this.sizeIsPercentage,options:{createMipMaps:!1,samples:this.samples,types:e,formats:t,useSRGBBuffers:r,labels:i}}),s=[];for(let e=0;e<this.textureDescriptions.length;e++)s.push(n+e);return s}_checkDepthTextureCompatibility(){let e=!1;if(void 0!==this.depthTexture){if(this.depthTexture===Gs)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth/stencil back buffer is not allowed as a depth texture`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==this.samples)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),e=!0}return e}_buildClearAttachmentsLayout(){const e=new Map,t=[];for(let i=0;i<this.textureDescriptions.length;i++){const r=this.textureDescriptions[i],n=Wa.m.GeometryTextureDescriptions.findIndex((e=>e.type===r.type)),s=Wa.m.GeometryTextureDescriptions[n];let a=e.get(s.clearType);if(void 0===a){a=[],e.set(s.clearType,a);for(let e=0;e<i;e++)a[e]=!1}e.forEach(((e,t)=>{e.push(t===s.clearType)})),t.push(!0)}this._clearAttachmentsLayout=new Map,e.forEach(((e,t)=>{this._clearAttachmentsLayout.set(t,this._engine.buildTextureLayout(e))})),this._allAttachmentsLayout=this._engine.buildTextureLayout(t)}_registerForRenderPassId(e){const t=Wa.m.CreateConfiguration(e);for(let e=0;e<this.textureDescriptions.length;e++){const i=this.textureDescriptions[e],r=Wa.m.GeometryTextureDescriptions.findIndex((e=>e.type===i.type)),n=Wa.m.GeometryTextureDescriptions[r];t.defines[n.defineIndex]=e}}}class qa extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this.viewDepthFormat=6,this.viewDepthType=2,this.screenDepthFormat=6,this.screenDepthType=2,this.viewNormalFormat=5,this.viewNormalType=0,this.worldNormalFormat=5,this.worldNormalType=0,this.localPositionFormat=5,this.localPositionType=2,this.worldPositionFormat=5,this.worldPositionType=2,this.albedoFormat=5,this.albedoType=0,this.reflectivityFormat=5,this.reflectivityType=0,this.velocityFormat=5,this.velocityType=0,this.linearVelocityFormat=5,this.linearVelocityType=0,this._additionalConstructionParameters=[r],this.registerInput("depth",Vs.tp.TextureBackBufferDepthStencilAttachment,!0),this.registerInput("camera",Vs.tp.Camera),this.registerInput("objects",Vs.tp.ObjectList),this.registerOutput("outputDepth",Vs.tp.BasedOnInput),this.registerOutput("geomViewDepth",Vs.tp.TextureViewDepth),this.registerOutput("geomScreenDepth",Vs.tp.TextureScreenDepth),this.registerOutput("geomViewNormal",Vs.tp.TextureViewNormal),this.registerOutput("geomWorldNormal",Vs.tp.TextureViewNormal),this.registerOutput("geomLocalPosition",Vs.tp.TextureLocalPosition),this.registerOutput("geomWorldPosition",Vs.tp.TextureWorldPosition),this.registerOutput("geomAlbedo",Vs.tp.TextureAlbedo),this.registerOutput("geomReflectivity",Vs.tp.TextureReflectivity),this.registerOutput("geomVelocity",Vs.tp.TextureVelocity),this.registerOutput("geomLinearVelocity",Vs.tp.TextureLinearVelocity),this.depth.addAcceptedConnectionPointTypes(Vs.tp.TextureDepthStencilAttachment),this.outputDepth._typeConnectionSource=this.depth,this._frameGraphTask=new Xa(this.name,t,i,{doNotChangeAspectRatio:r})}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._frameGraphTask.dispose(),this._frameGraphTask=new Xa(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e}),this._additionalConstructionParameters=[e]}get width(){return this._frameGraphTask.size.width}set width(e){this._frameGraphTask.size.width=e}get height(){return this._frameGraphTask.size.height}set height(e){this._frameGraphTask.size.height=e}get sizeInPercentage(){return this._frameGraphTask.sizeIsPercentage}set sizeInPercentage(e){this._frameGraphTask.sizeIsPercentage=e}get samples(){return this._frameGraphTask.samples}set samples(e){this._frameGraphTask.samples=e}getClassName(){return"NodeRenderGraphGeometryRendererBlock"}get depth(){return this._inputs[0]}get camera(){return this._inputs[1]}get objects(){return this._inputs[2]}get outputDepth(){return this._outputs[0]}get geomViewDepth(){return this._outputs[1]}get geomScreenDepth(){return this._outputs[2]}get geomViewNormal(){return this._outputs[3]}get geomWorldNormal(){return this._outputs[4]}get geomLocalPosition(){return this._outputs[5]}get geomWorldPosition(){return this._outputs[6]}get geomAlbedo(){return this._outputs[7]}get geomReflectivity(){return this._outputs[8]}get geomVelocity(){return this._outputs[9]}get geomLinearVelocity(){return this._outputs[10]}_buildBlock(e){super._buildBlock(e);const t=[this.geomViewDepth.isConnected,this.geomScreenDepth.isConnected,this.geomViewNormal.isConnected,this.geomWorldNormal.isConnected,this.geomLocalPosition.isConnected,this.geomWorldPosition.isConnected,this.geomAlbedo.isConnected,this.geomReflectivity.isConnected,this.geomVelocity.isConnected,this.geomLinearVelocity.isConnected];if(t.every((e=>!e)))throw new Error("NodeRenderGraphGeometryRendererBlock: At least one output geometry buffer must be connected");this._frameGraphTask.name=this.name,this.outputDepth.value=this._frameGraphTask.outputDepthTexture,this.geomViewDepth.value=this._frameGraphTask.geometryViewDepthTexture,this.geomScreenDepth.value=this._frameGraphTask.geometryScreenDepthTexture,this.geomViewNormal.value=this._frameGraphTask.geometryViewNormalTexture,this.geomWorldNormal.value=this._frameGraphTask.geometryWorldNormalTexture,this.geomLocalPosition.value=this._frameGraphTask.geometryLocalPositionTexture,this.geomWorldPosition.value=this._frameGraphTask.geometryWorldPositionTexture,this.geomAlbedo.value=this._frameGraphTask.geometryAlbedoTexture,this.geomReflectivity.value=this._frameGraphTask.geometryReflectivityTexture,this.geomVelocity.value=this._frameGraphTask.geometryVelocityTexture,this.geomLinearVelocity.value=this._frameGraphTask.geometryLinearVelocityTexture;const i=this.depth.connectedPoint;i&&(this._frameGraphTask.depthTexture=i.value);const r=this.camera.connectedPoint;r&&(this._frameGraphTask.camera=r.value);const n=this.objects.connectedPoint;n&&(this._frameGraphTask.objectList=n.value),this._frameGraphTask.textureDescriptions=[];const s=[this.viewDepthFormat,this.screenDepthFormat,this.viewNormalFormat,this.worldNormalFormat,this.localPositionFormat,this.worldPositionFormat,this.albedoFormat,this.reflectivityFormat,this.velocityFormat,this.linearVelocityFormat],a=[this.viewDepthType,this.screenDepthType,this.viewNormalType,this.worldNormalType,this.localPositionType,this.worldPositionType,this.albedoType,this.reflectivityType,this.velocityType,this.linearVelocityType],o=[5,10,6,8,9,1,12,3,2,11];for(let e=0;e<t.length;e++)t[e]&&this._frameGraphTask.textureDescriptions.push({textureFormat:s[e],textureType:a[e],type:o[e]})}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.viewDepthFormat = ${this.viewDepthFormat};`),e.push(`${this._codeVariableName}.viewDepthType = ${this.viewDepthType};`),e.push(`${this._codeVariableName}.screenDepthFormat = ${this.screenDepthFormat};`),e.push(`${this._codeVariableName}.screenDepthType = ${this.screenDepthType};`),e.push(`${this._codeVariableName}.localPositionFormat = ${this.localPositionFormat};`),e.push(`${this._codeVariableName}.localPositionType = ${this.localPositionType};`),e.push(`${this._codeVariableName}.worldPositionFormat = ${this.worldPositionFormat};`),e.push(`${this._codeVariableName}.worldPositionType = ${this.worldPositionType};`),e.push(`${this._codeVariableName}.viewNormalFormat = ${this.viewNormalFormat};`),e.push(`${this._codeVariableName}.viewNormalType = ${this.viewNormalType};`),e.push(`${this._codeVariableName}.worldNormalFormat = ${this.worldNormalFormat};`),e.push(`${this._codeVariableName}.worldNormalType = ${this.worldNormalType};`),e.push(`${this._codeVariableName}.albedoFormat = ${this.albedoFormat};`),e.push(`${this._codeVariableName}.albedoType = ${this.albedoType};`),e.push(`${this._codeVariableName}.reflectivityFormat = ${this.reflectivityFormat};`),e.push(`${this._codeVariableName}.reflectivityType = ${this.reflectivityType};`),e.push(`${this._codeVariableName}.velocityFormat = ${this.velocityFormat};`),e.push(`${this._codeVariableName}.velocityType = ${this.velocityType};`),e.push(`${this._codeVariableName}.linearVelocityFormat = ${this.linearVelocityFormat};`),e.push(`${this._codeVariableName}.linearVelocityType = ${this.linearVelocityType};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.samples=this.samples,e.viewDepthFormat=this.viewDepthFormat,e.viewDepthType=this.viewDepthType,e.screenDepthFormat=this.screenDepthFormat,e.screenDepthType=this.screenDepthType,e.localPositionFormat=this.localPositionFormat,e.localPositionType=this.localPositionType,e.worldPositionFormat=this.worldPositionFormat,e.worldPositionType=this.worldPositionType,e.viewNormalFormat=this.viewNormalFormat,e.viewNormalType=this.viewNormalType,e.worldNormalFormat=this.worldNormalFormat,e.worldNormalType=this.worldNormalType,e.albedoFormat=this.albedoFormat,e.albedoType=this.albedoType,e.reflectivityFormat=this.reflectivityFormat,e.reflectivityType=this.reflectivityType,e.velocityFormat=this.velocityFormat,e.velocityType=this.velocityType,e.linearVelocityFormat=this.linearVelocityFormat,e.linearVelocityType=this.linearVelocityType,e}_deserialize(e){super._deserialize(e),this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.samples=e.samples,this.viewDepthFormat=e.viewDepthFormat,this.viewDepthType=e.viewDepthType,this.screenDepthFormat=e.screenDepthFormat,this.screenDepthType=e.screenDepthType,this.localPositionFormat=e.localPositionFormat,this.localPositionType=e.localPositionType,this.worldPositionFormat=e.worldPositionFormat,this.worldPositionType=e.worldPositionType,this.viewNormalFormat=e.viewNormalFormat,this.viewNormalType=e.viewNormalType,this.worldNormalFormat=e.worldNormalFormat,this.worldNormalType=e.worldNormalType,this.albedoFormat=e.albedoFormat,this.albedoType=e.albedoType,this.reflectivityFormat=e.reflectivityFormat,this.reflectivityType=e.reflectivityType,this.velocityFormat=e.velocityFormat,this.velocityType=e.velocityType,this.linearVelocityFormat=e.linearVelocityFormat,this.linearVelocityType=e.linearVelocityType}}(0,ue.Cg)([oa("Depth test",0,"PROPERTIES")],qa.prototype,"depthTest",null),(0,ue.Cg)([oa("Depth write",0,"PROPERTIES")],qa.prototype,"depthWrite",null),(0,ue.Cg)([oa("Do not change aspect ratio",0,"PROPERTIES")],qa.prototype,"doNotChangeAspectRatio",null),(0,ue.Cg)([oa("Texture width",2,"PROPERTIES")],qa.prototype,"width",null),(0,ue.Cg)([oa("Texture height",2,"PROPERTIES")],qa.prototype,"height",null),(0,ue.Cg)([oa("Size is in percentage",0,"PROPERTIES")],qa.prototype,"sizeInPercentage",null),(0,ue.Cg)([oa("Samples",2,"PROPERTIES",{min:1,max:8})],qa.prototype,"samples",null),(0,ue.Cg)([oa("View depth format",7,"GEOMETRY BUFFERS")],qa.prototype,"viewDepthFormat",void 0),(0,ue.Cg)([oa("View depth type",8,"GEOMETRY BUFFERS")],qa.prototype,"viewDepthType",void 0),(0,ue.Cg)([oa("Screen depth format",7,"GEOMETRY BUFFERS")],qa.prototype,"screenDepthFormat",void 0),(0,ue.Cg)([oa("Screen depth type",8,"GEOMETRY BUFFERS")],qa.prototype,"screenDepthType",void 0),(0,ue.Cg)([oa("View normal format",7,"GEOMETRY BUFFERS")],qa.prototype,"viewNormalFormat",void 0),(0,ue.Cg)([oa("View normal type",8,"GEOMETRY BUFFERS")],qa.prototype,"viewNormalType",void 0),(0,ue.Cg)([oa("World normal format",7,"GEOMETRY BUFFERS")],qa.prototype,"worldNormalFormat",void 0),(0,ue.Cg)([oa("World normal type",8,"GEOMETRY BUFFERS")],qa.prototype,"worldNormalType",void 0),(0,ue.Cg)([oa("Local position format",7,"GEOMETRY BUFFERS")],qa.prototype,"localPositionFormat",void 0),(0,ue.Cg)([oa("Local position type",8,"GEOMETRY BUFFERS")],qa.prototype,"localPositionType",void 0),(0,ue.Cg)([oa("World position format",7,"GEOMETRY BUFFERS")],qa.prototype,"worldPositionFormat",void 0),(0,ue.Cg)([oa("World position type",8,"GEOMETRY BUFFERS")],qa.prototype,"worldPositionType",void 0),(0,ue.Cg)([oa("Albedo format",7,"GEOMETRY BUFFERS")],qa.prototype,"albedoFormat",void 0),(0,ue.Cg)([oa("Albedo type",8,"GEOMETRY BUFFERS")],qa.prototype,"albedoType",void 0),(0,ue.Cg)([oa("Reflectivity format",7,"GEOMETRY BUFFERS")],qa.prototype,"reflectivityFormat",void 0),(0,ue.Cg)([oa("Reflectivity type",8,"GEOMETRY BUFFERS")],qa.prototype,"reflectivityType",void 0),(0,ue.Cg)([oa("Velocity format",7,"GEOMETRY BUFFERS")],qa.prototype,"velocityFormat",void 0),(0,ue.Cg)([oa("Velocity type",8,"GEOMETRY BUFFERS")],qa.prototype,"velocityType",void 0),(0,ue.Cg)([oa("Linear velocity format",7,"GEOMETRY BUFFERS")],qa.prototype,"linearVelocityFormat",void 0),(0,ue.Cg)([oa("Linear velocity type",8,"GEOMETRY BUFFERS")],qa.prototype,"linearVelocityType",void 0),(0,o.Y5)("BABYLON.NodeRenderGraphGeometryRendererBlock",qa);class $a extends Us.L{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}constructor(e,t,i,r){super(e,t),this.dependencies=[],this.depthTest=!0,this.depthWrite=!0,this._scene=i,this._renderer=new Ha.P(e,i,r),this.name=e,this._renderer.onBeforeRenderingManagerRenderObservable.add((()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)})),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(e=!1,t){if(void 0===this.destinationTexture||void 0===this.objectList)throw new Error(`FrameGraphObjectRendererTask ${this.name}: destinationTexture and objectList are required`);const i=this._frameGraph.textureManager.getTextureDescription(this.destinationTexture);let r=!1;if(void 0!==this.depthTexture){if(this.depthTexture===Gs&&this.destinationTexture!==ks)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer color texture is the only color texture allowed when the depth is the back buffer depth/stencil`);if(this.depthTexture!==Gs&&this.destinationTexture===ks)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer depth/stencil texture is the only depth texture allowed when the destination is the back buffer color`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==i.options.samples)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);r=!0}this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=i.size.width,this._textureHeight=i.size.height;const n=this._frameGraph.addRenderPass(this.name);if(n.setRenderTarget(this.destinationTexture),n.setRenderTargetDepth(this.depthTexture),n.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,e.setDepthStates(this.depthTest&&r,this.depthWrite&&r),e.render(this._renderer,this._textureWidth,this._textureHeight),t?.(e)})),void 0!==this.dependencies)for(const e of this.dependencies)n.useTexture(e);if(!e){const e=this._frameGraph.addRenderPass(this.name+"_disabled",!0);if(e.setRenderTarget(this.destinationTexture),e.setRenderTargetDepth(this.depthTexture),e.setExecuteFunc((e=>{})),void 0!==this.dependencies)for(const t of this.dependencies)e.useTexture(t)}}dispose(){this._renderer.dispose(),super.dispose()}}class ja extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("destination",Vs.tp.Texture),this.registerInput("depth",Vs.tp.TextureBackBufferDepthStencilAttachment,!0),this.registerInput("camera",Vs.tp.Camera),this.registerInput("objects",Vs.tp.ObjectList),this.registerInput("dependencies",Vs.tp.Texture,!0),this.registerOutput("output",Vs.tp.BasedOnInput),this.registerOutput("outputDepth",Vs.tp.BasedOnInput),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBufferDepthStencil),this.depth.addAcceptedConnectionPointTypes(Vs.tp.TextureDepthStencilAttachment),this.dependencies.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.output._typeConnectionSource=this.destination,this.outputDepth._typeConnectionSource=this.depth}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}getClassName(){return"NodeRenderGraphBaseObjectRendererBlock"}get destination(){return this._inputs[0]}get depth(){return this._inputs[1]}get camera(){return this._inputs[2]}get objects(){return this._inputs[3]}get dependencies(){return this._inputs[4]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture,this.outputDepth.value=this._frameGraphTask.outputDepthTexture;const t=this.destination.connectedPoint;t&&(this._frameGraphTask.destinationTexture=t.value);const i=this.depth.connectedPoint;i&&(this._frameGraphTask.depthTexture=i.value);const r=this.camera.connectedPoint;r&&(this._frameGraphTask.camera=r.value);const n=this.objects.connectedPoint;n&&(this._frameGraphTask.objectList=n.value),this._frameGraphTask.dependencies=[];const s=this.dependencies.connectedPoint;s&&(this._frameGraphTask.dependencies[0]=s.value)}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e}_deserialize(e){super._deserialize(e),this.depthTest=e.depthTest,this.depthWrite=e.depthWrite}}(0,ue.Cg)([oa("Depth test",0,"PROPERTIES")],ja.prototype,"depthTest",null),(0,ue.Cg)([oa("Depth write",0,"PROPERTIES")],ja.prototype,"depthWrite",null);class Ka extends ja{constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r],this._frameGraphTask=new $a(this.name,t,i,{doNotChangeAspectRatio:r})}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._frameGraphTask.dispose(),this._frameGraphTask=new $a(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e}),this._additionalConstructionParameters=[e]}getClassName(){return"NodeRenderGraphObjectRendererBlock"}}(0,ue.Cg)([oa("Do not change aspect ratio",0,"PROPERTIES")],Ka.prototype,"doNotChangeAspectRatio",null),(0,o.Y5)("BABYLON.NodeRenderGraphObjectRendererBlock",Ka);class Za{constructor(e,t=2,i=3,r=1,n=1){this._curIndex=0,this._sequence=[],this._numSamples=0,this.x=0,this.y=0,this._width=r,this._height=n,this._baseX=t,this._baseY=i,this._generateSequence(e),this.next()}regenerate(e){this._generateSequence(e),this.next()}setDimensions(e,t){this._width=e,this._height=t}next(){this.x=this._sequence[this._curIndex]/this._width,this.y=this._sequence[this._curIndex+1]/this._height,this._curIndex+=2,this._curIndex>=2*this._numSamples&&(this._curIndex=0)}_generateSequence(e){this._sequence=[],this._curIndex=0,this._numSamples=e;for(let t=1;t<=e;++t)this._sequence.push(this._halton(t,this._baseX)-.5,this._halton(t,this._baseY)-.5)}_halton(e,t){let i=1,r=0;for(;e>0;)i/=t,r+=i*(e%t),e=~~(e/t);return r}}class Qa extends Ks.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,6422)))):t.push(Promise.resolve().then(i.bind(i,37489)))}set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}get disabled(){return this._disabled}set disabled(e){this._disabled!==e&&(this._disabled=e,this._reset())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e,this._reset())}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e,this._reset())}constructor(e,t=null,i){super({...i,name:e,engine:t||_i.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:Qa.FragmentUrl,uniforms:Qa.Uniforms,samplers:Qa.Samplers}),this._samples=8,this.factor=.05,this._disabled=!1,this._textureWidth=0,this._textureHeight=0,this.disableOnCameraMove=!0,this._firstUpdate=!0,this._hs=new Za(this.samples)}_reset(){this._hs.setDimensions(this._textureWidth/2,this._textureHeight/2),this._hs.next(),this._firstUpdate=!0}updateProjectionMatrix(){if(!this.disabled){if(this.camera&&!this.camera.hasMoved)if(this.camera.mode===Ct.i.PERSPECTIVE_CAMERA){const e=this.camera.getProjectionMatrix();e.setRowFromFloats(2,this._hs.x,this._hs.y,e.m[10],e.m[11])}else{const e=this.camera.getProjectionMatrix(!0);e.setRowFromFloats(3,this._hs.x+e.m[12],this._hs.y+e.m[13],e.m[14],e.m[15])}this._hs.next()}}bind(){super.bind(),this.disabled||(this._drawWrapper.effect.setFloat("factor",this.camera?.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1)}}Qa.FragmentUrl="taa",Qa.Uniforms=["factor"],Qa.Samplers=["historySampler"];class Ja extends $a{constructor(e,t,i,r){super(e,t,i,r),this.postProcess=new Qa(`${e} post-process`,i.getEngine()),this._postProcessDrawWrapper=this.postProcess.drawWrapper}record(){if(void 0===this.destinationTexture||void 0===this.objectList)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: destinationTexture and objectList are required`);if(this.destinationTexture===ks||this.depthTexture===Gs)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: the back buffer color/depth textures are not allowed. Use regular textures instead.`);const e=this._frameGraph.textureManager.getTextureDescription(this.destinationTexture);let t=!1;if(void 0!==this.depthTexture){if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==e.options.samples)throw new Error(`FrameGraphTAAObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);t=!0}this.postProcess.camera=this.camera,this.postProcess.textureWidth=e.size.width,this.postProcess.textureHeight=e.size.height;const i={size:e.size,options:{createMipMaps:e.options.createMipMaps,types:[2],formats:[5],samples:1,useSRGBBuffers:[!1],creationFlags:[0],labels:[""]},sizeIsPercentage:!1,isHistoryTexture:!0},r=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} history`,i);let n;this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,r),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=e.size.width,this._textureHeight=e.size.height;const s=this._frameGraph.addRenderPass(this.name);s.setRenderTarget(this.destinationTexture),s.setRenderTargetDepth(this.depthTexture),s.setExecuteFunc((e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,this.postProcess.updateProjectionMatrix(),e.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this.postProcess.disabled||(this._scene.activeCamera=this.camera,this._scene.setTransformMatrix(this.camera.getViewMatrix(),this.camera.getProjectionMatrix())),e.render(this._renderer,this._textureWidth,this._textureHeight),this._scene.activeCamera=null,n=n||e.createRenderTarget(`${this.name} ping/pong`,r),e.bindRenderTarget(n,"frame graph - TAA merge with history texture"),this.postProcess.disabled?e.copyTexture(this.destinationTexture):e.applyFullScreenEffect(this._postProcessDrawWrapper,(()=>{this.postProcess.bind(),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.destinationTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"historySampler",r)}))}));const a=this._frameGraph.addRenderPass(this.name+"_disabled",!0);if(a.setRenderTarget(this.outputTexture),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc((e=>{e.copyTexture(this.destinationTexture)})),void 0!==this.dependencies)for(const e of this.dependencies)s.useTexture(e),a.useTexture(e)}}class eo extends ja{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0){super(e,t,i),this._additionalConstructionParameters=[r],this._frameGraphTask=new Ja(this.name,t,i,{doNotChangeAspectRatio:r})}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._frameGraphTask.dispose(),this._frameGraphTask=new Ja(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:e}),this._additionalConstructionParameters=[e]}get samples(){return this._frameGraphTask.postProcess.samples}set samples(e){this._frameGraphTask.postProcess.samples=e}get factor(){return this._frameGraphTask.postProcess.factor}set factor(e){this._frameGraphTask.postProcess.factor=e}get disableOnCameraMove(){return this._frameGraphTask.postProcess.disableOnCameraMove}set disableOnCameraMove(e){this._frameGraphTask.postProcess.disableOnCameraMove=e}get disableTAA(){return this._frameGraphTask.postProcess.disabled}set disableTAA(e){this._frameGraphTask.postProcess.disabled=e}getClassName(){return"NodeRenderGraphTAAObjectRendererBlock"}_dumpPropertiesCode(){const e=[];return e.push(`${this._codeVariableName}.samples = ${this.samples};`),e.push(`${this._codeVariableName}.factor = ${this.factor};`),e.push(`${this._codeVariableName}.disableOnCameraMove = ${this.disableOnCameraMove};`),e.push(`${this._codeVariableName}.disableTAA = ${this.disableTAA};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){const e=super.serialize();return e.samples=this.samples,e.factor=this.factor,e.disableOnCameraMove=this.disableOnCameraMove,e.disableTAA=this.disableTAA,e}_deserialize(e){super._deserialize(e),this.samples=e.samples,this.factor=e.factor,this.disableOnCameraMove=e.disableOnCameraMove,this.disableTAA=e.disableTAA}}(0,ue.Cg)([oa("Do not change aspect ratio",0,"PROPERTIES")],eo.prototype,"doNotChangeAspectRatio",null),(0,ue.Cg)([oa("Samples",2,"TEMPORAL ANTI-ALIASING")],eo.prototype,"samples",null),(0,ue.Cg)([oa("Factor",1,"TEMPORAL ANTI-ALIASING")],eo.prototype,"factor",null),(0,ue.Cg)([oa("Disable on camera move",0,"TEMPORAL ANTI-ALIASING")],eo.prototype,"disableOnCameraMove",null),(0,ue.Cg)([oa("Disable TAA",0,"TEMPORAL ANTI-ALIASING")],eo.prototype,"disableTAA",null),(0,o.Y5)("BABYLON.NodeRenderGraphTAAObjectRendererBlock",eo);class to extends Bs.E{get endpoints(){return this._endpoints}constructor(e,t,i){super(e,t,i),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",Vs.tp.AutoDetect)}getClassName(){return"NodeRenderGraphTeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}(0,o.Y5)("BABYLON.NodeRenderGraphTeleportInBlock",to);class io extends Bs.E{constructor(e,t,i){super(e,t,i),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",Vs.tp.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeRenderGraphTeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}(0,o.Y5)("BABYLON.NodeRenderGraphTeleportOutBlock",io);class ro extends Us.L{constructor(e,t){super(e,t),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.sourceTexture||void 0===this.destinationTexture)throw new Error(`FrameGraphCopyToTextureTask "${this.name}": sourceTexture and destinationTexture are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture);const e=this._frameGraph.addRenderPass(this.name);e.useTexture(this.sourceTexture),e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{e.copyTexture(this.sourceTexture)}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc((e=>{}))}}class no extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("source",Vs.tp.Texture),this.registerInput("destination",Vs.tp.Texture),this.registerOutput("output",Vs.tp.BasedOnInput),this.source.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.destination.addAcceptedConnectionPointTypes(Vs.tp.TextureAll),this.output._typeConnectionSource=this.destination,this._frameGraphTask=new ro(e,t)}getClassName(){return"NodeRenderGraphCopyTextureBlock"}get source(){return this._inputs[0]}get destination(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this.output.value=this._frameGraphTask.outputTexture;const t=this.source.connectedPoint;t&&(this._frameGraphTask.sourceTexture=t.value);const i=this.destination.connectedPoint;i&&(this._frameGraphTask.destinationTexture=i.value)}}(0,o.Y5)("BABYLON.NodeRenderGraphCopyTextureBlock",no);class so extends Us.L{constructor(e,t){super(e,t),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.destinationTexture)throw new Error(`FrameGraphGenerateMipMapsTask ${this.name}: destinationTexture is required`);if(this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.destinationTexture),!this._frameGraph.textureManager.getTextureDescription(this.destinationTexture).options.createMipMaps)throw new Error(`FrameGraphGenerateMipMapsTask ${this.name}: destinationTexture must have createMipMaps set to true`);const e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.outputTexture),e.setExecuteFunc((e=>{e.generateMipMaps()}));const t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc((e=>{}))}}class ao extends Bs.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("texture",Vs.tp.Texture),this.registerOutput("output",Vs.tp.BasedOnInput),this.texture.addAcceptedConnectionPointTypes(Vs.tp.TextureAllButBackBuffer),this.output._typeConnectionSource=this.texture,this._frameGraphTask=new so(e,t)}getClassName(){return"NodeRenderGraphGenerateMipmapsBlock"}get texture(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.name=this.name,this._propagateInputValueToOutput(this.texture,this.output);const t=this.texture.connectedPoint;t&&(this._frameGraphTask.destinationTexture=t.value)}}(0,o.Y5)("BABYLON.NodeRenderGraphGenerateMipmapsBlock",ao);class oo{}var lo=i(8209),co=i(18917),ho=i(84900),uo=i(9472),po=i(35881);class fo extends uo.Fq{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=a.v9.Gray(),i=po.j.DefaultUtilityLayer,r=null,o=1,l=a.v9.Yellow(),c=a.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new n.cP,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this.incrementalSnap=!1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._tmpVector=new s.Pq(0,0,0),this._incrementalStartupValue=s.Pq.Zero(),this._parent=r,this._coloredMaterial=new Oi.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new a.v9(.1,.1,.1)),this._hoverMaterial=new Oi.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._disableMaterial=new Oi.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=c,this._disableMaterial.alpha=.4,this._gizmoMesh=new Rt.e("axis",i.utilityLayerScene);const{arrowMesh:h,arrowTail:u}=this._createGizmoMesh(this._gizmoMesh,o),d=this._createGizmoMesh(this._gizmoMesh,o+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,uo.Fq.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);const p=h.position.clone(),f=u.position.clone(),m=u.scaling.clone(),_=e=>{const t=e*(3/this._rootMesh.scaling.length())*6;h.position.z+=t/3.5,u.scaling.y+=t,this.dragScale=u.scaling.y,u.position.z=h.position.z/2},g=()=>{h.position.set(p.x,p.y,p.z),u.position.set(f.x,f.y,f.z),u.scaling.set(m.x,m.y,m.z),this.dragScale=u.scaling.y,this._dragging=!1};this.dragBehavior=new Ie.C({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let v=0,S=0;const x={snapDistance:0};this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const i=this.sensitivity*t.dragDistance*(3*this.scaleRatio/this._rootMesh.scaling.length()),r=this._tmpVector;let n=!1,a=0;if(this.uniformScaling?r.setAll(.57735):r.copyFrom(e),0==this.snapDistance)r.scaleToRef(i,r);else{v+=i,S+=i;const e=this.incrementalSnap?S:v;Math.abs(e)>this.snapDistance?(a=Math.floor(Math.abs(e)/this.snapDistance),e<0&&(a*=-1),v%=this.snapDistance,r.scaleToRef(this.snapDistance*a,r),n=!0):r.scaleInPlace(0)}r.addInPlaceFromFloats(1,1,1),r.x=Math.abs(r.x)<fo.MinimumAbsoluteScale?fo.MinimumAbsoluteScale*(r.x<0?-1:1):r.x,r.y=Math.abs(r.y)<fo.MinimumAbsoluteScale?fo.MinimumAbsoluteScale*(r.y<0?-1:1):r.y,r.z=Math.abs(r.z)<fo.MinimumAbsoluteScale?fo.MinimumAbsoluteScale*(r.z<0?-1:1):r.z;const o=this.attachedNode._isMesh?this.attachedNode:void 0;Math.abs(this.snapDistance)>0&&this.incrementalSnap?(this.attachedNode.getWorldMatrix().decompose(void 0,s.AA.Quaternion[0],s.AA.Vector3[2],uo.Fq.PreserveScaling?o:void 0),r.addInPlace(this._incrementalStartupValue),r.addInPlaceFromFloats(-1,-1,-1),r.x=Math.abs(r.x)*(this._incrementalStartupValue.x>0?1:-1),r.y=Math.abs(r.y)*(this._incrementalStartupValue.y>0?1:-1),r.z=Math.abs(r.z)*(this._incrementalStartupValue.z>0?1:-1),s.uq.ComposeToRef(r,s.AA.Quaternion[0],s.AA.Vector3[2],s.AA.Matrix[1])):(s.uq.ScalingToRef(r.x,r.y,r.z,s.AA.Matrix[2]),s.AA.Matrix[2].multiplyToRef(this.attachedNode.getWorldMatrix(),s.AA.Matrix[1])),s.AA.Matrix[1].decompose(s.AA.Vector3[1],void 0,void 0,uo.Fq.PreserveScaling?o:void 0);const l=1e5;Math.abs(s.AA.Vector3[1].x)<l&&Math.abs(s.AA.Vector3[1].y)<l&&Math.abs(s.AA.Vector3[1].z)<l&&this.attachedNode.getWorldMatrix().copyFrom(s.AA.Matrix[1]),n&&(x.snapDistance=this.snapDistance*a,this.onSnapObservable.notifyObservers(x)),this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0;const e=this.attachedNode._isMesh?this.attachedNode:void 0;this.attachedNode?.getWorldMatrix().decompose(this._incrementalStartupValue,void 0,void 0,uo.Fq.PreserveScaling?e:void 0),v=0,S=0})),this.dragBehavior.onDragObservable.add((e=>_(e.dragDistance))),this.dragBehavior.onDragEndObservable.add(g),r?.uniformScaleGizmo?.dragBehavior?.onDragObservable?.add((e=>_(e.delta.y))),r?.uniformScaleGizmo?.dragBehavior?.onDragEndObservable?.add(g);const T={gizmoMeshes:[h,u],colliderMeshes:[d.arrowMesh,d.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,T),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(this._customMeshSet)return;let t=this._parent?.getAxisCache(this._gizmoMesh);if(this._isHovered=!(!t||-1==t.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),t=this._parent?.getAxisCache(this._rootMesh),this._isHovered||(this._isHovered=!(!t||-1==t.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh))),!this._parent){const e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(T.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(T.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}));const E=i._getSharedGizmoLight();E.includedOnlyMeshes=E.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes())}_createGizmoMesh(e,t,i=!1){const r=(0,co.an)("yPosMesh",{size:.4*(1+(t-1)/4)},this.gizmoLayer.utilityLayerScene),n=(0,ho.zk)("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},this.gizmoLayer.utilityLayerScene);return r.scaling.scaleInPlace(.1),r.material=this._coloredMaterial,r.rotation.x=Math.PI/2,r.position.z+=.3,n.material=this._coloredMaterial,n.position.z+=.1375,n.rotation.x=Math.PI/2,i&&(r.visibility=0,n.visibility=0),e.addChild(r),e.addChild(n),{arrowMesh:r,arrowTail:n}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}setCustomMesh(e,t=!1){super.setCustomMesh(e),t&&(this._rootMesh.getChildMeshes().forEach((e=>{e.material=this._coloredMaterial,e.color&&(e.color=this._coloredMaterial.diffuseColor)})),this._customMeshSet=!1)}}fo.MinimumAbsoluteScale=Ee.bH;var mo,_o=i(96487),go=i(18458);!function(e){e[e.Rotation=0]="Rotation",e[e.Scaling=1]="Scaling"}(mo||(mo={}));class vo extends uo.Fq{set axisFactor(e){this._axisFactor=e;const t=this._scaleBoxesParent.getChildMeshes();let i=0;for(let e=0;e<3;e++)for(let r=0;r<3;r++)for(let n=0;n<3;n++){const a=(1===e?1:0)+(1===r?1:0)+(1===n?1:0);if(1!==a&&3!==a){if(t[i]){const a=new s.Pq(e-1,r-1,n-1);a.multiplyInPlace(this._axisFactor),t[i].setEnabled(a.lengthSquared()>Ee.bH)}i++}}}get axisFactor(){return this._axisFactor}set scaleDragSpeed(e){this._scaleDragSpeed=e}get scaleDragSpeed(){return this._scaleDragSpeed}get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverColoredMaterial}get pointerDragBehavior(){return this._pointerDragBehavior}get isDragging(){return this._dragging||this._pointerDragBehavior.dragging}setColor(e){this._coloredMaterial.emissiveColor=e,this._hoverColoredMaterial.emissiveColor=e.clone().add(new a.v9(.3,.3,.3)),this._lineBoundingBox.getChildren().forEach((t=>{t.color&&(t.color=e)}))}constructor(e=a.v9.Gray(),t=po.j.DefaultKeepDepthUtilityLayer){super(t),this._boundingDimensions=new s.Pq(1,1,1),this._renderObserver=null,this._pointerObserver=null,this._scaleDragSpeed=.2,this._rotateAnchorsDragBehaviors=[],this._scaleBoxesDragBehaviors=[],this._dragging=!1,this._tmpQuaternion=new s.PT,this._tmpVector=new s.Pq(0,0,0),this._tmpRotationMatrix=new s.uq,this._incrementalStartupValue=s.Pq.Zero(),this._incrementalAnchorStartupValue=s.Pq.Zero(),this.ignoreChildren=!1,this.includeChildPredicate=null,this.rotationSphereSize=.1,this.scaleBoxSize=.1,this.fixedDragMeshScreenSize=!1,this.fixedDragMeshBoundsSize=!1,this.fixedDragMeshScreenSizeDistanceFactor=10,this.scalingSnapDistance=0,this.rotationSnapDistance=0,this.onDragStartObservable=new n.cP,this.onHoverStartObservable=new n.cP,this.onHoverEndObservable=new n.cP,this.onScaleBoxDragObservable=new n.cP,this.onScaleBoxDragEndObservable=new n.cP,this.onRotationSphereDragObservable=new n.cP,this.onRotationSphereDragEndObservable=new n.cP,this.scalePivot=null,this._axisFactor=new s.Pq(1,1,1),this.incrementalSnap=!1,this._existingMeshScale=new s.Pq,this._dragMesh=null,this._pointerDragBehavior=new Ie.C,this._cornerMesh=null,this.updateScale=!1,this._anchorMesh=new ui.V("anchor",t.utilityLayerScene),this._coloredMaterial=new Oi.F("",t.utilityLayerScene),this._coloredMaterial.disableLighting=!0,this._hoverColoredMaterial=new Oi.F("",t.utilityLayerScene),this._hoverColoredMaterial.disableLighting=!0,this._lineBoundingBox=new ui.V("",t.utilityLayerScene),this._lineBoundingBox.rotationQuaternion=new s.PT;const i=[];i.push((0,_o.sh)("lines",{points:[new s.Pq(0,0,0),new s.Pq(this._boundingDimensions.x,0,0)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(0,0,0),new s.Pq(0,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(0,0,0),new s.Pq(0,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(this._boundingDimensions.x,0,0),new s.Pq(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(this._boundingDimensions.x,0,0),new s.Pq(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(0,this._boundingDimensions.y,0),new s.Pq(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(0,this._boundingDimensions.y,0),new s.Pq(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(0,0,this._boundingDimensions.z),new s.Pq(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(0,0,this._boundingDimensions.z),new s.Pq(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new s.Pq(0,this._boundingDimensions.y,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new s.Pq(this._boundingDimensions.x,0,this._boundingDimensions.z)]},t.utilityLayerScene)),i.push((0,_o.sh)("lines",{points:[new s.Pq(this._boundingDimensions.x,this._boundingDimensions.y,this._boundingDimensions.z),new s.Pq(this._boundingDimensions.x,this._boundingDimensions.y,0)]},t.utilityLayerScene)),i.forEach((t=>{t.color=e,t.position.addInPlace(new s.Pq(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),t.isPickable=!1,this._lineBoundingBox.addChild(t)})),this._rootMesh.addChild(this._lineBoundingBox),this.setColor(e),this._rotateAnchorsParent=new ui.V("",t.utilityLayerScene),this._rotateAnchorsParent.rotationQuaternion=new s.PT;for(let e=0;e<12;e++){const i=(0,co.an)("",{width:e<4||e>=8?1.6:.4,height:e>=4&&e<8?1.6:.4,depth:.4},t.utilityLayerScene);i.rotation.x=e<4||e>=8?.25*Math.PI:0,i.rotation.y=e>=4&&e<8?.25*Math.PI:0,i.bakeTransformIntoVertices(i.computeWorldMatrix(!0)),i.rotationQuaternion=new s.PT,i.material=this._coloredMaterial,i.isNearGrabbable=!0;const r=new Ie.C({});r.moveAttached=!1,r.updateDragPlane=!1,i.addBehavior(r);const n=new s.Pq(1,0,0);let a=0,o=0;r.onDragStartObservable.add((()=>{n.copyFrom(i.forward),a=0,o=0}));const l=function(){const t=Math.floor(e/4);return s.AA.Vector3[0].set(0==t?1:0,1==t?1:0,2==t?1:0),s.AA.Vector3[0]};r.onDragObservable.add((t=>{if(this.onRotationSphereDragObservable.notifyObservers({dragOperation:0,dragAxis:l().clone()}),this.attachedMesh){const i=this.attachedMesh.parent;if(i&&i.scaling&&i.scaling.isNonUniformWithinEpsilon(.001))return void f.V.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");go.G._RemoveAndStorePivotPoint(this.attachedMesh);const r=n,l=t.dragPlaneNormal.scale(s.Pq.Dot(t.dragPlaneNormal,r)),c=r.subtract(l).normalizeToNew();let h=s.Pq.Dot(c,t.delta)<0?Math.abs(t.delta.length()):-Math.abs(t.delta.length());if(h=h/this._boundingDimensions.length()*this._anchorMesh.scaling.length(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=s.PT.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=s.PT.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),a+=h,Math.abs(a)<=2*Math.PI){if(this.rotationSnapDistance>0){const e=Math.floor(Math.abs(a)/this.rotationSnapDistance)*(a<0?-1:1),t=this.rotationSnapDistance*e;h=t-o,o=t}e>=8?s.PT.RotationYawPitchRollToRef(0,0,h,this._tmpQuaternion):e>=4?s.PT.RotationYawPitchRollToRef(h,0,0,this._tmpQuaternion):s.PT.RotationYawPitchRollToRef(0,h,0,this._tmpQuaternion),this.attachedMesh.isUsingPivotMatrix()&&this._anchorMesh.position.copyFrom(this.attachedMesh.position),this._anchorMesh.addChild(this.attachedMesh),this._anchorMesh.getScene().useRightHandedSystem&&this._tmpQuaternion.conjugateInPlace(),this._tmpQuaternion.normalize(),this._anchorMesh.rotationQuaternion.multiplyToRef(this._tmpQuaternion,this._anchorMesh.rotationQuaternion),this._anchorMesh.rotationQuaternion.normalize(),this._anchorMesh.removeChild(this.attachedMesh),this.attachedMesh.setParent(i)}this.updateBoundingBox(),go.G._RestorePivotPoint(this.attachedMesh)}this._updateDummy()})),r.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({dragOperation:0,dragAxis:l().clone()}),this._dragging=!0,this._selectNode(i)})),r.onDragEndObservable.add((e=>{this.onRotationSphereDragEndObservable.notifyObservers({dragOperation:0,dragAxis:l().clone()}),this._dragging=!1,this._selectNode(null),this._updateDummy(),this._unhoverMeshOnTouchUp(e.pointerInfo,i)})),this._rotateAnchorsDragBehaviors.push(r),this._rotateAnchorsParent.addChild(i)}this._rootMesh.addChild(this._rotateAnchorsParent),this._scaleBoxesParent=new ui.V("",t.utilityLayerScene),this._scaleBoxesParent.rotationQuaternion=new s.PT;for(let e=0;e<3;e++)for(let i=0;i<3;i++)for(let r=0;r<3;r++){const n=(1===e?1:0)+(1===i?1:0)+(1===r?1:0);if(1===n||3===n)continue;const a=2===n?(0,co.an)("",{size:1},t.utilityLayerScene):this._getCornerMesh(t);0===n&&(a.rotationQuaternion=s.PT.FromEulerAngles(.25*i*Math.PI,.25*(r+3*e-e*r)*Math.PI,0)),a.material=this._coloredMaterial,a._internalMetadata=2===n,a.isNearGrabbable=!0,s.AA.Vector3[0].set(e-1,i-1,r-1),s.AA.Vector3[0].normalize(),a.computeWorldMatrix(!0).invertToRef(s.AA.Matrix[0]);const o=s.Pq.TransformCoordinates(s.AA.Vector3[0],s.AA.Matrix[0]);o.normalize();const l=new Ie.C({dragAxis:o});l.updateDragPlane=!1,l.moveAttached=!1;let c=0,h=0;a.addBehavior(l),l.onDragObservable.add((t=>{if(this.onScaleBoxDragObservable.notifyObservers({dragOperation:1,dragAxis:new s.Pq(e-1,i-1,r-1)}),this.attachedMesh){const e=this.attachedMesh.parent;if(e&&e.scaling&&e.scaling.isNonUniformWithinEpsilon(.001))return void f.V.Warn("BoundingBoxGizmo controls are not supported on child meshes with non-uniform parent scaling");go.G._RemoveAndStorePivotPoint(this.attachedMesh);let i=t.dragDistance/this._boundingDimensions.length()*this._anchorMesh.scaling.length();if(c+=i,this.scalingSnapDistance>0){const e=Math.floor(Math.abs(c)/this.scalingSnapDistance)*(c<0?-1:1),t=this.scalingSnapDistance*e;i=t-h,h=t}const r=new s.Pq(i,i,i),l=new s.Pq(h,h,h);2===n&&(r.x*=Math.abs(o.x),r.y*=Math.abs(o.y),r.z*=Math.abs(o.z)),r.scaleInPlace(this._scaleDragSpeed),r.multiplyInPlace(this._axisFactor),l.scaleInPlace(this._scaleDragSpeed),l.multiplyInPlace(this._axisFactor),l.addInPlace(this._incrementalStartupValue),this.updateBoundingBox(),this.scalePivot?(this.attachedMesh.getWorldMatrix().getRotationMatrixToRef(this._tmpRotationMatrix),this._boundingDimensions.scaleToRef(.5,this._tmpVector),s.Pq.TransformCoordinatesToRef(this._tmpVector,this._tmpRotationMatrix,this._tmpVector),this._anchorMesh.position.subtractInPlace(this._tmpVector),this._boundingDimensions.multiplyToRef(this.scalePivot,this._tmpVector),s.Pq.TransformCoordinatesToRef(this._tmpVector,this._tmpRotationMatrix,this._tmpVector),this._anchorMesh.position.addInPlace(this._tmpVector)):(a.absolutePosition.subtractToRef(this._anchorMesh.position,this._tmpVector),this._anchorMesh.position.subtractInPlace(this._tmpVector),this.attachedMesh.isUsingPivotMatrix()&&this._anchorMesh.position.subtractInPlace(this.attachedMesh.getPivotPoint())),this._anchorMesh.addChild(this.attachedMesh),this.incrementalSnap?(l.x/=Math.abs(this._incrementalStartupValue.x)<Ee.bH?1:this._incrementalStartupValue.x,l.y/=Math.abs(this._incrementalStartupValue.y)<Ee.bH?1:this._incrementalStartupValue.y,l.z/=Math.abs(this._incrementalStartupValue.z)<Ee.bH?1:this._incrementalStartupValue.z,l.x=Math.max(this._incrementalAnchorStartupValue.x*l.x,this.scalingSnapDistance),l.y=Math.max(this._incrementalAnchorStartupValue.y*l.y,this.scalingSnapDistance),l.z=Math.max(this._incrementalAnchorStartupValue.z*l.z,this.scalingSnapDistance),this._anchorMesh.scaling.x+=(l.x-this._anchorMesh.scaling.x)*Math.abs(o.x),this._anchorMesh.scaling.y+=(l.y-this._anchorMesh.scaling.y)*Math.abs(o.y),this._anchorMesh.scaling.z+=(l.z-this._anchorMesh.scaling.z)*Math.abs(o.z)):(this._anchorMesh.scaling.addInPlace(r),(this._anchorMesh.scaling.x<0||this._anchorMesh.scaling.y<0||this._anchorMesh.scaling.z<0)&&this._anchorMesh.scaling.subtractInPlace(r)),this._anchorMesh.removeChild(this.attachedMesh),this.attachedMesh.setParent(e),go.G._RestorePivotPoint(this.attachedMesh)}this._updateDummy()})),l.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({dragOperation:1,dragAxis:new s.Pq(e-1,i-1,r-1)}),this._dragging=!0,this._selectNode(a),c=0,h=0,this._incrementalStartupValue.copyFrom(this.attachedMesh.scaling),this._incrementalAnchorStartupValue.copyFrom(this._anchorMesh.scaling)})),l.onDragEndObservable.add((t=>{this.onScaleBoxDragEndObservable.notifyObservers({dragOperation:1,dragAxis:new s.Pq(e-1,i-1,r-1)}),this._dragging=!1,this._selectNode(null),this._updateDummy(),this._unhoverMeshOnTouchUp(t.pointerInfo,a)})),this._scaleBoxesParent.addChild(a),this._scaleBoxesDragBehaviors.push(l)}this._rootMesh.addChild(this._scaleBoxesParent);const r=[];this._pointerObserver=t.utilityLayerScene.onPointerObservable.add((e=>{r[e.event.pointerId]?e.pickInfo&&e.pickInfo.pickedMesh!=r[e.event.pointerId]&&(r[e.event.pointerId].material=this._coloredMaterial,delete r[e.event.pointerId],this.onHoverEndObservable.notifyObservers(),this._isHovered=!1):this._rotateAnchorsParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach((t=>{e.pickInfo&&e.pickInfo.pickedMesh==t&&(r[e.event.pointerId]=t,t.material=this._hoverColoredMaterial,this.onHoverStartObservable.notifyObservers(),this._isHovered=!0)}))})),this._renderObserver=this.gizmoLayer.originalScene.onBeforeRenderObservable.add((()=>{this.attachedMesh&&!this._existingMeshScale.equals(this.attachedMesh.scaling)?this.updateBoundingBox():(this.fixedDragMeshScreenSize||this.fixedDragMeshBoundsSize)&&(this._updateRotationAnchors(),this._updateScaleBoxes()),this._dragMesh&&this.attachedMesh&&this._pointerDragBehavior.dragging&&(this._lineBoundingBox.position.rotateByQuaternionToRef(this._rootMesh.rotationQuaternion,this._tmpVector),this.attachedMesh.setAbsolutePosition(this._dragMesh.position.add(this._tmpVector.scale(-1))))})),this.updateBoundingBox()}_getCornerMesh(e){if(!this._cornerMesh){const t=(0,co.an)("",{width:.4,height:.4,depth:1.6},e.utilityLayerScene);t.position.z=.6;const i=(0,co.an)("",{width:.4,height:1.6,depth:.4},e.utilityLayerScene);i.position.y=.6;const r=(0,co.an)("",{width:1.6,height:.4,depth:.4},e.utilityLayerScene);return r.position.x=.6,this._cornerMesh=Rt.e.MergeMeshes([r,i,t],!0),this._cornerMesh}return this._cornerMesh.clone()}_attachedNodeChanged(e){if(e){this._anchorMesh.scaling.setAll(1),go.G._RemoveAndStorePivotPoint(e);const t=e.parent;this._anchorMesh.addChild(e),this._anchorMesh.removeChild(e),e.setParent(t),go.G._RestorePivotPoint(e),this.updateBoundingBox(),e.getChildMeshes(!1).forEach((e=>{e.markAsDirty("scaling")})),this.gizmoLayer.utilityLayerScene.onAfterRenderObservable.addOnce((()=>{this._updateDummy()}))}}_selectNode(e){this._rotateAnchorsParent.getChildMeshes().concat(this._scaleBoxesParent.getChildMeshes()).forEach((t=>{t.isVisible=!e||t==e}))}_unhoverMeshOnTouchUp(e,t){e?.event instanceof PointerEvent&&"touch"===e?.event.pointerType&&(t.material=this._coloredMaterial)}getScaleBoxes(){return this._scaleBoxesParent.getChildMeshes()}updateBoundingBox(){if(this.attachedMesh){go.G._RemoveAndStorePivotPoint(this.attachedMesh);const e=this.attachedMesh.parent;this.attachedMesh.setParent(null),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=s.PT.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._anchorMesh.rotationQuaternion||(this._anchorMesh.rotationQuaternion=s.PT.RotationYawPitchRoll(this._anchorMesh.rotation.y,this._anchorMesh.rotation.x,this._anchorMesh.rotation.z)),this._anchorMesh.rotationQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);const t=this.attachedMesh.getHierarchyBoundingVectors(!this.ignoreChildren,this.includeChildPredicate);t.max.subtractToRef(t.min,this._boundingDimensions),this._lineBoundingBox.scaling.copyFrom(this._boundingDimensions),this._lineBoundingBox.position.set((t.max.x+t.min.x)/2,(t.max.y+t.min.y)/2,(t.max.z+t.min.z)/2),this._rotateAnchorsParent.position.copyFrom(this._lineBoundingBox.position),this._scaleBoxesParent.position.copyFrom(this._lineBoundingBox.position),this._lineBoundingBox.computeWorldMatrix(),this._anchorMesh.position.copyFrom(this._lineBoundingBox.absolutePosition),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),this.attachedMesh.setParent(e)}this._updateRotationAnchors(),this._updateScaleBoxes(),this.attachedMesh&&(this._existingMeshScale.copyFrom(this.attachedMesh.scaling),go.G._RestorePivotPoint(this.attachedMesh))}_updateRotationAnchors(){const e=this._rotateAnchorsParent.getChildMeshes();for(let t=0;t<3;t++)for(let i=0;i<2;i++)for(let r=0;r<2;r++){const n=4*t+2*i+r;e[n].position.normalizeToRef(s.AA.Vector3[0]),0==t&&(e[n].position.set(0,this._boundingDimensions.y*(i-.5),this._boundingDimensions.z*(r-.5)),s.AA.Vector3[1].set(1,0,0)),1==t&&(e[n].position.set(this._boundingDimensions.x*(i-.5),0,this._boundingDimensions.z*(r-.5)),s.AA.Vector3[1].set(0,1,0)),2==t&&(e[n].position.set(this._boundingDimensions.x*(i-.5),this._boundingDimensions.y*(r-.5),0),s.AA.Vector3[1].set(0,0,1));const a=s.AA.Vector3[2];if(s.Pq.CrossToRef(s.AA.Vector3[0],s.AA.Vector3[1],a),a.normalize(),a.addInPlace(e[n].position),e[n].lookAt(a),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[n].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);const t=this.rotationSphereSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[n].scaling.set(t,t,t)}else this.fixedDragMeshBoundsSize?e[n].scaling.set(this.rotationSphereSize*this._boundingDimensions.x,this.rotationSphereSize*this._boundingDimensions.y,this.rotationSphereSize*this._boundingDimensions.z):e[n].scaling.set(this.rotationSphereSize,this.rotationSphereSize,this.rotationSphereSize)}}_updateScaleBoxes(){const e=this._scaleBoxesParent.getChildMeshes();let t=0;for(let i=0;i<3;i++)for(let r=0;r<3;r++)for(let n=0;n<3;n++){const a=(1===i?1:0)+(1===r?1:0)+(1===n?1:0);if(1!==a&&3!==a){if(e[t])if(e[t].position.set(this._boundingDimensions.x*(i/2),this._boundingDimensions.y*(r/2),this._boundingDimensions.z*(n/2)),e[t].position.addInPlace(new s.Pq(-this._boundingDimensions.x/2,-this._boundingDimensions.y/2,-this._boundingDimensions.z/2)),this.fixedDragMeshScreenSize&&this.gizmoLayer.utilityLayerScene.activeCamera){e[t].absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.globalPosition,this._tmpVector);const i=this.scaleBoxSize*this._tmpVector.length()/this.fixedDragMeshScreenSizeDistanceFactor;e[t].scaling.set(i,i,i)}else this.fixedDragMeshBoundsSize?e[t].scaling.set(this.scaleBoxSize*this._boundingDimensions.x,this.scaleBoxSize*this._boundingDimensions.y,this.scaleBoxSize*this._boundingDimensions.z):e[t].scaling.set(this.scaleBoxSize,this.scaleBoxSize,this.scaleBoxSize);t++}}}setEnabledRotationAxis(e){this._rotateAnchorsParent.getChildMeshes().forEach(((t,i)=>{i<4?t.setEnabled(-1!=e.indexOf("x")):i<8?t.setEnabled(-1!=e.indexOf("y")):t.setEnabled(-1!=e.indexOf("z"))}))}setEnabledScaling(e,t=!1){this._scaleBoxesParent.getChildMeshes().forEach((i=>{let r=e;t&&!0===i._internalMetadata&&(r=!1),i.setEnabled(r)}))}_updateDummy(){this._dragMesh&&(this._dragMesh.position.copyFrom(this._lineBoundingBox.getAbsolutePosition()),this._dragMesh.scaling.copyFrom(this._lineBoundingBox.scaling),this._dragMesh.rotationQuaternion.copyFrom(this._rootMesh.rotationQuaternion))}enableDragBehavior(){this._dragMesh=(0,co.an)("dummy",{size:1},this.gizmoLayer.utilityLayerScene),this._dragMesh.visibility=0,this._dragMesh.rotationQuaternion=new s.PT,this._pointerDragBehavior.useObjectOrientationForDragging=!1,this._dragMesh.addBehavior(this._pointerDragBehavior)}releaseDrag(){this._scaleBoxesDragBehaviors.forEach((e=>{e.releaseDrag()})),this._rotateAnchorsDragBehaviors.forEach((e=>{e.releaseDrag()})),this._pointerDragBehavior.releaseDrag()}dispose(){this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),this._lineBoundingBox.dispose(),this._rotateAnchorsParent.dispose(),this._scaleBoxesParent.dispose(),this._dragMesh&&this._dragMesh.dispose(),this._scaleBoxesDragBehaviors.length=0,this._rotateAnchorsDragBehaviors.length=0,this.onDragStartObservable.clear(),this.onHoverStartObservable.clear(),this.onHoverEndObservable.clear(),this.onScaleBoxDragObservable.clear(),this.onScaleBoxDragEndObservable.clear(),this.onRotationSphereDragObservable.clear(),this.onRotationSphereDragEndObservable.clear(),super.dispose()}static MakeNotPickableAndWrapInBoundingBox(e){const t=e=>{e.isPickable=!1,e.getChildMeshes().forEach((e=>{t(e)}))};t(e),e.rotationQuaternion||(e.rotationQuaternion=s.PT.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z));const i=e.position.clone(),r=e.rotationQuaternion.clone();e.rotationQuaternion.set(0,0,0,1),e.position.set(0,0,0);const n=(0,co.an)("box",{size:1},e.getScene()),a=e.getHierarchyBoundingVectors();return a.max.subtractToRef(a.min,n.scaling),0===n.scaling.y&&(n.scaling.y=Ee.bH),0===n.scaling.x&&(n.scaling.x=Ee.bH),0===n.scaling.z&&(n.scaling.z=Ee.bH),n.position.set((a.max.x+a.min.x)/2,(a.max.y+a.min.y)/2,(a.max.z+a.min.z)/2),e.addChild(n),e.rotationQuaternion.copyFrom(r),e.position.copyFrom(i),e.removeChild(n),n.addChild(e),n.visibility=0,n}setCustomMesh(){f.V.Error("Custom meshes are not supported on this gizmo")}}var So=i(91056),xo=i(93260);class To extends uo.Fq{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}set rotationColor(e){this._rotationShaderMaterial.setColor3("rotationColor",e)}get disableMaterial(){return this._disableMaterial}constructor(e,t=a.v9.Gray(),i=po.j.DefaultUtilityLayer,r=32,o=null,l=!1,c=1,h=a.v9.Yellow(),u=a.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new n.cP,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new s.Pq,this._parent=o,this._coloredMaterial=new Oi.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new a.v9(.1,.1,.1)),this._hoverMaterial=new Oi.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=h,this._hoverMaterial.specularColor=h,this._disableMaterial=new Oi.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=u,this._disableMaterial.alpha=.4,this._gizmoMesh=new Rt.e("",i.utilityLayerScene);const{rotationMesh:d,collider:p}=this._createGizmoMesh(this._gizmoMesh,c,r);this._rotationDisplayPlane=(0,xo.x)("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),So.M.ShadersStore.rotationGizmoVertexShader=To._RotationGizmoVertexShader,So.M.ShadersStore.rotationGizmoFragmentShader=To._RotationGizmoFragmentShader,this._rotationShaderMaterial=new ir.B("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles","rotationColor"]}),this._rotationShaderMaterial.backFaceCulling=!1,this.rotationColor=h,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,uo.Fq.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new Ie.C({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=To.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const m=new s.Pq,_=new s.uq,g=new s.Pq;let v=new s.Pq;this.dragBehavior.onDragStartObservable.add((e=>{this.attachedNode&&(m.copyFrom(e.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(_),s.Pq.TransformCoordinatesToRef(e.dragPlanePoint,_,m),this._angles.x=Math.atan2(m.y,m.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,m.copyFrom(e.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)}));const S={snapDistance:0};let x=0;const T=new s.uq,E=new s.PT;this.dragBehavior.onDragObservable.add((t=>{if(this.attachedNode){const r=new s.Pq(1,1,1),n=new s.PT(0,0,0,1),a=new s.Pq(0,0,0);if(this.attachedNode.getWorldMatrix().decompose(r,n,a),!(Math.abs(Math.abs(r.x)-Math.abs(r.y))<=Ee.bH&&Math.abs(Math.abs(r.x)-Math.abs(r.z))<=Ee.bH)&&this.updateGizmoRotationToMatchAttachedMesh)return void f.V.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");n.normalize();const o=this.updateGizmoPositionToMatchAttachedMesh?a:this._rootMesh.absolutePosition,l=t.dragPlanePoint.subtract(o).normalize(),c=m.subtract(o).normalize(),h=s.Pq.Cross(l,c),u=s.Pq.Dot(l,c);let d=Math.atan2(h.length(),u)*this.sensitivity;g.copyFrom(e),v.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(n.toRotationMatrix(_),v=s.Pq.TransformCoordinates(g,_));let p=!1;if(i.utilityLayerScene.activeCamera){const e=i.utilityLayerScene.activeCamera.position.subtract(o).normalize();s.Pq.Dot(e,v)>0&&(g.scaleInPlace(-1),v.scaleInPlace(-1),p=!0)}s.Pq.Dot(v,h)>0&&(d=-d),s.AA.Vector3[0].set(d,0,0),this.dragBehavior.validateDrag(s.AA.Vector3[0])||(d=0);let C=!1;if(0!=this.snapDistance)if(x+=d,Math.abs(x)>this.snapDistance){let e=Math.floor(Math.abs(x)/this.snapDistance);x<0&&(e*=-1),x%=this.snapDistance,d=this.snapDistance*e,C=!0}else d=0;const b=Math.sin(d/2);if(E.set(g.x*b,g.y*b,g.z*b,Math.cos(d/2)),T.determinant()>0){const e=new s.Pq;E.toEulerAnglesToRef(e),s.PT.RotationYawPitchRollToRef(e.y,-e.x,-e.z,E)}if(this.updateGizmoRotationToMatchAttachedMesh)n.multiplyToRef(E,n),n.normalize(),s.uq.ComposeToRef(r,n,a,this.attachedNode.getWorldMatrix());else{E.toRotationMatrix(s.AA.Matrix[0]);const e=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(s.AA.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(e)}m.copyFrom(t.dragPlanePoint),C&&(S.snapDistance=d,this.onSnapObservable.notifyObservers(S)),this._angles.y+=d,this.angle+=p?-d:d,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}}));const C=i._getSharedGizmoLight();C.includedOnlyMeshes=C.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const b={colliderMeshes:[p],gizmoMeshes:[d],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,b),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=To.MaxDragAngle,this._isHovered=!(-1==b.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent)){const e=b.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(b.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(b.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_createGizmoMesh(e,t,i){const r=(0,Yi.YA)("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);r.visibility=0;const n=(0,Yi.YA)("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return n.material=this._coloredMaterial,n.rotation.x=Math.PI/2,r.rotation.x=Math.PI/2,e.addChild(n,uo.Fq.PreserveScaling),e.addChild(r,uo.Fq.PreserveScaling),{rotationMesh:n,collider:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()})),super.dispose()}}To.MaxDragAngle=9*Math.PI/20,To._RotationGizmoVertexShader="\n        precision highp float;\n        attribute vec3 position;\n        attribute vec2 uv;\n        uniform mat4 worldViewProjection;\n        varying vec3 vPosition;\n        varying vec2 vUV;\n\n        void main(void) {\n            gl_Position = worldViewProjection * vec4(position, 1.0);\n            vUV = uv;\n        }",To._RotationGizmoFragmentShader="\n        precision highp float;\n        varying vec2 vUV;\n        varying vec3 vPosition;\n        uniform vec3 angles;\n        uniform vec3 rotationColor;\n\n        #define twopi 6.283185307\n\n        void main(void) {\n            vec2 uv = vUV - vec2(0.5);\n            float angle = atan(uv.y, uv.x) + 3.141592;\n            float delta = gl_FrontFacing ? angles.y : -angles.y;\n            float begin = angles.x - delta * angles.z;\n            float start = (begin < (begin + delta)) ? begin : (begin + delta);\n            float end = (begin > (begin + delta)) ? begin : (begin + delta);\n            float len = sqrt(dot(uv,uv));\n            float opacity = 1. - step(0.5, len);\n\n            float base = abs(floor(start / twopi)) * twopi;\n            start += base;\n            end += base;\n\n            float intensity = 0.;\n            for (int i = 0; i < 5; i++)\n            {\n                intensity += max(step(start, angle) - step(end, angle), 0.);\n                angle += twopi;\n            }\n            gl_FragColor = vec4(rotationColor, min(intensity * 0.25, 0.8)) * opacity;\n        }\n    ";class Eo extends uo.Fq{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}_checkBillboardTransform(){this._nodeAttached&&this._nodeAttached.billboardMode&&f.V.Log("Rotation Gizmo will not work with transforms in billboard mode.")}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t&&(t.sensitivity=e)}))}get sensitivity(){return this._sensitivity}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered}get isDragging(){return this.xGizmo.dragBehavior.dragging||this.yGizmo.dragBehavior.dragging||this.zGizmo.dragBehavior.dragging}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.additionalTransformNode=e}))}constructor(e=po.j.DefaultUtilityLayer,t=32,i=!1,r=1,o,l){super(e),this.onDragStartObservable=new n.cP,this.onDragObservable=new n.cP,this.onDragEndObservable=new n.cP,this._observables=[],this._sensitivity=1,this._gizmoAxisCache=new Map;const c=l&&l.xOptions&&l.xOptions.color?l.xOptions.color:a.v9.Red().scale(.5),h=l&&l.yOptions&&l.yOptions.color?l.yOptions.color:a.v9.Green().scale(.5),u=l&&l.zOptions&&l.zOptions.color?l.zOptions.color:a.v9.Blue().scale(.5);this.xGizmo=new To(new s.Pq(1,0,0),c,e,t,this,i,r),this.yGizmo=new To(new s.Pq(0,1,0),h,e,t,this,i,r),this.zGizmo=new To(new s.Pq(0,0,1),u,e,t,this,i,r),this.additionalTransformNode=l?.additionalTransformNode,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((e=>{l&&null!=l.updateScale&&(e.updateScale=l.updateScale),e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragObservable.add((()=>{this.onDragObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,o?o.addToAxisCache(this._gizmoAxisCache):uo.Fq.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set updateGizmoRotationToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)}get updateGizmoRotationToMatchAttachedMesh(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.yGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.zGizmo.updateGizmoPositionToMatchAttachedMesh=e)}get updateGizmoPositionToMatchAttachedMesh(){return this.xGizmo.updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.anchorPoint=e}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t.coordinatesMode=e}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)}get snapDistance(){return this.xGizmo.snapDistance}set scaleRatio(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)}get scaleRatio(){return this.xGizmo.scaleRatio}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach((t=>{t&&(t.customRotationQuaternion=e)}))}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}releaseDrag(){this.xGizmo.dragBehavior.releaseDrag(),this.yGizmo.dragBehavior.releaseDrag(),this.zGizmo.dragBehavior.releaseDrag()}dispose(){this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),super.dispose()}setCustomMesh(){f.V.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")}}class Co extends uo.Fq{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreatePlane(e,t){const i=new ui.V("plane",e),r=(0,xo.x)("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return r.material=t,r.parent=i,i}constructor(e,t=a.v9.Gray(),i=po.j.DefaultUtilityLayer,r=null,o=a.v9.Yellow(),l=a.v9.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new n.cP,this._isEnabled=!1,this._parent=null,this._dragging=!1,this._parent=r,this._coloredMaterial=new Oi.F("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new a.v9(.1,.1,.1)),this._hoverMaterial=new Oi.F("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=o,this._disableMaterial=new Oi.F("",i.utilityLayerScene),this._disableMaterial.diffuseColor=l,this._disableMaterial.alpha=.4,this._gizmoMesh=Co._CreatePlane(i.utilityLayerScene,this._coloredMaterial),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let c=0;const h=new s.Pq,u={snapDistance:0};this.dragBehavior=new Ie.C({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add((e=>{if(this.attachedNode){if(0==this.snapDistance)this.attachedNode.getWorldMatrix().getTranslationToRef(s.AA.Vector3[0]),s.AA.Vector3[0].addToRef(e.delta,s.AA.Vector3[0]),this.dragBehavior.validateDrag(s.AA.Vector3[0])&&this.attachedNode.getWorldMatrix().addTranslationFromFloats(e.delta.x,e.delta.y,e.delta.z);else if(c+=e.dragDistance,Math.abs(c)>this.snapDistance){const t=Math.floor(Math.abs(c)/this.snapDistance);c%=this.snapDistance,e.delta.normalizeToRef(h),h.scaleInPlace(this.snapDistance*t),this.attachedNode.getWorldMatrix().getTranslationToRef(s.AA.Vector3[0]),s.AA.Vector3[0].addToRef(h,s.AA.Vector3[0]),this.dragBehavior.validateDrag(s.AA.Vector3[0])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(h.x,h.y,h.z),u.snapDistance=this.snapDistance*t,this.onSnapObservable.notifyObservers(u))}this._matrixChanged()}})),this.dragBehavior.onDragStartObservable.add((()=>{this._dragging=!0})),this.dragBehavior.onDragEndObservable.add((()=>{this._dragging=!1}));const d=i._getSharedGizmoLight();d.includedOnlyMeshes=d.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const p={gizmoMeshes:this._gizmoMesh.getChildMeshes(),colliderMeshes:this._gizmoMesh.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,p),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add((e=>{if(!this._customMeshSet&&(this._isHovered=!(-1==p.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent)){const e=p.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(p.gizmoMeshes,e)}})),this.dragBehavior.onEnabledObservable.add((e=>{this._setGizmoMeshMaterial(p.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)}))}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),super.dispose(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class bo extends uo.Fq{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered||this.xPlaneGizmo.isHovered||this.yPlaneGizmo.isHovered||this.zPlaneGizmo.isHovered}get isDragging(){return this.xGizmo.dragBehavior.dragging||this.yGizmo.dragBehavior.dragging||this.zGizmo.dragBehavior.dragging||this.xPlaneGizmo.dragBehavior.dragging||this.yPlaneGizmo.dragBehavior.dragging||this.zPlaneGizmo.dragBehavior.dragging}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.additionalTransformNode=e}))}constructor(e=po.j.DefaultUtilityLayer,t=1,i,r){super(e),this._meshAttached=null,this._nodeAttached=null,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new n.cP,this.onDragObservable=new n.cP,this.onDragEndObservable=new n.cP,this._planarGizmoEnabled=!1,this.xGizmo=new lo.e(new s.Pq(1,0,0),a.v9.Red().scale(.5),e,this,t),this.yGizmo=new lo.e(new s.Pq(0,1,0),a.v9.Green().scale(.5),e,this,t),this.zGizmo=new lo.e(new s.Pq(0,0,1),a.v9.Blue().scale(.5),e,this,t),this.xPlaneGizmo=new Co(new s.Pq(1,0,0),a.v9.Red().scale(.5),this.gizmoLayer,this),this.yPlaneGizmo=new Co(new s.Pq(0,1,0),a.v9.Green().scale(.5),this.gizmoLayer,this),this.zPlaneGizmo=new Co(new s.Pq(0,0,1),a.v9.Blue().scale(.5),this.gizmoLayer,this),this.additionalTransformNode=r?.additionalTransformNode,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragObservable.add((()=>{this.onDragObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,i?i.addToAxisCache(this._gizmoAxisCache):uo.Fq.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set planarGizmoEnabled(e){this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.isEnabled=e,e&&(t.attachedMesh?t.attachedMesh=this.attachedMesh:t.attachedNode=this.attachedNode))}),this)}get planarGizmoEnabled(){return this._planarGizmoEnabled}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.customRotationQuaternion=e)}))}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.updateGizmoPositionToMatchAttachedMesh=e)}))}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.anchorPoint=e}))}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t.coordinatesMode=e}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}releaseDrag(){this.xGizmo.dragBehavior.releaseDrag(),this.yGizmo.dragBehavior.releaseDrag(),this.zGizmo.dragBehavior.releaseDrag(),this.xPlaneGizmo.dragBehavior.releaseDrag(),this.yPlaneGizmo.dragBehavior.releaseDrag(),this.zPlaneGizmo.dragBehavior.releaseDrag()}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),super.dispose()}setCustomMesh(){f.V.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")}}var Po=i(59688);class yo extends uo.Fq{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null}))}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null}))}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered||this.uniformScaleGizmo.isHovered}get isDragging(){return this.xGizmo.dragBehavior.dragging||this.yGizmo.dragBehavior.dragging||this.zGizmo.dragBehavior.dragging||this.uniformScaleGizmo.dragBehavior.dragging}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t.additionalTransformNode=e}))}constructor(e=po.j.DefaultUtilityLayer,t=1,i,r){super(e),this._meshAttached=null,this._nodeAttached=null,this._incrementalSnap=!1,this._sensitivity=1,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new n.cP,this.onDragObservable=new n.cP,this.onDragEndObservable=new n.cP,this.uniformScaleGizmo=this._createUniformScaleMesh(),this.xGizmo=new fo(new s.Pq(1,0,0),a.v9.Red().scale(.5),e,this,t),this.yGizmo=new fo(new s.Pq(0,1,0),a.v9.Green().scale(.5),e,this,t),this.zGizmo=new fo(new s.Pq(0,0,1),a.v9.Blue().scale(.5),e,this,t),this.additionalTransformNode=r?.additionalTransformNode,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e.dragBehavior.onDragStartObservable.add((()=>{this.onDragStartObservable.notifyObservers({})})),e.dragBehavior.onDragObservable.add((()=>{this.onDragObservable.notifyObservers({})})),e.dragBehavior.onDragEndObservable.add((()=>{this.onDragEndObservable.notifyObservers({})}))})),this.attachedMesh=null,this.attachedNode=null,i?i.addToAxisCache(this._gizmoAxisCache):uo.Fq.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}_createUniformScaleMesh(){this._coloredMaterial=new Oi.F("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=a.v9.Gray(),this._hoverMaterial=new Oi.F("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=a.v9.Yellow(),this._disableMaterial=new Oi.F("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=a.v9.Gray(),this._disableMaterial.alpha=.4;const e=new fo(new s.Pq(0,1,0),a.v9.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=(0,Po.D6)("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=(0,Po.D6)("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);const t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._octahedron);const i={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._octahedron,this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:e.dragBehavior};return this.addToAxisCache(e._rootMesh,i),e}set updateGizmoRotationToMatchAttachedMesh(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)}))):f.V.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.anchorPoint=e)}))}get anchorPoint(){return this._anchorPoint}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.customRotationQuaternion=e)}))}set coordinatesMode(e){0==e&&f.V.Warn("Setting coordinates Mode to world on scaling gizmo is not supported."),[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e.coordinatesMode=1}))}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.snapDistance=e)}))}get snapDistance(){return this._snapDistance}set incrementalSnap(e){this._incrementalSnap=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.incrementalSnap=e)}))}get incrementalSnap(){return this._incrementalSnap}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((t=>{t&&(t.sensitivity=e)}))}get sensitivity(){return this._sensitivity}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}getAxisCache(e){return this._gizmoAxisCache.get(e)}releaseDrag(){this.xGizmo.dragBehavior.releaseDrag(),this.yGizmo.dragBehavior.releaseDrag(),this.zGizmo.dragBehavior.releaseDrag(),this.uniformScaleGizmo.dragBehavior.releaseDrag()}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach((e=>{e&&e.dispose()})),this._observables.forEach((e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach((e=>{e&&e.dispose()})),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach((e=>{e&&e.dispose()}))}}class Ao{get keepDepthUtilityLayer(){return this._defaultKeepDepthUtilityLayer}get utilityLayer(){return this._defaultUtilityLayer}get isHovered(){let e=!1;for(const t in this.gizmos){const i=this.gizmos[t];if(i&&i.isHovered){e=!0;break}}return e}get isDragging(){let e=!1;return[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo,this.gizmos.boundingBoxGizmo].forEach((t=>{t&&t.isDragging&&(e=!0)})),e}set scaleRatio(e){this._scaleRatio=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.scaleRatio=e)}))}get scaleRatio(){return this._scaleRatio}set coordinatesMode(e){this._coordinatesMode=e,[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo].forEach((t=>{t&&(t.coordinatesMode=e)}))}get coordinatesMode(){return this._coordinatesMode}get attachedMesh(){return this._attachedMesh}get attachedNode(){return this._attachedNode}get additionalTransformNode(){return this._additionalTransformNode}constructor(e,t=1,i=po.j.DefaultUtilityLayer,r=po.j.DefaultKeepDepthUtilityLayer){this._scene=e,this.clearGizmoOnEmptyPointerEvent=!1,this.enableAutoPicking=!0,this.onAttachedToMeshObservable=new n.cP,this.onAttachedToNodeObservable=new n.cP,this._gizmosEnabled={positionGizmo:!1,rotationGizmo:!1,scaleGizmo:!1,boundingBoxGizmo:!1},this._pointerObservers=[],this._attachedMesh=null,this._attachedNode=null,this._boundingBoxColor=a.v9.FromHexString("#0984e3"),this._thickness=1,this._scaleRatio=1,this._coordinatesMode=1,this._gizmoAxisCache=new Map,this.boundingBoxDragBehavior=new Oe.Y,this.attachableMeshes=null,this.attachableNodes=null,this.usePointerToAttachGizmos=!0,this._defaultUtilityLayer=i,this._defaultKeepDepthUtilityLayer=r,this._defaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,this._thickness=t,this.gizmos={positionGizmo:null,rotationGizmo:null,scaleGizmo:null,boundingBoxGizmo:null};const s=this._attachToMeshPointerObserver(e),o=uo.Fq.GizmoAxisPointerObserver(this._defaultUtilityLayer,this._gizmoAxisCache);this._pointerObservers=[s,o]}_attachToMeshPointerObserver(e){const t=e.onPointerObservable.add((e=>{if(this.usePointerToAttachGizmos&&e.type==xe.Zp.POINTERDOWN)if(e.pickInfo&&e.pickInfo.pickedMesh){if(this.enableAutoPicking){let t=e.pickInfo.pickedMesh;if(null==this.attachableMeshes)for(;t&&null!=t.parent;)t=t.parent;else{let e=!1;this.attachableMeshes.forEach((i=>{t&&(t==i||t.isDescendantOf(i))&&(t=i,e=!0)})),e||(t=null)}t instanceof Er.u?this._attachedMesh!=t&&this.attachToMesh(t):this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}}else this.clearGizmoOnEmptyPointerEvent&&this.attachToMesh(null)}));return t}attachToMesh(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=e,this._attachedNode=null;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedMesh=e)}this.boundingBoxGizmoEnabled&&this._attachedMesh&&this._attachedMesh.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToMeshObservable.notifyObservers(e)}attachToNode(e){this._attachedMesh&&this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh=null,this._attachedNode=e;for(const t in this.gizmos){const i=this.gizmos[t];i&&this._gizmosEnabled[t]&&(i.attachedNode=e)}this.boundingBoxGizmoEnabled&&this._attachedNode&&this._attachedNode.addBehavior(this.boundingBoxDragBehavior),this.onAttachedToNodeObservable.notifyObservers(e)}set positionGizmoEnabled(e){e?(this.gizmos.positionGizmo||(this.gizmos.positionGizmo=new bo(this._defaultUtilityLayer,this._thickness,this)),this._attachedNode?this.gizmos.positionGizmo.attachedNode=this._attachedNode:this.gizmos.positionGizmo.attachedMesh=this._attachedMesh):this.gizmos.positionGizmo&&(this.gizmos.positionGizmo.attachedNode=null),this._gizmosEnabled.positionGizmo=e,this._setAdditionalTransformNode()}get positionGizmoEnabled(){return this._gizmosEnabled.positionGizmo}set rotationGizmoEnabled(e){e?(this.gizmos.rotationGizmo||(this.gizmos.rotationGizmo=new Eo(this._defaultUtilityLayer,32,!1,this._thickness,this)),this._attachedNode?this.gizmos.rotationGizmo.attachedNode=this._attachedNode:this.gizmos.rotationGizmo.attachedMesh=this._attachedMesh):this.gizmos.rotationGizmo&&(this.gizmos.rotationGizmo.attachedNode=null),this._gizmosEnabled.rotationGizmo=e,this._setAdditionalTransformNode()}get rotationGizmoEnabled(){return this._gizmosEnabled.rotationGizmo}set scaleGizmoEnabled(e){e?(this.gizmos.scaleGizmo=this.gizmos.scaleGizmo||new yo(this._defaultUtilityLayer,this._thickness,this),this._attachedNode?this.gizmos.scaleGizmo.attachedNode=this._attachedNode:this.gizmos.scaleGizmo.attachedMesh=this._attachedMesh):this.gizmos.scaleGizmo&&(this.gizmos.scaleGizmo.attachedNode=null),this._gizmosEnabled.scaleGizmo=e,this._setAdditionalTransformNode()}get scaleGizmoEnabled(){return this._gizmosEnabled.scaleGizmo}set boundingBoxGizmoEnabled(e){e?(this.gizmos.boundingBoxGizmo=this.gizmos.boundingBoxGizmo||new vo(this._boundingBoxColor,this._defaultKeepDepthUtilityLayer),this._attachedMesh?this.gizmos.boundingBoxGizmo.attachedMesh=this._attachedMesh:this.gizmos.boundingBoxGizmo.attachedNode=this._attachedNode,this._attachedMesh?(this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior),this._attachedMesh.addBehavior(this.boundingBoxDragBehavior)):this._attachedNode&&(this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this._attachedNode.addBehavior(this.boundingBoxDragBehavior))):this.gizmos.boundingBoxGizmo&&(this._attachedMesh?this._attachedMesh.removeBehavior(this.boundingBoxDragBehavior):this._attachedNode&&this._attachedNode.removeBehavior(this.boundingBoxDragBehavior),this.gizmos.boundingBoxGizmo.attachedNode=null),this._gizmosEnabled.boundingBoxGizmo=e,this._setAdditionalTransformNode()}get boundingBoxGizmoEnabled(){return this._gizmosEnabled.boundingBoxGizmo}set additionalTransformNode(e){this._additionalTransformNode=e,this._setAdditionalTransformNode()}_setAdditionalTransformNode(){for(const e in this.gizmos){const t=this.gizmos[e];t&&this._gizmosEnabled[e]&&(t.additionalTransformNode=this._additionalTransformNode)}}addToAxisCache(e){e.size>0&&e.forEach(((e,t)=>{this._gizmoAxisCache.set(t,e)}))}releaseDrag(){[this.gizmos.positionGizmo,this.gizmos.rotationGizmo,this.gizmos.scaleGizmo,this.gizmos.boundingBoxGizmo].forEach((e=>{e?.releaseDrag()}))}dispose(){this._pointerObservers.forEach((e=>{this._scene.onPointerObservable.remove(e)}));for(const e in this.gizmos){const t=this.gizmos[e];t&&t.dispose()}this._defaultKeepDepthUtilityLayer!==po.j._DefaultKeepDepthUtilityLayer&&this._defaultKeepDepthUtilityLayer?.dispose(),this._defaultUtilityLayer!==po.j._DefaultUtilityLayer&&this._defaultUtilityLayer?.dispose(),this.boundingBoxDragBehavior.detach(),this.onAttachedToMeshObservable.clear()}}var Ro=i(57069),Io=i(89962),Mo=i(90197),Oo=i(68437);function No(e,t={},i){t.diameter||(t.diameter=1),t.segments||(t.segments=16);const r=(0,Mo._6)("",{slice:.5,diameter:t.diameter,segments:t.segments},i),n=(0,Oo.WA)("",{radius:t.diameter/2,tessellation:3*t.segments+(4-t.segments)},i);n.rotation.x=-Math.PI/2,n.parent=r;const s=Rt.e.MergeMeshes([n,r],!0);return s.name=e,s}const Do={CreateHemisphere:No};Rt.e.CreateHemisphere=(e,t,i,r)=>No(e,{segments:t,diameter:i},r);var Fo=i(9212);class Lo extends uo.Fq{constructor(e=po.j.DefaultUtilityLayer){super(e),this._cachedPosition=new s.Pq,this._cachedForward=new s.Pq(0,0,1),this._pointerObserver=null,this.onClickedObservable=new n.cP,this._light=null,this.attachedMesh=new Rt.e("",this.gizmoLayer.utilityLayerScene),this._attachedMeshParent=new ui.V("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this._attachedMeshParent,this._material=new Oi.F("light",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new a.v9(.5,.5,.5),this._material.specularColor=new a.v9(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._light&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._light))}),xe.Zp.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(e){f.V.Warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(e){if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof Ro.g?this._lightMesh=Lo._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof Io.Z?this._lightMesh=Lo._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof Fo.n?this._lightMesh=Lo._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=Lo._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._lightMesh.parent=this._rootMesh;const t=this.gizmoLayer._getSharedGizmoLight();if(t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new s.PT,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction){this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0);const t=this._getMeshForward();this._cachedForward.copyFrom(t)}this._update()}}get light(){return this._light}get material(){return this._material}_getMeshForward(){let e=this.attachedMesh.forward;return this.attachedMesh.getScene().useRightHandedSystem&&(e.negateToRef(s.AA.Vector3[0]),e=s.AA.Vector3[0]),e}_update(){if(super._update(),this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position)if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{const e=this.attachedMesh.position;this._light.position=new s.Pq(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}if(this._light.direction){const e=this._getMeshForward();if(s.Pq.DistanceSquared(e,this._cachedForward)>1e-4){const t=e;this._light.direction=new s.Pq(t.x,t.y,t.z),this._cachedForward.copyFrom(e)}else s.Pq.DistanceSquared(e,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(e))}}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),super.dispose(),this._attachedMeshParent.dispose()}static _CreateHemisphericLightMesh(e){const t=new Rt.e("hemisphereLight",e),i=No(t.name,{segments:10,diameter:1},e);return i.position.z=-.15,i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(3,e).parent=t,t.scaling.scaleInPlace(Lo._Scale),t.rotation.x=Math.PI/2,t}static _CreatePointLightMesh(e){const t=new Rt.e("pointLight",e),i=(0,Mo._6)(t.name,{segments:10,diameter:1},e);return i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(5,e).parent=t,t.scaling.scaleInPlace(Lo._Scale),t.rotation.x=Math.PI/2,t}static _CreateSpotLightMesh(e){const t=new Rt.e("spotLight",e);(0,Mo._6)(t.name,{segments:10,diameter:1},e).parent=t;const i=No(t.name,{segments:10,diameter:2},e);return i.parent=t,i.rotation.x=-Math.PI/2,this._CreateLightLines(2,e).parent=t,t.scaling.scaleInPlace(Lo._Scale),t.rotation.x=Math.PI/2,t}static _CreateDirectionalLightMesh(e){const t=new Rt.e("directionalLight",e),i=new Rt.e(t.name,e);i.parent=t,(0,Mo._6)(t.name,{diameter:1.2,segments:10},e).parent=i;const r=(0,ho.zk)(t.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);r.parent=i;let n=r.clone(t.name);n.scaling.y=.5,n.position.x+=1.25;let s=r.clone(t.name);s.scaling.y=.5,s.position.x+=-1.25;const a=(0,ho.zk)(t.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return a.position.y+=3,a.parent=i,n=a.clone(t.name),n.position.y=1.5,n.position.x+=1.25,s=a.clone(t.name),s.position.y=1.5,s.position.x+=-1.25,i.scaling.scaleInPlace(Lo._Scale),i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2,t}}Lo._Scale=.007,Lo._CreateLightLines=(e,t)=>{const i=new Rt.e("root",t);i.rotation.x=Math.PI/2;const r=new Rt.e("linePivot",t);r.parent=i;const n=(0,ho.zk)("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},t);if(n.position.y=n.scaling.y/2+1.2,n.parent=r,e<2)return r;for(let e=0;e<4;e++){const t=r.clone("lineParentClone");t.rotation.z=Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}if(e<3)return i;for(let e=0;e<4;e++){const t=r.clone("linePivotClone");t.rotation.z=Math.PI/2,t.rotation.y=Math.PI/2*e}if(e<4)return i;for(let e=0;e<4;e++){const t=r.clone("linePivotClone");t.rotation.z=Math.PI+Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}return e<5||(r.clone("linePivotClone").rotation.z=Math.PI),i};var wo=i(89529);class Bo extends uo.Fq{constructor(e=po.j.DefaultUtilityLayer,t,i){super(e),this._pointerObserver=null,this.onClickedObservable=new n.cP,this._camera=null,this._invProjection=new wo.uq,this._material=new Oi.F("cameraGizmoMaterial",this.gizmoLayer.utilityLayerScene),this._frustumLinesColor=i,this._material.diffuseColor=t??new a.v9(.5,.5,.5),this._material.specularColor=new a.v9(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add((e=>{this._camera&&(this._isHovered=!(!e.pickInfo||-1==this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._camera))}),xe.Zp.POINTERDOWN)}get displayFrustum(){return this._cameraLinesMesh.isEnabled()}set displayFrustum(e){this._cameraLinesMesh.setEnabled(e)}set camera(e){if(this._camera=e,this.attachedNode=e,e){this._customMeshSet||(this._cameraMesh&&this._cameraMesh.dispose(),this._cameraMesh=Bo._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach((e=>{e.material=this._material})),this._cameraMesh.parent=this._rootMesh),this._cameraLinesMesh&&this._cameraLinesMesh.dispose();const t=this._frustumLinesColor?.toColor4(1)??new a.ov(1,1,1,1);this._cameraLinesMesh=Bo._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene,t),this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<1.5*e.maxZ&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=1.5*e.maxZ),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;const i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}}get camera(){return this._camera}get material(){return this._material}_update(){super._update(),this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=.5*Math.PI*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._cameraMesh&&this._cameraMesh.dispose(),this._cameraMesh=e,this._cameraMesh.parent=this._rootMesh,this._customMeshSet=!0}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),super.dispose()}static _CreateCameraMesh(e){const t=new Rt.e("rootCameraGizmo",e),i=new Rt.e(t.name,e);i.parent=t,(0,co.an)(t.name,{width:1,height:.8,depth:.5},e).parent=i;const r=(0,ho.zk)(t.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);r.parent=i,r.position.y=.3,r.position.x=-.6,r.rotation.x=.5*Math.PI;const n=(0,ho.zk)(t.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);n.parent=i,n.position.y=.5,n.position.x=.4,n.rotation.x=.5*Math.PI;const s=(0,ho.zk)(t.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return s.parent=i,s.position.y=0,s.position.x=.6,s.rotation.z=.5*Math.PI,t.scaling.scaleInPlace(Bo._Scale),i.position.x=-.9,t}static _CreateCameraFrustum(e,t){const i=new Rt.e("rootCameraGizmo",e),r=new Rt.e(i.name,e);r.parent=i;for(let i=0;i<4;i+=2)for(let n=0;n<4;n+=2){let a=(0,_o.sh)("lines",{points:[new s.Pq(-1+n,-1+i,-1),new s.Pq(-1+n,-1+i,1)],colors:[t,t]},e);a.parent=r,a.alwaysSelectAsActiveMesh=!0,a.isPickable=!1,a=(0,_o.sh)("lines",{points:[new s.Pq(-1,-1+n,-1+i),new s.Pq(1,-1+n,-1+i)],colors:[t,t]},e),a.parent=r,a.alwaysSelectAsActiveMesh=!0,a.isPickable=!1,a=(0,_o.sh)("lines",{points:[new s.Pq(-1+n,-1,-1+i),new s.Pq(-1+n,1,-1+i)],colors:[t,t]},e),a.parent=r,a.alwaysSelectAsActiveMesh=!0,a.isPickable=!1}return i}}Bo._Scale=.05;var Vo=i(85682);class ko extends jt.w{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,n=null,s=_e.g.BILINEAR_SAMPLINGMODE,a,o,l=0,c="",h=!1,u=5){const d="number"==typeof r?h:!!r.blockCompilation,p={uniforms:Ea.Uniforms,samplers:Ea.Samplers,size:"number"==typeof r?r:void 0,camera:n,samplingMode:s,engine:a,reusable:o,textureType:l,vertexUrl:Ea.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:u,defines:c,...r,blockCompilation:!0};super(e,Ea.FragmentUrl,{effectWrapper:"number"!=typeof r&&r.effectWrapper?void 0:new Ea(e,a,void 0,void 0,p),...p}),this._effectWrapper.options.blockCompilation=d,this.direction=t,this.onApplyObservable.add((()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height})),this.kernel=i}updateEffect(e=null,t=null,i=null,r,n,s){this._effectWrapper._updateParameters(n,s)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new ko(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1)),e,i,r)}}(0,ue.Cg)([(0,de.WM)()],ko.prototype,"direction",null),(0,ue.Cg)([(0,de.lK)()],ko.prototype,"kernel",null),(0,ue.Cg)([(0,de.lK)()],ko.prototype,"packedFloat",null),(0,o.Y5)("BABYLON.BlurPostProcess",ko);class Go extends Si.${set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,n=0,a=_e.g.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,r,!0,n,!1,a,o),this.mirrorPlane=new et.Z(0,1,0,1),this._transformMatrix=s.uq.Zero(),this._mirrorMatrix=s.uq.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;let l;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateGammaSpace()})),i.getEngine().supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeRenderObservable.add((()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),s.uq.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),l=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=s.Pq.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)})),this.onAfterRenderObservable.add((()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=l}))}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new ko("horizontal blur",new s.I9(1,0),this._blurKernelX,this._blurRatio,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new ko("vertical blur",new s.I9(0,1),this._blurKernelY,this._blurRatio,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Go(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();const e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}}_e.g._CreateMirror=(e,t,i,r)=>new Go(e,t,i,r);var Uo=i(30338),zo=i(40890),Wo=i(48248),Ho=i(4365),Yo=i(64769),Xo=i(66384),qo=i(64871);class $o extends zo.M{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class jo extends Wo.E{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=jo.StandardReflectance0*t,this.reflectionReflectance90=jo.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=jo.StandardReflectance0+(1-jo.StandardReflectance0)*t,this.reflectionReflectance90=jo.StandardReflectance90+(1-jo.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()}))))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=a.v9.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=s.Pq.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new Sr.L(16),this._reflectionControls=s.IU.Zero(),this._white=a.v9.White(),this._primaryShadowColor=a.v9.Black(),this._primaryHighlightColor=a.v9.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!(!this._diffuseTexture||!this._diffuseTexture.isRenderTarget)||!(!this._reflectionTexture||!this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,r=!1){const n=t._drawWrapper;if(n.effect&&this.isFrozen&&n._wasPreviouslyReady&&n._wasPreviouslyUsingInstances===r)return!0;t.materialDefines||(t.materialDefines=new $o);const s=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();if((0,qo.az)(s,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,(0,qo.VO)(s,a),a._areTexturesDirty){if(a._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Ho.h.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;(0,qo.YT)(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;const e=this._reflectionTexture;if(e&&Ho.h.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;switch(a.REFLECTION=!0,a.GAMMAREFLECTION=e.gammaSpace,a.RGBDREFLECTION=e.isRGBD,a.REFLECTIONBLUR=this._reflectionBlur>0,a.LODINREFLECTIONALPHA=e.lodLevelInAlpha,a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,e.coordinatesMode===_e.g.INVCUBIC_MODE&&(a.INVERTCUBICMAP=!0),a.REFLECTIONMAP_3D=e.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,e.coordinatesMode){case _e.g.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=!0;break;case _e.g.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=!0;break;case _e.g.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=!0;break;case _e.g.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=!0;break;case _e.g.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=!0;break;case _e.g.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case _e.g.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case _e.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case _e.g.CUBIC_MODE:case _e.g.INVCUBIC_MODE:default:a.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTION=!1,a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1,a.REFLECTIONMAP_3D=!1,a.REFLECTIONMAP_SPHERICAL=!1,a.REFLECTIONMAP_PLANAR=!1,a.REFLECTIONMAP_CUBIC=!1,a.REFLECTIONMAP_PROJECTION=!1,a.REFLECTIONMAP_SKYBOX=!1,a.REFLECTIONMAP_EXPLICIT=!1,a.REFLECTIONMAP_EQUIRECTANGULAR=!1,a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,a.INVERTCUBICMAP=!1,a.REFLECTIONMAP_OPPOSITEZ=!1,a.LODINREFLECTIONALPHA=!1,a.GAMMAREFLECTION=!1,a.RGBDREFLECTION=!1}a.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(a._areMiscDirty&&(a.REFLECTIONMAP_3D&&this._enableGroundProjection?(a.PROJECTED_GROUND=!0,a.REFLECTIONMAP_SKYBOX=!0):a.PROJECTED_GROUND=!1),(0,qo.fm)(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),a),(0,qo.OR)(s,o,this,a,r,null,t.getRenderingMesh().hasThinInstances),(0,qo.qB)(e,a,!1,!0,!1)&&e&&(s.getEngine().getCaps().standardDerivatives||e.isVerticesDataPresent(Ue.R.NormalKind)||(e.createNormals(!0),f.V.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name))),a.isDirty){a.markAsProcessed(),s.resetCachedMaterial();const r=new Yo.J;a.FOG&&r.addFallback(0,"FOG"),a.POINTSIZE&&r.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&r.addFallback(0,"MULTIVIEW"),(0,qo.c4)(a,r,this._maxSimultaneousLights);const n=[Ue.R.PositionKind];a.NORMAL&&n.push(Ue.R.NormalKind),a.UV1&&n.push(Ue.R.UVKind),a.UV2&&n.push(Ue.R.UV2Kind),(0,qo.ni)(n,e,a,r),(0,qo.ER)(n,a);const l=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];(0,Xo.TV)(l);const c=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],h=["Material","Scene"];Mi.p&&(Mi.p.PrepareUniforms(l,a),Mi.p.PrepareSamplers(c,a)),(0,qo.Bb)({uniformsNames:l,uniformBuffersNames:h,samplers:c,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});const u=a.toString(),d=s.getEngine().createEffect("background",{attributes:n,uniformsNames:l,uniformBuffersNames:h,samplers:c,defines:u,fallbacks:r,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,93220)),Promise.resolve().then(i.bind(i,8846))]):await Promise.all([Promise.resolve().then(i.bind(i,62841)),Promise.resolve().then(i.bind(i,91724))]),this._shadersLoaded=!0}},o);t.setEffect(d,a,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady()||(a._renderId=s.getRenderId(),n._wasPreviouslyReady=!0,n._wasPreviouslyUsingInstances=r,this._checkScenePerformancePriority(),0))}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.materialDefines;if(!n)return;const s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e),(0,qo.f$)(t,this._activeEffect);const a=this._mustRebind(r,s,i,t.visibility);if(a){this._uniformBuffer.bindToEffect(s,"Material"),this.bindViewProjection(s);const e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync&&!i._drawWrapper._forceRebindOnNextCall||(r.texturesEnabled&&(this._diffuseTexture&&Ho.h.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),(0,qo.mA)(this._diffuseTexture,this._uniformBuffer,"diffuse")),e&&Ho.h.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",e.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",e.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",e.getSize().width,e.lodGenerationScale,e.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&Ho.h.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&Ho.h.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",e):n.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",e._lodTextureMid||e),this._uniformBuffer.setTexture("reflectionSamplerLow",e._lodTextureLow||e),this._uniformBuffer.setTexture("reflectionSamplerHigh",e._lodTextureHigh||e)):this._uniformBuffer.setTexture("reflectionSampler",e),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),n.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),(0,Xo.gS)(this._activeEffect,this,r),r.bindEyePosition(s)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(s,"Material"),this._needToBindSceneUbo=!0);!a&&this.isFrozen||(r.lightsEnabled&&(0,qo.RL)(r,t,this._activeEffect,n,this._maxSimultaneousLights),this.bindView(s),(0,qo.Yy)(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&(0,qo.DL)(n,s,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return pe.p.Clone((()=>new jo(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return pe.p.Parse((()=>new jo(e.name,t)),e,t,i)}}jo.StandardReflectance0=.05,jo.StandardReflectance90=.5,(0,ue.Cg)([(0,de.jT)()],jo.prototype,"_primaryColor",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsLightsDirty")],jo.prototype,"primaryColor",void 0),(0,ue.Cg)([(0,de.jT)()],jo.prototype,"__perceptualColor",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_primaryColorShadowLevel",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_primaryColorHighlightLevel",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsLightsDirty")],jo.prototype,"primaryColorHighlightLevel",null),(0,ue.Cg)([(0,de.uM)()],jo.prototype,"_reflectionTexture",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionTexture",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_reflectionBlur",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionBlur",void 0),(0,ue.Cg)([(0,de.uM)()],jo.prototype,"_diffuseTexture",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"diffuseTexture",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"shadowLights",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_shadowLevel",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"shadowLevel",void 0),(0,ue.Cg)([(0,de.P_)()],jo.prototype,"_sceneCenter",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"sceneCenter",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_opacityFresnel",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"opacityFresnel",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_reflectionFresnel",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionFresnel",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_reflectionFalloffDistance",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionFalloffDistance",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_reflectionAmount",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionAmount",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_reflectionReflectance0",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionReflectance0",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_reflectionReflectance90",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"reflectionReflectance90",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_useRGBColor",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"useRGBColor",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_enableNoise",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"enableNoise",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_maxSimultaneousLights",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],jo.prototype,"maxSimultaneousLights",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"_shadowOnly",void 0),(0,ue.Cg)([(0,de.$z)("_markAllSubMeshesAsLightsDirty")],jo.prototype,"shadowOnly",void 0),(0,ue.Cg)([(0,de.n1)()],jo.prototype,"_imageProcessingConfiguration",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsMiscDirty")],jo.prototype,"enableGroundProjection",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"projectedGroundRadius",void 0),(0,ue.Cg)([(0,de.lK)()],jo.prototype,"projectedGroundHeight",void 0),(0,o.Y5)("BABYLON.BackgroundMaterial",jo);class Ko{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new a.v9(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new a.v9(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:s.Pq.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(e,t)=>{this.onErrorObservable.notifyObservers({message:e,exception:t})},this._options={...Ko._GetDefaultOptions(t),...e},this._scene=t,this.onErrorObservable=new n.cP,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new a.ov(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof Vo.t)return void(this._scene.environmentTexture=this._options.environmentTexture);const e=Uo.b.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new Rt.e("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:i};const r=this._scene.getWorldExtends((e=>e!==this._ground&&e!==this._rootMesh&&e!==this._skybox)),n=r.max.subtract(r.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof It&&this._scene.activeCamera.upperRadiusLimit&&(e=2*this._scene.activeCamera.upperRadiusLimit,t=e);const s=n.length();s>e&&(e=2*s,t=e),e*=1.1,t*=1.5,i=r.min.add(n.scale(.5)),i.y=r.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){this._ground&&!this._ground.isDisposed()||(this._ground=(0,xo.x)("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add((()=>{this._ground=null}))),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new jo("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){this._groundMaterial&&(this._groundTexture||(this._options.groundTexture instanceof Vo.t?this._groundMaterial.diffuseTexture=this._options.groundTexture:(this._groundTexture=new _e.g(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture)))}_setupGroundMirrorTexture(e){const t=_e.g.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Go("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,_e.g.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new et.Z(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let e=0;e<this._scene.meshes.length;e++){const t=this._scene.meshes[e];t!==this._ground&&t!==this._skybox&&t!==this._rootMesh&&this._groundMirror.renderList.push(t)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new a.ov(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){this._skybox&&!this._skybox.isDisposed()||(this._skybox=(0,co.an)("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:Rt.e.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add((()=>{this._skybox=null}))),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new jo("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){this._skyboxMaterial&&(this._skyboxTexture||(this._options.skyboxTexture instanceof Vo.t?this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture:(this._skyboxTexture=new Uo.b(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=_e.g.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture)))}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}Ko._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",Ko._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",Ko._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class Zo extends ui.V{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=_e.g.CLAMP_ADDRESSMODE,this._texture.wrapV=_e.g.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=_e.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=_e.g.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,r,a=null){super(e,r),this.onError=a,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=Zo.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new n.cP,this.onLoadObservable=new n.cP,r=this.getScene(),e=e||"textureDome",i.resolution=0|Math.abs(i.resolution)||32,i.clickToPlay=Boolean(i.clickToPlay),i.autoPlay=void 0===i.autoPlay||Boolean(i.autoPlay),i.loop=void 0===i.loop||Boolean(i.loop),i.size=Math.abs(i.size)||(r.activeCamera?.48*r.activeCamera.maxZ:1e3),void 0===i.useDirectMapping?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,void 0===i.faceForward&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=(0,Mo._6)(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:Rt.e.BACKSIDE},r);const o=this._material=new jo(e+"_material",r);o.useEquirectangularFOV=!0,o.fovMultiplier=1,o.opacityFresnel=!1;const l=this._initTexture(t,r,i);if(this.texture=l,this._mesh.material=o,this._mesh.parent=this,this._halfDomeMask=(0,Mo._6)("",{slice:.5,diameter:.98*i.size,segments:2*i.resolution,sideOrientation:Rt.e.BACKSIDE},r),this._halfDomeMask.rotate(wo._0.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce((()=>{this._setReady(!0)})),i.faceForward&&r.activeCamera){const e=r.activeCamera,t=s.Pq.Forward(),i=s.Pq.TransformNormal(t,e.getViewMatrix());i.normalize(),this.rotation.y=Math.acos(s.Pq.Dot(t,i))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case Zo.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case Zo.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const e=this._halfDome?0:.5,t=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add((i=>{let r=i.isRightCamera;this._crossEye&&(r=!r),this._texture.uOffset=r?e:t}));break}case Zo.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add((e=>{let t=e.isRightCamera;this._crossEye&&(t=!t),this._texture.vOffset=t?.5:0}))}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}Zo.MODE_MONOSCOPIC=0,Zo.MODE_TOPBOTTOM=1,Zo.MODE_SIDEBYSIDE=2;class Qo extends Zo{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new _e.g(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,(()=>{this.onLoadObservable.notifyObservers()}),((e,t)=>{this.onLoadErrorObservable.notifyObservers(e||"Unknown error occured"),this.onError&&this.onError(e,t)}))}}Qo.MODE_MONOSCOPIC=Zo.MODE_MONOSCOPIC,Qo.MODE_TOPBOTTOM=Zo.MODE_TOPBOTTOM,Qo.MODE_SIDEBYSIDE=Zo.MODE_SIDEBYSIDE;var Jo=i(13979),el=i(62158),tl=i(53508),il=i(20234);class rl extends Pt.S{constructor(e,t,i){super(e,s.Pq.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=s.PT.Identity(),this._referencedPosition=new s.Pq,this._trackingState=0,this.onXRCameraInitializedObservable=new n.cP,this.onBeforeCameraTeleport=new n.cP,this.onAfterCameraTeleport=new n.cP,this.onTrackingStateChanged=new n.cP,this.compensateOnFirstFrame=!0,this._rotate180=new s.PT(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new s.PT,this.cameraRigMode=Ct.i.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add((()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add((()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()}))})),this._xrSessionManager.onXRFrameObservable.add((()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()}),void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new ii.L(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new ii.L(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){e&&e!==this&&(e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,s.PT.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace())}getClassName(){return"WebXRCamera"}setTarget(e){const t=s.AA.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),s.PT.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0,this.onTrackingStateChanged.clear()}_updateDepthNearFar(){const e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e)return void this._setTrackingState(0);const t=e.emulatedPosition?1:2;if(this._setTrackingState(t),this.minZ===this._cache.minZ&&this.maxZ===this._cache.maxZ||this._updateDepthNearFar(),e.transform){const t=e.transform.orientation;if(void 0===e.transform.orientation.x)return;const i=e.transform.position;this._referencedPosition.set(i.x,i.y,i.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach(((e,t)=>{const i=this.rigCameras[t];i.isLeftCamera||i.isRightCamera||("right"===e.eye?i._isRightCamera=!0:"left"===e.eye&&(i._isLeftCamera=!0));const r=this.getScene().customRenderTargets;for(let e=0;e<r.length;e++){const t=r[e];-1===i.customRenderTargets.indexOf(t)&&i.customRenderTargets.push(t)}const n=e.transform.position,a=e.transform.orientation;i.parent=this.parent,i.position.set(n.x,n.y,n.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),i.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem?i.rotationQuaternion.multiplyInPlace(this._rotate180):(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1),s.uq.FromFloat32ArrayToRefScaled(e.projectionMatrix,0,1,i._projectionMatrix),this._scene.useRightHandedSystem||i._projectionMatrix.toggleProjectionMatrixHandInPlace();const o=2*Math.atan2(1,e.projectionMatrix[5]);i.fov=o,0===t&&(this.fov=o,this._projectionMatrix.copyFrom(i._projectionMatrix));const l=this._xrSessionManager.getRenderTargetTextureForView(e);this._renderingMultiview=l?._texture?.isMultiview||!1,this._renderingMultiview?0==t&&(this._xrSessionManager.trySetViewportForView(this.viewport,e),this.outputRenderTarget=l):(this._xrSessionManager.trySetViewportForView(i.viewport,e),i.outputRenderTarget=l||this._xrSessionManager.getRenderTargetTextureForView(e)),i.layerMask=this.layerMask}))}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const e=new bt.F("XR-RigCamera: "+this.rigCameras.length,s.Pq.Zero(),this.getScene());e.minZ=.1,e.rotationQuaternion=new s.PT,e.updateUpVectorFromRotation=!0,e.isRigCamera=!0,e.rigParent=this,e.freezeProjectionMatrix(),this.rigCameras.push(e)}for(;this.rigCameras.length>e;){const e=this.rigCameras.pop();e&&e.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=s.AA.Matrix[0],t=s.AA.Matrix[1],i=s.AA.Matrix[2];s.uq.ComposeToRef(rl._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),s.uq.ComposeToRef(rl._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}}rl._ScaleReadOnly=s.Pq.One();var nl=i(39653);class sl{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new n.cP,this.onStateChangedObservable=new n.cP,this.state=3,this.sessionManager=new Wi(e),this.camera=new rl("webxr",e,this.sessionManager),this.featuresManager=new nl.n(this.sessionManager),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}static CreateAsync(e){const t=new sl(e);return t.sessionManager.initializeAsync().then((()=>(t._supported=!0,t))).catch((e=>{throw t._setState(3),t.dispose(),e}))}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),"viewer"!==t&&"local"!==t&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=await this.featuresManager._extendXRSessionInitObject(r),"immersive-ar"===e&&"unbounded"!==t&&f.V.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,r),await this.sessionManager.setReferenceSpaceTypeAsync(t);const n={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(nl._.LAYERS)){const e=await i.initializeXRLayerAsync(this.sessionManager.session);n.baseLayer=e}return this.sessionManager.updateRenderState(n),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,"immersive-ar"!==e?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),ne.$.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce((()=>{1!==this.state&&this._setState(1),this.camera.rigCameras.forEach((e=>{e.outputRenderTarget=null})),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)})),this.sessionManager.onXRFrameObservable.addOnce((()=>{this._setState(2)})),this.sessionManager}catch(e){throw f.V.Log(e),f.V.Log(e.message),this._setState(3),e}}exitXRAsync(){return 2!==this.state?Promise.resolve():(this._setState(1),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const t=1/(e?.fps?e.fps:1e3)*1e3,i=e?.preferredCameraIndex?e?.preferredCameraIndex:0,r=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=t&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[i].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[i].absoluteRotation))};if(this._spectatorMode){if(i>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const e=()=>{2===this.state?(this._spectatorCamera=new Xt("webxr-spectator",s.Pq.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new s.PT,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(r),this._scene.onAfterRenderCameraObservable.add((e=>{e===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)}))):1===this.state&&(this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=null)};this.onStateChangedObservable.add(e),e()}else this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class al{constructor(e,t,i=-1,r=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new n.cP,this.onButtonStateChangedObservable=new n.cP}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return-1!==this._buttonIndex}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const i=e.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},t=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},t=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},t=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}al.BUTTON_TYPE="button",al.SQUEEZE_TYPE="squeeze",al.THUMBSTICK_TYPE="thumbstick",al.TOUCHPAD_TYPE="touchpad",al.TRIGGER_TYPE="trigger";var ol=i(10111);class ll{constructor(e,t,i,r,s=!1,a){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=s,this._controllerCache=a,this._initComponent=e=>{if(!e)return;const t=this.layout.components[e],i=t.type,r=t.gamepadIndices.button,n=[];void 0!==t.gamepadIndices.xAxis&&void 0!==t.gamepadIndices.yAxis&&n.push(t.gamepadIndices.xAxis,t.gamepadIndices.yAxis),this.components[e]=new al(e,i,r,n)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new n.cP,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach((e=>this.getComponent(e).dispose())),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach((e=>{e.setEnabled(!1)})),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache)),this.onModelLoadedObservable.clear()}getAllComponentsOfType(e){return this.getComponentIds().map((e=>this.components[e])).filter((t=>t.type===e))}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?f.V.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise(((i,r)=>{const n=t=>{e?this._getGenericParentMesh(t):this._setRootMesh(t),this._processLoadedModel(t),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const e=this._controllerCache.filter((e=>e.filename===t.filename&&e.path===t.path));if(e[0])return e[0].meshes.forEach((e=>e.setEnabled(!0))),void n(e[0].meshes)}ol.cn.ImportMesh("",t.path,t.filename,this.scene,(e=>{this._controllerCache&&this._controllerCache.push({...t,meshes:e}),n(e)}),null,((e,i)=>{f.V.Log(i),f.V.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(i)}))}))}updateFromXRFrame(e){this.getComponentIds().forEach((e=>this.getComponent(e).update(this.gamepadObject))),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren((e=>e.name===t),!1)[0]}_getImmediateChildByName(e,t){return e.getChildren((e=>e.name==t),!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh)return;if(!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const r=i?.5*t+.5:t;s.PT.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),s.Pq.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new Rt.e(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.parent||(e.isPickable=!1,e.setParent(this.rootMesh))})),this.rootMesh.rotationQuaternion=s.PT.FromEulerAngles(0,Math.PI,0)}}class cl extends ll{constructor(e,t,i){super(e,hl[i],t,i),this.profileId=cl.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new Rt.e(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1,e.parent||e.setParent(this.rootMesh)})),this.rootMesh.rotationQuaternion=s.PT.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}cl.ProfileId="generic-trigger";const hl={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class ul extends ll{constructor(e,t,i,r,n){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,n),this._repositoryUrl=r,this.controllerCache=n,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach((e=>{this._touchDots[e].dispose()}))}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=ol.cn.IsPluginForExtensionAvailable(".glb");return e||f.V.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=this.layout.components[e];this._buttonMeshMapping[e]={mainMesh:this._getChildByName(this.rootMesh,t.rootNodeName),states:{}},Object.keys(t.visualResponses).forEach((i=>{const r=t.visualResponses[i];if("transform"===r.valueNodeProperty)this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,r.valueNodeName),minMesh:this._getChildByName(this.rootMesh,r.minNodeName),maxMesh:this._getChildByName(this.rootMesh,r.maxNodeName)};else{const n=t.type===al.TOUCHPAD_TYPE&&t.touchPointNodeName?t.touchPointNodeName:r.valueNodeName;if(this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,n)},t.type===al.TOUCHPAD_TYPE&&!this._touchDots[i]){const t=(0,Mo._6)(i+"dot",{diameter:.0015,segments:8},this.scene);t.material=new Oi.F(i+"mat",this.scene),t.material.diffuseColor=a.v9.Red(),t.parent=this._buttonMeshMapping[e].states[i].valueMesh||null,t.isVisible=!1,this._touchDots[i]=t}}}))}))}_setRootMesh(e){let t;this.rootMesh=new Rt.e(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(ke._0.Y,Math.PI,1)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach((e=>{const t=this.getComponent(e);if(!t.hasChanges)return;const i=this._buttonMeshMapping[e],r=this.layout.components[e];Object.keys(r.visualResponses).forEach((e=>{const n=r.visualResponses[e];let s=t.value;if("xAxis"===n.componentProperty?s=t.axes.x:"yAxis"===n.componentProperty&&(s=t.axes.y),"transform"===n.valueNodeProperty)this._lerpTransform(i.states[e],s,"button"!==n.componentProperty);else{const r=i.states[e].valueMesh;r&&(r.isVisible=t.touched||t.pressed),this._touchDots[e]&&(this._touchDots[e].isVisible=t.touched||t.pressed)}}))}))}}const dl=[];class pl{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const r=[];i&&r.push(i),r.push(...e.profiles||[]),r.length&&!r[0]&&r.pop(),e.gamepad&&e.gamepad.id&&e.gamepad.id===(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0)&&r.push("oculus-touch-v2");const n=r.indexOf("windows-mixed-reality");if(-1!==n&&r.splice(n,0,"microsoft-mixed-reality"),r.length||r.push("generic-trigger"),this.UseOnlineRepository){const i=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,n=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return i.call(this,r,e,t).catch((()=>n.call(this,r,e,t)))}return this._LoadProfilesFromAvailableControllers(r,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=re.S0.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then((e=>JSON.parse(e))),this._ProfilesList}static ClearControllerCache(){dl.forEach((e=>{e.meshes.forEach((e=>{e.dispose(!1,!0)}))})),dl.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then((()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList())).then((t=>{for(let i=0;i<e.length;++i)if(e[i]&&t[e[i]])return e[i];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)})).then((e=>(this._ProfileLoadingPromises[e]||(this._ProfileLoadingPromises[e]=re.S0.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${e}/profile.json`,!1).then((e=>JSON.parse(e)))),this._ProfileLoadingPromises[e]))).then((e=>new ul(i,t,e,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:dl)))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let r=0;r<e.length;++r){if(!e[r])continue;const n=this.FindFallbackWithProfileId(e[r]);for(let e=0;e<n.length;++e){const r=this._AvailableControllers[n[e]];if(r)return Promise.resolve(r(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}pl._AvailableControllers={},pl._Fallbacks={},pl._ProfileLoadingPromises={},pl.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",pl.PrioritizeOnlineRepository=!0,pl.UseOnlineRepository=!0,pl.DisableControllerCache=!0,pl.RegisterController(cl.ProfileId,((e,t)=>new cl(t,e.gamepad,e.handedness))),pl.DefaultFallbacks();let fl=0;class ml{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new s.Pq,this._disposed=!1,this.onDisposeObservable=new n.cP,this.onMeshLoadedObservable=new n.cP,this.onMotionControllerInitObservable=new n.cP,this._uniqueId=`controller-${fl++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new Rt.e(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new s.PT,this.inputSource.gripSpace&&(this.grip=new Rt.e(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new s.PT),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&pl.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then((e=>{this.motionController=e,this.onMotionControllerInitObservable.notifyObservers(e),this._options.doNotLoadControllerMesh||this.motionController._doNotLoadControllerMesh||this.motionController.loadModel().then((e=>{e&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach((e=>e.renderingGroupId=this._options.renderingGroupId))),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&this.motionController?.dispose()}))}),(()=>{re.S0.Warn("Could not find a matching motion controller for the registered input source")}))}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;s.Pq.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){const n=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=n,n){const e=n.transform.position;this.pointer.position.set(e.x,e.y,e.z).scaleInPlace(r.worldScalingFactor);const t=n.transform.orientation;this.pointer.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){const n=e.getPose(this.inputSource.gripSpace,t);if(n){const e=n.transform.position,t=n.transform.orientation;this.grip.position.set(e.x,e.y,e.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}}class _l{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new n.cP,this.onControllerRemovedObservable=new n.cP,this._onInputSourcesChange=e=>{this._addAndRemoveControllers(e.added,e.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add((()=>{this._addAndRemoveControllers([],this.controllers.map((e=>e.inputSource)))})),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add((e=>{e.addEventListener("inputsourceschange",this._onInputSourcesChange)})),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add((e=>{this.controllers.forEach((t=>{t.updateFromXRFrame(e,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)}))})),this._options.customControllersRepositoryURL&&(pl.BaseRepositoryUrl=this._options.customControllersRepositoryURL),pl.UseOnlineRepository=!this._options.disableOnlineControllerRepository,pl.UseOnlineRepository)try{pl.UpdateProfilesList().catch((()=>{pl.UseOnlineRepository=!1}))}catch(e){pl.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map((e=>e.inputSource));for(const t of e)if(-1===i.indexOf(t)){const e=new ml(this.xrSessionManager.scene,t,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(e),this.onControllerAddedObservable.notifyObservers(e)}const r=[],n=[];this.controllers.forEach((e=>{-1===t.indexOf(e.inputSource)?r.push(e):n.push(e)})),this.controllers=r,n.forEach((e=>{this.onControllerRemovedObservable.notifyObservers(e),e.dispose()}))}dispose(){this.controllers.forEach((e=>{e.dispose()})),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),pl.ClearControllerCache()}}class gl{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&-1===this._xrSessionManager.enabledFeatures?.indexOf(e)&&f.V.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new n.cP,this.onFeatureDetachObservable=new n.cP}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(this._xrSessionManager.enabledFeatures){if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&-1===this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName))return!1}else f.V.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,(e=>this._onXRFrame(e))),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach((e=>{e.observable.remove(e.observer)})),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}}class vl extends gl{constructor(e,t){super(e),this._options=t,this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&e.grip?e.grip:e.pointer);switch(this._controllers[e.uniqueId]={xrController:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new Ii.Rl(new s.Pq,new s.Pq),disabledByNearInteraction:!1,id:vl._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(e);case"gaze":return this._attachGazeMode(e);case"screen":case"transient-pointer":return this._attachScreenRayMode(e)}},this._controllers={},this._tmpVectorForPickCompare=new s.Pq,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new a.v9(.9,.9,.9),this.laserPointerDefaultColor=new a.v9(.7,.7,.7),this.selectionMeshDefaultColor=new a.v9(.8,.8,.8),this.selectionMeshPickedColor=new a.v9(.3,.3,1),this._identityMatrix=s.uq.Identity(),this._screenCoordinatesRef=s.Pq.Zero(),this._viewportRef=new ii.L(0,0,0,0),this._scene=this._xrSessionManager.scene,void 0===this._options.lookAndPickMode&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)}),!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new Ii.Rl(new s.Pq,new s.Pq),disabledByNearInteraction:!1,id:vl._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e)return void(this._controllers[i[r]].disabledByNearInteraction=t)}_onXRFrame(e){Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];if(this._options.lookAndPickMode&&"transient-pointer"!==t.xrController?.inputSource.targetRayMode)return;if(!this._options.enablePointerSelectionOnAllControllers&&e!==this._attachedController||t.disabledByNearInteraction)return t.selectionMesh.isVisible=!1,t.laserPointer.isVisible=!1,void(t.pick=null);let i;if(t.laserPointer.isVisible=this.displayLaserPointer,t.xrController)i=this._options.forceGripIfAvailable&&t.xrController.grip?t.xrController.grip.position:t.xrController.pointer.position,t.xrController.getWorldPointerRayToRef(t.tmpRay,this._options.forceGripIfAvailable);else{if(!t.webXRCamera)return;i=t.webXRCamera.position,t.webXRCamera.getForwardRayToRef(t.tmpRay)}if(this._options.maxPointerDistance&&(t.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&i){const e=this._xrSessionManager.scene,r=this._options.xrInput.xrCamera;r&&(r.viewport.toGlobalToRef(e.getEngine().getRenderWidth()/r.rigCameras.length,e.getEngine().getRenderHeight(),this._viewportRef),s.Pq.ProjectToRef(i,this._identityMatrix,r.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"!=typeof this._screenCoordinatesRef.x||"number"!=typeof this._screenCoordinatesRef.y||isNaN(this._screenCoordinatesRef.x)||isNaN(this._screenCoordinatesRef.y)||this._screenCoordinatesRef.x===1/0||this._screenCoordinatesRef.y===1/0||(e.pointerX=this._screenCoordinatesRef.x,e.pointerY=this._screenCoordinatesRef.y,t.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let r=null;this._utilityLayerScene&&(r=this._utilityLayerScene.pickWithRay(t.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const n=this._scene.pickWithRay(t.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);r&&r.hit?n&&n.hit?r.distance<n.distance?t.pick=r:t.pick=n:t.pick=r:t.pick=n,t.pick&&t.xrController&&(t.pick.aimTransform=t.xrController.pointer,t.pick.gripTransform=t.xrController.grip||null,t.pick.originMesh=t.xrController.pointer);const a=t.pick;if(a&&a.pickedPoint&&a.hit){this._updatePointerDistance(t.laserPointer,a.distance),t.selectionMesh.position.copyFrom(a.pickedPoint),t.selectionMesh.scaling.x=Math.sqrt(a.distance),t.selectionMesh.scaling.y=Math.sqrt(a.distance),t.selectionMesh.scaling.z=Math.sqrt(a.distance);const e=this._convertNormalToDirectionOfRay(a.getNormal(!0),t.tmpRay),i=.001;if(t.selectionMesh.position.copyFrom(a.pickedPoint),e){const r=s.Pq.Cross(ke._0.Y,e),n=s.Pq.Cross(e,r);s.Pq.RotationFromAxisToRef(n,e,r,t.selectionMesh.rotation),t.selectionMesh.position.addInPlace(e.scale(i))}t.selectionMesh.isVisible=this.displaySelectionMesh,t.meshUnderPointer=a.pickedMesh}else t.selectionMesh.isVisible=!1,this._updatePointerDistance(t.laserPointer,1),t.meshUnderPointer=null}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let n=new Ji.G;const s=(0,Yi.YA)("selection",{diameter:.0525,thickness:.015,tessellation:20},r);s.isVisible=!1,s.isPickable=!1,s.parent=t.selectionMesh;let a=0,o=!1;const l={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{if(t.pick){if(this._augmentPointerInit(l,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,s.isVisible=!1,t.pick.hit)if(this._pickingMoved(n,t.pick))o&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,l)),o=!1,a=0;else if(a>i/10&&(s.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=i)this._scene.simulatePointerDown(t.pick,l),o=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),s.isVisible=!1;else{const e=1-a/i;s.scaling.set(e,e,e)}else o=!1,a=0;this._scene.simulatePointerMove(t.pick,l),n=t.pick}})),void 0!==this._options.renderingGroupId&&(s.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce((()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&o&&(this._scene.simulatePointerUp(t.pick,l),t.finalPointerUpTriggered=!0),s.dispose()}))}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!t.pick||this._options.disablePointerUpOnTouchOut&&i||(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))})),e.onDisposeObservable.addOnce((()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame((()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)}))}))}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))})),e.inputSource.gamepad){const r=r=>{this._options.overrideButtonId&&(t.selectionComponent=r.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=r.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((r=>{if(r.changes.pressed){const n=r.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),n?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(n&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){const t=this._controllers[this._attachedController];t&&t.pointerDownTriggered&&!t.finalPointerUpTriggered&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(new Ji.G,{pointerId:t.id,pointerType:"xr"}),t.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}}))};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{const e=e=>{this._xrSessionManager.onXRFrameObservable.addOnce((()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)}))},r=e=>{this._xrSessionManager.onXRFrameObservable.addOnce((()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)}))};t.eventListeners={selectend:r,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",r)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(s.Pq.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const e={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame((()=>{this._augmentPointerInit(e,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new Ji.G,e),t.finalPointerUpTriggered=!0}))}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce((()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}catch(e){re.S0.Warn("controller already detached.")}}))}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():(0,ho.zk)("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const r=new Oi.F("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const n=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():(0,Yi.YA)("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);n.bakeCurrentTransformIntoVertices(),n.isPickable=!1,n.isVisible=!1;const s=new Oi.F("targetMat",t);return s.specularColor=a.v9.Black(),s.emissiveColor=this.selectionMeshDefaultColor,s.backFaceCulling=!1,n.material=s,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:n}}_pickingMoved(e,t){if(!e.hit||!t.hit)return!0;if(!(e.pickedMesh&&e.pickedPoint&&t.pickedMesh&&t.pickedPoint))return!0;if(e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const i=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}var Sl,xl,Tl,El;vl._IdCounter=200,vl.Name=nl._.POINTER_SELECTION,vl.Version=1,nl.n.AddWebXRFeature(vl.Name,((e,t)=>()=>new vl(e,t)),vl.Version,!0),function(e){e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Color3=32]="Color3",e[e.Color4=64]="Color4",e[e.Matrix=128]="Matrix",e[e.Object=256]="Object",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.All=4095]="All"}(Sl||(Sl={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Neutral=4]="Neutral",e[e.VertexAndFragment=3]="VertexAndFragment"}(xl||(xl={}));class Cl{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return 1===this.shaderLanguage?"f":""}finalize(e){const t=e.sharedData.emitComments,i=this.target===xl.Fragment;1===this.shaderLanguage?this.compilationString=i?`\n${t?"//Entry point\n":""}@fragment\nfn main(input: FragmentInputs) -> FragmentOutputs {\n${this.compilationString}`:`\n${t?"//Entry point\n":""}@vertex\nfn main(input: VertexInputs) -> FragmentInputs{\n${this.compilationString}`:this.compilationString=`\n${t?"//Entry point\n":""}void main(void) {\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\n${t?"//Constants\n":""}${this._constantDeclaration}\n${this.compilationString}`);let r="";for(const e in this.functions)r+=this.functions[e]+"\n";if(this.compilationString=`\n${r}\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\n${t?"//Varyings\n":""}${this.sharedData.varyingDeclaration}\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\n${t?"//Samplers\n":""}${this._samplerDeclaration}\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\n${t?"//Uniforms\n":""}${this._uniformDeclaration}\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\n${t?"//Attributes\n":""}${this._attributeDeclaration}\n${this.compilationString}`),1!==this.shaderLanguage){this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defined(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString);for(const e in this.extensions){const t=this.extensions[e];this.compilationString=`\n${t}\n${this.compilationString}`}}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}\n`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;\n`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;\n`):this._samplerDeclaration+=`uniform sampler2D ${e};\n`,t&&(this._samplerDeclaration+="#endif\n"),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}\n`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;\n`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;\n`):this._samplerDeclaration+=`uniform samplerCube ${e};\n`,t&&(this._samplerDeclaration+="#endif\n"),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\n`,this.samplers.push(e))}_getGLType(e){switch(e){case Sl.Float:return"float";case Sl.Int:return"int";case Sl.Vector2:return"vec2";case Sl.Color3:case Sl.Vector3:return"vec3";case Sl.Color4:case Sl.Vector4:return"vec4";case Sl.Matrix:return"mat4"}return""}_getShaderType(e){const t=1===this.shaderLanguage;switch(e){case Sl.Float:return t?"f32":"float";case Sl.Int:return t?"i32":"int";case Sl.Vector2:return t?"vec2f":"vec2";case Sl.Color3:case Sl.Vector3:return t?"vec3f":"vec3";case Sl.Color4:case Sl.Vector4:return t?"vec4f":"vec4";case Sl.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\n${t}\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){const r=ri.l.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`;let n=r[e]+"\n";if(this.sharedData.emitComments&&(n=t+"\n"+n),!i)return n;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];n=n.replace(t.search,t.replace)}return n}_emitFunctionFromInclude(e,t,i,r=""){const n=e+r;if(this.functions[n])return;const s=ri.l.GetIncludesShadersStore(this.shaderLanguage);if(!i||!(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings))return i&&i.repeatKey?this.functions[n]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`:this.functions[n]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}\n`,void(this.sharedData.emitComments&&(this.functions[n]=t+"\n"+this.functions[n]));if(this.functions[n]=s[e],this.sharedData.emitComments&&(this.functions[n]=t+"\n"+this.functions[n]),i.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[n]=this.functions[n].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[n]=this.functions[n].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[n]=this.functions[n].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];this.functions[n]=this.functions[n].replace(t.search,t.replace)}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){if(-1!==this.sharedData.varyings.indexOf(e))return!1;this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\n`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\n`);const n=this._getShaderType(t);return 1===this.shaderLanguage?this.sharedData.varyingDeclaration+=`varying ${e}: ${n};\n`:this.sharedData.varyingDeclaration+=`varying ${n} ${e};\n`,i&&(this.sharedData.varyingDeclaration+="#endif\n"),!0}_getVaryingName(e){return 1===this.shaderLanguage?(this.target!==xl.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(-1!==this.uniforms.indexOf(e))return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\n`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\n`);const n=this._getShaderType(t);1===this.shaderLanguage?this._uniformDeclaration+=`uniform ${e}: ${n};\n`:this._uniformDeclaration+=`uniform ${n} ${e};\n`,i&&(this._uniformDeclaration+="#endif\n")}_generateTernary(e,t,i){return 1===this.shaderLanguage?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return 1===this.shaderLanguage?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return 1===this.shaderLanguage?"textureSample":"textureCube"}_samplerFunc(){return 1===this.shaderLanguage?"textureSample":"texture2D"}_samplerLODFunc(){return 1===this.shaderLanguage?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return 1!==this.shaderLanguage||e.type!==Sl.Color3&&e.type!==Sl.Vector3?`toLinearSpace(${e.associatedVariableName})`:`toLinearSpaceVec3(${e.associatedVariableName})`}_generateTextureSample(e,t){return 1===this.shaderLanguage?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),((e,t,i,r)=>`select(${r}, ${i}, ${t})`))}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),((e,t,i)=>`((${t})%(${i}))`))}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){const t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;let i;for(;null!==(i=t.exec(e));){const t=i[1],r=i[2],n=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${t}(${n}) -> ${r}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=(e=this._convertOutParametersToWGSL(e)).replace(/\[\*\]/g,"*"),(e=(e=(e=this._convertFunctionsToWGSL(e)).replace(/\s->\svoidnull/g,"")).replace(/dFdx/g,"dpdx")).replace(/dFdy/g,"dpdy")}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),((e,t,i,r)=>`${t} ? ${i} : ${r}`))}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),this._convertTernaryOperandsToGLSL(e)}}class bl{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(e=null){let t="";this.checks.emitVertex||this.allowEmptyVertexProgram||(t+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.\n"),this.checks.emitFragment||(t+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.\n");for(const e of this.checks.notConnectedNonOptionalInputs)t+=`input ${e.name} from block ${e.ownerBlock.name}[${e.ownerBlock.getClassName()}] is not connected and is not optional.\n`;return!t||(e&&e.notifyObservers(t),f.V.Error("Build of NodeMaterial failed:\n"+t),!1)}}!function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.TargetIncompatible=2]="TargetIncompatible",e[e.HierarchyIssue=3]="HierarchyIssue"}(Tl||(Tl={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(El||(El={}));class Pl{static AreEquivalentTypes(e,t){switch(e){case Sl.Vector3:if(t===Sl.Color3)return!0;break;case Sl.Vector4:if(t===Sl.Color4)return!0;break;case Sl.Color3:if(t===Sl.Vector3)return!0;break;case Sl.Color4:if(t===Sl.Vector4)return!0}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._connectedPointBackingField=e)),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._typeConnectionSourceBackingField=e)),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState((()=>this._defaultConnectionPointTypeBackingField=e))}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._linkedConnectionSourceBackingField=e)),this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.declarationVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===Sl.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===Sl.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState((()=>this._type=e))}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==xl.VertexAndFragment?this._target:this._ownerBlock.target===xl.Fragment?xl.Fragment:xl.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===xl.Vertex)return!0;if((e.ownerBlock.target===xl.Neutral||e.ownerBlock.target===xl.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isDirectlyConnectedToVertexOutput)))return!0}return!1}get isConnectedInVertexShader(){if(this.target===xl.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===xl.Vertex)return!0;if(e.target===xl.Vertex)return!0;if((e.ownerBlock.target===xl.Neutral||e.ownerBlock.target===xl.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isConnectedInVertexShader)))return!0}return!1}get isConnectedInFragmentShader(){if(this.target===xl.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===xl.Fragment)return!0;if((e.ownerBlock.target===xl.Neutral||e.ownerBlock.target===xl.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0}return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=Sl.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new n.cP,this.onDisconnectionObservable=new n.cP,this.onTypeChangedObservable=new n.cP,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=xl.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===xl.Fragment){if(i.target===xl.Vertex)return 2;for(const e of i.outputs)if(e.ownerBlock.target!=xl.Neutral&&e.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==Sl.AutoDetect)return Pl.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&Pl.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,n=t;return 0===this.direction&&(r=t,n=i),r.isAnAncestorOf(n)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<Sl.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){const t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}var yl,Al,Rl,Il=i(522);class Ml{get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}constructor(e,t=xl.Vertex,i=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this.onCodeIsReadyObservable=new n.cP,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===xl.Neutral,this._isFinalMerger=i,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0}this._name=e,this.uniqueId=Il.K.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===xl.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some((e=>e.isConnectedInFragmentShader))}registerInput(e,t,i=!1,r,n){return(n=n??new Pl(e,this,0)).type=t,n.isOptional=i,r&&(n.target=r),this._inputs.push(n),this}registerOutput(e,t,i,r){return(r=r??new Pl(e,this,1)).type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==Sl.AutoDetect&&-1===t.acceptedConnectionPointTypes.indexOf(e.type)))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===xl.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const n=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&n&&i.canConnectTo(n))i.connectTo(n),r=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,n){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some((e=>e.isDirectlyConnectedToVertexOutput))||this.target===xl.Vertex||this.target!==xl.VertexAndFragment&&this.target!==xl.Neutral||!this._outputs.some((e=>e.isConnectedInVertexShader)))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);const n=null!=t._vertexState,s=e._buildTarget===xl.Vertex&&e.target!==xl.VertexAndFragment;if(n&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==xl.VertexAndFragment&&s)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const e=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+e.declarationVariableName,e.type)){const i=1===t.shaderLanguage?"vertexOutputs.":"";t._vertexState.compilationString+=`${i}${"v_"+e.declarationVariableName} = ${e.associatedVariableName};\n`}const r=1===t.shaderLanguage?"fragmentInputs.":"";i.associatedVariableName=r+"v_"+e.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const t of this._outputs)t.associatedVariableName||(t.associatedVariableName=e._getFreeVariableName(t.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==xl.Neutral){if(!(i.target&this.target))continue;if(!(i.target&e.target))continue}const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&f.V.Log(`${e.target===xl.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case xl.Vertex:e.sharedData.checks.emitVertex=!0;break;case xl.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\n//${this.name}\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(!i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const i=r.ownerBlock;i&&(i.target&e.target&&-1!==t.indexOf(i)||e._terminalBlocks.has(i))&&this._processBuild(i,e,r,t)}this._postBuildBlock(e);for(const i of this._outputs)if(i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const i=r.ownerBlock;i&&i.target&e.target&&-1!==t.indexOf(i)&&this._processBuild(i,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\n${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.target = ${this.target};\n`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`\n// ${this.getClassName()}\n`;this.comments&&(r+=`// ${this.comments}\n`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\n`,r+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const n=i.connectedPoint.ownerBlock;-1===t.indexOf(n)&&(r+=n._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const n of i.endpoints){const i=n.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}clone(e,t=""){const i=this.serialize(),r=(0,o.n9)(i.customType);if(r){const n=new r;return n._deserialize(i,e,t),n}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach(((e,t)=>{e.displayName&&(this.inputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.inputs[t].isExposedOnFrame=e.isExposedOnFrame,this.inputs[t].exposedPortPosition=e.exposedPortPosition)})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}dispose(){this.onCodeIsReadyObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class Ol extends Ml{get transformAsDirection(){return 0===this.complementW}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,xl.Neutral),this.complementW=1,this.complementZ=0,this.target=xl.Vertex,this.registerInput("vector",Sl.AutoDetect),this.registerInput("transform",Sl.Matrix),this.registerOutput("output",Sl.Vector4),this.registerOutput("xyz",Sl.Vector3),this._inputs[0].onConnectionObservable.add((e=>{if(e.ownerBlock.isInput){const t=e.ownerBlock;"normal"!==t.name&&"tangent"!==t.name||(this.complementW=0)}}))}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform,r=e._getShaderType(Sl.Vector4),n=e._getShaderType(Sl.Vector3);if(t.connectedPoint){if(0===this.complementW||this.transformAsDirection){const s=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",s),e.sharedData.blocksWithDefines.push(this);const a=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(1===e.shaderLanguage?e.compilationString+=`var ${a}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);\n`:e.compilationString+=`mat3 ${a} = mat3(${i.associatedVariableName});\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\n",e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));\n`,e.compilationString+="#endif\n",t.connectedPoint.type){case Sl.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${n}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\n`;break;case Sl.Vector3:case Sl.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\n`}}else{const n=i.associatedVariableName;switch(t.connectedPoint.type){case Sl.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${n} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\n`;break;case Sl.Vector3:case Sl.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${n} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${n} * ${t.associatedVariableName};\n`}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\n`,e}}(0,ue.Cg)([oa("Transform as direction",0,void 0,{embedded:!0})],Ol.prototype,"transformAsDirection",null),(0,o.Y5)("BABYLON.TransformBlock",Ol);class Nl extends Ml{constructor(e){super(e,xl.Vertex,!0),this.registerInput("vector",Sl.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=1===e.shaderLanguage;if(1===e.shaderLanguage?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};\n`:e.compilationString+=`gl_Position = ${t.associatedVariableName};\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",Sl.Float),e._emitVaryingFromString("vFragmentDepth",Sl.Float);const t=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",r=i?"uniforms.":"",n=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${t} = 1.0 + ${n}.w;\n`,e.compilationString+=`${n}.z = log2(max(0.000001, ${t})) * ${r}logarithmicDepthConstant;\n`}return this}}(0,o.Y5)("BABYLON.VertexOutputBlock",Nl),function(e){e[e.NoColorSpace=0]="NoColorSpace",e[e.Gamma=1]="Gamma",e[e.Linear=2]="Linear"}(yl||(yl={}));class Dl extends Ml{constructor(e){super(e,xl.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",Sl.Color4,!0),this.registerInput("rgb",Sl.Color3,!0),this.registerInput("a",Sl.Float,!0),this.rgb.acceptedConnectionPointTypes.push(Sl.Vector3),this.rgb.acceptedConnectionPointTypes.push(Sl.Float)}get colorSpace(){return this.convertToGammaSpace?yl.Gamma:this.convertToLinearSpace?yl.Linear:yl.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===yl.Gamma,this.convertToLinearSpace=e===yl.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&(0,qo.DL)(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a,n=1===e.shaderLanguage;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",Sl.Float),e._emitVaryingFromString("vFragmentDepth",Sl.Float),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const s=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",s);let a="gl_FragColor";1===e.shaderLanguage&&(e.compilationString+="var fragmentOutputsColor : vec4<f32>;\r\n",a="fragmentOutputsColor");const o=e._getShaderType(Sl.Vector4);if(t.connectedPoint)r.isConnected?e.compilationString+=`${a} = ${o}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});\n`:e.compilationString+=`${a}  = ${t.associatedVariableName};\n`;else if(i.connectedPoint){let t="1.0";r.connectedPoint&&(t=r.associatedVariableName),i.connectedPoint.type===Sl.Float?e.compilationString+=`${a}  = ${o}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${t});\n`:e.compilationString+=`${a}  = ${o}(${i.associatedVariableName}, ${t});\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${a}  = toLinearSpace(${a});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${a}  = toGammaSpace(${a});\n`,e.compilationString+="#endif\n",1===e.shaderLanguage&&(e.compilationString+="#if !defined(PREPASS)\r\n",e.compilationString+="fragmentOutputs.color = fragmentOutputsColor;\r\n",e.compilationString+="#endif\r\n"),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){const t=n?"input.vFragmentDepth":"vFragmentDepth",i=n?"uniforms.":"",r=n?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${r} = log2(${t}) * ${i}logarithmicDepthConstant * 0.5;\n`}return e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+=`${n?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${a};\r\n`,e.compilationString+="#endif\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}(0,ue.Cg)([oa("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],Dl.prototype,"useLogarithmicDepth",void 0),(0,ue.Cg)([oa("Color space",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:yl.NoColorSpace},{label:"Gamma",value:yl.Gamma},{label:"Linear",value:yl.Linear}]})],Dl.prototype,"colorSpace",null),(0,o.Y5)("BABYLON.FragmentOutputBlock",Dl),function(e){e[e.World=1]="World",e[e.View=2]="View",e[e.Projection=3]="Projection",e[e.ViewProjection=4]="ViewProjection",e[e.WorldView=5]="WorldView",e[e.WorldViewProjection=6]="WorldViewProjection",e[e.CameraPosition=7]="CameraPosition",e[e.FogColor=8]="FogColor",e[e.DeltaTime=9]="DeltaTime",e[e.CameraParameters=10]="CameraParameters",e[e.MaterialAlpha=11]="MaterialAlpha"}(Al||(Al={})),function(e){e[e.None=0]="None",e[e.Time=1]="Time",e[e.RealTime=2]="RealTime",e[e.MouseInfo=3]="MouseInfo"}(Rl||(Rl={}));const Fl={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Ll={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},wl={particle_texturemask:!0};class Bl extends Ml{get type(){if(this._type===Sl.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=Sl.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=Sl.Vector2,this._type;case"Vector3":return this._type=Sl.Vector3,this._type;case"Vector4":return this._type=Sl.Vector4,this._type;case"Color3":return this._type=Sl.Color3,this._type;case"Color4":return this._type=Sl.Color4,this._type;case"Matrix":return this._type=Sl.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=Sl.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=Sl.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":return this._type=Sl.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=Sl.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=Sl.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Al.World:case Al.WorldView:case Al.WorldViewProjection:case Al.View:case Al.ViewProjection:case Al.Projection:return this._type=Sl.Matrix,this._type;case Al.CameraPosition:return this._type=Sl.Vector3,this._type;case Al.FogColor:return this._type=Sl.Color3,this._type;case Al.DeltaTime:case Al.MaterialAlpha:return this._type=Sl.Float,this._type;case Al.CameraParameters:return this._type=Sl.Vector4,this._type}}return this._type}constructor(e,t=xl.Vertex,i=Sl.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=Rl.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new n.cP,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===Sl.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return 3===this._mode}get isUniform(){return 0===this._mode}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return 1===this._mode}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return 2===this._mode}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case Rl.Time:this.type===Sl.Float&&(this.value+=.01*e.getAnimationRatio());break;case Rl.RealTime:this.type===Sl.Float&&(this.value=(Te.j.Now-e.getEngine().startTime)/1e3);break;case Rl.MouseInfo:if(this.type===Sl.Vector4){const t=e._inputManager._originMouseEvent;if(t){const e=t.offsetX,i=t.offsetY,r=1&t.buttons?1:0,n=2&t.buttons?1:0;this.value=new s.IU(e,i,r,n)}else this.value=new s.IU(0,0,0,0)}}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\n`:`#ifdef ${e}\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case Sl.Float:this.value=0;break;case Sl.Vector2:this.value=s.I9.Zero();break;case Sl.Vector3:this.value=s.Pq.Zero();break;case Sl.Vector4:this.value=s.IU.Zero();break;case Sl.Color3:this.value=wo.v9.White();break;case Sl.Color4:this.value=new wo.ov(1,1,1,1);break;case Sl.Matrix:this.value=s.uq.Identity()}}_emitConstant(e){switch(this.type){case Sl.Float:return`${e._emitFloat(this.value)}`;case Sl.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case Sl.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case Sl.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case Sl.Color3:return wo.IG.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&wo.IG.Color3[0].toGammaSpaceToRef(wo.IG.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wo.IG.Color3[0].toLinearSpaceToRef(wo.IG.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${wo.IG.Color3[0].r}, ${wo.IG.Color3[0].g}, ${wo.IG.Color3[0].b})`;case Sl.Color4:return wo.IG.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&wo.IG.Color4[0].toGammaSpaceToRef(wo.IG.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wo.IG.Color4[0].toLinearSpaceToRef(wo.IG.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${wo.IG.Color4[0].r}, ${wo.IG.Color4[0].g}, ${wo.IG.Color4[0].b}, ${wo.IG.Color4[0].a})`}return""}get _noContextSwitch(){return Ll[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));const i=e._getShaderType(this.type);1===e.shaderLanguage?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};\n`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};\n`,t&&(e._uniformDeclaration+="#endif\n");const r=e.sharedData.hints;if(null!==this._systemValue&&void 0!==this._systemValue)switch(this._systemValue){case Al.WorldView:r.needWorldViewMatrix=!0;break;case Al.WorldViewProjection:r.needWorldViewProjectionMatrix=!0}else this._animationType!==Rl.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=Fl[this.name]??this.name,this.target===xl.Vertex&&e._vertexState)return void(Ll[this.name]?wl[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type,t):this._emit(e._vertexState,t));const i=-1!==e.attributes.indexOf(this.declarationVariableName);i||e.attributes.push(this.declarationVariableName),Ll[this.name]?wl[this.name]?(i||e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="uniforms.")):(i||e._emitVaryingFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="fragmentInputs.")):(t&&!i&&(e._attributeDeclaration+=this._emitDefine(t)),1===e.shaderLanguage?(i||(e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};\n`),this._prefix="vertexInputs."):i||(e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};\n`),t&&!i&&(e._attributeDeclaration+="#endif\n"))}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const n=this._associatedVariableName;switch(this._systemValue){case Al.World:e.setMatrix(n,t);break;case Al.WorldView:e.setMatrix(n,i);break;case Al.WorldViewProjection:e.setMatrix(n,r)}}_transmit(e,t,i){if(this.isAttribute)return;const r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case Al.World:case Al.WorldView:case Al.WorldViewProjection:return;case Al.View:e.setMatrix(r,t.getViewMatrix());break;case Al.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case Al.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case Al.CameraPosition:t.bindEyePosition(e,r,!0);break;case Al.FogColor:e.setColor3(r,t.fogColor);break;case Al.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case Al.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Al.MaterialAlpha:e.setFloat(r,i.alpha)}return}const n=this._valueCallback?this._valueCallback():this._storedValue;if(null!==n)switch(this.type){case Sl.Float:e.setFloat(r,n);break;case Sl.Int:e.setInt(r,n);break;case Sl.Color3:wo.IG.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&wo.IG.Color3[0].toGammaSpaceToRef(wo.IG.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wo.IG.Color3[0].toLinearSpaceToRef(wo.IG.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,wo.IG.Color3[0]);break;case Sl.Color4:wo.IG.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&wo.IG.Color4[0].toGammaSpaceToRef(wo.IG.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&wo.IG.Color4[0].toLinearSpaceToRef(wo.IG.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,wo.IG.Color4[0]);break;case Sl.Vector2:e.setVector2(r,n);break;case Sl.Vector3:e.setVector3(r,n);break;case Sl.Vector4:e.setVector4(r,n);break;case Sl.Matrix:e.setMatrix(r,n)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Al[this._systemValue]});\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case Sl.Float:i=`${this.value}`;break;case Sl.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case Sl.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case Sl.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case Sl.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case Sl.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case Sl.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===Sl.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${Rl[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&0===this._mode&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&1===e.mode&&e.type===Sl.Vector3&&(this._type=Sl.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=(0,o.n9)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}(0,o.Y5)("BABYLON.InputBlock",Bl);class Vl extends Ml{constructor(e){super(e,xl.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",Sl.AutoDetect,!1,xl.VertexAndFragment),this.registerOutput("rgba",Sl.Color4,xl.Neutral),this.registerOutput("rgb",Sl.Color3,xl.Neutral),this.registerOutput("r",Sl.Float,xl.Neutral),this.registerOutput("g",Sl.Float,xl.Neutral),this.registerOutput("b",Sl.Float,xl.Neutral),this.registerOutput("a",Sl.Float,xl.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector2|Sl.Vector3|Sl.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?xl.VertexAndFragment:xl.Fragment:xl.VertexAndFragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,Sl.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,Sl.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===xl.Fragment)return;const t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,r=0===e.shaderLanguage?"":", 0";return void(e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${t} ${i.associatedVariableName}${r});\n`)}const r=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;this.uv.ownerBlock.target!==xl.Fragment?e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${r} ${this._mainUVName});\n`:e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${r} ${i.associatedVariableName});\n`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===xl.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target!==xl.Fragment?(e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"):e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==xl.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=_e.g.Parse(e.texture,t,i))}}(0,o.Y5)("BABYLON.CurrentScreenBlock",Vl);class kl extends Ml{constructor(e){super(e,xl.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",Sl.AutoDetect,!1,xl.VertexAndFragment),this.registerOutput("rgba",Sl.Color4,xl.Neutral),this.registerOutput("rgb",Sl.Color3,xl.Neutral),this.registerOutput("r",Sl.Float,xl.Neutral),this.registerOutput("g",Sl.Float,xl.Neutral),this.registerOutput("b",Sl.Float,xl.Neutral),this.registerOutput("a",Sl.Float,xl.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector2|Sl.Vector3|Sl.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"particle_uv"===e.name&&t(e)));i||(i=new Bl("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};\n`;for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=_e.g.Parse(e.texture,t,i))}}(0,o.Y5)("BABYLON.ParticleTextureBlock",kl);class Gl extends Ml{constructor(e){super(e,xl.Fragment),this._isUnique=!0,this.registerInput("color",Sl.Color4,!1,xl.Fragment),this.registerOutput("rampColor",Sl.Color4,xl.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target!==xl.Vertex)return e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",Sl.Vector4,"RAMPGRADIENT"),e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                ${e._declareLocalVar("baseColor",Sl.Vector4)} = ${this.color.associatedVariableName};\n                ${e._declareLocalVar("alpha",Sl.Float)} = ${this.color.associatedVariableName}.a;\n\n                ${e._declareLocalVar("remappedColorIndex",Sl.Float)} = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                ${e._declareLocalVar("rampColor",Sl.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};\n\n                // Remapped alpha\n                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0));\n            #else\n                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}(0,o.Y5)("BABYLON.ParticleRampGradientBlock",Gl);class Ul extends Ml{constructor(e){super(e,xl.Fragment),this._isUnique=!0,this.registerInput("color",Sl.Color4,!1,xl.Fragment),this.registerInput("alphaTexture",Sl.Float,!1,xl.Fragment),this.registerInput("alphaColor",Sl.Float,!1,xl.Fragment),this.registerOutput("blendColor",Sl.Color4,xl.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==xl.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${e._declareOutput(this.blendColor)};\n                ${e._declareLocalVar("sourceAlpha",Sl.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);\n            #else\n                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}(0,o.Y5)("BABYLON.ParticleBlendMultiplyBlock",Ul);class zl extends Ml{constructor(e){super(e,xl.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",Sl.Vector4,!0),this.registerInput("xyz ",Sl.Vector3,!0),this.registerInput("xy ",Sl.Vector2,!0),this.registerInput("zw ",Sl.Vector2,!0),this.registerInput("x",Sl.Float,!0),this.registerInput("y",Sl.Float,!0),this.registerInput("z",Sl.Float,!0),this.registerInput("w",Sl.Float,!0),this.registerOutput("xyzw",Sl.Vector4),this.registerOutput("xyz",Sl.Vector3),this.registerOutput("xy",Sl.Vector2),this.registerOutput("zw",Sl.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,n=this.w,s=this.xyIn,a=this.zwIn,o=this.xyzIn,l=this.xyzwIn,c=this._outputs[0],h=this._outputs[1],u=this._outputs[2],d=this._outputs[3],p=e._getShaderType(Sl.Vector4),f=e._getShaderType(Sl.Vector3),m=e._getShaderType(Sl.Vector2);return l.isConnected?(c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${l.associatedVariableName}${this._buildSwizzle(4)};\n`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\n`)):o.isConnected?(c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${p}(${o.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${o.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`)):s.isConnected?(c.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(c)+` = ${p}(${s.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=e._declareOutput(c)+` = ${p}(${s.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${f}(${s.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${s.associatedVariableName}${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(d)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=e._declareOutput(d)+` = ${m}(${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};\n`)):(c.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(c)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=e._declareOutput(c)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${f}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(d)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=e._declareOutput(d)+` = ${m}(${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\n`,e}}(0,o.Y5)("BABYLON.VectorMergerBlock",zl);class Wl extends Ml{constructor(e){super(e,xl.Neutral),this.sourceRange=new s.I9(-1,1),this.targetRange=new s.I9(0,1),this.registerInput("input",Sl.AutoDetect),this.registerInput("sourceMin",Sl.Float,!0),this.registerInput("sourceMax",Sl.Float,!0),this.registerInput("targetMin",Sl.Float,!0),this.registerInput("targetMax",Sl.Float,!0),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),s=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${n} + (${this._inputs[0].associatedVariableName} - ${i}) * (${s} - ${n}) / (${r} - ${i});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=s.I9.FromArray(e.sourceRange),this.targetRange=s.I9.FromArray(e.targetRange)}}(0,ue.Cg)([oa("From",3)],Wl.prototype,"sourceRange",void 0),(0,ue.Cg)([oa("To",3)],Wl.prototype,"targetRange",void 0),(0,o.Y5)("BABYLON.RemapBlock",Wl);class Hl extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(Sl.Float),this.right.acceptedConnectionPointTypes.push(Sl.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add((()=>this._updateInputOutputTypes())),this.right.onTypeChangedObservable.add((()=>this._updateInputOutputTypes()))]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===Sl.Int||this.left.type===Sl.Float&&this.right.type!==Sl.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[Sl.Int,Sl.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),t.type!==Sl.Int&&t.type!==Sl.Float||e.acceptedConnectionPointTypes.push(Sl.Vector2,Sl.Vector3,Sl.Vector4,Sl.Color3,Sl.Color4,Sl.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach((e=>e.remove())),this._connectionObservers.length=0}}class Yl extends Hl{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\n`,this}}var Xl;(0,o.Y5)("BABYLON.MultiplyBlock",Yl),function(e){e[e.Material=0]="Material",e[e.PostProcess=1]="PostProcess",e[e.Particle=2]="Particle",e[e.ProceduralTexture=3]="ProceduralTexture",e[e.GaussianSplatting=4]="GaussianSplatting"}(Xl||(Xl={}));class ql extends zo.M{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class $l{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:s.Pq.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:s.Pq.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:s.Pq.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:s.Pq.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let r=0;for(const i of t){if(i.gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=s.Pq.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new s.Pq(10,10,10),this.onAnimationEnd=null,this.blendMode=$l.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new s.I9(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new s.Pq(0,0,0),this._useLogarithmicDepth=!1,this.gravity=s.Pq.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new a.ov(1,1,1,1),this.color2=new a.ov(1,1,1,1),this.colorDead=new a.ov(0,0,0,1),this.textureMask=new a.ov(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new ql,this.id=e,this.name=e}createPointEmitter(e,t){throw new Error("Method not implemented.")}createHemisphericEmitter(e=1,t=1){throw new Error("Method not implemented.")}createSphereEmitter(e=1,t=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(e=1,t=new s.Pq(0,1,0),i=new s.Pq(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(e=1,t=1,i=1,r=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new s.Pq(0,1,0),n=new s.Pq(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(e=1,t=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new s.Pq(0,1,0),r=new s.Pq(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(e,t,i,r){throw new Error("Method not implemented.")}}$l.BLENDMODE_ONEONE=0,$l.BLENDMODE_STANDARD=1,$l.BLENDMODE_ADD=2,$l.BLENDMODE_MULTIPLY=3,$l.BLENDMODE_MULTIPLYADD=4,(0,o.Y5)("BABYLON.BaseParticleSystem",$l);class jl extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("rgba",Sl.Color4,!0),this.registerInput("rgb ",Sl.Color3,!0),this.registerOutput("rgb",Sl.Color3),this.registerOutput("r",Sl.Float),this.registerOutput("g",Sl.Float),this.registerOutput("b",Sl.Float),this.registerOutput("a",Sl.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],n=this._outputs[2],s=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.g;\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.b;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.a;\n`),this}}(0,o.Y5)("BABYLON.ColorSplitterBlock",jl);var Kl=i(63288),Zl=i(93803);class Ql{constructor(e){this.name=Gt.v.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(Gt.v.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){re.S0.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}re.S0.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}var Jl,ec=i(95776);class tc extends _e.g{get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,s=null,a=!0,o=!1,l=0){super(null,r,!a),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new n.cP,this.onBeforeGenerationObservable=new n.cP,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,null===s||s instanceof _e.g?(this._options={},this._fallbackTexture=s):(this._options=s,this._fallbackTexture=s.fallbackTexture??null),this._shaderLanguage=this._options.shaderLanguage??0;let c=(r=this.getScene()||P.q.LastCreatedScene)._getComponent(Gt.v.NAME_PROCEDURALTEXTURE);c||(c=new Ql(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=a,this._drawWrapper=new ec.E(this._fullEngine),this.setFragment(i);const h=this._createRtWrapper(o,t,a,l);this._texture=h.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[Ue.R.PositionKind]=new Ue.R(this._fullEngine,u,Ue.R.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then((e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId})):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[Ue.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Si.$.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Si.$.REFRESHRATE_RENDER_ONCE)}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady())return void e(this);const t=this.getEffect();t&&t.executeWhenCompiled((()=>{e(this)}))}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const r={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:"string"==typeof this._fragment?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(r,[Ue.R.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,(()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0}),void 0,this._shaderLanguage,(async()=>{this._options.extraInitializationsAsync?1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,37177)),this._options.extraInitializationsAsync()]):await Promise.all([Promise.resolve().then(i.bind(i,53328)),this._options.extraInitializationsAsync()]):1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,37177)):await Promise.resolve().then(i.bind(i,53328))}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)):(this._texture&&(this._texture.isReady=!1),!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){-1===this._uniforms.indexOf(e)&&this._uniforms.push(e)}setTexture(e,t){return-1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){const t=this.getScene();if(!t)return;const i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e]);for(const e in this._ints)this._drawWrapper.effect.setInt(e,this._ints[e]);for(const e in this._floats)this._drawWrapper.effect.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)this._drawWrapper.effect.setArray(e,this._floatsArrays[e]);for(const e in this._colors3)this._drawWrapper.effect.setColor3(e,this._colors3[e]);for(const e in this._colors4){const t=this._colors4[e];this._drawWrapper.effect.setFloat4(e,t.r,t.g,t.b,t.a)}for(const e in this._vectors2)this._drawWrapper.effect.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)this._drawWrapper.effect.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)this._drawWrapper.effect.setVector4(e,this._vectors4[e]);for(const e in this._matrices)this._drawWrapper.effect.setMatrix(e,this._matrices[e])}if(!this._texture||!this._rtWrapper)return;i._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);const r=i.currentViewport;if(this.isCube)for(let e=0;e<6;e++)i.bindFramebuffer(this._rtWrapper,e,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",e),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Zl.i.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let e=1;this._rtWrapper.is3D?e=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(e=this._rtWrapper.layers);for(let r=0;r<e;r++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,r),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){this._drawWrapper.effect?.setFloat("layer",1!==e?r/(e-1):0),this._drawWrapper.effect?.setInt("layerNum",r);for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Zl.i.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),i._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new tc(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[Ue.R.PositionKind];i&&(i.dispose(),this._vertexBuffers[Ue.R.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}(0,ue.Cg)([(0,de.lK)()],tc.prototype,"isEnabled",void 0),(0,ue.Cg)([(0,de.lK)()],tc.prototype,"autoClear",void 0),(0,ue.Cg)([(0,de.lK)()],tc.prototype,"_generateMipMaps",void 0),(0,ue.Cg)([(0,de.lK)()],tc.prototype,"_size",void 0),(0,ue.Cg)([(0,de.lK)()],tc.prototype,"refreshRate",null),(0,o.Y5)("BABYLON.ProceduralTexture",tc),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Exp2=4]="Exp2",e[e.Round=5]="Round",e[e.Floor=6]="Floor",e[e.Ceiling=7]="Ceiling",e[e.Sqrt=8]="Sqrt",e[e.Log=9]="Log",e[e.Tan=10]="Tan",e[e.ArcTan=11]="ArcTan",e[e.ArcCos=12]="ArcCos",e[e.ArcSin=13]="ArcSin",e[e.Fract=14]="Fract",e[e.Sign=15]="Sign",e[e.Radians=16]="Radians",e[e.Degrees=17]="Degrees",e[e.Set=18]="Set"}(Jl||(Jl={}));class ic extends Ml{constructor(e){super(e,xl.Neutral),this.operation=Jl.Cos,this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case Jl.Cos:i="cos";break;case Jl.Sin:i="sin";break;case Jl.Abs:i="abs";break;case Jl.Exp:i="exp";break;case Jl.Exp2:i="exp2";break;case Jl.Round:i="round";break;case Jl.Floor:i="floor";break;case Jl.Ceiling:i="ceil";break;case Jl.Sqrt:i="sqrt";break;case Jl.Log:i="log";break;case Jl.Tan:i="tan";break;case Jl.ArcTan:i="atan";break;case Jl.ArcCos:i="acos";break;case Jl.ArcSin:i="asin";break;case Jl.Fract:i="fract";break;case Jl.Sign:i="sign";break;case Jl.Radians:i="radians";break;case Jl.Degrees:i="degrees";break;case Jl.Set:i=""}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${Jl[this.operation]};\n`}}(0,ue.Cg)([oa("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:Jl.Cos},{label:"Sin",value:Jl.Sin},{label:"Abs",value:Jl.Abs},{label:"Exp",value:Jl.Exp},{label:"Exp2",value:Jl.Exp2},{label:"Round",value:Jl.Round},{label:"Floor",value:Jl.Floor},{label:"Ceiling",value:Jl.Ceiling},{label:"Sqrt",value:Jl.Sqrt},{label:"Log",value:Jl.Log},{label:"Tan",value:Jl.Tan},{label:"ArcTan",value:Jl.ArcTan},{label:"ArcCos",value:Jl.ArcCos},{label:"ArcSin",value:Jl.ArcSin},{label:"Fract",value:Jl.Fract},{label:"Sign",value:Jl.Sign},{label:"Radians",value:Jl.Radians},{label:"Degrees",value:Jl.Degrees},{label:"Set",value:Jl.Set}]})],ic.prototype,"operation",void 0),(0,o.Y5)("BABYLON.TrigonometryBlock",ic);const rc={effect:null,subMesh:null};class nc extends zo.M{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class sc extends Wo.E{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"ReflectionTextureBlock"===e.getClassName()||"ReflectionBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get shaderLanguage(){return this._options.shaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||P.q.LastCreatedScene),this._buildId=sc._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new s.uq,this._cachedWorldViewProjectionMatrix=new s.uq,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new n.cP,this.onBuildErrorObservable=new n.cP,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=Xl.Material,this.forceAlphaBlending=!1,i&&1===i.shaderLanguage&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:sc.DefaultShaderLanguage,...i},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return re.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&xl.Vertex&&this._addVertexOutputNode(e),e.target&xl.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(e.target&xl.Vertex&&this._removeVertexOutputNode(e),e.target&xl.Fragment&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=xl.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=xl.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===xl.VertexAndFragment||t.target===xl.Fragment&&e.target===xl.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const t=e.getClassName();for(const e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(const n of e.inputs){n.associatedVariableName="";const s=n.connectedPoint;if(s&&!s._preventBubbleUp){const n=s.ownerBlock;n!==e&&this._processInitializeOnLink(n,t,i,r)}}if(e.isLoop){const n=e;if(n.loopID.hasEndpoints)for(const e of n.loopID.endpoints){const n=e.ownerBlock;0===n.outputs.length&&(t._terminalBlocks.add(n),this._processInitializeOnLink(n,t,i,r))}}else if(e.isTeleportOut){const n=e;n.entryPoint&&this._processInitializeOnLink(n.entryPoint,t,i,r)}for(const t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){e.target===xl.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r&&!r._preventBubbleUp){const i=r.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){const i=e;if(i.loopID.hasEndpoints)for(const e of i.loopID.endpoints){const i=e.ownerBlock;0===i.outputs.length&&this._resetDualBlocks(i,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress)return void f.V.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");this._buildIsInProgress=!0,this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),n=this._mode===Xl.Particle;if(0===this._vertexOutputNodes.length&&!n)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Cl,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=xl.Vertex,this._fragmentCompilationState=new Cl,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=xl.Fragment,this._sharedData=new bl,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=n;const s=[],a=[];for(const e of this._vertexOutputNodes)s.push(e),this._initializeBlock(e,this._vertexCompilationState,a,i);for(const e of this._fragmentOutputNodes)a.push(e),this._initializeBlock(e,this._fragmentCompilationState,s,i);let o=0;for(const i of this.attachedBlocks)i.codeIsReady||(o++,i.onCodeIsReadyObservable.addOnce((()=>{o--,0===o&&this._finishBuildProcess(e,t,s,a)})));0===o&&this._finishBuildProcess(e,t,s,a)}_finishBuildProcess(e=!1,t=!0,i,r){this.optimize();for(const e of i)e.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const e of r)this._resetDualBlocks(e,this._buildId-1);for(const e of r)e.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=sc._BuildIdGenerator++);const n=this._sharedData.emitErrors(this.onBuildErrorObservable);e&&(f.V.Log("Vertex shader:"),f.V.Log(this._vertexCompilationState.compilationString),f.V.Log("Fragment shader:"),f.V.Log(this._fragmentCompilationState.compilationString)),this._buildIsInProgress=!1,this._buildWasSuccessful=!0,n&&this.onBuildObservable.notifyObservers(this);const s=this.getScene().meshes;for(const e of s)if(e.subMeshes)for(const t of e.subMeshes){if(t.getMaterial()!==this)continue;if(!t.materialDefines)continue;const e=t.materialDefines;e.markAllAsDirty(),e.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const a=this.getScene().prePassRenderer;a&&a.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT,n=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(Ue.R.NormalKind),t.TANGENT=e.isVerticesDataPresent(Ue.R.TangentKind);const s=e.useVertexColors&&e.isVerticesDataPresent(Ue.R.ColorKind);t.VERTEXCOLOR_NME=s;let a=!1;for(let i=1;i<=6;++i){const r=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),a=a||t["UV"+i]!==r}const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;(0,qo.N4)(this.getScene(),t,!o),(i!==t.NORMAL||r!==t.TANGENT||n!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate((e=>"PrePassOutputBlock"===e.getClassName())),t=[4];return e?(this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1)),t):t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter((e=>"PrePassTextureBlock"===e.getClassName())),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const e of t)i.texturesRequired.includes(e)||i.texturesRequired.push(e);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,n,s=0,a=5){return this.mode!==Xl.PostProcess?(f.V.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,n,s,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,n,s,a=0,o=5){let l=this.name+this._buildId;const c=new nc,h=new Rt.e(l+"PostProcess",this.getScene());let u=this._buildId;return this._processDefines(h,c),So.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(c.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new jt.w(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,n,s,c.toString(),a,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,o,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add((t=>{u!==this._buildId&&(delete So.M.ShadersStore[l+"VertexShader"],delete So.M.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,c.markAllAsDirty(),u=this._buildId),this._processDefines(h,c)&&(So.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Kl._.SetImmediate((()=>e.updateEffect(c.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l)))),this._checkInternals(t)})),e}createProceduralTexture(e,t){if(this.mode!==Xl.ProceduralTexture)return f.V.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new tc(i,e,null,t),n=new Rt.e(i+"Procedural",this.getScene());n.reservedDataStore={hidden:!0};const s=new nc,a=this._processDefines(n,s);So.M.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[Ue.R.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString(),a?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(o);let l=this._buildId;const c=()=>{l!==this._buildId&&(delete So.M.ShadersStore[i+"VertexShader"],delete So.M.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,s.markAllAsDirty(),l=this._buildId);const e=this._processDefines(n,s);e&&(So.M.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),Kl._.SetImmediate((()=>{o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[Ue.R.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString(),e?.fallbacks,void 0),r._setEffect(o)}))),this._checkInternals(o)};return r.onBeforeGenerationObservable.add((()=>{c()})),this.onBuildObservable.add((()=>{c()})),r}_createEffectForParticles(e,t,i,r,n,s,a,o=""){let l=this.name+this._buildId+"_"+t;s||(s=new nc),a||(a=this.getScene().getMeshByName(this.name+"Particle"))||((a=new Rt.e(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let c=this._buildId;const h=[];let u=o;if(!n){const o=this._processDefines(a,s);So.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(h,t,!1),u=h.join("\n"),n=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString()+"\n"+u,o?.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(n,t)}n.onBindObservable.add((n=>{c!==this._buildId&&(delete So.M.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,s.markAllAsDirty(),c=this._buildId),h.length=0,e.fillDefines(h,t,!1);const d=h.join("\n");d!==u&&(s.markAllAsDirty(),u=d);const p=this._processDefines(a,s);if(p)return So.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),n=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString()+"\n"+u,p?.fallbacks,i,r,e),e.setCustomEffect(n,t),void this._createEffectForParticles(e,t,i,r,n,s,a,o);this._checkInternals(n)}))}_checkInternals(e){if(this._sharedData.animatedInputs){const e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(const t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===Xl.Particle?(this._createEffectForParticles(e,$l.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,$l.BLENDMODE_MULTIPLY,t,i)):f.V.Log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===Xl.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):f.V.Log("Incompatible material mode")}_processDefines(e,t,i=!1,r){let n=null;const s=this.getScene();if((0,qo.Y7)(s,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach((r=>{r.initializeDefines(e,this,t,i)})),this._sharedData.blocksWithDefines.forEach((n=>{n.prepareDefines(e,this,t,i,r)})),t.isDirty){const i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach((i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)}));const r=[];this._sharedData.dynamicUniformBlocks.forEach((e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,r)}));const s=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach((e=>{-1===s.indexOf(e)&&s.push(e)}));const a=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach((e=>{-1===a.indexOf(e)&&a.push(e)}));const o=new Yo.J;this._sharedData.blocksWithFallbacks.forEach((t=>{t.provideFallbacks(e,o)})),n={lightDisposed:i,uniformBuffers:r,mergedUniforms:s,mergedSamplers:a,fallbacks:o}}return n}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const e=r.getFrameId();if(this._animationFrame!==e){for(const e of this._sharedData.animatedInputs)e.animate(r);this._animationFrame=e}}const n=t._drawWrapper;if(n.effect&&this.isFrozen&&n._wasPreviouslyReady&&n._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new nc);const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=r.getEngine();if(this._prepareDefinesForAttributes(e,s),this._sharedData.blockingBlocks.some((t=>!t.isReady(e,this,s,i))))return!1;const o=this._processDefines(e,s,i,t);if(o){const e=t.effect,i=s.toString();let n=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:i,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:s.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},a);if(n)if(this._onEffectCreatedObservable&&(rc.effect=n,rc.subMesh=t,this._onEffectCreatedObservable.notifyObservers(rc)),this.allowShaderHotSwapping&&e&&!n.isReady()){if(n=e,s.markAsUnprocessed(),o.lightDisposed)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(n,s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),n._wasPreviouslyReady=!0,n._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader\n${this._vertexCompilationState.compilationString}\n\n// Fragment shader\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const t of this._sharedData.inputBlocks)t._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e);const s=this._mustRebind(r,n,i,t.visibility),a=this._sharedData;if(s){for(const e of a.bindableBlocks)e.bind(n,this,t,i);for(const e of a.forcedBindableBlocks)e.bind(n,this,t,i);for(const e of a.inputBlocks)e._transmit(n,r,this)}else if(!this.isFrozen)for(const e of a.forcedBindableBlocks)e.bind(n,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter((e=>e.texture)).map((e=>e.texture))),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)sc._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const e of this.getTextureBlocks().filter((e=>e.texture)).map((e=>e.texture)))e.dispose();for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise((t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){const i=e&&e.editorURL?e.editorURL:sc.EditorURL;re.S0.LoadBabylonScript(i,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()}))}else this._createNodeEditor(e?.nodeEditorConfig),t()}))}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;const e=new Bl("Position");e.setAsAttribute("position");const t=new Bl("World");t.setAsSystemValue(Al.World);const i=new Ol("WorldPos");e.connectTo(i),t.connectTo(i);const r=new Bl("ViewProjection");r.setAsSystemValue(Al.ViewProjection);const n=new Ol("WorldPos * ViewProjectionTransform");i.connectTo(n),r.connectTo(n);const s=new Nl("VertexOutput");n.connectTo(s);const o=new Bl("color");o.value=new a.ov(.8,.8,.8,1);const l=new Dl("FragmentOutput");o.connectTo(l),this.addOutputNode(s),this.addOutputNode(l),this._mode=Xl.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new Bl("Position");e.setAsAttribute("position2d");const t=new Bl("Constant1");t.isConstant=!0,t.value=1;const i=new zl("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new Nl("VertexOutput");i.connectTo(r);const n=new Bl("Scale");n.visibleInInspector=!0,n.value=new s.I9(1,1);const a=new Wl("uv0");e.connectTo(a);const o=new Yl("UV scale");a.connectTo(o),n.connectTo(o);const l=new Vl("CurrentScreen");o.connectTo(l),l.texture=new _e.g("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const c=new Dl("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(c),this._mode=Xl.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new Bl("Position");e.setAsAttribute("position2d");const t=new Bl("Constant1");t.isConstant=!0,t.value=1;const i=new zl("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new Nl("VertexOutput");i.connectTo(r);const n=new Bl("Time");n.value=0,n.min=0,n.max=0,n.isBoolean=!1,n.matrixMode=0,n.animationType=Rl.Time,n.isConstant=!1;const s=new Bl("Color3");s.value=new a.v9(1,1,1),s.isConstant=!1;const o=new Dl("FragmentOutput"),l=new zl("VectorMerger");l.visibleInInspector=!1;const c=new ic("Cos");c.operation=Jl.Cos,e.connectTo(l),n.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(o.rgb),this.addOutputNode(r),this.addOutputNode(o),this._mode=Xl.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new Bl("uv");e.setAsAttribute("particle_uv");const t=new kl("ParticleTexture");e.connectTo(t);const i=new Bl("Color");i.setAsAttribute("particle_color");const r=new Yl("Texture * Color");t.connectTo(r),i.connectTo(r);const n=new Gl("ParticleRampGradient");r.connectTo(n);const s=new jl("ColorSplitter");i.connectTo(s);const a=new Ul("ParticleBlendMultiply");n.connectTo(a),t.connectTo(a,{output:"a"}),s.connectTo(a,{output:"a"});const o=new Dl("FragmentOutput");a.connectTo(o),this.addOutputNode(o),this._mode=Xl.Particle}async loadAsync(e,t=""){return sc.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,t);const r=[];for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,r);let n=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\n`;n+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${Xl[this.mode]};\n`;for(const r of t)r.isInput&&-1===e.indexOf(r)&&(n+=r._dumpCode(i,e));for(const t of r)t.isInput&&-1===e.indexOf(t)&&(n+=t._dumpCode(i,e));e=[],n+="\n// Connections\n";for(const t of this._vertexOutputNodes)n+=t._dumpCodeForOutputConnections(e);for(const t of this._fragmentOutputNodes)n+=t._dumpCodeForOutputConnections(e);n+="\n// Output nodes\n";for(const e of this._vertexOutputNodes)n+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;for(const e of this._fragmentOutputNodes)n+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;return n+="nodeMaterial.build();\n",n}serialize(e){const t=e?{}:pe.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const s=i[n.id];if(s)for(const a of n.inputs)if(i[a.targetBlockId]!==e||a.targetConnectionName!==r.name);else{const e=s.getInputByName(a.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(s,t,i)}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();const n={};for(const i of e.blocks){const e=(0,o.n9)(i.customType);if(e){const s=new e;s._deserialize(i,this.getScene(),t,r),n[i.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,i=t._tempEntryPointUniqueId;i&&n[i].attachToEndpoint(t)}for(let t=0;t<e.blocks.length;t++){const r=n[e.blocks[t].id];r&&(r.inputs.length&&!i||this._restoreConnections(r,e,n))}if(e.outputNodes)for(const t of e.outputNodes)this.addOutputNode(n[t]);if(e.locations||e.editorData&&e.editorData.locations){const t=e.locations||e.editorData.locations;for(const e of t)n[e.blockId]&&(e.blockId=n[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);const r=[];for(const e in n)r[e]=n[e].uniqueId;this.editorData.map=r}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),void 0!==e.alphaMode&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??Xl.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=pe.p.Clone((()=>new sc(e,this.getScene(),this.options)),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach((t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise(((e,t)=>{i.onLoadedObservable.addOnce((()=>{e()})),i.onErrorObservable.addOnce((e=>{t(e)}))})))})),Promise.all(e)}static Parse(e,t,i="",r=0){const n=pe.p.Parse((()=>new sc(e.name,t,{shaderLanguage:r})),e,t,i);return n.parseSerializedObject(e,i),n.build(),n}static async ParseFromFileAsync(e,t,i,r="",n=!1,s,a){const o=s??new sc(e,i),l=await i._loadFileAsync(t),c=JSON.parse(l);return o.parseSerializedObject(c,r,void 0,a),n||o.build(),o}static ParseFromSnippetAsync(e,t=P.q.LastCreatedScene,i="",r,n=!1,s=!1,a){return"_BLANK"===e?Promise.resolve(sc.CreateDefault("blank",t)):new Promise(((o,l)=>{const c=new aa.u;c.addEventListener("readystatechange",(()=>{if(4==c.readyState)if(200==c.status){const h=JSON.parse(JSON.parse(c.responseText).jsonPayload),u=JSON.parse(h.nodeMaterial);r||((r=pe.p.Parse((()=>new sc(e,t)),u,t,i)).uniqueId=t.getUniqueId()),r.parseSerializedObject(u,void 0,void 0,a),r.snippetId=e,r.sideOrientation=null;try{n||r.build()}catch(e){l(e)}s?r.whenTexturesReadyAsync().then((()=>{o(r)})).catch((e=>{l(e)})):o(r)}else l("Unable to load the snippet "+e)})),c.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),c.send()}))}static CreateDefault(e,t){const i=new sc(e,t);return i.setToDefault(),i.build(),i}}sc._BuildIdGenerator=0,sc.EditorURL=`${re.S0._DefaultCdnUrl}/v${ne.$.Version}/nodeEditor/babylon.nodeEditor.js`,sc.SnippetUrl="https://snippet.babylonjs.com",sc.IgnoreTexturesAtLoadTime=!1,sc.DefaultShaderLanguage=0,(0,ue.Cg)([(0,de.lK)()],sc.prototype,"ignoreAlpha",void 0),(0,ue.Cg)([(0,de.lK)()],sc.prototype,"maxSimultaneousLights",void 0),(0,ue.Cg)([(0,de.lK)("mode")],sc.prototype,"_mode",void 0),(0,ue.Cg)([(0,de.lK)("comment")],sc.prototype,"comment",void 0),(0,ue.Cg)([(0,de.lK)()],sc.prototype,"forceAlphaBlending",void 0),(0,o.Y5)("BABYLON.NodeMaterial",sc);var ac,oc,lc=i(103);lc.K.prototype._projectOnTrianglesToRef=function(e,t,i,r,n,a){const o=s.AA.Vector3[0],l=s.AA.Vector3[1];let c=1/0;for(let a=this.indexStart;a<this.indexStart+this.indexCount-(3-r);a+=r){const r=i[a],h=i[a+1],u=i[a+2];if(n&&4294967295===u){a+=2;continue}const d=t[r],p=t[h],f=t[u];if(!d||!p||!f)continue;const m=s.Pq.ProjectOnTriangleToRef(e,d,p,f,l);m<c&&(o.copyFrom(l),c=m)}return a.copyFrom(o),c},lc.K.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,r){const n=s.AA.Vector3[0],a=s.AA.Vector3[1];let o=1/0;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const r=t[i],l=t[i+1],c=t[i+2],h=s.Pq.ProjectOnTriangleToRef(e,r,l,c,a);h<o&&(n.copyFrom(a),o=h)}return r.copyFrom(n),o},lc.K.prototype.projectToRef=function(e,t,i,r){const n=this.getMaterial();if(!n)return-1;let s=3,a=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,a=!0}return 4===n.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,r):this._projectOnTrianglesToRef(e,t,i,s,a,r)},function(e){e[e.DEHYDRATED=0]="DEHYDRATED",e[e.HOVER=1]="HOVER",e[e.TOUCH=2]="TOUCH"}(ac||(ac={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",e[e.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(oc||(oc={}));class cc extends gl{constructor(e,t){super(e),this._options=t,this._tmpRay=new Ii.Rl(new s.Pq,new s.Pq),this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r}=this._generateNewTouchPointMesh(),n=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r,currentAnimationState:ac.DEHYDRATED,grabRay:new Ii.Rl(new s.Pq,new s.Pq),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:cc._IdCounter++,pickedPointVisualCue:n},this._controllers[e.uniqueId]._worldScaleObserver=this._controllers[e.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add((t=>{if(t.newScaleFactor!==t.previousScaleFactor){this._controllers[e.uniqueId].touchCollisionMesh.dispose(),this._controllers[e.uniqueId].pickedPointVisualCue.dispose();const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r}=this._generateNewTouchPointMesh();this._controllers[e.uniqueId].touchCollisionMesh=t,this._controllers[e.uniqueId].touchCollisionMeshFunction=i,this._controllers[e.uniqueId].hydrateCollisionMeshFunction=r,this._controllers[e.uniqueId].pickedPointVisualCue=this._generateVisualCue()}})),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new a.v9(.8,.8,.8),this.selectionMeshPickedColor=new a.v9(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){if(e.currentAnimationState!==t&&2===this._options.nearInteractionControllerMode&&!e.xrController?.inputSource.hand){if(t>e.currentAnimationState)switch(e.currentAnimationState){case ac.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===ac.HOVER)break;case ac.HOVER:if(e.touchCollisionMeshFunction(!0),t===ac.TOUCH)break}else switch(e.currentAnimationState){case ac.TOUCH:if(e.touchCollisionMeshFunction(!1),t===ac.HOVER)break;case ac.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===ac.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(s.AA.Vector3[0]),r.grabRay.direction.copyFrom(s.AA.Vector3[0]),2!==this._options.nearInteractionControllerMode||r.xrController?.inputSource.hand||(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){Object.keys(this._controllers).forEach((t=>{const i=this._controllers[t],r=i.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!i.xrController||!r&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad))return void(i.pick=null);if(i.hoverInteraction=!1,i.nearInteraction=!1,!i.xrController)return;if(r){const i=r.get("index-finger-tip");if(i){const r=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(r&&r.transform){const e=this._scene.useRightHandedSystem?1:-1;s.AA.Vector3[0].set(r.transform.position.x,r.transform.position.y,r.transform.position.z*e),s.AA.Quaternion[0].set(r.transform.orientation.x,r.transform.orientation.y,r.transform.orientation.z*e,r.transform.orientation.w*e),this._processTouchPoint(t,s.AA.Vector3[0],s.AA.Quaternion[0])}}}else if(i.xrController.inputSource.gamepad&&0!==this._options.nearInteractionControllerMode){let e=i.xrController.pointer;i.xrController.grip&&1===this._options.nearInteractionControllerMode&&(e=i.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}const n=(e,t)=>{let i=null;return i=t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,i},a=e=>{let t=new Ji.G,i=!1;const r=e&&e.pickedPoint&&e.hit;return e?.pickedPoint&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),r&&!i&&(t=e),t};if(!i.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,(e=>this._nearInteractionPredicate(e))));const s=n(this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,(e=>this._nearInteractionPredicate(e))),t);if(s&&s.hit&&(e=a(s),e.hit&&(i.hoverInteraction=!0)),i.hoverInteraction){let t=null;const s=(r?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,s,this._utilityLayerScene,(e=>this._nearPickPredicate(e))));const o=a(n(this._pickWithSphere(i,s,this._scene,(e=>this._nearPickPredicate(e))),t));o.hit&&(e=o,i.nearInteraction=!0)}i.stalePick=i.pick,i.pick=e,i.pick&&i.pick.pickedPoint&&i.pick.hit?(i.meshUnderPointer=i.pick.pickedMesh,i.pickedPointVisualCue.position.copyFrom(i.pick.pickedPoint),i.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!0)):(i.meshUnderPointer=null,i.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!1))}let o=ac.DEHYDRATED;i.grabInteraction||i.nearInteraction?o=ac.TOUCH:i.hoverInteraction&&(o=ac.HOVER),this._handleTransitionAnimation(i,o)}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene:this._scene,t=(0,Mo._6)("nearInteraction",{diameter:.0105*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=s.PT.Identity();const i=new Oi.F("targetMat",e);return i.specularColor=a.v9.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))}));const r=r=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),r&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!r&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):!r||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;r(t)}})):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;r(t)}})))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{const e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},r=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0,t.downTriggered=!1)};t.eventListeners={selectend:r,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",r)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame((()=>{if(!t.downTriggered)return;const e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Ji.G,e)})),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e)){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene:this._scene,i=(0,Mo._6)("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let e;e=this._options.motionControllerTouchMaterialSnippetUrl?sc.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):sc.ParseFromSnippetAsync("8RUNKL#3",t),e.then((e=>{i.material=e})).catch((e=>{f.V.Warn(`Error creating touch material in WebXRNearInteraction: ${e}`)}))}const r=new W;r.setEasingMode(L.EASINGMODE_EASEINOUT);const n=new s.Pq(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),a=this._controllerPickRadius*(4/3),o=new s.Pq(a,a,a).scaleInPlace(e),l=this._controllerPickRadius*(7/6),c=new s.Pq(l,l,l).scaleInPlace(e),h=.8*this._controllerPickRadius,u=new s.Pq(h,h,h).scaleInPlace(e),d=1.5*this._controllerPickRadius,p=[{frame:0,value:n},{frame:10,value:new s.Pq(d,d,d).scaleInPlace(e)},{frame:18,value:o}],m=[{frame:0,value:o},{frame:10,value:u},{frame:18,value:n}],_=[{frame:0,value:s.Pq.ZeroReadOnly},{frame:12,value:c},{frame:15,value:n}],g=[{frame:0,value:n},{frame:10,value:s.Pq.ZeroReadOnly},{frame:15,value:s.Pq.ZeroReadOnly}],v=new M.X5("touch","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),S=new M.X5("release","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),x=new M.X5("hydrate","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT),T=new M.X5("dehydrate","scaling",60,M.X5.ANIMATIONTYPE_VECTOR3,M.X5.ANIMATIONLOOPMODE_CONSTANT);return v.setEasingFunction(r),S.setEasingFunction(r),x.setEasingFunction(r),T.setEasingFunction(r),v.setKeys(p),S.setKeys(m),x.setKeys(_),T.setKeys(g),{touchCollisionMesh:i,touchCollisionMeshFunction:e=>{const r=e?v:S;t.beginDirectAnimation(i,[r],0,18,!1,1)},hydrateCollisionMeshFunction:e=>{const r=e?x:T;e&&(i.isVisible=!0),t.beginDirectAnimation(i,[r],0,15,!1,1,(()=>{e||(i.isVisible=!1)}))}}}_pickWithSphere(e,t,i,r){const n=new Ji.G;if(n.distance=1/0,e.touchCollisionMesh&&e.xrController){const s=e.touchCollisionMesh.position,a=vr.i.CreateFromCenterAndRadius(s,t);for(let t=0;t<i.meshes.length;t++){const s=i.meshes[t];if(!r(s)||!this._controllerAvailablePredicate(s,e.xrController.uniqueId))continue;const o=cc.PickMeshWithSphere(s,a);o&&o.hit&&o.distance<n.distance&&(n.hit=o.hit,n.pickedMesh=s,n.pickedPoint=o.pickedPoint,n.aimTransform=e.xrController.pointer,n.gripTransform=e.xrController.grip||null,n.originMesh=e.touchCollisionMesh,n.distance=o.distance,n.bu=o.bu,n.bv=o.bv,n.faceId=o.faceId,n.subMeshId=o.subMeshId)}}return n}static PickMeshWithSphere(e,t,i=!1){const r=e.subMeshes,n=new Ji.G,a=e.getBoundingInfo();if(!e._generatePointsArray())return n;if(!e.subMeshes||!a)return n;if(!i&&!vr.i.Intersects(a.boundingSphere,t))return n;const o=s.AA.Vector3[0],l=s.AA.Vector3[1],c=new Ii.Rl(s.Pq.Zero(),s.Pq.Zero(),1);let h,u,d,p,f=1/0;const m=s.AA.Vector3[2],_=s.AA.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),s.Pq.TransformCoordinatesToRef(t.center,_,m);for(let i=0;i<r.length;i++)r[i].projectToRef(m,e._positions,e.getIndices(),l),s.Pq.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),h=s.Pq.Distance(l,t.center),d=s.Pq.Distance(l,e.getAbsolutePosition()),u=s.Pq.Distance(t.center,e.getAbsolutePosition()),-1!==u&&-1!==d&&d>u&&(h=0,l.copyFrom(t.center)),-1!==h&&h<f&&(f=h,Ii.Rl.CreateFromToToRef(t.center,l,c),c.length=2*f,p=c.intersectsMesh(e),o.copyFrom(l));return f<t.radius&&(n.hit=!0,n.distance=f,n.pickedMesh=e,n.pickedPoint=o.clone(),p&&null!==p.bu&&null!==p.bv&&(n.faceId=p.faceId,n.subMeshId=p.subMeshId,n.bu=p.bu,n.bv=p.bv)),n}}cc._IdCounter=200,cc.Name=nl._.NEAR_INTERACTION,cc.Version=1,nl.n.AddWebXRFeature(cc.Name,((e,t)=>()=>new cc(e,t)),cc.Version,!0);class hc{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class uc{}class dc{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new n.cP,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw re.S0.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor";let r=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";r+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const n=document.createElement("style");n.appendChild(document.createTextNode(r)),document.getElementsByTagName("head")[0].appendChild(n);const s=document.createElement("button");s.className="babylonVRicon",s.title=`${e} - ${i}`,this._buttons.push(new hc(s,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",s.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map((t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode)));e.onStateChangedObservable.add((e=>{3==e&&this._updateButtons(null)})),(await Promise.all(i)).forEach(((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):re.S0.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)}))}static async CreateAsync(e,t,i){const r=new dc(e,i);return await r.setHelperAsync(t,i.renderTarget||void 0),r}async _enterXRWithButtonIndex(e=0){if(2==this._helper.state)await this._helper.exitXRAsync(),this._updateButtons(null);else if(3==this._helper.state)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach((e=>{e.update(this._activeButton)})),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var pc,fc,mc=i(29206),_c=i(53318);!function(e){e.WRIST="wrist",e.THUMB="thumb",e.INDEX="index",e.MIDDLE="middle",e.RING="ring",e.LITTLE="little"}(pc||(pc={})),function(e){e.WRIST="wrist",e.THUMB_METACARPAL="thumb-metacarpal",e.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",e.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",e.THUMB_TIP="thumb-tip",e.INDEX_FINGER_METACARPAL="index-finger-metacarpal",e.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",e.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",e.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",e.INDEX_FINGER_TIP="index-finger-tip",e.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",e.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",e.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",e.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",e.MIDDLE_FINGER_TIP="middle-finger-tip",e.RING_FINGER_METACARPAL="ring-finger-metacarpal",e.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",e.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",e.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",e.RING_FINGER_TIP="ring-finger-tip",e.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",e.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",e.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",e.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",e.PINKY_FINGER_TIP="pinky-finger-tip"}(fc||(fc={}));const gc=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],vc={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]};class Sc{get handMesh(){return this._handMesh}getHandPartMeshes(e){return vc[e].map((e=>this._jointMeshes[gc.indexOf(e)]))}getJointMesh(e){return this._jointMeshes[gc.indexOf(e)]}constructor(e,t,i,r,a=!1,o=!1,l=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=a,this._jointsInvisible=o,this._jointScaleFactor=l,this.onHandMeshSetObservable=new n.cP,this._jointTransforms=new Array(gc.length),this._jointTransformMatrices=new Float32Array(16*gc.length),this._tempJointMatrix=new s.uq,this._jointRadii=new Float32Array(gc.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)this._jointTransforms[e]=new ui.V(gc[e],this._scene),this._jointTransforms[e].rotationQuaternion=new s.PT,t[e].rotationQuaternion?t[e].rotationQuaternion=new s.PT:t[e].rotationQuaternion?.set(0,0,0,1);i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add((e=>{e._doNotLoadControllerMesh=!0}))}setHandMesh(e,t,i){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach((e=>{e.alwaysSelectAsActiveMesh=!0})),this._handMesh.skeleton){const e=this._handMesh.skeleton;gc.forEach(((i,r)=>{const n=e.getBoneIndexByName(t?t[i]:i);-1!==n&&e.bones[n].linkTransformNode(this._jointTransforms[r])}))}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const r=i,n=gc.map((e=>r[e]||i.get(e)));let a=!1;if(e.fillPoses&&e.fillJointRadii)a=e.fillPoses(n,t,this._jointTransformMatrices)&&e.fillJointRadii(n,this._jointRadii);else if(e.getJointPose){a=!0;for(let i=0;i<n.length;i++){const r=e.getJointPose(n[i],t);if(!r){a=!1;break}this._jointTransformMatrices.set(r.transform.matrix,16*i),this._jointRadii[i]=r.radius||.008}}a&&(gc.forEach(((e,t)=>{const i=this._jointTransforms[t];s.uq.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);const r=this._jointRadii[t]*this._jointScaleFactor,n=this._jointMeshes[t];n.isVisible=!this._handMesh&&!this._jointsInvisible,n.position.copyFrom(i.position),n.rotationQuaternion.copyFrom(i.rotationQuaternion),n.scaling.setAll(r),this._scene.useRightHandedSystem||(n.position.z*=-1,n.rotationQuaternion.z*=-1,n.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))})),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1),this._jointTransforms.forEach((e=>e.dispose())),this._jointTransforms.length=0,this.onHandMeshSetObservable.clear()}}class xc extends gl{static _GenerateTrackedJointMeshes(e,t=(0,_c.Ds)("jointParent",xc._ICOSPHERE_PARAMS)){const i={};return["left","right"].map((r=>{const n=[];t.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let i=0;i<gc.length;++i){let a=t.createInstance(`${r}-handJoint-${i}`);if(e.jointMeshes?.onHandJointMeshGenerated){const t=e.jointMeshes.onHandJointMeshGenerated(a,i,r);t&&t!==a&&(a.dispose(),a=t)}if(a.isPickable=!1,e.jointMeshes?.enablePhysics){const t=e.jointMeshes?.physicsProps||{};a.scaling.setAll(.02);const i=void 0!==t.impostorType?t.impostorType:mc.j.SphereImpostor;a.physicsImpostor=new mc.j(a,i,{mass:0,...t})}a.rotationQuaternion=new s.PT,a.isVisible=!1,n.push(a)}i[r]=n})),{left:i.left,right:i.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return new Promise((async r=>{const n={};xc._RightHandGLB?.meshes[1]?.isDisposed()&&(xc._RightHandGLB=null),xc._LeftHandGLB?.meshes[1]?.isDisposed()&&(xc._LeftHandGLB=null);const s=!(!xc._RightHandGLB||!xc._LeftHandGLB),o=await Promise.all([xc._RightHandGLB||ol.cn.ImportMeshAsync("",xc.DEFAULT_HAND_MODEL_BASE_URL,xc.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),xc._LeftHandGLB||ol.cn.ImportMeshAsync("",xc.DEFAULT_HAND_MODEL_BASE_URL,xc.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);xc._RightHandGLB=o[0],xc._LeftHandGLB=o[1];const l=await sc.ParseFromFileAsync("handShader",xc.DEFAULT_HAND_MODEL_SHADER_URL,e,void 0,!0);l.needDepthPrePass=!0,l.transparencyMode=Zl.i.MATERIAL_ALPHABLEND,l.alphaMode=2,l.build(!1);const c={base:a.v9.FromInts(116,63,203),fresnel:a.v9.FromInts(149,102,229),fingerColor:a.v9.FromInts(177,130,255),tipFresnel:a.v9.FromInts(220,200,255),...i?.handMeshes?.customColors},h={base:l.getBlockByName("baseColor"),fresnel:l.getBlockByName("fresnelColor"),fingerColor:l.getBlockByName("fingerColor"),tipFresnel:l.getBlockByName("tipFresnelColor")};h.base.value=c.base,h.fresnel.value=c.fresnel,h.fingerColor.value=c.fingerColor,h.tipFresnel.value=c.tipFresnel;const u=t._getBaseLayerWrapper()?.isMultiview;["left","right"].forEach((t=>{const r="left"==t?xc._LeftHandGLB:xc._RightHandGLB;if(!r)throw new Error("Could not load hand model");const a=r.meshes[1];a._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,u||i?.handMeshes?.disableHandShader||(a.material=l.clone(`${t}HandShaderClone`,!0)),a.isVisible=!1,n[t]=a,s||e.useRightHandedSystem||r.meshes[1].rotate(ke._0.Y,Math.PI)})),l.dispose(),r({left:n.left,right:n.right})}))}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new n.cP,this.onHandRemovedObservable=new n.cP,this._attachHand=e=>{if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;const t=e.inputSource.handedness,i=new Sc(e,this._handResources.jointMeshes[t],this._handResources.handMeshes&&this._handResources.handMeshes[t],this._handResources.rigMappings&&this._handResources.rigMappings[t],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[e.uniqueId]=i,this._trackingHands[t]=i,this.onHandAddedObservable.notifyObservers(i)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";const i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};const e={},r={};[[i.rigMapping.left,e],[i.rigMapping.right,r]].forEach((e=>{const t=e[0],i=e[1];t.forEach(((e,t)=>{i[gc[t]]=e}))})),t.handMeshes.customRigMappings={left:e,right:r}}}attach(){return!!super.attach()&&(this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||this.options.jointMeshes?.sourceMesh||(0,_c.Ds)("jointParent",xc._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=xc._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=this.options.handMeshes?.customMeshes||null,this._handResources.rigMappings=this.options.handMeshes?.customRigMappings||null,this.options.handMeshes?.customMeshes||this.options.handMeshes?.disableDefaultMeshes||(xc._GenerateDefaultHandMeshesAsync(P.q.LastCreatedScene,this._xrSessionManager,this.options).then((e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:xc._GenerateDefaultHandMeshRigMapping("left"),right:xc._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)})),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add((e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))}))),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e,t){const i=this.getHandByControllerId(e);if(i){const r="left"==i.xrController.inputSource.handedness?"left":"right";this._trackingHands[r]?.xrController.uniqueId===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach((e=>this._detachHandById(e,this.options.handMeshes?.disposeOnSessionEnd))),this.options.handMeshes?.disposeOnSessionEnd&&(this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())),this._handResources.jointMeshes=null),this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),xc._RightHandGLB?.meshes.forEach((e=>e.dispose())),xc._LeftHandGLB?.meshes.forEach((e=>e.dispose())),xc._RightHandGLB=null,xc._LeftHandGLB=null,this._originalMesh?.dispose(),this._originalMesh=void 0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0)}dispose(){super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),xc._RightHandGLB?.meshes.forEach((e=>e.dispose())),xc._LeftHandGLB?.meshes.forEach((e=>e.dispose())),xc._RightHandGLB=null,xc._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())))}}xc.Name=nl._.HAND_TRACKING,xc.Version=1,xc.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",xc.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",xc.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",xc.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",xc._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},xc._RightHandGLB=null,xc._LeftHandGLB=null,nl.n.AddWebXRFeature(xc.Name,((e,t)=>()=>new xc(e,t)),xc.Version,!1);var Tc=i(18988);class Ec extends gl{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,(e=>"rotationCone"===e.name));t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new a.ov(1,1,1,1),this._tmpRay=new Ii.Rl(new s.Pq,new s.Pq),this._tmpVector=new s.Pq,this._tmpQuaternion=new s.PT,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new n.cP,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new n.cP,this.onAfterCameraTeleportRotation=new n.cP,this._attachController=e=>{if(this._controllers[e.uniqueId]||this._options.forceHandedness&&e.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[e.uniqueId]={xrController:e,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController){const i=e.motionController.getComponentOfType(al.THUMBSTICK_TYPE)||e.motionController.getComponentOfType(al.TOUCHPAD_TYPE);if(!i||this._options.useMainComponentOnly){const i=e.motionController.getMainComponent();if(!i)return;t.teleportationState.mainComponentUsed=!0,t.teleportationComponent=i,t.onButtonChangedObserver=i.onButtonStateChangedObservable.add((()=>{if(!this.teleportationEnabled)return;const r=()=>{t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0;const r=this._options.timeToTeleport||3e3;(0,Tc.fj)({timeout:r,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!i.pressed,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};i.changes.pressed&&(i.changes.pressed.current?this._options.timeToTeleportStart?(0,Tc.fj)({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{i.pressed&&r()}}):r():(t.teleportationState.forward=!1,this._currentTeleportationControllerId=""))}))}else t.teleportationComponent=i,t.onAxisChangedObserver=i.onAxisValueChangedObservable.add((i=>{if(i.y<=.7&&t.teleportationState.backwards&&(t.teleportationState.backwards=!1),i.y>.7&&!t.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!t.teleportationState.backwards){t.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,s.PT.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const e=this._xrSessionManager.scene.pickWithRay(this._tmpRay,(e=>-1!==this._floorMeshes.indexOf(e)));e&&e.pickedPoint&&(this._options.xrInput.xrCamera.position.x=e.pickedPoint.x,this._options.xrInput.xrCamera.position.z=e.pickedPoint.z)}if(i.y<-.7&&!this._currentTeleportationControllerId&&!t.teleportationState.rotating&&this.teleportationEnabled&&(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),i.x){if(t.teleportationState.forward)this._currentTeleportationControllerId===t.xrController.uniqueId&&(this.rotationEnabled?setTimeout((()=>{t.teleportationState.currentRotation=Math.atan2(i.x,i.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))})):t.teleportationState.currentRotation=0);else if(!t.teleportationState.rotating&&Math.abs(i.x)>.7){t.teleportationState.rotating=!0;const e=this.rotationAngle*(i.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(e),s.PT.FromEulerAngles(0,e,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else t.teleportationState.rotating=!1;0===i.x&&0===i.y&&(t.teleportationState.blocked&&(t.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),t.teleportationState.forward&&this._teleportForward(e.uniqueId))}))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}else{t.teleportationState.mainComponentUsed=!0;let i=!1;const r=()=>{this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0;const i=this._options.timeToTeleport||3e3;(0,Tc.fj)({timeout:i,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add((e=>{e.type===xe.Zp.POINTERDOWN?(i=!1,this._options.timeToTeleportStart?(0,Tc.fj)({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&r()},breakCondition:()=>!!i&&(i=!1,!0)}):r()):e.type===xe.Zp.POINTERUP&&(i=!0,t.teleportationState.forward=!1,this._currentTeleportationControllerId="")}))}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new a.ov(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add((e=>{this.parabolicCheckRadius=this.parabolicCheckRadius/e.previousScaleFactor*e.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor)}))}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),this.onTargetMeshPositionUpdatedObservable.clear(),this.onTargetMeshPositionUpdatedObservable.clear(),this.onBeforeCameraTeleportRotation.clear(),this.onAfterCameraTeleportRotation.clear(),this.onBeforeCameraTeleport.clear(),this.onAfterCameraTeleport.clear()}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t)for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}return-1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new s.PT;const e=this._controllers[this._currentTeleportationControllerId];if(e&&e.teleportationState.forward){s.PT.RotationYawPitchRollToRef(e.teleportationState.currentRotation+e.teleportationState.baseRotation,0,0,r.rotationQuaternion);let t=!1;const n="transient-pointer"!==e.xrController.inputSource.targetRayMode;if(e.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const r=i.pickWithRay(this._tmpRay,(e=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(e))return!0;if(this._options.blockAllPickableMeshes&&e.isPickable)return!0;if(this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e))return!0;const t=this._floorMeshes.indexOf(e);return-1!==t&&this._floorMeshes[t].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y})),s=r&&r.pickedMesh&&-1!==this._floorMeshes.indexOf(r.pickedMesh);if(r&&r.pickedMesh&&!s)return e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit?void(e.teleportationState.forward=!1):(e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,n),void this._showParabolicPath(r));r&&r.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(r),this._setTargetMeshVisibility(!0,!1,n),this._showParabolicPath(r))}if(this.parabolicRayEnabled&&!t){const r=e.xrController.pointer.rotationQuaternion.toEulerAngles().x,s=Math.PI/2-Math.abs(r)+1,a=this.parabolicCheckRadius*s;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*a),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(a)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const o=i.pickWithRay(this._tmpRay,(e=>!(!this._options.blockerMeshesPredicate||!this._options.blockerMeshesPredicate(e))||!(!this._options.blockAllPickableMeshes||!e.isPickable)||!(!this._options.pickBlockerMeshes||-1===this._options.pickBlockerMeshes.indexOf(e))||-1!==this._floorMeshes.indexOf(e))),l=o&&o.pickedMesh&&-1!==this._floorMeshes.indexOf(o.pickedMesh);if(o&&o.pickedMesh&&!l)return e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit?void(e.teleportationState.forward=!1):(e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,n),void this._showParabolicPath(o));o&&o.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(o),this._setTargetMeshVisibility(!0,!1,n),this._showParabolicPath(o))}this._setTargetMeshVisibility(t,!1,n)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=(0,Hi.km)("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const i=512,r=new Ni.R("teleportationPlaneDynamicTexture",i,e,!0);r.hasAlpha=!0;const n=r.getContext(),s=i/2,a=i/2,o=200;n.beginPath(),n.arc(s,a,o,0,2*Math.PI,!1),n.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",n.fill(),n.lineWidth=10,n.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",n.stroke(),n.closePath(),r.update();const l=new Oi.F("teleportationPlaneMaterial",e);l.diffuseTexture=r,t.material=l}const i=(0,Yi.YA)("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const t=new M.X5("animationInnerCircle","position.y",30,M.X5.ANIMATIONTYPE_FLOAT,M.X5.ANIMATIONLOOPMODE_CYCLE),r=[];r.push({frame:0,value:0}),r.push({frame:30,value:.4}),r.push({frame:60,value:0}),t.setKeys(r);const n=new X;n.setEasingMode(L.EASINGMODE_EASEINOUT),t.setEasingFunction(n),i.animations=[],i.animations.push(t),e.beginAnimation(i,0,60,!0)}const r=(0,ho.zk)("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(ke._0.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const t=new Oi.F("torusConsMat",e);t.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,t.disableLighting?t.emissiveColor=new a.v9(.3,.3,1):t.diffuseColor=new a.v9(.3,.3,1),t.alpha=.9,i.material=t,r.material=t,this._teleportationRingMaterial=t}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){const n=t*t;this._snapToPositions.forEach((t=>{const a=s.Pq.DistanceSquared(t,e);a<=n&&a<r&&(r=a,i=t)}))}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible!==e||t)&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach((t=>{t.isVisible=e})),e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||po.j.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=F.jj.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),n=i.teleportationState.blocked?this._blockedRayColor:void 0,s=this._colorArray.fill(n||this._cachedColor4White),a=r.getPoints();a.shift(),a.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=(0,_o.sh)("teleportation path line",{points:a,instance:this._quadraticBezierCurve,updatable:!0,colors:s},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint))if(this.skipNextTeleportation)this.skipNextTeleportation=!1;else if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const e=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=e,s.PT.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}Ec.Name=nl._.TELEPORTATION,Ec.Version=1,nl.n.AddWebXRFeature(Ec.Name,((e,t)=>()=>new Ec(e,t)),Ec.Version,!0);class Cc{}class bc{constructor(){}static CreateAsync(e,t={}){const i=new bc;if(e.onDisposeObservable.addOnce((()=>{i.dispose()})),!t.disableDefaultUI){const r={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new dc(e,r)}return sl.CreateAsync(e).then((e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new _l(e.sessionManager,e.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const e={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(vl.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(Ec.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(cc.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(xc.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,...t.handSupportOptions},void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)})).then((()=>i)).catch((e=>(f.V.Error("Error initializing XR"),f.V.Error(e),i)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}var Pc=!0;function yc(e){for(;e.firstChild;)e.removeChild(e.firstChild);e.srcObject=null,e.src="",e.removeAttribute("src")}kt.Z.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new Ro.g("default light",s.Pq.Up(),this)},kt.Z.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const t=this.getWorldExtends((e=>e.isVisible&&e.isEnabled())),r=t.max.subtract(t.min),n=t.min.add(r.scale(.5));let a,o=1.5*r.length();if(isFinite(o)||(o=1,n.copyFromFloats(0,0,0)),e){const e=new It("default camera",-Math.PI/2,Math.PI/2,o,n,this);e.lowerRadiusLimit=.01*o,e.wheelPrecision=100/o,a=e}else{const e=new Pt.S("default camera",new s.Pq(n.x,n.y,-o),this);e.setTarget(n),a=e}a.minZ=.01*o,a.maxZ=1e3*o,a.speed=.2*o,this.activeCamera=a,i&&a.attachControl()}},kt.Z.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},kt.Z.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,r=0,n=!0){if(!e)return f.V.Warn("Can not create default skybox without environment texture."),null;n&&e&&(this.environmentTexture=e);const s=(0,co.an)("hdrSkyBox",{size:i},this);if(t){const t=new Jo.Y("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=_e.g.SKYBOX_MODE),t.microSurface=1-r,t.disableLighting=!0,t.twoSidedLighting=!0,s.material=t}else{const t=new Oi.F("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=_e.g.SKYBOX_MODE),t.disableLighting=!0,s.material=t}return s.isPickable=!1,s.infiniteDistance=!0,s.ignoreCameraMaxZ=!0,s},kt.Z.prototype.createDefaultEnvironment=function(e){return Ko?new Ko(e,this):null},kt.Z.prototype.createDefaultVRExperience=function(e={}){return new ji(this,e)},kt.Z.prototype.createDefaultXRExperienceAsync=function(e={}){return bc.CreateAsync(this,e).then((e=>e))};class Ac extends _e.g{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new n.cP),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e?.message):f.V.Error(e?.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch((e=>{if("NotAllowedError"===e?.name){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers())return void this._onUserActionRequestedObservable.notifyObservers(this);if(!this.video.muted)return f.V.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,void this.video.play().catch((e=>{this._processError(e)}))}this._processError(e)}))}constructor(e,t,i,r=!1,n=!1,s=_e.g.TRILINEAR_SAMPLINGMODE,a={},o,l=5){super(null,i,!r,n),this._externalTexture=null,this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{null!=this._texture&&this._texture.dispose(),!this._getEngine().needPOTTextures||re.S0.IsExponentOfTwo(this.video.videoWidth)&&re.S0.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=_e.g.WRAP_ADDRESSMODE,this.wrapV=_e.g.WRAP_ADDRESSMODE):(this.wrapU=_e.g.CLAMP_ADDRESSMODE,this.wrapV=_e.g.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=this._format??5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(null!=this._texture){if(!this._displayingPosterTexture)return;this._displayingPosterTexture=!1}if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),this.video.autoplay||this._settings.poster||this._settings.independentVideoSource)this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{const e=this.video.onplaying,t=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=t,this.video.onplaying=e,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}},this._reset=()=>{null!=this._texture&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(null==this._texture)return;if(this.video.readyState<this.video.HAVE_CURRENT_DATA)return;if(this._displayingPosterTexture)return;const e=this.getScene().getFrameId();this._frameId!==e&&(this._frameId=e,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...a},this._onError=o,this._generateMipMaps=r,this._initialSamplingMode=s,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t);const c=this._engine,h=c?.createExternalTexture;h&&(this._externalTexture=h.call(c,this.video)),this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),void 0!==this._settings.autoPlay&&(this.video.autoplay=this._settings.autoPlay),void 0!==this._settings.loop&&(this.video.loop=this._settings.loop),void 0!==this._settings.muted&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("loadeddata",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=l;const u=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this._settings.poster||this._settings.autoPlay&&u?u&&this._createInternalTexture():(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0)}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:"object"==typeof e?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return re.S0.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return"string"==typeof e?(re.S0.SetCorsBehavior(e,t),t.src=e):(re.S0.SetCorsBehavior(e[0],t),e.forEach((e=>{const i=document.createElement("source");i.src=e,t.appendChild(i)}))),this.onDisposeObservable.addOnce((()=>{yc(t)})),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new Ac(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("loadeddata",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),this._externalTexture?.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){const n=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(n),n.style.transform="scale(0.0001, 0.0001)",n.style.opacity="0",n.style.position="fixed",n.style.bottom="0px",n.style.right="0px"),n.setAttribute("autoplay",""),n.setAttribute("muted","true"),n.setAttribute("playsinline",""),n.muted=!0,n.isNative||("object"==typeof n.srcObject?n.srcObject=t:n.src=window.URL&&window.URL.createObjectURL(t)),new Promise((t=>{const i=()=>{const s=new Ac("video",n,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&s.onDisposeObservable.addOnce((()=>{n.remove()})),s.onDisposeObservable.addOnce((()=>{yc(n)})),t(s),n.removeEventListener("playing",i)};n.addEventListener("playing",i),n.play()}))}static async CreateFromWebCamAsync(e,t,i=!1,r=!0){if(navigator.mediaDevices){const n=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),s=await this.CreateFromStreamAsync(e,n,t,r);return s.onDisposeObservable.addOnce((()=>{n.getTracks().forEach((e=>{e.stop()}))})),s}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,r=!1,n=!0){this.CreateFromWebCamAsync(e,i,r,n).then((function(e){t&&t(e)})).catch((function(e){f.V.Error(e.name)}))}}(0,ue.Cg)([(0,de.lK)("settings")],Ac.prototype,"_settings",void 0),(0,ue.Cg)([(0,de.lK)("src")],Ac.prototype,"_currentSrc",void 0),(0,ue.Cg)([(0,de.lK)()],Ac.prototype,"isVideo",void 0),_e.g._CreateVideoTexture=(e,t,i,r=!1,n=!1,s=_e.g.TRILINEAR_SAMPLINGMODE,a={},o,l=5)=>new Ac(e,t,i,r,n,s,a,o,l),(0,o.Y5)("BABYLON.VideoTexture",Ac);class Rc extends Zo{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const r={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},n=new Ac((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,_e.g.TRILINEAR_SAMPLINGMODE,r);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add((e=>{e.pickInfo?.pickedMesh===this.mesh&&this._texture.video.play()}),xe.Zp.POINTERDOWN)),this._textureObserver=n.onLoadObservable.add((()=>{this.onLoadObservable.notifyObservers()})),n}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}Rc.MODE_MONOSCOPIC=Zo.MODE_MONOSCOPIC,Rc.MODE_TOPBOTTOM=Zo.MODE_TOPBOTTOM,Rc.MODE_SIDEBYSIDE=Zo.MODE_SIDEBYSIDE;class Ic{get gpuFrameTimeCounter(){return this.engine.getGPUFrameTimeCounter()}get captureGPUFrameTime(){return this._captureGPUFrameTime}set captureGPUFrameTime(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,this.engine.captureGPUFrameTime(e))}get shaderCompilationTimeCounter(){return this._shaderCompilationTime}get captureShaderCompilationTime(){return this._captureShaderCompilationTime}set captureShaderCompilationTime(e){e!==this._captureShaderCompilationTime&&(this._captureShaderCompilationTime=e,e?(this._onBeforeShaderCompilationObserver=this.engine.onBeforeShaderCompilationObservable.add((()=>{this._shaderCompilationTime.fetchNewFrame(),this._shaderCompilationTime.beginMonitoring()})),this._onAfterShaderCompilationObserver=this.engine.onAfterShaderCompilationObservable.add((()=>{this._shaderCompilationTime.endMonitoring()}))):(this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null))}constructor(e){this.engine=e,this._captureGPUFrameTime=!1,this._captureShaderCompilationTime=!1,this._shaderCompilationTime=new Gr.A,this._onBeginFrameObserver=null,this._onEndFrameObserver=null,this._onBeforeShaderCompilationObserver=null,this._onAfterShaderCompilationObserver=null}dispose(){this.engine.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.engine.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null,this.engine.onBeforeShaderCompilationObservable.remove(this._onBeforeShaderCompilationObserver),this._onBeforeShaderCompilationObserver=null,this.engine.onAfterShaderCompilationObservable.remove(this._onAfterShaderCompilationObserver),this._onAfterShaderCompilationObserver=null,this.engine=null}}class Mc{get activeMeshesEvaluationTimeCounter(){return this._activeMeshesEvaluationTime}get captureActiveMeshesEvaluationTime(){return this._captureActiveMeshesEvaluationTime}set captureActiveMeshesEvaluationTime(e){e!==this._captureActiveMeshesEvaluationTime&&(this._captureActiveMeshesEvaluationTime=e,e?(this._onBeforeActiveMeshesEvaluationObserver=this.scene.onBeforeActiveMeshesEvaluationObservable.add((()=>{re.S0.StartPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.beginMonitoring()})),this._onAfterActiveMeshesEvaluationObserver=this.scene.onAfterActiveMeshesEvaluationObservable.add((()=>{re.S0.EndPerformanceCounter("Active meshes evaluation"),this._activeMeshesEvaluationTime.endMonitoring(!1)}))):(this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null))}get renderTargetsRenderTimeCounter(){return this._renderTargetsRenderTime}get captureRenderTargetsRenderTime(){return this._captureRenderTargetsRenderTime}set captureRenderTargetsRenderTime(e){e!==this._captureRenderTargetsRenderTime&&(this._captureRenderTargetsRenderTime=e,e?(this._onBeforeRenderTargetsRenderObserver=this.scene.onBeforeRenderTargetsRenderObservable.add((()=>{re.S0.StartPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.beginMonitoring()})),this._onAfterRenderTargetsRenderObserver=this.scene.onAfterRenderTargetsRenderObservable.add((()=>{re.S0.EndPerformanceCounter("Render targets rendering"),this._renderTargetsRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null))}get particlesRenderTimeCounter(){return this._particlesRenderTime}get captureParticlesRenderTime(){return this._captureParticlesRenderTime}set captureParticlesRenderTime(e){e!==this._captureParticlesRenderTime&&(this._captureParticlesRenderTime=e,e?(this._onBeforeParticlesRenderingObserver=this.scene.onBeforeParticlesRenderingObservable.add((()=>{re.S0.StartPerformanceCounter("Particles"),this._particlesRenderTime.beginMonitoring()})),this._onAfterParticlesRenderingObserver=this.scene.onAfterParticlesRenderingObservable.add((()=>{re.S0.EndPerformanceCounter("Particles"),this._particlesRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null))}get spritesRenderTimeCounter(){return this._spritesRenderTime}get captureSpritesRenderTime(){return this._captureSpritesRenderTime}set captureSpritesRenderTime(e){e!==this._captureSpritesRenderTime&&(this._captureSpritesRenderTime=e,this.scene.spriteManagers&&(e?(this._onBeforeSpritesRenderingObserver=this.scene.onBeforeSpritesRenderingObservable.add((()=>{re.S0.StartPerformanceCounter("Sprites"),this._spritesRenderTime.beginMonitoring()})),this._onAfterSpritesRenderingObserver=this.scene.onAfterSpritesRenderingObservable.add((()=>{re.S0.EndPerformanceCounter("Sprites"),this._spritesRenderTime.endMonitoring(!1)}))):(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null,this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null)))}get physicsTimeCounter(){return this._physicsTime}get capturePhysicsTime(){return this._capturePhysicsTime}set capturePhysicsTime(e){e!==this._capturePhysicsTime&&this.scene.onBeforePhysicsObservable&&(this._capturePhysicsTime=e,e?(this._onBeforePhysicsObserver=this.scene.onBeforePhysicsObservable.add((()=>{re.S0.StartPerformanceCounter("Physics"),this._physicsTime.beginMonitoring()})),this._onAfterPhysicsObserver=this.scene.onAfterPhysicsObservable.add((()=>{re.S0.EndPerformanceCounter("Physics"),this._physicsTime.endMonitoring()}))):(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null,this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null))}get animationsTimeCounter(){return this._animationsTime}get captureAnimationsTime(){return this._captureAnimationsTime}set captureAnimationsTime(e){e!==this._captureAnimationsTime&&(this._captureAnimationsTime=e,e?this._onAfterAnimationsObserver=this.scene.onAfterAnimationsObservable.add((()=>{this._animationsTime.endMonitoring()})):(this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null))}get frameTimeCounter(){return this._frameTime}get captureFrameTime(){return this._captureFrameTime}set captureFrameTime(e){this._captureFrameTime=e}get interFrameTimeCounter(){return this._interFrameTime}get captureInterFrameTime(){return this._captureInterFrameTime}set captureInterFrameTime(e){this._captureInterFrameTime=e}get renderTimeCounter(){return this._renderTime}get captureRenderTime(){return this._captureRenderTime}set captureRenderTime(e){e!==this._captureRenderTime&&(this._captureRenderTime=e,e?(this._onBeforeDrawPhaseObserver=this.scene.onBeforeDrawPhaseObservable.add((()=>{this._renderTime.beginMonitoring(),re.S0.StartPerformanceCounter("Main render")})),this._onAfterDrawPhaseObserver=this.scene.onAfterDrawPhaseObservable.add((()=>{this._renderTime.endMonitoring(!1),re.S0.EndPerformanceCounter("Main render")}))):(this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null))}get cameraRenderTimeCounter(){return this._cameraRenderTime}get captureCameraRenderTime(){return this._captureCameraRenderTime}set captureCameraRenderTime(e){e!==this._captureCameraRenderTime&&(this._captureCameraRenderTime=e,e?(this._onBeforeCameraRenderObserver=this.scene.onBeforeCameraRenderObservable.add((e=>{this._cameraRenderTime.beginMonitoring(),re.S0.StartPerformanceCounter(`Rendering camera ${e.name}`)})),this._onAfterCameraRenderObserver=this.scene.onAfterCameraRenderObservable.add((e=>{this._cameraRenderTime.endMonitoring(!1),re.S0.EndPerformanceCounter(`Rendering camera ${e.name}`)}))):(this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null))}get drawCallsCounter(){return this.scene.getEngine()._drawCalls}constructor(e){this.scene=e,this._captureActiveMeshesEvaluationTime=!1,this._activeMeshesEvaluationTime=new Gr.A,this._captureRenderTargetsRenderTime=!1,this._renderTargetsRenderTime=new Gr.A,this._captureFrameTime=!1,this._frameTime=new Gr.A,this._captureRenderTime=!1,this._renderTime=new Gr.A,this._captureInterFrameTime=!1,this._interFrameTime=new Gr.A,this._captureParticlesRenderTime=!1,this._particlesRenderTime=new Gr.A,this._captureSpritesRenderTime=!1,this._spritesRenderTime=new Gr.A,this._capturePhysicsTime=!1,this._physicsTime=new Gr.A,this._captureAnimationsTime=!1,this._animationsTime=new Gr.A,this._captureCameraRenderTime=!1,this._cameraRenderTime=new Gr.A,this._onBeforeActiveMeshesEvaluationObserver=null,this._onAfterActiveMeshesEvaluationObserver=null,this._onBeforeRenderTargetsRenderObserver=null,this._onAfterRenderTargetsRenderObserver=null,this._onAfterRenderObserver=null,this._onBeforeDrawPhaseObserver=null,this._onAfterDrawPhaseObserver=null,this._onBeforeAnimationsObserver=null,this._onBeforeParticlesRenderingObserver=null,this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver=null,this._onAfterSpritesRenderingObserver=null,this._onBeforePhysicsObserver=null,this._onAfterPhysicsObserver=null,this._onAfterAnimationsObserver=null,this._onBeforeCameraRenderObserver=null,this._onAfterCameraRenderObserver=null,this._onBeforeAnimationsObserver=e.onBeforeAnimationsObservable.add((()=>{this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.fetchNewFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.fetchNewFrame(),this._captureFrameTime&&(re.S0.StartPerformanceCounter("Scene rendering"),this._frameTime.beginMonitoring()),this._captureInterFrameTime&&this._interFrameTime.endMonitoring(),this._captureParticlesRenderTime&&this._particlesRenderTime.fetchNewFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.fetchNewFrame(),this._captureAnimationsTime&&this._animationsTime.beginMonitoring(),this._captureRenderTime&&this._renderTime.fetchNewFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.fetchNewFrame(),this.scene.getEngine()._drawCalls.fetchNewFrame()})),this._onAfterRenderObserver=e.onAfterRenderObservable.add((()=>{this._captureFrameTime&&(re.S0.EndPerformanceCounter("Scene rendering"),this._frameTime.endMonitoring()),this._captureRenderTime&&this._renderTime.endMonitoring(!1),this._captureInterFrameTime&&this._interFrameTime.beginMonitoring(),this._captureActiveMeshesEvaluationTime&&this._activeMeshesEvaluationTime.endFrame(),this._captureRenderTargetsRenderTime&&this._renderTargetsRenderTime.endFrame(),this._captureParticlesRenderTime&&this._particlesRenderTime.endFrame(),this._captureSpritesRenderTime&&this._spritesRenderTime.endFrame(),this._captureRenderTime&&this._renderTime.endFrame(),this._captureCameraRenderTime&&this._cameraRenderTime.endFrame()}))}dispose(){this.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=null,this.scene.onBeforeActiveMeshesEvaluationObservable.remove(this._onBeforeActiveMeshesEvaluationObserver),this._onBeforeActiveMeshesEvaluationObserver=null,this.scene.onAfterActiveMeshesEvaluationObservable.remove(this._onAfterActiveMeshesEvaluationObserver),this._onAfterActiveMeshesEvaluationObserver=null,this.scene.onBeforeRenderTargetsRenderObservable.remove(this._onBeforeRenderTargetsRenderObserver),this._onBeforeRenderTargetsRenderObserver=null,this.scene.onAfterRenderTargetsRenderObservable.remove(this._onAfterRenderTargetsRenderObserver),this._onAfterRenderTargetsRenderObserver=null,this.scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.scene.onBeforeParticlesRenderingObservable.remove(this._onBeforeParticlesRenderingObserver),this._onBeforeParticlesRenderingObserver=null,this.scene.onAfterParticlesRenderingObservable.remove(this._onAfterParticlesRenderingObserver),this._onAfterParticlesRenderingObserver=null,this._onBeforeSpritesRenderingObserver&&(this.scene.onBeforeSpritesRenderingObservable.remove(this._onBeforeSpritesRenderingObserver),this._onBeforeSpritesRenderingObserver=null),this._onAfterSpritesRenderingObserver&&(this.scene.onAfterSpritesRenderingObservable.remove(this._onAfterSpritesRenderingObserver),this._onAfterSpritesRenderingObserver=null),this.scene.onBeforeDrawPhaseObservable.remove(this._onBeforeDrawPhaseObserver),this._onBeforeDrawPhaseObserver=null,this.scene.onAfterDrawPhaseObservable.remove(this._onAfterDrawPhaseObserver),this._onAfterDrawPhaseObserver=null,this._onBeforePhysicsObserver&&(this.scene.onBeforePhysicsObservable.remove(this._onBeforePhysicsObserver),this._onBeforePhysicsObserver=null),this._onAfterPhysicsObserver&&(this.scene.onAfterPhysicsObservable.remove(this._onAfterPhysicsObserver),this._onAfterPhysicsObserver=null),this.scene.onAfterAnimationsObservable.remove(this._onAfterAnimationsObserver),this._onAfterAnimationsObserver=null,this.scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=null,this.scene.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=null,this.scene=null}}var Oc=i(60299);class Nc{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const r=e[i];t?this._materialForRendering[r.uniqueId]=[r,t]:delete this._materialForRendering[r.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){return this._effectIntensity[e.uniqueId]??1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t,i=!1){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new a.ov},this._effectIntensity={},this.neutralColor=new a.ov,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new n.cP,this.onBeforeRenderMainTextureObservable=new n.cP,this.onBeforeComposeObservable=new n.cP,this.onBeforeRenderMeshToEffect=new n.cP,this.onAfterRenderMeshToEffect=new n.cP,this.onAfterComposeObservable=new n.cP,this.onSizeChangedObservable=new n.cP,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=e,this._scene=t||P.q.LastCreatedScene,Nc._SceneComponentInitialization(this._scene),!this._scene.getEngine().isWebGPU||i||Nc.ForceGLSL||(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1,...e},this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new Ue.R(this._engine,e,Ue.R.PositionKind,!1,!1,2);this._vertexBuffers[Ue.R.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?(0,Tn.R)(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?(0,Tn.R)(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Si.$("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType,!1,_e.g.TRILINEAR_SAMPLINGMODE,!0,this._effectLayerOptions.generateStencilBuffer),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=_e.g.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=_e.g.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(_e.g.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],r=i.getMaterial(),n=i.getRenderingMesh();if(!r)continue;const s=n._getInstancesRenderList(i._id,!!i.getReplacementMesh()).hardwareInstancedRendering[i._id]||n.hasThinInstances;if(this._setEmissiveTextureAndColor(n,i,r),!this._isReady(i,s,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,r)=>{let n;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const s=this._scene.getEngine();if(r.length){for(s.setColorWrite(!1),n=0;n<r.length;n++)this._renderSubMesh(r.data[n]);s.setColorWrite(!0)}for(n=0;n<e.length;n++)this._renderSubMesh(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMesh(t.data[n]);const a=s.getAlphaMode();for(n=0;n<i.length;n++){const e=i.data[n],t=e.getMaterial();if(t&&t.needDepthPrePass){const i=t.getScene().getEngine();i.setColorWrite(!1),this._renderSubMesh(e),i.setColorWrite(!0)}this._renderSubMesh(e,!0)}s.setAlphaMode(a)},this._mainTexture.onClearObservable.add((e=>{e.clear(this.neutralColor,!0,!0,!0)})),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e})),this._mainTexture.onAfterUnbindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=e}))}}_addCustomEffectDefines(e){}_isReady(e,t,i){const r=this._scene.getEngine(),n=e.getMesh(),s=n._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];if(s)return s.isReadyForSubMesh(n,e,t);const a=e.getMaterial();if(!a)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return a.isReadyForSubMesh(e.getMesh(),e,t);const o=[],l=[Ue.R.PositionKind];let c=!1,h=!1;if(a){const e=a.needAlphaTesting(),t=a.getAlphaTestTexture(),i=t&&t.hasAlpha&&(a.useAlphaFromDiffuseTexture||a._useAlphaFromAlbedoTexture);t&&(e||i)&&(o.push("#define DIFFUSE"),n.isVerticesDataPresent(Ue.R.UV2Kind)&&1===t.coordinatesIndex?(o.push("#define DIFFUSEUV2"),h=!0):n.isVerticesDataPresent(Ue.R.UVKind)&&(o.push("#define DIFFUSEUV1"),c=!0),e&&(o.push("#define ALPHATEST"),o.push("#define ALPHATESTVALUE 0.4")),t.gammaSpace||o.push("#define DIFFUSE_ISLINEAR"));const r=a.opacityTexture;r&&(o.push("#define OPACITY"),n.isVerticesDataPresent(Ue.R.UV2Kind)&&1===r.coordinatesIndex?(o.push("#define OPACITYUV2"),h=!0):n.isVerticesDataPresent(Ue.R.UVKind)&&(o.push("#define OPACITYUV1"),c=!0))}i&&(o.push("#define EMISSIVE"),n.isVerticesDataPresent(Ue.R.UV2Kind)&&1===i.coordinatesIndex?(o.push("#define EMISSIVEUV2"),h=!0):n.isVerticesDataPresent(Ue.R.UVKind)&&(o.push("#define EMISSIVEUV1"),c=!0),i.gammaSpace||o.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(Ue.R.ColorKind)&&n.hasVertexAlpha&&a.transparencyMode!==Zl.i.MATERIAL_OPAQUE&&(l.push(Ue.R.ColorKind),o.push("#define VERTEXALPHA")),c&&(l.push(Ue.R.UVKind),o.push("#define UV1")),h&&(l.push(Ue.R.UV2Kind),o.push("#define UV2"));const u=new Yo.J;if(n.useBones&&n.computeBonesUsingShaders){l.push(Ue.R.MatricesIndicesKind),l.push(Ue.R.MatricesWeightsKind),n.numBoneInfluencers>4&&(l.push(Ue.R.MatricesIndicesExtraKind),l.push(Ue.R.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);const e=n.skeleton;e&&e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e?e.bones.length+1:0)),n.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,n)}else o.push("#define NUM_BONE_INFLUENCERS 0");const d=n.morphTargetManager;let p=0;d&&(p=d.numMaxInfluencers||d.numInfluencers,p>0&&(o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+p),d.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),(0,qo.MF)(l,n,p))),t&&(o.push("#define INSTANCES"),(0,qo.te)(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),(0,Xo.tv)(a,this._scene,o),this._addCustomEffectDefines(o);const f=e._getDrawWrapper(void 0,!0),m=f.defines,_=o.join("\n");if(m!==_){const e=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];(0,Xo.TV)(e),f.setEffect(this._engine.createEffect("glowMapGeneration",l,e,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],_,u,void 0,void 0,{maxSimultaneousMorphTargets:p},this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0}),_)}const g=f.effect.isReady();return this._arePostProcessAndMergeReady()&&g}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,66031)),Promise.resolve().then(i.bind(i,63205))]):await Promise.all([Promise.resolve().then(i.bind(i,45764)),Promise.resolve().then(i.bind(i,72206))])}_arePostProcessAndMergeReady(){let e=!0;for(let t=0;t<this._postProcesses.length;t++)e=this._postProcesses[t].isReady()&&e;const t=this._numInternalDraws();for(let i=0;i<t;++i){let t=this._mergeDrawWrapper[i];t||(t=this._mergeDrawWrapper[i]=new ec.E(this._engine),t.setEffect(this._createMergeEffect())),e=t.effect.isReady()&&e}return e}render(){if(!this._arePostProcessAndMergeReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();this.onBeforeComposeObservable.notifyObservers(this);const i=e.getAlphaMode();for(let i=0;i<t;++i){const t=this._mergeDrawWrapper[i];e.enableEffect(t),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(t.effect,i)}e.setAlphaMode(i),this.onAfterComposeObservable.notifyObservers(this);const r=this._mainTexture.getSize();this._setMainTextureSize(),r.width===this._mainTextureDesiredSize.width&&r.height===this._mainTextureDesiredSize.height||0===this._mainTextureDesiredSize.width||0===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){if(!this.shouldRender())return;const i=e.getMaterial(),r=e.getMesh(),n=e.getReplacementMesh(),s=e.getRenderingMesh(),a=e.getEffectiveMesh(),o=this._scene,l=o.getEngine();if(a._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!i)return;if(!this._canRenderMesh(s,i))return;let c=i._getEffectiveOrientation(s);a._getWorldMatrixDeterminant()<0&&(c=c===Zl.i.ClockWiseSideOrientation?Zl.i.CounterClockWiseSideOrientation:Zl.i.ClockWiseSideOrientation);const h=c===Zl.i.ClockWiseSideOrientation;l.setState(i.backFaceCulling,i.zOffset,void 0,h,i.cullBackFaces,void 0,i.zOffsetUnits);const u=s._getInstancesRenderList(e._id,!!n);if(u.mustReturn)return;if(!this._shouldRenderMesh(s))return;const d=u.hardwareInstancedRendering[e._id]||s.hasThinInstances;if(this._setEmissiveTextureAndColor(s,e,i),this.onBeforeRenderMeshToEffect.notifyObservers(r),this._useMeshMaterial(s))s.render(e,t,n||void 0);else if(this._isReady(e,d,this._emissiveTextureAndColor.texture)){const r=a._internalAbstractMeshDataInfo._materialForRenderPass?.[l.currentRenderPassId];let n=e._getDrawWrapper();if(!n&&r&&(n=r._getDrawWrapper()),!n)return;const c=n.effect;if(l.enableEffect(n),d||s._bind(e,c,i.fillMode),r?r.bindForSubMesh(a.getWorldMatrix(),a,e):(c.setMatrix("viewProjection",o.getTransformMatrix()),c.setMatrix("world",a.getWorldMatrix()),c.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!r){const e=i.needAlphaTesting(),r=i.getAlphaTestTexture(),n=r&&r.hasAlpha&&(i.useAlphaFromDiffuseTexture||i._useAlphaFromAlbedoTexture);if(r&&(e||n)){c.setTexture("diffuseSampler",r);const e=r.getTextureMatrix();e&&c.setMatrix("diffuseMatrix",e)}const a=i.opacityTexture;if(a){c.setTexture("opacitySampler",a),c.setFloat("opacityIntensity",a.level);const e=a.getTextureMatrix();e&&c.setMatrix("opacityMatrix",e)}if(this._emissiveTextureAndColor.texture&&(c.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),c.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const e=s.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(s);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(s))}(0,qo.nR)(s,c),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(c),t&&l.setAlphaMode(i.alphaMode),c.setFloat("glowIntensity",this.getEffectIntensity(s)),(0,Xo.gS)(c,i,o)}s._processRendering(a,e,c,i.fillMode,u,d,((e,t)=>c.setMatrix("world",t)))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[Ue.R.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[Ue.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[Ue.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const e of this._mergeDrawWrapper)e.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return re.S0.Instantiate(e.customType).Parse(e,t,i)}}Nc.ForceGLSL=!1,Nc._SceneComponentInitialization=e=>{throw(0,Oc.n)("EffectLayerSceneComponent")},(0,ue.Cg)([(0,de.lK)()],Nc.prototype,"name",void 0),(0,ue.Cg)([(0,de.qK)()],Nc.prototype,"neutralColor",void 0),(0,ue.Cg)([(0,de.lK)()],Nc.prototype,"isEnabled",void 0),(0,ue.Cg)([(0,de.fW)()],Nc.prototype,"camera",null),(0,ue.Cg)([(0,de.lK)()],Nc.prototype,"renderingGroupId",null),(0,ue.Cg)([(0,de.lK)()],Nc.prototype,"disableBoundingBoxesFromEffectLayer",void 0);var Dc=i(88576);(0,Dc.ji)(Gt.v.NAME_EFFECTLAYER,((e,t,i,r)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=[]);for(let n=0;n<e.effectLayers.length;n++){const s=Nc.Parse(e.effectLayers[n],t,r);i.effectLayers.push(s)}}})),kt.Z.prototype.removeEffectLayer=function(e){const t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},kt.Z.prototype.addEffectLayer=function(e){this.effectLayers.push(e)};class Fc{constructor(e){this.name=Gt.v.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||P.q.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._isReadyForMeshStage.registerStep(Gt.v.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Gt.v.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Gt.v.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Gt.v.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Gt.v.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Gt.v.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.addEffectLayer(e)}))}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.removeEffectLayer(e),t&&e.dispose()}))}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(const n of r){if(!n.hasMesh(e))continue;const r=n._mainTexture;this._engine.currentRenderPassId=r.renderPassId;for(const r of e.subMeshes)if(!n.isReady(r,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===Ct.i.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==Ct.i.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();const e=r._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}Nc._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_EFFECTLAYER);t||(t=new Fc(e),e._addComponent(t))},kt.Z.prototype.getGlowLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===Lc.EffectName)return this.effectLayers[t];return null};class Lc extends Nc{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new a.ov(0,0,0,1),this._options={mainTextureRatio:Lc.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType,generateStencilBuffer:this._options.generateStencilBuffer})}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,46679)),Promise.resolve().then(i.bind(i,61297)),Promise.resolve().then(i.bind(i,93341))]):await Promise.all([Promise.resolve().then(i.bind(i,58750)),Promise.resolve().then(i.bind(i,93172)),Promise.resolve().then(i.bind(i,1938))]),await super._importShadersAsync()}getEffectName(){return Lc.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[Ue.R.PositionKind],["offset"],["textureSampler","textureSampler2"],e,void 0,void 0,void 0,void 0,this.shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?(0,Tn.R)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,Tn.R)(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new Si.$("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=_e.g.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=_e.g.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(_e.g.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const r=Math.floor(e/2),n=Math.floor(t/2);this._blurTexture2=new Si.$("GlowLayerBlurRTT2",{width:r,height:n},this._scene,!1,!0,i),this._blurTexture2.wrapU=_e.g.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=_e.g.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(_e.g.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const a=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new ko("GlowLayerHBP1",new s.I9(1,0),a,{width:e,height:t},null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess1=new ko("GlowLayerVBP1",new s.I9(0,1),a,{width:e,height:t},null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new ko("GlowLayerHBP2",new s.I9(1,0),a,{width:r,height:n},null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=n,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._blurTexture1)})),this._verticalBlurPostprocess2=new ko("GlowLayerVBP2",new s.I9(0,1),a,{width:r,height:n},null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add((()=>{const e=this._blurTexture1.renderTarget;if(e){this._scene.postProcessManager.directRender(this._postProcesses1,e,!0);const t=this._blurTexture2.renderTarget;t&&this._scene.postProcessManager.directRender(this._postProcesses2,t,!0),this._engine.unBindFramebuffer(t??e,!0)}})),this._postProcesses.map((e=>{e.autoClear=!1}))}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r)return!1;const n=i.emissiveTexture;return super._isReady(e,t,n)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(Zl.i.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){let r=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(r=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(r*=i.emissiveIntensity??1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return 0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=pe.p.Serialize(this);let t;if(e.customType="BABYLON.GlowLayer",e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const r=pe.p.Parse((()=>new Lc(e.name,t,e.options)),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const i=t.getMeshById(e.excludedMeshes[n]);i&&r.addExcludedMesh(i)}for(n=0;n<e.includedMeshes.length;n++){const i=t.getMeshById(e.includedMeshes[n]);i&&r.addIncludedOnlyMesh(i)}return r}}Lc.EffectName="GlowLayer",Lc.DefaultBlurKernelSize=32,Lc.DefaultTextureRatio=.5,(0,ue.Cg)([(0,de.lK)()],Lc.prototype,"blurKernelSize",null),(0,ue.Cg)([(0,de.lK)()],Lc.prototype,"intensity",null),(0,ue.Cg)([(0,de.lK)("options")],Lc.prototype,"_options",void 0),(0,o.Y5)("BABYLON.GlowLayer",Lc),kt.Z.prototype.getHighlightLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===Bc.EffectName)return this.effectLayers[t];return null};class wc extends jt.w{constructor(e,t,i,r,n,s=_e.g.BILINEAR_SAMPLINGMODE,a,o){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,r,n,s,a,o),this.direction=t,this.kernel=i,this.onApplyObservable.add((e=>{e.setFloat2("screenSize",this.width,this.height),e.setVector2("direction",this.direction),e.setFloat("blurWidth",this.kernel)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,93341)))):t.push(Promise.resolve().then(i.bind(i,1938))),super._gatherImports(e,t)}}class Bc extends Nc{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t,void 0!==i&&!!i.forceGLSL),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new n.cP,this.onAfterBlurObservable=new n.cP,this._instanceGlowingMeshStencilReference=Bc.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=Bc.NeutralColor,this._engine.isStencilEnable||f.V.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,forceGLSL:!1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,46679)),Promise.resolve().then(i.bind(i,61297)),Promise.resolve().then(i.bind(i,93341))]):await Promise.all([Promise.resolve().then(i.bind(i,58750)),Promise.resolve().then(i.bind(i,93172)),Promise.resolve().then(i.bind(i,1938))]),await super._importShadersAsync()}getEffectName(){return Bc.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[Ue.R.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?(0,Tn.R)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,Tn.R)(t,this._maxSize):t;let i=0;if(i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new Si.$("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=_e.g.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=_e.g.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(_e.g.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode)this._downSamplePostprocess=new $t.v("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._horizontalBlurPostprocess=new wc("HighlightLayerHBP",new s.I9(1,0),this._options.blurHorizontalSize,1,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._verticalBlurPostprocess=new wc("HighlightLayerVBP",new s.I9(0,1),this._options.blurVerticalSize,1,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess];else{this._horizontalBlurPostprocess=new ko("HighlightLayerHBP",new s.I9(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i);const r=this._horizontalBlurPostprocess;r.width=e,r.height=t,r.externalTextureSamplerBinding=!0,r.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess=new ko("HighlightLayerVBP",new s.I9(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]}this._mainTexture.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this._postProcesses.map((e=>{e.autoClear=!1}))}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r||!this._meshes)return!1;let n=null;const s=this._meshes[r.uniqueId];return s&&s.glowEmissiveOnly&&i&&(n=i.emissiveTexture),super._isReady(e,t,n)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(Zl.i.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(Zl.i.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const r=this._meshes[e.uniqueId];r?this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),r&&r.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){const t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add((e=>{t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1)})),t.afterRender=e.onAfterRenderObservable.add((e=>{e.getEngine().setStencilBuffer(t.stencilState)})),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!!this._meshes&&!!super.hasMesh(e)&&void 0!==this._meshes[e.uniqueId]&&null!==this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const r=this._meshes[e.uniqueId];r?r.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add((e=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))})),observerDefault:e.onAfterRenderObservable.add((e=>{this.isEnabled&&this._defaultStencilReference(e)})),glowEmissiveOnly:i},e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const e in this._meshes)if(this._meshes[e]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(Bc.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=pe.p.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const r=pe.p.Parse((()=>new Bc(e.name,t,e.options)),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const i=t.getMeshById(e.excludedMeshes[n]);i&&r.addExcludedMesh(i)}for(n=0;n<e.meshes.length;n++){const i=e.meshes[n],s=t.getMeshById(i.meshId);s&&r.addMesh(s,a.v9.FromArray(i.color),i.glowEmissiveOnly)}return r}}Bc.EffectName="HighlightLayer",Bc.NeutralColor=new a.ov(0,0,0,0),Bc.GlowingMeshStencilReference=2,Bc.NormalMeshStencilReference=1,(0,ue.Cg)([(0,de.lK)()],Bc.prototype,"innerGlow",void 0),(0,ue.Cg)([(0,de.lK)()],Bc.prototype,"outerGlow",void 0),(0,ue.Cg)([(0,de.lK)()],Bc.prototype,"blurHorizontalSize",null),(0,ue.Cg)([(0,de.lK)()],Bc.prototype,"blurVerticalSize",null),(0,ue.Cg)([(0,de.lK)("options")],Bc.prototype,"_options",void 0),(0,o.Y5)("BABYLON.HighlightLayer",Bc);var Vc=i(84442),kc=i(8013),Gc=i(72206),Uc=i(45764),zc=i(63205),Wc=i(66031),Hc=i(58750),Yc=i(93172),Xc=i(1938),qc=i(46679),$c=i(61297),jc=i(93341),Kc=i(96996),Zc=i(25890),Qc=i(32379),Jc=i(31333);class eh{static AddFlare(e,t,i,r,n){return new eh(e,t,i,r,n)}constructor(e,t,i,r,n){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new a.v9(1,1,1),this.texture=r?new _e.g(r,n.getScene(),!0):null,this._system=n;const s=n.scene.getEngine();n._onShadersLoaded.addOnce((()=>{this._drawWrapper=new ec.E(s),this._drawWrapper.effect=s.createEffect("lensFlare",[Ue.R.PositionKind],["color","viewportMatrix"],["textureSampler"],"",void 0,void 0,void 0,void 0,n.shaderLanguage)})),n.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}class th{get scene(){return this._scene}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this.name=e,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._shaderLanguage=0,this._vertexBuffers={},this._isEnabled=!0,this._onShadersLoaded=new n.cP(void 0,!0),this._shadersLoaded=!1,this._scene=i||P.q.LastCreatedScene,th._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=e=>i.activeCamera&&e.material&&e.isVisible&&e.isEnabled()&&e.isBlocker&&!!(e.layerMask&i.activeCamera.layerMask);const r=i.getEngine(),s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[Ue.R.PositionKind]=new Ue.R(r,s,Ue.R.PositionKind,!1,!1,2),this._createIndexBuffer(),this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!th.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,31660)),Promise.resolve().then(i.bind(i,38682))])):await Promise.all([Promise.resolve().then(i.bind(i,12155)),Promise.resolve().then(i.bind(i,61637))]),this._shadersLoaded=!0,this._onShadersLoaded.notifyObservers()}_createIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=s.Pq.Project(t,s.uq.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=s.Pq.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=2*this.viewportBorder,e.height+=2*this.viewportBorder,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const i=this._scene.useRightHandedSystem;return!!(t.z>0&&!i||t.z<0&&i)&&(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&(this._positionY,e.y,e.height),!0)}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const e=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),t=e.length();e.normalize();const i=new Ii.Rl(this._scene.activeCamera.globalPosition,e),r=this._scene.pickWithRay(i,this.meshesSelectionPredicate,!0);return!r||!r.hit||r.distance>t}render(){if(!this._scene.activeCamera||!this._shadersLoaded)return!1;const e=this._scene.getEngine(),t=this._scene.activeCamera.viewport.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(t))return!1;if(!this._isVisible())return!1;let i,r;i=this._positionX<this.borderLimit+t.x?this.borderLimit+t.x-this._positionX:this._positionX>t.x+t.width-this.borderLimit?this._positionX-t.x-t.width+this.borderLimit:0,r=this._positionY<this.borderLimit+t.y?this.borderLimit+t.y-this._positionY:this._positionY>t.y+t.height-this.borderLimit?this._positionY-t.y-t.height+this.borderLimit:0;let n=i>r?i:r;n-=this.viewportBorder,n>this.borderLimit&&(n=this.borderLimit);let a=1-(0,it.Clamp)(n/this.borderLimit,0,1);if(a<0)return!1;a>1&&(a=1),this.viewportBorder>0&&(t.x+=this.viewportBorder,t.y+=this.viewportBorder,t.width-=2*this.viewportBorder,t.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const o=t.x+t.width/2,l=t.y+t.height/2,c=o-this._positionX,h=l-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(let i=0;i<this.lensFlares.length;i++){const r=this.lensFlares[i];if(!r._drawWrapper.effect.isReady()||r.texture&&!r.texture.isReady())continue;e.enableEffect(r._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,r._drawWrapper.effect),e.setAlphaMode(r.alphaMode);const n=o-c*r.position,u=l-h*r.position,d=r.size,p=r.size*e.getAspectRatio(this._scene.activeCamera,!0),f=(n-t.x)/t.width*2-1,m=1-(u-t.y)/t.height*2,_=s.uq.FromValues(d/2,0,0,0,0,p/2,0,0,0,0,1,0,f,m,0,1);r._drawWrapper.effect.setMatrix("viewportMatrix",_),r._drawWrapper.effect.setTexture("textureSampler",r.texture),r._drawWrapper.effect.setFloat4("color",r.color.r*a,r.color.g*a,r.color.b*a,1),e.drawElementsType(Zl.i.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0}rebuild(){this._createIndexBuffer();for(const e in this._vertexBuffers)this._vertexBuffers[e]?._rebuild()}dispose(){this._onShadersLoaded.clear();const e=this._vertexBuffers[Ue.R.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[Ue.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){const r=t.getLastEntryById(e.emitterId),n=e.name||"lensFlareSystem#"+e.emitterId,s=new th(n,r,t);s.id=e.id||n,s.borderLimit=e.borderLimit;for(let t=0;t<e.flares.length;t++){const r=e.flares[t];eh.AddFlare(r.size,r.position,a.v9.FromArray(r.color),r.textureName?i+r.textureName:"",s)}return s}serialize(){const e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){const i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:re.S0.GetFilename(i.texture?i.texture.name:"")})}return e}}th.ForceGLSL=!1,th._SceneComponentInitialization=e=>{throw(0,Oc.n)("LensFlareSystemSceneComponent")},(0,Dc.ji)(Gt.v.NAME_LENSFLARESYSTEM,((e,t,i,r)=>{if(void 0!==e.lensFlareSystems&&null!==e.lensFlareSystems){i.lensFlareSystems||(i.lensFlareSystems=[]);for(let n=0,s=e.lensFlareSystems.length;n<s;n++){const s=e.lensFlareSystems[n],a=th.Parse(s,t,r);i.lensFlareSystems.push(a)}}})),kt.Z.prototype.getLensFlareSystemByName=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===e)return this.lensFlareSystems[t];return null},kt.Z.prototype.getLensFlareSystemById=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===e)return this.lensFlareSystems[t];return null},kt.Z.prototype.getLensFlareSystemByID=function(e){return this.getLensFlareSystemById(e)},kt.Z.prototype.removeLensFlareSystem=function(e){const t=this.lensFlareSystems.indexOf(e);return-1!==t&&this.lensFlareSystems.splice(t,1),t},kt.Z.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)};class ih{constructor(e){this.name=Gt.v.NAME_LENSFLARESYSTEM,this.scene=e}register(){this.scene._afterCameraDrawStage.registerStep(Gt.v.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.addLensFlareSystem(e)}))}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach((e=>{this.scene.removeLensFlareSystem(e),t&&e.dispose()}))}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;re.S0.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)e.layerMask&i.layerMask&&i.render();re.S0.EndPerformanceCounter("Lens flares",t.length>0)}}}th._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_LENSFLARESYSTEM);t||(t=new ih(e),e._addComponent(t))};var rh=i(12155),nh=i(61637),sh=i(31660),ah=i(38682),oh=i(75556),lh=i(23728),ch=i(5044);class hh{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===hh.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===hh.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===hh.FILTER_PCF||e===hh.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==hh.FILTER_PCF&&e!==hh.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===hh.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(hh.FILTER_POISSONSAMPLING);(e||this.filter===hh.FILTER_POISSONSAMPLING)&&(this.filter=e?t:hh.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===hh.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(hh.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===hh.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:hh.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===hh.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(hh.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===hh.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:hh.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===hh.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(hh.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===hh.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:hh.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===hh.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(hh.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===hh.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:hh.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===hh.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(hh.FILTER_PCF);(e||this.filter===hh.FILTER_PCF)&&(this.filter=e?t:hh.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===hh.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(hh.FILTER_PCSS);(e||this.filter===hh.FILTER_PCSS)&&(this.filter=e?t:hh.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return hh.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,a,o=!1){this.onBeforeShadowMapRenderObservable=new n.cP,this.onAfterShadowMapRenderObservable=new n.cP,this.onBeforeShadowMapRenderMeshObservable=new n.cP,this.onAfterShadowMapRenderMeshObservable=new n.cP,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=hh.FILTER_NONE,this._filteringQuality=hh.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=s.Pq.Zero(),this._viewMatrix=s.uq.Zero(),this._projectionMatrix=s.uq.Zero(),this._transformMatrix=s.uq.Zero(),this._cachedPosition=new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=s.uq.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!a,this._initShaderSourceAsync(o);let l=t._shadowGenerators;l||(l=t._shadowGenerators=new Map),l.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),hh._SceneComponentInitialization(this._scene);const c=this._scene.getEngine().getCaps();i?c.textureFloatRender&&c.textureFloatLinearFiltering?this._textureType=1:c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering?this._textureType=2:c.textureFloatRender&&c.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new Si.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new Si.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=_e.g.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=_e.g.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(_e.g.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,r)=>this._renderForShadowMap(e,t,i,r),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===hh.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===hh.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.(1);const t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0)),e._debugPopGroup?.(1)}));const t=new a.ov(0,0,0,0),i=new a.ov(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===hh.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}));for(let e=ch.m.MIN_RENDERINGGROUPS;e<ch.m.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||hh.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,50463)),Promise.resolve().then(i.bind(i,62697)),Promise.resolve().then(i.bind(i,7518)),Promise.resolve().then(i.bind(i,11110))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,9082)),Promise.resolve().then(i.bind(i,31065)),Promise.resolve().then(i.bind(i,61583)),Promise.resolve().then(i.bind(i,94563))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new Si.$(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=_e.g.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=_e.g.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(_e.g.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new ko(this._light.name+"KernelBlurX",new s.I9(1,0),this.blurKernel,1,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap)})),this._kernelBlurYPostprocess=new ko(this._light.name+"KernelBlurY",new s.I9(0,1),this.blurKernel,1,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new jt.w(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,r){let n;if(r.length)for(n=0;n<r.length;n++)this._renderSubMeshForShadowMap(r.data[n]);for(n=0;n<e.length;n++)this._renderSubMeshForShadowMap(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMeshForShadowMap(t.data[n]);if(this._transparencyShadow)for(n=0;n<i.length;n++)this._renderSubMeshForShadowMap(i.data[n],!0);else for(n=0;n<i.length;n++)i.data[n].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const i=e.getRenderingMesh(),r=e.getEffectiveMesh(),n=this._scene,s=n.getEngine(),a=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||0===e.verticesCount||e._renderId===n.getRenderId())return;const o=n.useRightHandedSystem,l=r._getWorldMatrixDeterminant()<0;let c=a._getEffectiveOrientation(i);(l&&!o||!l&&o)&&(c=0===c?1:0);const h=0===c;s.setState(a.backFaceCulling,void 0,void 0,h,a.cullBackFaces);const u=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;const d=s.getCaps().instancedArrays&&(null!==u.visibleInstances[e._id]&&void 0!==u.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,d,t)){e._renderId=n.getRenderId();const o=a.shadowDepthWrapper,l=o?.getEffect(e,this,s.currentRenderPassId)??e._getDrawWrapper(),c=ec.E.GetEffect(l);s.enableEffect(l),d||i._bind(e,c,a.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===oh.v.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this._cachedDirection):c.setVector3("lightDataSM",this._cachedPosition);const h=this._getCamera();if(h&&c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(h),this.getLight().getDepthMinZ(h)+this.getLight().getDepthMaxZ(h)),t&&this.enableSoftTransparentShadow&&c.setFloat2("softTransparentShadowSM",r.visibility*a.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),o)e._setMainDrawWrapperOverride(l),o.standalone?o.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):a.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(c.setTexture("diffuseSampler",this._opacityTexture),c.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const e=i.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(i);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(i))}(0,qo.nR)(i,c),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(c);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(c,d),(0,Xo.gS)(c,a,n)}this._useUBO||o||this._bindCustomEffectForRenderSubMeshForShadowMap(e,c,r),(0,qo._8)(c,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const p=r.getWorldMatrix();d&&(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(p)),this.forceBackFacesOnly&&s.setState(!0,0,!1,!0,a.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(c),i._processRendering(r,e,c,a.fillMode,u,d,((e,t)=>{r===i||e?(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(e?t:p)):(i.getMeshUniformBuffer().bindToEffect(c,"Mesh"),i.transferToEffect(t))})),this.forceBackFacesOnly&&s.setState(!0,0,!1,!1,a.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===hh.FILTER_NONE||this.filter===hh.FILTER_PCSS?this._shadowMap.updateSamplingMode(_e.g.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(_e.g.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},r=this.getShadowMap();if(!r)return void(e&&e(this));const n=r.renderList;if(!n)return void(e&&e(this));const s=[];for(const e of n)s.push(...e.subMeshes);if(0===s.length)return void(e&&e(this));let a=0;const o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(s[a],i.useInstances,s[a].getMaterial()?.needAlphaBlendingForMesh(s[a].getMesh())??!1);)if(a++,a>=s.length)return void(e&&e(this));setTimeout(o,16)}};o()}forceCompilationAsync(e){return new Promise((t=>{this.forceCompilation((()=>{t()}),e)}))}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const n=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&n.isVerticesDataPresent(Ue.R.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===oh.v.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;const r=e.getMaterial(),n=r?.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;const s=[];if(this._prepareShadowDefines(e,t,s,i),n){if(!n.isReadyForSubMesh(e,s,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const i=e._getDrawWrapper(void 0,!0);let n=i.effect,a=i.defines;const o=[Ue.R.PositionKind],l=e.getMesh();this.normalBias&&l.isVerticesDataPresent(Ue.R.NormalKind)&&(o.push(Ue.R.NormalKind),s.push("#define NORMAL"),l.nonUniformScaling&&s.push("#define NONUNIFORMSCALING"));const c=r.needAlphaTesting();if((c||r.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=r.alphaCutOff??hh.DEFAULT_ALPHA_CUTOFF;s.push("#define ALPHATEXTURE"),c&&s.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),l.isVerticesDataPresent(Ue.R.UVKind)&&(o.push(Ue.R.UVKind),s.push("#define UV1")),l.isVerticesDataPresent(Ue.R.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(o.push(Ue.R.UV2Kind),s.push("#define UV2"))}const h=new Yo.J;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){o.push(Ue.R.MatricesIndicesKind),o.push(Ue.R.MatricesWeightsKind),l.numBoneInfluencers>4&&(o.push(Ue.R.MatricesIndicesExtraKind),o.push(Ue.R.MatricesWeightsExtraKind));const e=l.skeleton;s.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&h.addCPUSkinningFallback(0,l),e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");const u=l.morphTargetManager;let d=0;if(u&&(d=u.numMaxInfluencers||u.numInfluencers,d>0&&(s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),(0,qo.MF)(o,l,d))),(0,Xo.tv)(r,this._scene,s),t&&(s.push("#define INSTANCES"),(0,qo.te)(o),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===s.indexOf(e)&&s.push(e);const p=l.bakedVertexAnimationManager;p&&p.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&o.push("bakedVertexAnimationSettingsInstanced"));const f=s.join("\n");if(a!==f){a=f;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],r=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],s=["Scene","Mesh"];if((0,Xo.TV)(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===o.indexOf(e)&&o.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===r.indexOf(e)&&r.push(e)}const l=this._scene.getEngine();n=l.createEffect(e,{attributes:o,uniformsNames:t,uniformBuffersNames:s,samplers:r,defines:f,fallbacks:h,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},shaderLanguage:this._shaderLanguage},l),i.setEffect(n,a)}if(!n.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,r=this._light;i.shadowsEnabled&&r.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===hh.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===hh.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===hh.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===hh.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),r.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera();if(!r)return;const n=this.getShadowMap();if(!n)return;i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());const s=this.getShadowMapForRendering();this._filter===hh.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===hh.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,s),t.setTexture("depthTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),s.Pq.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(s.Pq.Dot(this._lightDirection,s.Pq.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),s.uq.LookAtLHToRef(t,t.add(this._lightDirection),s.Pq.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t,i){const r=t.getLightById(e.lightId),n=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,s=i?i(e.mapSize,r,n):new hh(e.mapSize,r,void 0,n),a=s.getShadowMap();for(let i=0;i<e.renderList.length;i++)t.getMeshesById(e.renderList[i]).forEach((function(e){a&&(a.renderList||(a.renderList=[]),a.renderList.push(e))}));return void 0!==e.id&&(s.id=e.id),s.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&s.setDarkness(e.darkness),e.transparencyShadow&&s.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(s.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(s.bias=e.bias),void 0!==e.normalBias&&(s.normalBias=e.normalBias),e.usePercentageCloserFiltering?s.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?s.useContactHardeningShadow=!0:e.usePoissonSampling?s.usePoissonSampling=!0:e.useExponentialShadowMap?s.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?s.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?s.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?s.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?s.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(s.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(s.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(s.filteringQuality=e.filteringQuality),e.depthScale&&(s.depthScale=e.depthScale),e.blurScale&&(s.blurScale=e.blurScale),e.blurBoxOffset&&(s.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(s.useKernelBlur=e.useKernelBlur),e.blurKernel&&(s.blurKernel=e.blurKernel),s}}hh.CLASSNAME="ShadowGenerator",hh.ForceGLSL=!1,hh.FILTER_NONE=0,hh.FILTER_EXPONENTIALSHADOWMAP=1,hh.FILTER_POISSONSAMPLING=2,hh.FILTER_BLUREXPONENTIALSHADOWMAP=3,hh.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,hh.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,hh.FILTER_PCF=6,hh.FILTER_PCSS=7,hh.QUALITY_HIGH=0,hh.QUALITY_MEDIUM=1,hh.QUALITY_LOW=2,hh.DEFAULT_ALPHA_CUTOFF=.5,hh._SceneComponentInitialization=e=>{throw(0,Oc.n)("ShadowGeneratorSceneComponent")};var uh=i(79144),dh=i(47901);class ph{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,n=_e.g.TRILINEAR_SAMPLINGMODE,s=!1,o){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=s,this.isPacked=0===t,this.isPacked?this.clearColor=new a.ov(1,1,1,1):this.clearColor=new a.ov(s?1e8:1,0,0,1),this._initShaderSourceAsync(),ph._SceneComponentInitialization(this._scene);const l=e.getEngine();this._camera=i,n!==_e.g.NEAREST_SAMPLINGMODE&&(1!==t||l._caps.textureFloatLinearFiltering||(n=_e.g.NEAREST_SAMPLINGMODE),2!==t||l._caps.textureHalfFloatLinearFiltering||(n=_e.g.NEAREST_SAMPLINGMODE));const c=this.isPacked||!l._features.supportExtendedTextureFormats?5:6;this._depthMap=new Si.$(o??"DepthRenderer",{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,t,!1,n,void 0,void 0,void 0,c),this._depthMap.wrapU=_e.g.CLAMP_ADDRESSMODE,this._depthMap.wrapV=_e.g.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add((e=>{e.clear(this.clearColor,!0,!0,!0)})),this._depthMap.onBeforeBindObservable.add((()=>{l._debugPushGroup?.("depth renderer",1)})),this._depthMap.onAfterUnbindObservable.add((()=>{l._debugPopGroup?.(1)})),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],r=i.getRenderingMesh(),n=r._getInstancesRenderList(i._id,!!i.getReplacementMesh()),s=l.getCaps().instancedArrays&&(null!==n.visibleInstances[i._id]&&void 0!==n.visibleInstances[i._id]||r.hasThinInstances);if(!this.isReady(i,s))return!1}return!0};const h=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,n=r.getEngine(),s=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!s||i.infiniteDistance||s.disableDepthWrite||0===e.verticesCount||e._renderId===r.getRenderId())return;const a=i._getWorldMatrixDeterminant()<0;let o=s._getEffectiveOrientation(t);a&&(o=0===o?1:0);const l=0===o;n.setState(s.backFaceCulling,0,!1,l,this.reverseCulling?!s.cullBackFaces:s.cullBackFaces);const c=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(c.mustReturn)return;const h=n.getCaps().instancedArrays&&(null!==c.visibleInstances[e._id]&&void 0!==c.visibleInstances[e._id]||t.hasThinInstances),u=this._camera||r.activeCamera;if(this.isReady(e,h)&&u){e._renderId=r.getRenderId();const a=i._internalAbstractMeshDataInfo._materialForRenderPass?.[n.currentRenderPassId];let o=e._getDrawWrapper();!o&&a&&(o=a._getDrawWrapper());const l=u.mode===Ct.i.ORTHOGRAPHIC_CAMERA;if(!o)return;const d=o.effect;let p,f;if(n.enableEffect(o),h||t._bind(e,d,s.fillMode),a?a.bindForSubMesh(i.getWorldMatrix(),i,e):(d.setMatrix("viewProjection",r.getTransformMatrix()),d.setMatrix("world",i.getWorldMatrix()),this._storeCameraSpaceZ&&d.setMatrix("view",r.getViewMatrix())),l?(p=!n.useReverseDepthBuffer&&n.isNDCHalfZRange?0:1,f=n.useReverseDepthBuffer&&n.isNDCHalfZRange?0:1):(p=n.useReverseDepthBuffer&&n.isNDCHalfZRange?u.minZ:n.isNDCHalfZRange?0:u.minZ,f=n.useReverseDepthBuffer&&n.isNDCHalfZRange?0:u.maxZ),d.setFloat2("depthValues",p,p+f),!a){if(s.needAlphaTesting()){const e=s.getAlphaTestTexture();e&&(d.setTexture("diffuseSampler",e),d.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,qo.f$)(t,d),(0,Xo.gS)(d,s,r),(0,qo.nR)(t,d),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(d);const i=e.getMesh().bakedVertexAnimationManager;i&&i.isEnabled&&i.bind(d,h),s.pointsCloud&&d.setFloat("pointSize",s.pointSize)}t._processRendering(i,e,d,s.fillMode,c,h,((e,t)=>d.setMatrix("world",t)))}};this._depthMap.customRenderFunction=(e,t,i,r)=>{let n;if(r.length)for(n=0;n<r.length;n++)h(r.data[n]);for(n=0;n<e.length;n++)h(e.data[n]);for(n=0;n<t.length;n++)h(t.data[n]);if(this.forceDepthWriteTransparentMeshes)for(n=0;n<i.length;n++)h(i.data[n]);else for(n=0;n<i.length;n++)i.data[n].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||ph.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,47901)),Promise.resolve().then(i.bind(i,79144))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,93105)),Promise.resolve().then(i.bind(i,24567))])),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=this._scene.getEngine(),r=e.getMesh(),n=r.getScene(),s=r._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(s)return s.isReadyForSubMesh(r,e,t);const a=e.getMaterial();if(!a||a.disableDepthWrite)return!1;const o=[],l=[Ue.R.PositionKind];a.needAlphaTesting()&&a.getAlphaTestTexture()&&(o.push("#define ALPHATEST"),r.isVerticesDataPresent(Ue.R.UVKind)&&(l.push(Ue.R.UVKind),o.push("#define UV1")),r.isVerticesDataPresent(Ue.R.UV2Kind)&&(l.push(Ue.R.UV2Kind),o.push("#define UV2")));const c=new Yo.J;if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){l.push(Ue.R.MatricesIndicesKind),l.push(Ue.R.MatricesWeightsKind),r.numBoneInfluencers>4&&(l.push(Ue.R.MatricesIndicesExtraKind),l.push(Ue.R.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),r.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,r);const e=r.skeleton;e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");const h=r.morphTargetManager;let u=0;h&&(u=h.numMaxInfluencers||h.numInfluencers,u>0&&(o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+u),h.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),(0,qo.MF)(l,r,u))),a.pointsCloud&&o.push("#define POINTSIZE"),t&&(o.push("#define INSTANCES"),(0,qo.te)(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));const d=r.bakedVertexAnimationManager;d&&d.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&l.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&o.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&o.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&o.push("#define PACKED"),(0,Xo.tv)(a,n,o);const p=e._getDrawWrapper(void 0,!0),f=p.defines,m=o.join("\n");if(f!==m){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];(0,Xo.TV)(e),p.setEffect(i.createEffect("depth",{attributes:l,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:m,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:u},shaderLanguage:this._shaderLanguage},i))}return p.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}ph.ForceGLSL=!1,ph._SceneComponentInitialization=e=>{throw(0,Oc.n)("DepthRendererSceneComponent")};var fh=i(55788);ri.l.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";class mh{constructor(e){this.onAfterReductionPerformed=new n.cP,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new fh.X(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{this._postProcessManager._rebuild()}))}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;const n=this._camera.getScene(),s=new jt.w("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,n.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);s.autoClear=!1,s.forceFullscreenViewport=r;let a=this._sourceTexture.getRenderWidth(),o=this._sourceTexture.getRenderHeight();s.onApply=((e,t)=>i=>{i.setTexture("sourceTexture",this._sourceTexture),i.setFloat2("texSize",e,t)})(a,o),this._reductionSteps.push(s);let l=1;for(;a>1||o>1;){a=Math.max(Math.round(a/2),1),o=Math.max(Math.round(o/2),1);const e=new jt.w("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:a,height:o},null,1,n.getEngine(),!1,"#define "+(1==a&&1==o?"LAST":1==a||1==o?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(e.autoClear=!1,e.forceFullscreenViewport=r,e.onApply=((e,t)=>i=>{1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)})(a,o),this._reductionSteps.push(e),l++,1==a&&1==o){const t=(e,t,i)=>{const r=new Float32Array(4*e*t),s={min:0,max:0};return()=>{n.getEngine()._readTexturePixels(i.inputTexture.texture,e,t,-1,0,r,!1),s.min=r[0],s.max=r[1],this.onAfterReductionPerformed.notifyObservers(s)}};e.onAfterRenderObservable.add(t(a,o,e))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((()=>{const e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),e.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),e._debugPopGroup?.(1)})),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class _h extends mh{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(r._depthRenderer||(r._depthRenderer={}),(e=this._depthRenderer=new ph(r,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const gh=s.Pq.Up(),vh=s.Pq.Zero(),Sh=new s.Pq,xh=new s.Pq,Th=new s.uq;class Eh extends hh{_validateFilter(e){return e===hh.FILTER_NONE||e===hh.FILTER_PCF||e===hh.FILTER_PCSS?e:(f.V.Error('Unsupported filter "'+e+'"!'),hh.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,Eh.MIN_CASCADES_COUNT),Eh.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add((()=>this._computeShadowCastersBoundingInfo()))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const r=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(r.minimumWorld),this._scbiMax.maximizeInPlace(r.maximumWorld)}const t=this._scene.meshes;for(let e=0;e<t.length;e++){const i=t[e];if(!(i&&i.isVisible&&i.isEnabled&&i.receiveShadows))continue;const r=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(r.minimumWorld),this._scbiMax.maximizeInPlace(r.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Eh.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new _h(t),this._depthReducer.onAfterReductionPerformed.add((e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),t==this._minDistance&&i==this._maxDistance||this.setMinMaxDistance(t,i)})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,r=i-t,n=this._minDistance,s=t+n*r,a=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*r,o=a-s,l=a/s;for(let e=0;e<this._cascades.length;++e){const i=(e+1)/this._numCascades,a=s*l**i,c=s+o*i,h=this._lambda*(a-c)+c;this._cascades[e].prevBreakDistance=0===e?n:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(h-t)/r,this._viewSpaceFrustumsZ[e]=h,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;s.Pq.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(s.Pq.Dot(this._lightDirection,s.Pq.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],Sh),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),s.uq.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],gh,this._viewMatrices[i]);let r=0,n=Sh.z;const a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[i]),n=Math.min(n,a.boundingBox.maximumWorld.z),r=this._depthClamp&&this.filter!==hh.FILTER_PCSS?Math.max(r,a.boundingBox.minimumWorld.z):Math.min(r,a.boundingBox.minimumWorld.z),s.uq.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?n:r,t?r:n,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=r,this._cascadeMaxExtents[i].z=n,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),s.Pq.TransformCoordinatesToRef(vh,this._transformMatrices[i],Sh),Sh.scaleInPlace(this._mapSize/2),xh.copyFromFloats(Math.round(Sh.x),Math.round(Sh.y),Math.round(Sh.z)),xh.subtractInPlace(Sh).scaleInPlace(2/this._mapSize),s.uq.TranslationToRef(xh.x,xh.y,0,Th),this._projectionMatrices[i].multiplyToRef(Th,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,n=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const a=0===t.maxZ,o=t.maxZ;a&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const l=s.uq.Invert(t.getTransformationMatrix());a&&(t.maxZ=o,t.getProjectionMatrix(!0));const c=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<Eh._FrustumCornersNDCSpace.length;++t)Sh.copyFrom(Eh._FrustumCornersNDCSpace[(t+c)%Eh._FrustumCornersNDCSpace.length]),n&&-1===Sh.z&&(Sh.z=0),s.Pq.TransformCoordinatesToRef(Sh,l,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<Eh._FrustumCornersNDCSpace.length/2;++t)Sh.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),xh.copyFrom(Sh).scaleInPlace(i),Sh.scaleInPlace(r),Sh.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(Sh),this._frustumCornersWorldSpace[e][t].addInPlace(xh)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i){const r=this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],Sh).length();t=Math.max(t,r)}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,Sh),s.uq.LookAtLHToRef(t,Sh,gh,Th);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)s.Pq.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],Th,Sh),this._cascadeMinExtents[e].minimizeInPlace(Sh),this._cascadeMaxExtents[e].maximizeInPlace(Sh)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=P.q.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,r,n=!0){Eh.IsSupported?(super(e,t,i,r,n),this.usePercentageCloserFiltering=!0):f.V.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??Eh.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new s.Pq(0,0,0),this._scbiMax=this._scbiMax??new s.Pq(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new fr.j(new s.Pq(0,0,0),new s.Pq(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Si.$(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=s.uq.Zero(),this._projectionMatrices[e]=s.uq.Zero(),this._transformMatrices[e]=s.uq.Zero(),this._cascadeMinExtents[e]=new s.Pq,this._cascadeMaxExtents[e]=new s.Pq,this._frustumCenter[e]=new s.Pq,this._shadowCameraPos[e]=new s.Pq,this._frustumCornersWorldSpace[e]=new Array(Eh._FrustumCornersNDCSpace.length);for(let t=0;t<Eh._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new s.Pq}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===hh.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()})),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==hh.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const n=this._getCamera();n&&this._shadowMaxZ<=(n.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera();if(!r)return;const n=this.getShadowMap();if(!n)return;const s=n.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===hh.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s,1/s,this.frustumEdgeFalloff,e);else if(this._filter===hh.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,n),t.setTexture("depthTexture"+e,n),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s,this._contactHardeningLightSizeUVRatio*s,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s,1/s,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){const i=hh.Parse(e,t,((e,t,i)=>new Eh(e,t,void 0,i)));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Eh._FrustumCornersNDCSpace=[new s.Pq(-1,1,-1),new s.Pq(1,1,-1),new s.Pq(1,-1,-1),new s.Pq(-1,-1,-1),new s.Pq(-1,1,1),new s.Pq(1,1,1),new s.Pq(1,-1,1),new s.Pq(-1,-1,1)],Eh.CLASSNAME="CascadedShadowGenerator",Eh.DEFAULT_CASCADES_COUNT=4,Eh.MIN_CASCADES_COUNT=2,Eh.MAX_CASCADES_COUNT=4,Eh._SceneComponentInitialization=e=>{throw(0,Oc.n)("ShadowGeneratorSceneComponent")},(0,Dc.ji)(Gt.v.NAME_SHADOWGENERATOR,((e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let i=0,r=e.shadowGenerators.length;i<r;i++){const r=e.shadowGenerators[i];r.className===Eh.CLASSNAME?Eh.Parse(r,t):hh.Parse(r,t)}}));class Ch{constructor(e){this.name=Gt.v.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Gt.v.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const t=i.getShadowGenerators();if(t){const i=t.values();for(let t=i.next();!0!==t.done;t=i.next()){const i=t.value;e.shadowGenerators.push(i.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const r=t.lights[i],n=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&n){const i=n.values();for(let r=i.next();!0!==r.done;r=i.next()){const i=r.value.getShadowMap();-1!==t.textures.indexOf(i)&&e.push(i)}}}}}hh._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_SHADOWGENERATOR);t||(t=new Ch(e),e._addComponent(t))};var bh=i(9082),Ph=i(31065),yh=i(61583),Ah=i(94563),Rh=i(50463),Ih=i(62697),Mh=i(7518),Oh=i(11110),Nh=i(92264);class Dh{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const e=this._renderingCanvas.getBoundingClientRect(),t=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position="fixed"===t?"fixed":"absolute",this._loadingDiv.style.left=e.left+"px",this._loadingDiv.style.top=e.top+"px",this._loadingDiv.style.width=e.width+"px",this._loadingDiv.style.height=e.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const e=!!window.SVGSVGElement,t=new Image;Dh.DefaultLogoUrl?t.src=Dh.DefaultLogoUrl:t.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",t.style.width="150px",t.style.gridColumn="1",t.style.gridRow="1",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.position="absolute";const i=document.createElement("div");i.style.width="300px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const r=new Image;if(Dh.DefaultSpinnerUrl?r.src=Dh.DefaultSpinnerUrl:r.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",r.style.animation="spin1 0.75s infinite linear",r.style.transformOrigin="50% 50%",!e){const e={w:16,h:18.5},i={w:30,h:30};t.style.width=`${e.w}vh`,t.style.height=`${e.h}vh`,t.style.left=`calc(50% - ${e.w/2}vh)`,t.style.top=`calc(50% - ${e.h/2}vh)`,r.style.width=`${i.w}vh`,r.style.height=`${i.h}vh`,r.style.left=`calc(50% - ${i.w/2}vh)`,r.style.top=`calc(50% - ${i.h/2}vh)`}i.appendChild(r),this._loadingDiv.appendChild(t),this._loadingDiv.appendChild(i),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",(()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)})))}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}Dh.DefaultLogoUrl="",Dh.DefaultSpinnerUrl="",ne.$.DefaultLoadingScreenFactory=e=>new Dh(e);var Fh=i(84254),Lh=i(89617),wh=i(60554),Bh=i(9783);class Vh{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=(0,it.ILog2)(t)+1,r=this._effectWrapper.effect,n=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();const s=e.getInternalTexture();s&&this._engine.updateTextureSamplingMode(3,s,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const a=[[new wo.Pq(0,0,-1),new wo.Pq(0,-1,0),new wo.Pq(1,0,0)],[new wo.Pq(0,0,1),new wo.Pq(0,-1,0),new wo.Pq(-1,0,0)],[new wo.Pq(1,0,0),new wo.Pq(0,0,1),new wo.Pq(0,1,0)],[new wo.Pq(1,0,0),new wo.Pq(0,0,-1),new wo.Pq(0,-1,0)],[new wo.Pq(1,0,0),new wo.Pq(0,-1,0),new wo.Pq(0,0,1)],[new wo.Pq(-1,0,0),new wo.Pq(0,-1,0),new wo.Pq(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let e=0;e<6;e++){r.setVector3("up",a[e][0]),r.setVector3("right",a[e][1]),r.setVector3("front",a[e][2]);for(let s=0;s<i;s++){this._engine.bindFramebuffer(n,e,void 0,void 0,!0,s),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let i=Math.pow(2,(s-this._lodGenerationOffset)/this._lodGenerationScale)/t;0===s&&(i=0),r.setFloat("alphaG",i),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);const o=n.texture.type,l=n.texture.format;return n._swapAndDie(e._texture),e._texture.type=o,e._texture.format=l,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){const r=[];e.gammaSpace&&r.push("#define GAMMA_INPUT"),r.push("#define NUM_SAMPLES "+this.quality+"u");const n=this._engine.isWebGPU;return new Ks.$({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:r,onCompiled:t,shaderLanguage:n?1:0,extraInitializationsAsync:async()=>{n?await Promise.all([Promise.resolve().then(i.bind(i,43644)),Promise.resolve().then(i.bind(i,37110))]):await Promise.all([Promise.resolve().then(i.bind(i,12409)),Promise.resolve().then(i.bind(i,76175))])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise((i=>{this._effectRenderer=new Ks.J(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled((()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()}))})):(f.V.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}var kh=i(89783);i(45688);class Gh extends Vo.t{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(s.uq.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,r=!1,a=!0,o=!1,l=!1,c=null,h=null,u=!1){super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=s.Pq.Zero(),this.onLoadObservable=new n.cP,e&&(this._coordinatesMode=_e.g.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=s.uq.Identity(),this._prefilterOnLoad=l,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),c&&c()},this._onError=h,this.gammaSpace=o,this._noMipmap=r,this._size=i,this._supersample=u,this._generateHarmonics=a,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?re.S0.SetImmediate((()=>this._onLoad())):this._texture.onLoadedObservable.add(this._onLoad):this.getScene()?.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;if(t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2),e._features.allowTexturePrefiltering&&this._prefilterOnLoad){const t=this._onLoad,i=new Vh(e);this._onLoad=()=>{i.prefilter(this,t)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,(e=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const t=(0,wh.VH)(e,this._size,this._supersample);if(this._generateHarmonics){const e=Bh.d.ConvertCubeMapToSphericalPolynomial(t);this.sphericalPolynomial=e}const r=[];let n=null,s=null;for(let e=0;e<6;e++){2===i?s=new Uint16Array(this._size*this._size*3):0===i&&(n=new Uint8Array(this._size*this._size*3));const a=t[Gh._FacesMapping[e]];if(this.gammaSpace||s||n)for(let e=0;e<this._size*this._size;e++)if(this.gammaSpace&&(a[3*e+0]=Math.pow(a[3*e+0],Ee.rv),a[3*e+1]=Math.pow(a[3*e+1],Ee.rv),a[3*e+2]=Math.pow(a[3*e+2],Ee.rv)),s&&(s[3*e+0]=(0,kh.LZ)(a[3*e+0]),s[3*e+1]=(0,kh.LZ)(a[3*e+1]),s[3*e+2]=(0,kh.LZ)(a[3*e+2])),n){let t=Math.max(255*a[3*e+0],0),i=Math.max(255*a[3*e+1],0),r=Math.max(255*a[3*e+2],0);const s=Math.max(Math.max(t,i),r);if(s>255){const e=255/s;t*=e,i*=e,r*=e}n[3*e+0]=t,n[3*e+1]=i,n[3*e+2]=r}s?r.push(s):n?r.push(n):r.push(a)}return r}),null,this._onLoad,this._onError)}clone(){const e=new Gh(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this)))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let r=null;return e.name&&!e.isRenderTarget&&(r=new Gh(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),r.name=e.name,r.hasAlpha=e.hasAlpha,r.level=e.level,r.coordinatesMode=e.coordinatesMode,r.isBlocking=e.isBlocking),r&&(e.boundingBoxPosition&&(r.boundingBoxPosition=s.Pq.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=s.Pq.FromArray(e.boundingBoxSize)),e.rotationY&&(r.rotationY=e.rotationY)),r}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}Gh._FacesMapping=["right","left","up","down","front","back"],(0,o.Y5)("BABYLON.HDRCubeTexture",Gh);var Uh=i(44211),zh=i(28567),Wh=i(13493),Hh=i(61529);class Yh{constructor(e=!0,t=10,i=CANNON){this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new s.PT,this._minus90X=new s.PT(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new s.PT(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=s.Pq.Zero(),this._tmpDeltaPosition=s.Pq.Zero(),this._tmpUnityRotation=new s.PT,this.BJSCANNON=i,this.isSupported()?(this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new Wh.G):f.V.Error("CannonJS is not available. Please make sure you included the js file.")}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const e of t)e.type!=mc.j.HeightmapImpostor&&e.type!==mc.j.PlaneImpostor&&e.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach((e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)})),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(n,r)}applyForce(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(n,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t)return void f.V.Warn("It was not possible to create a physics body for this object.");const i=e.physicsBody;i&&this.removePhysicsBody(e);const r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),n={mass:e.getParam("mass"),material:r},s=e.getParam("nativeOptions");for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&(n[e]=s[e]);e.physicsBody=new this.BJSCANNON.Body(n),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach((function(t){const r=i[t];e.physicsBody[t].set(r.x,r.y,r.z)})),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const i=t=>{if(!t.rotationQuaternion)return;const r=t.getPhysicsImpostor();if(r&&r.parent!==e&&t.parent){const i=t.getAbsolutePosition().subtract(t.parent.getAbsolutePosition()),n=t.rotationQuaternion.multiply(this._tmpQuaternion);r.physicsBody&&(this.removePhysicsBody(r),r.physicsBody=null),r.parent=e,r.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(r),new this.BJSCANNON.Vec3(i.x,i.y,i.z),new this.BJSCANNON.Quaternion(n.x,n.y,n.z,n.w)),e.physicsBody.mass+=r.getParam("mass")}t.getChildMeshes(!0).filter((e=>!!e.physicsImpostor)).forEach(i)};t.filter((e=>!!e.physicsImpostor)).forEach(i)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r;const n=e.joint.jointData,s={pivotA:n.mainPivot?(new this.BJSCANNON.Vec3).set(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z):null,pivotB:n.connectedPivot?(new this.BJSCANNON.Vec3).set(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z):null,axisA:n.mainAxis?(new this.BJSCANNON.Vec3).set(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z):null,axisB:n.connectedAxis?(new this.BJSCANNON.Vec3).set(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z):null,maxForce:n.nativeParams.maxForce,collideConnected:!!n.collision};switch(e.joint.type){case zh.W$.HingeJoint:case zh.W$.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,s);break;case zh.W$.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,n.maxDistance||2);break;case zh.W$.SpringJoint:{const e=n;r=new this.BJSCANNON.Spring(t,i,{restLength:e.length,stiffness:e.stiffness,damping:e.damping,localAnchorA:s.pivotA,localAnchorB:s.pivotB});break}case zh.W$.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,s);break;case zh.W$.PointToPointJoint:case zh.W$.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,s.pivotA,i,s.pivotB,s.maxForce)}r.collideConnected=!!n.collision,e.joint.physicsJoint=r,e.joint.type!==zh.W$.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==zh.W$.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,n;for(r=0;r<this._physicsMaterials.length;r++)if(n=this._physicsMaterials[r],n.friction===t&&n.restitution===i)return n;const s=new this.BJSCANNON.Material(e);return s.friction=t,s.restitution=i,this._physicsMaterials.push(s),s}_checkWithEpsilon(e){return e<Ee.bH?Ee.bH:e}_createShape(e){const t=e.object;let i;const r=e.getObjectExtents();switch(e.type){case mc.j.SphereImpostor:{const e=r.x,t=r.y,n=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(e),this._checkWithEpsilon(t),this._checkWithEpsilon(n))/2);break}case mc.j.CylinderImpostor:{let t=e.getParam("nativeOptions");t||(t={});const n=void 0!==t.radiusTop?t.radiusTop:this._checkWithEpsilon(r.x)/2,s=void 0!==t.radiusBottom?t.radiusBottom:this._checkWithEpsilon(r.x)/2,a=void 0!==t.height?t.height:this._checkWithEpsilon(r.y),o=void 0!==t.numSegments?t.numSegments:16;i=new this.BJSCANNON.Cylinder(n,s,a,o);const l=new this.BJSCANNON.Quaternion;l.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const c=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(c,l);break}case mc.j.BoxImpostor:{const e=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(e.x),this._checkWithEpsilon(e.y),this._checkWithEpsilon(e.z)));break}case mc.j.PlaneImpostor:f.V.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case mc.j.MeshImpostor:{const r=t.getVerticesData?t.getVerticesData(Ue.R.PositionKind):[],n=t.getIndices?t.getIndices():[];if(!r)return void f.V.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");const a=t.position.clone(),o=t.rotation&&t.rotation.clone(),l=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const c=t.computeWorldMatrix(!0),h=[];let u;for(u=0;u<r.length;u+=3)s.Pq.TransformCoordinates(s.Pq.FromArray(r,u),c).toArray(h,u);f.V.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(h,n),t.position.copyFrom(a),o&&t.rotation&&t.rotation.copyFrom(o),l&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(l);break}case mc.j.HeightmapImpostor:{const r=t.position.clone(),n=t.rotation&&t.rotation.clone(),s=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(r),n&&t.rotation&&t.rotation.copyFrom(n),s&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(s),t.computeWorldMatrix(!0);break}case mc.j.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case mc.j.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return i}_createHeightmap(e,t){let i=e.getVerticesData(Ue.R.PositionKind);const r=e.computeWorldMatrix(!0),n=[];let a;for(a=0;a<i.length;a+=3)s.Pq.TransformCoordinates(s.Pq.FromArray(i,a),r).toArray(n,a);i=n;const o=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),h=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),u=c.boundingBox.extendSizeWorld.z,d=2*h/l;for(let e=0;e<i.length;e+=3){const t=Math.round(i[e+0]/d+l/2),r=Math.round(-1*(i[e+1]/d-l/2)),n=-i[e+2]+u;o[t]||(o[t]=[]),o[t][r]||(o[t][r]=n),o[t][r]=Math.max(n,o[t][r])}for(let e=0;e<=l;++e){if(!o[e]){let t=1;for(;!o[(e+t)%l];)t++;o[e]=o[(e+t)%l].slice()}for(let t=0;t<=l;++t)if(!o[e][t]){let i,r=1;for(;void 0===i;)i=o[e][(t+r++)%l];o[e][t]=i}}const p=new this.BJSCANNON.Heightfield(o,{elementSize:d});return p.minY=u,p}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if(e.type!==mc.j.PlaneImpostor&&e.type!==mc.j.HeightmapImpostor||(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===mc.j.HeightmapImpostor){const e=t;let r=e.getBoundingInfo();const n=e.rotationQuaternion;e.rotationQuaternion=this._tmpUnityRotation,e.computeWorldMatrix(!0);const a=i.clone();let o=e.getPivotMatrix();o=o?o.clone():s.uq.Identity();const l=s.uq.Translation(r.boundingBox.extendSizeWorld.x,0,-r.boundingBox.extendSizeWorld.z);e.setPreTransformMatrix(l),e.computeWorldMatrix(!0),r=e.getBoundingInfo();const c=r.boundingBox.centerWorld.subtract(i).subtract(e.position).negate();this._tmpPosition.copyFromFloats(c.x,c.y-r.boundingBox.extendSizeWorld.y,c.z),this._tmpDeltaPosition.copyFrom(r.boundingBox.centerWorld.subtract(a)),this._tmpDeltaPosition.y+=r.boundingBox.extendSizeWorld.y,e.rotationQuaternion=n,e.setPreTransformMatrix(o),e.computeWorldMatrix(!0)}else e.type===mc.j.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new s.Pq(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new s.Pq(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,n){if(n=n||10,0===(r=r||0))this.internalStep(i),this.time+=i;else{let s=Math.floor((this.time+r)/i)-Math.floor(this.time/i);s=Math.min(s,n)||1;const a=performance.now();for(let e=0;e!==s&&(this.internalStep(i),!(performance.now()-a>1e3*i));e++);this.time+=r;const o=this.time%i/i,l=e,c=this.bodies;for(let e=0;e!==c.length;e++){const i=c[e];i.type!==t.Body.STATIC&&i.sleepState!==t.Body.SLEEPING?(i.position.vsub(i.previousPosition,l),l.scale(o,l),i.position.vadd(l,i.interpolatedPosition)):(i.interpolatedPosition.set(i.position.x,i.position.y,i.position.z),i.interpolatedQuaternion.set(i.quaternion.x,i.quaternion.y,i.quaternion.z,i.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}Hh.A.DefaultPluginFactory=()=>new Yh;class Xh{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=s.Pq.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new Wh.G}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach((function(e){e.beforeStep()})),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach((e=>{e.afterStep(),this._tmpImpostorsArray[e.uniqueId]=e}));let i=this.world.contacts;for(;null!==i;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const e=this._tmpImpostorsArray[+i.body1.name],t=this._tmpImpostorsArray[+i.body2.name];e&&t?(e.onCollide({body:t.physicsBody,point:null,distance:0,impulse:0,normal:null}),t.onCollide({body:e.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next):i=i.next}}applyImpulse(e,t,i){const r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){f.V.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent)e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());else{if(e.isBodyInitRequired()){const i={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},r=[e];(t=e.object).getChildMeshes&&t.getChildMeshes().forEach((function(e){e.physicsImpostor&&r.push(e.physicsImpostor)}));const n=e=>Math.max(e,Ee.bH),a=new s.PT;r.forEach((t=>{if(!t.object.rotationQuaternion)return;const r=t.object.rotationQuaternion;a.copyFrom(r),t.object.rotationQuaternion.set(0,0,0,1),t.object.computeWorldMatrix(!0);const s=a.toEulerAngles(),o=t.getObjectExtents(),l=57.29577951308232;if(t===e){const t=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(t,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),i.pos.push(t.x),i.pos.push(t.y),i.pos.push(t.z),i.posShape.push(0,0,0),i.rotShape.push(0,0,0)}else{const e=t.object.position.clone();i.posShape.push(e.x),i.posShape.push(e.y),i.posShape.push(e.z),i.rotShape.push(s.x*l,s.y*l,s.z*l)}switch(t.object.rotationQuaternion.copyFrom(a),t.type){case mc.j.ParticleImpostor:f.V.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case mc.j.SphereImpostor:{const e=o.x,t=o.y,r=o.z,s=Math.max(n(e),n(t),n(r))/2;i.type.push("sphere"),i.size.push(s),i.size.push(s),i.size.push(s);break}case mc.j.CylinderImpostor:{const e=n(o.x)/2,t=n(o.y);i.type.push("cylinder"),i.size.push(e),i.size.push(t),i.size.push(t);break}case mc.j.PlaneImpostor:case mc.j.BoxImpostor:default:{const e=n(o.x),t=n(o.y),r=n(o.z);i.type.push("box"),i.size.push(e),i.size.push(t),i.size.push(r);break}}t.object.rotationQuaternion=r})),e.physicsBody=this.world.add(i),e.physicsBody.resetQuaternion(a),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}var t}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const r=e.joint.jointData,n=r.nativeParams||{};let s;const a={body1:t,body2:i,axe1:n.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:n.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:n.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:n.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:n.min,max:n.max,collision:n.collision||r.collision,spring:n.spring,world:this.world};switch(e.joint.type){case zh.W$.BallAndSocketJoint:s="jointBall";break;case zh.W$.SpringJoint:{f.V.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const e=r;a.min=e.length||a.min,a.max=Math.max(a.min,a.max)}case zh.W$.DistanceJoint:s="jointDistance",a.max=r.maxDistance;break;case zh.W$.PrismaticJoint:s="jointPrisme";break;case zh.W$.SliderJoint:s="jointSlide";break;case zh.W$.WheelJoint:s="jointWheel";break;case zh.W$.HingeJoint:default:s="jointHinge"}a.type=s,e.joint.physicsJoint=this.world.add(a)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){f.V.Warn(e)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new s.Pq(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new s.Pq(t.x,t.y,t.z):null}setBodyMass(e,t){const i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){void 0!==i?f.V.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setMotor(t,i)}setLimit(e,t,i,r){const n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setLimit(t,void 0===i?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth}dispose(){this.world.clear()}raycast(e,t){return f.V.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){f.V.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}var qh=i(88403);kt.Z.prototype.removeReflectionProbe=function(e){if(!this.reflectionProbes)return-1;const t=this.reflectionProbes.indexOf(e);return-1!==t&&this.reflectionProbes.splice(t,1),t},kt.Z.prototype.addReflectionProbe=function(e){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(e)};class $h{constructor(e,t,i,r=!0,n=!1,a=!1){if(this.name=e,this._viewMatrix=s.uq.Identity(),this._target=s.Pq.Zero(),this._add=s.Pq.Zero(),this._invertYAxis=!1,this.position=s.Pq.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let t=0;t<6;++t)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${t}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let o=0;if(n){const e=this._scene.getEngine().getCaps();e.textureHalfFloatRender?o=2:e.textureFloatRender&&(o=1)}this._renderTargetTexture=new Si.$(e,t,i,r,!0,o,!0),this._renderTargetTexture.gammaSpace=!a,this._renderTargetTexture.invertZ=i.useRightHandedSystem;const l=i.getEngine().useReverseDepthBuffer;let c;this._renderTargetTexture.onBeforeRenderObservable.add((e=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[e]),i.getSceneUniformBuffer().unbindEffect()),e){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const t=i.useRightHandedSystem?s.uq.LookAtRHToRef:s.uq.LookAtLHToRef,r=i.useRightHandedSystem?s.uq.PerspectiveFovRH:s.uq.PerspectiveFovLH;t(this.position,this._target,s.Pq.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=r(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position})),this._renderTargetTexture.onBeforeBindObservable.add((()=>{this._currentSceneUBO=i.getSceneUniformBuffer(),i.getEngine()._debugPushGroup?.(`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,a&&(i.imageProcessingConfiguration.applyByPostProcess=!0)})),this._renderTargetTexture.onAfterUnbindObservable.add((()=>{i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),i.getEngine()._debugPopGroup?.(1)}))}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const e=this._parentContainer.reflectionProbes.indexOf(this);e>-1&&this._parentContainer.reflectionProbes.splice(e,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=pe.p.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const n=t.reflectionProbes[i];if(n.name===e.name){r=n;break}}return r=pe.p.Parse((()=>r||new $h(e.name,e.renderTargetSize,t,e._generateMipMaps)),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}}(0,ue.Cg)([(0,de.xG)()],$h.prototype,"_attachedMesh",void 0),(0,ue.Cg)([(0,de.P_)()],$h.prototype,"position",void 0);class jh{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,n){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=n,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}class Kh extends jh{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new n.cP,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new a.ov(1,1,1,1),this.position=s.Pq.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,n=null){this._onAnimationEnd=n,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){const i=new Kh(e.name,t);return i.position=s.Pq.FromArray(e.position),i.color=a.ov.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}var Zh=i(39626);kt.Z.prototype._internalPickSprites=function(e,t,i,r){if(!Ji.G)return null;let n=null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){const a=this.spriteManagers[s];if(!a.isPickable)continue;const o=a.intersects(e,r,t,i);if(o&&o.hit&&(i||null==n||!(o.distance>=n.distance))&&(n=o,i))break}return n||new Ji.G},kt.Z.prototype._internalMultiPickSprites=function(e,t,i){if(!Ji.G)return null;let r=[];if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){const s=this.spriteManagers[n];if(!s.isPickable)continue;const a=s.multiIntersects(e,i,t);null!==a&&(r=r.concat(a))}return r},kt.Z.prototype.pickSprite=function(e,t,i,r,n){if(!this._tempSpritePickingRay)return null;(0,Zh.oZ)(this,e,t,this._tempSpritePickingRay,n);const s=this._internalPickSprites(this._tempSpritePickingRay,i,r,n);return s&&(s.ray=(0,Zh.AU)(this,e,t,n)),s},kt.Z.prototype.pickSpriteWithRay=function(e,t,i,r){if(!this._tempSpritePickingRay)return null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}Zh.Rl.TransformToRef(e,r.getViewMatrix(),this._tempSpritePickingRay);const n=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return n&&(n.ray=e),n},kt.Z.prototype.multiPickSprite=function(e,t,i,r){return(0,Zh.oZ)(this,e,t,this._tempSpritePickingRay,r),this._internalMultiPickSprites(this._tempSpritePickingRay,i,r)},kt.Z.prototype.multiPickSpriteWithRay=function(e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}return Zh.Rl.TransformToRef(e,i.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)},kt.Z.prototype.setPointerOverSprite=function(e){this._pointerOverSprite!==e&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,c.X.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=e,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,c.X.CreateNewFromSprite(this._pointerOverSprite,this)))},kt.Z.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class Qh{constructor(e){this.name=Gt.v.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=Zh.Rl?Zh.Rl.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new n.cP,this.scene.onAfterSpritesRenderingObservable=new n.cP,this._spritePredicate=e=>!!e.actionManager&&e.isPickable&&e.actionManager.hasPointerTriggers}register(){this.scene._pointerMoveStage.registerStep(Gt.v.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(Gt.v.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(Gt.v.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,n){const s=this.scene.pickSprite(t,i,this._spritePredicate,r,n);return s&&(s.ray=e?e.ray:null),s}_pointerMove(e,t,i,r,n){const s=this.scene;return r?s.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,s.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite?(s.setPointerOverSprite(i.pickedSprite),!s.doNotHandleCursors&&n&&(s._pointerOverSprite&&s._pointerOverSprite.actionManager&&s._pointerOverSprite.actionManager.hoverCursor?n.style.cursor=s._pointerOverSprite.actionManager.hoverCursor:n.style.cursor=s.hoverCursor)):s.setPointerOverSprite(null),i}_pointerDown(e,t,i,r){const n=this.scene;if(n._pickedDownSprite=null,n.spriteManagers&&n.spriteManagers.length>0&&(i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager){switch(n._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,c.X.CreateNewFromSprite(i.pickedSprite,n,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,c.X.CreateNewFromSprite(i.pickedSprite,n,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,c.X.CreateNewFromSprite(i.pickedSprite,n,r))}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,c.X.CreateNewFromSprite(i.pickedSprite,n,r))}return i}_pointerUp(e,t,i,r,n){const s=this.scene;if(s.spriteManagers&&s.spriteManagers.length>0){const i=s.pickSprite(e,t,this._spritePredicate,!1,s.cameraToUseForPointers||void 0);i&&(i.hit&&i.pickedSprite&&i.pickedSprite.actionManager&&(i.pickedSprite.actionManager.processTrigger(7,c.X.CreateNewFromSprite(i.pickedSprite,s,r)),i.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||i.pickedSprite.actionManager.processTrigger(1,c.X.CreateNewFromSprite(i.pickedSprite,s,r)),n&&i.pickedSprite.actionManager.processTrigger(6,c.X.CreateNewFromSprite(i.pickedSprite,s,r)))),s._pickedDownSprite&&s._pickedDownSprite.actionManager&&s._pickedDownSprite!==i.pickedSprite&&s._pickedDownSprite.actionManager.processTrigger(16,c.X.CreateNewFromSprite(s._pickedDownSprite,s,r)))}return i}}class Jh{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&f.V.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,r=null,n){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=n?.pixelPerfect??!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=r,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new Ue.h(e,this._vertexData,!0,this._vertexBufferSize);const s=this._buffer.createVertexBuffer(Ue.R.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),a=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let o,l=6;if(this._useInstancing){const t=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new Ue.h(e,t,!1,2),o=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else o=this._buffer.createVertexBuffer("offsets",l,2,this._vertexBufferSize,this._useInstancing),l+=2;const c=this._buffer.createVertexBuffer("inverts",l,2,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("cellInfo",l+2,4,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer(Ue.R.ColorKind,l+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Ue.R.PositionKind]=s,this._vertexBuffers.options=a,this._vertexBuffers.offsets=o,this._vertexBuffers.inverts=c,this._vertexBuffers.cellInfo=h,this._vertexBuffers[Ue.R.ColorKind]=u,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!Jh.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,20468)),Promise.resolve().then(i.bind(i,75393))])):await Promise.all([Promise.resolve().then(i.bind(i,18467)),Promise.resolve().then(i.bind(i,49481))]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){if(this._isDisposed||!this._shadersLoaded)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new ec.E(this._engine),this._drawWrapperDepth=new ec.E(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+="#define PIXEL_PERFECT\n"),this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode&&this._fogEnabled&&(e+="#define FOG\n"),this._useLogarithmicDepth&&(e+="#define LOGARITHMICDEPTH\n"),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[Ue.R.PositionKind,"options","offsets","inverts","cellInfo",Ue.R.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,n=null){if(!(this._shadersLoaded&&this.texture&&this.texture.isReady()&&e.length))return;const s=this._drawWrapperBase,a=this._drawWrapperDepth,o=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode,l=s.effect;if(!l.isReady())return;const c=this._engine,h=!(!this._scene||!this._scene.useRightHandedSystem),u=Math.min(this._capacity,e.length);let d=0,p=!0;for(let i=0;i<u;i++){const r=e[i];if(!r||!r.isVisible)continue;p=!1,r._animate(t);const s=this.texture.getBaseSize();this._appendSpriteVertex(d++,r,0,0,s,h,n),this._useInstancing||(this._appendSpriteVertex(d++,r,1,0,s,h,n),this._appendSpriteVertex(d++,r,1,1,s,h,n),this._appendSpriteVertex(d++,r,0,1,s,h,n))}if(p)return;this._buffer.update(this._vertexData);const f=!!c.depthCullingState.cull,m=c.depthCullingState.zOffset,_=c.depthCullingState.zOffsetUnits;if(c.setState(f,m,!1,!1,void 0,void 0,_),c.enableEffect(s),l.setTexture("diffuseSampler",this.texture),l.setMatrix("view",i),l.setMatrix("projection",r),o){const e=this._scene;l.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),l.setColor3("vFogColor",e.fogColor)}this.useLogarithmicDepth&&this._scene&&(0,qo.DL)(s.defines,l,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=c.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,l)),c.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):c.bindBuffers(this._vertexBuffers,this._indexBuffer,l),c.depthCullingState.depthFunc=c.useReverseDepthBuffer?518:515,this.disableDepthWrite||(l.setBool("alphaTest",!0),c.setColorWrite(!1),c.enableEffect(a),this._useInstancing?c.drawArraysType(7,0,4,d):c.drawElementsType(0,0,d/4*6),c.enableEffect(s),c.setColorWrite(!0),l.setBool("alphaTest",!1)),c.setAlphaMode(this.blendMode),this._useInstancing?c.drawArraysType(7,0,4,d):c.drawElementsType(0,0,d/4*6),this.autoResetAlpha&&c.setAlphaMode(0),h&&this._scene.getEngine().setState(f,m,!1,!0,void 0,void 0,_),c.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,n,s,a){let o=e*this._vertexBufferSize;if(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),a)a(t,n);else{t.cellIndex||(t.cellIndex=0);const e=n.width/this.cellWidth,i=t.cellIndex/e|0;t._xOffset=(t.cellIndex-i*e)*this.cellWidth/n.width,t._yOffset=i*this.cellHeight/n.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[o]=t.position.x,this._vertexData[o+1]=t.position.y,this._vertexData[o+2]=t.position.z,this._vertexData[o+3]=t.angle,this._vertexData[o+4]=t.width,this._vertexData[o+5]=t.height,this._useInstancing?o-=2:(this._vertexData[o+6]=i,this._vertexData[o+7]=r),this._vertexData[o+8]=s?t.invertU?0:1:t.invertU?1:0,this._vertexData[o+9]=t.invertV?1:0,this._vertexData[o+10]=t._xOffset,this._vertexData[o+11]=t._yOffset,this._vertexData[o+12]=t._xSize/n.width,this._vertexData[o+13]=t._ySize/n.height,this._vertexData[o+14]=t.color.r,this._vertexData[o+15]=t.color.g,this._vertexData[o+16]=t.color.b,this._vertexData[o+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}Jh.ForceGLSL=!1;class eu{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=_e.g.CLAMP_ADDRESSMODE,e.wrapV=_e.g.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&3!==this.texture.samplingMode&&this.texture.updateSamplingMode(3)}constructor(e,t,i,r,s,a=.01,o=_e.g.TRILINEAR_SAMPLINGMODE,l=!1,c=null,h){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new n.cP,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(e,t)=>{e.cellRef||(e.cellIndex=0);const i=e.cellIndex;"number"==typeof i&&isFinite(i)&&Math.floor(i)===i&&(e.cellRef=this._spriteMap[e.cellIndex]),e._xOffset=this._cellData[e.cellRef].frame.x/t.width,e._yOffset=this._cellData[e.cellRef].frame.y/t.height,e._xSize=this._cellData[e.cellRef].frame.w,e._ySize=this._cellData[e.cellRef].frame.h},s||(s=P.q.LastCreatedScene),s._getComponent(Gt.v.NAME_SPRITE)||s._addComponent(new Qh(s)),this._fromPacked=l,this._scene=s;const u=this._scene.getEngine();if(this._spriteRenderer=new Jh(u,i,a,s,h?.spriteRendererOptions),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else{if(void 0===r)return void(this._spriteRenderer=null);this.cellWidth=r,this.cellHeight=r}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new _e.g(t,s,!0,!1,o)),this._fromPacked&&this._makePacked(t,c)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(null!==t)try{let e;if(e="string"==typeof t?JSON.parse(t):t,e.frames.length){const t={};for(let i=0;i<e.frames.length;i++){const r=e.frames[i];if("string"!=typeof Object.keys(r)[0])throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");t[r[Object.keys(r)[0]]]=r}e.frames=t}const i=Reflect.ownKeys(e.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=e.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const t=/\./g;let i;do{i=t.lastIndex,t.test(e)}while(t.lastIndex>0);const r=e.substring(0,i-1)+".json",n=()=>{f.V.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},s=e=>{try{const t=JSON.parse(e),i=Reflect.ownKeys(t.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=t.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};re.S0.LoadFile(r,s,void 0,void 0,!1,n)}}_checkTextureAlpha(e,t,i,r,n){if(!e.useAlphaForPicking||!this.texture)return!0;const a=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(a.width*a.height*4),this.texture.readPixels(0,0,this._textureContent));const o=s.AA.Vector3[0];o.copyFrom(t.direction),o.normalize(),o.scaleInPlace(i),o.addInPlace(t.origin);const l=(o.x-r.x)/(n.x-r.x),c=1-(o.y-r.y)/(n.y-r.y),h=e._xOffset*a.width+l*e._xSize|0,u=e._yOffset*a.height+c*e._ySize|0;return this._textureContent[4*(h+u*a.width)+3]>.5}intersects(e,t,i,r){const n=Math.min(this.capacity,this.sprites.length),a=s.Pq.Zero(),o=s.Pq.Zero();let l=Number.MAX_VALUE,c=null;const h=s.AA.Vector3[0],u=s.AA.Vector3[1],d=t.getViewMatrix();let p=e,f=e;for(let t=0;t<n;t++){const n=this.sprites[t];if(n){if(i){if(!i(n))continue}else if(!n.isPickable)continue;if(s.Pq.TransformCoordinatesToRef(n.position,d,u),n.angle?(s.uq.TranslationToRef(-u.x,-u.y,0,s.AA.Matrix[1]),s.uq.TranslationToRef(u.x,u.y,0,s.AA.Matrix[2]),s.uq.RotationZToRef(-n.angle,s.AA.Matrix[3]),s.AA.Matrix[1].multiplyToRef(s.AA.Matrix[3],s.AA.Matrix[4]),s.AA.Matrix[4].multiplyToRef(s.AA.Matrix[2],s.AA.Matrix[0]),p=e.clone(),s.Pq.TransformCoordinatesToRef(e.origin,s.AA.Matrix[0],p.origin),s.Pq.TransformNormalToRef(e.direction,s.AA.Matrix[0],p.direction)):p=e,a.copyFromFloats(u.x-n.width/2,u.y-n.height/2,u.z),o.copyFromFloats(u.x+n.width/2,u.y+n.height/2,u.z),p.intersectsBoxMinMax(a,o)){const e=s.Pq.Distance(u,p.origin);if(l>e){if(!this._checkTextureAlpha(n,p,e,a,o))continue;if(f=p,l=e,c=n,r)break}}}}if(c){const e=new Ji.G;d.invertToRef(s.AA.Matrix[0]),e.hit=!0,e.pickedSprite=c,e.distance=l;const t=s.AA.Vector3[2];return t.copyFrom(f.direction),t.normalize(),t.scaleInPlace(l),f.origin.addToRef(t,h),e.pickedPoint=s.Pq.TransformCoordinates(h,s.AA.Matrix[0]),e}return null}multiIntersects(e,t,i){const r=Math.min(this.capacity,this.sprites.length),n=s.Pq.Zero(),a=s.Pq.Zero();let o;const l=[],c=s.AA.Vector3[0].copyFromFloats(0,0,0),h=s.AA.Vector3[1].copyFromFloats(0,0,0),u=t.getViewMatrix();for(let t=0;t<r;t++){const r=this.sprites[t];if(r){if(i){if(!i(r))continue}else if(!r.isPickable)continue;if(s.Pq.TransformCoordinatesToRef(r.position,u,h),n.copyFromFloats(h.x-r.width/2,h.y-r.height/2,h.z),a.copyFromFloats(h.x+r.width/2,h.y+r.height/2,h.z),e.intersectsBoxMinMax(n,a)){if(o=s.Pq.Distance(h,e.origin),!this._checkTextureAlpha(r,e,o,n,a))continue;const t=new Ji.G;l.push(t),u.invertToRef(s.AA.Matrix[0]),t.hit=!0,t.pickedSprite=r,t.distance=o;const i=s.AA.Vector3[2];i.copyFrom(e.direction),i.normalize(),i.scaleInPlace(o),e.origin.addToRef(i,c),t.pickedPoint=s.Pq.TransformCoordinates(c,s.AA.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const e=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){this._spriteRenderer?.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const e of this.sprites)t.sprites.push(e.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const r=new eu(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);void 0!==e.fogEnabled&&(r.fogEnabled=e.fogEnabled),void 0!==e.blendMode&&(r.blendMode=e.blendMode),void 0!==e.disableDepthWrite&&(r.disableDepthWrite=e.disableDepthWrite),void 0!==e.pixelPerfect&&(r.pixelPerfect=e.pixelPerfect),void 0!==e.useLogarithmicDepth&&(r.useLogarithmicDepth=e.useLogarithmicDepth),void 0!==e.metadata&&(r.metadata=e.metadata),e.texture?r.texture=_e.g.Parse(e.texture,t,i):e.textureName&&(r.texture=new _e.g(i+e.textureUrl,t,!1,void 0===e.invertY||e.invertY));for(const t of e.sprites)Kh.Parse(t,r);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise(((n,s)=>{const a=new aa.u;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const t=JSON.parse(a.responseText),s=eu.Parse(t,i||P.q.LastCreatedScene,r);e&&(s.name=e),n(s)}else s("Unable to load the sprite manager")})),a.open("GET",t),a.send()}))}static ParseFromSnippetAsync(e,t,i=""){return"_BLANK"===e?Promise.resolve(new eu("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise(((r,n)=>{const s=new aa.u;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const n=JSON.parse(JSON.parse(s.responseText).jsonPayload),a=JSON.parse(n.spriteManager),o=eu.Parse(a,t||P.q.LastCreatedScene,i);o.snippetId=e,r(o)}else n("Unable to load the snippet "+e)})),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()}))}}eu.SnippetUrl="https://snippet.babylonjs.com",eu.CreateFromSnippetAsync=eu.ParseFromSnippetAsync;var tu=!0;class iu{}iu.LoaderInjectedPhysicsEngine=void 0;let ru={},nu={},su={};const au=(e,t,i,r)=>{if(!t.materials)return null;for(let n=0,s=t.materials.length;n<s;n++){const s=t.materials[n];if(e(s))return{parsedMaterial:s,material:Zl.i.Parse(s,i,r)}}return null},ou=(e,t,i)=>{for(const r in t)if(e.name===t[r])return i.push(e.id),!0;return void 0!==e.parentId&&-1!==i.indexOf(e.parentId)&&(i.push(e.id),!0)},lu=(e,t)=>e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown"),cu=(e,t)=>{const i=t;if(t._waitingData.lods){if(t._waitingData.lods.ids&&t._waitingData.lods.ids.length>0){const r=t._waitingData.lods.ids,n=i.isEnabled(!1);if(t._waitingData.lods.distances){const s=t._waitingData.lods.distances;if(s.length>=r.length){const t=s.length>r.length?s[s.length-1]:0;i.setEnabled(!1);for(let t=0;t<r.length;t++){const n=r[t],a=e.getMeshById(n);null!=a&&i.addLODLevel(s[t],a)}t>0&&i.addLODLevel(t,null),!0===n&&i.setEnabled(!0)}else re.S0.Warn("Invalid level of detail distances for "+t.name)}}t._waitingData.lods=null}},hu=(e,t,i)=>{if("number"!=typeof e){const r=i.getLastEntryById(e);return r&&null!=t?r.instances[parseInt(t)]:r}const r=ru[e];return r&&null!=t?r.instances[parseInt(t)]:r},uu=(e,t)=>"number"!=typeof e?t.getLastMaterialById(e,!0):nu[e],du=(e,t,i,r,n=!1)=>{const s=new ie.WZ(e);let a="importScene has failed JSON parse";try{var l=JSON.parse(t);a="";const r=ol.cn.loggingLevel===ol.cn.DETAILED_LOGGING;let n,c;if(void 0!==l.environmentTexture&&null!==l.environmentTexture){const t=void 0===l.isPBR||l.isPBR;if(l.environmentTextureType&&"BABYLON.HDRCubeTexture"===l.environmentTextureType){const r=l.environmentTextureSize?l.environmentTextureSize:128,n=new Gh((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,r,!0,!t,void 0,l.environmentTexturePrefilterOnLoad);l.environmentTextureRotationY&&(n.rotationY=l.environmentTextureRotationY),e.environmentTexture=n}else if("object"==typeof l.environmentTexture){const t=Uo.b.Parse(l.environmentTexture,e,i);e.environmentTexture=t}else if(l.environmentTexture.endsWith(".env")){const t=new Uo.b((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}else{const t=Uo.b.CreateFromPrefilteredData((l.environmentTexture.match(/https?:\/\//g)?"":i)+l.environmentTexture,e,l.environmentTextureForcedExtension);l.environmentTextureRotationY&&(t.rotationY=l.environmentTextureRotationY),e.environmentTexture=t}if(!0===l.createDefaultSkybox){const i=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,r=l.skyboxBlurLevel||0;e.createDefaultSkybox(e.environmentTexture,t,i,r)}s.environmentTexture=e.environmentTexture}if(void 0!==l.environmentIntensity&&null!==l.environmentIntensity&&(e.environmentIntensity=l.environmentIntensity),void 0!==l.lights&&null!==l.lights)for(n=0,c=l.lights.length;n<c;n++){const t=l.lights[n],i=oh.v.Parse(t,e);i&&(ru[t.uniqueId]=i,s.lights.push(i),i._parentContainer=s,a+=0===n?"\n\tLights:":"",a+="\n\t\t"+i.toString(r))}if(void 0!==l.reflectionProbes&&null!==l.reflectionProbes)for(n=0,c=l.reflectionProbes.length;n<c;n++){const t=l.reflectionProbes[n],o=$h.Parse(t,e,i);o&&(s.reflectionProbes.push(o),o._parentContainer=s,a+=0===n?"\n\tReflection Probes:":"",a+="\n\t\t"+o.toString(r))}if(void 0!==l.animations&&null!==l.animations)for(n=0,c=l.animations.length;n<c;n++){const t=l.animations[n],i=(0,o.n9)("BABYLON.Animation");if(i){const o=i.Parse(t);e.animations.push(o),s.animations.push(o),a+=0===n?"\n\tAnimations:":"",a+="\n\t\t"+o.toString(r)}}if(void 0!==l.materials&&null!==l.materials)for(n=0,c=l.materials.length;n<c;n++){const t=l.materials[n],o=Zl.i.Parse(t,e,i);o&&(nu[t.uniqueId||t.id]=o,s.materials.push(o),o._parentContainer=s,a+=0===n?"\n\tMaterials:":"",a+="\n\t\t"+o.toString(r),o.getActiveTextures().forEach((e=>{-1==s.textures.indexOf(e)&&(s.textures.push(e),e._parentContainer=s)})))}if(void 0!==l.multiMaterials&&null!==l.multiMaterials)for(n=0,c=l.multiMaterials.length;n<c;n++){const t=l.multiMaterials[n],i=Lh.F.ParseMultiMaterial(t,e);nu[t.uniqueId||t.id]=i,s.multiMaterials.push(i),i._parentContainer=s,a+=0===n?"\n\tMultiMaterials:":"",a+="\n\t\t"+i.toString(r),i.getActiveTextures().forEach((e=>{-1==s.textures.indexOf(e)&&(s.textures.push(e),e._parentContainer=s)}))}if(void 0!==l.morphTargetManagers&&null!==l.morphTargetManagers)for(const t of l.morphTargetManagers){const i=Uh.j.Parse(t,e);su[t.id]=i,s.morphTargetManagers.push(i),i._parentContainer=s}if(void 0!==l.skeletons&&null!==l.skeletons)for(n=0,c=l.skeletons.length;n<c;n++){const t=l.skeletons[n],i=ve.E.Parse(t,e);s.skeletons.push(i),i._parentContainer=s,a+=0===n?"\n\tSkeletons:":"",a+="\n\t\t"+i.toString(r)}const h=l.geometries;if(null!=h){const t=new Array,r=h.vertexData;if(null!=r)for(n=0,c=r.length;n<c;n++){const s=r[n];t.push(Fh.V.Parse(s,e,i))}t.forEach((e=>{e&&(s.geometries.push(e),e._parentContainer=s)}))}if(void 0!==l.transformNodes&&null!==l.transformNodes)for(n=0,c=l.transformNodes.length;n<c;n++){const t=l.transformNodes[n],r=ui.V.Parse(t,e,i);ru[t.uniqueId]=r,s.transformNodes.push(r),r._parentContainer=s}if(void 0!==l.meshes&&null!==l.meshes)for(n=0,c=l.meshes.length;n<c;n++){const t=l.meshes[n],o=Rt.e.Parse(t,e,i);if(ru[t.uniqueId]=o,s.meshes.push(o),o._parentContainer=s,o.hasInstances)for(const e of o.instances)s.meshes.push(e),e._parentContainer=s;a+=0===n?"\n\tMeshes:":"",a+="\n\t\t"+o.toString(r)}if(void 0!==l.cameras&&null!==l.cameras)for(n=0,c=l.cameras.length;n<c;n++){const t=l.cameras[n],i=Ct.i.Parse(t,e);ru[t.uniqueId]=i,s.cameras.push(i),i._parentContainer=s,a+=0===n?"\n\tCameras:":"",a+="\n\t\t"+i.toString(r)}if(void 0!==l.postProcesses&&null!==l.postProcesses)for(n=0,c=l.postProcesses.length;n<c;n++){const t=l.postProcesses[n],r=jt.w.Parse(t,e,i);r&&(s.postProcesses.push(r),r._parentContainer=s,a+=0===n?"\nPostprocesses:":"",a+="\n\t\t"+r.toString())}if(void 0!==l.animationGroups&&null!==l.animationGroups)for(n=0,c=l.animationGroups.length;n<c;n++){const t=l.animationGroups[n],i=Z.AnimationGroup.Parse(t,e);s.animationGroups.push(i),i._parentContainer=s,a+=0===n?"\n\tAnimationGroups:":"",a+="\n\t\t"+i.toString(r)}if(l.spriteManagers)for(let t=0,r=l.spriteManagers.length;t<r;t++){const r=l.spriteManagers[t];a+="\n\t\tSpriteManager "+eu.Parse(r,e,i).name}for(n=0,c=e.cameras.length;n<c;n++){const t=e.cameras[n];null!==t._waitingParentId&&(t.parent=hu(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,c=e.lights.length;n<c;n++){const t=e.lights[n];t&&null!==t._waitingParentId&&(t.parent=hu(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,c=e.transformNodes.length;n<c;n++){const t=e.transformNodes[n];null!==t._waitingParentId&&(t.parent=hu(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(n=0,c=e.meshes.length;n<c;n++){const t=e.meshes[n];null!==t._waitingParentId&&(t.parent=hu(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null),t._waitingData.lods&&cu(e,t)}for(e.multiMaterials.forEach((t=>{t._waitingSubMaterialsUniqueIds.forEach((i=>{t.subMaterials.push(uu(i,e))})),t._waitingSubMaterialsUniqueIds=[]})),e.meshes.forEach((t=>{null!==t._waitingMaterialId&&(t.material=uu(t._waitingMaterialId,e),t._waitingMaterialId=null)})),e.meshes.forEach((e=>{null!==e._waitingMorphTargetManagerId&&(e.morphTargetManager=su[e._waitingMorphTargetManagerId],e._waitingMorphTargetManagerId=null)})),n=0,c=e.skeletons.length;n<c;n++){const t=e.skeletons[n];t._hasWaitingData&&(null!=t.bones&&t.bones.forEach((t=>{if(t._waitingTransformNodeId){const i=e.getLastEntryById(t._waitingTransformNodeId);i&&t.linkTransformNode(i),t._waitingTransformNodeId=null}})),t._hasWaitingData=null)}for(n=0,c=e.meshes.length;n<c;n++){const t=e.meshes[n];t._waitingData.freezeWorldMatrix?(t.freezeWorldMatrix(),t._waitingData.freezeWorldMatrix=null):t.computeWorldMatrix(!0)}for(n=0,c=e.lights.length;n<c;n++){const t=e.lights[n];if(t._excludedMeshesIds.length>0){for(let i=0;i<t._excludedMeshesIds.length;i++){const r=e.getMeshById(t._excludedMeshesIds[i]);r&&t.excludedMeshes.push(r)}t._excludedMeshesIds=[]}if(t._includedOnlyMeshesIds.length>0){for(let i=0;i<t._includedOnlyMeshesIds.length;i++){const r=e.getMeshById(t._includedOnlyMeshesIds[i]);r&&t.includedOnlyMeshes.push(r)}t._includedOnlyMeshesIds=[]}}for(e.geometries.forEach((e=>{e._loadedUniqueId=""})),(0,Dc.oj)(l,e,s,i),n=0,c=e.meshes.length;n<c;n++){const t=e.meshes[n];t._waitingData.actions&&(A.Parse(t._waitingData.actions,t,e),t._waitingData.actions=null)}void 0!==l.actions&&null!==l.actions&&A.Parse(l.actions,null,e)}catch(e){const t=lu("loadAssets",l?l.producer:"Unknown")+a;if(!r)throw f.V.Log(t),e;r(t,e)}finally{ru={},nu={},su={},n||s.removeAllFromScene(),null!==a&&ol.cn.loggingLevel!==ol.cn.NO_LOGGING&&f.V.Log(lu("loadAssets",l?l.producer:"Unknown")+(ol.cn.loggingLevel!==ol.cn.MINIMAL_LOGGING?a:""))}return s};ol.cn.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:e=>-1!==e.indexOf("babylon"),importMesh:(e,t,i,r,n,s,a,o)=>{let l="importMesh has failed JSON parse";try{var c=JSON.parse(i);l="";const o=ol.cn.loggingLevel===ol.cn.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;const h=[],u=new Map,d=[];if(void 0!==c.transformNodes&&null!==c.transformNodes)for(let e=0,i=c.transformNodes.length;e<i;e++){const i=c.transformNodes[e],n=ui.V.Parse(i,t,r);d.push(n),u.set(n._waitingParsedUniqueId,n),n._waitingParsedUniqueId=null}if(void 0!==c.meshes&&null!==c.meshes){const i=[],s=[],p=[],m=[];for(let d=0,_=c.meshes.length;d<_;d++){const _=c.meshes[d];if(null===e||ou(_,e,h)){if(null!==e&&delete e[e.indexOf(_.name)],void 0!==_.geometryId&&null!==_.geometryId&&void 0!==c.geometries&&null!==c.geometries){let e=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach((i=>{!0!==e&&c.geometries[i]&&Array.isArray(c.geometries[i])&&c.geometries[i].forEach((n=>{n.id===_.geometryId&&("vertexData"===i&&Fh.V.Parse(n,t,r),e=!0)}))})),!1===e&&f.V.Warn("Geometry not found for mesh "+_.id)}if(_.materialUniqueId||_.materialId){const e=_.materialUniqueId?p:s;let i=-1!==e.indexOf(_.materialUniqueId||_.materialId);if(!1===i&&void 0!==c.multiMaterials&&null!==c.multiMaterials){const n=(i,n)=>{e.push(i);const s=au(n,c,t,r);s&&s.material&&(nu[s.parsedMaterial.uniqueId||s.parsedMaterial.id]=s.material,l+="\n\tMaterial "+s.material.toString(o))};for(let r=0,s=c.multiMaterials.length;r<s;r++){const s=c.multiMaterials[r];if(_.materialUniqueId&&s.uniqueId===_.materialUniqueId||s.id===_.materialId){s.materialsUniqueIds?s.materialsUniqueIds.forEach((e=>n(e,(t=>t.uniqueId===e)))):s.materials.forEach((e=>n(e,(t=>t.id===e)))),e.push(s.uniqueId||s.id);const r=Lh.F.ParseMultiMaterial(s,t);nu[s.uniqueId||s.id]=r,r&&(i=!0,l+="\n\tMulti-Material "+r.toString(o));break}}}if(!1===i){e.push(_.materialUniqueId||_.materialId);const i=au((e=>_.materialUniqueId&&e.uniqueId===_.materialUniqueId||e.id===_.materialId),c,t,r);i&&i.material?(nu[i.parsedMaterial.uniqueId||i.parsedMaterial.id]=i.material,l+="\n\tMaterial "+i.material.toString(o)):f.V.Warn("Material not found for mesh "+_.id)}}if(null!==_.skeletonId&&void 0!==_.skeletonId&&-1!==c.skeletonId&&void 0!==c.skeletons&&null!==c.skeletons&&!(i.indexOf(_.skeletonId)>-1))for(let e=0,r=c.skeletons.length;e<r;e++){const r=c.skeletons[e];if(r.id===_.skeletonId){const e=ve.E.Parse(r,t);a.push(e),i.push(r.id),l+="\n\tSkeleton "+e.toString(o)}}if(_.morphTargetManagerId>-1&&void 0!==c.morphTargetManagers&&null!==c.morphTargetManagers&&!(m.indexOf(_.morphTargetManagerId)>-1))for(let e=0;e<c.morphTargetManagers.length;e++){const i=c.morphTargetManagers[e];if(i.id===_.morphTargetManagerId){const e=Uh.j.Parse(i,t);su[i.id]=e,m.push(i.id),l+="\nMorph target manager"+e.toString()}}const h=Rt.e.Parse(_,t,r);n.push(h),u.set(h._waitingParsedUniqueId,h),h._waitingParsedUniqueId=null,l+="\n\tMesh "+h.toString(o)}}t.multiMaterials.forEach((e=>{e._waitingSubMaterialsUniqueIds.forEach((i=>{e.subMaterials.push(uu(i,t))})),e._waitingSubMaterialsUniqueIds=[]})),t.meshes.forEach((e=>{null!==e._waitingMaterialId&&(e.material=uu(e._waitingMaterialId,t),e._waitingMaterialId=null)})),t.meshes.forEach((e=>{null!==e._waitingMorphTargetManagerId&&(e.morphTargetManager=su[e._waitingMorphTargetManagerId],e._waitingMorphTargetManagerId=null)}));for(let e=0,i=t.transformNodes.length;e<i;e++){const i=t.transformNodes[e];if(null!==i._waitingParentId){let e=u.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let r=e;i._waitingParentInstanceIndex&&(r=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=r,i._waitingParentId=null}}let _;for(let e=0,i=t.meshes.length;e<i;e++){if(_=t.meshes[e],_._waitingParentId){let e=u.get(parseInt(_._waitingParentId))||null;null===e&&(e=t.getLastEntryById(_._waitingParentId));let i=e;_._waitingParentInstanceIndex&&(i=e.instances[parseInt(_._waitingParentInstanceIndex)],_._waitingParentInstanceIndex=null),_.parent=i,_._waitingParentId=null}_._waitingData.lods&&cu(t,_)}for(const e of d)e.getChildMeshes(!1).length||e.dispose();for(let e=0,i=t.skeletons.length;e<i;e++){const i=t.skeletons[e];i._hasWaitingData&&(null!=i.bones&&i.bones.forEach((e=>{if(e._waitingTransformNodeId){const i=t.getLastEntryById(e._waitingTransformNodeId);i&&e.linkTransformNode(i),e._waitingTransformNodeId=null}})),i._hasWaitingData=null)}for(let e=0,i=t.meshes.length;e<i;e++)_=t.meshes[e],_._waitingData.freezeWorldMatrix?(_.freezeWorldMatrix(),_._waitingData.freezeWorldMatrix=null):_.computeWorldMatrix(!0)}if(void 0!==c.particleSystems&&null!==c.particleSystems){const e=(0,Dc.LO)(Gt.v.NAME_PARTICLESYSTEM);if(e)for(let i=0,n=c.particleSystems.length;i<n;i++){const n=c.particleSystems[i];-1!==h.indexOf(n.emitterId)&&s.push(e(n,t,r))}}return t.geometries.forEach((e=>{e._loadedUniqueId=""})),!0}catch(e){const t=lu("importMesh",c?c.producer:"Unknown")+l;if(!o)throw f.V.Log(t),e;o(t,e)}finally{null!==l&&ol.cn.loggingLevel!==ol.cn.NO_LOGGING&&f.V.Log(lu("importMesh",c?c.producer:"Unknown")+(ol.cn.loggingLevel!==ol.cn.MINIMAL_LOGGING?l:"")),nu={},su={}}return!1},load:(e,t,i,r)=>{let n="importScene has failed JSON parse";try{var o=JSON.parse(t);switch(n="",void 0!==o.useDelayedTextureLoading&&null!==o.useDelayedTextureLoading&&(e.useDelayedTextureLoading=o.useDelayedTextureLoading&&!ol.cn.ForceFullSceneLoadingForIncremental),void 0!==o.autoClear&&null!==o.autoClear&&(e.autoClear=o.autoClear),void 0!==o.clearColor&&null!==o.clearColor&&(e.clearColor=a.ov.FromArray(o.clearColor)),void 0!==o.ambientColor&&null!==o.ambientColor&&(e.ambientColor=a.v9.FromArray(o.ambientColor)),void 0!==o.gravity&&null!==o.gravity&&(e.gravity=s.Pq.FromArray(o.gravity)),void 0!==o.useRightHandedSystem&&(e.useRightHandedSystem=!!o.useRightHandedSystem),void 0!==o.fogMode&&null!==o.fogMode&&(e.fogMode=o.fogMode),void 0!==o.fogColor&&null!==o.fogColor&&(e.fogColor=a.v9.FromArray(o.fogColor)),void 0!==o.fogStart&&null!==o.fogStart&&(e.fogStart=o.fogStart),void 0!==o.fogEnd&&null!==o.fogEnd&&(e.fogEnd=o.fogEnd),void 0!==o.fogDensity&&null!==o.fogDensity&&(e.fogDensity=o.fogDensity),n+="\tFog mode for scene:  ",e.fogMode){case 0:n+="none\n";break;case 1:n+="exp\n";break;case 2:n+="exp2\n";break;case 3:n+="linear\n"}if(o.physicsEnabled){let t;"cannon"===o.physicsEngine||o.physicsEngine===Yh.name?t=new Yh(void 0,void 0,iu.LoaderInjectedPhysicsEngine):"oimo"===o.physicsEngine||o.physicsEngine===Xh.name?t=new Xh(void 0,iu.LoaderInjectedPhysicsEngine):"ammo"!==o.physicsEngine&&o.physicsEngine!==qh.v.name||(t=new qh.v(void 0,iu.LoaderInjectedPhysicsEngine,void 0)),n="\tPhysics engine "+(o.physicsEngine?o.physicsEngine:"oimo")+" enabled\n";const i=o.gravity?s.Pq.FromArray(o.gravity):o.physicsGravity?s.Pq.FromArray(o.physicsGravity):null;e.enablePhysics(i,t)}return void 0!==o.metadata&&null!==o.metadata&&(e.metadata=o.metadata),void 0!==o.collisionsEnabled&&null!==o.collisionsEnabled&&(e.collisionsEnabled=o.collisionsEnabled),!!du(e,t,i,r,!0)&&(o.autoAnimate&&e.beginAnimation(e,o.autoAnimateFrom,o.autoAnimateTo,o.autoAnimateLoop,o.autoAnimateSpeed||1),void 0!==o.activeCameraID&&null!==o.activeCameraID&&e.setActiveCameraById(o.activeCameraID),!0)}catch(e){const t=lu("importScene",o?o.producer:"Unknown")+n;if(!r)throw f.V.Log(t),e;r(t,e)}finally{null!==n&&ol.cn.loggingLevel!==ol.cn.NO_LOGGING&&f.V.Log(lu("importScene",o?o.producer:"Unknown")+(ol.cn.loggingLevel!==ol.cn.MINIMAL_LOGGING?n:""))}return!1},loadAssetContainer:(e,t,i,r)=>du(e,t,i,r)});var pu=i(90777),fu=i(93220),mu=i(8846),_u=i(62841),gu=i(91724),vu=i(18394);class Su{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,ne.$.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||a.v9.White(),this.rightColor=e.rightColor||a.v9.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){const e=new Su;return y.r.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new Su({isEnabled:e.isEnabled,leftColor:a.v9.FromArray(e.leftColor),rightColor:a.v9.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}pe.p._FresnelParametersParser=Su.Parse;class xu{}xu.BindSceneUniformBuffer=qo._8,xu.PrepareDefinesForMergedUV=qo.YT,xu.BindTextureMatrix=qo.mA,xu.GetFogState=qo.qL,xu.PrepareDefinesForMisc=qo.fm,xu.PrepareDefinesForCamera=qo.Y7,xu.PrepareDefinesForFrameBoundValues=qo.OR,xu.PrepareDefinesForBones=qo.IC,xu.PrepareDefinesForMorphTargets=qo.Jz,xu.PrepareDefinesForBakedVertexAnimation=qo.wu,xu.PrepareDefinesForAttributes=qo.qB,xu.PrepareDefinesForMultiview=qo.VO,xu.PrepareDefinesForOIT=qo.Nc,xu.PrepareDefinesForPrePass=qo.N4,xu.PrepareDefinesForLight=qo.lo,xu.PrepareDefinesForLights=qo.az,xu.PrepareUniformsAndSamplersForLight=qo.GD,xu.PrepareUniformsAndSamplersList=qo.Bb,xu.HandleFallbacksForShadows=qo.c4,xu.PrepareAttributesForMorphTargetsInfluencers=qo.MF,xu.PrepareAttributesForMorphTargets=qo.IF,xu.PrepareAttributesForBakedVertexAnimation=qo.J2,xu.PrepareAttributesForBones=qo.ni,xu.PrepareAttributesForInstances=qo.ER,xu.PushAttributesForInstances=qo.te,xu.BindLightProperties=qo.L0,xu.BindLight=qo.Kd,xu.BindLights=qo.RL,xu.BindFogParameters=qo.Yy,xu.BindBonesParameters=qo.f$,xu.BindMorphTargetParameters=qo.nR,xu.BindLogDepth=qo.DL;var Tu=i(97310),Eu=i(88468);class Cu extends ir.B{constructor(e,t){super(e,t,"color",{attributes:["position"],uniforms:["world","viewProjection","color"]}),this.disableColorWrite=!0,this.forceDepthWrite=!0,this.setColor4("color",new a.ov(0,0,0,1))}}var bu=i(12851),Pu=i(17062);class yu extends Pu.d{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new a.v9(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsLightsDirty")],yu.prototype,"maxSimultaneousLights",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsLightsDirty")],yu.prototype,"disableLighting",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],yu.prototype,"environmentTexture",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],yu.prototype,"invertNormalMapX",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],yu.prototype,"invertNormalMapY",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],yu.prototype,"normalTexture",void 0),(0,ue.Cg)([(0,de.jT)("emissive"),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],yu.prototype,"emissiveColor",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],yu.prototype,"emissiveTexture",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],yu.prototype,"occlusionStrength",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],yu.prototype,"occlusionTexture",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],yu.prototype,"alphaCutOff",void 0),(0,ue.Cg)([(0,de.lK)()],yu.prototype,"doubleSided",null),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty",null)],yu.prototype,"lightmapTexture",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],yu.prototype,"useLightmapAsShadowmap",void 0);var Au=i(51242),Ru=i(3468);class Iu extends yu{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=pe.p.Clone((()=>new Iu(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=pe.p.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=pe.p.Parse((()=>new Iu(e.name,t)),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}(0,ue.Cg)([(0,de.jT)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Iu.prototype,"baseColor",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Iu.prototype,"baseTexture",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],Iu.prototype,"metallic",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],Iu.prototype,"roughness",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],Iu.prototype,"metallicRoughnessTexture",void 0),(0,o.Y5)("BABYLON.PBRMetallicRoughnessMaterial",Iu);class Mu extends yu{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=pe.p.Clone((()=>new Mu(e,this.getScene())),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=pe.p.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=pe.p.Parse((()=>new Mu(e.name,t)),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}(0,ue.Cg)([(0,de.jT)("diffuse"),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Mu.prototype,"diffuseColor",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Mu.prototype,"diffuseTexture",void 0),(0,ue.Cg)([(0,de.jT)("specular"),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],Mu.prototype,"specularColor",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_microSurface")],Mu.prototype,"glossiness",void 0),(0,ue.Cg)([(0,de.uM)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],Mu.prototype,"specularGlossinessTexture",void 0),(0,o.Y5)("BABYLON.PBRSpecularGlossinessMaterial",Mu);var Ou,Nu=i(81791),Du=i(76669),Fu=i(46602),Lu=i(21800),wu=i(78979),Bu=i(85773);!function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(Ou||(Ou={}));class Vu extends Vo.t{constructor(e,t,i=null){if(super(t),e)if(this._textureMatrix=s.uq.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const e=this.getScene();e&&e.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;t=e._features.support3DTextures?e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=i=>{if("string"!=typeof i)return;let r,n=null,s=null;const a=i.split("\n");let o=0,l=0,c=0,h=0,u=0;for(let e=0;e<a.length;e++){if(r=a[e],!Vu._NoneEmptyLineRegex.test(r))continue;if(0===r.indexOf("#"))continue;const t=r.split(" ");if(0!==o){if(0!=o){const e=Math.max(parseInt(t[0]),0),i=Math.max(parseInt(t[1]),0),r=Math.max(parseInt(t[2]),0);u=Math.max(e,u),u=Math.max(i,u),u=Math.max(r,u);const n=4*(l+h*o+c*o*o);s&&(s[n+0]=e,s[n+1]=i,s[n+2]=r),c++,c%o==0&&(h++,c=0,h%o==0&&(l++,h=0))}}else o=t.length,n=new Uint8Array(o*o*o*4),s=new Float32Array(o*o*o*4)}if(s&&n)for(let e=0;e<s.length;e++)if(e>0&&(e+1)%4==0)n[e]=255;else{const t=s[e];n[e]=t/u*255}t.is3D?(t.updateSize(o,o,o),e.updateRawTexture3D(t,n,5,!1)):(t.updateSize(o*o,o),e.updateRawTexture(t,n,5,!1)),t.isReady=!0,this._triggerOnLoad()},r=this.getScene();return r?r._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const e=new Vu(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new Vu(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}Vu._NoneEmptyLineRegex=/\S+/,(0,o.Y5)("BABYLON.ColorGradingTexture",Vu);var ku=i(76531),Gu=i(42712);class Uu extends Vo.t{constructor(e,t,i,r=!1,n=!0,s=null,a=null,o=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=_e.g.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=o,this._noMipmap=r,this.gammaSpace=n,this._onLoad=s,this._onError=a,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?s&&(this._texture.isReady?re.S0.SetImmediate((()=>s())):this._texture.onLoadedObservable.add(s)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage((()=>this._loadTexture()),this._onError)}_loadImage(e,t){const i=this.getScene();if(!i)return;const r=i.getEngine().createRawCubeTexture(null,this._size,4,i.getEngine().getCaps().textureFloat?1:7,!this._noMipmap,!1,3);r.generateMipMaps=!this._noMipmap,i.addPendingData(r),r.url=this.url,r.isReady=!1,i.getEngine()._internalTexturesCache.push(r),this._texture=r,(0,Gu.W$)(this.url,(t=>{let i;this._width=t.width,this._height=t.height,(0,Ut.Nf)()?(i=document.createElement("canvas"),i.width=this._width,i.height=this._height):i=new OffscreenCanvas(this._width,this._height);const r=i.getContext("2d");r.drawImage(t,0,0);const n=r.getImageData(0,0,t.width,t.height);this._buffer=n.data.buffer,i.remove&&i.remove(),e()}),((e,n)=>{i.removePendingData(r),t&&t(`${this.getClassName()} could not be loaded`,n)}),i?i.offlineProvider:null)}_loadTexture(){const e=this.getScene();if(!e)return;const t=(()=>{const e=this._getFloat32ArrayFromArrayBuffer(this._buffer),t=ku.D.ConvertPanoramaToCubemap(e,this._width,this._height,this._size,this._supersample),i=[];for(let e=0;e<6;e++){const r=t[Uu._FacesMapping[e]];i.push(r)}return i})(),i=this._texture;e.getEngine().updateRawCubeTexture(i,t,i.format,i.type,i.invertY),i.isReady=!0,e.removePendingData(i),i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),this._onLoad&&this._onLoad()}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(3*e.byteLength/4);let r=0;for(let n=0;n<e.byteLength;n++)(n+1)%4!=0&&(i[r++]=t.getUint8(n)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new Uu(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}Uu._FacesMapping=["right","left","up","down","front","back"];var zu=i(11352);class Wu extends Vo.t{constructor(e,t,i){if(super(i.scene||i.engine),this.onLoadObservable=new n.cP,t&&(i.engine||i.scene)){if(i={...Wu._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=s.uq.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._isVideo){const e=this._engine,i=e?.createExternalTexture;i&&(this._externalTexture=i.call(e,t))}this.anisotropicFilteringLevel=1,this._createInternalTexture()}}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(null==this._texture||null==t)return;const i=this.isReady();if(this._isVideo){const i=this.element;if(i.readyState<i.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:i,null===e||e)}else{const i=this.element;t.updateDynamicTexture(this._texture,i,null===e||e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}Wu._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};var Hu=i(99229),Yu=i(76075),Xu=i(41391),qu=i(10218),$u=i(90097),ju=i(44104),Ku=i(82730),Zu=i(86025),Qu=i(33248),Ju=i(42707),ed=i(28522);class td extends Si.${get isSupported(){return this._engine?.getCaps().drawBuffersExtension??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,n,s){const a=!(!n||!n.generateMipMaps)&&n.generateMipMaps,o=!(!n||!n.generateDepthTexture)&&n.generateDepthTexture,l=n&&n.depthTextureFormat?n.depthTextureFormat:15,c=!n||void 0===n.doNotChangeAspectRatio||n.doNotChangeAspectRatio,h=!(!n||!n.drawOnlyOnFirstAttachmentByDefault)&&n.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,r,a,c,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();this._textureNames=s;const u=[],d=[],p=[],f=[],m=[],_=[],g=[],v=[];this._initTypes(i,u,d,p,f,m,_,g,v,n);const S=!n||void 0===n.generateDepthBuffer||n.generateDepthBuffer,x=!(!n||void 0===n.generateStencilBuffer)&&n.generateStencilBuffer,T=n&&n.samples?n.samples:1;this._multiRenderTargetOptions={samplingModes:d,generateMipMaps:a,generateDepthBuffer:S,generateStencilBuffer:x,generateDepthTexture:o,depthTextureFormat:l,types:u,textureCount:i,useSRGBBuffers:p,samples:T,formats:f,targetTypes:m,faceIndex:_,layerIndex:g,layerCounts:v,labels:s,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=h,i>0&&(this._createInternalTextures(),this._createTextures(s))}_initTypes(e,t,i,r,n,s,a,o,l,c){for(let h=0;h<e;h++)c&&c.types&&void 0!==c.types[h]?t.push(c.types[h]):t.push(c&&c.defaultType?c.defaultType:0),c&&c.samplingModes&&void 0!==c.samplingModes[h]?i.push(c.samplingModes[h]):i.push(_e.g.BILINEAR_SAMPLINGMODE),c&&c.useSRGBBuffers&&void 0!==c.useSRGBBuffers[h]?r.push(c.useSRGBBuffers[h]):r.push(!1),c&&c.formats&&void 0!==c.formats[h]?n.push(c.formats[h]):n.push(5),c&&c.targetTypes&&void 0!==c.targetTypes[h]?s.push(c.targetTypes[h]):s.push(3553),c&&c.faceIndex&&void 0!==c.faceIndex[h]?a.push(c.faceIndex[h]):a.push(0),c&&c.layerIndex&&void 0!==c.layerIndex[h]?o.push(c.layerIndex[h]):o.push(0),c&&c.layerCounts&&void 0!==c.layerCounts[h]?l.push(c.layerCounts[h]):l.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let r=0;r<i.length;r++){const n=i[r];if(!n)continue;const s=e[n.uniqueId];void 0!==s?t[r]=s:e[n.uniqueId]=r}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;const r=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));const n=this._renderTarget.textures;for(let e=0;e<n.length;e++){const t=this._textures[e];void 0!==r[e]&&this._renderTarget.setTexture(n[r[e]],e),t._texture=n[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer)}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const r=new _e.g(null,this.getScene());e?.[i]&&(r.name=e[i]),r._texture=t[i],r._texture&&(r._noMipmap=!r._texture.useMipMaps,r._useSRGBBuffer=r._texture._useSRGBBuffer),this._textures.push(r)}}setInternalTexture(e,t,i=!0){if(this.renderTarget&&(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new _e.g(null,this.getScene()),this.textures[t].name=this._textureNames?.[t]??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[t])){let i=0;i=e.is2DArray?35866:e.isCube?34067:e.is3D?32879:3553,this._multiRenderTargetOptions.targetTypes[t]=i}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const r=[],n=[],s=[],a=[],o=[],l=[],c=[],h=[];this._textureNames=i,this._initTypes(e,r,n,s,a,o,l,c,h,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=n,this._multiRenderTargetOptions.useSRGBBuffers=s,this._multiRenderTargetOptions.formats=a,this._multiRenderTargetOptions.targetTypes=o,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=c,this._multiRenderTargetOptions.layerCounts=h,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){const e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null}}}class id{constructor(e,t,i){this.id=e,this.scale=t,this.offset=i}}class rd{constructor(e,t,i,r){return this.name=e,this.meshes=t,this.scene=r,this.options=i,this.options.map=this.options.map??["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=this.options.uvsIn??Ue.R.UVKind,this.options.uvsOut=this.options.uvsOut??Ue.R.UVKind,this.options.layout=this.options.layout??rd.LAYOUT_STRIP,this.options.layout===rd.LAYOUT_COLNUM&&(this.options.colnum=this.options.colnum??8),this.options.updateInputMeshes=this.options.updateInputMeshes??!0,this.options.disposeSources=this.options.disposeSources??!0,this._expecting=0,this.options.fillBlanks=this.options.fillBlanks??!0,!0===this.options.fillBlanks&&(this.options.customFillColor=this.options.customFillColor??"black"),this.options.frameSize=this.options.frameSize??256,this.options.paddingRatio=this.options.paddingRatio??.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=this.options.paddingMode??rd.SUBUV_WRAP,this.options.paddingMode===rd.SUBUV_COLOR&&(this.options.paddingColor=this.options.paddingColor??new a.ov(0,0,0,1)),this.sets={},this.frames=[],this}_createFrames(e){const t=this._calculateSize(),i=new s.I9(1,1).divide(t);let r=0;const n=this._expecting,o=this.meshes.length,l=Object.keys(this.sets);for(let e=0;e<l.length;e++){const i=l[e],r=new Ni.R(this.name+".TexturePack."+i+"Set",{width:t.x,height:t.y},this.scene,!0,_e.g.TRILINEAR_SAMPLINGMODE,5),n=r.getContext();n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,t.x,t.y),r.update(!1),this.sets[i]=r}const c=this.options.frameSize||256,h=this._paddingValue,u=c+2*h,d=()=>{this._calculateMeshUVFrames(c,h,t,i,this.options.updateInputMeshes||!1)};for(let i=0;i<o;i++){const s=this.meshes[i].material;for(let o=0;o<l.length;o++){const p=new Ni.R("temp",u,this.scene,!0),f=p.getContext(),m=this._getFrameOffset(i),_=()=>{r++,p.update(!1);const i=f.getImageData(0,0,u,u),s=this.sets[g];if(s.getContext().putImageData(i,t.x*m.x,t.y*m.y),p.dispose(),s.update(!1),r==n)return d(),void e()},g=l[o]||"_blank";if(s&&null!==s[g]){const e=s[g],t=new Image;e instanceof Ni.R?t.src=e.getContext().canvas.toDataURL("image/png"):t.src=e.url,re.S0.SetCorsBehavior(t.src,t),t.onload=()=>{f.fillStyle="rgba(0,0,0,0)",f.fillRect(0,0,u,u),p.update(!1),f.setTransform(1,0,0,-1,0,0);const e=[0,0,1,0,1,1,0,1,-1,1,-1,0,-2,0,-1,1,-1];switch(this.options.paddingMode){case 0:for(let i=0;i<9;i++)f.drawImage(t,0,0,t.width,t.height,h+c*e[i],h+c*e[i+1]-u,c,c);break;case 1:for(let i=0;i<h;i++)f.drawImage(t,0,0,t.width,t.height,i+c*e[0],h-u,c,c),f.drawImage(t,0,0,t.width,t.height,2*h-i,h-u,c,c),f.drawImage(t,0,0,t.width,t.height,h,i-u,c,c),f.drawImage(t,0,0,t.width,t.height,h,2*h-i-u,c,c);f.drawImage(t,0,0,t.width,t.height,h+c*e[0],h+c*e[1]-u,c,c);break;case 2:f.fillStyle=(this.options.paddingColor||a.v9.Black()).toHexString(),f.fillRect(0,0,u,-u),f.clearRect(h,h,c,c),f.drawImage(t,0,0,t.width,t.height,h+c*e[0],h+c*e[1]-u,c,c)}f.setTransform(1,0,0,1,0,0),_()}}else f.fillStyle="rgba(0,0,0,0)",this.options.fillBlanks&&(f.fillStyle=this.options.customFillColor),f.fillRect(0,0,u,u),_()}}}_calculateSize(){const e=this.meshes.length||0,t=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new s.I9(t*e+2*i*e,t+2*i);case 1:{const r=Math.max(2,Math.ceil(Math.sqrt(e))),n=t*r+2*i*r;return new s.I9(n,n)}case 2:{const r=this.options.colnum||1,n=Math.max(1,Math.ceil(e/r));return new s.I9(t*r+2*i*r,t*n+2*i*n)}}return s.I9.Zero()}_calculateMeshUVFrames(e,t,i,r,n){const a=this.meshes.length;for(let o=0;o<a;o++){const a=this.meshes[o],l=new s.I9(e/i.x,e/i.y),c=r.clone().scale(t),h=this._getFrameOffset(o).add(c),u=new id(o,l,h);this.frames.push(u),n&&(this._updateMeshUV(a,o),this._updateTextureReferences(a))}}_getFrameOffset(e){const t=this.meshes.length;let i,r,n;switch(this.options.layout){case 0:return i=1/t,new s.I9(e*i,0);case 1:{const a=Math.max(2,Math.ceil(Math.sqrt(t)));return r=Math.floor(e/a),n=e-r*a,i=1/a,new s.I9(n*i,r*i)}case 2:{const a=this.options.colnum||1,o=Math.max(1,Math.ceil(t/a));return n=Math.floor(e/o),r=e-n*o,i=new s.I9(1/a,1/o),new s.I9(n*i.x,r*i.y)}}return s.I9.Zero()}_updateMeshUV(e,t){const i=this.frames[t],r=e.getVerticesData(this.options.uvsIn||Ue.R.UVKind),n=[];let s=0;r.length&&(s=r.length||0);for(let e=0;e<s;e+=2)n.push(r[e]*i.scale.x+i.offset.x,r[e+1]*i.scale.y+i.offset.y);e.setVerticesData(this.options.uvsOut||Ue.R.UVKind,n)}_updateTextureReferences(e,t=!1){const i=e.material,r=Object.keys(this.sets),n=e=>{e.dispose&&e.dispose()};for(let e=0;e<r.length;e++){const s=r[e];if(t)null!==i[s]&&n(i[s]),i[s]=this.sets[s];else{if(!i)return;null!==i[s]&&(n(i[s]),i[s]=this.sets[s])}}}setMeshToFrame(e,t,i=!1){this._updateMeshUV(e,t),i&&this._updateTextureReferences(e,!0)}processAsync(){return new Promise(((e,t)=>{try{if(0===this.meshes.length)return void e();let t=0;const i=i=>{if(t++,this.options.map){for(let e=0;e<this.options.map.length;e++)null!==i[this.options.map[e]]&&(this.sets[this.options.map[e]]||(this.sets[this.options.map[e]]=!0),this._expecting++);t===this.meshes.length&&this._createFrames(e)}};for(let r=0;r<this.meshes.length;r++){const n=this.meshes[r],s=n.material;if(s)s.forceCompilationAsync(n).then((()=>{i(s)}));else if(t++,t===this.meshes.length)return this._createFrames(e)}}catch(e){return t(e)}}))}dispose(){const e=Object.keys(this.sets);for(let t=0;t<e.length;t++){const i=e[t];this.sets[i].dispose()}}download(e="png",t=1){setTimeout((()=>{const i={name:this.name,sets:{},options:{},frames:[]},r=Object.keys(this.sets),n=Object.keys(this.options);try{for(let n=0;n<r.length;n++){const s=r[n],a=this.sets[s];i.sets[s]=a.getContext().canvas.toDataURL("image/"+e,t)}for(let e=0;e<n.length;e++){const t=n[e];i.options[t]=this.options[t]}for(let e=0;e<this.frames.length;e++){const t=this.frames[e];i.frames.push(t.scale.x,t.scale.y,t.offset.x,t.offset.y)}}catch(e){return void f.V.Warn("Unable to download: "+e)}const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i,null,4)),a=document.createElement("a");a.setAttribute("href",s),a.setAttribute("download",this.name+"_texurePackage.json"),document.body.appendChild(a),a.click(),a.remove()}),0)}updateFromJSON(e){try{const t=JSON.parse(e);this.name=t.name;const i=Object.keys(t.options);for(let e=0;e<i.length;e++)this.options[i[e]]=t.options[i[e]];for(let e=0;e<t.frames.length;e+=4){const i=new id(e/4,new s.I9(t.frames[e],t.frames[e+1]),new s.I9(t.frames[e+2],t.frames[e+3]));this.frames.push(i)}const r=Object.keys(t.sets);for(let e=0;e<r.length;e++){const i=new _e.g(t.sets[r[e]],this.scene,!1,!1);this.sets[r[e]]=i}}catch(e){f.V.Warn("Unable to update from JSON: "+e)}}}rd.LAYOUT_STRIP=0,rd.LAYOUT_POWER2=1,rd.LAYOUT_COLNUM=2,rd.SUBUV_WRAP=0,rd.SUBUV_EXTEND=1,rd.SUBUV_COLOR=2;class nd extends tc{constructor(e,t,i,r,n,s,a){super(e,i,null,r,n,s),this._animate=!0,this._time=0,this._texturePath=t,!n||n instanceof _e.g||(a=!!n.skipJson),a?this.setFragment(this._texturePath):this._loadJson(t),this.refreshRate=1}_loadJson(e){const t=()=>{try{this.setFragment(this._texturePath)}catch(e){f.V.Log("No json or ShaderStore or DOM element found for CustomProceduralTexture")}},i=e+"/config.json",r=new aa.u;r.open("GET",i),r.addEventListener("load",(()=>{if(200===r.status||r.responseText&&r.responseText.length>0)try{this._config=JSON.parse(r.response),this.updateShaderUniforms(),this.updateTextures(),this.setFragment(this._texturePath+"/custom"),this._animate=this._config.animate,this.refreshRate=this._config.refreshrate}catch(e){t()}else t()}),!1),r.addEventListener("error",(()=>{t()}),!1);try{r.send()}catch(e){f.V.Error("CustomProceduralTexture: Error on XHR send request.")}}isReady(){if(!super.isReady())return!1;for(const e in this._textures)if(!this._textures[e].isReady())return!1;return!0}render(e){const t=this.getScene();this._animate&&t&&(this._time+=.03*t.getAnimationRatio(),this.updateShaderUniforms()),super.render(e)}updateTextures(){for(let e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new _e.g(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))}updateShaderUniforms(){if(this._config)for(let e=0;e<this._config.uniforms.length;e++){const t=this._config.uniforms[e];switch(t.type){case"float":this.setFloat(t.name,t.value);break;case"color3":this.setColor3(t.name,new a.v9(t.r,t.g,t.b));break;case"color4":this.setColor4(t.name,new a.ov(t.r,t.g,t.b,t.a));break;case"vector2":this.setVector2(t.name,new s.I9(t.x,t.y));break;case"vector3":this.setVector3(t.name,new s.Pq(t.x,t.y,t.z))}}this.setFloat("time",this._time)}get animate(){return this._animate}set animate(e){this._animate=e}}ri.l.ShadersStore.noisePixelShader="uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)\n{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}\nfloat interpolationNoise(vec2 p)\n{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); \nreturn ym;}\nfloat perlinNoise2D(float x,float y)\n{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)\n{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}\nreturn sum;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}\n";class sd extends tc{constructor(e,t=256,i=P.q.LastCreatedScene,r,n){super(e,t,"noise",i,r,n),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(0|this.octaves)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={customType:"BABYLON.NoiseProceduralTexture"};return e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new sd(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){const i=new sd(e.name,e.size,t,void 0,e.generateMipMaps);return i.brightness=e.brightness,i.octaves=e.octaves,i.persistence=e.persistence,i.animationSpeedFactor=e.animationSpeedFactor,i.time=e.time??0,i}}(0,o.Y5)("BABYLON.NoiseProceduralTexture",sd);var ad=i(43250),od=i(41930);class ld extends _e.g{get width(){return this._texture?this._texture.width:0}get height(){return this._texture?this._texture.height:0}get depth(){return this._texture?this._texture.depth:0}constructor(e,t,i,r,n,s,a=!0,o=!1,l=_e.g.TRILINEAR_SAMPLINGMODE,c=0,h){super(null,s,!a,o),this.format=n,this._texture=s.getEngine().createRawTexture3D(e,t,i,r,n,a,o,l,null,c,h),this.is3D=!0}update(e){this._texture&&this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}}class cd extends Si.${constructor(e,t,i,r){super(e,t,i,r,!0),this.refractionPlane=new et.Z(0,1,0,1),this.depth=2,this.onBeforeRenderObservable.add((()=>{this.getScene().clipPlane=this.refractionPlane})),this.onAfterRenderObservable.add((()=>{this.getScene().clipPlane=null}))}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new cd(this.name,t.width,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.refractionPlane=this.refractionPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i.depth=this.depth,i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.refractionPlane.asArray(),e.depth=this.depth,e}}var hd=i(67065),ud=i(64468);class dd extends ud.D{get renderTarget(){return this._renderTarget}constructor(e,t,i){super(null),this._renderTarget=null,this._engine=e,this._renderTargetOptions=i,this.resize(t)}resize(e){this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,this._size=e,this._engine&&(this._renderTarget=this._engine.createRenderTargetTexture(this._size,this._renderTargetOptions)),this._texture=this.renderTarget.texture}getInternalTexture(){return this._texture}getClassName(){return"ThinRenderTargetTexture"}dispose(e=!1){this._renderTarget?.dispose(!0),this._renderTarget=null,e||super.dispose()}}var pd,fd=i(68744),md=i(37177),_d=i(53328),gd=i(12409),vd=i(76175),Sd=i(43644),xd=i(37110);!function(e){e[e.Uniform=0]="Uniform",e[e.Attribute=1]="Attribute",e[e.Varying=2]="Varying",e[e.Undefined=3]="Undefined"}(pd||(pd={}));class Td extends Pl{constructor(e,t,i,r,n){super(e,t,i),this._blockType=r,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Td&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class Ed extends Ml{constructor(e){super(e,xl.Vertex),this._isUnique=!0,this.registerInput("splatPosition",Sl.Vector3,!1,xl.Vertex),this.registerInput("splatScale",Sl.Vector2,!0,xl.Vertex),this.registerInput("world",Sl.Matrix,!1,xl.Vertex),this.registerInput("view",Sl.Matrix,!1,xl.Vertex),this.registerInput("projection",Sl.Matrix,!1,xl.Vertex),this.registerOutput("splatVertex",Sl.Vector4,xl.Vertex)}getClassName(){return"GaussianSplattingBlock"}get splatPosition(){return this._inputs[0]}get splatScale(){return this._inputs[1]}get world(){return this._inputs[2]}get view(){return this._inputs[3]}get projection(){return this._inputs[4]}get splatVertex(){return this._outputs[0]}initialize(e){e._excludeVariableName("focal"),e._excludeVariableName("invViewport")}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Fragment)return;const t=`//${this.name}`;e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitUniformFromString("focal",Sl.Vector2),e._emitUniformFromString("invViewport",Sl.Vector2),e.attributes.push(rr.R.PositionKind),e.sharedData.nodeMaterial.backFaceCulling=!1;const i=this.splatPosition,r=this.splatScale,n=this.world,s=this.view,a=this.projection,o=this.splatVertex;let l=`vec2${e.fSuffix}(1.,1.)`;r.isConnected&&(l=r.associatedVariableName);let c="position",h="";return 1===e.shaderLanguage&&(c="input.position",h=", uniforms.focal, uniforms.invViewport"),e.compilationString+=`${e._declareOutput(o)} = gaussianSplatting(${c}, ${i.associatedVariableName}, ${l}, covA, covB, ${n.associatedVariableName}, ${s.associatedVariableName}, ${a.associatedVariableName}${h});\n`,this}}(0,o.Y5)("BABYLON.GaussianSplattingBlock",Ed);class Cd extends Ml{constructor(e){super(e,xl.Fragment),this._isUnique=!1,this.registerInput("splatColor",Sl.Color4,!1,xl.Fragment),this.registerOutput("rgba",Sl.Color4,xl.Fragment)}getClassName(){return"GaussianBlock"}get splatColor(){return this._inputs[0]}get rgba(){return this._outputs[0]}initialize(e){e._excludeVariableName("vPosition")}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Vertex)return;const t=`//${this.name}`;e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e._emitFunctionFromInclude("logDepthDeclaration",t),e._emitFunctionFromInclude("fogFragmentDeclaration",t),e._emitFunctionFromInclude("gaussianSplattingFragmentDeclaration",t),e._emitVaryingFromString("vPosition",Sl.Vector2);const i=this.splatColor,r=this._outputs[0];return 1===e.shaderLanguage?e.compilationString+=`${e._declareOutput(r)} = gaussianColor(${i.associatedVariableName}, input.vPosition);\n`:e.compilationString+=`${e._declareOutput(r)} = gaussianColor(${i.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.GaussianBlock",Cd);var bd=i(92243);class Pd extends Ml{constructor(e){super(e,xl.Vertex),this._isUnique=!0,this.registerInput("splatIndex",Sl.Float,!1,xl.Vertex),this.registerOutput("splatPosition",Sl.Vector3,xl.Vertex),this.registerOutput("splatColor",Sl.Color4,xl.Vertex)}getClassName(){return"SplatReaderBlock"}get splatIndex(){return this._inputs[0]}get splatPosition(){return this._outputs[0]}get splatColor(){return this._outputs[1]}initialize(e){e._excludeVariableName("covA"),e._excludeVariableName("covB"),e._excludeVariableName("vPosition"),e._excludeVariableName("covariancesATexture"),e._excludeVariableName("covariancesBTexture"),e._excludeVariableName("centersTexture"),e._excludeVariableName("colorsTexture"),e._excludeVariableName("dataTextureSize")}bind(e,t,i){if(!i)return;const r=i.getScene();bd.b.BindEffect(i,e,r)}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Fragment)return;e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emit2DSampler("covariancesATexture"),e._emit2DSampler("covariancesBTexture"),e._emit2DSampler("centersTexture"),e._emit2DSampler("colorsTexture"),e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitVaryingFromString("vPosition",Sl.Vector2),e._emitUniformFromString("dataTextureSize",Sl.Vector2);const i=this.splatIndex,r=this.splatPosition,n=this.splatColor,s=e._getFreeVariableName("splat");return 1===e.shaderLanguage?(e.compilationString+=`var ${s}: Splat = readSplat(${i.associatedVariableName}, uniforms.dataTextureSize);\n`,e.compilationString+="var covA: vec3f = splat.covA.xyz; var covB: vec3f = vec3f(splat.covA.w, splat.covB.xy);\n",e.compilationString+="vertexOutputs.vPosition = input.position;\n"):(e.compilationString+=`Splat ${s} = readSplat(${i.associatedVariableName});\n`,e.compilationString+="vec3 covA = splat.covA.xyz; vec3 covB = vec3(splat.covA.w, splat.covB.xy);\n",e.compilationString+="vPosition = position;\n"),e.compilationString+=`${e._declareOutput(r)} = ${s}.center.xyz;\n`,e.compilationString+=`${e._declareOutput(n)} = ${s}.color;\n`,this}}function yd(e){e.clear(),e.editorData=null;const t=new Bl("SplatIndex");t.setAsAttribute("splatIndex");const i=new Pd("SplatReader");t.connectTo(i);const r=new Ed("GaussianSplatting");i.connectTo(r);const n=new Bl("World");n.setAsSystemValue(Al.World);const s=new Ol("WorldPos");i.connectTo(s),n.connectTo(s),s.connectTo(r,{output:"xyz",input:"splatPosition"});const a=new Bl("view");a.setAsSystemValue(Al.View);const o=new Bl("Projection");o.setAsSystemValue(Al.Projection),n.connectTo(r,{input:"world"}),a.connectTo(r,{input:"view"}),o.connectTo(r,{input:"projection"});const l=new Cd("Gaussian");i.connectTo(l,{input:"splatColor",output:"splatColor"});const c=new Dl("FragmentOutput");l.connectTo(c);const h=new Nl("VertexOutput");r.connectTo(h),e.addOutputNode(h),e.addOutputNode(c),e._mode=Xl.GaussianSplatting}(0,o.Y5)("BABYLON.SplatReaderBlock",Pd);class Ad extends Ml{constructor(e){super(e,xl.Vertex),this.registerInput("matricesIndices",Sl.Vector4),this.registerInput("matricesWeights",Sl.Vector4),this.registerInput("matricesIndicesExtra",Sl.Vector4,!0),this.registerInput("matricesWeightsExtra",Sl.Vector4,!0),this.registerInput("world",Sl.Matrix),this.registerOutput("output",Sl.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,97346)),Promise.resolve().then(i.bind(i,36674))]):await Promise.all([Promise.resolve().then(i.bind(i,50143)),Promise.resolve().then(i.bind(i,95581))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesIndices"===e.name&&t(e)));i||(i=new Bl("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesWeights"===e.name&&t(e)));i||(i=new Bl("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.World&&t(e)));i||(i=new Bl("world"),i.setAsSystemValue(Al.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){(0,qo.f$)(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&(0,qo.IC)(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const r=this._outputs[0],n=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\n",e.compilationString+=e._declareOutput(r)+` = ${n.associatedVariableName} * ${i};\n`,e.compilationString+="#else\n",e.compilationString+=e._declareOutput(r)+` = ${n.associatedVariableName};\n`,e.compilationString+="#endif\n",this}}(0,o.Y5)("BABYLON.BonesBlock",Ad);class Rd extends Ml{constructor(e){super(e,xl.Vertex),this.registerInput("world0",Sl.Vector4),this.registerInput("world1",Sl.Vector4),this.registerInput("world2",Sl.Vector4),this.registerInput("world3",Sl.Vector4),this.registerInput("world",Sl.Matrix,!0),this.registerOutput("output",Sl.Matrix),this.registerOutput("instanceID",Sl.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world0"===e.name&&t(e)));i||(i=new Bl("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world1"===e.name&&t(e)));i||(i=new Bl("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world2"===e.name&&t(e)));i||(i=new Bl("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world3"===e.name&&t(e)));i||(i=new Bl("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world"===e.name&&t(e)));i||(i=new Bl("world"),i.setAsSystemValue(Al.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,n){let s=!1;i.INSTANCES!==r&&(i.setValue("INSTANCES",r),s=!0),n&&i.THIN_INSTANCES!==!!n?.getRenderingMesh().hasThinInstances&&(i.setValue("THIN_INSTANCES",!!n?.getRenderingMesh().hasThinInstances),s=!0),s&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],r=this._outputs[1],n=this.world0,s=this.world1,a=this.world2,o=this.world3;let l="mat4",c="gl_InstanceID",h="float";return 1===e.shaderLanguage&&(l="mat4x4f",c="vertexInputs.instanceIndex",h="f32"),e.compilationString+="#ifdef INSTANCES\n",e.compilationString+=e._declareOutput(i)+` = ${l}(${n.associatedVariableName}, ${s.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName});\n`,e.compilationString+="#ifdef THIN_INSTANCES\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\n`,e.compilationString+="#endif\n",t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(r)+` = ${h}(${c});\n`:e.compilationString+=e._declareOutput(r)+" = 0.0;\n",e.compilationString+="#else\n",e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};\n`,e.compilationString+=e._declareOutput(r)+" = 0.0;\n",e.compilationString+="#endif\n",this}}(0,o.Y5)("BABYLON.InstancesBlock",Rd);class Id extends Ml{constructor(e){super(e,xl.Vertex),this.registerInput("position",Sl.Vector3),this.registerInput("normal",Sl.Vector3),this.registerInput("tangent",Sl.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(Sl.Color4|Sl.Vector4|Sl.Vector3),this.registerInput("uv",Sl.Vector2),this.registerOutput("positionOutput",Sl.Vector3),this.registerOutput("normalOutput",Sl.Vector3),this.registerOutput("tangentOutput",Sl.Vector4),this.registerOutput("uvOutput",Sl.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,56205)),Promise.resolve().then(i.bind(i,15909)),Promise.resolve().then(i.bind(i,95030)),Promise.resolve().then(i.bind(i,22400))]):await Promise.all([Promise.resolve().then(i.bind(i,58176)),Promise.resolve().then(i.bind(i,88822)),Promise.resolve().then(i.bind(i,41375)),Promise.resolve().then(i.bind(i,4835))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Bl("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Bl("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&t(e)));i||(i=new Bl("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Bl("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const t=e.morphTargetManager;t?.isUsingTextureForTargets&&(t.numMaxInfluencers||t.numInfluencers)!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&(0,qo.Jz)(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&((0,qo.nR)(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,r){const n=this.position,s=this.normal,a=this.tangent,o=this.uv,l=this.positionOutput,c=this.normalOutput,h=this.tangentOutput,u=this.uvOutput,d=e,p=r.NUM_MORPH_INFLUENCERS,f=i.morphTargetManager,m=f&&f.supportsNormals&&r.NORMAL,_=f&&f.supportsTangents&&r.TANGENT,g=f&&f.supportsUVs&&r.UV1;let v="";f?.isUsingTextureForTargets&&p>0&&(v+=`${d._declareLocalVar("vertexID",Sl.Float)};\n`),v+="#ifdef MORPHTARGETS\n";const S=1===d.shaderLanguage,x=S?"uniforms.":"";if(f?.isUsingTextureForTargets)v+=`for (${S?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {\n`,v+=`if (i >= ${x}morphTargetCount) { break; }\n`,v+=`vertexID = ${S?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${x}morphTargetTextureInfo.x;\n`,v+=`${l.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${n.associatedVariableName}) * ${x}morphTargetInfluences[i];\n`,v+="vertexID += 1.0;\n",m&&(v+="#ifdef MORPHTARGETS_NORMAL\n",v+=`${c.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${s.associatedVariableName}) * ${x}morphTargetInfluences[i];\n`,v+="vertexID += 1.0;\n",v+="#endif\n"),g&&(v+="#ifdef MORPHTARGETS_UV\n",v+=`${u.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${o.associatedVariableName}) * ${x}morphTargetInfluences[i];\n`,v+="vertexID += 1.0;\n",v+="#endif\n"),_&&(v+="#ifdef MORPHTARGETS_TANGENT\n",v+=`${h.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${a.associatedVariableName}.xyz) * ${x}morphTargetInfluences[i];\n`,a.type===Sl.Vector4?v+=`${h.associatedVariableName}.w = ${a.associatedVariableName}.w;\n`:v+=`${h.associatedVariableName}.w = 1.;\n`,v+="#endif\n"),v+="}\n";else for(let e=0;e<p;e++)v+=`${l.associatedVariableName} += (position${e} - ${n.associatedVariableName}) * ${x}morphTargetInfluences[${e}];\n`,m&&(v+="#ifdef MORPHTARGETS_NORMAL\n",v+=`${c.associatedVariableName} += (normal${e} - ${s.associatedVariableName}) * ${x}morphTargetInfluences[${e}];\n`,v+="#endif\n"),g&&(v+="#ifdef MORPHTARGETS_UV\n",v+=`${u.associatedVariableName}.xy += (uv_${e} - ${o.associatedVariableName}.xy) * ${x}morphTargetInfluences[${e}];\n`,v+="#endif\n"),_&&(v+="#ifdef MORPHTARGETS_TANGENT\n",v+=`${h.associatedVariableName}.xyz += (tangent${e} - ${a.associatedVariableName}.xyz) * ${x}morphTargetInfluences[${e}];\n`,a.type===Sl.Vector4?v+=`${h.associatedVariableName}.w = ${a.associatedVariableName}.w;\n`:v+=`${h.associatedVariableName}.w = 1.;\n`,v+="#endif\n");if(v+="#endif\n",d.compilationString=d.compilationString.replace(this._repeatableContentAnchor,v),p>0)for(let e=0;e<p;e++)d.attributes.push(Ue.R.PositionKind+e),m&&d.attributes.push(Ue.R.NormalKind+e),_&&d.attributes.push(Ue.R.TangentKind+e),g&&d.attributes.push(Ue.R.UVKind+"_"+e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,r=this.tangent,n=this.uv,s=this.positionOutput,a=this.normalOutput,o=this.tangentOutput,l=this.uvOutput,c=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",c),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",c,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(s)} = ${t.associatedVariableName};\n`,e.compilationString+="#ifdef NORMAL\n",e.compilationString+=`${e._declareOutput(a)} = ${i.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(a)} = vec3(0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef TANGENT\n",e.compilationString+=`${e._declareOutput(o)} = ${r.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(o)} = vec4(0., 0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef UV1\n",e.compilationString+=`${e._declareOutput(l)} = ${n.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(l)} = vec2(0., 0.);\n`,e.compilationString+="#endif\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}(0,o.Y5)("BABYLON.MorphTargetsBlock",Id);class Md extends Ml{constructor(e){super(e,xl.Vertex),this.registerInput("worldPosition",Sl.Vector4,!1,xl.Vertex),this.registerOutput("direction",Sl.Vector3),this.registerOutput("color",Sl.Color3),this.registerOutput("intensity",Sl.Float),this.registerOutput("shadowBias",Sl.Float),this.registerOutput("shadowNormalBias",Sl.Float),this.registerOutput("shadowDepthScale",Sl.Float),this.registerOutput("shadowDepthRange",Sl.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light;const n=t.getScene();if(!r&&n.lights.length&&(r=this.light=n.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);const s=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(s?e.setFloat3(this._lightShadowUniformName,s.bias,s.normalBias,s.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(s&&n.activeCamera){const t=r;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(n.activeCamera),t.getDepthMinZ(n.activeCamera)+t.getDepthMaxZ(n.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const r=this.light;i.setValue(this._lightTypeDefineName,!!(r&&r instanceof Nh.H),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,r=this.intensity,n=this.shadowBias,s=this.shadowNormalBias,a=this.shadowDepthScale,o=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");const l=1===e.shaderLanguage?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,Sl.Vector3),e._emitUniformFromString(this._lightColorUniformName,Sl.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\n`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${l}${this._lightDataUniformName});\n`,e.compilationString+="#else\n",e.compilationString+=e._declareOutput(t)+` = ${l}${this._lightDataUniformName};\n`,e.compilationString+="#endif\n",e.compilationString+=e._declareOutput(i)+` = ${l}${this._lightColorUniformName}.rgb;\n`,e.compilationString+=e._declareOutput(r)+` = ${l}${this._lightColorUniformName}.a;\n`,(n.hasEndpoints||s.hasEndpoints||a.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,Sl.Vector3),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${l}${this._lightShadowUniformName}.x;\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${l}${this._lightShadowUniformName}.y;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}${this._lightShadowUniformName}.z;\n`)),o.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,Sl.Vector2),e.compilationString+=e._declareOutput(o)+` = ${this._lightShadowUniformName};\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}(0,o.Y5)("BABYLON.LightInformationBlock",Md);var Od=i(97346),Nd=i(36674),Dd=i(50143),Fd=i(95581),Ld=i(56205),wd=i(15909),Bd=i(95030),Vd=i(22400),kd=i(58176),Gd=i(88822),Ud=i(41375),zd=i(4835);class Wd extends Ml{constructor(e){super(e,xl.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",Sl.AutoDetect),this.registerOutput("output",Sl.Color4),this.registerOutput("rgb",Sl.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Color4|Sl.Vector3|Sl.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,68458)),Promise.resolve().then(i.bind(i,93673)),Promise.resolve().then(i.bind(i,76224))]):await Promise.all([Promise.resolve().then(i.bind(i,60201)),Promise.resolve().then(i.bind(i,85204)),Promise.resolve().then(i.bind(i,94021))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const t=this.color,i=this._outputs[0],r=`//${this.name}`,n=1===e.shaderLanguage?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),t.connectedPoint?.isConnected&&(t.connectedPoint.type===Sl.Color4||t.connectedPoint.type===Sl.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};\n`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\n",this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${n}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);\n`),e.compilationString+="#else\n",e.compilationString+="#ifdef IMAGEPROCESSING\n",this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${n}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);\n`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+="#endif\n",this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}}(0,ue.Cg)([oa("Convert input to linear space",0,"ADVANCED")],Wd.prototype,"convertInputToLinearSpace",void 0),(0,o.Y5)("BABYLON.ImageProcessingBlock",Wd);class Hd extends Ml{constructor(e){super(e,xl.Fragment,!0),this.registerInput("normal",Sl.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(Sl.Color4|Sl.Vector4|Sl.Vector3),this.registerInput("tangent",Sl.Vector4,!1),this.registerInput("world",Sl.Matrix,!1),this.registerOutput("TBN",Sl.Object,xl.Fragment,new Td("TBN",this,1,Hd,"TBNBlock")),this.registerOutput("row0",Sl.Vector3,xl.Fragment),this.registerOutput("row1",Sl.Vector3,xl.Fragment),this.registerOutput("row2",Sl.Vector3,xl.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return xl.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.isSystemValue&&e.systemValue===Al.World&&t(e)));i||(i=new Bl("world"),i.setAsSystemValue(Al.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Bl("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&e.type===Sl.Vector4&&t(e)));i||(i=new Bl("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){const r=this.normal,n=this.tangent;let s=r.isConnected;r.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(r.connectInputBlock?.name)&&(s=!1);let a=n.isConnected;n.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(n.connectInputBlock?.name)&&(a=!1);const o=s&&a;i.setValue("TBNBLOCK",o,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,r=this.world,n=this.TBN,s=this.row0,a=this.row1,o=this.row2,l=1===e.shaderLanguage,c=l?"mat3x3f":"mat3",h=l?"f":"";return e.target===xl.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                ${e._declareLocalVar("tbnNormal",Sl.Vector3)} = normalize(${t.associatedVariableName}).xyz;\n                ${e._declareLocalVar("tbnTangent",Sl.Vector3)} = normalize(${i.associatedVariableName}.xyz);\n                ${e._declareLocalVar("tbnBitangent",Sl.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                ${l?"var":"mat3"} ${n.associatedVariableName} = ${c}(${r.associatedVariableName}[0].xyz, ${r.associatedVariableName}[1].xyz, ${r.associatedVariableName}[2].xyz) * ${c}(tbnTangent, tbnBitangent, tbnNormal);\n            `,s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = vec3${h}(${n.associatedVariableName}[0][0], ${n.associatedVariableName}[0][1], ${n.associatedVariableName}[0][2]);\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${h}(${n.associatedVariableName}[1[0], ${n.associatedVariableName}[1][1], ${n.associatedVariableName}[1][2]);\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${h}(${n.associatedVariableName}[2][0], ${n.associatedVariableName}[2][1], ${n.associatedVariableName}[2][2]);\n`),e.sharedData.blocksWithDefines.push(this)),this}}(0,o.Y5)("BABYLON.TBNBlock",Hd);class Yd extends Ml{constructor(e){super(e,xl.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",Sl.Vector4,!1),this.registerInput("worldNormal",Sl.Vector4,!1),this.registerInput("worldTangent",Sl.Vector4,!0),this.registerInput("uv",Sl.Vector2,!1),this.registerInput("normalMapColor",Sl.Color3,!1),this.registerInput("strength",Sl.Float,!1),this.registerInput("viewDirection",Sl.Vector3,!0),this.registerInput("parallaxScale",Sl.Float,!0),this.registerInput("parallaxHeight",Sl.Float,!0),this.registerInput("TBN",Sl.Object,!0,xl.VertexAndFragment,new Td("TBN",this,0,Hd,"TBNBlock")),this.registerInput("world",Sl.Matrix,!0),this.registerOutput("output",Sl.Vector4),this.registerOutput("uvOffset",Sl.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,41627)),Promise.resolve().then(i.bind(i,54013)),Promise.resolve().then(i.bind(i,44806))]):await Promise.all([Promise.resolve().then(i.bind(i,55574)),Promise.resolve().then(i.bind(i,37418)),Promise.resolve().then(i.bind(i,10305))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}prepareDefines(e,t,i){const r=this.normalMapColor.connectedPoint._ownerBlock.samplerName,n=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&r||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",n,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Bl("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const e=new Bl("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,r=this.worldPosition,n=this.worldNormal,s=this.worldTangent,a=1===e.shaderLanguage,o=a?"mat3x3f":"mat3",l=a?"f":"",c=a?"uniforms.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,Sl.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,Sl.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,Sl.Matrix);let h=null;this.normalMapColor.connectedPoint&&(h=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const u=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&h||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),d=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",p=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${this.strength.associatedVariableName}`;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const f={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"},m=this.TBN;m.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            ${a?"var":"mat3"} vTBN = ${m.associatedVariableName};\n            #endif\n            `:s.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",Sl.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,e.compilationString+=`${e._declareLocalVar("tbnTangent",Sl.Vector3)} = normalize(${s.associatedVariableName}.xyz);\n`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",Sl.Vector3)} = cross(tbnNormal, tbnTangent) * ${a?"uniforms.":""}${this._tangentCorrectionFactorName};\n`,e.compilationString+=`${a?"var":"mat3"} vTBN = ${o}(tbnTangent, tbnBitangent, tbnNormal);\n`);let _=[f,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}];a&&(_.push({search:/varying vTBN0: vec3f;/g,replace:""}),_.push({search:/varying vTBN1: vec3f;/g,replace:""}),_.push({search:/varying vTBN2: vec3f;/g,replace:""})),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:_});const g=a?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bump: texture_2d<f32>, bumpSampler: sampler)":"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)",v=a?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,S=a?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)",x=a?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g;e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:v,replace:g},{search:x,replace:S},{search:/texture.+?bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const T=u&&h?`${a?`textureSample(${h}, ${h+"Sampler"}`:`texture2D(${h}`}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName,E=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(E,Sl.Vector3)+` = vec3${l}(0.);\n`,_=[{search:new RegExp(`texture.+?bumpSampler${a?"Sampler,fragmentInputs.":","}vBumpUV\\)`,"g"),replace:`${T}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",Sl.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:new RegExp(`perturbNormal\\(TBN,texture.+?bumpSampler${a?"Sampler,fragmentInputs.":","}vBumpUV\\+uvOffset\\).xyz,${a?"uniforms.":""}vBumpInfos.y\\)`,"g"),replace:`perturbNormal(TBN, ${T}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a?u&&this.useParallaxOcclusion?`${h}, ${h+"Sampler"}`:"bump, bumpSampler":u&&this.useParallaxOcclusion?h:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${u?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vBumpInfos.y/g,replace:p},{search:/vBumpInfos.z/g,replace:d},{search:/normalW=/g,replace:E+" = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${o}(normalMatrix) * `+E},{search:/normalW/g,replace:n.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:u?this.viewDirection.associatedVariableName:`vec3${l}(0.)`},f],a?(_.push({search:/fragmentInputs.vBumpUV/g,replace:i.associatedVariableName}),_.push({search:/input.vPositionW/g,replace:r.associatedVariableName+".xyz"}),_.push({search:/uniforms.vTangentSpaceParams/g,replace:c+this._tangentSpaceParameterName}),_.push({search:/var TBN: mat3x3f=mat3x3<f32>\(input.vTBN0,input.vTBN1,input.vTBN2\);/g,replace:"var TBN = vTBN;"})):(_.push({search:/vBumpUV/g,replace:i.associatedVariableName}),_.push({search:/vPositionW/g,replace:r.associatedVariableName+".xyz"}),_.push({search:/vTangentSpaceParams/g,replace:c+this._tangentSpaceParameterName})),e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:_}),e.compilationString+=e._declareOutput(this.output)+` = vec4${l}(${E}, 0.);\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}(0,ue.Cg)([oa("Invert X axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Yd.prototype,"invertX",void 0),(0,ue.Cg)([oa("Invert Y axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Yd.prototype,"invertY",void 0),(0,ue.Cg)([oa("Use parallax occlusion",0,void 0,{embedded:!0,notifiers:{update:!1}})],Yd.prototype,"useParallaxOcclusion",void 0),(0,ue.Cg)([oa("Object Space Mode",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Yd.prototype,"useObjectSpaceNormalMap",void 0),(0,o.Y5)("BABYLON.PerturbNormalBlock",Yd);class Xd extends Ml{constructor(e){super(e,xl.Fragment,!0),this.registerInput("value",Sl.Float,!0),this.registerInput("cutoff",Sl.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }\n`,this}}(0,o.Y5)("BABYLON.DiscardBlock",Xd);class qd extends Ml{constructor(e){super(e,xl.Fragment),this.registerOutput("output",Sl.Float,xl.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",0===e.shaderLanguage?"gl_FrontFacing":"fragmentInputs.frontFacing")};\n`,this}}(0,o.Y5)("BABYLON.FrontFacingBlock",qd);class $d extends Ml{constructor(e){super(e,xl.Fragment),this.registerInput("input",Sl.AutoDetect,!1),this.registerOutput("dx",Sl.BasedOnInput),this.registerOutput("dy",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let r="dFdx",n="dFdy";return 1===e.shaderLanguage&&(r="dpdx",n="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});\n`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${n}(${this.input.associatedVariableName});\n`),this}}(0,o.Y5)("BABYLON.DerivativeBlock",$d);class jd extends Ml{constructor(e){super(e,xl.Fragment),this.registerOutput("xy",Sl.Vector2,xl.Fragment),this.registerOutput("xyz",Sl.Vector3,xl.Fragment),this.registerOutput("xyzw",Sl.Vector4,xl.Fragment),this.registerOutput("x",Sl.Float,xl.Fragment),this.registerOutput("y",Sl.Float,xl.Fragment),this.registerOutput("z",Sl.Float,xl.Fragment),this.registerOutput("w",Sl.Float,xl.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";const i=1===e.shaderLanguage?"fragmentInputs.position":"gl_FragCoord";for(const r of this._outputs)r.hasEndpoints&&(t+=`${e._declareOutput(r)} = ${i}.${r.name};\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}(0,o.Y5)("BABYLON.FragCoordBlock",jd);class Kd extends Ml{constructor(e){super(e,xl.Fragment),this.registerOutput("xy",Sl.Vector2,xl.Fragment),this.registerOutput("x",Sl.Float,xl.Fragment),this.registerOutput("y",Sl.Float,xl.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===xl.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,Sl.Vector2);const t=1===e.shaderLanguage?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}}(0,o.Y5)("BABYLON.ScreenSizeBlock",Kd);class Zd extends Ml{constructor(e){super(e,xl.Fragment),this.registerInput("vector",Sl.AutoDetect),this.registerInput("worldViewProjection",Sl.Matrix),this.registerOutput("output",Sl.Vector2),this.registerOutput("x",Sl.Float),this.registerOutput("y",Sl.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.WorldViewProjection&&t(e)));i||(i=new Bl("worldViewProjection"),i.setAsSystemValue(Al.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const r=i.associatedVariableName,n=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case Sl.Vector3:e.compilationString+=`${e._declareLocalVar(n,Sl.Vector4)} = ${r} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);\n`;break;case Sl.Vector4:e.compilationString+=`${e._declareLocalVar(n,Sl.Vector4)} = ${r} * ${t.associatedVariableName};\n`}return e.compilationString+=`${n} = vec4${e.fSuffix}(${n}.xy / ${n}.w, ${n}.zw);`,e.compilationString+=`${n} = vec4${e.fSuffix}(${n}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${n}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${n}.xy;\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${n}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${n}.y;\n`),this}}(0,o.Y5)("BABYLON.ScreenSpaceBlock",Zd);class Qd extends Ml{constructor(e){super(e,xl.Fragment),this.registerInput("input",Sl.Vector2),this.registerInput("strength",Sl.Float),this.registerInput("center",Sl.Vector2),this.registerInput("offset",Sl.Vector2),this.registerOutput("output",Sl.Vector2),this.registerOutput("x",Sl.Float),this.registerOutput("y",Sl.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new Bl("center");e.value=new s.I9(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new Bl("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new Bl("offset");e.value=new s.I9(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),n=e._getFreeVariableName("y"),s=e._getFreeVariableName("result");return e.compilationString+=`        \n            ${e._declareLocalVar(t,Sl.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            ${e._declareLocalVar(i,Sl.Float)} = ${this.strength.associatedVariableName} * length(${t});\n            ${e._declareLocalVar(r,Sl.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            ${e._declareLocalVar(n,Sl.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            ${e._declareLocalVar(s,Sl.Vector2)} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${n} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${s};\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${s}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${s}.y;\n`),this}}(0,o.Y5)("BABYLON.TwirlBlock",Qd);class Jd extends Ml{constructor(e){super(e,xl.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",Sl.Float),this.registerInput("worldPosition",Sl.Vector3),this.registerInput("worldNormal",Sl.Vector3),this.registerInput("worldTangent",Sl.AutoDetect,!0),this.registerOutput("output",Sl.Vector4),this.registerOutput("xyz",Sl.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage,r=e.fSuffix;this.generateInWorldSpace||this.worldTangent.isConnected||f.V.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const n=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(norm, tgt);\n            mat3 TBN = mat3(tgt, biTangent, norm);\n            ",s=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ";let a=`\n            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {\n                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}\n                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}\n                ${n}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(norm, worlddX);\n                vec3 crossY = cross(worlddY, norm);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * norm) - inToNormal);\n                ${s}\n                return vec4(result, 0.);\n            }`;return i?a=e._babylonSLtoWGSL(a):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",a,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${r}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});\n`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}(0,ue.Cg)([oa("Generate in world space instead of tangent space",0,"PROPERTIES",{notifiers:{update:!0}})],Jd.prototype,"generateInWorldSpace",void 0),(0,ue.Cg)([oa("Force normalization for the worldNormal input",0,"PROPERTIES",{notifiers:{update:!0}})],Jd.prototype,"automaticNormalizationNormal",void 0),(0,ue.Cg)([oa("Force normalization for the worldTangent input",0,"PROPERTIES",{notifiers:{update:!0}})],Jd.prototype,"automaticNormalizationTangent",void 0),(0,o.Y5)("BABYLON.HeightToNormalBlock",Jd);class ep extends Ml{constructor(e){super(e,xl.Fragment,!0),this.registerInput("depth",Sl.Float,!0),this.registerInput("worldPos",Sl.Vector4,!0),this.registerInput("viewProjection",Sl.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);const t=0===e.shaderLanguage?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                ${e._declareLocalVar("p",Sl.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                ${e._declareLocalVar("v",Sl.Float)} = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                ${t} = v;\n    \n            `:f.V.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}(0,o.Y5)("BABYLON.FragDepthBlock",ep);class tp extends Ml{constructor(e){super(e,xl.Fragment),this.registerInput("worldPosition",Sl.Vector4,!1),this.registerInput("viewProjection",Sl.Matrix,!1),this.registerInput("worldNormal",Sl.AutoDetect,!0),this.registerOutput("depth",Sl.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,81635)),Promise.resolve().then(i.bind(i,79643)),Promise.resolve().then(i.bind(i,43605))]):await Promise.all([Promise.resolve().then(i.bind(i,11728)),Promise.resolve().then(i.bind(i,98282)),Promise.resolve().then(i.bind(i,58230))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=1===e.shaderLanguage;e._emitUniformFromString("biasAndScaleSM",Sl.Vector3),e._emitUniformFromString("lightDataSM",Sl.Vector3),e._emitUniformFromString("depthValuesSM",Sl.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`${e._declareLocalVar("worldPos",Sl.Vector4)} = ${this.worldPosition.associatedVariableName};\n`,e.compilationString+=`${e._declareLocalVar("vPositionWSM",Sl.Vector3)};\n`,e.compilationString+=`${e._declareLocalVar("vDepthMetricSM",Sl.Float)} = 0.0;\n`,e.compilationString+=`${e._declareLocalVar("zSM",Sl.Float)};\n`,this.worldNormal.isConnected&&(e.compilationString+=`${e._declareLocalVar("vNormalW",Sl.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`${e._declareLocalVar("clipPos",Sl.Vector4)} = ${this.viewProjection.associatedVariableName} * worldPos;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"},{search:/vertexOutputs.position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]});const r=i?"fragmentOutputs.fragDepth":"gl_FragDepth";return e.compilationString+=`\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    ${r} = (clipPos.z / clipPos.w);\n                #else\n                    ${r} = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3${e.fSuffix}(depthSM, 1., 1.);\n`,this}}(0,o.Y5)("BABYLON.ShadowMapBlock",tp);class ip extends Ml{constructor(e){super(e,xl.Fragment,!0),this.registerInput("viewDepth",Sl.Float,!0),this.registerInput("screenDepth",Sl.Float,!0),this.registerInput("worldPosition",Sl.AutoDetect,!0),this.registerInput("localPosition",Sl.AutoDetect,!0),this.registerInput("viewNormal",Sl.AutoDetect,!0),this.registerInput("worldNormal",Sl.AutoDetect,!0),this.registerInput("reflectivity",Sl.AutoDetect,!0),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4),this.inputs[4].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4),this.inputs[5].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4),this.inputs[6].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get screenDepth(){return this._inputs[1]}get worldPosition(){return this._inputs[2]}get localPosition(){return this._inputs[3]}get viewNormal(){return this._inputs[4]}get worldNormal(){return this._inputs[5]}get reflectivity(){return this._inputs[6]}_getFragData(e,t){return e?`fragmentOutputs.fragData${t}`:`gl_FragData[${t}]`}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.localPosition,r=this.viewNormal,n=this.worldNormal,s=this.viewDepth,a=this.reflectivity,o=this.screenDepth;e.sharedData.blocksWithDefines.push(this);const l=`//${this.name}`,c=e._getShaderType(Sl.Vector4),h=1===e.shaderLanguage;return e._emitFunctionFromInclude("helperFunctions",l),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+=h?"var fragData: array<vec4<f32>, SCENE_MRT_COUNT>;\r\n":"vec4 fragData[SCENE_MRT_COUNT];\r\n",e.compilationString+="#ifdef PREPASS_DEPTH\r\n",s.connectedPoint?e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${c}(${s.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${c}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_SCREENSPACE_DEPTH\r\n",o.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(${o.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=" gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_POSITION\r\n",t.connectedPoint?e.compilationString+=`fragData[PREPASS_POSITION_INDEX] = ${c}(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===Sl.Vector4?t.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_POSITION_INDEX] = ${c}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_LOCAL_POSITION\r\n",i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===Sl.Vector4?i.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_NORMAL\r\n",r.connectedPoint?e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${c}(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===Sl.Vector4?r.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${c}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_WORLD_NORMAL\r\n",n.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(${n.associatedVariableName}.rgb, ${n.connectedPoint.type===Sl.Vector4?n.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_REFLECTIVITY\r\n",a.connectedPoint?e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${c}(${a.associatedVariableName}.rgb, ${a.connectedPoint.type===Sl.Vector4?a.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${c}(0.0, 0.0, 0.0, 1.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 1\r\n",e.compilationString+=`${this._getFragData(h,1)} = fragData[1];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 2\r\n",e.compilationString+=`${this._getFragData(h,2)} = fragData[2];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 3\r\n",e.compilationString+=`${this._getFragData(h,3)} = fragData[3];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 4\r\n",e.compilationString+=`${this._getFragData(h,4)} = fragData[4];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 5\r\n",e.compilationString+=`${this._getFragData(h,5)} = fragData[5];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 6\r\n",e.compilationString+=`${this._getFragData(h,6)} = fragData[6];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 7\r\n",e.compilationString+=`${this._getFragData(h,7)} = fragData[7];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this}}(0,o.Y5)("BABYLON.PrePassOutputBlock",ip);var rp=i(68458),np=i(93673),sp=i(76224),ap=i(60201),op=i(85204),lp=i(94021),cp=i(41627),hp=i(54013),up=i(44806),dp=i(55574),pp=i(37418),fp=i(10305),mp=i(81635),_p=i(79643),gp=i(43605),vp=i(11728),Sp=i(98282),xp=i(58230);class Tp extends Ml{constructor(e){super(e,xl.VertexAndFragment,!1),this.registerInput("worldPosition",Sl.Vector4,!1,xl.Vertex),this.registerInput("view",Sl.Matrix,!1,xl.Vertex),this.registerInput("input",Sl.AutoDetect,!1,xl.Fragment),this.registerInput("fogColor",Sl.AutoDetect,!1,xl.Fragment),this.registerOutput("output",Sl.Color3,xl.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(i.bind(i,59939)):await Promise.resolve().then(i.bind(i,69586)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.View&&t(e)));i||(i=new Bl("view"),i.setAsSystemValue(Al.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.FogColor&&t(e)));i||(i=new Bl("fogColor",void 0,Sl.Color3),i.setAsSystemValue(Al.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const r=e.getScene();i.setValue("FOG",t.fogEnabled&&(0,qo.qL)(e,r))}bind(e,t,i){if(!i)return;const r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",r="";1===e.shaderLanguage?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",r="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});const n=e._getFreeVariableName("fog"),s=this.input,a=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const o=this._outputs[0];e._emitUniformFromString(this._fogParameters,Sl.Vector4),e.compilationString+="#ifdef FOG\n",e.compilationString+=`${e._declareLocalVar(n,Sl.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${r}${this._fogParameters});\n`,e.compilationString+=e._declareOutput(o)+` = ${n} * ${s.associatedVariableName}.rgb + (1.0 - ${n}) * ${a.associatedVariableName}.rgb;\n`,e.compilationString+=`#else\n${e._declareOutput(o)} =  ${s.associatedVariableName}.rgb;\n`,e.compilationString+="#endif\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,Sl.Vector3);const r=1===e.shaderLanguage?"vertexOutputs.":"";e.compilationString+=`${r}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\n`}return this}}(0,o.Y5)("BABYLON.FogBlock",Tp);class Ep extends Ml{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,f.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?xl.Fragment:xl.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?xl.Fragment:xl.Vertex}constructor(e){super(e,xl.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",Sl.Vector4,!1,xl.Vertex),this.registerInput("worldNormal",Sl.Vector4,!1,xl.Fragment),this.registerInput("cameraPosition",Sl.Vector3,!1,xl.Fragment),this.registerInput("glossiness",Sl.Float,!0,xl.Fragment),this.registerInput("glossPower",Sl.Float,!0,xl.Fragment),this.registerInput("diffuseColor",Sl.Color3,!0,xl.Fragment),this.registerInput("specularColor",Sl.Color3,!0,xl.Fragment),this.registerInput("view",Sl.Matrix,!0),this.registerOutput("diffuseOutput",Sl.Color3,xl.Fragment),this.registerOutput("specularOutput",Sl.Color3,xl.Fragment),this.registerOutput("shadow",Sl.Float,xl.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,49979)),Promise.resolve().then(i.bind(i,10879)),Promise.resolve().then(i.bind(i,46225)),Promise.resolve().then(i.bind(i,68458)),Promise.resolve().then(i.bind(i,6529)),Promise.resolve().then(i.bind(i,32889)),Promise.resolve().then(i.bind(i,95988))]):await Promise.all([Promise.resolve().then(i.bind(i,16802)),Promise.resolve().then(i.bind(i,10948)),Promise.resolve().then(i.bind(i,6492)),Promise.resolve().then(i.bind(i,83034)),Promise.resolve().then(i.bind(i,13292)),Promise.resolve().then(i.bind(i,60201)),Promise.resolve().then(i.bind(i,52182)),Promise.resolve().then(i.bind(i,75520)),Promise.resolve().then(i.bind(i,29523))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.CameraPosition&&t(e)));i||(i=new Bl("cameraPosition"),i.setAsSystemValue(Al.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const r=e.getScene();if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,qo.lo)(r,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,qo.az)(r,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,r){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const t=e.uniforms.indexOf("vLightData"+n)>=0;(0,qo.GD)(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],r,t)}}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?(0,qo.Kd)(this.light,this._lightId,r,e,!0):(0,qo.RL)(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,Sl.Vector4)&&(e.compilationString+=(1===e.shaderLanguage?"vertexOutputs.":"")+`${r} = ${t.associatedVariableName};\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",Sl.Vector4)} = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",Sl.Matrix)} = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){const t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);const t=1===e.shaderLanguage,i=t?"f":"",r=`//${this.name}`;if(e.target!==xl.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const n=t?"fragmentInputs.":"";e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const s=this.worldPosition;let a=s.associatedVariableName;this.generateOnlyFragmentCode?(a=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(a,Sl.Vector3)};\n`,r),e.compilationString+=`${a} = ${s.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${s.associatedVariableName}`:void 0})):a=n+"v_"+a+".xyz",e._emitFunctionFromInclude("helperFunctions",r);let o={search:/vPositionW/g,replace:a};if(t&&(o={search:/fragmentInputs\.vPositionW/g,replace:a}),e._emitFunctionFromInclude("lightsFragmentFunctions",r,{replaceStrings:[o]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",r,{replaceStrings:[o]}),this._injectUBODeclaration(e),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",Sl.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${a});\n`),e.compilationString+=t?"var info: lightingInfo;\n":"lightingInfo info;\n",e.compilationString+=`${e._declareLocalVar("shadow",Sl.Float)} = 1.;\n`,e.compilationString+=`${e._declareLocalVar("aggShadow",Sl.Float)} = 0.;\n`,e.compilationString+=`${e._declareLocalVar("numLights",Sl.Float)} = 0.;\n`,e.compilationString+=`${e._declareLocalVar("glossiness",Sl.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\n`,e.compilationString+=`${e._declareLocalVar("diffuseBase",Sl.Vector3)} = vec3${i}(0., 0., 0.);\n`,e.compilationString+=`${e._declareLocalVar("specularBase",Sl.Vector3)}  = vec3${i}(0., 0., 0.);\n`,e.compilationString+=`${e._declareLocalVar("normalW",Sl.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;\n`),this.light){let i={search:/vPositionW/g,replace:a+".xyz"};t&&(i={search:/fragmentInputs\.vPositionW/g,replace:a+".xyz"}),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},i]})}else{let i=`vPositionW,${a}.xyz`;t&&(i=`fragmentInputs.vPositionW,${a}.xyz`),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:i})}0===this._lightId&&(e.compilationString+="aggShadow = aggShadow / numLights;\n");const l=this.diffuseOutput,c=this.specularOutput;return e.compilationString+=e._declareOutput(l)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\n`,c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\n`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+" = aggShadow;\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,ue.Cg)([oa("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Ep._OnGenerateOnlyFragmentCodeChanged}})],Ep.prototype,"generateOnlyFragmentCode",void 0),(0,o.Y5)("BABYLON.LightBlock",Ep);class Cp extends Ml{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??P.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get samplerName(){return this._samplerName}constructor(e){super(e,xl.VertexAndFragment),this.registerOutput("source",Sl.Object,xl.VertexAndFragment,new Td("source",this,1,Cp,"ImageSourceBlock")),this.registerOutput("dimensions",Sl.Vector2)}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),e.target===xl.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let t="";t=1===e.shaderLanguage?`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${t};\n`}return e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!sc.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=_e.g.Parse(e.texture,t,i))}}(0,o.Y5)("BABYLON.ImageSourceBlock",Cp);class bp extends Ml{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??P.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _IsPrePassTextureBlock(e){return"PrePassTextureBlock"===e?.getClassName()}get _isSourcePrePass(){return bp._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!bp._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=this.texture.getScene()??P.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=this.texture.getScene()??P.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?xl.Fragment:xl.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",Sl.AutoDetect,!1,xl.VertexAndFragment),this.registerInput("source",Sl.Object,!0,xl.VertexAndFragment,new Td("source",this,0,Cp,"ImageSourceBlock")),this.registerInput("layer",Sl.Float,!0),this.registerInput("lod",Sl.Float,!0),this.registerOutput("rgba",Sl.Color4,xl.Neutral),this.registerOutput("rgb",Sl.Color3,xl.Neutral),this.registerOutput("r",Sl.Float,xl.Neutral),this.registerOutput("g",Sl.Float,xl.Neutral),this.registerOutput("b",Sl.Float,xl.Neutral),this.registerOutput("a",Sl.Float,xl.Neutral),this.registerOutput("level",Sl.Float,xl.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector2|Sl.Vector3|Sl.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}_isTiedToFragment(e){if(e.target===xl.Fragment)return!0;if(e.target===xl.Vertex)return!1;if(e.target===xl.Neutral||e.target===xl.VertexAndFragment){const t=e.ownerBlock;if(t.target===xl.Fragment)return!0;for(const e of t.inputs)if(e.isConnected&&this._isTiedToFragment(e.connectedPoint))return!0}return!1}_getEffectiveTarget(){return this._fragmentOnly?xl.Fragment:this.uv.isConnected?this.uv.sourceBlock.isInput?xl.VertexAndFragment:this._isTiedToFragment(this.uv.connectedPoint)?xl.Fragment:xl.VertexAndFragment:xl.VertexAndFragment}get target(){return this._getEffectiveTarget()}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected)if(e.mode===Xl.PostProcess){const i=e.getBlockByPredicate((e=>"uv"===e.name&&t(e)));i&&i.connectTo(this)}else if(e.mode!==Xl.ProceduralTexture){const i=e.mode===Xl.Particle?"particle_uv":"uv";let r=e.getInputBlockByPredicate((e=>e.isAttribute&&e.name===i&&t(e)));r||(r=new Bl("uv"),r.setAsAttribute(i)),r.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,n,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==xl.Fragment}_injectVertexCode(e){const t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,Sl.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,Sl.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,Sl.Matrix,this._defineName);const i=e._getShaderType(Sl.Vector4),r=e._getShaderType(Sl.Vector2);e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${r}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`;let n="";if(1===e.shaderLanguage&&t.isConnectedToInputBlock&&-1===t.associatedVariableName.indexOf("vertexInputs.")&&(n="vertexInputs."),e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${n}${t.associatedVariableName}.xy;\n`,e.compilationString+="#endif\n",this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}}_getUVW(e){let t=e;const i=this._texture?._texture?.is2DArray??!1,r=this._texture?._texture?.is3D??!1;return(i||r)&&(t=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),t}_samplerFunc(e){return 1===e.shaderLanguage?e.target===xl.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(1===t.shaderLanguage){const i=t.target===xl.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};\n`,e.compilationString+="#endif\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===xl.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==xl.Fragment?this._generateTextureLookup(e):e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};\n`}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = ${e._toLinearSpace(t)};\n                #endif\n            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===xl.Fragment)return;return e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===xl.Fragment)return e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i);let n="";this.disableLevelMultiplication||(n=" * "+(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${n};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===xl.Vertex||this._fragmentOnly||e.target===xl.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===xl.Fragment||this._isMixed&&e.target===xl.Vertex){if(!this._imageSource){const t=e._getFreeVariableName(this.name);this._samplerName=t+"Texture",this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==xl.Fragment)return void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;this._isMixed&&!this._imageSource&&(this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,Sl.Float),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!sc.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=_e.g.Parse(e.texture,t,i))}}(0,o.Y5)("BABYLON.TextureBlock",bp);class Pp extends Ml{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??P.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?xl.Fragment:xl.VertexAndFragment)}constructor(e){super(e,xl.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(i.bind(i,44338)):await Promise.resolve().then(i.bind(i,1139)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Bl("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.World&&t(e)));i||(i=new Bl("world"),i.setAsSystemValue(Al.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.View&&t(e)));i||(i=new Bl("view"),i.setAsSystemValue(Al.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this._getTexture();r&&r.getTextureMatrix&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLocalCubicName,!!r.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===r.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===r.coordinatesMode,!0),i.setValue(this._defineCubicName,3===r.coordinatesMode||6===r.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===r.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===r.coordinatesMode,!0),i.setValue(this._definePlanarName,2===r.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===r.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===r.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===r.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===r.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i,r){const n=this._getTexture();if(i&&n&&(e.setMatrix(this._reflectionMatrixName,n.getReflectionTextureMatrix()),n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n),n.boundingBoxSize)){const t=n;e.setVector3(this._reflectionPositionName,t.boundingBoxPosition),e.setVector3(this._reflectionSizeName,t.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===xl.Vertex)return"";const t=1===e.shaderLanguage;this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,Sl.Matrix);let i="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const r=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(r,Sl.Vector4))&&(this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(r,Sl.Vector4)} = ${this.worldPosition.associatedVariableName};\n`:i+=`${t?"vertexOutputs.":""}${r} = ${this.worldPosition.associatedVariableName};\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,Sl.Vector3,this._defineSkyboxName))&&(i+=`#ifdef ${this._defineSkyboxName}\n`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._positionUVWName,Sl.Vector3)} = ${this.position.associatedVariableName}.xyz;\n`:i+=`${t?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\n`,i+="#endif\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,Sl.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(i+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\n`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._directionWName,Sl.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));\n`:i+=`${t?"vertexOutputs.":""}${this._directionWName} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));\n`,i+="#endif\n"),i}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+="#else\n",e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords\(worldPos: vec4f,worldNormal: vec3f\)->vec3f/g,replace:"fn DUMMYFUNC()"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,Sl.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,Sl.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,r=!1,n=!1){i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const s=(1===e.shaderLanguage?"uniforms.":"")+this._reflectionMatrixName,a=`normalize(${this._directionWName})`,o=`${this._positionUVWName}`,l=`${this.cameraPosition.associatedVariableName}`,c=`${this.view.associatedVariableName}`;t+=".xyz";let h=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n               ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${a});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${a});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${l}.xyz, ${s});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeSphericalCoords(${i}, ${t}, ${c}, ${s});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computePlanarCoords(${i}, ${t}, ${l}.xyz, ${s});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${l}.xyz, ${s}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeCubicCoords(${i}, ${t}, ${l}.xyz, ${s});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeProjectionCoords(${i}, ${c}, ${s});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = computeSkyBoxCoords(${o}, ${s});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                ${e._declareLocalVar(this._reflectionVectorName,Sl.Vector3)} = vec3(0, 0, 0);\n            #endif\n`;return n||(h+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\n`),r||(h+=`\n                #ifdef ${this._define3DName}\n                    ${e._declareLocalVar(this._reflectionCoordsName,Sl.Vector3)} = ${this._reflectionVectorName};\n                #else\n                    ${e._declareLocalVar(this._reflectionCoordsName,Sl.Vector2)} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\n`),h}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let r=Sl.Vector4;3===i.length&&(r=Sl.Vector3);let n=`${e._declareLocalVar(this._reflectionColorName,r)};\n            #ifdef ${this._define3DName}\n`;return n+=t?`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};\n`:`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};\n`,n+="\n            #else\n",n+=t?`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};\n`:`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};\n`,n+="#endif\n",n}writeOutputs(e,t){let i="";if(e.target===xl.Fragment)for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!sc.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=Uo.b.Parse(e.texture,t,i):this.texture=_e.g.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,ue.Cg)([oa("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Pp._OnGenerateOnlyFragmentCodeChanged}})],Pp.prototype,"generateOnlyFragmentCode",void 0),(0,o.Y5)("BABYLON.ReflectionTextureBaseBlock",Pp);class yp extends Pp{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,f.V.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,f.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?xl.Fragment:xl.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?xl.Fragment:xl.Vertex}constructor(e){super(e),this.registerInput("position",Sl.AutoDetect,!1,xl.Vertex),this.registerInput("worldPosition",Sl.Vector4,!1,xl.Vertex),this.registerInput("worldNormal",Sl.Vector4,!1,xl.Fragment),this.registerInput("world",Sl.Matrix,!1,xl.Vertex),this.registerInput("cameraPosition",Sl.Vector3,!1,xl.Fragment),this.registerInput("view",Sl.Matrix,!1,xl.Fragment),this.registerOutput("rgb",Sl.Color3,xl.Fragment),this.registerOutput("rgba",Sl.Color4,xl.Fragment),this.registerOutput("r",Sl.Float,xl.Fragment),this.registerOutput("g",Sl.Float,xl.Fragment),this.registerOutput("b",Sl.Float,xl.Fragment),this.registerOutput("a",Sl.Float,xl.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.CameraPosition&&t(e)));i||(i=new Bl("cameraPosition"),i.setAsSystemValue(Al.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==xl.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,Sl.Vector4)} = normalize(${this.worldNormal.associatedVariableName});\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}(0,o.Y5)("BABYLON.ReflectionTextureBlock",yp);class Ap extends Ml{constructor(e){super(e,xl.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",Sl.AutoDetect,!1,xl.VertexAndFragment),this.registerOutput("depth",Sl.Float,xl.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector2|Sl.Vector3|Sl.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?xl.VertexAndFragment:xl.Fragment:xl.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,t.type===Sl.Vector3?Sl.Vector3:t.type===Sl.Vector4?Sl.Vector4:Sl.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,Sl.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===xl.Fragment)return;const t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,r=0===e.shaderLanguage?"":", 0";return void(e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)}=  ${t} ${i.associatedVariableName}.xy${r});\n`)}const r=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;this.uv.ownerBlock.target!==xl.Fragment?e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${r} ${this._mainUVName});\n`:e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = ${r} ${i.associatedVariableName}.xy);\n`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===xl.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target,xl.Fragment,e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==xl.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some((e=>e.isConnectedInFragmentShader))){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}(0,ue.Cg)([oa("Use non linear depth",0,"ADVANCED",{embedded:!0,notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let r=!1;return i.useNonLinearDepth&&(i.storeCameraSpaceZ=!1,r=!0),e&&e.disableDepthRenderer(),r}}})],Ap.prototype,"useNonLinearDepth",void 0),(0,ue.Cg)([oa("Store Camera space Z",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let r=!1;return i.storeCameraSpaceZ&&(i.useNonLinearDepth=!1,r=!0),e&&e.disableDepthRenderer(),r}}})],Ap.prototype,"storeCameraSpaceZ",void 0),(0,ue.Cg)([oa("Force 32 bits float",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>e?.disableDepthRenderer()}})],Ap.prototype,"force32itsFloat",void 0),(0,o.Y5)("BABYLON.SceneDepthBlock",Ap);class Rp extends Ml{constructor(e){super(e,xl.VertexAndFragment,!0),this.registerInput("worldPosition",Sl.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,72207)),Promise.resolve().then(i.bind(i,24595)),Promise.resolve().then(i.bind(i,22713)),Promise.resolve().then(i.bind(i,45737))]):await Promise.all([Promise.resolve().then(i.bind(i,71288)),Promise.resolve().then(i.bind(i,77630)),Promise.resolve().then(i.bind(i,85046)),Promise.resolve().then(i.bind(i,70624))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get target(){return xl.VertexAndFragment}set target(e){}prepareDefines(e,t,i){const r=e.getScene(),n=!!(t.clipPlane??r.clipPlane),s=!!(t.clipPlane2??r.clipPlane2),a=!!(t.clipPlane3??r.clipPlane3),o=!!(t.clipPlane4??r.clipPlane4),l=!!(t.clipPlane5??r.clipPlane5),c=!!(t.clipPlane6??r.clipPlane6);i.setValue("CLIPPLANE",n,!0),i.setValue("CLIPPLANE2",s,!0),i.setValue("CLIPPLANE3",a,!0),i.setValue("CLIPPLANE4",o,!0),i.setValue("CLIPPLANE5",l,!0),i.setValue("CLIPPLANE6",c,!0)}bind(e,t,i){if(!i)return;const r=i.getScene();(0,Xo.gS)(e,t,r)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==xl.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",Sl.Vector4),e._emitUniformFromString("vClipPlane2",Sl.Vector4),e._emitUniformFromString("vClipPlane3",Sl.Vector4),e._emitUniformFromString("vClipPlane4",Sl.Vector4),e._emitUniformFromString("vClipPlane5",Sl.Vector4),void e._emitUniformFromString("vClipPlane6",Sl.Vector4)}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}(0,o.Y5)("BABYLON.ClipPlanesBlock",Rp);var Ip,Mp=i(72207),Op=i(24595),Np=i(22713),Dp=i(45737),Fp=i(71288),Lp=i(77630),wp=i(85046),Bp=i(70624),Vp=i(59939),kp=i(69586),Gp=i(49979),Up=i(10879),zp=i(46225),Wp=i(6529),Hp=i(32889),Yp=i(95988),Xp=i(16802),qp=i(10948),$p=i(6492),jp=i(83034),Kp=i(13292),Zp=i(52182),Qp=i(75520),Jp=i(29523),ef=i(44338),tf=i(1139);class rf extends Ml{get texture(){return null}set texture(e){}constructor(e,t=xl.VertexAndFragment){super(e,t,!1),this.registerOutput("position",Sl.Object,xl.VertexAndFragment,new Td("position",this,1,Cp,"ImageSourceBlock")),this.registerOutput("localPosition",Sl.Object,xl.VertexAndFragment,new Td("localPosition",this,1,Cp,"ImageSourceBlock")),this.registerOutput("depth",Sl.Object,xl.VertexAndFragment,new Td("depth",this,1,Cp,"ImageSourceBlock")),this.registerOutput("screenDepth",Sl.Object,xl.VertexAndFragment,new Td("screenDepth",this,1,Cp,"ImageSourceBlock")),this.registerOutput("normal",Sl.Object,xl.VertexAndFragment,new Td("normal",this,1,Cp,"ImageSourceBlock")),this.registerOutput("worldNormal",Sl.Object,xl.VertexAndFragment,new Td("worldNormal",this,1,Cp,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._localPositionSamplerName:e===this._outputs[2]?this._depthSamplerName:e===this._outputs[3]?this._screenSpaceDepthSamplerName:e===this._outputs[4]?this._normalSamplerName:e===this._outputs[5]?this._worldNormalSamplerName:""}get position(){return this._outputs[0]}get localPosition(){return this._outputs[1]}get depth(){return this._outputs[2]}get screenDepth(){return this._outputs[3]}get normal(){return this._outputs[4]}get worldNormal(){return this._outputs[5]}get positionSamplerName(){return this._positionSamplerName}get localPositionSamplerName(){return this._localPositionSamplerName}get normalSamplerName(){return this._normalSamplerName}get worldNormalSamplerName(){return this._worldNormalSamplerName}get depthSamplerName(){return this._depthSamplerName}get linearDepthSamplerName(){return this._screenSpaceDepthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==xl.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",this._worldNormalSamplerName="prepassWorldNormalSampler",this._localPositionSamplerName="prepassLocalPositionSampler",this._screenSpaceDepthSamplerName="prepassScreenSpaceDepthSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.variableNames.prepassWorldNormalSampler=0,e.sharedData.variableNames.prepassLocalPositionSampler=0,e.sharedData.variableNames.prepassScreenSpaceDepthSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),this.position.isConnected&&e._emit2DSampler(this._positionSamplerName),this.depth.isConnected&&e._emit2DSampler(this._depthSamplerName),this.normal.isConnected&&e._emit2DSampler(this._normalSamplerName),this.worldNormal.isConnected&&e._emit2DSampler(this._worldNormalSamplerName),this.localPosition.isConnected&&e._emit2DSampler(this._localPositionSamplerName),this.screenDepth.isConnected&&e._emit2DSampler(this._screenSpaceDepthSamplerName),this}bind(e,t){const i=t.getScene().enablePrePassRenderer();if(!i)return;const r=i.defaultRT;r.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,r.textures[i.getIndex(1)]),this.localPosition.isConnected&&e.setTexture(this._localPositionSamplerName,r.textures[i.getIndex(9)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,r.textures[i.getIndex(5)]),this.screenDepth.isConnected&&e.setTexture(this._screenSpaceDepthSamplerName,r.textures[i.getIndex(10)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,r.textures[i.getIndex(6)]),this.worldNormal.isConnected&&e.setTexture(this._worldNormalSamplerName,r.textures[i.getIndex(8)]))}}(0,o.Y5)("BABYLON.PrePassTextureBlock",rf);class nf extends Ml{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==xl.VertexAndFragment)return t.target;if(e.connectedPoint.target!==xl.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,xl.Neutral),this._endpoints=[],this.registerInput("input",Sl.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some((e=>e.output.isConnectedInFragmentShader))}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name,this._outputs=this._endpoints.map((e=>e.output))}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null,this._outputs=this._endpoints.map((e=>e.output)))}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}(0,o.Y5)("BABYLON.NodeMaterialTeleportInBlock",nf);class sf extends Ml{constructor(e){super(e,xl.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",Sl.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};\n`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}(0,o.Y5)("BABYLON.NodeMaterialTeleportOutBlock",sf);class af extends Hl{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.AddBlock",af);class of extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.AutoDetect),this.registerInput("factor",Sl.Float),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.ScaleBlock",of);class lf extends Ml{constructor(e){super(e,xl.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}(0,ue.Cg)([oa("Minimum",1,void 0,{embedded:!0})],lf.prototype,"minimum",void 0),(0,ue.Cg)([oa("Maximum",1,void 0,{embedded:!0})],lf.prototype,"maximum",void 0),(0,o.Y5)("BABYLON.ClampBlock",lf);class cf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Sl.Vector2),this._inputs[1].excludedConnectionPointTypes.push(Sl.Float),this._inputs[1].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Sl.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\n`,this}}(0,o.Y5)("BABYLON.CrossBlock",cf);class hf extends Ml{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach((r=>{const n=new RegExp("\\{TYPE_"+r.name+"\\}","gm"),s=e._getGLType(r.type);t=t.replace(n,s),i=i.replace(n,s)})),this._outputs.forEach((r=>{const n=new RegExp("\\{TYPE_"+r.name+"\\}","gm"),s=e._getGLType(r.type);t=t.replace(n,s),i=i.replace(n,s)})),e._emitFunction(i,t,""),this._outputs.forEach((t=>{e.compilationString+=e._declareOutput(t)+";\n"})),e.compilationString+=i+"(";let r=!1;return this._inputs.forEach(((t,i)=>{i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=t.connectedPoint?.ownerBlock?.samplerName??t.associatedVariableName:e.compilationString+=t.associatedVariableName,r=!0})),this._outputs.forEach(((t,i)=>{(i>0||r)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName})),e.compilationString+=");\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=xl[e.target],e.inParameters?.forEach(((e,t)=>{const i=Sl[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,Sl.Object,!0,xl.VertexAndFragment,new Td(e.name,this,0,Cp,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})})),e.outParameters?.forEach(((e,t)=>{this.registerOutput(e.name,Sl[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])})),e.inLinkedConnectionTypes?.forEach((e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])}))}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}(0,o.Y5)("BABYLON.CustomBlock",hf);class uf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Sl.Float),this._inputs[1].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.DotBlock",uf);class df extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.NormalizeBlock",df);class pf extends Ml{constructor(e){super(e,xl.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",Sl.Color3,!0),this.registerInput("r",Sl.Float,!0),this.registerInput("g",Sl.Float,!0),this.registerInput("b",Sl.Float,!0),this.registerInput("a",Sl.Float,!0),this.registerOutput("rgba",Sl.Color4),this.registerOutput("rgb",Sl.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,r=this.b,n=this.a,s=this.rgbIn,a=this._outputs[0],o=this._outputs[1],l=e._getShaderType(Sl.Vector4),c=e._getShaderType(Sl.Vector3);return s.isConnected?(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}(${s.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${s.associatedVariableName}${this._buildSwizzle(3)};\n`)):(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\n`,e}}(0,o.Y5)("BABYLON.ColorMergerBlock",pf);class ff extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("xyzw",Sl.Vector4,!0),this.registerInput("xyz ",Sl.Vector3,!0),this.registerInput("xy ",Sl.Vector2,!0),this.registerOutput("xyz",Sl.Vector3),this.registerOutput("xy",Sl.Vector2),this.registerOutput("zw",Sl.Vector2),this.registerOutput("x",Sl.Float),this.registerOutput("y",Sl.Float),this.registerOutput("z",Sl.Float),this.registerOutput("w",Sl.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],n=this._outputs[2],s=this._outputs[3],a=this._outputs[4],o=this._outputs[5],l=this._outputs[6],c=e._getShaderType(Sl.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${c}(${t.associatedVariableName}, 0.0);\n`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;\n`),n.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(n)+` = ${this.xyzw.associatedVariableName}.zw;\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.xy;\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.x;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.y;\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.z;\n`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.w;\n`),this}}(0,o.Y5)("BABYLON.VectorSplitterBlock",ff);class mf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerInput("gradient",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(Sl.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.LerpBlock",mf);class _f extends Hl{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.DivideBlock",_f);class gf extends Hl{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.SubtractBlock",gf);class vf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.Float),this.registerInput("edge",Sl.Float),this.registerOutput("output",Sl.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.StepBlock",vf);class Sf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.OneMinusBlock",Sf),(0,o.Y5)("BABYLON.OppositeBlock",Sf);class xf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("worldPosition",Sl.Vector4),this.registerInput("cameraPosition",Sl.Vector3),this.registerOutput("output",Sl.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.CameraPosition&&t(e)));i||(i=new Bl("cameraPosition"),i.setAsSystemValue(Al.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\n`,this}}(0,o.Y5)("BABYLON.ViewDirectionBlock",xf),i(27735);class Tf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("worldNormal",Sl.Vector4),this.registerInput("viewDirection",Sl.Vector3),this.registerInput("bias",Sl.Float),this.registerInput("power",Sl.Float),this.registerOutput("fresnel",Sl.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new xf("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const e=new Bl("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){const e=new Bl("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.FresnelBlock",Tf);class Ef extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.MaxBlock",Ef);class Cf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.MinBlock",Cf);class bf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Sl.Float),this._inputs[1].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.DistanceBlock",bf);class Pf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.AutoDetect),this.registerOutput("output",Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.LengthBlock",Pf);class yf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.NegateBlock",yf);class Af extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.AutoDetect),this.registerInput("power",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(max(${this.value.associatedVariableName}, 0.), ${this.power.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.PowBlock",Af);class Rf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("seed",Sl.AutoDetect),this.registerOutput("output",Sl.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector2|Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);\n`,this}}(0,o.Y5)("BABYLON.RandomNumberBlock",Rf);class If extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("x",Sl.Float),this.registerInput("y",Sl.Float),this.registerOutput("output",Sl.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.ArcTan2Block",If);class Mf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.AutoDetect),this.registerInput("edge0",Sl.Float),this.registerInput("edge1",Sl.Float),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.SmoothStepBlock",Mf);class Of extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===Sl.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});\n`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.ReciprocalBlock",Of);class Nf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.AutoDetect),this.registerInput("reference",Sl.AutoDetect),this.registerInput("distance",Sl.Float),this.registerInput("replacement",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(Sl.Float),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Sl.Float),this._inputs[1].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[3].excludedConnectionPointTypes.push(Sl.Float),this._inputs[3].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+";\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\n`,e.compilationString+="} else {\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\n`,e.compilationString+="}\n",this}}(0,o.Y5)("BABYLON.ReplaceColorBlock",Nf);class Df extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("value",Sl.AutoDetect),this.registerInput("steps",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(Sl.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.PosterizeBlock",Df),function(e){e[e.SawTooth=0]="SawTooth",e[e.Square=1]="Square",e[e.Triangle=2]="Triangle"}(Ip||(Ip={}));class Ff extends Ml{constructor(e){super(e,xl.Neutral),this.kind=0,this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case 0:e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\n`;break;case 1:e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\n`;break;case 2:e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}(0,ue.Cg)([oa("Kind",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"SawTooth",value:0},{label:"Square",value:1},{label:"Triangle",value:2}]})],Ff.prototype,"kind",void 0),(0,o.Y5)("BABYLON.WaveBlock",Ff);class Lf{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class wf extends Ml{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,xl.Neutral),this.colorSteps=[new Lf(0,a.v9.Black()),new Lf(1,a.v9.White())],this.onValueChangedObservable=new n.cP,this.registerInput("gradient",Sl.AutoDetect),this.registerOutput("output",Sl.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Float|Sl.Vector2|Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){const i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(Sl.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);\n`);const r=e._getFreeVariableName("gradientTempColor"),n=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(r,Sl.Vector3)} = ${this._writeColorConstant(0,i)};\n`,e.compilationString+=`${e._declareLocalVar(n,Sl.Float)};\n`;let s=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==Sl.Float&&(s+=".x");for(let t=1;t<this.colorSteps.length;t++){const a=this.colorSteps[t],o=this.colorSteps[t-1];e.compilationString+=`${n} = clamp((${s} - ${e._emitFloat(o.step)}) / (${e._emitFloat(a.step)} -  ${e._emitFloat(o.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});\n`,e.compilationString+=`${r} = mix(${r}, ${this._writeColorConstant(t,i)}, ${n});\n`}return e.compilationString+=e._declareOutput(t)+` = ${r};\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const t of e.colorSteps)this.colorSteps.push(new Lf(t.step,new a.v9(t.color.r,t.color.g,t.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\n`;return e}}(0,o.Y5)("BABYLON.GradientBlock",wf);class Bf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerInput("gradient",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(Sl.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\n`,this}}(0,o.Y5)("BABYLON.NLerpBlock",Bf);class Vf extends Ml{constructor(e){super(e,xl.Neutral),this.manhattanDistance=!1,this.registerInput("seed",Sl.Vector3),this.registerInput("jitter",Sl.Float),this.registerOutput("output",Sl.Vector2),this.registerOutput("x",Sl.Float),this.registerOutput("y",Sl.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\n",t+="}\n\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n",t+="    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];\n",t+="}\n\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\n",t+="    float K = 0.142857142857; // 1/7\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\n",t+="    float Kz = 0.166666666667; // 1/6\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\n",t+="\n",t+="    vec3 Pi = mod(floor(P), 289.0);\n",t+="    vec3 Pf = fract(P) - 0.5;\n",t+="\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n",t+="\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\n",t+="    vec3 p2 = permute(p + Pi.y);\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\n",t+="\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\n",t+="    vec3 p12 = permute(p1 + Pi.z);\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\n",t+="    vec3 p22 = permute(p2 + Pi.z);\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\n",t+="    vec3 p32 = permute(p3 + Pi.z);\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n",t+="\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\n",t+="\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\n",t+="\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\n",t+="\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\n",t+="\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\n",t+="\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\n",t+="\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\n",t+="\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\n",t+="\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\n",t+="\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n",t+="    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n",t+="\n",t+="    vec3 d1a = min(d11, d12);\n",t+="    d12 = max(d11, d12);\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n",t+="    d13 = max(d1a, d13);\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\n",t+="    vec3 d2a = min(d21, d22);\n",t+="    d22 = max(d21, d22);\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n",t+="    d23 = max(d2a, d23);\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\n",t+="    vec3 d3a = min(d31, d32);\n",t+="    d32 = max(d31, d32);\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n",t+="    d33 = max(d3a, d33);\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\n",t+="    vec3 da = min(d11, d21);\n",t+="    d21 = max(d11, d21);\n",t+="    d11 = min(da, d31); // Smallest now in d11\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\n",t+="    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }\n",t+="    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\n",t+="    d12 = min(d12, d22); // nor in d22\n",t+="    d12 = min(d12, d31); // nor in d31\n",t+="    d12 = min(d12, d32); // nor in d32\n",t+="    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz\n",t+="    d11.y = temp2.x;\n",t+="    d11.z = temp2.y;\n",t+="    d11.y = min(d11.y, d12.z); // Only two more to go\n",t+="    d11.y = min(d11.y, d11.z); // Done! (Phew!)\n",t+="    return sqrt(d11.xy); // F1, F2\n",t+="}\n\n",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,Sl.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\n`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}(0,ue.Cg)([oa("Use Manhattan Distance",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Vf.prototype,"manhattanDistance",void 0),(0,o.Y5)("BABYLON.WorleyNoise3DBlock",Vf);class kf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("seed",Sl.Vector3),this.registerOutput("output",Sl.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\n",t+="float SimplexPerlin3D( vec3 source ){\n",t+="    vec3 P = source;\n",t+="    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\n",t+="    vec3 l = 1.0 - g;\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n",t+="    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n",t+="    Pt *= Pt;\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n",t+="    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];\n",t+="    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n",t+="    kernel_weights = max(0.5 - kernel_weights, vec4(0.));\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n",t+="}\n",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.SimplexPerlin3DBlock",kf);class Gf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("normalMap0",Sl.AutoDetect),this.registerInput("normalMap1",Sl.AutoDetect),this.registerOutput("output",Sl.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Color4|Sl.Vector3|Sl.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Color4|Sl.Vector3|Sl.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],n=e._getFreeVariableName("stepR"),s=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(n,Sl.Float)} = step(0.5, ${i.associatedVariableName}.r);\n`,e.compilationString+=`${e._declareLocalVar(s,Sl.Float)} = step(0.5, ${i.associatedVariableName}.g);\n`,e.compilationString+=e._declareOutput(t)+";\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${n}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${s}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${s} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;\n`,this}}(0,o.Y5)("BABYLON.NormalBlendBlock",Gf);class Uf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.Vector2),this.registerInput("angle",Sl.Float),this.registerOutput("output",Sl.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Bl("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);\n`,this}}(0,o.Y5)("BABYLON.Rotate2dBlock",Uf);class zf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("incident",Sl.AutoDetect),this.registerInput("normal",Sl.AutoDetect),this.registerOutput("output",Sl.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\n`,this}}(0,o.Y5)("BABYLON.ReflectBlock",zf);class Wf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("incident",Sl.AutoDetect),this.registerInput("normal",Sl.AutoDetect),this.registerInput("ior",Sl.Float),this.registerOutput("output",Sl.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Sl.Vector3|Sl.Vector4|Sl.Color3|Sl.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.RefractBlock",Wf);class Hf extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("color",Sl.Color3),this.registerInput("level",Sl.Float),this.registerOutput("output",Sl.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.color.associatedVariableName,r=e._getFreeVariableName("colorMin"),n=e._getFreeVariableName("colorMax"),s=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(r,Sl.Float)} = min(min(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`${e._declareLocalVar(n,Sl.Float)} = max(max(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`${e._declareLocalVar(s,Sl.Float)} = 0.5 * (${r} + ${n});\n`,e.compilationString+=e._declareOutput(t)+` = mix(${i}, ${e._getShaderType(Sl.Vector3)}(${s}, ${s}, ${s}), ${this.level.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.DesaturateBlock",Hf);class Yf extends Ml{constructor(e){super(e,xl.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",Sl.Float,!0,xl.Fragment),this.registerInput("color",Sl.Color3,!0,xl.Fragment),this.registerInput("roughness",Sl.Float,!0,xl.Fragment),this.registerOutput("sheen",Sl.Object,xl.Fragment,new Td("sheen",this,1,Yf,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e,t){let i="";const r=this.color.isConnected?this.color.associatedVariableName:`vec3${t.fSuffix}(1.)`,n=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",s=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",a=`vec4${t.fSuffix}(0.)`,o=1===t.shaderLanguage;return i=`#ifdef SHEEN\n            ${o?"var sheenOut: sheenOutParams":"sheenOutParams sheenOut"};\n\n            ${t._declareLocalVar("vSheenColor",Sl.Vector4)} = vec4${t.fSuffix}(${r}, ${n});\n\n            sheenOut = sheenBlock(\n                vSheenColor\n            #ifdef SHEEN_ROUGHNESS\n                , ${s}\n            #endif\n                , roughness\n            #ifdef SHEEN_TEXTURE\n                , ${a}\n                ${o?`, ${a}Sampler`:""}\n                , 1.0\n            #endif\n                , reflectance\n            #ifdef SHEEN_LINKWITHALBEDO\n                , baseColor\n                , surfaceAlbedo\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                , NdotV\n                , environmentBrdf\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                , AARoughnessFactors\n                , ${o?"uniforms.":""}${e?._vReflectionMicrosurfaceInfosName}\n                , ${e?._vReflectionInfosName}\n                , ${e?.reflectionColor}\n                , ${o?"uniforms.":""}vLightingIntensity\n                #ifdef ${e?._define3DName}\n                    , ${e?._cubeSamplerName}                                      \n                    ${o?`, ${e?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${e?._2DSamplerName}\n                    ${o?`, ${e?._2DSamplerName}Sampler`:""}\n                #endif\n                , reflectionOut.reflectionCoords\n                , NdotVUnclamped\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${e?._define3DName}\n                        , ${e?._cubeSamplerName}                        \n                        ${o?`, ${e?._cubeSamplerName}Sampler`:""}\n                        , ${e?._cubeSamplerName}\n                        ${o?`, ${e?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${e?._2DSamplerName}\n                        ${o?`, ${e?._2DSamplerName}Sampler`:""}\n                        , ${e?._2DSamplerName}\n                        ${o?`, ${e?._2DSamplerName}Sampler`:""}\n                    #endif\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    , seo\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e?._define3DName})\n                    , eho\n                #endif\n            #endif\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\n`,i}_buildBlock(e){return e.target===xl.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}(0,ue.Cg)([oa("Albedo scaling",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],Yf.prototype,"albedoScaling",void 0),(0,ue.Cg)([oa("Link sheen with albedo",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],Yf.prototype,"linkSheenWithAlbedo",void 0),(0,o.Y5)("BABYLON.SheenBlock",Yf);var Xf=i(71689);class qf extends Ml{constructor(e){super(e,xl.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",Sl.Float,!0,xl.Fragment),this.registerInput("direction",Sl.Vector2,!0,xl.Fragment),this.registerInput("uv",Sl.Vector2,!0),this.registerInput("worldTangent",Sl.Vector4,!0),this.registerInput("TBN",Sl.Object,!0,xl.VertexAndFragment,new Td("TBN",this,0,Hd,"TBNBlock")),this.registerInput("roughness",Sl.Float,!0,xl.Fragment),this.registerOutput("anisotropy",Sl.Object,xl.Fragment,new Td("anisotropy",this,1,qf,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,r=this.uv,n=this.worldPositionConnectionPoint,s=this.worldNormalConnectionPoint,a=this.worldTangent,o=1===e.shaderLanguage;r.isConnected||f.V.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            ${o?"var TBN":"mat3 TBN"} = ${c.associatedVariableName};\n            #endif\n            `:a.isConnected&&(t+=`${e._declareLocalVar("tbnNormal",Sl.Vector3)} = normalize(${s.associatedVariableName}.xyz);\n`,t+=`${e._declareLocalVar("tbnTangent",Sl.Vector3)} = normalize(${a.associatedVariableName}.xyz);\n`,t+=`${e._declareLocalVar("tbnBitangent",Sl.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,t+=`${o?"var vTBN":"mat3 vTBN"} = ${o?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);\n`),t+=`\n            #if defined(${a.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                ${o?"var TBN":"mat3 TBN"} = vTBN;\n            #else\n                ${o?"var TBN":"mat3 TBN"} = cotangent_frame(${s.associatedVariableName+".xyz"}, ${"v_"+n.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2${e.fSuffix}(1., 1.));\n            #endif\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const r=1===e.shaderLanguage,n=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return i+=`${r?"var anisotropicOut: anisotropicOutParams":"anisotropicOutParams anisotropicOut"};\n            anisotropicOut = anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${n}),\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW\n            );\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===xl.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,Sl.Float)),this}}(0,o.Y5)("BABYLON.AnisotropyBlock",qf);class $f extends Pp{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,f.V.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?xl.Fragment:xl.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",Sl.AutoDetect,!1,xl.Vertex),this.registerInput("world",Sl.Matrix,!1,xl.Vertex),this.registerInput("color",Sl.Color3,!0,xl.Fragment),this.registerOutput("reflection",Sl.Object,xl.Fragment,new Td("reflection",this,1,$f,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),n=r&&r.getTextureMatrix;i.setValue("REFLECTION",n,!0),n&&(i.setValue(this._defineLODReflectionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",r.gammaSpace,!0),i.setValue("RGBDREFLECTION",r.isRGBD,!0),r&&r.coordinatesMode!==_e.g.SKYBOX_MODE&&r.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);const n=this._getTexture();if(!n||!r)return;n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n);const s=n.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,s,n.lodGenerationScale,n.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,s,Math.log2(s));const a=r.materialDefines,o=n.sphericalPolynomial;if(a.USESPHERICALFROMREFLECTIONMAP&&o)if(a.SPHERICAL_HARMONICS){const t=o.preScaledHarmonics;e.setVector3("vSphericalL00",t.l00),e.setVector3("vSphericalL1_1",t.l1_1),e.setVector3("vSphericalL10",t.l10),e.setVector3("vSphericalL11",t.l11),e.setVector3("vSphericalL2_2",t.l2_2),e.setVector3("vSphericalL2_1",t.l2_1),e.setVector3("vSphericalL20",t.l20),e.setVector3("vSphericalL21",t.l21),e.setVector3("vSphericalL22",t.l22)}else e.setFloat3("vSphericalX",o.x.x,o.x.y,o.x.z),e.setFloat3("vSphericalY",o.y.x,o.y.y,o.y.z),e.setFloat3("vSphericalZ",o.z.x,o.z.y,o.z.z),e.setFloat3("vSphericalXX_ZZ",o.xx.x-o.zz.x,o.xx.y-o.zz.y,o.xx.z-o.zz.z),e.setFloat3("vSphericalYY_ZZ",o.yy.x-o.zz.x,o.yy.y-o.zz.y,o.yy.z-o.zz.z),e.setFloat3("vSphericalZZ",o.zz.x,o.zz.y,o.zz.z),e.setFloat3("vSphericalXY",o.xy.x,o.xy.y,o.xy.z),e.setFloat3("vSphericalYZ",o.yz.x,o.yz.y,o.yz.z),e.setFloat3("vSphericalZX",o.zx.x,o.zx.y,o.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);const i=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,Sl.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",Sl.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",Sl.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",Sl.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                ${e._declareLocalVar(r,Sl.Vector3)} = (${(i?"uniforms.":"")+this._reflectionMatrixName} * vec4${e.fSuffix}(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${r}.z *= -1.0;\n                #endif\n                ${i?"vertexOutputs.":""}${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${r});\n            #endif\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e);const r=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),r||(e._emitFunction("sampleReflection",`\n                #ifdef ${this._define3DName}\n                    #define sampleReflection(s, c) textureCube(s, c)\n                #else\n                    #define sampleReflection(s, c) texture2D(s, c)\n                #endif\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n                #ifdef ${this._define3DName}\n                    #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n                #else\n                    #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n                #endif\n`,`//${this.name}`));const n=r?`\n            fn computeReflectionCoordsPBR(worldPos: vec4f, worldNormal: vec3f) -> vec3f {\n                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`:`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`;return e._emitFunction("computeReflectionCoordsPBR",n,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,Sl.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,Sl.Vector2),i+=`#ifdef REFLECTION\n            ${e._declareLocalVar(this._vReflectionInfosName,Sl.Vector2)} = vec2${e.fSuffix}(1., 0.);\n\n            ${r?"var reflectionOut: reflectionOutParams":"reflectionOutParams reflectionOut"};\n\n            reflectionOut = reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:(r?"input.":"")+"v_"+this.worldPosition.associatedVariableName}.xyz\n                , ${t}\n                , alphaG\n                , ${(r?"uniforms.":"")+this._vReflectionMicrosurfaceInfosName}\n                , ${this._vReflectionInfosName}\n                , ${this.reflectionColor}\n            #ifdef ANISOTROPIC\n                ,anisotropicOut\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                ,NdotVUnclamped\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                , roughness\n            #endif\n            #ifdef ${this._define3DName}\n                , ${this._cubeSamplerName}\n                ${r?`, ${this._cubeSamplerName}Sampler`:""}\n            #else\n                , ${this._2DSamplerName}\n                ${r?`, ${this._2DSamplerName}Sampler`:""}\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                , ${r?"input.":""}${this._vEnvironmentIrradianceName}\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    , ${this._reflectionMatrixName}\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                , irradianceSampler         // ** not handled **\n                ${r?", irradianceSamplerSampler":""}\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    , ${this._cubeSamplerName}\n                    ${r?`, ${this._cubeSamplerName}Sampler`:""}\n                    , ${this._cubeSamplerName}\n                    ${r?`, ${this._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${this._2DSamplerName}\n                    ${r?`, ${this._2DSamplerName}Sampler`:""}\n                    , ${this._2DSamplerName}                    \n                    ${r?`, ${this._2DSamplerName}Sampler`:""}\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                , ${this._vReflectionFilteringInfoName}\n                #ifdef IBL_CDF_FILTERING\n                    , icdfxSampler         // ** not handled **\n                    ${r?", icdfxSamplerSampler":""}\n                    , icdfySampler         // ** not handled **\n                    ${r?", icdfySamplerSampler":""}\n                #endif\n            #endif\n            );\n        #endif\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==xl.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\n`,e}serialize(){const e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=this.texture?.gammaSpace??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}(0,ue.Cg)([oa("Spherical Harmonics",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],$f.prototype,"useSphericalHarmonics",void 0),(0,ue.Cg)([oa("Force irradiance in fragment",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],$f.prototype,"forceIrradianceInFragment",void 0),(0,o.Y5)("BABYLON.ReflectionBlock",$f);class jf extends Ml{constructor(e){super(e,xl.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",Sl.Float,!1,xl.Fragment),this.registerInput("roughness",Sl.Float,!0,xl.Fragment),this.registerInput("indexOfRefraction",Sl.Float,!0,xl.Fragment),this.registerInput("normalMapColor",Sl.Color3,!0,xl.Fragment),this.registerInput("uv",Sl.Vector2,!0,xl.Fragment),this.registerInput("tintColor",Sl.Color3,!0,xl.Fragment),this.registerInput("tintAtDistance",Sl.Float,!0,xl.Fragment),this.registerInput("tintThickness",Sl.Float,!0,xl.Fragment),this.registerInput("worldTangent",Sl.Vector4,!0),this.registerInput("worldNormal",Sl.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(Sl.Color4|Sl.Vector4|Sl.Vector3),this.registerInput("TBN",Sl.Object,!0,xl.VertexAndFragment,new Td("TBN",this,0,Hd,"TBNBlock")),this.registerOutput("clearcoat",Sl.Object,xl.Fragment,new Td("clearcoat",this,1,jf,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Bl("ClearCoat intensity",xl.Fragment,Sl.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===Au.t._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){super.bind(e,t,i);const r=this.indexOfRefraction.connectInputBlock?.value??Au.t._DefaultIndexOfRefraction,n=1-r,s=1+r,a=Math.pow(-n/s,2),o=1/r;e.setFloat4("vClearCoatRefractionParams",a,o,n,s);const l=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,c=l?.perturbedNormal.isConnected?l.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",c?.invertX?1:-1,c?.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",c?.invertX?-1:1,c?.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let r="";const n=`//${this.name}`,s=this.worldTangent,a=1===e.shaderLanguage;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:s.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n                ${a?"var TBN":"mat3 TBN"} = ${l.associatedVariableName};\n            #endif\n            `:s.isConnected&&(r+=`${e._declareLocalVar("tbnNormal",Sl.Vector3)} = normalize(${i}.xyz);\n`,r+=`${e._declareLocalVar("tbnTangent",Sl.Vector3)} = normalize(${s.associatedVariableName}.xyz);\n`,r+=`${e._declareLocalVar("tbnBitangent",Sl.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,r+=`${a?"var vTBN":"mat3 vTBN"} = ${a?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);\n`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",n,{replaceStrings:[o]}),r}static GetCode(e,t,i,r,n,s,a){let o="";const l=t?.intensity.isConnected?t.intensity.associatedVariableName:"1.",c=t?.roughness.isConnected?t.roughness.associatedVariableName:"0.",h=t?.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:`vec3${e.fSuffix}(0.)`,u=t?.uv.isConnected?t.uv.associatedVariableName:`vec2${e.fSuffix}(0.)`,d=t?.tintColor.isConnected?t.tintColor.associatedVariableName:`vec3${e.fSuffix}(1.)`,p=t?.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",f=t?.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",m=`vec4${e.fSuffix}(0.)`;if(t){e._emitUniformFromString("vClearCoatRefractionParams",Sl.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",Sl.Vector2);const i=t.worldNormal;o+=`${e._declareLocalVar("vGeometricNormaClearCoatW",Sl.Vector3)} = ${i.isConnected?"normalize("+i.associatedVariableName+".xyz)":"geometricNormalW"};\n`}else o+=`${e._declareLocalVar("vGeometricNormaClearCoatW",Sl.Vector3)} = geometricNormalW;\n`;n&&t&&(o+=t._generateTBNSpace(e,r,a),s=t.worldTangent.isConnected);const _=1===e.shaderLanguage;return o+=`${_?"var clearcoatOut: clearcoatOutParams":"clearcoatOutParams clearcoatOut"};\n\n        #ifdef CLEARCOAT\n            ${e._declareLocalVar("vClearCoatParams",Sl.Vector2)} = vec2${e.fSuffix}(${l}, ${c});\n            ${e._declareLocalVar("vClearCoatTintParams",Sl.Vector4)} = vec4${e.fSuffix}(${d}, ${p});\n\n            clearcoatOut = clearcoatBlock(\n                ${r}.xyz\n                , vGeometricNormaClearCoatW\n                , viewDirectionW\n                , vClearCoatParams\n                , specularEnvironmentR0\n            #ifdef CLEARCOAT_TEXTURE\n                , vec2${e.fSuffix}(0.)\n            #endif\n            #ifdef CLEARCOAT_TINT\n                , vClearCoatTintParams\n                , ${f}\n                , ${_?"uniforms.":""}vClearCoatRefractionParams\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    , ${m}\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                , vec2${e.fSuffix}(0., 1.)\n                , vec4${e.fSuffix}(${h}, 0.)\n                , ${u}\n                #if defined(${s?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    , vTBN\n                #else\n                    , ${_?"uniforms.":""}vClearCoatTangentSpaceParams\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    , normalMatrix\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                , faceNormal\n            #endif\n            #ifdef REFLECTION\n                , ${_?"uniforms.":""}${i?._vReflectionMicrosurfaceInfosName}\n                , ${i?._vReflectionInfosName}\n                , ${i?.reflectionColor}\n                , ${_?"uniforms.":""}vLightingIntensity\n                #ifdef ${i?._define3DName}\n                    , ${i?._cubeSamplerName}       \n                    ${_?`, ${i?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${i?._2DSamplerName}       \n                    ${_?`, ${i?._2DSamplerName}Sampler`:""}\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${i?._define3DName}\n                        , ${i?._cubeSamplerName}       \n                        ${_?`, ${i?._cubeSamplerName}Sampler`:""}\n                        , ${i?._cubeSamplerName}\n                        ${_?`, ${i?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${i?._2DSamplerName}\n                        ${_?`, ${i?._2DSamplerName}Sampler`:""}\n                        , ${i?._2DSamplerName}\n                        ${_?`, ${i?._2DSamplerName}Sampler`:""}                        \n                    #endif\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                , (${e._generateTernary("1.","-1.",_?"fragmentInputs.frontFacing":"gl_FrontFacing")})\n            #endif\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\n`,o}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===xl.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,Sl.Float)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}}(0,ue.Cg)([oa("Remap F0 on interface change",0,"ADVANCED",{embedded:!0})],jf.prototype,"remapF0OnInterfaceChange",void 0),(0,o.Y5)("BABYLON.ClearCoatBlock",jf);class Kf extends Ml{constructor(e){super(e,xl.Fragment),this._isUnique=!0,this.registerInput("intensity",Sl.Float,!0,xl.Fragment),this.registerInput("indexOfRefraction",Sl.Float,!0,xl.Fragment),this.registerInput("thickness",Sl.Float,!0,xl.Fragment),this.registerOutput("iridescence",Sl.Object,xl.Fragment,new Td("iridescence",this,1,Kf,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Bl("Iridescence intensity",xl.Fragment,Sl.Float);e.value=1,e.output.connectTo(this.intensity);const t=new Bl("Iridescence ior",xl.Fragment,Sl.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new Bl("Iridescence thickness",xl.Fragment,Sl.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e,t){let i="";const r=e?.intensity.isConnected?e.intensity.associatedVariableName:"1.",n=e?.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:Ru.z._DefaultIndexOfRefraction,s=e?.thickness.isConnected?e.thickness.associatedVariableName:Ru.z._DefaultMaximumThickness;return i+=`${1===t.shaderLanguage?"var iridescenceOut: iridescenceOutParams":"iridescenceOutParams iridescenceOut"};\n\n        #ifdef IRIDESCENCE\n            iridescenceOut = iridescenceBlock(\n                vec4(${r}, ${n}, 1., ${s})\n                , NdotV\n                , specularEnvironmentR0\n                #ifdef CLEARCOAT\n                    , NdotVUnclamped\n                #endif                \n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\n`,i}_buildBlock(e){return e.target===xl.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}(0,o.Y5)("BABYLON.IridescenceBlock",Kf);class Zf extends Ml{constructor(e){super(e,xl.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",Sl.Float,!1,xl.Fragment),this.registerInput("tintAtDistance",Sl.Float,!0,xl.Fragment),this.registerInput("volumeIndexOfRefraction",Sl.Float,!0,xl.Fragment),this.registerOutput("refraction",Sl.Object,xl.Fragment,new Td("refraction",this,1,Zf,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){const e=new Bl("Refraction intensity",xl.Fragment,Sl.Float);e.value=1,e.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.View&&t(e)));i||(i=new Bl("view"),i.setAsSystemValue(Al.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),n=r&&r.getTextureMatrix;i.setValue("SS_REFRACTION",n,!0),n&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLODRefractionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&r.isCube?!r.invertZ:r.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",r.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",r.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!r.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){super.bind(e,t,i);const r=this._getTexture();if(!r)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),e.setMatrix(this._refractionMatrixName,r.getRefractionTextureMatrix());let n=1;r.isCube||r.depth&&(n=r.depth);const s=this.volumeIndexOfRefraction.connectInputBlock?.value??this.indexOfRefractionConnectionPoint.connectInputBlock?.value??1.5;e.setFloat4(this._vRefractionInfosName,r.level,1/s,n,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset,1/s);const a=r.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,a,Math.log2(a)),r.boundingBoxSize){const t=r;e.setVector3("vRefractionPosition",t.boundingBoxPosition),e.setVector3("vRefractionSize",t.boundingBoxSize)}}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),this._getTexture()&&(e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._emitCubeSampler(this._cubeSamplerName,void 0,!0),e._samplerDeclaration+="#else\n",e._emit2DSampler(this._2DSamplerName,void 0,!0),e._samplerDeclaration+="#endif\n"),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,Sl.Matrix),1!==e.shaderLanguage&&(e._emitFunction("sampleRefraction",`\n                #ifdef ${this._define3DName}\n                    #define sampleRefraction(s, c) textureCube(s, c)\n                #else\n                    #define sampleRefraction(s, c) texture2D(s, c)\n                #endif\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n                #ifdef ${this._define3DName}\n                    #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n                #else\n                    #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n                #endif\n`,`//${this.name}`)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,Sl.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,Sl.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,Sl.Vector2),e._emitUniformFromString("vRefractionPosition",Sl.Vector3),e._emitUniformFromString("vRefractionSize",Sl.Vector3),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=Uo.b.Parse(e.texture,t,i):this.texture=_e.g.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}(0,ue.Cg)([oa("Link refraction to transparency",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Zf.prototype,"linkRefractionWithTransparency",void 0),(0,ue.Cg)([oa("Invert refraction Y",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Zf.prototype,"invertRefractionY",void 0),(0,ue.Cg)([oa("Use thickness as depth",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],Zf.prototype,"useThicknessAsDepth",void 0),(0,o.Y5)("BABYLON.RefractionBlock",Zf);class Qf extends Ml{constructor(e){super(e,xl.Fragment),this._isUnique=!0,this.registerInput("thickness",Sl.Float,!1,xl.Fragment),this.registerInput("tintColor",Sl.Color3,!0,xl.Fragment),this.registerInput("translucencyIntensity",Sl.Float,!0,xl.Fragment),this.registerInput("translucencyDiffusionDist",Sl.Color3,!0,xl.Fragment),this.registerInput("refraction",Sl.Object,!0,xl.Fragment,new Td("refraction",this,0,Zf,"RefractionBlock")),this.registerInput("dispersion",Sl.Float,!0,xl.Fragment),this.registerOutput("subsurface",Sl.Object,xl.Fragment,new Td("subsurface",this,1,Qf,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new Bl("SubSurface thickness",xl.Fragment,Sl.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",r||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",r,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,r){let n="";const s=t?.thickness.isConnected?t.thickness.associatedVariableName:"0.",a=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",o=t?.translucencyIntensity.isConnected?t?.translucencyIntensity.associatedVariableName:"1.",l=t?.translucencyDiffusionDist.isConnected?t?.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",c=t?.refraction.isConnected?t?.refraction.connectedPoint?.ownerBlock:null,h=c?.tintAtDistance.isConnected?c.tintAtDistance.associatedVariableName:"1.",u=c?.intensity.isConnected?c.intensity.associatedVariableName:"1.",d=c?.view.isConnected?c.view.associatedVariableName:"",p=t?.dispersion.isConnected?t?.dispersion.associatedVariableName:"0.0",f=1===e.shaderLanguage;return n+=c?.getCode(e)??"",n+=`${f?"var subSurfaceOut: subSurfaceOutParams":"subSurfaceOutParams subSurfaceOut"};\n\n        #ifdef SUBSURFACE\n            ${e._declareLocalVar("vThicknessParam",Sl.Vector2)} = vec2${e.fSuffix}(0., ${s});\n            ${e._declareLocalVar("vTintColor",Sl.Vector4)} = vec4${e.fSuffix}(${a}, ${h});\n            ${e._declareLocalVar("vSubSurfaceIntensity",Sl.Vector3)} = vec3(${u}, ${o}, 0.);\n            ${e._declareLocalVar("dispersion",Sl.Float)} = ${p};\n            subSurfaceOut = subSurfaceBlock(\n                vSubSurfaceIntensity\n                , vThicknessParam\n                , vTintColor\n                , normalW\n                , specularEnvironmentReflectance\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                , vec4${e.fSuffix}(0.)\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    , ${(f?"uniforms.":"")+i?._reflectionMatrixName}\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            , reflectionOut.irradianceVector\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            , ${i?._cubeSamplerName}\n                            ${f?`, ${i?._cubeSamplerName}Sampler`:""}\n                            , ${i?._vReflectionFilteringInfoName}\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        , irradianceSampler\n                        ${f?", irradianceSamplerSampler":""}\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                , surfaceAlbedo\n            #endif\n            #ifdef SS_REFRACTION\n                , ${r}.xyz\n                , viewDirectionW\n                , ${d}\n                , ${(f?"uniforms.":"")+c?._vRefractionInfosName??""}\n                , ${(f?"uniforms.":"")+c?._refractionMatrixName??""}\n                , ${(f?"uniforms.":"")+c?._vRefractionMicrosurfaceInfosName??""}\n                , ${f?"uniforms.":""}vLightingIntensity\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    , alpha\n                #endif\n                #ifdef ${c?._defineLODRefractionAlpha??"IGNORE"}\n                    , NdotVUnclamped\n                #endif\n                #ifdef ${c?._defineLinearSpecularRefraction??"IGNORE"}\n                    , roughness\n                #endif\n                , alphaG\n                #ifdef ${c?._define3DName??"IGNORE"}\n                    , ${c?._cubeSamplerName??""}\n                    ${f?`, ${c?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${c?._2DSamplerName??""}\n                    ${f?`, ${c?._2DSamplerName}Sampler`:""}\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${c?._define3DName??"IGNORE"}\n                        , ${c?._cubeSamplerName??""}                        \n                        ${f?`, ${c?._cubeSamplerName}Sampler`:""}\n                        , ${c?._cubeSamplerName??""}                        \n                        ${f?`, ${c?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${c?._2DSamplerName??""}\n                        ${f?`, ${c?._2DSamplerName}Sampler`:""}\n                        , ${c?._2DSamplerName??""}\n                        ${f?`, ${c?._2DSamplerName}Sampler`:""}\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    , anisotropicOut\n                #endif\n                #ifdef REALTIME_FILTERING\n                    , ${c?._vRefractionFilteringInfoName??""}\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    , vRefractionPosition\n                    , vRefractionSize\n                #endif\n                #ifdef SS_DISPERSION\n                    , dispersion\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                , ${l}\n                , vTintColor\n                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n                    , vec4${e.fSuffix}(0.)\n                #endif\n            #endif                \n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\n`,n}_buildBlock(e){return e.target===xl.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}(0,o.Y5)("BABYLON.SubSurfaceBlock",Qf);const Jf={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class em extends Ml{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,f.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?xl.Fragment:xl.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?xl.Fragment:xl.Vertex}constructor(e){super(e,xl.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=a.v9.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",Sl.Vector4,!1,xl.Vertex),this.registerInput("worldNormal",Sl.Vector4,!1,xl.Vertex),this.registerInput("view",Sl.Matrix,!1),this.registerInput("cameraPosition",Sl.Vector3,!1,xl.Fragment),this.registerInput("perturbedNormal",Sl.Vector4,!0,xl.Fragment),this.registerInput("baseColor",Sl.Color3,!0,xl.Fragment),this.registerInput("metallic",Sl.Float,!1,xl.Fragment),this.registerInput("roughness",Sl.Float,!1,xl.Fragment),this.registerInput("ambientOcc",Sl.Float,!0,xl.Fragment),this.registerInput("opacity",Sl.Float,!0,xl.Fragment),this.registerInput("indexOfRefraction",Sl.Float,!0,xl.Fragment),this.registerInput("ambientColor",Sl.Color3,!0,xl.Fragment),this.registerInput("reflection",Sl.Object,!0,xl.Fragment,new Td("reflection",this,0,$f,"ReflectionBlock")),this.registerInput("clearcoat",Sl.Object,!0,xl.Fragment,new Td("clearcoat",this,0,jf,"ClearCoatBlock")),this.registerInput("sheen",Sl.Object,!0,xl.Fragment,new Td("sheen",this,0,Yf,"SheenBlock")),this.registerInput("subsurface",Sl.Object,!0,xl.Fragment,new Td("subsurface",this,0,Qf,"SubSurfaceBlock")),this.registerInput("anisotropy",Sl.Object,!0,xl.Fragment,new Td("anisotropy",this,0,qf,"AnisotropyBlock")),this.registerInput("iridescence",Sl.Object,!0,xl.Fragment,new Td("iridescence",this,0,Kf,"IridescenceBlock")),this.registerOutput("ambientClr",Sl.Color3,xl.Fragment),this.registerOutput("diffuseDir",Sl.Color3,xl.Fragment),this.registerOutput("specularDir",Sl.Color3,xl.Fragment),this.registerOutput("clearcoatDir",Sl.Color3,xl.Fragment),this.registerOutput("sheenDir",Sl.Color3,xl.Fragment),this.registerOutput("diffuseInd",Sl.Color3,xl.Fragment),this.registerOutput("specularInd",Sl.Color3,xl.Fragment),this.registerOutput("clearcoatInd",Sl.Color3,xl.Fragment),this.registerOutput("sheenInd",Sl.Color3,xl.Fragment),this.registerOutput("refraction",Sl.Color3,xl.Fragment),this.registerOutput("lighting",Sl.Color3,xl.Fragment),this.registerOutput("shadow",Sl.Float,xl.Fragment),this.registerOutput("alpha",Sl.Float,xl.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,46602)),Promise.resolve().then(i.bind(i,21800))]):await Promise.all([Promise.resolve().then(i.bind(i,78979)),Promise.resolve().then(i.bind(i,85773))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.CameraPosition&&t(e)));i||(i=new Bl("cameraPosition"),i.setAsSystemValue(Al.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Al.View&&t(e)));i||(i=new Bl("view"),i.setAsSystemValue(Al.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Pu.d.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Pu.d.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const r=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",r.indexOf(".")<0?r+".":r,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const n=e.getScene();if(n.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&Ho.h.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,qo.lo)(n,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,qo.az)(n,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,(0,qo.VO)(n,i)}updateUniformsAndSamples(e,t,i,r){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const t=e.uniforms.indexOf("vLightData"+n)>=0;(0,qo.GD)(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],r,t)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?(0,qo.Kd)(this.light,this._lightId,r,e,!0):(0,qo.RL)(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const n=this._scene.ambientColor;n&&e.setColor3("ambientFromScene",n);const s=r.useRightHandedSystem===(null!=r._mirroredCameraPosition);e.setFloat(this._invertNormalName,s?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const o=this.indexOfRefraction.connectInputBlock?.value??1.5,l=Math.pow((o-1)/(o+1),2);this._metallicReflectanceColor.scaleToRef(l*this._metallicF0Factor,a.IG.Color3[0]);const c=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,a.IG.Color3[0],c),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){const t=this.worldPosition,i=this.worldNormal,r=`//${this.name}`,n=1===e.shaderLanguage;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,Sl.Vector4)&&(e.compilationString+=(n?"vertexOutputs.":"")+`${s} = ${t.associatedVariableName};\n`);const a="v_"+i.associatedVariableName;e._emitVaryingFromString(a,Sl.Vector4)&&(e.compilationString+=(n?"vertexOutputs.":"")+`${a} = ${i.associatedVariableName};\n`);const o=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=o?.handleVertexSide(e)??"",e._emitVaryingFromString("vClipSpacePosition",Sl.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\n",e._injectAtEnd+=(n?"vertexOutputs.":"")+`vClipSpacePosition = ${n?"vertexOutputs.position":"gl_Position"};\n`,e._injectAtEnd+="#endif\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",Sl.Vector4)} = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",Sl.Matrix)} = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(e){let t=1===e.shaderLanguage?"var albedoOpacityOut: albedoOpacityOutParams;\n":"albedoOpacityOutParams albedoOpacityOut;\n";const i=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",r=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return t+=`albedoOpacityOut = albedoOpacityBlock(\n                vec4${e.fSuffix}(${i}, 1.)\n            #ifdef ALBEDO\n                ,vec4${e.fSuffix}(1.)\n                ,vec2${e.fSuffix}(1., 1.)\n            #endif\n            #ifdef OPACITY\n                ,vec4${e.fSuffix}(${r})\n                ,vec2${e.fSuffix}(1., 1.)\n            #endif                \n            );\n\n            ${e._declareLocalVar("surfaceAlbedo",Sl.Vector3)} = albedoOpacityOut.surfaceAlbedo;\n            ${e._declareLocalVar("alpha",Sl.Float)} = albedoOpacityOut.alpha;\n`,t}_getAmbientOcclusionCode(e){let t=1===e.shaderLanguage?"var aoOut: ambientOcclusionOutParams;\n":"ambientOcclusionOutParams aoOut;\n";const i=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return t+=`aoOut = ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3${e.fSuffix}(${i}),\n                vec4${e.fSuffix}(0., 1.0, 1.0, 0.)\n            #endif\n            );\n`,t}_getReflectivityCode(e){const t=1===e.shaderLanguage;let i=t?"var reflectivityOut: reflectivityOutParams;\n":"reflectivityOutParams reflectivityOut;\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,Sl.Vector4),i+=`${e._declareLocalVar("baseColor",Sl.Vector3)} = surfaceAlbedo;\n\n            reflectivityOut = reflectivityBlock(\n                vec4${e.fSuffix}(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.)\n            #ifdef METALLICWORKFLOW\n                , surfaceAlbedo\n                , ${(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}\n            #endif\n            #ifdef REFLECTIVITY\n                , vec3${e.fSuffix}(0., 0., 1.)\n                , vec4${e.fSuffix}(1.)\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                , aoOut.ambientOcclusionColor\n            #endif\n            #ifdef MICROSURFACEMAP\n                , microSurfaceTexel <== not handled!\n            #endif\n            );\n\n            ${e._declareLocalVar("microSurface",Sl.Float)} = reflectivityOut.microSurface;\n            ${e._declareLocalVar("roughness",Sl.Float)} = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\n`,i}_buildBlock(e){super._buildBlock(e),this._scene=e.sharedData.scene;const t=1===e.shaderLanguage;this._environmentBRDFTexture||(this._environmentBRDFTexture=(0,Xf.X)(this._scene));const i=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;if(i&&(i.worldPositionConnectionPoint=this.worldPosition,i.cameraPositionConnectionPoint=this.cameraPosition,i.worldNormalConnectionPoint=this.worldNormal,i.viewConnectionPoint=this.view),e.target!==xl.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const r=`//${this.name}`,n=this.perturbedNormal;let s=this.worldPosition.associatedVariableName,a=this.worldNormal.associatedVariableName;this.generateOnlyFragmentCode?(s=e._getFreeVariableName("globalWorldPos"),e.compilationString+=`${s} = ${this.worldPosition.associatedVariableName}.xyz;\n`,a=e._getFreeVariableName("globalWorldNormal"),e.compilationString+=`${a} = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\n",e.compilationString+=`${e._declareLocalVar("vClipSpacePosition",Sl.Vector4)} = vec4${e.fSuffix}((vec2${e.fSuffix}(${t?"fragmentInputs.position":"gl_FragCoord.xy"}) / vec2${e.fSuffix}(1.0)) * 2.0 - 1.0, 0.0, 1.0);\n`,e.compilationString+="#endif\n"):(s=(t?"input.":"")+"v_"+s,a=(t?"input.":"")+"v_"+a),this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",Sl.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",Sl.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("importanceSampling",r),e._emitFunctionFromInclude("pbrHelperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),e._emitFunctionFromInclude("shadowsFragmentFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",r),e._emitFunctionFromInclude("pbrBRDFFunctions",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFunctions",r),e._emitFunctionFromInclude("pbrIBLFunctions",r),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",r),e._emitFunctionFromInclude("pbrBlockReflectivity",r),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",r),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",r),e._emitFunctionFromInclude("pbrBlockAnisotropic",r),e._emitUniformFromString("vLightingIntensity",Sl.Vector4),i?.generateOnlyFragmentCode&&(e.compilationString+=i.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`${e._declareLocalVar(this._vNormalWName,Sl.Vector4)} = normalize(${a});\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",Sl.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${s}.xyz);\n`),e.compilationString+=`${e._declareLocalVar("geometricNormalW",Sl.Vector3)} = ${this._vNormalWName}.xyz;\n`,e.compilationString+=`${e._declareLocalVar("normalW",Sl.Vector3)} = ${n.isConnected?"normalize("+n.associatedVariableName+".xyz)":"geometricNormalW"};\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,Sl.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",r,{replaceStrings:[{search:/vPositionW/g,replace:s+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(e),e.compilationString+=e._emitCodeFromInclude("depthPrePass",r),e.compilationString+=this._getAmbientOcclusionCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",r),e.compilationString+=`#ifdef UNLIT\n                ${e._declareLocalVar("diffuseBase",Sl.Vector3)} = vec3${e.fSuffix}(1., 1., 1.);\n            #else\n`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});const o=this.anisotropy.isConnected?this.anisotropy.connectedPoint?.ownerBlock:null;o&&(o.worldPositionConnectionPoint=this.worldPosition,o.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=o.getCode(e,!this.perturbedNormal.isConnected)),i&&i.hasTexture&&(e.compilationString+=i.getCode(e,o?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:i?._vReflectionFilteringInfoName??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",r,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}]});const l=this.sheen.isConnected?this.sheen.connectedPoint?.ownerBlock:null;l&&(e.compilationString+=l.getCode(i,e)),e._emitFunctionFromInclude("pbrBlockSheen",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"}]});const c=this.iridescence.isConnected?this.iridescence.connectedPoint?.ownerBlock:null;e.compilationString+=Kf.GetCode(c,e),e._emitFunctionFromInclude("pbrBlockIridescence",r,{replaceStrings:[]});const h=this.clearcoat.isConnected?this.clearcoat.connectedPoint?.ownerBlock:null,u=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,d=this.perturbedNormal.isConnected&&(this.perturbedNormal.connectedPoint?.ownerBlock).worldTangent?.isConnected,p=this.anisotropy.isConnected&&(this.anisotropy.connectedPoint?.ownerBlock).worldTangent.isConnected;let m=d||!this.perturbedNormal.isConnected&&p;e.compilationString+=jf.GetCode(e,h,i,s,u,m,a),u&&(m=h?.worldTangent.isConnected??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:m?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});const _=this.subsurface.isConnected?this.subsurface.connectedPoint?.ownerBlock:null,g=this.subsurface.isConnected?(this.subsurface.connectedPoint?.ownerBlock).refraction.connectedPoint?.ownerBlock:null;g&&(g.viewConnectionPoint=this.view,g.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Qf.GetCode(e,_,i,s),e._emitFunctionFromInclude("pbrBlockSubSurface",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:g?._define3DName??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:g?._defineLODRefractionAlpha??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:g?._defineLinearSpecularRefraction??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:g?._defineOppositeZ??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",r),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:new RegExp((t?"fragmentInputs.":"")+"vPositionW","g"),replace:s+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`${t?"fragmentInputs.":""}vPositionW,${s}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",r),e.compilationString+="#endif\n";const v=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:`vec3${e.fSuffix}(0., 0., 0.)`;let S=Pu.d.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===S.indexOf(".")&&(S+=".");let x=[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:new RegExp((t?"uniforms.":"")+"vAmbientColor","g"),replace:v+` * ${t?"uniforms.":""}ambientFromScene`},{search:new RegExp((t?"uniforms.":"")+"vAmbientInfos.w","g"),replace:S}];t&&(x[0]={search:/var finalEmissive[\s\S]*?finalEmissive\*=uniforms.vLightingIntensity\.y;/g,replace:""}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",r,{replaceStrings:x}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",r,{replaceStrings:[{search:/finalEmissive/g,replace:`vec3${e.fSuffix}(0.)`}]}),x=t?[{search:/mesh.visibility/g,replace:"1."}]:[{search:/visibility/g,replace:"1."}],e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",r,{replaceStrings:x});const T=t?"fragmentOutputs.color":"gl_FragColor";x=[{search:new RegExp((t?"fragmentInputs.":"")+"vNormalW","g"),replace:this._vNormalWName},{search:new RegExp((t?"fragmentInputs.":"")+"vPositionW","g"),replace:s},{search:/albedoTexture\.rgb;/g,replace:`vec3${e.fSuffix}(1.);\n${T}.rgb = toGammaSpace(${T}.rgb);\n`}],e.compilationString+=e._emitCodeFromInclude("pbrDebug",r,{replaceStrings:x});for(const t of this._outputs)if(t.hasEndpoints){const i=Jf[t.name];if(i){const[r,n]=i;n&&(e.compilationString+=`#if ${n}\n`),e.compilationString+=`${e._declareOutput(t)} = ${r};\n`,n&&(e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(t)} = vec3${e.fSuffix}(0.);\n`,e.compilationString+="#endif\n")}else f.V.Error(`There's no remapping for the ${t.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}(0,ue.Cg)([oa("Direct lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],em.prototype,"directIntensity",void 0),(0,ue.Cg)([oa("Environment lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],em.prototype,"environmentIntensity",void 0),(0,ue.Cg)([oa("Specular highlights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],em.prototype,"specularIntensity",void 0),(0,ue.Cg)([oa("Light falloff",4,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Pu.d.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Pu.d.LIGHTFALLOFF_GLTF},{label:"Standard",value:Pu.d.LIGHTFALLOFF_STANDARD}]})],em.prototype,"lightFalloff",void 0),(0,ue.Cg)([oa("Alpha Testing",0,"OPACITY")],em.prototype,"useAlphaTest",void 0),(0,ue.Cg)([oa("Alpha CutOff",1,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],em.prototype,"alphaTestCutoff",void 0),(0,ue.Cg)([oa("Alpha blending",0,"OPACITY")],em.prototype,"useAlphaBlending",void 0),(0,ue.Cg)([oa("Radiance over alpha",0,"RENDERING",{notifiers:{update:!0}})],em.prototype,"useRadianceOverAlpha",void 0),(0,ue.Cg)([oa("Specular over alpha",0,"RENDERING",{notifiers:{update:!0}})],em.prototype,"useSpecularOverAlpha",void 0),(0,ue.Cg)([oa("Specular anti-aliasing",0,"RENDERING",{notifiers:{update:!0}})],em.prototype,"enableSpecularAntiAliasing",void 0),(0,ue.Cg)([oa("Realtime filtering",0,"RENDERING",{notifiers:{update:!0}})],em.prototype,"realTimeFiltering",void 0),(0,ue.Cg)([oa("Realtime filtering quality",4,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],em.prototype,"realTimeFilteringQuality",void 0),(0,ue.Cg)([oa("Energy Conservation",0,"ADVANCED",{notifiers:{update:!0}})],em.prototype,"useEnergyConservation",void 0),(0,ue.Cg)([oa("Radiance occlusion",0,"ADVANCED",{notifiers:{update:!0}})],em.prototype,"useRadianceOcclusion",void 0),(0,ue.Cg)([oa("Horizon occlusion",0,"ADVANCED",{notifiers:{update:!0}})],em.prototype,"useHorizonOcclusion",void 0),(0,ue.Cg)([oa("Unlit",0,"ADVANCED",{notifiers:{update:!0}})],em.prototype,"unlit",void 0),(0,ue.Cg)([oa("Force normal forward",0,"ADVANCED",{notifiers:{update:!0}})],em.prototype,"forceNormalForward",void 0),(0,ue.Cg)([oa("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:em._OnGenerateOnlyFragmentCodeChanged}})],em.prototype,"generateOnlyFragmentCode",void 0),(0,ue.Cg)([oa("Debug mode",4,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],em.prototype,"debugMode",void 0),(0,ue.Cg)([oa("Split position",1,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],em.prototype,"debugLimit",void 0),(0,ue.Cg)([oa("Output factor",1,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],em.prototype,"debugFactor",void 0),(0,o.Y5)("BABYLON.PBRMetallicRoughnessBlock",em);class tm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("left",Sl.AutoDetect),this.registerInput("right",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(Sl.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return 0===e.shaderLanguage?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.ModBlock",tm);class im extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("row0",Sl.Vector4),this.registerInput("row1",Sl.Vector4),this.registerInput("row2",Sl.Vector4),this.registerInput("row3",Sl.Vector4),this.registerOutput("output",Sl.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new Bl("row0");e.value=new s.IU(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new Bl("row1");e.value=new s.IU(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new Bl("row2");e.value=new s.IU(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new Bl("row3");e.value=new s.IU(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,r=this.row1,n=this.row2,s=this.row3,a=1===e.shaderLanguage?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${a}(${i.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName}, ${s.associatedVariableName});\n`,this}}var rm,nm,sm;(0,o.Y5)("BABYLON.MatrixBuilder",im),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(rm||(rm={}));class am extends Ml{constructor(e){super(e,xl.Neutral),this.condition=rm.LessThan,this.registerInput("a",Sl.Float),this.registerInput("b",Sl.Float),this.registerInput("true",Sl.AutoDetect,!0),this.registerInput("false",Sl.AutoDetect,!0),this.registerOutput("output",Sl.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=Sl.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.true.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&1===e.value&&"True"===e.name))||new Bl("True");t.value=1,t.output.connectTo(this.true)}if(!this.false.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&0===e.value&&"False"===e.name))||new Bl("False");t.value=0,t.output.connectTo(this.false)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case rm.Equal:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};\n`;break;case rm.NotEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};\n`;break;case rm.LessThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};\n`;break;case rm.LessOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};\n`;break;case rm.GreaterThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};\n`;break;case rm.GreaterOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};\n`;break;case rm.Xor:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};\n`;break;case rm.Or:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};\n`;break;case rm.And:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${rm[this.condition]};\n`}}(0,ue.Cg)([oa("Condition",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:rm.Equal},{label:"NotEqual",value:rm.NotEqual},{label:"LessThan",value:rm.LessThan},{label:"GreaterThan",value:rm.GreaterThan},{label:"LessOrEqual",value:rm.LessOrEqual},{label:"GreaterOrEqual",value:rm.GreaterOrEqual},{label:"Xor",value:rm.Xor},{label:"And",value:rm.And},{label:"Or",value:rm.Or}]})],am.prototype,"condition",void 0),(0,o.Y5)("BABYLON.ConditionalBlock",am);class om extends Ml{constructor(e){super(e,xl.Neutral),this.octaves=6,this.registerInput("seed",Sl.AutoDetect),this.registerInput("chaos",Sl.AutoDetect,!0),this.registerInput("offsetX",Sl.Float,!0),this.registerInput("offsetY",Sl.Float,!0),this.registerInput("offsetZ",Sl.Float,!0),this.registerOutput("output",Sl.Float),this._inputs[0].acceptedConnectionPointTypes.push(Sl.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(Sl.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="\n\n        float cloudRandom(float p) { \n            float temp = fract(p * 0.011); \n            temp *= temp + 7.5; \n            temp *= temp + temp; \n            return fract(temp); \n        }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise2(vec2 x, vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise3(vec3 x, vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }",i="\n        float fbm2(vec2 st, vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            vec2 tempST = st;\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise2(tempST, chaos);\n                tempST *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm3(vec3 x, vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            vec3 tempX = x;\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise3(tempX, chaos);\n                tempX = tempX * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }";1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));const r=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,r).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const n=e._getFreeVariableName("st"),s=this.seed.connectedPoint?.type||Sl.Vector3;e.compilationString+=`${e._declareLocalVar(n,s)} = ${this.seed.associatedVariableName};\n`,this.offsetX.isConnected&&(e.compilationString+=`${n}.x += 0.1 * ${this.offsetX.associatedVariableName};\n`),this.offsetY.isConnected&&(e.compilationString+=`${n}.y += 0.1 * ${this.offsetY.associatedVariableName};\n`),this.offsetZ.isConnected&&s===Sl.Vector3&&(e.compilationString+=`${n}.z += 0.1 * ${this.offsetZ.associatedVariableName};\n`);let a="";if(this.chaos.isConnected)a=this.chaos.associatedVariableName;else{const t=e.fSuffix;a=this.seed.connectedPoint?.type===Sl.Vector2?`vec2${t}(0., 0.)`:`vec3${t}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${r}${this.seed.connectedPoint?.type===Sl.Vector2?"2":"3"}(${n}, ${a});\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}(0,ue.Cg)([oa("Octaves",2,void 0,{embedded:!0})],om.prototype,"octaves",void 0),(0,o.Y5)("BABYLON.CloudBlock",om);class lm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("seed",Sl.Vector2),this.registerInput("offset",Sl.Float),this.registerInput("density",Sl.Float),this.registerOutput("output",Sl.Float),this.registerOutput("cells",Sl.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 p){\n            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));\n            return fract(sin(p)*18.5453);\n        }\n        ";1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 n = floor(seed * density);\n            vec2 f = fract(seed * density);\n            vec3 m = vec3( 8.0 );\n            for( int j=-1; j<=1; j++ ){\n                for( int i=-1; i<=1; i++ ){\n                    vec2  g = vec2( float(i), float(j) );\n                    vec2  o = voronoiRandom( n + g);\n                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));\n                    float d = dot( r, r );\n                    if( d<m.x ){\n                        m = vec3( d, o );\n                        outValue = m.x;\n                        cells = m.y;\n                    }\n                }\n\t\t\t}\n        }\n        ",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells"),n=1===e.shaderLanguage?"&":"";return e.compilationString+=`${e._declareLocalVar(i,Sl.Float)} = 0.0;\n`,e.compilationString+=`${e._declareLocalVar(r,Sl.Float)} = 0.0;\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${n}${i}, ${n}${r});\n`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};\n`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${r};\n`),this}}(0,o.Y5)("BABYLON.VoronoiNoiseBlock",lm);class cm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==xl.VertexAndFragment)return t.target;if(e.connectedPoint.target!==xl.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.ElbowBlock",cm);class hm extends Ml{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=e?.getScene()??P.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get textureY(){return this.sourceY.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}get textureZ(){return this.sourceZ?.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){return this._getImageSourceBlock(this.sourceY)?.samplerName??null}get samplerZName(){return this._getImageSourceBlock(this.sourceZ)?.samplerName??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=this.texture.getScene()??P.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=this.texture.getScene()??P.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,xl.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",Sl.AutoDetect,!1),this.registerInput("normal",Sl.AutoDetect,!1),this.registerInput("sharpness",Sl.Float,!0),this.registerInput("source",Sl.Object,!0,xl.VertexAndFragment,new Td("source",this,0,Cp,"ImageSourceBlock")),this.registerInput("sourceY",Sl.Object,!0,xl.VertexAndFragment,new Td("sourceY",this,0,Cp,"ImageSourceBlock")),t||this.registerInput("sourceZ",Sl.Object,!0,xl.VertexAndFragment,new Td("sourceZ",this,0,Cp,"ImageSourceBlock")),this.registerOutput("rgba",Sl.Color4,xl.Neutral),this.registerOutput("rgb",Sl.Color3,xl.Neutral),this.registerOutput("r",Sl.Float,xl.Neutral),this.registerOutput("g",Sl.Float,xl.Neutral),this.registerOutput("b",Sl.Float,xl.Neutral),this.registerOutput("a",Sl.Float,xl.Neutral),this.registerOutput("level",Sl.Float,xl.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Sl.Color3|Sl.Vector3|Sl.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,n,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return 1===e.shaderLanguage?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return 1===i.shaderLanguage?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",s=e._getFreeVariableName("x"),a=e._getFreeVariableName("y"),o=e._getFreeVariableName("z"),l=e._getFreeVariableName("w"),c=e._getFreeVariableName("n"),h=e._getFreeVariableName("uvx"),u=e._getFreeVariableName("uvy"),d=e._getFreeVariableName("uvz");e.compilationString+=`\n            ${e._declareLocalVar(c,Sl.Vector3)} = ${this.normal.associatedVariableName}.xyz;\n\n            ${e._declareLocalVar(h,Sl.Vector2)} = ${this.position.associatedVariableName}.yz;\n            ${e._declareLocalVar(u,Sl.Vector2)} = ${this.position.associatedVariableName}.zx;\n            ${e._declareLocalVar(d,Sl.Vector2)} = ${this.position.associatedVariableName}.xy;\n        `,this.projectAsCube&&(e.compilationString+=`\n                ${h}.xy = ${h}.yx;\n\n                if (${c}.x >= 0.0) {\n                    ${h}.x = -${h}.x;\n                }\n                if (${c}.y < 0.0) {\n                    ${u}.y = -${u}.y;\n                }\n                if (${c}.z < 0.0) {\n                    ${d}.x = -${d}.x;\n                }\n            `);const p=e.fSuffix;e.compilationString+=`\n            ${e._declareLocalVar(s,Sl.Vector4)} = ${this._generateTextureSample(t,h,e)};\n            ${e._declareLocalVar(a,Sl.Vector4)} = ${this._generateTextureSample(i,u,e)};\n            ${e._declareLocalVar(o,Sl.Vector4)} = ${this._generateTextureSample(r,d,e)};\n           \n            // blend weights\n            ${e._declareLocalVar(l,Sl.Vector3)} = pow(abs(${c}), vec3${p}(${n}));\n\n            // blend and return\n            ${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = (${s}*${l}.x + ${a}*${l}.y + ${o}*${l}.z) / (${l}.x + ${l}.y + ${l}.z);        \n        `}_generateConversionCode(e,t,i){let r="";1!==e.shaderLanguage||t.type!==Sl.Vector3&&t.type!==Sl.Color3||(r="Vec3"),"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${1===e.shaderLanguage?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,Sl.Float),this._generateTextureLookup(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!sc.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=_e.g.Parse(e.texture,t,i))}}(0,ue.Cg)([oa("Project as cube",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],hm.prototype,"projectAsCube",void 0),(0,o.Y5)("BABYLON.TriPlanarBlock",hm);class um extends hm{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return 1===t.shaderLanguage?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return 1===e.shaderLanguage?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("dxValue"),s=e._getFreeVariableName("dyValue"),a=e._getFreeVariableName("n"),o=e._getFreeVariableName("ma"),l=e._getFreeVariableName("mi"),c=e._getFreeVariableName("me"),h=e._getFreeVariableName("x"),u=e._getFreeVariableName("y"),d=e._getFreeVariableName("w");let p="ivec3",f="dFdx",m="dFdy";const _=e.fSuffix;1===e.shaderLanguage&&(p="vec3<i32>",f="dpdx",m="dpdy"),e.compilationString+=`\n            // grab coord derivatives for texturing\n            ${e._declareLocalVar(n,Sl.Vector3)} = ${f}(${this.position.associatedVariableName}.xyz);\n            ${e._declareLocalVar(s,Sl.Vector3)} = ${m}(${this.position.associatedVariableName}.xyz);\n            ${e._declareLocalVar(a,Sl.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ${this._declareLocalVarAsVec3I(o,e)} = ${e._generateTernary(`${p}(0,1,2)`,`${e._generateTernary(`${p}(1,2,0)`,`${p}(2,0,1)`,`(${a}.y>${a}.z)`)}`,`(${a}.x>${a}.y && ${a}.x>${a}.z)`)};                    \n\n            // determine minor axis (in x; yz are following axis)\n            ${this._declareLocalVarAsVec3I(l,e)} =  ${e._generateTernary(`${p}(0,1,2)`,`${e._generateTernary(`${p}(1,2,0)`,`${p}(2,0,1)`,`(${a}.y<${a}.z)`)}`,`(${a}.x<${a}.y && ${a}.x<${a}.z)`)};  \n                              \n            // determine median axis (in x;  yz are following axis)\n            ${this._declareLocalVarAsVec3I(c,e)} = ${p}(3) - ${l} - ${o};\n            \n            // project+fetch\n            ${e._declareLocalVar(h,Sl.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${_}(${this.position.associatedVariableName}[${o}.y], ${this.position.associatedVariableName}[${o}.z]), \n                                    vec2${_}(${n}[${o}.y],${n}[${o}.z]), \n                                    vec2${_}(${s}[${o}.y],${s}[${o}.z]));\n            ${e._declareLocalVar(u,Sl.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${_}(${this.position.associatedVariableName}[${c}.y], ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2${_}(${n}[${c}.y],${n}[${c}.z]),\n                                    vec2${_}(${s}[${c}.y],${s}[${c}.z]));\n            \n            // blend factors\n            ${e._declareLocalVar(d,Sl.Vector2)} = vec2${_}(${a}[${o}.x],${a}[${c}.x]);\n            // make local support\n            ${d} = clamp( (${d}-0.5773)/(1.0-0.5773), vec2${_}(0.0), vec2${_}(1.0) );\n            // shape transition\n            ${d} = pow( ${d}, vec2${_}(${r}/8.0) );\n            // blend and return\n            ${e._declareLocalVar(this._tempTextureRead,Sl.Vector4)} = (${h}*${d}.x + ${u}*${d}.y) / (${d}.x + ${d}.y);\n        `}}(0,o.Y5)("BABYLON.BiPlanarBlock",um);class dm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.Matrix),this.registerOutput("output",Sl.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.MatrixDeterminantBlock",dm);class pm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.Matrix),this.registerOutput("output",Sl.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});\n`,this}}(0,o.Y5)("BABYLON.MatrixTransposeBlock",pm),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Tangent=2]="Tangent",e[e.VertexColor=3]="VertexColor",e[e.UV1=4]="UV1",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6"}(nm||(nm={}));class fm extends Ml{constructor(e){super(e,xl.Neutral),this.attributeType=0,this.registerInput("input",Sl.AutoDetect),this.registerInput("fallback",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add((e=>{if(this.attributeType)return;const t=e.ownerBlock;if(t instanceof Bl&&t.isAttribute)switch(t.name){case"color":this.attributeType=3;break;case"normal":this.attributeType=1;break;case"tangent":this.attributeType=2;break;case"uv":this.attributeType=4;break;case"uv2":this.attributeType=5;break;case"uv3":this.attributeType=6;break;case"uv4":this.attributeType=7;break;case"uv5":this.attributeType=8;break;case"uv6":this.attributeType=9}else if(t instanceof Id)switch(this.input.connectedPoint?.name){case"normalOutput":this.attributeType=1;break;case"tangentOutput":this.attributeType=2;break;case"uvOutput":this.attributeType=4}}))}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case 3:t="VERTEXCOLOR_NME";break;case 1:t="NORMAL";break;case 2:t="TANGENT";break;case 4:t="UV1";break;case 5:t="UV2";break;case 6:t="UV3";break;case 7:t="UV4";break;case 8:t="UV5";break;case 9:t="UV6"}const i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}\n`),e.compilationString+=`${i} = ${this.input.associatedVariableName};\n`,t&&(e.compilationString+="#else\n",e.compilationString+=`${i} = ${this.fallback.associatedVariableName};\n`,e.compilationString+="#endif\n"),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??0}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};\n`,e}}(0,ue.Cg)([oa("Attribute lookup",4,void 0,{notifiers:{update:!0},embedded:!0,options:[{label:"(None)",value:0},{label:"Normal",value:1},{label:"Tangent",value:2},{label:"Vertex Color",value:3},{label:"UV1",value:4},{label:"UV2",value:5},{label:"UV3",value:6},{label:"UV4",value:7},{label:"UV5",value:8},{label:"UV6",value:9}]})],fm.prototype,"attributeType",void 0),(0,o.Y5)("BABYLON.MeshAttributeExistsBlock",fm),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(sm||(sm={}));class mm extends Ml{constructor(e){super(e,xl.Neutral),this.type=sm.EaseInOutSine,this.registerInput("input",Sl.AutoDetect),this.registerOutput("output",Sl.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Sl.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Sl.Object),this._inputs[0].excludedConnectionPointTypes.push(Sl.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if("float"===t||"f32"===t)return this._duplicateEntryDirect(e);const r=parseInt(t.replace("vec",""));let n=i?`\n            var ret: vec${r}f = vec${r}f(0.0);\n        `:`\n            vec${r} ret = vec${r}(0.0);\n        `;for(let t=1;t<=r;t++)n+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return n+="return ret;\n",n}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",r="";const n=e._getShaderType(this.input.type),s=1===e.shaderLanguage;switch(r=sm[this.type]+"_"+n.replace("<","").replace(">",""),this.type){case sm.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case sm.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case sm.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case sm.EaseInQuad:i="return v * v";break;case sm.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case sm.EaseInOutQuad:{const t=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,n,s);break}case sm.EaseInCubic:i="return v * v * v";break;case sm.EaseOutCubic:{const e="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(e,n,s);break}case sm.EaseInOutCubic:{const t=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,n,s);break}case sm.EaseInQuart:i="return v * v * v * v";break;case sm.EaseOutQuart:{const e="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(e,n,s);break}case sm.EaseInOutQuart:{const t=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,n,s);break}case sm.EaseInQuint:i="return v * v * v * v * v";break;case sm.EaseOutQuint:{const e="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(e,n,s);break}case sm.EaseInOutQuint:{const t=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,n,s);break}case sm.EaseInExpo:{const t=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(t,n,s);break}case sm.EaseOutExpo:{const t=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(t,n,s);break}case sm.EaseInOutExpo:{const t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,n,s);break}case sm.EaseInCirc:{const e="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(e,n,s);break}case sm.EaseOutCirc:{const e="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(e,n,s);break}case sm.EaseInOutCirc:{const t=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,n,s);break}case sm.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case sm.EaseOutBack:{const e="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(e,n,s);break}case sm.EaseInOutBack:{const t=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,n,s);break}case sm.EaseInElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,n,s);break}case sm.EaseOutElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,n,s);break}case sm.EaseInOutElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,n,s);break}}return s?e._emitFunction(r,`fn ${r}(v: ${n}) -> ${n}  {${i};}\n`,""):e._emitFunction(r,`${n} ${r}(${n} v) {${i};}\n`,""),e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${sm[this.type]};\n`}}(0,ue.Cg)([oa("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:sm.EaseInSine},{label:"EaseOutSine",value:sm.EaseOutSine},{label:"EaseInOutSine",value:sm.EaseInOutSine},{label:"EaseInQuad",value:sm.EaseInQuad},{label:"EaseOutQuad",value:sm.EaseOutQuad},{label:"EaseInOutQuad",value:sm.EaseInOutQuad},{label:"EaseInCubic",value:sm.EaseInCubic},{label:"EaseOutCubic",value:sm.EaseOutCubic},{label:"EaseInOutCubic",value:sm.EaseInOutCubic},{label:"EaseInQuart",value:sm.EaseInQuart},{label:"EaseOutQuart",value:sm.EaseOutQuart},{label:"EaseInOutQuart",value:sm.EaseInOutQuart},{label:"EaseInQuint",value:sm.EaseInQuint},{label:"EaseOutQuint",value:sm.EaseOutQuint},{label:"EaseInOutQuint",value:sm.EaseInOutQuint},{label:"EaseInExpo",value:sm.EaseInExpo},{label:"EaseOutExpo",value:sm.EaseOutExpo},{label:"EaseInOutExpo",value:sm.EaseInOutExpo},{label:"EaseInCirc",value:sm.EaseInCirc},{label:"EaseOutCirc",value:sm.EaseOutCirc},{label:"EaseInOutCirc",value:sm.EaseInOutCirc},{label:"EaseInBack",value:sm.EaseInBack},{label:"EaseOutBack",value:sm.EaseOutBack},{label:"EaseInOutBack",value:sm.EaseInOutBack},{label:"EaseInElastic",value:sm.EaseInElastic},{label:"EaseOutElastic",value:sm.EaseOutElastic},{label:"EaseInOutElastic",value:sm.EaseInOutElastic}]})],mm.prototype,"type",void 0),(0,o.Y5)("BABYLON.CurveBlock",mm);class _m extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("rgb ",Sl.Color3,!0),this.registerInput("hsl ",Sl.Color3,!0),this.registerOutput("rgb",Sl.Color3),this.registerOutput("hsl",Sl.Color3)}getClassName(){return"ColorConverterBlock"}get rgbIn(){return this._inputs[0]}get hslIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get hslOut(){return this._outputs[1]}_inputRename(e){return"rgb "===e?"rgbIn":"hsl "===e?"hslIn":e}_buildBlock(e){super._buildBlock(e);const t=this.rgbIn,i=this.hslIn,r=this._outputs[0],n=this._outputs[1],s=e._getShaderType(Sl.Vector3);let a="\n            vec3 rgb2hsl(vec3 color) {\n                float r = color.r;\n                float g = color.g;\n                float b = color.b;\n\n                float maxc = max(r, max(g, b));\n                float minc = min(r, min(g, b));\n                float h = 0.0;\n                float s = 0.0;\n                float l = (maxc + minc) / 2.0;\n\n                if (maxc != minc) {\n                    float d = maxc - minc;\n                    if (l > 0.5) {\n                        s = d / (2.0 - maxc - minc);\n                    } else {\n                        s = d / (maxc + minc);\n                    }\n\n                    if (maxc == r) {\n                        float add = 0.0;\n                        if (g < b) {\n                            add = 6.0;\n                        }\n                        h = (g - b) / d + add;\n                    } else if (maxc == g) {\n                        h = (b - r) / d + 2.0;\n                    } else if (maxc == b) {\n                        h = (r - g) / d + 4.0;\n                    }\n                    h /= 6.0;\n                }\n\n                return vec3(h, s, l);\n            }",o="\n            float hue2rgb(float p, float q, float tt) {\n                float t = tt;\n                if (t < 0.0) {\n                    t += 1.0;\n                }\n                if (t > 1.0) {\n                    t -= 1.0;\n                }\n                if (t < 1.0/6.0) {\n                    return p + (q - p) * 6.0 * t;\n                }\n                if (t < 1.0/2.0) {\n                    return q;\n                }\n                if (t < 2.0/3.0) {\n                    return p + (q - p) * (2.0/3.0 - t) * 6.0;\n                }\n                return p;\n            }",l="\n            vec3 hsl2rgb(vec3 hsl) {\n                float h = hsl.x;\n                float s = hsl.y;\n                float l = hsl.z;\n\n                float r;\n                float g;\n                float b;\n\n                if (s == 0.0) {\n                    // Achromatic (grey)\n                    r = l;\n                    g = l;\n                    b = l; \n                } else {\n                    float q;\n                \n                    if (l < 0.5) {\n                        q = l * (1.0 + s);\n                    } else {\n                        q = (l + s - l * s);\n                    }\n\n                    float p = 2.0 * l - q;\n\n                    r = hue2rgb(p, q, h + 1.0/3.0);\n                    g = hue2rgb(p, q, h);\n                    b = hue2rgb(p, q, h - 1.0/3.0);\n                }\n\n                return vec3(r, g, b);\n            }";return 1===e.shaderLanguage&&(a=e._babylonSLtoWGSL(a),o=e._babylonSLtoWGSL(o),l=e._babylonSLtoWGSL(l)),e._emitFunction("rgb2hsl",a,""),e._emitFunction("hue2rgb",o,""),e._emitFunction("hsl2rgb",l,""),t.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName};\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = rgb2hsl(${t.associatedVariableName});\n`)):i.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = hsl2rgb(${i.associatedVariableName});\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${i.associatedVariableName};\n`)):(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` =  ${s}(0.);\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` =  ${s}(0.);\n`)),this}}(0,o.Y5)("BABYLON.ColorConverterBlock",_m);class gm extends Ml{constructor(e){super(e,xl.Neutral),this.iterations=4,this.registerInput("input",Sl.AutoDetect),this.registerInput("iterations",Sl.Float,!0),this.registerOutput("output",Sl.BasedOnInput),this.registerOutput("index",Sl.Float,xl.Fragment),this.registerOutput("loopID",Sl.Object,void 0,new Td("loopID",this,1,gm,"LoopBlock")),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._forPostBuild=!0,this._outputs[2]._redirectedSource=this._inputs[0],this._outputs[1]._preventBubbleUp=!0,this._outputs[2]._preventBubbleUp=!0}getClassName(){return"LoopBlock"}get input(){return this._inputs[0]}get iterationsInput(){return this._inputs[1]}get output(){return this._outputs[0]}get index(){return this._outputs[1]}get loopID(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1],r=e._getFreeVariableName("index"),n=1===e.shaderLanguage?"var":"int",s=1===e.shaderLanguage?"f32":"float",a=1===e.shaderLanguage?"i32":"int";e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName};\n`;const o=this.iterationsInput.isConnected?`${a}(${this.iterationsInput.associatedVariableName})`:this.iterations;return e.compilationString+=`for (${n} ${r} = 0; ${r} < ${o}; ${r}++){\n`,e.compilationString+=`${e._declareOutput(i)} = ${s}(${r});\n`,this}_postBuildBlock(e){return super._postBuildBlock(e),e.compilationString+="}\n",this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.iterations = ${this.iterations};\n`}serialize(){const e=super.serialize();return e.iterations=this.iterations,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.iterations=e.iterations}}(0,ue.Cg)([oa("Iterations",2,void 0,{embedded:!0})],gm.prototype,"iterations",void 0),(0,o.Y5)("BABYLON.LoopBlock",gm);class vm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("loopID",Sl.Object,!1,void 0,new Td("loopID",this,0,gm,"LoopBlock")),this.registerOutput("value",Sl.AutoDetect),this._outputs[0]._linkedConnectionSource=this._inputs[0]}getClassName(){return"StorageReadBlock"}get loopID(){return this._inputs[0]}get value(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=e._declareOutput(t)+` = ${i.output.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.StorageReadBlock",vm);class Sm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("loopID",Sl.Object,!1,void 0,new Td("loopID",this,0,gm,"LoopBlock")),this.registerInput("value",Sl.AutoDetect),this._linkConnectionTypes(0,1)}getClassName(){return"StorageWriteBlock"}get loopID(){return this._inputs[0]}get value(){return this._inputs[1]}isConnectedInFragmentShader(){return!!this.loopID.isConnected&&this.loopID.connectedPoint.ownerBlock.output.isConnectedInFragmentShader}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=`${i.output.associatedVariableName} = ${t.associatedVariableName};\n`,this}}(0,o.Y5)("BABYLON.StorageWriteBlock",Sm);class xm extends Ml{constructor(e){super(e,xl.Neutral),this.registerInput("input",Sl.Matrix),this.registerOutput("row0",Sl.Vector4),this.registerOutput("row1",Sl.Vector4),this.registerOutput("row2",Sl.Vector4),this.registerOutput("row3",Sl.Vector4),this.registerOutput("col0",Sl.Vector4),this.registerOutput("col1",Sl.Vector4),this.registerOutput("col2",Sl.Vector4),this.registerOutput("col3",Sl.Vector4)}getClassName(){return"MatrixSplitterBlock"}get input(){return this._inputs[0]}get row0(){return this._outputs[0]}get row1(){return this._outputs[1]}get row2(){return this._outputs[2]}get row3(){return this._outputs[3]}get col0(){return this._outputs[4]}get col1(){return this._outputs[5]}get col2(){return this._outputs[6]}get col3(){return this._outputs[7]}_exportColumn(e,t,i,r){const n=1===e.shaderLanguage?"vec4f":"vec4";e.compilationString+=e._declareOutput(t)+` = ${n}(${i}[0][${r}], ${i}[1][${r}], ${i}[2][${r}], ${i}[3][${r}]);\n`}_buildBlock(e){super._buildBlock(e);const t=this._inputs[0].associatedVariableName,i=this.row0,r=this.row1,n=this.row2,s=this.row3,a=this.col0,o=this.col1,l=this.col2,c=this.col3;return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t}[0];\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t}[1];\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t}[2];\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t}[3];\n`),a.hasEndpoints&&this._exportColumn(e,a,t,0),o.hasEndpoints&&this._exportColumn(e,o,t,1),l.hasEndpoints&&this._exportColumn(e,l,t,2),c.hasEndpoints&&this._exportColumn(e,c,t,3),this}}(0,o.Y5)("BABYLON.MatrixSplitterBlock",xm);const Tm="gaussianSplattingVertexDeclaration",Em="attribute position: vec2f;\n";ri.l.IncludesShadersStoreWGSL[Tm]=Em;const Cm={name:Tm,shader:Em};var bm=i(86731);class Pm{optimize(e,t){}}var ym=i(88076);class Am{constructor(){this.mm=new Map}get(e,t){const i=this.mm.get(e);if(void 0!==i)return i.get(t)}set(e,t,i){let r=this.mm.get(e);void 0===r&&this.mm.set(e,r=new Map),r.set(t,i)}}class Rm{get standalone(){return this._options?.standalone??!1}get baseMaterial(){return this._baseMaterial}get doNotInjectCode(){return this._options?.doNotInjectCode??!1}constructor(e,t,i){this._baseMaterial=e,this._scene=t??P.q.LastCreatedScene,this._options=i,this._subMeshToEffect=new Map,this._subMeshToDepthWrapper=new Am,this._meshes=new Map,this._onEffectCreatedObserver=this._baseMaterial.onEffectCreatedObservable.add((e=>{const t=e.subMesh?.getMesh();t&&!this._meshes.has(t)&&this._meshes.set(t,t.onDisposeObservable.add((e=>{const t=this._subMeshToEffect.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value;t?.getMesh()===e&&(this._subMeshToEffect.delete(t),this._deleteDepthWrapperEffect(t))}}))),this._subMeshToEffect.get(e.subMesh)?.[0]!==e.effect&&(this._subMeshToEffect.set(e.subMesh,[e.effect,this._scene.getEngine().currentRenderPassId]),this._deleteDepthWrapperEffect(e.subMesh))}))}_deleteDepthWrapperEffect(e){const t=this._subMeshToDepthWrapper.mm.get(e);t&&(t.forEach((e=>{e.mainDrawWrapper.effect?.dispose()})),this._subMeshToDepthWrapper.mm.delete(e))}getEffect(e,t,i){const r=this._subMeshToDepthWrapper.mm.get(e)?.get(t);if(!r)return null;let n=r.drawWrapper[i];return n||(n=r.drawWrapper[i]=new ec.E(this._scene.getEngine()),n.setEffect(r.mainDrawWrapper.effect,r.mainDrawWrapper.defines)),n}isReadyForSubMesh(e,t,i,r,n){return!(this.standalone&&!this._baseMaterial.isReadyForSubMesh(e.getMesh(),e,r))&&(this._makeEffect(e,t,i,n)?.isReady()??!1)}dispose(){this._baseMaterial.onEffectCreatedObservable.remove(this._onEffectCreatedObserver),this._onEffectCreatedObserver=null;const e=this._meshes.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;e.onDisposeObservable.remove(i)}}_makeEffect(e,t,i,r){const n=this._scene.getEngine(),s=this._subMeshToEffect.get(e);if(!s)return null;const[a,o]=s;let l=this._subMeshToDepthWrapper.get(e,i);if(!l){const t=new ec.E(n);t.defines=e._getDrawWrapper(o)?.defines??null,l={drawWrapper:[],mainDrawWrapper:t,depthDefines:"",token:(0,ym.z)()},l.drawWrapper[r]=t,this._subMeshToDepthWrapper.set(e,i,l)}const c=t.join("\n");if(l.mainDrawWrapper.effect&&c===l.depthDefines)return l.mainDrawWrapper.effect;l.depthDefines=c;const h=a.getUniformNames().slice();let u=a.vertexSourceCodeBeforeMigration,d=a.fragmentSourceCodeBeforeMigration;if(!this.doNotInjectCode){const e=this._options&&this._options.remappedVariables?`#include<shadowMapVertexNormalBias>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapVertexNormalBias>",t=this._options&&this._options.remappedVariables?`#include<shadowMapVertexMetric>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapVertexMetric>",i=this._options&&this._options.remappedVariables?`#include<shadowMapFragmentSoftTransparentShadow>(${this._options.remappedVariables.join(",")})`:"#include<shadowMapFragmentSoftTransparentShadow>",r="#include<shadowMapFragment>",n="#include<shadowMapVertexExtraDeclaration>";u=0===a.shaderLanguage?u.replace(/void\s+?main/g,`\n${n}\nvoid main`):u.replace(/@vertex/g,`\n${n}\n@vertex`),u=u.replace(/#define SHADOWDEPTH_NORMALBIAS|#define CUSTOM_VERTEX_UPDATE_WORLDPOS/g,e),u=-1!==u.indexOf("#define SHADOWDEPTH_METRIC")?u.replace(/#define SHADOWDEPTH_METRIC/g,t):u.replace(/}\s*$/g,t+"\n}"),u=u.replace(/#define SHADER_NAME.*?\n|out vec4 glFragColor;\n/g,"");const s=d.indexOf("#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW")>=0||d.indexOf("#define CUSTOM_FRAGMENT_BEFORE_FOG")>=0,o=-1!==d.indexOf("#define SHADOWDEPTH_FRAGMENT");let l="";s?d=d.replace(/#define SHADOWDEPTH_SOFTTRANSPARENTSHADOW|#define CUSTOM_FRAGMENT_BEFORE_FOG/g,i):l=i+"\n",d=d.replace(/void\s+?main/g,So.M.IncludesShadersStore.shadowMapFragmentExtraDeclaration+"\nvoid main"),o?d=d.replace(/#define SHADOWDEPTH_FRAGMENT/g,r):l+=r+"\n",l&&(d=d.replace(/}\s*$/g,l+"}")),h.push("biasAndScaleSM","depthValuesSM","lightDataSM","softTransparentShadowSM")}l.mainDrawWrapper.effect=n.createEffect({vertexSource:u,fragmentSource:d,vertexToken:l.token,fragmentToken:l.token},{attributes:a.getAttributesNames(),uniformsNames:h,uniformBuffersNames:a.getUniformBuffersNames(),samplers:a.getSamplers(),defines:c+"\n"+a.defines.replace("#define SHADOWS","").replace(/#define SHADOW\d/g,""),indexParameters:a.getIndexParameters(),shaderLanguage:a.shaderLanguage},n);for(let e=0;e<l.drawWrapper.length;++e)e!==r&&l.drawWrapper[e]?.setEffect(l.mainDrawWrapper.effect,l.mainDrawWrapper.defines);return l.mainDrawWrapper.effect}}var Im,Mm=i(24470),Om=i(39324);!function(e){e[e.Created=1]="Created",e[e.Disposed=2]="Disposed",e[e.GetDefineNames=4]="GetDefineNames",e[e.PrepareUniformBuffer=8]="PrepareUniformBuffer",e[e.IsReadyForSubMesh=16]="IsReadyForSubMesh",e[e.PrepareDefines=32]="PrepareDefines",e[e.BindForSubMesh=64]="BindForSubMesh",e[e.PrepareEffect=128]="PrepareEffect",e[e.GetAnimatables=256]="GetAnimatables",e[e.GetActiveTextures=512]="GetActiveTextures",e[e.HasTexture=1024]="HasTexture",e[e.FillRenderTargetTextures=2048]="FillRenderTargetTextures",e[e.HasRenderTargetTextures=4096]="HasRenderTargetTextures",e[e.HardBindForSubMesh=8192]="HardBindForSubMesh"}(Im||(Im={}));var Nm=i(15949);class Dm extends zo.M{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class Fm extends Mm.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DecalMap",150,new Dm,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,r){const n=r.getMesh().decalMap;return!(this._isEnabled&&n?.texture&&Ho.h.DecalMapEnabled&&t.texturesEnabled)||n.isReady()}prepareDefinesBeforeAttributes(e,t,i){const r=i.decalMap;this._isEnabled&&r?.texture&&Ho.h.DecalMapEnabled&&t.texturesEnabled?((!e.DECAL||e.GAMMADECAL!==r.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=r.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,(0,qo.YT)(r.texture,e,"DECAL")):(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1)}hardBindForSubMesh(e,t,i,r){const n=r.getMesh().decalMap;if(!(this._isEnabled&&n?.texture&&Ho.h.DecalMapEnabled&&t.texturesEnabled))return;const s=this._material.isFrozen,a=n.texture;e.useUbo&&s&&e.isSync||(e.updateFloat4("vDecalInfos",a.coordinatesIndex,0,0,0),(0,qo.mA)(a,e,"decal")),e.setTexture("decalSampler",a)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],Fm.prototype,"isEnabled",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],Fm.prototype,"smoothAlpha",void 0),(0,o.Y5)("BABYLON.DecalMapConfiguration",Fm);var Lm=i(98152);function wm(e){return e instanceof Pu.d?new bu.i(e):null}function Bm(e){return e instanceof Pu.d?new Lm.j(e):null}function Vm(e){return e instanceof Pu.d?new Au.t(e):null}function km(e){return e instanceof Pu.d?new Ru.z(e):null}function Gm(e){return e instanceof Pu.d?new Nu.C(e):null}function Um(e){return e instanceof Pu.d?new Du.I(e):null}function zm(e){return e instanceof Pu.d||e instanceof Oi.F?new Nm.c(e):null}class Wm{}Wm.DEFAULT_COLOR=a.v9.White(),Wm.DEFAULT_WIDTH_ATTENUATED=1,Wm.DEFAULT_WIDTH=.1;var Hm=i(95495);class Ym{static ConvertPoints(e,t){if(e.length&&Array.isArray(e)&&"number"==typeof e[0])return[e];if(e.length&&Array.isArray(e[0])&&"number"==typeof e[0][0])return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof s.Pq){const t=[];for(let i=0;i<e.length;i++){const r=e[i];t.push(r.x,r.y,r.z)}return[t]}if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof s.Pq){const t=[];return e.forEach((e=>{t.push(e.flatMap((e=>[e.x,e.y,e.z])))})),t}if(e instanceof Float32Array){if(t?.floatArrayStride){const i=[],r=3*t.floatArrayStride;for(let t=0;t<e.length;t+=r){const n=new Array(r);for(let i=0;i<r;i++)n[i]=e[t+i];i.push(n)}return i}return[Array.from(e)]}if(e.length&&e[0]instanceof Float32Array){const t=[];return e.forEach((e=>{t.push(Array.from(e))})),t}return[]}static OmitZeroLengthPredicate(e,t,i){const r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),0===r.length?null:r}static OmitDuplicatesPredicate(e,t,i,r){const n=[];return Ym._SearchInPoints(e,t,r)||n.push([e,t]),Ym._SearchInPoints(t,i,r)||n.push([t,i]),Ym._SearchInPoints(i,e,r)||n.push([i,e]),0===n.length?null:n}static _SearchInPoints(e,t,i){for(const r of i)for(let i=0;i<r.length;i++)if(r[i]?.equals(e)&&(r[i+1]?.equals(t)||r[i-1]?.equals(t)))return!0;return!1}static MeshesToLines(e,t){const i=[];return e.forEach(((e,r)=>{const n=e.getVerticesData(Ue.R.PositionKind),a=e.getIndices();if(n&&a)for(let o=0,l=0;o<a.length;o++){const c=3*a[l++],h=3*a[l++],u=3*a[l++],d=new s.Pq(n[c],n[c+1],n[c+2]),p=new s.Pq(n[h],n[h+1],n[h+2]),f=new s.Pq(n[u],n[u+1],n[u+2]);if(t){const s=t(d,p,f,i,o,c,e,r,n,a);if(s)for(const e of s)i.push(e)}else i.push([d,p],[p,f],[f,d])}})),i}static ToVector3Array(e){if(Array.isArray(e[0])){const t=[],i=e;for(const e of i){const i=[];for(let t=0;t<e.length;t+=3)i.push(new s.Pq(e[t],e[t+1],e[t+2]));t.push(i)}return t}const t=e,i=[];for(let e=0;e<t.length;e+=3)i.push(new s.Pq(t[e],t[e+1],t[e+2]));return i}static ToNumberArray(e){return e.flatMap((e=>[e.x,e.y,e.z]))}static GetPointsCountInfo(e){const t=new Array(e.length);let i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){if(0===e.length)return 0;let t;t="number"==typeof e[0]?Ym.ToVector3Array(e):e;const i=s.AA.Vector3[0];let r=0;for(let e=0;e<t.length-1;e++){const n=t[e];r+=t[e+1].subtractToRef(n,i).length()}return r}static GetLineLengthArray(e){const t=new Float32Array(e.length/3);let i=0;for(let r=0,n=e.length/3-1;r<n;r++){let n=e[3*r+0],s=e[3*r+1],a=e[3*r+2];n-=e[3*r+3],s-=e[3*r+4],a-=e[3*r+5],i+=Math.sqrt(n*n+s*s+a*a),t[r+1]=i}return t}static SegmentizeSegmentByCount(e,t,i){const r=[],n=t.subtract(e),a=s.AA.Vector3[0];a.setAll(i);const o=s.AA.Vector3[1];n.divideToRef(a,o);let l=e.clone();r.push(l);for(let e=0;e<i;e++)l=l.clone(),r.push(l.addInPlace(o));return r}static SegmentizeLineBySegmentLength(e,t){const i=e[0]instanceof s.Pq?Ym.GetLineSegments(e):"number"==typeof e[0]?Ym.GetLineSegments(Ym.ToVector3Array(e)):e,r=[];return i.forEach((e=>{e.length>t?Ym.SegmentizeSegmentByCount(e.point1,e.point2,Math.ceil(e.length/t)).forEach((e=>{r.push(e)})):(r.push(e.point1),r.push(e.point2))})),r}static SegmentizeLineBySegmentCount(e,t){const i="number"==typeof e[0]?Ym.ToVector3Array(e):e,r=Ym.GetLineLength(i)/t;return Ym.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){const t=[];for(let i=0;i<e.length-1;i++){const r=e[i],n=e[i+1],s=n.subtract(r).length();t.push({point1:r,point2:n,length:s})}return t}static GetMinMaxSegmentLength(e){const t=Ym.GetLineSegments(e).sort((e=>e.length));return{min:t[0].length,max:t[t.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){const n=t*i;let a=0,o=0;const l=e.length;for(let t=0;t<l;t++){if(n<=a+e[t].length){o=t;break}a+=e[t].length}const c=(n-a)/e[o].length;return e[o].point2.subtractToRef(e[o].point1,s.AA.Vector3[0]),s.AA.Vector3[1]=s.AA.Vector3[0].multiplyByFloats(c,c,c),r||s.AA.Vector3[1].addInPlace(e[o].point1),s.AA.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,r=e,n=2*Math.PI/t){const a=[];for(let o=0;o<=t;o++)a.push(new s.Pq(Math.cos(o*n)*e,Math.sin(o*n)*r,i));return a}static GetBezierLinePoints(e,t,i,r){return F.jj.CreateQuadraticBezier(e,t,i,r).getPoints().flatMap((e=>[e.x,e.y,e.z]))}static GetArrowCap(e,t,i,r,n,s=0,a=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,n,s,a]}}static GetPointsFromText(e,t,i,r,n=0,s=!0){const a=[],o=(0,Hm.r)(e,t,i,r);for(const e of o){for(const t of e.paths){const e=[],i=t.getPoints();for(const t of i)e.push(t.x,t.y,n);a.push(e)}if(s)for(const t of e.holes){const e=[],i=t.getPoints();for(const t of i)e.push(t.x,t.y,n);a.push(e)}}return a}static Color3toRGBAUint8(e){const t=new Uint8Array(4*e.length);for(let i=0,r=0;i<e.length;i++)t[r++]=255*e[i].r,t[r++]=255*e[i].g,t[r++]=255*e[i].b,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){const n=r.getEngine().getCaps().maxTextureSize??1,s=t.length>n?n:t.length,a=Math.ceil(t.length/n);a>1&&(t=[...t,...Array(s*a-t.length).fill(t[0])]);const o=Ym.Color3toRGBAUint8(t),l=new me.I(o,s,a,_i.N.TEXTUREFORMAT_RGBA,r,!1,!0,i);return l.name=e,l}static PrepareEmptyColorsTexture(e){if(!Wm.EmptyColorsTexture){const t=new Uint8Array(4);Wm.EmptyColorsTexture=new me.I(t,1,1,_i.N.TEXTUREFORMAT_RGBA,e,!1,!1,me.I.NEAREST_NEAREST),Wm.EmptyColorsTexture.name="grlEmptyColorsTexture"}return Wm.EmptyColorsTexture}static DisposeEmptyColorsTexture(){Wm.EmptyColorsTexture?.dispose(),Wm.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}}class Xm extends zo.M{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0}}class qm extends Mm.y{isCompatible(e){return!0}constructor(e,t,i){i=i||{color:Wm.DEFAULT_COLOR};const r=new Xm;r.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,r.GREASED_LINE_SIZE_ATTENUATION=i.sizeAttenuation??!1,r.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===i.colorDistributionType,r.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(t??e.getScene()).useRightHandedSystem,r.GREASED_LINE_CAMERA_FACING=i.cameraFacing??!0,super(e,qm.GREASED_LINE_MATERIAL_NAME,200,r,!0,!0),this.colorsTexture=null,this._forceGLSL=!1,this._forceGLSL=i?.forceGLSL||qm.ForceGLSL,this._scene=t??e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=i.cameraFacing??!0,this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.width=i.width?i.width:i.sizeAttenuation?Wm.DEFAULT_WIDTH_ATTENUATED:Wm.DEFAULT_WIDTH,this._sizeAttenuation=i.sizeAttenuation??!1,this.colorMode=i.colorMode??0,this._color=i.color??null,this.useColors=i.useColors??!1,this._colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??me.I.NEAREST_NEAREST,this._colors=i.colors??null,this.dashCount=i.dashCount??1,this.resolution=i.resolution??new s.I9(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=Ym.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??Wm.DEFAULT_COLOR,Ym.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add((()=>{Ym.DisposeEmptyColorsTexture()}))}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(e=0){const t=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&t.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),1===e&&t.push({name:"viewProjection",size:16,type:"mat4"}),{ubo:t,vertex:this._cameraFacing&&this._isGLSL(e)?"\n                    uniform vec4 grl_aspect_resolution_lineWidth;\n                    uniform mat4 grl_projection;\n    ":"",fragment:this._isGLSL(e)?"\n                    uniform vec4 grl_dashOptions;\n                    uniform vec2 grl_textureSize;\n                    uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;\n                    uniform vec3 grl_singleColor;\n    ":""}}get isEnabled(){return!0}bindForSubMesh(e){if(this._cameraFacing){e.updateMatrix("grl_projection",this._scene.getProjectionMatrix()),e.updateMatrix("viewProjection",this._scene.getTransformMatrix());const t=s.AA.Vector4[0];t.x=this._aspect,t.y=this._resolution.x,t.z=this._resolution.y,t.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",t)}const t=s.AA.Vector4[0];t.x=Ym.BooleanToNumber(this.useDash),t.y=this._dashArray,t.z=this.dashOffset,t.w=this.dashRatio,e.updateVector4("grl_dashOptions",t);const i=s.AA.Vector4[1];i.x=this.colorMode,i.y=this.visibility,i.z=this.colorsTexture?this.colorsTexture.getSize().width:0,i.w=Ym.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",i),this._color&&e.updateColor3("grl_singleColor",this._color);const r=this.colorsTexture??Wm.EmptyColorsTexture;e.setTexture("grl_colors",r),e.updateFloat2("grl_textureSize",r?.getSize().width??1,r?.getSize().height??1)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===this._colorsDistributionType,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing}getClassName(){return qm.GREASED_LINE_MATERIAL_NAME}getCustomCode(e,t=0){return this._isGLSL(t)?function(e,t){if("vertex"===e){const e={CUSTOM_VERTEX_DEFINITIONS:"\n                attribute float grl_widths;\n                attribute vec3 grl_offsets;\n                attribute float grl_colorPointers;\n                varying float grlCounters;\n                varying float grlColorPointer;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    attribute vec4 grl_previousAndSide;\n                    attribute vec4 grl_nextAndCounters;\n\n                    vec2 grlFix( vec4 i, float aspect ) {\n                        vec2 res = i.xy / i.w;\n                        res.x *= aspect;\n                        return res;\n                    }\n                #else\n                    attribute vec3 grl_slopes;\n                    attribute float grl_counters;\n                #endif\n                ",CUSTOM_VERTEX_UPDATE_POSITION:"\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    vec3 grlPositionOffset = grl_offsets;\n                    positionUpdated += grlPositionOffset;\n                #else\n                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);\n                #endif\n                ",CUSTOM_VERTEX_MAIN_END:"\n                grlColorPointer = grl_colorPointers;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n\n                    float grlAspect = grl_aspect_resolution_lineWidth.x;\n                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;\n\n                    vec3 grlPrevious = grl_previousAndSide.xyz;\n                    float grlSide = grl_previousAndSide.w;\n\n                    vec3 grlNext = grl_nextAndCounters.xyz;\n                    grlCounters = grl_nextAndCounters.w;\n\n                    mat4 grlMatrix = viewProjection * finalWorld;\n                    vec4 grlFinalPosition = grlMatrix * vec4(positionUpdated, 1.0);\n                    vec4 grlPrevPos = grlMatrix * vec4(grlPrevious + grlPositionOffset, 1.0);\n                    vec4 grlNextPos = grlMatrix * vec4(grlNext + grlPositionOffset, 1.0);\n\n                    vec2 grlCurrentP = grlFix(grlFinalPosition, grlAspect);\n                    vec2 grlPrevP = grlFix(grlPrevPos, grlAspect);\n                    vec2 grlNextP = grlFix(grlNextPos, grlAspect);\n\n                    float grlWidth = grlBaseWidth * grl_widths;\n\n                    vec2 grlDir;\n                    if (grlNextP == grlCurrentP) {\n                        grlDir = normalize(grlCurrentP - grlPrevP);\n                    } else if (grlPrevP == grlCurrentP) {\n                        grlDir = normalize(grlNextP - grlCurrentP);\n                    } else {\n                        vec2 grlDir1 = normalize(grlCurrentP - grlPrevP);\n                        vec2 grlDir2 = normalize(grlNextP - grlCurrentP);\n                        grlDir = normalize(grlDir1 + grlDir2);\n                    }\n                    vec4 grlNormal = vec4(-grlDir.y, grlDir.x, 0., 1.);\n\n                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM\n                        grlNormal.xy *= -.5 * grlWidth;\n                    #else\n                        grlNormal.xy *= .5 * grlWidth;\n                    #endif\n\n                    grlNormal *= grl_projection;\n\n                    #ifdef GREASED_LINE_SIZE_ATTENUATION\n                        grlNormal.xy *= grlFinalPosition.w;\n                        grlNormal.xy /= (vec4(grl_aspect_resolution_lineWidth.yz, 0., 1.) * grl_projection).xy;\n                    #endif\n\n                    grlFinalPosition.xy += grlNormal.xy * grlSide;\n                    gl_Position = grlFinalPosition;\n\n                    vPositionW = vec3(grlFinalPosition);\n                #else\n                    grlCounters = grl_counters;\n                #endif\n                "};return t&&(e["!gl_Position\\=viewProjection\\*worldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    varying float grlCounters;\n                    varying float grlColorPointer;\n                    uniform sampler2D grl_colors;\n                ",CUSTOM_FRAGMENT_MAIN_END:"\n                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;\n                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;\n                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;\n                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;\n\n                    float grlUseDash = grl_dashOptions.x;\n                    float grlDashArray = grl_dashOptions.y;\n                    float grlDashOffset = grl_dashOptions.z;\n                    float grlDashRatio = grl_dashOptions.w;\n\n                    gl_FragColor.a *= step(grlCounters, grlVisibility);\n                    if(gl_FragColor.a == 0.) discard;\n\n                    if(grlUseDash == 1.){\n                        gl_FragColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));\n                        if (gl_FragColor.a == 0.) discard;\n                    }\n\n                    #ifdef GREASED_LINE_HAS_COLOR\n                        if (grlColorMode == 0.) {\n                            gl_FragColor.rgb = grl_singleColor;\n                        } else if (grlColorMode == 1.) {\n                            gl_FragColor.rgb += grl_singleColor;\n                        } else if (grlColorMode == 2.) {\n                            gl_FragColor.rgb *= grl_singleColor;\n                        }\n                    #else\n                        if (grlUseColors == 1.) {\n                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\n                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);\n                            #else\n                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));\n                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);\n                            #endif\n                            if (grlColorMode == 0.) {\n                                gl_FragColor = grlColor;\n                            } else if (grlColorMode == 1.) {\n                                gl_FragColor += grlColor;\n                            } else if (grlColorMode == 2.) {\n                                gl_FragColor *= grlColor;\n                            }\n                        }\n                    #endif\n                "}:null}(e,this._cameraFacing):function(e,t){if("vertex"===e){const e={CUSTOM_VERTEX_DEFINITIONS:"\n                attribute grl_widths: f32;\n                attribute grl_offsets: vec3f;\n                attribute grl_colorPointers: f32;\n                varying grlCounters: f32;\n                varying grlColorPointer: f32;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    attribute grl_previousAndSide : vec4f;\n                    attribute grl_nextAndCounters : vec4f;\n\n                    fn grlFix(i: vec4f, aspect: f32) -> vec2f {\n                        var res = i.xy / i.w;\n                        res.x *= aspect;\n                        return res;\n                    }\n                #else\n                    attribute grl_slopes: f32;\n                    attribute grl_counters: f32;\n                #endif\n\n\n                ",CUSTOM_VERTEX_UPDATE_POSITION:"\n                #ifdef GREASED_LINE_CAMERA_FACING\n                    var grlPositionOffset: vec3f = input.grl_offsets;\n                    positionUpdated += grlPositionOffset;\n                #else\n                    positionUpdated = (positionUpdated + input.grl_offsets) + (input.grl_slopes * input.grl_widths);\n                #endif\n                ",CUSTOM_VERTEX_MAIN_END:"\n                vertexOutputs.grlColorPointer = input.grl_colorPointers;\n\n                #ifdef GREASED_LINE_CAMERA_FACING\n\n                    let grlAspect: f32 = uniforms.grl_aspect_resolution_lineWidth.x;\n                    let grlBaseWidth: f32 = uniforms.grl_aspect_resolution_lineWidth.w;\n\n                    let grlPrevious: vec3f = input.grl_previousAndSide.xyz;\n                    let grlSide: f32 = input.grl_previousAndSide.w;\n\n                    let grlNext: vec3f = input.grl_nextAndCounters.xyz;\n                    vertexOutputs.grlCounters = input.grl_nextAndCounters.w;\n\n                    let grlMatrix: mat4x4f = uniforms.viewProjection * finalWorld;\n                    var grlFinalPosition: vec4f = grlMatrix * vec4f(positionUpdated, 1.0);\n                    let grlPrevPos: vec4f = grlMatrix * vec4f(grlPrevious + grlPositionOffset, 1.0);\n                    let grlNextPos: vec4f = grlMatrix * vec4f(grlNext + grlPositionOffset, 1.0);\n\n                    let grlCurrentP: vec2f = grlFix(grlFinalPosition, grlAspect);\n                    let grlPrevP: vec2f = grlFix(grlPrevPos, grlAspect);\n                    let grlNextP: vec2f = grlFix(grlNextPos, grlAspect);\n\n                    let grlWidth: f32 = grlBaseWidth * input.grl_widths;\n\n                    var grlDir: vec2f;\n                    if (all(grlNextP == grlCurrentP)) {\n                        grlDir = normalize(grlCurrentP - grlPrevP);\n                    } else if (all(grlPrevP == grlCurrentP)) {\n                        grlDir = normalize(grlNextP - grlCurrentP);\n                    } else {\n                        let grlDir1: vec2f = normalize(grlCurrentP - grlPrevP);\n                        let grlDir2: vec2f = normalize(grlNextP - grlCurrentP);\n                        grlDir = normalize(grlDir1 + grlDir2);\n                    }\n\n                    var grlNormal: vec4f = vec4f(-grlDir.y, grlDir.x, 0.0, 1.0);\n\n                    let grlHalfWidth: f32 = 0.5 * grlWidth;\n                    #if defined(GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM)\n                        grlNormal.x *= -grlHalfWidth;\n                        grlNormal.y *= -grlHalfWidth;\n                    #else\n                        grlNormal.x *= grlHalfWidth;\n                        grlNormal.y *= grlHalfWidth;\n                    #endif\n\n                    grlNormal *= uniforms.grl_projection;\n\n                    #if defined(GREASED_LINE_SIZE_ATTENUATION)\n                        grlNormal.x *= grlFinalPosition.w;\n                        grlNormal.y *= grlFinalPosition.w;\n\n                        let pr: f32 = vec4f(uniforms.grl_aspect_resolution_lineWidth.yz, 0.0, 1.0) * uniforms.grl_projection;\n                        grlNormal.x /= pr.x;\n                        grlNormal.y /= pr.y;\n                    #endif\n\n                    vertexOutputs.position = vec4f(grlFinalPosition.xy + grlNormal.xy * grlSide, grlFinalPosition.z, grlFinalPosition.w);\n                    vertexOutputs.vPositionW = vertexOutputs.position.xyz;\n                \n                #else\n                    vertexOutputs.grlCounters = input.grl_counters;\n                #endif\n                "};return t&&(e["!vertexOutputs\\.position\\s=\\sscene\\.viewProjection\\s\\*\\sworldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                    varying grlCounters: f32;\n                    varying grlColorPointer: 32;\n\n                    var grl_colors: texture_2d<f32>;\n                    var grl_colorsSampler: sampler;\n                ",CUSTOM_FRAGMENT_MAIN_END:"\n                    let grlColorMode: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.x;\n                    let grlVisibility: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.y;\n                    let grlColorsWidth: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.z;\n                    let grlUseColors: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.w;\n\n                    let grlUseDash: f32 = uniforms.grl_dashOptions.x;\n                    let grlDashArray: f32 = uniforms.grl_dashOptions.y;\n                    let grlDashOffset: f32 = uniforms.grl_dashOptions.z;\n                    let grlDashRatio: f32 = uniforms.grl_dashOptions.w;\n\n                    fragmentOutputs.color.a *= step(fragmentInputs.grlCounters, grlVisibility);\n                    if (fragmentOutputs.color.a == 0.0) {\n                        discard;\n                    }\n\n                    if (grlUseDash == 1.0) {\n                        let dashPosition = (fragmentInputs.grlCounters + grlDashOffset) % grlDashArray;\n                        fragmentOutputs.color.a *= ceil(dashPosition - (grlDashArray * grlDashRatio));\n\n                        if (fragmentOutputs.color.a == 0.0) {\n                            discard;\n                        }\n                    }\n\n                    #ifdef GREASED_LINE_HAS_COLOR\n                        if (grlColorMode == 0.) {\n                            fragmentOutputs.color = vec4f(uniforms.grl_singleColor, fragmentOutputs.color.a);\n                        } else if (grlColorMode == 1.) {\n                            fragmentOutputs.color += vec4f(uniforms.grl_singleColor, fragmentOutputs.color.a);\n                        } else if (grlColorMode == 2.) {\n                            fragmentOutputs.color *= vec4f(uniforms.grl_singleColor, fragmentOutputs.color.a);\n                        }\n                    #else\n                        if (grlUseColors == 1.) {\n                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE\n                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, vec2f(fragmentInputs.grlCounters, 0.));\n                            #else\n                                let lookup: vec2f = vec2(fract(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x), 1.0 - floor(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x) / max(uniforms.grl_textureSize.y - 1.0, 1.0));\n                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, lookup);\n                            #endif\n                            if (grlColorMode == 0.) {\n                                fragmentOutputs.color = grlColor;\n                            } else if (grlColorMode == 1.) {\n                                fragmentOutputs.color += grlColor;\n                            } else if (grlColorMode == 2.) {\n                                fragmentOutputs.color *= grlColor;\n                            }\n                        }\n                    #endif\n\n\n                "}:null}(e,this._cameraFacing)}dispose(){this.colorsTexture?.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){const r=this._colors?.length??0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this.colorsTexture&&r===e.length&&!i){const t=Ym.Color3toRGBAUint8(e);this.colorsTexture.update(t)}else this.colorsTexture?.dispose(),this.colorsTexture=Ym.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}else this.colorsTexture?.dispose()}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){null===this._color&&null!==e||null!==this._color&&null===e?(this._color=e,!t&&this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){super.parse(e,t,i);const r=e.greasedLineMaterialOptions;this.colorsTexture?.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=Ym.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):Ym.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){const t=e;t.colorsTexture?.dispose(),this._colors&&(t.colorsTexture=Ym.CreateColorsTexture(`${t._material.name}-colors-texture`,this._colors,t.colorsSampling,this._scene)),t.setColor(this.color,!0),t.colorsDistributionType=this.colorsDistributionType,t.colorsSampling=this.colorsSampling,t.colorMode=this.colorMode,t.useColors=this.useColors,t.visibility=this.visibility,t.useDash=this.useDash,t.dashCount=this.dashCount,t.dashRatio=this.dashRatio,t.dashOffset=this.dashOffset,t.width=this.width,t.sizeAttenuation=this.sizeAttenuation,t.resolution=this.resolution,t.markAllDefinesAsDirty()}_isGLSL(e){return 0===e||this._forceGLSL}}qm.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",qm.ForceGLSL=!1,(0,o.Y5)(`BABYLON.${qm.GREASED_LINE_MATERIAL_NAME}`,qm);ri.l.ShadersStore.greasedLinePixelShader="precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}\nif (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { \ntextureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}\nif (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}\n",i(99966),i(66038);ri.l.ShadersStore.greasedLineVertexShader="precision highp float;\n#include<instancesDeclaration>\nattribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;\n#ifdef GREASED_LINE_CAMERA_FACING\nattribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}\n#else\nattribute vec3 grl_slopes;attribute float grl_counters;\n#endif\nvoid main() {\n#include<instancesVertex>\ngrlColorPointer=grl_colorPointers;mat4 grlMatrix=viewProjection*finalWorld ;\n#ifdef GREASED_LINE_CAMERA_FACING\nfloat grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;vec3 grlPositionOffset=grl_offsets;vec4 grlFinalPosition=grlMatrix*vec4( position+grlPositionOffset ,1.0 );vec4 grlPrevPos=grlMatrix*vec4( grlPrevious+grlPositionOffset,1.0 );vec4 grlNextPos=grlMatrix*vec4( grlNext+grlPositionOffset,1.0 );vec2 grlCurrentP=grlFix( grlFinalPosition,grlAspect );vec2 grlPrevP=grlFix( grlPrevPos,grlAspect );vec2 grlNextP=grlFix( grlNextPos,grlAspect );float grlWidth=grlBaseWidth*grl_widths;vec2 grlDir;if( grlNextP==grlCurrentP ) grlDir=normalize( grlCurrentP-grlPrevP );else if( grlPrevP==grlCurrentP ) grlDir=normalize( grlNextP-grlCurrentP );else {vec2 grlDir1=normalize( grlCurrentP-grlPrevP );vec2 grlDir2=normalize( grlNextP-grlCurrentP );grlDir=normalize( grlDir1+grlDir2 );}\nvec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );\n#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM\ngrlNormal.xy*=-.5*grlWidth;\n#else\ngrlNormal.xy*=.5*grlWidth;\n#endif\ngrlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}\ngrlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;\n#else\ngrlCounters=grl_counters;vec4 grlFinalPosition=grlMatrix*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;\n#endif\n}\n";class $m extends ir.B{constructor(e,t,i){const r=["COLOR_DISTRIBUTION_TYPE_LINE 1.","COLOR_DISTRIBUTION_TYPE_SEGMENT 0.","COLOR_MODE_SET 0.","COLOR_MODE_ADD 1.","COLOR_MODE_MULTIPLY 2."],n=["position","grl_widths","grl_offsets","grl_colorPointers"];t.useRightHandedSystem&&r.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM"),i.cameraFacing?(r.push("GREASED_LINE_CAMERA_FACING"),n.push("grl_previousAndSide","grl_nextAndCounters")):(n.push("grl_slopes"),n.push("grl_counters")),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{attributes:n,uniforms:["world","viewProjection","view","projection","grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility"],samplers:["grlColors"],defines:r}),this._color=a.v9.White(),this._colorsDistributionType=0,this._colorsTexture=null,i=i||{color:Wm.DEFAULT_COLOR};const o=t.getEngine();this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.dashCount=i.dashCount??1,this.width=i.width?i.width:i.sizeAttenuation&&i.cameraFacing?Wm.DEFAULT_WIDTH_ATTENUATED:Wm.DEFAULT_WIDTH,this.sizeAttenuation=i.sizeAttenuation??!1,this.color=i.color??a.v9.White(),this.useColors=i.useColors??!1,this.colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??me.I.NEAREST_NEAREST,this.colorMode=i.colorMode??0,this._colors=i.colors??null,this._cameraFacing=i.cameraFacing??!0,this.resolution=i.resolution??new s.I9(o.getRenderWidth(),o.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this.colorsTexture=Ym.PrepareEmptyColorsTexture(t),this._colors&&this.useColors&&(this.colorsTexture=Ym.CreateColorsTexture(`${this.name}-colors-texture`,this._colors,this.colorsSampling,t)),o.onDisposeObservable.add((()=>{Ym.DisposeEmptyColorsTexture()}))}dispose(){this._colorsTexture?.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new s.I9(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){const r=this._colors?.length??0;if(this._colors=e,null!==e&&0!==e.length){if(!t||i)if(this._colorsTexture&&r===e.length&&!i){const t=Ym.Color3toRGBAUint8(e);this._colorsTexture.update(t)}else this._colorsTexture?.dispose(),this.colorsTexture=Ym.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}else this._colorsTexture?.dispose()}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",Ym.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",Ym.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",Ym.BooleanToNumber(e))}get color(){return this._color}set color(e){this.setColor(e)}setColor(e){e=e??Wm.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){const r=e.greasedLineMaterialOptions;this._colorsTexture?.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=Ym.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=Ym.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}var jm,Km,Zm;!function(e){e[e.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",e[e.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",e[e.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE"}(jm||(jm={})),function(e){e[e.COLOR_MODE_SET=0]="COLOR_MODE_SET",e[e.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",e[e.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY"}(Km||(Km={})),function(e){e[e.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",e[e.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"}(Zm||(Zm={}));const Qm=[new wo.v9(.98,.26,.38),new wo.v9(.47,.75,.3),new wo.v9(0,.26,.77),new wo.v9(.97,.6,.76),new wo.v9(.19,.63,.78),new wo.v9(.98,.8,.6),new wo.v9(.65,.43,.15),new wo.v9(.15,.47,.22),new wo.v9(.67,.71,.86),new wo.v9(.09,.46,.56),new wo.v9(.8,.98,.02),new wo.v9(.39,.29,.13),new wo.v9(.53,.63,.06),new wo.v9(.95,.96,.41),new wo.v9(1,.72,.94),new wo.v9(.63,.08,.31),new wo.v9(.66,.96,.95),new wo.v9(.22,.14,.19),new wo.v9(.14,.65,.59),new wo.v9(.93,1,.68),new wo.v9(.93,.14,.44),new wo.v9(.47,.86,.67),new wo.v9(.85,.07,.78),new wo.v9(.53,.64,.98),new wo.v9(.43,.37,.56),new wo.v9(.71,.65,.25),new wo.v9(.66,.19,.01),new wo.v9(.94,.53,.12),new wo.v9(.41,.44,.44),new wo.v9(.24,.71,.96),new wo.v9(.57,.28,.56),new wo.v9(.44,.98,.42)];var Jm;!function(e){e[e.NONE=0]="NONE",e[e.TRIANGLES=1]="TRIANGLES",e[e.VERTICES=2]="VERTICES",e[e.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",e[e.UV0=4]="UV0",e[e.UV1=5]="UV1",e[e.VERTEXCOLORS=6]="VERTEXCOLORS",e[e.MATERIALIDS=7]="MATERIALIDS"}(Jm||(Jm={}));class e_ extends zo.M{constructor(){super(...arguments),this.DBG_MODE=0,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class t_ extends Mm.y{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}constructor(e,t={}){const i=new e_;i.DBG_MODE=t.mode??i.DBG_MODE,i.DBG_MULTIPLY=t.multiply??i.DBG_MULTIPLY,super(e,"MeshDebug",200,i,!0,!0),this._mode=i.DBG_MODE,this._multiply=i.DBG_MULTIPLY,this.shadedDiffuseColor=t.shadedDiffuseColor??new wo.v9(1,1,1),this.shadedSpecularColor=t.shadedSpecularColor??new wo.v9(.8,.8,.8),this.shadedSpecularPower=t.shadedSpecularPower??10,this.wireframeThickness=t.wireframeThickness??.7,this.wireframeTrianglesColor=t.wireframeTrianglesColor??new wo.v9(0,0,0),this.wireframeVerticesColor=t.wireframeVerticesColor??new wo.v9(.8,.8,.8),this.vertexColor=t.vertexColor??new wo.v9(0,0,0),this.vertexRadius=t.vertexRadius??1.2,this.uvScale=t.uvScale??20,this.uvPrimaryColor=t.uvPrimaryColor??new wo.v9(1,1,1),this.uvSecondaryColor=t.uvSecondaryColor??new wo.v9(.5,.5,.5),this._materialColor=t_.MaterialColors[t_._PluginCount++%t_.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&1==this._material.getScene().getEngine().version)return f.V.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),void(this._isEnabled=!1);this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){2!=this._mode&&1!=this._mode&&3!=this._mode||i.isVerticesDataPresent("dbg_initialPass")||f.V.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(e=0){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:0===e?"#if defined(DBG_ENABLED)\nuniform vec3 dbg_shadedDiffuseColor;\nuniform vec4 dbg_shadedSpecularColorPower;\nuniform vec3 dbg_thicknessRadiusScale;\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    uniform vec3 dbg_vertexColor;\n#endif\n\n#if DBG_MODE == 1\n    uniform vec3 dbg_wireframeTrianglesColor;\n#elif DBG_MODE == 3\n    uniform vec3 dbg_wireframeVerticesColor;\n#elif DBG_MODE == 4 || DBG_MODE == 5\n    uniform vec3 dbg_uvPrimaryColor;\n    uniform vec3 dbg_uvSecondaryColor;\n#elif DBG_MODE == 7\n    uniform vec3 dbg_materialColor;\n#endif\n#endif":"#if defined(DBG_ENABLED)\nuniform dbg_shadedDiffuseColor: vec3f;\nuniform dbg_shadedSpecularColorPower: vec4f;\nuniform dbg_thicknessRadiusScale: vec3f;\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    uniform dbg_vertexColor: vec3f;\n#endif\n\n#if DBG_MODE == 1\n    uniform dbg_wireframeTrianglesColor: vec3f;\n#elif DBG_MODE == 3\n    uniform  dbg_wireframeVerticesColor: vec3f;\n#elif DBG_MODE == 4 || DBG_MODE == 5\n    uniform dbg_uvPrimaryColor: vec3f;\n    uniform dbg_uvSecondaryColor: vec3f;\n#elif DBG_MODE == 7\n    uniform dbg_materialColor: vec3f;\n#endif\n#endif"}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e,t=0){return 1===t?"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"#if defined(DBG_ENABLED)\nattribute dbg_initialPass: f32;\nvarying dbg_vBarycentric: vec3f;\nvarying dbg_vVertexWorldPos: vec3f;\nvarying dbg_vPass: f32;\n#endif",CUSTOM_VERTEX_MAIN_END:"#if defined(DBG_ENABLED)\nvar dbg_vertexIndex = f32(input.vertexIndex) % 3.;\nif (dbg_vertexIndex == 0.0) { \n    vertexOutputs.dbg_vBarycentric = vec3f(1.,0.,0.); \n}\nelse if (dbg_vertexIndex == 1.0) { \n    vertexOutputs.dbg_vBarycentric = vec3f(0.,1.,0.); \n}\nelse { \n    vertexOutputs.dbg_vBarycentric = vec3f(0.,0.,1.); \n}\n\nvertexOutputs.dbg_vVertexWorldPos = vertexOutputs.vPositionW;\nvertexOutputs.dbg_vPass = input.dbg_initialPass;\n#endif"}:{CUSTOM_FRAGMENT_DEFINITIONS:"#if defined(DBG_ENABLED)\nvarying dbg_vBarycentric: vec3f;\nvarying dbg_vVertexWorldPos: vec3f;\nvarying dbg_vPass: f32;\n\n#if !defined(DBG_MULTIPLY)\n    fn dbg_applyShading(color: vec3f) -> vec3f {\n        var N = fragmentInputs.vNormalW.xyz;\n        var L = normalize(scene.vEyePosition.xyz - fragmentInputs.vPositionW.xyz);\n        var H = normalize(L + L);\n        var LdotN = clamp(dot(L,N), 0., 1.);\n        var HdotN = clamp(dot(H,N), 0., 1.);\n        var specTerm = pow(HdotN, uniforms.dbg_shadedSpecularColorPower.w);\n        var result = color * (LdotN / PI);\n        result += uniforms.dbg_shadedSpecularColorPower.rgb * (specTerm / PI);\n        return result;\n    }\n#endif\n\n#if DBG_MODE == 1 || DBG_MODE == 3\n    fn dbg_edgeFactor() -> f32 {\n        var d = fwidth(fragmentInputs.dbg_vBarycentric);\n        var a3 = smoothstep(vec3f(0.), d * uniforms.dbg_thicknessRadiusScale.x, fragmentInputs.dbg_vBarycentric);\n        return min(min(a3.x, a3.y), a3.z);\n    }\n#endif\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    fn dbg_cornerFactor() -> f32 {\n        var worldPos = fragmentInputs.vPositionW;\n        float dist = length(worldPos - fragmentInputs.dbg_vVertexWorldPos);\n        float camDist = length(worldPos - scene.vEyePosition.xyz);\n        float d = sqrt(camDist) * .001;\n        return smoothstep((uniforms.dbg_thicknessRadiusScale.y * d), ((uniforms.dbg_thicknessRadiusScale.y * 1.01) * d), dist);\n    }\n#endif\n\n#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))\n    fn dbg_checkerboardFactor(uv: vec2f) -> f32 {\n        var f = fract(uv * uniforms.dbg_thicknessRadiusScale.z);\n        f -= .5;\n        return (f.x * f.y) > 0. ? 1. : 0.;\n    }\n#endif\n#endif",CUSTOM_FRAGMENT_MAIN_END:"#if defined(DBG_ENABLED)\nvar dbg_color = vec3f(1.);\n#if DBG_MODE == 1\n    dbg_color = mix(uniforms.dbg_wireframeTrianglesColor, vec3f(1.), dbg_edgeFactor());\n#elif DBG_MODE == 2 || DBG_MODE == 3\n    var dbg_cornerFactor = dbg_cornerFactor();\n    if (fragmentInputs.dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;\n    dbg_color = mix(uniforms.dbg_vertexColor, vec3(1.), dbg_cornerFactor);\n    #if DBG_MODE == 3\n        dbg_color *= mix(uniforms.dbg_wireframeVerticesColor, vec3f(1.), dbg_edgeFactor());\n    #endif\n#elif DBG_MODE == 4 && defined(MAINUV1)\n    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV1));\n#elif DBG_MODE == 5 && defined(MAINUV2)\n    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV2));\n#elif DBG_MODE == 6 && defined(VERTEXCOLOR)\n    dbg_color = fragmentInputs.vColor.rgb;\n#elif DBG_MODE == 7\n    dbg_color = uniforms.dbg_materialColor;\n#endif\n\n#if defined(DBG_MULTIPLY)\n    fragmentOutputs.color *= vec4f(dbg_color, 1.);\n#else\n    #if DBG_MODE != 6\n        fragmentOutputs.color = vec4f(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);\n    #else\n        fragmentOutputs.color = vec4f(dbg_color, 1.);\n    #endif\n#endif\n#endif"}:"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:"#if defined(DBG_ENABLED)\nattribute float dbg_initialPass;\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n#endif",CUSTOM_VERTEX_MAIN_END:"#if defined(DBG_ENABLED)\nfloat dbg_vertexIndex = mod(float(gl_VertexID), 3.);\nif (dbg_vertexIndex == 0.0) { \n    dbg_vBarycentric = vec3(1.,0.,0.); \n}\nelse if (dbg_vertexIndex == 1.0) { \n    dbg_vBarycentric = vec3(0.,1.,0.); \n}\nelse { \n    dbg_vBarycentric = vec3(0.,0.,1.); \n}\n\ndbg_vVertexWorldPos = vPositionW;\ndbg_vPass = dbg_initialPass;\n#endif"}:{CUSTOM_FRAGMENT_DEFINITIONS:"#if defined(DBG_ENABLED)\nvarying vec3 dbg_vBarycentric;\nflat varying vec3 dbg_vVertexWorldPos;\nflat varying float dbg_vPass;\n\n#if !defined(DBG_MULTIPLY)\n    vec3 dbg_applyShading(vec3 color) {\n        vec3 N = vNormalW.xyz;\n        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);\n        vec3 H = normalize(L + L);\n        float LdotN = clamp(dot(L,N), 0., 1.);\n        float HdotN = clamp(dot(H,N), 0., 1.);\n        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);\n        color *= (LdotN / PI);\n        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);\n        return color;\n    }\n#endif\n\n#if DBG_MODE == 1 || DBG_MODE == 3\n    float dbg_edgeFactor() {\n        vec3 d = fwidth(dbg_vBarycentric);\n        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);\n        return min(min(a3.x, a3.y), a3.z);\n    }\n#endif\n\n#if DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor() {\n        vec3 worldPos = vPositionW;\n        float dist = length(worldPos - dbg_vVertexWorldPos);\n        float camDist = length(worldPos - vEyePosition.xyz);\n        float d = sqrt(camDist) * .001;\n        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);\n    }\n#endif\n\n#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))\n    float dbg_checkerboardFactor(vec2 uv) {\n        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);\n        f -= .5;\n        return (f.x * f.y) > 0. ? 1. : 0.;\n    }\n#endif\n#endif",CUSTOM_FRAGMENT_MAIN_END:"#if defined(DBG_ENABLED)\nvec3 dbg_color = vec3(1.);\n#if DBG_MODE == 1\n    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());\n#elif DBG_MODE == 2 || DBG_MODE == 3\n    float dbg_cornerFactor = dbg_cornerFactor();\n    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;\n    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);\n    #if DBG_MODE == 3\n        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());\n    #endif\n#elif DBG_MODE == 4 && defined(MAINUV1)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));\n#elif DBG_MODE == 5 && defined(MAINUV2)\n    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));\n#elif DBG_MODE == 6 && defined(VERTEXCOLOR)\n    dbg_color = vColor.rgb;\n#elif DBG_MODE == 7\n    dbg_color = dbg_materialColor;\n#endif\n\n#if defined(DBG_MULTIPLY)\n    gl_FragColor *= vec4(dbg_color, 1.);\n#else\n    #if DBG_MODE != 6\n        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);\n    #else\n        gl_FragColor = vec4(dbg_color, 1.);\n    #endif\n#endif\n#endif"}}static Reset(){this._PluginCount=0,this.MaterialColors=Qm}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(0==e.getTotalIndices())return i;if(t){const t=e.getVerticesDataKinds(),r=e.getIndices(),n={};for(const i of t)n[i]=e.getVerticesData(i);i=function(){e.setIndices(r);for(const i of t){const t=e.getVertexBuffer(i).getStrideSize();e.setVerticesData(i,n[i],void 0,t)}e.removeVerticesData("dbg_initialPass")}}let r=Array.from(e.getIndices());const n=[];for(let e=0;e<r.length;e+=3)n.push(r[e+1],r[e+2],r[e+0]);e.setIndices(r.concat(n)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,r=Array.from(e.getIndices());const s=[];for(let e=r.length/2;e<r.length;e+=3)s.push(r[e+1],r[e+2],r[e+0]);e.setIndices(r.concat(s));const a=e.getTotalVertices(),o=a/2,l=new Array(a).fill(1,0,o).fill(0,o,a);return e.setVerticesData("dbg_initialPass",l,!1,1),i}}t_._PluginCount=0,t_.MaterialColors=Qm,(0,ue.Cg)([(0,de.jT)()],t_.prototype,"_materialColor",void 0),(0,ue.Cg)([(0,de.lK)()],t_.prototype,"_isEnabled",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllDefinesAsDirty")],t_.prototype,"mode",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllDefinesAsDirty")],t_.prototype,"multiply",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"shadedDiffuseColor",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"shadedSpecularColor",void 0),(0,ue.Cg)([(0,de.lK)()],t_.prototype,"shadedSpecularPower",void 0),(0,ue.Cg)([(0,de.lK)()],t_.prototype,"wireframeThickness",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"wireframeTrianglesColor",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"wireframeVerticesColor",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"vertexColor",void 0),(0,ue.Cg)([(0,de.lK)()],t_.prototype,"vertexRadius",void 0),(0,ue.Cg)([(0,de.lK)()],t_.prototype,"uvScale",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"uvPrimaryColor",void 0),(0,ue.Cg)([(0,de.jT)()],t_.prototype,"uvSecondaryColor",void 0),(0,o.Y5)("BABYLON.MeshDebugPluginMaterial",t_),Object.defineProperty(Oi.F.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new Fm(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Pu.d.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new Fm(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(Er.u.prototype,"decalMap",{get:function(){return this._decalMap},set:function(e){this._decalMap=e},enumerable:!0,configurable:!0});var i_=i(94429),r_=i(17119),n_=i(48627),s_=i(37842),a_=i(87020),o_=i(53679);class l_{constructor(e,t){this.radius=e,this.theta=t,this.radius=e,this.theta=t}getClassName(){return"Polar"}toString(){return JSON.stringify(this)}asArray(){return[this.radius,this.theta]}addToRef(e,t){return t.radius=this.radius+e.radius,t.theta=this.theta+e.theta,t}add(e){const t=new l_(0,0);return this.addToRef(e,t),t}addInPlace(e){return this.addToRef(e,this),this}addInPlaceFromFloats(e,t){return this.radius+=e,this.theta+=t,this}subtractToRef(e,t){return t.radius=this.radius-e.radius,t.theta=this.theta-e.theta,t}subtract(e){const t=new l_(0,0);return this.subtractToRef(e,t),t}subtractInPlace(e){return this.subtractToRef(e,this),this}subtractFromFloatsToRef(e,t,i){return i.radius=this.radius-e,i.theta=this.theta-t,i}subtractFromFloats(e,t){const i=new l_(0,0);return this.subtractFromFloatsToRef(e,t,i),i}multiplyToRef(e,t){return t.radius=this.radius*e.radius,t.theta=this.theta*e.theta,t}multiply(e){const t=new l_(0,0);return this.multiplyToRef(e,t),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}divideToRef(e,t){return t.radius=this.radius/e.radius,t.theta=this.theta/e.theta,t}divide(e){const t=new l_(0,0);return this.divideToRef(e,t),t}divideInPlace(e){return this.divideToRef(e,this),this}clone(){return new l_(this.radius,this.theta)}copyFrom(e){return this.radius=e.radius,this.theta=e.theta,this}copyFromFloats(e,t){return this.radius=e,this.theta=t,this}scaleToRef(e,t){return t.radius=this.radius*e,t.theta=this.theta*e,t}scale(e){const t=new l_(0,0);return this.scaleToRef(e,t),t}scaleInPlace(e){return this.scaleToRef(e,this),this}set(e,t){return this.radius=e,this.theta=t,this}setAll(e){return this.set(e,e),this}toVector2ToRef(e){const t=this.radius*Math.cos(this.theta),i=this.radius*Math.sin(this.theta);return e.set(t,i),e}toVector2(){const e=new s.I9(0,0);return this.toVector2ToRef(e)}static FromVector2ToRef(e,t){const i=Math.sign(e.y)*Math.acos(e.x/e.length());return t.radius=e.length(),t.theta=i,t}static FromVector2(e){const t=new l_(0,0);return l_.FromVector2ToRef(e,t),t}static FromArray(e){return new l_(e[0],e[1])}}class c_{constructor(e,t,i){this.radius=e,this.theta=t,this.phi=i,this.radius=e,this.theta=t,this.phi=i}getClassName(){return"Spherical"}toString(){return JSON.stringify(this)}asArray(){return[this.radius,this.theta,this.phi]}addToRef(e,t){return t.radius=this.radius+e.radius,t.theta=this.theta+e.theta,t.phi=this.phi+e.phi,t}add(e){const t=new c_(0,0,0);return this.addToRef(e,t),t}addInPlace(e){return this.addToRef(e,this),this}addInPlaceFromFloats(e,t,i){return this.radius+=e,this.theta+=t,this.phi+=i,this}subtractToRef(e,t){return t.radius=this.radius-e.radius,t.theta=this.theta-e.theta,t.phi=this.phi-e.phi,t}subtract(e){const t=new c_(0,0,0);return this.subtractToRef(e,t),t}subtractInPlace(e){return this.subtractToRef(e,this),this}subtractFromFloatsToRef(e,t,i,r){return r.radius=this.radius-e,r.theta=this.theta-t,r.phi=this.phi-i,r}subtractFromFloats(e,t,i){const r=new c_(0,0,0);return this.subtractFromFloatsToRef(e,t,i,r),r}multiplyToRef(e,t){return t.radius=this.radius*e.radius,t.theta=this.theta*e.theta,t.phi=this.phi*e.phi,t}multiply(e){const t=new c_(0,0,0);return this.multiplyToRef(e,t),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}divideToRef(e,t){return t.radius=this.radius/e.radius,t.theta=this.theta/e.theta,t.phi=this.phi/e.phi,t}divide(e){const t=new c_(0,0,0);return this.divideToRef(e,t),t}divideInPlace(e){return this.divideToRef(e,this),this}clone(){return new c_(this.radius,this.theta,this.phi)}copyFrom(e){return this.radius=e.radius,this.theta=e.theta,this.phi=e.phi,this}copyFromFloats(e,t,i){return this.radius=e,this.theta=t,this.phi=i,this}scaleToRef(e,t){return t.radius=this.radius*e,t.theta=this.theta*e,t.phi=this.phi*e,t}scale(e){const t=new c_(0,0,0);return this.scaleToRef(e,t),t}scaleInPlace(e){return this.scaleToRef(e,this),this}set(e,t,i){return this.radius=e,this.theta=t,this.phi=i,this}setAll(e){return this.set(e,e,e),this}toVector3ToRef(e){const t=this.radius*Math.sin(this.theta)*Math.cos(this.phi),i=this.radius*Math.cos(this.theta),r=this.radius*Math.sin(this.theta)*Math.sin(this.phi);return e.set(t,i,r),e}toVector3(){const e=new s.Pq(0,0,0);return this.toVector3ToRef(e)}static FromVector3ToRef(e,t){return t.radius=e.length(),t.theta=Math.acos(e.y/t.radius),t.phi=Math.atan2(e.z,e.x),t}static FromVector3(e){const t=new c_(0,0,0);return c_.FromVector3ToRef(e,t),t}static FromArray(e){return new c_(e[0],e[1],e[2])}}var h_=i(47369);function u_(e,t){return`{X: ${e.x.toFixed(t)} Y: ${e.y.toFixed(t)}}`}function d_(e,t){return`{X: ${e._x.toFixed(t)} Y: ${e._y.toFixed(t)} Z: ${e._z.toFixed(t)}}`}function p_(e,t){return`{X: ${e.x.toFixed(t)} Y: ${e.y.toFixed(t)} Z: ${e.z.toFixed(t)} W: ${e.w.toFixed(t)}}`}function f_(e){const t=e.pickedMesh?.getIndices();if(t){const i=3*e.faceId;return{pointIndex:[t[i],t[i+1],t[i+2]],barycentric:[e.bu,e.bv,1-e.bu-e.bv]}}return null}function m_(e,t,i){const r=e.getVerticesData(Ue.R.PositionKind);if(!r)return!1;const n=3*t,a=[r[n+0],r[n+1],r[n+2]];if(a.some((e=>isNaN(e??Number.NaN))))return!1;if(e.morphTargetManager)for(let t=0;t<3;t++){let i=a[t];for(let s=0;s<e.morphTargetManager.numTargets;s++){const a=e.morphTargetManager.getTarget(s),o=a.influence;if(0!==o){const e=a.getPositions();e&&(i+=(e[n+t]-r[n+t])*o)}}a[t]=i}if(i.fromArray(a),e.skeleton){const r=e.getVerticesData(Ue.R.MatricesIndicesKind),n=e.getVerticesData(Ue.R.MatricesWeightsKind);if(n&&r){const o=e.numBoneInfluencers>4,l=o?e.getVerticesData(Ue.R.MatricesIndicesExtraKind):null,c=o?e.getVerticesData(Ue.R.MatricesWeightsExtraKind):null,h=e.skeleton.getTransformMatrices(e),u=s.AA.Matrix[0],d=s.AA.Matrix[1];u.reset();const p=4*t;let f,m;for(f=0;f<4;f++)m=n[p+f],m>0&&(s.uq.FromFloat32ArrayToRefScaled(h,Math.floor(16*r[p+f]),m,d),u.addToSelf(d));if(l&&c)for(f=0;f<4;f++)m=c[p+f],m>0&&(s.uq.FromFloat32ArrayToRefScaled(h,Math.floor(16*l[p+f]),m,d),u.addToSelf(d));s.Pq.TransformCoordinatesFromFloatsToRef(a[0],a[1],a[2],u,i)}}return!0}function __(e,t,i,r){i.set(0,0,0);for(let r=0;r<3;r++){if(!m_(e,t.pointIndex[r],s.AA.Vector3[r]))return!1;s.AA.Vector3[r].scaleAndAddToRef(t.barycentric[r],i)}if(s.Pq.TransformCoordinatesToRef(i,e.getWorldMatrix(),i),r){const t=s.AA.Vector3[0],i=s.AA.Vector3[1],n=s.AA.Vector3[2],a=s.AA.Vector3[3],o=s.AA.Vector3[4];a.copyFrom(i),a.subtractInPlace(t),o.copyFrom(n),o.subtractInPlace(t),a.normalize(),o.normalize(),s.Pq.CrossToRef(a,o,r),e.material&&e.material.sideOrientation===(e.getScene().useRightHandedSystem?0:1)&&r.scaleInPlace(-1),s.Pq.TransformNormalToRef(r,e.getWorldMatrix(),r),r.normalize()}return!0}var g_=i(86244),v_=i(85533),S_=i(33543);let x_=0;class T_{constructor(e,t,i,r){this.pos=e,this.normal=t,this.uv=i,this.vertColor=r}clone(){return new T_(this.pos.clone(),this.normal.clone(),this.uv?.clone(),this.vertColor?.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new T_(s.Pq.Lerp(this.pos,e.pos,t),s.Pq.Lerp(this.normal,e.normal,t),this.uv&&e.uv?s.I9.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?a.ov.Lerp(this.vertColor,e.vertColor,t):void 0)}}class E_{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){const r=i.subtract(e),n=t.subtract(e);if(0===r.lengthSquared()||0===n.lengthSquared())return null;const a=s.Pq.Normalize(s.Pq.Cross(r,n));return new E_(a,s.Pq.Dot(a,e))}clone(){return new E_(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,r,n){let a=0;const o=[];let l,c;for(l=0;l<e.vertices.length;l++){c=s.Pq.Dot(this.normal,e.vertices[l].pos)-this.w;const t=c<-E_.EPSILON?2:c>E_.EPSILON?1:0;a|=t,o.push(t)}switch(a){case 0:(s.Pq.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:r.push(e);break;case 2:n.push(e);break;case 3:{const t=[],i=[];for(l=0;l<e.vertices.length;l++){const r=(l+1)%e.vertices.length,n=o[l],a=o[r],h=e.vertices[l],u=e.vertices[r];if(2!==n&&t.push(h),1!==n&&i.push(2!==n?h.clone():h),3==(n|a)){c=(this.w-s.Pq.Dot(this.normal,h.pos))/s.Pq.Dot(this.normal,u.pos.subtract(h.pos));const e=h.interpolate(u,c);t.push(e),i.push(e.clone())}}let a;t.length>=3&&(a=new C_(t,e.shared),a.plane&&r.push(a)),i.length>=3&&(a=new C_(i,e.shared),a.plane&&n.push(a));break}}}}E_.EPSILON=1e-5;class C_{constructor(e,t){this.vertices=e,this.shared=t,this.plane=E_.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map((e=>e.clone()));return new C_(e,this.shared)}flip(){this.vertices.reverse().map((e=>{e.flip()})),this.plane.flip()}}class b_{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){const e=new b_;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map((e=>e.clone())),e}invert(){for(let e=0;e<this._polygons.length;e++)this._polygons[e].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();const e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),i=this._back?this._back.clipPolygons(i):[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());const t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new b_),this._front.build(t)),i.length&&(this._back||(this._back=new b_),this._back.build(i))}}class P_{constructor(){this._polygons=new Array}static FromVertexData(e){let t,i,r;const n=[],o=e.indices,l=e.positions,c=e.normals,h=e.uvs,u=e.colors;if(!o||!l)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let e=0;e<o.length;e+=3){r=[];for(let i=0;i<3;i++){const n=o[e+i],d=c?s.Pq.FromArray(c,3*n):s.Pq.Zero(),p=h?s.I9.FromArray(h,2*n):void 0,f=u?a.ov.FromArray(u,4*n):void 0,m=s.Pq.FromArray(l,3*n);t=new T_(m,d,p,f),r.push(t)}i=new C_(r,{subMeshId:0,meshId:x_,materialIndex:0}),i.plane&&n.push(i)}const d=P_._FromPolygons(n);return d.matrix=s.uq.Identity(),d.position=s.Pq.Zero(),d.rotation=s.Pq.Zero(),d.scaling=s.Pq.One(),d.rotationQuaternion=s.PT.Identity(),x_++,d}static FromMesh(e,t=!1){let i,r,n,o,l,c,h;const u=[];let d,p,f,m,_=null,g=!1;if(!(e instanceof Rt.e))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";e.computeWorldMatrix(!0),d=e.getWorldMatrix(),p=e.position.clone(),f=e.rotation.clone(),e.rotationQuaternion&&(_=e.rotationQuaternion.clone()),m=e.scaling.clone(),e.material&&t&&(g=0===e.material.sideOrientation);const v=e.getIndices(),S=e.getVerticesData(Ue.R.PositionKind),x=e.getVerticesData(Ue.R.NormalKind),T=e.getVerticesData(Ue.R.UVKind),E=e.getVerticesData(Ue.R.ColorKind);if(null===v)throw"BABYLON.CSG: Mesh has no indices";if(null===S)throw"BABYLON.CSG: Mesh has no positions";if(null===x)throw"BABYLON.CSG: Mesh has no normals";const C=e.subMeshes;for(let e=0,t=C.length;e<t;e++)for(let t=C[e].indexStart,p=C[e].indexCount+C[e].indexStart;t<p;t+=3){h=[];for(let e=0;e<3;e++){const c=0===e?t+e:g?t+3-e:t+e,u=new s.Pq(x[3*v[c]],x[3*v[c]+1],x[3*v[c]+2]);T&&(n=new s.I9(T[2*v[c]],T[2*v[c]+1])),E&&(l=new a.ov(E[4*v[c]],E[4*v[c]+1],E[4*v[c]+2],E[4*v[c]+3]));const p=new s.Pq(S[3*v[c]],S[3*v[c]+1],S[3*v[c]+2]);o=s.Pq.TransformCoordinates(p,d),r=s.Pq.TransformNormal(u,d),i=new T_(o,r,n,l),h.push(i)}c=new C_(h,{subMeshId:e,meshId:x_,materialIndex:C[e].materialIndex}),c.plane&&u.push(c)}const b=P_._FromPolygons(u);return b.matrix=t?s.uq.Identity():d,b.position=t?s.Pq.Zero():p,b.rotation=t?s.Pq.Zero():f,b.scaling=t?s.Pq.One():m,b.rotationQuaternion=t&&_?s.PT.Identity():_,x_++,b}static _FromPolygons(e){const t=new P_;return t._polygons=e,t}clone(){const e=new P_;return e._polygons=this._polygons.map((e=>e.clone())),e.copyTransformAttributes(this),e}union(e){const t=new b_(this.clone()._polygons),i=new b_(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),P_._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){const t=new b_(this._polygons),i=new b_(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){const t=new b_(this.clone()._polygons),i=new b_(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),P_._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){const t=new b_(this._polygons),i=new b_(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){const t=new b_(this.clone()._polygons),i=new b_(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),P_._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){const t=new b_(this._polygons),i=new b_(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){const e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map((e=>{e.flip()}))}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){const i=this.matrix.clone();i.invert();const r=this._polygons,n=[],o=[],l=[];let c=null,h=null;const u=s.Pq.Zero(),d=s.Pq.Zero(),p=s.I9.Zero(),f=new a.ov(0,0,0,0),m=[0,0,0],_={};let g;for(let a=0,v=r.length;a<v;a++){const v=r[a];e&&e(v);for(let e=2,r=v.vertices.length;e<r;e++){m[0]=0,m[1]=e-1,m[2]=e;for(let e=0;e<3;e++){u.copyFrom(v.vertices[m[e]].pos),d.copyFrom(v.vertices[m[e]].normal),v.vertices[m[e]].uv&&(c||(c=[]),p.copyFrom(v.vertices[m[e]].uv)),v.vertices[m[e]].vertColor&&(h||(h=[]),f.copyFrom(v.vertices[m[e]].vertColor));const r=s.Pq.TransformCoordinates(u,i),a=s.Pq.TransformNormal(d,i);g=_[r.x+","+r.y+","+r.z];let S=!1;c&&c[2*g]!==p.x&&c[2*g+1]!==p.y&&(S=!0);let x=!1;h&&h[4*g]!==f.r&&h[4*g+1]!==f.g&&h[4*g+2]!==f.b&&h[4*g+3]!==f.a&&(x=!0),(void 0===g||l[3*g]!==a.x||l[3*g+1]!==a.y||l[3*g+2]!==a.z||S||x)&&(n.push(r.x,r.y,r.z),c&&c.push(p.x,p.y),l.push(d.x,d.y,d.z),h&&h.push(f.r,f.g,f.b,f.a),g=_[r.x+","+r.y+","+r.z]=n.length/3-1),o.push(g),t&&t()}}}const v=new S_.P;return v.positions=n,v.normals=l,c&&(v.uvs=c),h&&(v.colors=h),v.indices=o,v}buildMeshGeometry(e,t,i){const r=new Rt.e(e,t),n=this._polygons;let s=0;const a={};let o;if(i&&n.sort(((e,t)=>e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId)),this.toVertexData((e=>{a[e.shared.meshId]||(a[e.shared.meshId]={}),a[e.shared.meshId][e.shared.subMeshId]||(a[e.shared.meshId][e.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:e.shared.materialIndex}),o=a[e.shared.meshId][e.shared.subMeshId]}),(()=>{o.indexStart=Math.min(s,o.indexStart),o.indexEnd=Math.max(s,o.indexEnd),s++})).applyToMesh(r),i){let e,t=0;r.subMeshes=[];for(const i in a){e=-1;for(const n in a[i])o=a[i][n],lc.K.CreateFromIndices(o.materialIndex+t,o.indexStart,o.indexEnd-o.indexStart+1,r),e=Math.max(o.materialIndex,e);t+=++e}}return r}toMesh(e,t=null,i,r){const n=this.buildMeshGeometry(e,i,r);return n.material=t,n.position.copyFrom(this.position),n.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(n.rotationQuaternion=this.rotationQuaternion.clone()),n.scaling.copyFrom(this.scaling),n.computeWorldMatrix(!0),n}}class y_{static _GetShader(e,t){if(!e._meshUVSpaceRendererShader){const i=new ir.B("meshUVSpaceRendererShader",e,{vertex:"meshUVSpaceRenderer",fragment:"meshUVSpaceRenderer"},{attributes:["position","normal","uv"],uniforms:["world","projMatrix"],samplers:["textureSampler"],needAlphaBlending:!0,shaderLanguage:t});i.backFaceCulling=!1,i.alphaMode=2,e.onDisposeObservable.add((()=>{e._meshUVSpaceRendererShader?.dispose(),e._meshUVSpaceRendererShader=null})),e._meshUVSpaceRendererShader=i}return e._meshUVSpaceRendererShader}static _GetMaskShader(e,t){if(!e._meshUVSpaceRendererMaskShader){const i=new ir.B("meshUVSpaceRendererMaskShader",e,{vertex:"meshUVSpaceRendererMasker",fragment:"meshUVSpaceRendererMasker"},{attributes:["position","uv"],uniforms:["worldViewProjection"],shaderLanguage:t});i.backFaceCulling=!1,i.alphaMode=2,e.onDisposeObservable.add((()=>{e._meshUVSpaceRendererMaskShader?.dispose(),e._meshUVSpaceRendererMaskShader=null})),e._meshUVSpaceRendererMaskShader=i}return e._meshUVSpaceRendererMaskShader}static _IsRenderTargetTexture(e){return void 0!==e.renderList}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this._textureCreatedInternally=!1,this._configureUserCreatedTexture=!0,this._maskTexture=null,this._finalPostProcess=null,this._shadersLoaded=!1,this._isDisposed=!1,this.clearColor=new a.ov(0,0,0,0),this.texture=null,this._shaderLanguage=0,this._mesh=e,this._scene=t,this._options={width:1024,height:1024,textureType:0,generateMipMaps:!0,optimizeUVAllocation:!0,uvEdgeBlending:!1,...i},this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,34863)),Promise.resolve().then(i.bind(i,84613)),Promise.resolve().then(i.bind(i,58990)),Promise.resolve().then(i.bind(i,69536)),Promise.resolve().then(i.bind(i,6286)),Promise.resolve().then(i.bind(i,95552))])):await Promise.all([Promise.resolve().then(i.bind(i,17808)),Promise.resolve().then(i.bind(i,12714)),Promise.resolve().then(i.bind(i,63325)),Promise.resolve().then(i.bind(i,95171)),Promise.resolve().then(i.bind(i,52511)),Promise.resolve().then(i.bind(i,27637))]),this._isDisposed||(this._shadersLoaded=!0)}isReady(){if(!this._shadersLoaded)return!1;this.texture?this._configureUserCreatedTexture&&this._configureUserCreatedRTT():this._createDiffuseRTT();const e=y_._IsRenderTargetTexture(this.texture)?this.texture.isReadyForRendering():this.texture.isReady(),t=this._maskTexture?.isReadyForRendering()??!0,i=this._finalPostProcess?.isReady()??!0;return e&&t&&i}renderTexture(e,t,i,r,n=0,s=!0){if(!s||this.isReady()){if(this.texture?this._configureUserCreatedTexture&&this._configureUserCreatedRTT():this._createDiffuseRTT(),y_._IsRenderTargetTexture(this.texture)){const s=this._createProjectionMatrix(t,i,r,n),a=y_._GetShader(this._scene,this._shaderLanguage);a.setTexture("textureSampler",e),a.setMatrix("projMatrix",s),this.texture.render(),a.removeTexture("textureSampler")}}else setTimeout((()=>{this.renderTexture(e,t,i,r,n,s)}),16)}clear(){if(this.texture&&y_._IsRenderTargetTexture(this.texture)&&this.texture.renderTarget){const e=this._scene.getEngine();e.bindFramebuffer(this.texture.renderTarget),e.clear(this.clearColor,!0,!0,!0),e.unBindFramebuffer(this.texture.renderTarget)}if(this._finalPostProcess?.inputTexture){const e=this._scene.getEngine();e.bindFramebuffer(this._finalPostProcess?.inputTexture),e.clear(this.clearColor,!0,!0,!0),e.unBindFramebuffer(this._finalPostProcess?.inputTexture)}}dispose(){this._textureCreatedInternally&&(this.texture?.dispose(),this._textureCreatedInternally=!1),this._configureUserCreatedTexture=!0,this._maskTexture?.dispose(),this._maskTexture=null,this._finalPostProcess?.dispose(),this._finalPostProcess=null,this._isDisposed=!0}_configureUserCreatedRTT(){this._configureUserCreatedTexture=!1,this.texture&&y_._IsRenderTargetTexture(this.texture)&&(this.texture.setMaterialForRendering(this._mesh,y_._GetShader(this._scene,this._shaderLanguage)),this.texture.onClearObservable.add((()=>{})),this.texture.renderList=[this._mesh],this._options.uvEdgeBlending&&(this._createMaskTexture(),this._createPostProcess(),this.texture.addPostProcess(this._finalPostProcess)))}_createDiffuseRTT(){this._textureCreatedInternally=!0;const e=this._createRenderTargetTexture(this._options.width,this._options.height);e.setMaterialForRendering(this._mesh,y_._GetShader(this._scene,this._shaderLanguage)),this.texture=e,this._configureUserCreatedTexture=!1,this._options.uvEdgeBlending&&(this._createMaskTexture(),this._createPostProcess(),e.addPostProcess(this._finalPostProcess))}_createMaskTexture(){this._maskTexture||(this._maskTexture=new Si.$(this._mesh.name+"_maskTexture",{width:this._options.width,height:this._options.height},this._scene,!1,!0,0,!1,2,void 0,void 0,void 0,6),this._maskTexture.clearColor=new a.ov(0,0,0,0),this._maskTexture.renderList.push(this._mesh),this._maskTexture.setMaterialForRendering(this._mesh,y_._GetMaskShader(this._scene,this._shaderLanguage)),this._maskTexture.refreshRate=Si.$.REFRESHRATE_RENDER_ONCE,this._scene.customRenderTargets.push(this._maskTexture))}_createPostProcess(){this._finalPostProcess||(this._finalPostProcess=new jt.w(this._mesh.name+"_fixSeamsPostProcess","meshUVSpaceRendererFinaliser",["textureSize"],["textureSampler","maskTextureSampler"],1,null,1,this._scene.getEngine(),!1,null,this._options.textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._finalPostProcess.onApplyObservable.add((e=>{e.setTexture("maskTextureSampler",this._maskTexture),e.setFloat2("textureSize",this._options.width,this._options.height)})))}_createRenderTargetTexture(e,t){const i=new Si.$(this._mesh.name+"_uvspaceTexture",{width:e,height:t},this._scene,this._options.generateMipMaps,!0,this._options.textureType,!1,this._options.generateMipMaps?3:2,!1,!1,!1,5);return i.renderParticles=!1,i.optimizeUVAllocation=!!this._options.optimizeUVAllocation,i.onClearObservable.addOnce((()=>{this._scene.getEngine().clear(this.clearColor,!0,!0,!0),i.onClearObservable.add((()=>{}))})),i.renderList=[this._mesh],i}_createProjectionMatrix(e,t,i,r=0){const n=-Math.atan2(t.z,t.x)-Math.PI/2,a=Math.sqrt(t.x*t.x+t.z*t.z),o=Math.atan2(t.y,a),l=e.add(t.scale(.5*i.z)),c=s.uq.RotationYawPitchRoll(n,o,r).multiply(s.uq.Translation(l.x,l.y,l.z)),h=s.uq.Invert(c),u=s.uq.FromArray([2/i.x,0,0,0,0,2/i.y,0,0,0,0,1/i.z,0,0,0,0,1]),d=s.uq.FromArray([.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1]);return h.multiply(u).multiply(d)}}var A_=i(54568),R_=i(12359);Rt.e._TrailMeshParser=(e,t)=>I_.Parse(e,t);class I_ extends Rt.e{constructor(e,t,i,r,n=60,a=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._generator=t,"object"==typeof r&&null!==r?(this.diameter=r.diameter||1,this._length=r.length||60,this._segments=r.segments?r.segments>this._length?this._length:r.segments:this._length,this._sectionPolygonPointsCount=r.sections||4,this._doNotTaper=r.doNotTaper||!1,this._autoStart=r.autoStart||!0):(this.diameter=r||1,this._length=n,this._segments=this._length,this._doNotTaper=!1,this._autoStart=a),this._sectionVectors=[],this._sectionNormalVectors=[];for(let e=0;e<=this._sectionPolygonPointsCount;e++)this._sectionVectors[e]=s.Pq.Zero(),this._sectionNormalVectors[e]=s.Pq.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){const e=new S_.P,t=[],i=[],r=[],n=[];let a=s.Pq.Zero();a=this._generator instanceof Er.u&&this._generator.hasBoundingInfo?this._generator.getBoundingInfo().boundingBox.centerWorld:this._generator.absolutePosition;const o=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<=this._sectionPolygonPointsCount;e++){const i=e!==this._sectionPolygonPointsCount?e*o:0;t.push(a.x+Math.cos(i)*this.diameter,a.y+Math.sin(i)*this.diameter,a.z),n.push(e/this._sectionPolygonPointsCount,0)}for(let e=1;e<=this._segments;e++){for(let i=0;i<=this._sectionPolygonPointsCount;i++){const r=i!==this._sectionPolygonPointsCount?i*o:0;t.push(a.x+Math.cos(r)*this.diameter,a.y+Math.sin(r)*this.diameter,a.z),n.push(i/this._sectionPolygonPointsCount,e/this._segments)}const i=t.length/3-2*(this._sectionPolygonPointsCount+1);for(let e=0;e<=this._sectionPolygonPointsCount;e++)r.push(i+e,i+e+this._sectionPolygonPointsCount,i+e+this._sectionPolygonPointsCount+1),r.push(i+e,i+e+this._sectionPolygonPointsCount+1,i+e+1)}S_.P.ComputeNormals(t,r,i),e.positions=t,e.normals=i,e.indices=r,e.uvs=n,e.applyToMesh(this,!0),this._autoStart&&this.start()}_updateSectionVectors(){const e=this._generator.getWorldMatrix(),t=2*Math.PI/this._sectionPolygonPointsCount;for(let i=0;i<=this._sectionPolygonPointsCount;i++){const r=i!==this._sectionPolygonPointsCount?i*t:0;this._sectionVectors[i].copyFromFloats(Math.cos(r)*this.diameter,Math.sin(r)*this.diameter,0),this._sectionNormalVectors[i].copyFromFloats(Math.cos(r),Math.sin(r),0),s.Pq.TransformCoordinatesToRef(this._sectionVectors[i],e,this._sectionVectors[i]),s.Pq.TransformNormalToRef(this._sectionNormalVectors[i],e,this._sectionNormalVectors[i])}}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add((()=>{this.update()})))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){const e=this.getVerticesData(Ue.R.PositionKind),t=this.getVerticesData(Ue.R.NormalKind),i=3*(this._sectionPolygonPointsCount+1);if(e&&t){if(this._doNotTaper)for(let t=i;t<e.length;t++)e[t-i]=(0,it.Lerp)(e[t-i],e[t],this._segments/this._length);else for(let r=i;r<e.length;r++)e[r-i]=(0,it.Lerp)(e[r-i],e[r],this._segments/this._length)-t[r]/this._length*this.diameter;for(let e=i;e<t.length;e++)t[e-i]=(0,it.Lerp)(t[e-i],t[e],this._segments/this._length);this._updateSectionVectors();const r=e.length-3*(this._sectionPolygonPointsCount+1);for(let i=0;i<=this._sectionPolygonPointsCount;i++)e[r+3*i]=this._sectionVectors[i].x,e[r+3*i+1]=this._sectionVectors[i].y,e[r+3*i+2]=this._sectionVectors[i].z,t[r+3*i]=this._sectionNormalVectors[i].x,t[r+3*i+1]=this._sectionNormalVectors[i].y,t[r+3*i+2]=this._sectionNormalVectors[i].z;this.updateVerticesData(Ue.R.PositionKind,e,!0,!1),this.updateVerticesData(Ue.R.NormalKind,t,!0,!1)}}reset(){const e=this.getVerticesData(Ue.R.PositionKind),t=this.getVerticesData(Ue.R.NormalKind);if(e&&t){this._updateSectionVectors();for(let i=0;i<=this._segments;i++){const r=3*i*(this._sectionPolygonPointsCount+1);for(let i=0;i<=this._sectionPolygonPointsCount;i++)e[r+3*i]=this._sectionVectors[i].x,e[r+3*i+1]=this._sectionVectors[i].y,e[r+3*i+2]=this._sectionVectors[i].z,t[r+3*i]=this._sectionNormalVectors[i].x,t[r+3*i+1]=this._sectionNormalVectors[i].y,t[r+3*i+2]=this._sectionNormalVectors[i].z}this.updateVerticesData(Ue.R.PositionKind,e,!0,!1),this.updateVerticesData(Ue.R.NormalKind,t,!0,!1)}}clone(e="",t){const i={diameter:this.diameter,length:this._length,segments:this._segments,sections:this._sectionPolygonPointsCount,doNotTaper:this._doNotTaper,autoStart:this._autoStart};return new I_(e,t??this._generator,this.getScene(),i)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){const i=t.getLastMeshById(e.generatorId)??t.getLastTransformNodeById(e.generatorId);if(!i)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);const r={diameter:e.diameter??e._diameter,length:e._length,segments:e._segments,sections:e._sectionPolygonPointsCount,doNotTaper:e._doNotTaper,autoStart:e._autoStart};return new I_(e.name,i,t,r)}}var M_,O_=i(28900),N_=i(22814),D_=i(32404);class F_{constructor(e,t,i){this.quality=e,this.distance=t,this.optimizeMesh=i}}class L_{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach((t=>{this._getSimplifier(e).simplify(t,(i=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,i),i.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()}))}));else{const t=this._getSimplifier(e),i=(i,r)=>{t.simplify(i,(t=>{void 0!==i.distance&&e.mesh.addLODLevel(i.distance,t),t.isVisible=!0,r()}))};re.LV.Run(e.settings.length,(t=>{i(e.settings[t.index],(()=>{t.executeNext()}))}),(()=>{e.successCallback&&e.successCallback(),this.executeNext()}))}}_getSimplifier(e){return e.simplificationType,new G_(e.mesh)}}!function(e){e[e.QUADRATIC=0]="QUADRATIC"}(M_||(M_={}));class w_{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class B_{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new V_,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class V_{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,n,s,a,o,l){return this.data[e]*this.data[n]*this.data[l]+this.data[i]*this.data[r]*this.data[o]+this.data[t]*this.data[s]*this.data[a]-this.data[i]*this.data[n]*this.data[a]-this.data[e]*this.data[s]*this.data[o]-this.data[t]*this.data[r]*this.data[l]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new V_;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new V_(V_.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}}class k_{constructor(e,t){this.vertexId=e,this.triangleId=t}}class G_{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=Ee.bH}simplify(e,t){this._initDecimatedMesh(),re.LV.Run(this._mesh.subMeshes.length,(t=>{this._initWithMesh(t.index,(()=>{this._runDecimation(e,t.index,(()=>{t.executeNext()}))}),e.optimizeMesh)}),(()=>{setTimeout((()=>{t(this._reconstructedMesh)}),0)}))}_runDecimation(e,t,i){const r=~~(this._triangles.length*e.quality);let n=0;const a=this._triangles.length,o=(e,t)=>{setTimeout((()=>{e%5==0&&this._updateMesh(0===e);for(let e=0;e<this._triangles.length;++e)this._triangles[e].isDirty=!1;const i=1e-9*Math.pow(e+3,this.aggressiveness);re.LV.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=~~((this._triangles.length/2+e)%this._triangles.length),r=this._triangles[t];if(r&&!(r.error[3]>i||r.deleted||r.isDirty))for(let e=0;e<3;++e)if(r.error[e]<i){const t=[],i=[],a=r._vertices[e],o=r._vertices[(e+1)%3];if(a.isBorder||o.isBorder)continue;const l=s.Pq.Zero();this._calculateError(a,o,l);const c=[];if(this._isFlipped(a,o,l,t,c))continue;if(this._isFlipped(o,a,l,i,c))continue;if(t.indexOf(!0)<0||i.indexOf(!0)<0)continue;const h=[];if(c.forEach((e=>{-1===h.indexOf(e)&&(e.deletePending=!0,h.push(e))})),h.length%2!=0)continue;a.q=o.q.add(a.q),a.updatePosition(l);const u=this._references.length;n=this._updateTriangles(a,a,t,n),n=this._updateTriangles(a,o,i,n);const d=this._references.length-u;if(d<=a.triangleCount){if(d)for(let e=0;e<d;e++)this._references[a.triangleStart+e]=this._references[u+e]}else a.triangleStart=u;a.triangleCount=d;break}}),t,(()=>a-n<=r))}),0)};re.LV.Run(this.decimationIterations,(e=>{a-n<=r?e.breakLoop():o(e.index,(()=>{e.executeNext()}))}),(()=>{setTimeout((()=>{this._reconstructMesh(t),i()}),0)}))}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const r=this._mesh.getVerticesData(Ue.R.PositionKind),n=this._mesh.getIndices(),a=this._mesh.subMeshes[e],o=e=>{if(i)for(let t=0;t<this._vertices.length;++t)if(this._vertices[t].position.equalsWithEpsilon(e,1e-4))return this._vertices[t];return null},l=[],c=a.verticesCount;re.LV.SyncAsyncForLoop(c,this.syncIterations/4|0,(e=>{if(!r)return;const t=e+a.verticesStart,i=s.Pq.FromArray(r,3*t),n=o(i)||new B_(i,this._vertices.length);n.originalOffsets.push(t),n.id===this._vertices.length&&this._vertices.push(n),l.push(n.id)}),(()=>{re.LV.SyncAsyncForLoop(a.indexCount/3,this.syncIterations,(e=>{if(!n)return;const t=3*(a.indexStart/3+e),i=n[t+0],r=n[t+1],s=n[t+2],o=this._vertices[l[i-a.verticesStart]],c=this._vertices[l[r-a.verticesStart]],h=this._vertices[l[s-a.verticesStart]],u=new w_([o,c,h]);u.originalOffset=t,this._triangles.push(u)}),(()=>{this._init(t)}))}))}_init(e){re.LV.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];t.normal=s.Pq.Cross(t._vertices[1].position.subtract(t._vertices[0].position),t._vertices[2].position.subtract(t._vertices[0].position)).normalize();for(let e=0;e<3;e++)t._vertices[e].q.addArrayInPlace(V_.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-s.Pq.Dot(t.normal,t._vertices[0].position)))}),(()=>{re.LV.SyncAsyncForLoop(this._triangles.length,this.syncIterations,(e=>{const t=this._triangles[e];for(let e=0;e<3;++e)t.error[e]=this._calculateError(t._vertices[e],t._vertices[(e+1)%3]);t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])}),(()=>{e()}))}))}_reconstructMesh(e){const t=[];let i,r,n;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(r=this._triangles[i],n=0;n<3;++n)r._vertices[n].triangleCount=1;t.push(r)}const s=this._reconstructedMesh.getVerticesData(Ue.R.PositionKind)||[],a=this._reconstructedMesh.getVerticesData(Ue.R.NormalKind)||[],o=this._reconstructedMesh.getVerticesData(Ue.R.UVKind)||[],l=this._reconstructedMesh.getVerticesData(Ue.R.ColorKind)||[],c=this._mesh.getVerticesData(Ue.R.NormalKind),h=this._mesh.getVerticesData(Ue.R.UVKind),u=this._mesh.getVerticesData(Ue.R.ColorKind);let d=0;for(i=0;i<this._vertices.length;++i){const e=this._vertices[i];e.id=d,e.triangleCount&&e.originalOffsets.forEach((t=>{s.push(e.position.x),s.push(e.position.y),s.push(e.position.z),c&&c.length&&(a.push(c[3*t]),a.push(c[3*t+1]),a.push(c[3*t+2])),h&&h.length&&(o.push(h[2*t]),o.push(h[2*t+1])),u&&u.length&&(l.push(u[4*t]),l.push(u[4*t+1]),l.push(u[4*t+2]),l.push(u[4*t+3])),++d}))}const p=this._reconstructedMesh.getTotalIndices(),f=this._reconstructedMesh.getTotalVertices(),m=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const _=this._reconstructedMesh.getIndices(),g=this._mesh.getIndices();for(i=0;i<t.length;++i)r=t[i],[0,1,2].forEach((e=>{const t=g[r.originalOffset+e];let i=r._vertices[e].originalOffsets.indexOf(t);i<0&&(i=0),_.push(r._vertices[e].id+i+f)}));this._reconstructedMesh.setIndices(_),this._reconstructedMesh.setVerticesData(Ue.R.PositionKind,s),a.length>0&&this._reconstructedMesh.setVerticesData(Ue.R.NormalKind,a),o.length>0&&this._reconstructedMesh.setVerticesData(Ue.R.UVKind,o),l.length>0&&this._reconstructedMesh.setVerticesData(Ue.R.ColorKind,l);const v=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],m.forEach((e=>{lc.K.AddToMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())})),lc.K.AddToMesh(v.materialIndex,f,d,p,3*t.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new Rt.e(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,n){for(let a=0;a<e.triangleCount;++a){const o=this._triangles[this._references[e.triangleStart+a].triangleId];if(o.deleted)continue;const l=this._references[e.triangleStart+a].vertexId,c=o._vertices[(l+1)%3],h=o._vertices[(l+2)%3];if(c===t||h===t){r[a]=!0,n.push(o);continue}let u=c.position.subtract(i);u=u.normalize();let d=h.position.subtract(i);if(d=d.normalize(),Math.abs(s.Pq.Dot(u,d))>.999)return!0;const p=s.Pq.Cross(u,d).normalize();if(r[a]=!1,s.Pq.Dot(p,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,r){let n=r;for(let r=0;r<t.triangleCount;++r){const s=this._references[t.triangleStart+r],a=this._triangles[s.triangleId];a.deleted||(i[r]&&a.deletePending?(a.deleted=!0,n++):(a._vertices[s.vertexId]=e,a.isDirty=!0,a.error[0]=this._calculateError(a._vertices[0],a._vertices[1])+a.borderFactor/2,a.error[1]=this._calculateError(a._vertices[1],a._vertices[2])+a.borderFactor/2,a.error[2]=this._calculateError(a._vertices[2],a._vertices[0])+a.borderFactor/2,a.error[3]=Math.min(a.error[0],a.error[1],a.error[2]),this._references.push(s)))}return n}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],r=this._vertices[e];let n;for(n=0;n<r.triangleCount;++n){const e=this._triangles[this._references[r.triangleStart+n].triangleId];for(let r=0;r<3;r++){let n=0;const s=e._vertices[r];for(;n<t.length&&i[n]!==s.id;)++n;n===t.length?(t.push(1),i.push(s.id)):t[n]++}}for(n=0;n<t.length;++n)1===t[n]?this._vertices[i[n]].isBorder=!0:this._vertices[i[n]].isBorder=!1}}_updateMesh(e=!1){let t,i,r,n;if(!e){const e=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||e.push(this._triangles[t]);this._triangles=e}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)n=i._vertices[r],n.triangleCount++;let s=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=s,s+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const a=new Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)n=i._vertices[r],a[n.triangleStart+n.triangleCount]=new k_(r,t),n.triangleCount++;this._references=a,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,r=t.y,n=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*n+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*n+2*e.data[6]*r+e.data[7]*n*n+2*e.data[8]*n+e.data[9]}_calculateError(e,t,i){const r=e.q.add(t.q),n=e.isBorder&&t.isBorder;let a=0;const o=r.det(0,1,2,1,4,5,2,5,7);if(0===o||n){const n=e.position.add(t.position).divide(new s.Pq(2,2,2)),o=this._vertexError(r,e.position),l=this._vertexError(r,t.position),c=this._vertexError(r,n);a=Math.min(o,l,c),a===o?i&&i.copyFrom(e.position):a===l?i&&i.copyFrom(t.position):i&&i.copyFrom(n)}else i||(i=s.Pq.Zero()),i.x=-1/o*r.det(1,2,3,4,5,6,5,7,8),i.y=1/o*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*r.det(0,1,3,1,4,6,2,5,8),a=this._vertexError(r,i);return a}}Object.defineProperty(kt.Z.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new L_;let e=this._getComponent(Gt.v.NAME_SIMPLIFICATIONQUEUE);e||(e=new U_(this),this._addComponent(e))}return this._simplificationQueue},set:function(e){this._simplificationQueue=e},enumerable:!0,configurable:!0}),Rt.e.prototype.simplify=function(e,t=!0,i=0,r){return this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:t,mesh:this,simplificationType:i,successCallback:r}),this};class U_{constructor(e){this.name=Gt.v.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(Gt.v.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}function z_(e){const t=e.minimum.x,i=e.minimum.y,r=e.minimum.z,n=e.maximum.x,a=e.maximum.y,o=e.maximum.z;return[new s.Pq(t,i,r),new s.Pq(n,a,o),new s.Pq(n,i,r),new s.Pq(t,a,r),new s.Pq(t,i,o),new s.Pq(n,a,r),new s.Pq(t,a,o),new s.Pq(n,i,o)]}function W_(e,t=null,i=1/6){const r=s.AA.Vector3[0],n=new Map,a=new Map,o=e.reduce(((e,t)=>Math.max(e,t.getTotalVertices())),0),l=Array.from({length:o},(()=>new s.Pq)),c=Array.from({length:o},(()=>new s.Pq));for(const t of e){const e=t.getVerticesData(Ue.R.PositionKind);if(!e)continue;const i=t.getTotalVertices();l.length=Math.max(l.length,i),c.length=Math.max(l.length,i);for(let t=0,n=0;t<i;t++,n+=3)r.set(e[n],e[n+1],e[n+2]),l[t].copyFrom(r),c[t].copyFrom(r);const o=t.morphTargetManager;if(o)for(let e=0;e<o.numTargets;++e){const t=o.getTarget(e).getPositions();if(t)for(let e=0,n=0;e<i;e++,n+=3)r.set(t[n],t[n+1],t[n+2]),l[e].minimizeInPlace(r),c[e].maximizeInPlace(r)}const h=t.skeleton,u=h?t.getVerticesData(Ue.R.MatricesWeightsKind):null,d=h?t.getVerticesData(Ue.R.MatricesIndicesKind):null;if(u&&d){const e=t.numBoneInfluencers>4,r=e?t.getVerticesData(Ue.R.MatricesWeightsExtraKind):null,n=e?t.getVerticesData(Ue.R.MatricesIndicesExtraKind):null,s=a.get(t.uniqueId)||new Map;a.set(t.uniqueId,s);const o=(e,t,i,r)=>{for(let n=t;n<t+4;n++)if(i[n]>0){const t=r[n],i=s.get(t);i?(i.minimum.minimizeInPlace(l[e]),i.maximum.maximizeInPlace(c[e])):s.set(t,{minimum:l[e].clone(),maximum:c[e].clone()})}};for(let e=0,t=0;e<i;e++,t+=4)o(e,t,u,d),r&&n&&o(e,t,r,n)}else{const e=n.get(t.uniqueId)||{minimum:(new s.Pq).setAll(Number.POSITIVE_INFINITY),maximum:(new s.Pq).setAll(Number.NEGATIVE_INFINITY)};n.set(t.uniqueId,e);for(let t=0;t<i;t++)e.minimum.minimizeInPlace(l[t]),e.maximum.maximizeInPlace(c[t])}}const h=new Map,u=new Map;for(const t of e){const e=n.get(t.uniqueId);if(e)h.set(t.uniqueId,z_(e));else{const e=a.get(t.uniqueId);if(e){const i=t.skeleton.bones,r=new Map;u.set(t.uniqueId,r),e.forEach(((e,t)=>{const n=z_(e),a=i[t].getAbsoluteInverseBindMatrix();for(const e of n)s.Pq.TransformCoordinatesToRef(e,a,e);r.set(t,n)}))}}}const d=Array.from({length:e.length},(()=>({minimum:(new s.Pq).setAll(Number.POSITIVE_INFINITY),maximum:(new s.Pq).setAll(Number.NEGATIVE_INFINITY)}))),p=()=>{for(let t=0;t<e.length;t++){const i=e[t];if(!i.getVerticesData(Ue.R.PositionKind))continue;const n=i.computeWorldMatrix(!0),a=i.skeleton;if(a){a.prepare(!0);const e=a.bones;u.get(i.uniqueId).forEach(((i,a)=>{for(const o of i){const i=e[a].getFinalMatrix().multiplyToRef(n,s.AA.Matrix[0]);s.Pq.TransformCoordinatesToRef(o,i,r),d[t].minimum.minimizeInPlace(r),d[t].maximum.maximizeInPlace(r)}}))}else for(const e of h.get(i.uniqueId))s.Pq.TransformCoordinatesToRef(e,n,r),d[t].minimum.minimizeInPlace(r),d[t].maximum.maximizeInPlace(r)}};if(t&&t.isStarted){const e=t.getCurrentFrame(),r=i/t.getLength(0,1);for(let e=t.from;e<=t.to;e+=r)t.goToFrame(e),p();t.goToFrame(e)}else p();return d}var H_=i(64883),Y_=i(43425);class X_{getClassName(){return"Lattice"}get resolutionX(){return this._resolutionX}get resolutionY(){return this._resolutionY}get resolutionZ(){return this._resolutionZ}get size(){return this._size}get position(){return this._position}get data(){return this._data}get cellSize(){return this._cellSize}get min(){return this._min}get max(){return this._max}constructor(e){this._cellSize=new s.Pq,this._min=new s.Pq(-.5,-.5,-.5),this._max=new s.Pq(.5,.5,.5),this._localPos=new s.Pq,this._tmpVector=new s.Pq,this._lerpVector0=new s.Pq,this._lerpVector1=new s.Pq,this._lerpVector2=new s.Pq,this._lerpVector3=new s.Pq,this._lerpVector4=new s.Pq,this._lerpVector5=new s.Pq;const t={resolutionX:3,resolutionY:3,resolutionZ:3,position:s.Pq.Zero(),size:s.Pq.One(),...e};this._resolutionX=t.resolutionX,this._resolutionY=t.resolutionY,this._resolutionZ=t.resolutionZ,this._position=t.position,this._size=t.autoAdaptToMesh?t.autoAdaptToMesh.getBoundingInfo().boundingBox.extendSize.scale(2):t.size,this._allocateData(),this.update()}_allocateData(){this._data=new Array(this.resolutionX);for(let e=0;e<this.resolutionX;e++){this._data[e]=new Array(this.resolutionY);for(let t=0;t<this.resolutionY;t++){this._data[e][t]=new Array(this.resolutionZ);for(let i=0;i<this.resolutionZ;i++)this._data[e][t][i]=s.Pq.Zero()}}}update(){for(let e=0;e<this.resolutionX;e++)for(let t=0;t<this.resolutionY;t++)for(let i=0;i<this.resolutionZ;i++){const r=-this.size.x/2+this.size.x*(e/(this.resolutionX-1)),n=-this.size.y/2+this.size.y*(t/(this.resolutionY-1)),s=-this.size.z/2+this.size.z*(i/(this.resolutionZ-1));this._data[e][t][i].set(r,n,s)}}deformMesh(e){const t=e.getVerticesData(rr.R.PositionKind);t&&(this.deform(t),e.setVerticesData(rr.R.PositionKind,t,!0))}updateInternals(){const e=this._resolutionX,t=this._resolutionY,i=this._resolutionZ;this._cellSize.set(this.size.x/(e-1),this.size.y/(t-1),this.size.z/(i-1)),this._min.set(this.position.x-this.size.x/2,this.position.y-this.size.y/2,this.position.z-this.size.z/2),this._min.addToRef(this._size,this._max)}deform(e,t){const i=this._resolutionX,r=this._resolutionY,n=this._resolutionZ;this.updateInternals();const a=this._min,o=this._max;for(let l=0;l<e.length;l+=3){const c=this._tmpVector.fromArray(e,l);if(c.x<a.x||c.x>o.x||c.y<a.y||c.y>o.y||c.z<a.z||c.z>o.z){t&&c.toArray(t,l);continue}const h=this._localPos.set((c.x-a.x)/this._cellSize.x,(c.y-a.y)/this._cellSize.y,(c.z-a.z)/this._cellSize.z),u=Math.floor(h.x),d=Math.floor(h.y),p=Math.floor(h.z),f=Math.min(u+1,i-1),m=Math.min(d+1,r-1),_=Math.min(p+1,n-1),g=h.x-u,v=h.y-d,S=h.z-p,x=(0,it.Clamp)(u,0,i-1),T=(0,it.Clamp)(d,0,r-1),E=(0,it.Clamp)(p,0,n-1),C=(0,it.Clamp)(f,0,i-1),b=(0,it.Clamp)(m,0,r-1),P=(0,it.Clamp)(_,0,n-1),y=this._data[x][T][E],A=this._data[C][T][E],R=this._data[x][b][E],I=this._data[C][b][E],M=this._data[x][T][P],O=this._data[C][T][P],N=this._data[x][b][P],D=this._data[C][b][P],F=s.Pq.LerpToRef(y,A,g,this._lerpVector0),L=s.Pq.LerpToRef(M,O,g,this._lerpVector1),w=s.Pq.LerpToRef(R,I,g,this._lerpVector2),B=s.Pq.LerpToRef(N,D,g,this._lerpVector3),V=s.Pq.LerpToRef(F,w,v,this._lerpVector4),k=s.Pq.LerpToRef(L,B,v,this._lerpVector5),G=s.Pq.LerpToRef(V,k,S,this._lerpVector0);G.addInPlace(this.position),G.toArray(t||e,l)}}}class q_ extends Mm.y{constructor(e,t){super(t,"Lattice",200),this._lattice=e,this.refreshData(),this._enable(!0)}getClassName(){return"LatticePluginMaterial"}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}refreshData(){const e=this._lattice.resolutionX*this._lattice.resolutionY*this._lattice.resolutionZ*4;this._latticeData&&this._latticeData.length===e||(this._latticeData=new Float32Array(e));for(let e=0;e<this._lattice.resolutionX;e++)for(let t=0;t<this._lattice.resolutionY;t++)for(let i=0;i<this._lattice.resolutionZ;i++){const r=this._lattice.data[e][t][i],n=e+this._lattice.resolutionX*(t+this._lattice.resolutionY*i);r.toArray(this._latticeData,4*n)}this._latticeDataTexture&&this._latticeDataTexture.width===this._lattice.resolutionX&&this._latticeDataTexture.height===this._lattice.resolutionY&&this._latticeDataTexture.depth===this._lattice.resolutionZ?this._latticeDataTexture.update(this._latticeData):(this._latticeDataTexture&&this._latticeDataTexture.dispose(),this._latticeDataTexture=new ld(this._latticeData,this._lattice.resolutionX,this._lattice.resolutionY,this._lattice.resolutionZ,5,this._material.getScene(),!1,!1,1,1))}getUniforms(e=0){return 1===e?{ubo:[{name:"lattice_cellSize",size:3,type:"vec3"},{name:"lattice_min",size:3,type:"vec3"},{name:"lattice_max",size:3,type:"vec3"},{name:"lattice_resolution",size:3,type:"vec3"},{name:"lattice_position",size:3,type:"vec3"}]}:{ubo:[{name:"lattice_cellSize",size:3,type:"vec3"},{name:"lattice_min",size:3,type:"vec3"},{name:"lattice_max",size:3,type:"vec3"},{name:"lattice_resolution",size:3,type:"vec3"},{name:"lattice_position",size:3,type:"vec3"}],vertex:"\n                    uniform vec3 lattice_cellSize;\n                    uniform vec3 lattice_min;\n                    uniform vec3 lattice_max;\n                    uniform vec3 lattice_resolution;\n                    uniform vec3 lattice_position;\n                    "}}bindForSubMesh(e){this._lattice.updateInternals(),e.updateVector3("lattice_cellSize",this._lattice.cellSize),e.updateVector3("lattice_min",this._lattice.min),e.updateVector3("lattice_max",this._lattice.max),e.updateFloat3("lattice_resolution",this._lattice.resolutionX,this._lattice.resolutionY,this._lattice.resolutionZ),e.updateVector3("lattice_position",this._lattice.position),e.setTexture("latticeData",this._latticeDataTexture)}getSamplers(e){e.push("latticeData")}_prepareCode(e=0){if(this._code)return this._code;let t="\n            if (positionUpdated.x >= lattice_min.x && positionUpdated.x <= lattice_max.x &&\n                positionUpdated.y >= lattice_min.y && positionUpdated.y <= lattice_max.y &&\n                positionUpdated.z >= lattice_min.z && positionUpdated.z <= lattice_max.z) {\n\n                // Map vertex position to lattice local coordinates\n                vec3d localPos = vec3c((positionUpdated.x - lattice_min.x) / lattice_cellSize.x, (positionUpdated.y - lattice_min.y) / lattice_cellSize.y, (positionUpdated.z - lattice_min.z) / lattice_cellSize.z);\n\n                // Get integer lattice indices\n                intd i0 = intc(floor(localPos.x));\n                intd j0 = intc(floor(localPos.y));\n                intd k0 = intc(floor(localPos.z));\n\n                intd resX = intc(lattice_resolution.x) - 1;\n                intd resY = intc(lattice_resolution.y) - 1;\n                intd resZ = intc(lattice_resolution.z) - 1;\n\n                intd i1 = min(i0 + 1, resX);\n                intd j1 = min(j0 + 1, resY);\n                intd k1 = min(k0 + 1, resZ);\n\n                // Compute interpolation weights\n                floatd tx = localPos.x - floatc(i0);\n                floatd ty = localPos.y - floatc(j0);\n                floatd tz = localPos.z - floatc(k0);\n\n                // Ensure indices are within bounds\n                intd ii0 = clamp(i0, 0, resX);\n                intd jj0 = clamp(j0, 0, resY);\n                intd kk0 = clamp(k0, 0, resZ);\n                intd ii1 = clamp(i1, 0, resX);\n                intd jj1 = clamp(j1, 0, resY);\n                intd kk1 = clamp(k1, 0, resZ);\n\n                // Get lattice control points\n                vec3d p000 = texelFetch(latticeData, ivec3c(ii0, jj0, kk0), 0).rgb;\n                vec3d p100 = texelFetch(latticeData, ivec3c(ii1, jj0, kk0), 0).rgb;\n                vec3d p010 = texelFetch(latticeData, ivec3c(ii0, jj1, kk0), 0).rgb;\n                vec3d p110 = texelFetch(latticeData, ivec3c(ii1, jj1, kk0), 0).rgb;\n                vec3d p001 = texelFetch(latticeData, ivec3c(ii0, jj0, kk1), 0).rgb;\n                vec3d p101 = texelFetch(latticeData, ivec3c(ii1, jj0, kk1), 0).rgb;\n                vec3d p011 = texelFetch(latticeData, ivec3c(ii0, jj1, kk1), 0).rgb;\n                vec3d p111 = texelFetch(latticeData, ivec3c(ii1, jj1, kk1), 0).rgb;\n\n                // Trilinear interpolation\n                vec3d p00 = mix(p000, p100, tx);\n                vec3d p01 = mix(p001, p101, tx);\n                vec3d p10 = mix(p010, p110, tx);\n                vec3d p11 = mix(p011, p111, tx);\n\n                vec3d p0 = mix(p00, p10, ty);\n                vec3d p1 = mix(p01, p11, ty);\n\n                vec3d deformedPos = mix(p0, p1, tz);\n                positionUpdated = deformedPos + lattice_position;\n            };\n        ";return 1===e?(t="\n                let lattice_min = uniforms.lattice_min;\n                let lattice_max = uniforms.lattice_max;\n                let lattice_resolution = uniforms.lattice_resolution;\n                let lattice_position = uniforms.lattice_position;\n                let lattice_cellSize = uniforms.lattice_cellSize;\n            "+t,t=t.replace(/ivec3c/g,"vec3i"),t=t.replace(/vec3d/g,"var"),t=t.replace(/vec3c/g,"vec3f"),t=t.replace(/intd/g,"var"),t=t.replace(/intc/g,"i32"),t=t.replace(/floatd/g,"var"),t=t.replace(/floatc/g,"f32"),t=t.replace(/texelFetch/g,"textureLoad")):(t=t.replace(/ivec3c/g,"ivec3"),t=t.replace(/vec3d/g,"vec3"),t=t.replace(/vec3c/g,"vec3"),t=t.replace(/intd/g,"int"),t=t.replace(/intc/g,"int"),t=t.replace(/floatd/g,"float"),t=t.replace(/floatc/g,"float")),this._code=t,this._code}getCustomCode(e,t=0){return"vertex"===e?1===t?{CUSTOM_VERTEX_DEFINITIONS:"\n                        var latticeData: texture_3d<f32>;\n                    ",CUSTOM_VERTEX_UPDATE_POSITION:this._prepareCode(t)}:{CUSTOM_VERTEX_DEFINITIONS:"\n                    precision highp sampler3D;\n                    uniform sampler3D latticeData;\n                ",CUSTOM_VERTEX_UPDATE_POSITION:this._prepareCode(t)}:null}dispose(){this._latticeDataTexture&&(this._latticeDataTexture.dispose(),this._latticeDataTexture=null)}}var $_,j_,K_,Z_,Q_,J_=i(74180),eg=i(38585),tg=i(60838),ig=i(81699),rg=i(90044),ng=i(32725),sg=i(86840),ag=i(57088),og=i(18280),lg=i(26135),cg=i(80098),hg=i(94661),ug=i(86795);!function(e){e[e.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",e[e.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS"}($_||($_={})),function(e){e[e.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",e[e.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",e[e.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED"}(j_||(j_={})),function(e){e[e.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",e[e.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",e[e.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",e[e.AUTO_DIRECTIONS_FACE_TO=3]="AUTO_DIRECTIONS_FACE_TO",e[e.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE"}(K_||(K_={}));class dg extends Rt.e{constructor(e,t,i){super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=i.lazy??!1,this._updatable=i.updatable??!1,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=i.colorPointers??[],this._widths=i.widths??new Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(const e of this._points)t+=e.length;const i=t/3*2-this._widths.length;for(let t=0;t<i;t++)this._widths.push(e)}updateLazy(){this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(this._options.ribbonOptions?.smoothShading),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo(),this.greasedLineMaterial?.updateLazy()}addPoints(e,t){for(const t of e)this._points.push(t);this._lazy||this.setPoints(this._points,t)}dispose(e,t=!1){super.dispose(e,t)}isLazy(){return this._lazy}get uvs(){return this._uvs}set uvs(e){this._uvs=e instanceof Float32Array?e:new Float32Array(e),this._createVertexBuffers()}get offsets(){return this._offsets}set offsets(e){this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){if(this.material&&this.material instanceof $m)return this.material;const e=this.material?.pluginManager?.getPlugin(qm.GREASED_LINE_MATERIAL_NAME);return e||void 0}get points(){const e=[];return y.r.DeepCopy(this._points,e),e}setPoints(e,t){this._points=Ym.ConvertPoints(e,t?.pointsOptions??this._options.pointsOptions),this._updateWidths(),t?.colorPointers||this._updateColorPointers(),this._setPoints(this._points,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){const t=new S_.P;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],S_.P.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){const t=this._scene.getEngine(),i=new Ue.h(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}Rt.e._GreasedLineMeshParser=(e,t)=>pg.Parse(e,t);class pg extends dg{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(Ym.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[],this._points.forEach((t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)}))}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,n=0,s=0;e.forEach((e=>{i+=2*e.length,r+=2*(e.length-3),n+=4*e.length/3,s+=8*e.length/3}));const a=new Float32Array(i),o=i>65535?new Uint32Array(r):new Uint16Array(r),l=new Float32Array(n),c=new Float32Array(s),h=new Float32Array(s);let u=0,d=0,p=0,f=0,m=0;e.forEach((e=>{const i=Ym.GetLineLengthArray(e),r=i[i.length-1];for(let i=0,r=0;r<e.length;i++,r+=3){const n=u+2*r;if(a[n+0]=e[r+0],a[n+1]=e[r+1],a[n+2]=e[r+2],a[n+3]=e[r+0],a[n+4]=e[r+1],a[n+5]=e[r+2],r<e.length-3){const e=2*i+t,n=d+2*r;o[n+0]=e,o[n+1]=e+1,o[n+2]=e+2,o[n+3]=e+2,o[n+4]=e+1,o[n+5]=e+3}}t+=e.length/3*2;const n=2*e.length,s=a.subarray(u,u+n);u+=n,d+=2*(e.length-3);const _=new Float32Array(s.length),g=new Float32Array(s.length),v=s.length/6;let S;S=pg._CompareV3(0,v-1,s)?s.subarray(6*(v-2),6*(v-1)):s.subarray(0,6),_.set(S),_.set(s.subarray(0,s.length-6),6),g.set(s.subarray(6)),S=pg._CompareV3(v-1,0,s)?s.subarray(6,12):s.subarray(6*(v-1),6*v),g.set(S,g.length-6);for(let e=0,t=s.length/3;e<t;e++)c[f++]=_[3*e],c[f++]=_[3*e+1],c[f++]=_[3*e+2],c[f++]=1-((1&e)<<1),h[m++]=g[3*e],h[m++]=g[3*e+1],h[m++]=g[3*e+2],h[m++]=i[e>>1]/r;if(this._options.uvs)for(let e=0;e<this._options.uvs.length;e++)l[p++]=this._options.uvs[e];else for(let e=0;e<v;e++){const t=i[e]/r,n=p+4*e;l[n+0]=t,l[n+1]=0,l[n+2]=t,l[n+3]=1}})),this._vertexPositions=a,this._indices=o,this._uvs=l,this._previousAndSide=c,this._nextAndCounters=h,this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={};y.r.DeepCopy(i,r,["instance"],void 0,!0);const n=new pg(e,this._scene,r);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){const i=e.lineOptions,r=e.name;return new pg(r,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,n,s=!1){const a=new Ji.G,o=this.findAllIntersections(e,t,i,r,n,s,!0);if(1===o?.length){const t=o[0];a.hit=!0,a.distance=t.distance,a.ray=e,a.pickedMesh=this,a.pickedPoint=t.point}return a}findAllIntersections(e,t,i,r=!1,n,s=!1,a=!1){if(r&&!s&&!1===e.intersectsSphere(this._boundingSphere,this.intersectionThreshold))return;const o=this.getIndices(),l=this.getVerticesData(Ue.R.PositionKind),c=this._widths,h=this.greasedLineMaterial?.width??1,u=[];if(o&&l&&c){let t=0,i=0;for(t=0,i=o.length-1;t<i;t+=3){const i=o[t],r=o[t+1];pg._V_START.fromArray(l,3*i),pg._V_END.fromArray(l,3*r),this._offsets&&(pg._V_OFFSET_START.fromArray(this._offsets,3*i),pg._V_OFFSET_END.fromArray(this._offsets,3*r),pg._V_START.addInPlace(pg._V_OFFSET_START),pg._V_END.addInPlace(pg._V_OFFSET_END));const n=Math.floor(t/3),s=void 0!==c[n]?c[n]:1,d=this.intersectionThreshold*(h*s)/2,p=e.intersectionSegment(pg._V_START,pg._V_END,d);if(-1!==p&&(u.push({distance:p,point:e.direction.normalize().multiplyByFloats(p,p,p).add(e.origin)}),a))return u}t=i}return u}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){const r=6*e,n=6*t;return i[r]===i[n]&&i[r+1]===i[n+1]&&i[r+2]===i[n+2]}_createVertexBuffers(){const e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new Ue.h(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));const r=new Ue.h(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));const n=new Ue.h(t,this._widths,this._updatable,1);this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n;const s=new Ue.h(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(s.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=s,e}}pg._V_START=new s.Pq,pg._V_END=new s.Pq,pg._V_OFFSET_START=new s.Pq,pg._V_OFFSET_END=new s.Pq,Rt.e._GreasedLineRibbonMeshParser=(e,t)=>fg.Parse(e,t);class fg extends dg{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(Ym.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){const{options:i,pathCount:r}=this._pathsOptions[t],n=this._points[t];if(0===i.ribbonOptions.pointsMode)for(let t=0;t<r;t++)for(let t=0;t<n.length;t+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let t=0;t<n.length;t+=3){for(let t=0;t<r;t++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let i,r=0;for(let t=0,n=0;t<this._pathsOptions.length;t++){const{options:s,pathCount:a}=this._pathsOptions[t],o=e.slice(n,n+a);if(n+=a,1===s.ribbonOptions?.pointsMode)r=this._preprocess(Ym.ToVector3Array(o),r,s);else{if(99===s.ribbonOptions?.directionsAutoMode){if(!s.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";i=fg._GetDirectionPlanesFromDirectionsOption(o.length,s.ribbonOptions.directions)}o.forEach(((e,t)=>{const n=fg._ConvertToRibbonPath(e,s.ribbonOptions,this._scene.useRightHandedSystem,i?i[t]:i);r=this._preprocess(n,r,s)}))}}this._lazy||(this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:new Array(e).fill(t)}static _CreateRibbonVertexData(e,t){const i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";const r=[],n=[],s=e[0];for(let t=0;t<s.length;t++)for(let i=0;i<e.length;i++){const n=e[i][t];r.push(n.x,n.y,n.z)}const a=[1,0,i],o=2===t.ribbonOptions?.facesMode??!1,l=1===t.ribbonOptions?.pointsMode&&t.ribbonOptions.closePath;if(i>2)for(let e=0;e<s.length-1;e++){a[0]=1+i*e,a[1]=i*e,a[2]=(e+1)*i;for(let e=0;e<2*(i-1);e++)e%2!=0&&(a[2]+=1),e%2==0&&e>0&&(a[0]+=1,a[1]+=1),n.push(a[1]+(e%2!=0?i:0),a[0],a[2]),o&&n.push(a[0],a[1]+(e%2!=0?i:0),a[2])}else for(let e=0;e<r.length/3-3;e+=2)n.push(e,e+1,e+2),n.push(e+2,e+1,e+3),o&&(n.push(e+1,e,e+2),n.push(e+1,e+2,e+3));if(l){let e=i*(s.length-1);for(let t=0;t<i-1;t++)n.push(e,t+1,t),n.push(e+1,t+1,e),o&&(n.push(t,t+1,e),n.push(e,t+1,e+1)),e++}return{positions:r,indices:n}}_preprocess(e,t,i){this._paths=e;const r=fg._CreateRibbonVertexData(e,i),n=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";const s=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=s;const a=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=a;const o=Array.isArray(this._indices)?this._indices:Array.from(this._indices);this._indices=o;for(const e of n)s.push(e);let l=e;if(1===i.ribbonOptions?.pointsMode&&i.ribbonOptions.closePath){l=[];for(let t=0;t<e.length;t++){const i=e[t].slice();i.push(e[t][0].clone()),l.push(i)}}this._calculateSegmentLengths(l);const c=l.length,h=new Array(c).fill(0);for(let e=0;e<l[0].length;e++){let t=0;for(let i=0;i<c;i++){const r=h[i]+this._vSegmentLengths[i][e]/this._vTotalLengths[i];this._counters.push(r),a.push(r,t),h[i]=r,t+=this._uSegmentLengths[e][i]/this._uTotalLengths[e]}}for(let e=0,t=0;e<l[0].length;e++){const i=this._uSegmentLengths[e][0]/2,r=this._uSegmentLengths[e][c-1]/2;this._ribbonWidths.push(((this._widths[t++]??1)-1)*i);for(let e=0;e<c-2;e++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[t++]??1)-1)*r)}const u=1===i.ribbonOptions?.pointsMode?new Array(l[0].length*l.length*6).fill(0):fg._CalculateSlopes(l);for(const e of u)this._slopes.push(e);if(r.indices)for(let e=0;e<r.indices.length;e++)o.push(r.indices[e]+t);return t+n.length/3}static _ConvertToRibbonPath(e,t,i,r){if(0===t.pointsMode&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";const n=[],a=[];if(0===t.pointsMode){const o=t.width/2,l=Ym.ToVector3Array(e);let c=null,h=null;if(0===t.directionsAutoMode&&(r=fg._GetDirectionFromPoints(l[0],l[1],null)),3===t.directionsAutoMode&&!(t.directions instanceof s.Pq))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";s.AA.Vector3[1]=t.directions instanceof s.Pq?t.directions:fg.DIRECTION_XZ;for(let e=0;e<l.length-(r?0:1);e++){const u=l[e],d=l[e+1];if(r)c=r;else if(3===t.directionsAutoMode)d.subtractToRef(u,s.AA.Vector3[0]),c=s.Pq.CrossToRef(s.AA.Vector3[0],s.AA.Vector3[1],s.AA.Vector3[2]).normalize();else if(1===t.directionsAutoMode)c=fg._GetDirectionFromPoints(u,d,c);else{const e=d.subtract(u);e.applyRotationQuaternionInPlace(e.x>e.y&&e.x>e.z?i?fg._RightHandedForwardReadOnlyQuaternion:fg._LeftHandedForwardReadOnlyQuaternion:fg._LeftReadOnlyQuaternion),c=e.normalize()}h=c.multiplyByFloats(o,o,o),n.push(u.add(h)),a.push(u.subtract(h))}r||(n.push(l[l.length-1].add(h)),a.push(l[l.length-1].subtract(h)))}return[n,a]}static _GetDirectionFromPoints(e,t,i){return e.x!==t.x||i&&1!==i?.x?e.y===t.y?fg.DIRECTION_XZ:e.z===t.z?fg.DIRECTION_XY:fg.DIRECTION_XZ:fg.DIRECTION_YZ}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={},n=[];y.r.DeepCopy(this._pathsOptions,n,void 0,void 0,!0),y.r.DeepCopy(i,r,["instance"],void 0,!0);const s=new fg(e,this._scene,r,n);return t&&(s.parent=t),s.material=this.material,s}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){const i=e.lineOptions,r=e.name,n=e.pathOptions;return new fg(r,t,i,n)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){const t=e.length;this._vSegmentLengths=new Array(t),this._vTotalLengths=new Array(t);let i=0;for(let r=0;r<t;r++){const t=e[r];this._vSegmentLengths[r]=[0],i=0;for(let e=0;e<t.length-1;e++){const n=Math.abs(t[e].subtract(t[e+1]).lengthSquared());i+=n,this._vSegmentLengths[r].push(n)}this._vTotalLengths[r]=i}const r=e[0].length;this._uSegmentLengths=new Array(r).fill([]),this._uTotalLengths=new Array(r).fill([]);const n=new s.Pq;for(let s=0;s<r;s++){i=0;for(let r=1;r<t;r++){e[r][s].subtractToRef(e[r-1][s],n);const t=n.length();i+=t,this._uSegmentLengths[s].push(t)}this._uTotalLengths[s]=i}}static _CalculateSlopes(e){const t=e[0],i=2===e.length?e[1]:e[e.length-1],r=[],n=new s.Pq;for(let s=0;s<t.length;s++)for(let a=0;a<e.length;a++)0===a||a===e.length-1?(t[s].subtract(i[s]).normalizeToRef(n),r.push(n.x,n.y,n.z),r.push(-n.x,-n.y,-n.z)):r.push(0,0,0,0,0,0);return r}_createVertexBuffers(){this._uvs=this._options.uvs??this._uvs;const e=super._createVertexBuffers(this._options.ribbonOptions?.smoothShading),t=new Ue.h(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));const i=new Ue.h(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));const r=new Ue.h(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));const n=new Ue.h(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n,e}}function mg(e,t,i){let r;switch(i=i??P.q.LastCreatedScene,t.materialType){case 1:r=new Jo.Y(e,i,t.forceGLSL),new qm(r,i,t);break;case 2:r=new $m(e,i,t);break;default:r=new Oi.F(e,i,t.forceGLSL),new qm(r,i,t)}return r}function _g(e,t,i,r){let n;r=r??P.q.LastCreatedScene;const s=Ym.ConvertPoints(t.points,t.pointsOptions);t.widthDistribution=t.widthDistribution??3,t.ribbonOptions&&(t.ribbonOptions.facesMode=t.ribbonOptions.facesMode??1,t.ribbonOptions.pointsMode=t.ribbonOptions.pointsMode??0,t.ribbonOptions.directionsAutoMode=t.ribbonOptions.directionsAutoMode??(t.ribbonOptions.directions?99:0)),(i=i??{color:Wm.DEFAULT_COLOR}).createAndAssignMaterial=i.createAndAssignMaterial??!0,i.colorDistribution=i?.colorDistribution??3,i.materialType=i.materialType??0;const a=gg(s),o=vg(a,t.widths??[],t.widthDistribution),l=i?.colors?Sg(a,i.colors,i.colorDistribution,i.color??Wm.DEFAULT_COLOR):void 0,c={points:s,updatable:t.updatable,widths:o,lazy:t.lazy,ribbonOptions:t.ribbonOptions,uvs:t.uvs,colorPointers:t.colorPointers};if(c.ribbonOptions&&0===c.ribbonOptions.pointsMode&&(c.ribbonOptions.width=i.width??c.ribbonOptions.width??Wm.DEFAULT_WIDTH),t.instance)if(n=t.instance,n instanceof fg)n.addPoints(s,c);else{const e=n.widths;if(e){const t=e.slice();for(const e of o)t.push(e);n.widths=t}else n.widths=o;if(n.addPoints(s),t.uvs){const e=n.uvs;if(e){const i=new Float32Array(e.length+t.uvs.length);i.set(e,0),i.set(t.uvs,e.length),n.uvs=i}else n.uvs=t.uvs}}else if(n=c.ribbonOptions?new fg(e,r,c):new pg(e,r,c),i){const s={materialType:i.materialType,dashCount:i.dashCount,dashOffset:i.dashOffset,dashRatio:i.dashRatio,resolution:i.resolution,sizeAttenuation:i.sizeAttenuation,useColors:i.useColors,useDash:i.useDash,visibility:i.visibility,width:i.width,color:i.color,colorMode:i.colorMode,colorsSampling:i.colorsSampling,colorDistributionType:i.colorDistributionType,colors:l,cameraFacing:!t.ribbonOptions,colorsTexture:i.colorsTexture};if(i.createAndAssignMaterial){const i=mg(e,s,r);n.material=i,1===t.ribbonOptions?.facesMode&&(i.backFaceCulling=!1)}}if(l&&t.instance&&t.instance.greasedLineMaterial){const e=t.instance.greasedLineMaterial.colors;if(e){const i=e.concat(l);t.instance.greasedLineMaterial.setColors(i,n.isLazy())}}return n}function gg(e){let t=0;for(const i of e)t+=i.length/3;return t}function vg(e,t,i,r=1,n=1){const s=e-t.length/2,a=[];if(s<0)return t.slice(0,2*e);if(s>0){if(t.length%2!=0&&t.push(r),5===i){const e=Math.floor(t.length/2);for(let i=0,r=0;i<e-1;i++)a.push(t[r++]),a.push(t[r++]);const i=t[e/2],r=t[e/2+1];for(let e=0;e<s;e++)a.push(r),a.push(i);for(let i=e;i<t.length;i+=2)a.push(t[i]),a.push(t[i+1])}else if(3===i){for(let e=0;e<t.length;e+=2)a.push(t[e]),a.push(t[e+1]);for(let e=0;e<s;e++)a.push(r),a.push(n)}else if(4===i){for(let e=0;e<s;e++)a.push(r),a.push(n);for(let e=0;e<t.length;e+=2)a.push(t[e]),a.push(t[e+1])}else if(1===i){let i=0;for(let r=0;r<e;r++)a.push(t[i++]),a.push(t[i++]),i===t.length&&(i=0)}else if(2===i){let i=0;const r=t.length/(2*(e-1));for(let n=0;n<e;n++){const e=Math.floor(i);a.push(t[e]),a.push(t[e+1]),i+=r}}}else for(let e=0;e<t.length;e++)a.push(t[e]);return a}function Sg(e,t,i,r){const n=(e=Math.max(t.length,e))-t.length;if(n<0)return t.slice(0,e);const s=[];if(n>0){if(5===i){const e=Math.floor(t.length/2);for(let i=0;i<e;i++)s.push(t[i]);for(let e=0;e<n-1;e++)s.push(r);for(let i=e;i<t.length;i++)s.push(t[i])}else if(3===i){for(let e=0;e<t.length;e++)s.push(t[e]);for(let e=0;e<n;e++)s.push(r)}else if(4===i){for(let e=0;e<n-1;e++)s.push(r);for(let e=0;e<t.length;e++)s.push(t[e])}else if(1===i){let i=0;for(let r=0;r<e;r++)s.push(t[i]),i++,i===t.length&&(i=0)}else if(2===i){let i=0;const r=t.length/(e-1);for(let n=0;n<e-1;n++){const e=Math.floor(i);s.push(t[e]),i+=r}}else if(0===i)for(let e=0;e<t.length;e++)s.push(t[e])}else for(let i=0;i<e;i++)s.push(t[i]);return s}fg.DEFAULT_WIDTH=.1,fg._RightHandedForwardReadOnlyQuaternion=s.PT.RotationAxis(s.Pq.RightHandedForwardReadOnly,Math.PI/2),fg._LeftHandedForwardReadOnlyQuaternion=s.PT.RotationAxis(s.Pq.LeftHandedForwardReadOnly,Math.PI/2),fg._LeftReadOnlyQuaternion=s.PT.RotationAxis(s.Pq.LeftReadOnly,Math.PI/2),fg.DIRECTION_XY=s.Pq.LeftHandedForwardReadOnly,fg.DIRECTION_XZ=s.Pq.UpReadOnly,fg.DIRECTION_YZ=s.Pq.LeftReadOnly,function(e){e[e.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",e[e.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",e[e.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",e[e.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",e[e.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",e[e.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END"}(Z_||(Z_={})),function(e){e[e.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",e[e.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",e[e.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",e[e.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",e[e.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",e[e.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"}(Q_||(Q_={}));var xg=i(20125),Tg=i(21807);let Eg,Cg,bg,Pg=0;class yg{get numProp(){return this._numProp}constructor(e,t,i){this._manifold=e,this._numProp=t,this._vertexStructure=i}_process(e,t){if(this.numProp!==t.numProp)throw new Error("CSG must be used with geometries having the same number of properties");return new yg(Eg[e](this._manifold,t._manifold),this.numProp,this._vertexStructure)}subtract(e){return this._process("difference",e)}intersect(e){return this._process("intersection",e)}add(e){return this._process("union",e)}printDebug(){f.V.Log("Genus:"+this._manifold.genus());const e=this._manifold.getProperties();f.V.Log("Volume:"+e.volume),f.V.Log("surface area:"+e.surfaceArea)}toVertexData(e){const t={rebuildNormals:!1,...e},i=new S_.P,r=this._vertexStructure.find((e=>e.kind===Ue.R.NormalKind)),n=this._manifold.getMesh(t.rebuildNormals&&r?[3,4,5]:void 0);i.indices=n.triVerts.length>65535?new Uint32Array(n.triVerts):new Uint16Array(n.triVerts);for(let e=0;e<n.triVerts.length;e+=3)i.indices[e]=n.triVerts[e+2],i.indices[e+1]=n.triVerts[e+1],i.indices[e+2]=n.triVerts[e];const s=n.vertProperties.length/n.numProp;let a=0;for(let e=0;e<this._vertexStructure.length;e++){const t=this._vertexStructure[e],r=new Float32Array(s*t.stride);for(let e=0;e<s;e++)for(let i=0;i<t.stride;i++)r[e*t.stride+i]=n.vertProperties[e*n.numProp+a+i];i.set(r,t.kind),a+=t.stride}return i}toMesh(e,t,i){const r={rebuildNormals:!1,centerMesh:!0,...i},n=this.toVertexData({rebuildNormals:r.rebuildNormals}),s=this._vertexStructure.find((e=>e.kind===Ue.R.NormalKind)),a=this._manifold.getMesh(r.rebuildNormals&&s?[3,4,5]:void 0),o=a.vertProperties.length/a.numProp,l=new Rt.e(e,t);if(n.applyToMesh(l),r.centerMesh){const e=l.getBoundingInfo().boundingSphere.center;l.position.set(-e.x,-e.y,-e.z),l.bakeCurrentTransformIntoVertices()}let c=a.runOriginalID[0],h=a.runIndex[0],u=0;const d=[];t=l.getScene();for(let e=0;e<a.numRun;++e){const i=a.runOriginalID[e+1];if(i!==c){const r=a.runIndex[e+1];new lc.K(u,0,o,h,r-h,l),d.push(t.getMaterialByUniqueID(c-bg)||t.defaultMaterial),c=i,h=r,u++}}if(r.materialToUse)l.material=r.materialToUse;else if(d.length>1){const i=new Lh.F(e,t);i.subMaterials=d,l.material=i}else l.material=d[0];return l}dispose(){this._manifold&&(this._manifold.delete(),this._manifold=null)}static _ProcessData(e,t,i,r,n,s){const a=new Float32Array(e*i.reduce(((e,t)=>e+t.stride),0));for(let t=0;t<e;t++){let e=0;for(let n=0;n<i.length;n++){const s=i[n];for(let i=0;i<s.stride;i++)a[t*r+e+i]=s.data[t*s.stride+i];e+=s.stride}}const o=new Cg({numProp:r,vertProperties:a,triVerts:t,runIndex:n,runOriginalID:s});let l;o.merge();try{l=new yg(new Eg(o),r,i)}catch(e){throw new Error("Error while creating the CSG: "+e.message)}return l}static _Construct(e,t,i,r){const n=new Uint32Array(e.indices.length);for(let t=0;t<e.indices.length;t+=3)n[t]=e.indices[t+2],n[t+1]=e.indices[t+1],n[t+2]=e.indices[t];const a=new s.Pq;let o=3;const l=[{stride:3,kind:Ue.R.PositionKind}];if(t){const i=new Float32Array(e.positions.length);for(let r=0;r<e.positions.length;r+=3)s.Pq.TransformCoordinatesFromFloatsToRef(e.positions[r],e.positions[r+1],e.positions[r+2],t,a),a.toArray(i,r);l[0].data=i}else l[0].data=e.positions;const c=e.normals;if(c)if(o+=3,l.push({stride:3,kind:Ue.R.NormalKind}),t){const e=new Float32Array(c.length);for(let i=0;i<c.length;i+=3)s.Pq.TransformNormalFromFloatsToRef(c[i],c[i+1],c[i+2],t,a),a.toArray(e,i);l[1].data=e}else l[1].data=c;for(const t of[Ue.R.UVKind,Ue.R.UV2Kind,Ue.R.UV3Kind,Ue.R.UV4Kind,Ue.R.UV5Kind,Ue.R.UV6Kind]){const i=e[t===Ue.R.UVKind?"uvs":t];i&&(o+=2,l.push({stride:2,kind:t,data:i}))}const h=e.colors;return h&&(o+=4,l.push({stride:4,kind:Ue.R.ColorKind,data:h})),this._ProcessData(e.positions.length/3,n,l,o,i,r)}static FromVertexData(e){const t=e.positions,i=e.indices;if(!t||!i)throw new Error("The vertexData must at least have positions and indices");return this._Construct(e,null)}static FromMesh(e,t=!1){const i=e.getVerticesData(Ue.R.PositionKind),r=e.getIndices(),n=e.computeWorldMatrix(!0);if(!i||!r)throw new Error("The mesh must at least have positions and indices");const s=[...Array(e.subMeshes.length)].map(((t,i)=>e.subMeshes[i].indexStart)),a=e.material||e.getScene().defaultMaterial,o="MultiMaterial"===a.getClassName(),l=[...Array(e.subMeshes.length)].map(((t,i)=>o?bg+a.subMaterials[e.subMeshes[i].materialIndex].uniqueId:bg+a.uniqueId)),c=Array.from(s.keys());c.sort(((e,t)=>s[e]-s[t]));const h=new Uint32Array(c.map((e=>s[e]))),u=new Uint32Array(c.map((e=>l[e]))),d={positions:i,indices:r,normals:e.getVerticesData(Ue.R.NormalKind),colors:e.getVerticesData(Ue.R.ColorKind),uvs:e.getVerticesData(Ue.R.UVKind),uvs2:e.getVerticesData(Ue.R.UV2Kind),uvs3:e.getVerticesData(Ue.R.UV3Kind),uvs4:e.getVerticesData(Ue.R.UV4Kind),uvs5:e.getVerticesData(Ue.R.UV5Kind),uvs6:e.getVerticesData(Ue.R.UV6Kind)};return this._Construct(d,t?null:n,h,u)}}function Ag(){return void 0!==Eg}async function Rg(e){const t={manifoldUrl:"https://unpkg.com/manifold-3d@3.0.0",...e};if(t.manifoldInstance)Eg=t.manifoldInstance,Cg=t.manifoldMeshInstance;else{const e=await(i=`\n            import Module from '${t.manifoldUrl}/manifold.js';\n            const wasm = await Module();\n            wasm.setup();\n            const {Manifold, Mesh} = wasm;\n            const returnedValue =  {Manifold, Mesh};\n        `,new Promise(((e,t)=>{let r,n;if((0,Ut.BA)())r=window,n="window";else{if("undefined"==typeof self)return void t(new Error("Cannot load script module outside of a window or a worker"));r=self,n="self"}r._LoadScriptModuleResolve||(r._LoadScriptModuleResolve={}),r._LoadScriptModuleResolve[Pg]=e,i+=`\n            ${n}._LoadScriptModuleResolve[${Pg}](returnedValue);\n            ${n}._LoadScriptModuleResolve[${Pg}] = undefined;\n        `,Pg++,re.S0.LoadScript(i,void 0,((e,i)=>{t(i||new Error(e))}),undefined,!0)})));Eg=e.Manifold,Cg=e.Mesh}var i;bg=Eg.reserveIDs(65536)}var Ig,Mg,Og,Ng,Dg,Fg,Lg,wg,Bg,Vg,kg,Gg;i(42319),function(e){e[e.Int=1]="Int",e[e.Float=2]="Float",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Matrix=32]="Matrix",e[e.Geometry=64]="Geometry",e[e.Texture=128]="Texture",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.Undefined=4096]="Undefined",e[e.All=4095]="All"}(Ig||(Ig={})),function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.HierarchyIssue=2]="HierarchyIssue"}(Mg||(Mg={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Og||(Og={}));class Ug{get direction(){return this._direction}get type(){if(this._type===Ig.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===Ig.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){return this.isConnected?this._connectedPoint?._storedFunction?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=Ig.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new n.cP,this.onDisconnectionObservable=new n.cP,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==Ig.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,n=t;return 0===this.direction&&(r=t,n=i),r.isAnAncestorOf(n)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<Ig.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,void 0!==this.value&&null!==this.value&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class zg{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const t=i.ownerBlock.getDescendantOfPredicate(e);if(t)return t}return null}get _isReadyState(){return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new n.cP,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=Il.K.UniqueId}registerInput(e,t,i=!1,r,n,s){const a=new Ug(e,this,0);return a.type=t,a.isOptional=i,a.defaultValue=r,a.value=r,a.valueMin=n,a.valueMax=s,this._inputs.push(a),this}registerOutput(e,t,i){return(i=i??new Ug(e,this,1)).type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some((e=>e.hasEndpoints))&&!this.isDebug)return!1;this.outputs.forEach((e=>e._resetCounters()))}this._buildId=e.buildId;for(const t of this._inputs){if(!t.connectedPoint){t.isOptional||e.notConnectedNonOptionalInputs.push(t);continue}const i=t.connectedPoint.ownerBlock;i&&i!==this&&i.build(e)}this._customBuildStep(e),e.verbose&&f.V.Log(`Building ${this.name} [${this.getClassName()}]`);const t=Te.j.Now;return this._buildBlock(e),this._buildExecutionTime=Te.j.Now-t,this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(e){}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((e=>{const t=this.inputs.find((t=>t.name===e.name));if(t&&(e.displayName&&(t.displayName=e.displayName),e.isExposedOnFrame&&(t.isExposedOnFrame=e.isExposedOnFrame,t.exposedPortPosition=e.exposedPortPosition),void 0!==e.value&&null!==e.value))if("number"===e.valueType)t.value=e.value;else{const i=(0,o.n9)(e.valueType);i&&(t.value=i.FromArray(e.value))}})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}_dumpPropertiesCode(){return`${this._codeVariableName}.visibleOnFrame = ${this.visibleOnFrame};\n`}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`\n// ${this.getClassName()}\n`;this.comments&&(r+=`// ${this.comments}\n`);const n=this.getClassName();if("GeometryInputBlock"===n){const e=this.type;r+=`var ${this._codeVariableName} = new BABYLON.GeometryInputBlock("${this.name}", ${e});\n`}else r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}");\n`;r+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const n=i.connectedPoint.ownerBlock;-1===t.indexOf(n)&&(r+=n._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const n of i.endpoints){const i=n.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=(0,o.n9)(e.customType);if(t){const i=new t;return i._deserialize(e),i}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this.onBuildObservable.clear()}}(0,ue.Cg)([(0,de.lK)("comment")],zg.prototype,"comments",void 0);class Wg extends zg{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",Ig.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}}(0,o.Y5)("BABYLON.GeometryOutputBlock",Wg),function(e){e[e.None=0]="None",e[e.Positions=1]="Positions",e[e.Normals=2]="Normals",e[e.Tangents=3]="Tangents",e[e.UV=4]="UV",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6",e[e.Colors=10]="Colors",e[e.VertexID=11]="VertexID",e[e.FaceID=12]="FaceID",e[e.GeometryID=13]="GeometryID",e[e.CollectionID=14]="CollectionID",e[e.LoopID=15]="LoopID",e[e.InstanceID=16]="InstanceID",e[e.LatticeID=17]="LatticeID",e[e.LatticeControl=18]="LatticeControl"}(Ng||(Ng={}));class Hg{constructor(){this._rotationMatrix=new s.uq,this._scalingMatrix=new s.uq,this._positionMatrix=new s.uq,this._scalingRotationMatrix=new s.uq,this._transformMatrix=new s.uq,this._tempVector3=new s.Pq,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;const i=this.executionContext.getExecutionIndex();switch(e){case Ng.Positions:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():this.geometryContext&&this.geometryContext.positions?s.Pq.FromArray(this.geometryContext.positions,3*i):s.Pq.Zero();case Ng.Normals:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():this.geometryContext&&this.geometryContext.normals?s.Pq.FromArray(this.geometryContext.normals,3*i):s.Pq.Zero();case Ng.Colors:return this.geometryContext&&this.geometryContext.colors?s.IU.FromArray(this.geometryContext.colors,4*i):s.IU.Zero();case Ng.Tangents:return this.geometryContext&&this.geometryContext.tangents?s.IU.FromArray(this.geometryContext.tangents,4*i):s.IU.Zero();case Ng.UV:return this.executionContext.getOverrideUVs1ContextualValue?this.executionContext.getOverrideUVs1ContextualValue():this.geometryContext&&this.geometryContext.uvs?s.I9.FromArray(this.geometryContext.uvs,2*i):s.I9.Zero();case Ng.UV2:return this.geometryContext&&this.geometryContext.uvs2?s.I9.FromArray(this.geometryContext.uvs2,2*i):s.I9.Zero();case Ng.UV3:return this.geometryContext&&this.geometryContext.uvs3?s.I9.FromArray(this.geometryContext.uvs3,2*i):s.I9.Zero();case Ng.UV4:return this.geometryContext&&this.geometryContext.uvs4?s.I9.FromArray(this.geometryContext.uvs4,2*i):s.I9.Zero();case Ng.UV5:return this.geometryContext&&this.geometryContext.uvs5?s.I9.FromArray(this.geometryContext.uvs5,2*i):s.I9.Zero();case Ng.UV6:return this.geometryContext&&this.geometryContext.uvs6?s.I9.FromArray(this.geometryContext.uvs6,2*i):s.I9.Zero();case Ng.VertexID:return i;case Ng.FaceID:return this.executionContext.getExecutionFaceIndex();case Ng.LoopID:return this.executionContext.getExecutionLoopIndex();case Ng.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case Ng.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case Ng.CollectionID:return this.geometryContext&&this.geometryContext.metadata&&this.geometryContext.metadata.collectionId||0;case Ng.LatticeID:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():s.Pq.Zero();case Ng.LatticeControl:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():s.Pq.Zero()}return null}adapt(e,t){const i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case Ig.Vector2:return new s.I9(i,i);case Ig.Vector3:return new s.Pq(i,i,i);case Ig.Vector4:return new s.IU(i,i,i,i)}return null}adaptInput(e,t,i){if(!e.isConnected)return e.value||i;const r=e.getConnectedValue(this);if(e._connectedPoint?.type===t)return r;switch(t){case Ig.Vector2:return new s.I9(r,r);case Ig.Vector3:return new s.Pq(r,r,r);case Ig.Vector4:return new s.IU(r,r,r,r)}return null}emitErrors(){let e="";for(const t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\n`;for(const t of this.noContextualData)e+=`Contextual input ${Ng[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).\n`;if(e)throw"Build of NodeGeometry failed:\n"+e}_instantiate(e,t,i,r,n){s.uq.ScalingToRef(r.x,r.y,r.z,this._scalingMatrix),s.uq.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),s.uq.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),s.Pq.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),s.Pq.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));n.push(e)}_instantiateWithMatrix(e,t,i){for(let i=0;i<e.positions.length;i+=3)this._tempVector3.fromArray(e.positions,i),s.Pq.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,i),e.normals&&(this._tempVector3.fromArray(e.normals,i),s.Pq.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,i));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,r){s.uq.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),s.Pq.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),s.Pq.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));r.push(e)}}class Yg extends zg{get type(){if(this._type===Ig.AutoDetect&&null!=this.value){if(!isNaN(this.value))return this._type=Ig.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=Ig.Vector2,this._type;case"Vector3":return this._type=Ig.Vector3,this._type;case"Vector4":return this._type=Ig.Vector4,this._type;case"Matrix":return this._type=Ig.Matrix,this._type}}return this._type}get isContextual(){return this._contextualSource!==Ng.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case Ng.Positions:case Ng.Normals:case Ng.LatticeID:case Ng.LatticeControl:this._type=Ig.Vector3;break;case Ng.Colors:case Ng.Tangents:this._type=Ig.Vector4;break;case Ng.UV:case Ng.UV2:case Ng.UV3:case Ng.UV4:case Ng.UV5:case Ng.UV6:this._type=Ig.Vector2;break;case Ng.VertexID:case Ng.GeometryID:case Ng.CollectionID:case Ng.FaceID:case Ng.LoopID:case Ng.InstanceID:this._type=Ig.Int}this.output&&(this.output.type=this._type)}constructor(e,t=Ig.AutoDetect){super(e),this._type=Ig.Undefined,this._contextualSource=Ng.None,this.min=0,this.max=0,this.groupInInspector="",this.onValueChangedObservable=new n.cP,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===Ig.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=Ng.None,this.type){case Ig.Int:case Ig.Float:this.value=0;break;case Ig.Vector2:this.value=s.I9.Zero();break;case Ig.Vector3:this.value=s.Pq.Zero();break;case Ig.Vector4:this.value=s.IU.Zero();break;case Ig.Matrix:this.value=s.uq.Identity()}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=e=>e.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${Ng[this._contextualSource]};\n`;const t=[];let i="";switch(this.type){case Ig.Float:case Ig.Int:i=`${this.value}`;break;case Ig.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case Ig.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case Ig.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`}return t.push(`${e}.value = ${i}`),this.type!==Ig.Float&&this.type!==Ig.Int||t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}serialize(){const e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,null===this._storedValue||this.isContextual||(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=(0,o.n9)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}(0,o.Y5)("BABYLON.GeometryInputBlock",Yg);class Xg extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",Ig.Float,!0,1),this.registerInput("width",Ig.Float,!0,0),this.registerInput("height",Ig.Float,!0,0),this.registerInput("depth",Ig.Float,!0,0),this.registerInput("subdivisions",Ig.Int,!0,1),this.registerInput("subdivisionsX",Ig.Int,!0,0),this.registerInput("subdivisionsY",Ig.Int,!0,0),this.registerInput("subdivisionsZ",Ig.Int,!0,0),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){const e=new Yg("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new Yg("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Yg("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){const e=new Yg("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){const t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.depth=this.depth.getConnectedValue(e);const i=this.subdivisions.getConnectedValue(e),r=this.subdivisionsX.getConnectedValue(e),n=this.subdivisionsY.getConnectedValue(e),s=this.subdivisionsZ.getConnectedValue(e);return i&&(t.segments=i),r&&(t.widthSegments=r),n&&(t.heightSegments=n),s&&(t.depthSegments=s),(0,co.G$)(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Xg.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.BoxBlock",Xg);class qg{_getGlobalNodeGeometryEditor(){return"undefined"!=typeof NODEGEOMETRYEDITOR?NODEGEOMETRYEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeGeometryEditor?BABYLON:void 0}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=qg._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new n.cP,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}get vertexData(){return this._vertexData}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return re.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise((t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),void 0===this.BJSNODEGEOMETRYEDITOR){const i=e&&e.editorURL?e.editorURL:qg.EditorURL;re.S0.LoadBabylonScript(i,(()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(e?.nodeGeometryEditorConfig),t()}))}else this._createNodeEditor(e?.nodeGeometryEditorConfig),t()}))}_createNodeEditor(e){const t={nodeGeometry:this,...e};this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";const r=Te.j.Now;this._initializeBlock(this.outputBlock,i);const n=[];for(const e of this.attachedBlocks)e._isReadyState&&n.push(e._isReadyState);if(n.length)return void Promise.all(n).then((()=>{this.build(e,t,i)}));const s=new Hg;s.buildId=this._buildId,s.verbose=e;try{this.outputBlock.build(s)}finally{t&&(this._buildId=qg._BuildIdGenerator++)}this._buildExecutionTime=Te.j.Now-r,s.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=s.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;const i=new Rt.e(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),!!this._vertexData&&(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e)}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._initializeBlock(i,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const t of e.blocks){const e=(0,o.n9)(t.customType);if(e){const r=new e;r._deserialize(t),i[t.id]=r,this.attachedBlocks.push(r)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,r=t._tempEntryPointUniqueId;if(r){const e=i[r];e&&e.attachToEndpoint(t)}}for(let r=0;r<e.blocks.length;r++){const n=e.blocks[r],s=i[n.id];s&&(s.inputs.length&&n.inputs.some((e=>e.targetConnectionName))&&!t||this._restoreConnections(s,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const e of r)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const n=[];for(const e in i)n[e]=i[e].uniqueId;this.editorData.map=n}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const n of t.blocks){const s=i[n.id];if(s)for(const a of n.inputs)if(i[a.targetBlockId]!==e||a.targetConnectionName!==r.name);else{const e=s.getInputByName(a.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(s,t,i)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let r=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");\n`;for(const n of t)n.isInput&&-1===e.indexOf(n)&&(r+=n._dumpCode(i,e));return this.outputBlock&&(e=[],r+="// Connections\n",r+=this.outputBlock._dumpCodeForOutputConnections(e),r+="// Output nodes\n",r+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};\n`,r+="nodeGeometry.build();\n"),r}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new Xg("Box");e.autoConfigure();const t=new Wg("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){const t=this.serialize(),i=pe.p.Clone((()=>new qg(e)),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){const t=e?{}:pe.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new qg(e);return t.setToDefault(),t.build(),t}static Parse(e){const t=pe.p.Parse((()=>new qg(e.name)),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return"_BLANK"===e?Promise.resolve(qg.CreateDefault("blank")):new Promise(((r,n)=>{const s=new aa.u;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const a=JSON.parse(JSON.parse(s.responseText).jsonPayload),o=JSON.parse(a.nodeGeometry);t||(t=pe.p.Parse((()=>new qg(e)),o,null)),t.parseSerializedObject(o),t.snippetId=e;try{i||t.build(),r(t)}catch(e){n(e)}}else n("Unable to load the snippet "+e)})),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()}))}}qg._BuildIdGenerator=0,qg.EditorURL=`${re.S0._DefaultCdnUrl}/v${ne.$.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`,qg.SnippetUrl="https://snippet.babylonjs.com",(0,ue.Cg)([(0,de.lK)()],qg.prototype,"name",void 0),(0,ue.Cg)([(0,de.lK)("comment")],qg.prototype,"comment",void 0);class $g extends zg{getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}constructor(e){super(e),this.evaluateContext=!0,this.epsilon=Ee.bH,this.optimizeFaces=!1,this.registerInput("geometry",Ig.Geometry),this.registerInput("selector",Ig.Int,!0),this.registerOutput("output",Ig.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get selector(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e),i=[],r={};e.pushExecutionContext(this),e.pushGeometryContext(t);for(let n=0;n<t.positions.length;n+=3){if(this._currentIndex=n/3,this.selector.isConnected&&!this.selector.getConnectedValue(e))continue;const s=t.positions[n],a=t.positions[n+1],o=t.positions[n+2];let l=!1;for(let e=0;e<i.length;e+=3)(0,it.WithinEpsilon)(s,i[e],this.epsilon)&&(0,it.WithinEpsilon)(a,i[e+1],this.epsilon)&&(0,it.WithinEpsilon)(o,i[e+2],this.epsilon)&&(r[n/3]=e/3,l=!0);l||(r[n/3]=i.length/3,i.push(s,a,o))}const n=new S_.P;n.positions=i;const s=t.indices.map((e=>r[e])),a=[];if(this.optimizeFaces){for(let e=0;e<s.length;e+=3){const t=s[e],i=s[e+1],r=s[e+2];if(t===i||i==r||r===t)continue;let n=!1;for(let e=0;e<a.length;e+=3)(t!==a[e]||i!==a[e+1]||r!==a[e+2])&&(t!==a[e+1]||i!==a[e+2]||r!==a[e])&&(t!==a[e+2]||i!==a[e]||r!==a[e+1])||(n=!0);n||a.push(t,i,r)}n.indices=a}else n.indices=s;return n};e.restoreGeometryContext(),e.restoreExecutionContext(),this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};\n`,e+=`${this._codeVariableName}.optimizeFaces = ${this.optimizeFaces?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e.optimizeFaces=this.optimizeFaces,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon,this.optimizeFaces=e.optimizeFaces}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],$g.prototype,"evaluateContext",void 0),(0,ue.Cg)([oa("Epsilon",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],$g.prototype,"epsilon",void 0),(0,ue.Cg)([oa("Optimize faces",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],$g.prototype,"optimizeFaces",void 0),(0,o.Y5)("BABYLON.GeometryOptimizeBlock",$g);class jg extends zg{constructor(e){super(e),this._rotationMatrix=new s.uq,this.evaluateContext=!1,this.registerInput("size",Ig.Float,!0,1),this.registerInput("width",Ig.Float,!0,0),this.registerInput("height",Ig.Float,!0,0),this.registerInput("subdivisions",Ig.Int,!0,1),this.registerInput("subdivisionsX",Ig.Int,!0,0),this.registerInput("subdivisionsY",Ig.Int,!0,0),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get subdivisionsX(){return this._inputs[4]}get subdivisionsY(){return this._inputs[5]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){const e=new Yg("Size");return e.value=1,void e.output.connectTo(this.size)}if(!this.width.isConnected){const e=new Yg("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Yg("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){const t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e);const i=this.subdivisions.getConnectedValue(e),r=this.subdivisionsX.getConnectedValue(e),n=this.subdivisionsY.getConnectedValue(e);i&&(t.subdivisions=i),r&&(t.subdivisionsX=r),n&&(t.subdivisionsY=n);const a=(0,Hi.EH)(t);return s.uq.RotationYawPitchRollToRef(-Math.PI/2,0,Math.PI/2,this._rotationMatrix),a.transform(this._rotationMatrix),a};if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],jg.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.PlaneBlock",jg);class Kg extends zg{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh)return void(this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null);const e=S_.P.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){const i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){const e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=S_.P.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=S_.P.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}}(0,ue.Cg)([oa("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Kg.prototype,"serializedCachedData",void 0),(0,o.Y5)("BABYLON.MeshBlock",Kg);class Zg extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",Ig.Float,!0,1),this.registerInput("radiusX",Ig.Float,!0,0),this.registerInput("radiusY",Ig.Float,!0,0),this.registerInput("radiusZ",Ig.Float,!0,0),this.registerInput("subdivisions",Ig.Int,!0,4),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new Yg("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.radiusX=this.radiusX.getConnectedValue(e),t.radiusY=this.radiusY.getConnectedValue(e),t.radiusZ=this.radiusZ.getConnectedValue(e),(0,_c.F)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Zg.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.IcoSphereBlock",Zg);class Qg extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",Ig.Int,!0,32),this.registerInput("diameter",Ig.Float,!0,1),this.registerInput("diameterX",Ig.Float,!0,0),this.registerInput("diameterY",Ig.Float,!0,0),this.registerInput("diameterZ",Ig.Float,!0,0),this.registerInput("arc",Ig.Float,!0,1),this.registerInput("slice",Ig.Float,!0,1),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Yg("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.segments=this.segments.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterX=this.diameterX.getConnectedValue(e),t.diameterY=this.diameterY.getConnectedValue(e),t.diameterZ=this.diameterZ.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),t.slice=this.slice.getConnectedValue(e),(0,Mo.W$)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Qg.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.SphereBlock",Qg);class Jg extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",Ig.Float,!0,1),this.registerInput("height",Ig.Float,!0,1),this.registerInput("subdivisions",Ig.Int,!0,1),this.registerInput("subdivisionsX",Ig.Int,!0,0),this.registerInput("subdivisionsY",Ig.Int,!0,0),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){const e=new Yg("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new Yg("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.subdivisionsX=this.subdivisionsX.getConnectedValue(e),t.subdivisionsY=this.subdivisionsY.getConnectedValue(e),(0,Hi.EH)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Jg.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.GridBlock",Jg);class ev extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",Ig.Float,!0,1),this.registerInput("thickness",Ig.Float,!0,.5),this.registerInput("tessellation",Ig.Int,!0,16),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Yg("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=e=>(t.thickness=this.thickness.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),(0,Yi.qq)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],ev.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.TorusBlock",ev);class tv extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",Ig.Float,!0,25),this.registerInput("diameter",Ig.Float,!0,1),this.registerInput("diameterTop",Ig.Float,!0,-1),this.registerInput("diameterBottom",Ig.Float,!0,-1),this.registerInput("subdivisions",Ig.Int,!0,1),this.registerInput("tessellation",Ig.Int,!0,24),this.registerInput("arc",Ig.Float,!0,1),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new Yg("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){const e=new Yg("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterTop=this.diameterTop.getConnectedValue(e),t.diameterBottom=this.diameterBottom.getConnectedValue(e),-1===t.diameterTop&&(t.diameterTop=t.diameter),-1===t.diameterBottom&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),(0,ho.ZS)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],tv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.CylinderBlock",tv);class iv extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",Ig.Float,!0,1),this.registerInput("radius",Ig.Float,!0,.25),this.registerInput("tessellation",Ig.Int,!0,16),this.registerInput("subdivisions",Ig.Int,!0,2),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){const e=new Yg("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){const e=new Yg("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.height=this.height.getConnectedValue(e),t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),(0,ug.yD)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],iv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.CapsuleBlock",iv);class rv extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",Ig.Float,!0,.5),this.registerInput("tessellation",Ig.Int,!0,64),this.registerInput("arc",Ig.Float,!0,1),this.registerOutput("geometry",Ig.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new Yg("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),(0,Oo.OD)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],rv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.DiscBlock",rv);class nv extends zg{constructor(e){super(e),this.registerOutput("geometry",Ig.Geometry),this.registerOutput("vector",Ig.Vector3)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}get vector(){return this._outputs[1]}_buildBlock(){this.geometry._storedValue=null,this.vector._storedValue=null}}(0,o.Y5)("BABYLON.NullBlock",nv);class sv extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("positions",Ig.Vector3),this.registerOutput("output",Ig.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_remapVector3Data(e,t){const i=[];for(let r=0;r<e.length;r+=3)void 0!==t[r/3]&&i.push(e[r],e[r+1],e[r+2]);return i}_remapVector4Data(e,t){const i=[];for(let r=0;r<e.length;r+=4)void 0!==t[r/4]&&i.push(e[r],e[r+1],e[r+2],e[r+3]);return i}_remapVector2Data(e,t){const i=[];for(let r=0;r<e.length;r+=2)void 0!==t[r/2]&&i.push(e[r],e[r+1]);return i}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);const t={},i=this._vertexData.positions.length/3,r=[];let n=0,s=!1;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){const i=this.positions.getConnectedValue(e);i?(i.toArray(r,3*n),t[this._currentIndex]=n,n++):s=!0}if(s){if(this._vertexData.indices){const e=[];for(let i=0;i<this._vertexData.indices.length;i+=3){const r=this._vertexData.indices[i],n=this._vertexData.indices[i+1],s=this._vertexData.indices[i+2],a=t[r],o=t[n],l=t[s];void 0!==a&&void 0!==o&&void 0!==l&&(e.push(a),e.push(o),e.push(l))}this._vertexData.indices=e}this._vertexData.normals&&(this._vertexData.normals=this._remapVector3Data(this._vertexData.normals,t)),this._vertexData.tangents&&(this._vertexData.tangents=this._remapVector4Data(this._vertexData.tangents,t)),this._vertexData.colors&&(this._vertexData.colors=this._remapVector4Data(this._vertexData.colors,t)),this._vertexData.uvs&&(this._vertexData.uvs=this._remapVector2Data(this._vertexData.uvs,t)),this._vertexData.uvs2&&(this._vertexData.uvs2=this._remapVector2Data(this._vertexData.uvs2,t)),this._vertexData.uvs3&&(this._vertexData.uvs3=this._remapVector2Data(this._vertexData.uvs3,t)),this._vertexData.uvs4&&(this._vertexData.uvs4=this._remapVector2Data(this._vertexData.uvs4,t)),this._vertexData.uvs5&&(this._vertexData.uvs5=this._remapVector2Data(this._vertexData.uvs5,t)),this._vertexData.uvs6&&(this._vertexData.uvs6=this._remapVector2Data(this._vertexData.uvs6,t))}return this._vertexData.positions=r,e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],sv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.SetPositionsBlock",sv);class av extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("normals",Ig.Vector3),this.registerOutput("output",Ig.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.normals.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.normals||(this._vertexData.normals=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.normals.getConnectedValue(e);t&&t.toArray(this._vertexData.normals,3*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],av.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.SetNormalsBlock",av);class ov extends zg{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",Ig.Geometry),this.registerInput("uvs",Ig.Vector2),this.registerOutput("output",Ig.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.uvs.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);const t=[],i=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){const i=this.uvs.getConnectedValue(e);i&&i.toArray(t,2*this._currentIndex)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=t;break;case 1:this._vertexData.uvs2=t;break;case 2:this._vertexData.uvs3=t;break;case 3:this._vertexData.uvs4=t;break;case 4:this._vertexData.uvs5=t;break;case 5:this._vertexData.uvs6=t}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],ov.prototype,"evaluateContext",void 0),(0,ue.Cg)([oa("Texture coordinates index",4,"ADVANCED",{notifiers:{update:!0},embedded:!0,options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],ov.prototype,"textureCoordinateIndex",void 0),(0,o.Y5)("BABYLON.SetUVsBlock",ov);class lv extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("colors",Ig.AutoDetect),this.registerOutput("output",Ig.Geometry),this._inputs[1].excludedConnectionPointTypes.push(Ig.Int),this._inputs[1].excludedConnectionPointTypes.push(Ig.Float),this._inputs[1].excludedConnectionPointTypes.push(Ig.Vector2),this._inputs[1].excludedConnectionPointTypes.push(Ig.Texture),this._inputs[1].excludedConnectionPointTypes.push(Ig.Texture)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.colors.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.colors||(this._vertexData.colors=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++)if(this.colors.connectedPoint?.type===Ig.Vector3){const t=this.colors.getConnectedValue(e);t&&(t.toArray(this._vertexData.colors,4*this._currentIndex),this._vertexData.colors[4*this._currentIndex+3]=1,this._vertexData.hasVertexAlpha=!1)}else{const t=this.colors.getConnectedValue(e);t&&(t.toArray(this._vertexData.colors,4*this._currentIndex),this._vertexData.hasVertexAlpha=!0)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],lv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.SetColorsBlock",lv);class cv extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("tangents",Ig.Vector4),this.registerOutput("output",Ig.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);if(!this.tangents.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=this._vertexData);this._vertexData.tangents||(this._vertexData.tangents=[]);const t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.tangents.getConnectedValue(e);t&&t.toArray(this._vertexData.tangents,4*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],cv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.SetTangentsBlock",cv),function(e){e[e.Add=0]="Add",e[e.Subtract=1]="Subtract",e[e.Multiply=2]="Multiply",e[e.Divide=3]="Divide",e[e.Max=4]="Max",e[e.Min=5]="Min"}(Dg||(Dg={}));class hv extends zg{constructor(e){super(e),this.operation=Dg.Add,this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this.output._typeConnectionSource=this.left;const t=[Ig.Matrix,Ig.Geometry,Ig.Texture];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add((()=>this._updateInputOutputTypes())),this.left.onDisconnectionObservable.add((()=>this._updateInputOutputTypes())),this.right.onConnectionObservable.add((()=>this._updateInputOutputTypes())),this.right.onDisconnectionObservable.add((()=>this._updateInputOutputTypes()))]}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;const t=this.left,i=this.right;if(!t.isConnected||!i.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const r=t.type===Ig.Float||t.type===Ig.Int,n=i.type===Ig.Float||i.type===Ig.Int,a=r&&n;switch(this.operation){case Dg.Add:e=a?e=>t.getConnectedValue(e)+i.getConnectedValue(e):r?e=>e.adapt(t,i.type).add(i.getConnectedValue(e)):e=>t.getConnectedValue(e).add(e.adapt(i,t.type));break;case Dg.Subtract:e=a?e=>t.getConnectedValue(e)-i.getConnectedValue(e):r?e=>e.adapt(t,i.type).subtract(i.getConnectedValue(e)):e=>t.getConnectedValue(e).subtract(e.adapt(i,t.type));break;case Dg.Multiply:e=a?e=>t.getConnectedValue(e)*i.getConnectedValue(e):r?e=>e.adapt(t,i.type).multiply(i.getConnectedValue(e)):e=>t.getConnectedValue(e).multiply(e.adapt(i,t.type));break;case Dg.Divide:e=a?e=>t.getConnectedValue(e)/i.getConnectedValue(e):r?e=>e.adapt(t,i.type).divide(i.getConnectedValue(e)):e=>t.getConnectedValue(e).divide(e.adapt(i,t.type));break;case Dg.Min:if(a)e=e=>Math.min(t.getConnectedValue(e),i.getConnectedValue(e));else{const[n,a]=r?[i,t]:[t,i];switch(n.type){case Ig.Vector2:e=e=>s.I9.Minimize(n.getConnectedValue(e),e.adapt(a,n.type));break;case Ig.Vector3:e=e=>s.Pq.Minimize(n.getConnectedValue(e),e.adapt(a,n.type));break;case Ig.Vector4:e=e=>s.IU.Minimize(n.getConnectedValue(e),e.adapt(a,n.type))}}break;case Dg.Max:if(!a){const[n,a]=r?[i,t]:[t,i];switch(n.type){case Ig.Vector2:e=e=>s.I9.Maximize(n.getConnectedValue(e),e.adapt(a,n.type));break;case Ig.Vector3:e=e=>s.Pq.Maximize(n.getConnectedValue(e),e.adapt(a,n.type));break;case Ig.Vector4:e=e=>s.IU.Maximize(n.getConnectedValue(e),e.adapt(a,n.type))}break}e=e=>Math.max(t.getConnectedValue(e),i.getConnectedValue(e))}this.output._storedFunction=i=>t.type===Ig.Int?0|e(i):e(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${Dg[this.operation]};\n`}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===Ig.Int||this.left.type===Ig.Float&&this.right.type!==Ig.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[Ig.Int,Ig.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),t.type!==Ig.Int&&t.type!==Ig.Float||e.acceptedConnectionPointTypes.push(Ig.Vector2,Ig.Vector3,Ig.Vector4))}dispose(){super.dispose(),this._connectionObservers.forEach((e=>e.remove())),this._connectionObservers.length=0}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}(0,ue.Cg)([oa("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Add",value:Dg.Add},{label:"Subtract",value:Dg.Subtract},{label:"Multiply",value:Dg.Multiply},{label:"Divide",value:Dg.Divide},{label:"Max",value:Dg.Max},{label:"Min",value:Dg.Min}]})],hv.prototype,"operation",void 0),(0,o.Y5)("BABYLON.MathBlock",hv);class uv extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("fromMin",Ig.Float,!0,0),this.registerInput("fromMax",Ig.Float,!0,1),this.registerInput("toMin",Ig.Float,!0,0),this.registerInput("toMax",Ig.Float,!0,1),this.registerOutput("output",Ig.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Ig.Vector2),this._inputs[0].excludedConnectionPointTypes.push(Ig.Vector3),this._inputs[0].excludedConnectionPointTypes.push(Ig.Vector4),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),r=this.fromMax.getConnectedValue(e),n=this.toMin.getConnectedValue(e),s=(t-i)/(r-i)*(this.toMax.getConnectedValue(e)-n)+n;return this.output.type===Ig.Int?Math.floor(s):s}}}(0,o.Y5)("BABYLON.MapRangeBlock",uv),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(Fg||(Fg={}));class dv extends zg{constructor(e){super(e),this.test=Fg.Equal,this.registerInput("left",Ig.Float),this.registerInput("right",Ig.Float,!0,0),this.registerInput("ifTrue",Ig.AutoDetect,!0,1),this.registerInput("ifFalse",Ig.AutoDetect,!0,0),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=Ig.Float,this._inputs[0].acceptedConnectionPointTypes.push(Ig.Int),this._inputs[1].acceptedConnectionPointTypes.push(Ig.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.ifTrue.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&1===e.value&&"True"===e.name))||new Yg("True");t.value=1,t.output.connectTo(this.ifTrue)}if(!this.ifFalse.isConnected){const t=e.getBlockByPredicate((e=>e.isInput&&0===e.value&&"False"===e.name))||new Yg("False");t.value=0,t.output.connectTo(this.ifFalse)}}_buildBlock(){if(!this.left.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);let r=!1;switch(this.test){case Fg.Equal:r=(0,it.WithinEpsilon)(t,i,Ee.bH);break;case Fg.NotEqual:r=t!==i;break;case Fg.LessThan:r=t<i;break;case Fg.GreaterThan:r=t>i;break;case Fg.LessOrEqual:r=t<=i;break;case Fg.GreaterOrEqual:r=t>=i;break;case Fg.Xor:r=!!t&&!i||!t&&!!i;break;case Fg.Or:r=!!t||!!i;break;case Fg.And:r=!!t&&!!i}return r};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${Fg[this.test]};\n`}serialize(){const e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}}(0,ue.Cg)([oa("Test",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:Fg.Equal},{label:"NotEqual",value:Fg.NotEqual},{label:"LessThan",value:Fg.LessThan},{label:"GreaterThan",value:Fg.GreaterThan},{label:"LessOrEqual",value:Fg.LessOrEqual},{label:"GreaterOrEqual",value:Fg.GreaterOrEqual},{label:"Xor",value:Fg.Xor},{label:"Or",value:Fg.Or},{label:"And",value:Fg.And}]})],dv.prototype,"test",void 0),(0,o.Y5)("BABYLON.ConditionBlock",dv),function(e){e[e.None=0]="None",e[e.LoopID=1]="LoopID",e[e.InstanceID=2]="InstanceID",e[e.Once=3]="Once"}(Lg||(Lg={}));class pv extends zg{constructor(e){super(e),this._currentLockId=-1,this.lockMode=Lg.None,this.registerInput("min",Ig.AutoDetect),this.registerInput("max",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture),this._inputs[1].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[1].excludedConnectionPointTypes.push(Ig.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){const e=new Yg("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){const e=new Yg("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case Ig.Int:case Ig.Float:e=e=>{const t=this.min.getConnectedValue(e)||0,i=this.max.getConnectedValue(e)||0;return t+Math.random()*(i-t)};break;case Ig.Vector2:e=e=>{const t=this.min.getConnectedValue(e)||s.I9.Zero(),i=this.max.getConnectedValue(e)||s.I9.Zero();return new s.I9(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y))};break;case Ig.Vector3:e=e=>{const t=this.min.getConnectedValue(e)||s.Pq.Zero(),i=this.max.getConnectedValue(e)||s.Pq.Zero();return new s.Pq(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z))};break;case Ig.Vector4:e=e=>{const t=this.min.getConnectedValue(e)||s.IU.Zero(),i=this.max.getConnectedValue(e)||s.IU.Zero();return new s.IU(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z),t.w+Math.random()*(i.w-t.w))}}this.lockMode!==Lg.None&&e?this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case Lg.InstanceID:i=t.getContextualValue(Ng.InstanceID,!0)||0;break;case Lg.LoopID:i=t.getContextualValue(Ng.LoopID,!0)||0;break;case Lg.Once:i=t.buildId||0}return this._currentLockId===i&&this.lockMode!==Lg.None||(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}:this.output._storedFunction=e}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${Lg[this.lockMode]};\n`}serialize(){const e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}(0,ue.Cg)([oa("LockMode",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"None",value:Lg.None},{label:"LoopID",value:Lg.LoopID},{label:"InstanceID",value:Lg.InstanceID},{label:"Once",value:Lg.Once}]})],pv.prototype,"lockMode",void 0),(0,o.Y5)("BABYLON.RandomBlock",pv);class fv extends zg{constructor(e){super(e),this.registerInput("offset",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("scale",Ig.Float,!0,1),this.registerInput("octaves",Ig.Float,!0,2,0,16),this.registerInput("roughness",Ig.Float,!0,.5,0,1),this.registerOutput("output",Ig.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return 0!==t?-e:e}_noiseGrad(e,t,i,r){const n=15&e,s=n<8?t:i,a=n<4?i:12===n||14==n?t:r;return this._negateIf(s,n&s)+this._negateIf(a,2&n)}_fade(e){return e*e*e*(e*(6*e-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let r,n,s;return r=n=s=3735928584,s+=i,n+=t,r+=e,s^=n,s-=this._hashBitRotate(n,14),r^=s,r-=this._hashBitRotate(s,11),n^=r,n-=this._hashBitRotate(r,25),s^=n,s-=this._hashBitRotate(n,16),r^=s,r-=this._hashBitRotate(s,4),n^=r,n-=this._hashBitRotate(r,14),s^=n,s-=this._hashBitRotate(n,24),s}_mix(e,t,i,r,n,s,a,o,l,c,h){const u=1-l,d=1-c;return(1-h)*(d*(e*u+t*l)+c*(i*u+r*l))+h*(d*(n*u+s*l)+c*(a*u+o*l))}_perlinNoise(e){const t=(0|e.x)-(e.x<0?1:0),i=(0|e.y)-(e.y<0?1:0),r=(0|e.z)-(e.z<0?1:0),n=e.x-t,s=e.y-i,a=e.z-r,o=this._fade(n),l=this._fade(s),c=this._fade(a);return this._mix(this._noiseGrad(this._hash(t,i,r),n,s,a),this._noiseGrad(this._hash(t+1,i,r),n-1,s,a),this._noiseGrad(this._hash(t,i+1,r),n,s-1,a),this._noiseGrad(this._hash(t+1,i+1,r),n-1,s-1,a),this._noiseGrad(this._hash(t,i,r+1),n,s,a-1),this._noiseGrad(this._hash(t+1,i,r+1),n-1,s,a-1),this._noiseGrad(this._hash(t,i+1,r+1),n,s-1,a-1),this._noiseGrad(this._hash(t+1,i+1,r+1),n-1,s-1,a-1),o,l,c)}_perlinSigned(e){return.982*this._perlinNoise(e)}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,r,n){const a=new s.Pq(i.x*n+r.x,i.y*n+r.y,i.z*n+r.z);let o=1,l=1,c=0,h=0;const u=0|(e=(0,it.Clamp)(e,0,15));for(let e=0;e<=u;e++)h+=this._perlin(a.scale(o))*l,c+=l,l*=(0,it.Clamp)(t,0,1),o*=2;const d=e-Math.floor(e);if(0==d)return h/c;let p=h+this._perlin(a.scale(o))*l;return h/=c,p/=c+l,(1-d)*h+d*p}_buildBlock(){this.output._storedFunction=e=>{const t=e.getContextualValue(Ng.Positions),i=this.octaves.getConnectedValue(e),r=this.roughness.getConnectedValue(e),n=this.offset.getConnectedValue(e),s=this.scale.getConnectedValue(e);return this.noise(i,r,t,n,s)}}}(0,o.Y5)("BABYLON.NoiseBlock",fv);class mv extends zg{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",Ig.Geometry),this.registerInput("geometry1",Ig.Geometry,!0),this.registerInput("geometry2",Ig.Geometry,!0),this.registerInput("geometry3",Ig.Geometry,!0),this.registerInput("geometry4",Ig.Geometry,!0),this.registerOutput("output",Ig.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{const t=[];if(this.geometry0.isConnected){const i=this.geometry0.getConnectedValue(e);i&&t.push(i)}if(this.geometry1.isConnected){const i=this.geometry1.getConnectedValue(e);i&&t.push(i)}if(this.geometry2.isConnected){const i=this.geometry2.getConnectedValue(e);i&&t.push(i)}if(this.geometry3.isConnected){const i=this.geometry3.getConnectedValue(e);i&&t.push(i)}if(this.geometry4.isConnected){const i=this.geometry4.getConnectedValue(e);i&&t.push(i)}if(0===t.length)return null;let i=t[0].clone();const r=t.slice(1);return r.length&&i&&(i=i.merge(r,!0,!1,!0,!0)),i};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],mv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.MergeGeometryBlock",mv);class _v extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",Ig.Geometry,!0),this.registerInput("geometry1",Ig.Geometry,!0),this.registerInput("geometry2",Ig.Geometry,!0),this.registerInput("geometry3",Ig.Geometry,!0),this.registerInput("geometry4",Ig.Geometry,!0),this.registerInput("geometry5",Ig.Geometry,!0),this.registerInput("geometry6",Ig.Geometry,!0),this.registerInput("geometry7",Ig.Geometry,!0),this.registerInput("geometry8",Ig.Geometry,!0),this.registerInput("geometry9",Ig.Geometry,!0),this.registerOutput("output",Ig.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,r){if(e.isConnected){const n=e.getConnectedValue(t);if(!n)return;n.metadata=n.metadata||{},n.metadata.collectionId=i,r.push(n)}}_buildBlock(e){const t=e=>{const t=[];return this._storeGeometry(this.geometry0,e,0,t),this._storeGeometry(this.geometry1,e,1,t),this._storeGeometry(this.geometry2,e,2,t),this._storeGeometry(this.geometry3,e,3,t),this._storeGeometry(this.geometry4,e,4,t),this._storeGeometry(this.geometry5,e,5,t),this._storeGeometry(this.geometry6,e,6,t),this._storeGeometry(this.geometry7,e,7,t),this._storeGeometry(this.geometry8,e,8,t),this._storeGeometry(this.geometry9,e,9,t),t.length?t[Math.round(Math.random()*(t.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],_v.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.GeometryCollectionBlock",_v);class gv extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerOutput("output",Ig.Geometry)}getClassName(){return"CleanGeometryBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e).clone();if(!t.positions||!t.indices||!t.normals)return t;const i=t.indices,r=t.positions;return(0,o_.Y4)(r,i),t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],gv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.CleanGeometryBlock",gv);class vv extends zg{constructor(e){super(e),this.registerInput("input",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>i.getConnectedValue(e)}}(0,o.Y5)("BABYLON.GeometryElbowBlock",vv);class Sv extends zg{constructor(e){super(e),this.registerInput("geometry",Ig.Geometry),this.registerOutput("output",Ig.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);return t.normals||(t.normals=[]),S_.P.ComputeNormals(t.positions,t.indices,t.normals),t}}}(0,o.Y5)("BABYLON.ComputeNormalsBlock",Sv);class xv extends zg{constructor(e){super(e),this.registerInput("xyzw ",Ig.Vector4,!0),this.registerInput("xyz ",Ig.Vector3,!0),this.registerInput("xy ",Ig.Vector2,!0),this.registerInput("zw ",Ig.Vector2,!0),this.registerInput("x ",Ig.Float,!0),this.registerInput("y ",Ig.Float,!0),this.registerInput("z ",Ig.Float,!0),this.registerInput("w ",Ig.Float,!0),this.registerOutput("xyzw",Ig.Vector4),this.registerOutput("xyz",Ig.Vector3),this.registerOutput("xy",Ig.Vector2),this.registerOutput("zw",Ig.Vector2),this.registerOutput("x",Ig.Float),this.registerOutput("y",Ig.Float),this.registerOutput("z",Ig.Float),this.registerOutput("w",Ig.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":"x "===e?"xIn":"y "===e?"yIn":"z "===e?"zIn":"w "===e?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xIn,i=this.yIn,r=this.zIn,n=this.wIn,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,h=this.xyzwOut,u=this.xyzOut,d=this.xyOut,p=this.zwOut,f=this.xOut,m=this.yOut,_=this.zOut,g=this.wOut,v=e=>{if(c.isConnected)return c.getConnectedValue(e);let h=0,u=0,d=0,p=0;if(t.isConnected&&(h=t.getConnectedValue(e)),i.isConnected&&(u=i.getConnectedValue(e)),r.isConnected&&(d=r.getConnectedValue(e)),n.isConnected&&(p=n.getConnectedValue(e)),a.isConnected){const t=a.getConnectedValue(e);t&&(h=t.x,u=t.y)}if(o.isConnected){const t=o.getConnectedValue(e);t&&(d=t.x,p=t.y)}if(l.isConnected){const t=l.getConnectedValue(e);t&&(h=t.x,u=t.y,d=t.z)}return new s.IU(h,u,d,p)};h._storedFunction=e=>v(e),u._storedFunction=e=>{const t=v(e);return new s.Pq(t.x,t.y,t.z)},d._storedFunction=e=>{const t=v(e);return new s.I9(t.x,t.y)},p._storedFunction=e=>{const t=v(e);return new s.I9(t.z,t.w)},f._storedFunction=e=>v(e).x,m._storedFunction=e=>v(e).y,_._storedFunction=e=>v(e).z,g._storedFunction=e=>v(e).w}}(0,o.Y5)("BABYLON.VectorConverterBlock",xv);class Tv extends zg{constructor(e){super(e),this.registerInput("input",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.output._storedFunction=null,this.input.isConnected?this.output._storedFunction=e=>this.input.getConnectedValue(e).normalize():this.output._storedValue=null}}(0,o.Y5)("BABYLON.NormalizeVectorBlock",Tv);class Ev extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("id",Ig.Int,!0,0),this.registerOutput("output",Ig.Geometry),this.id.acceptedConnectionPointTypes.push(Ig.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.geometry.getConnectedValue(e);if(!t||!t.indices||!t.positions)return t;const i=new S_.o;return i.materialIndex=0|this.id.getConnectedValue(e),i.indexStart=0,i.indexCount=t.indices.length,i.verticesStart=0,i.verticesCount=t.positions.length/3,t.materialInfos=[i],t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Ev.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.SetMaterialIDBlock",Ev);class Cv extends zg{constructor(e){super(e),this._indexVector3=new s.Pq,this._currentControl=new s.Pq,this.evaluateContext=!0,this.resolutionX=3,this.resolutionY=3,this.resolutionZ=3,this.registerInput("geometry",Ig.Geometry),this.registerInput("controls",Ig.Vector3),this.registerOutput("output",Ig.Geometry)}getExecutionIndex(){return this._currentIndexX+this.resolutionX*(this._currentIndexY+this.resolutionY*this._currentIndexZ)}getExecutionLoopIndex(){return this.getExecutionIndex()}getExecutionFaceIndex(){return 0}getClassName(){return"LatticeBlock"}get geometry(){return this._inputs[0]}get controls(){return this._inputs[1]}get output(){return this._outputs[0]}getOverridePositionsContextualValue(){return this._indexVector3}getOverrideNormalsContextualValue(){return this._currentControl}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),!this._vertexData||!this._vertexData.positions)return e.restoreExecutionContext(),void(this.output._storedValue=null);const t=this._vertexData.positions,i=(0,o_.b8)(t,0,t.length/3),r=i.maximum.subtract(i.minimum);for(this._lattice=new X_({resolutionX:this.resolutionX,resolutionY:this.resolutionY,resolutionZ:this.resolutionZ,size:r,position:i.minimum.add(r.scale(.5))}),this._currentIndexX=0;this._currentIndexX<this.resolutionX;this._currentIndexX++)for(this._currentIndexY=0;this._currentIndexY<this.resolutionY;this._currentIndexY++)for(this._currentIndexZ=0;this._currentIndexZ<this.resolutionZ;this._currentIndexZ++){this._indexVector3.set(this._currentIndexX,this._currentIndexY,this._currentIndexZ);const t=this._lattice.data[this._currentIndexX][this._currentIndexY][this._currentIndexZ];this._currentControl.copyFrom(t);const i=this.controls.getConnectedValue(e);i&&t.set(i.x,i.y,i.z)}return this._lattice.deform(t),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.resolutionX = ${this.resolutionX};\n`,e+=`${this._codeVariableName}.resolutionY = ${this.resolutionY};\n`,e+=`${this._codeVariableName}.resolutionZ = ${this.resolutionZ};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.resolutionX=this.resolutionX,e.resolutionY=this.resolutionY,e.resolutionZ=this.resolutionZ,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext,this.resolutionX=e.resolutionX,this.resolutionY=e.resolutionY,this.resolutionZ=e.resolutionZ)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Cv.prototype,"evaluateContext",void 0),(0,ue.Cg)([oa("resolutionX",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],Cv.prototype,"resolutionX",void 0),(0,ue.Cg)([oa("resolutionY",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],Cv.prototype,"resolutionY",void 0),(0,ue.Cg)([oa("resolutionZ",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],Cv.prototype,"resolutionZ",void 0),(0,o.Y5)("BABYLON.LatticeBlock",Cv),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Round=4]="Round",e[e.Floor=5]="Floor",e[e.Ceiling=6]="Ceiling",e[e.Sqrt=7]="Sqrt",e[e.Log=8]="Log",e[e.Tan=9]="Tan",e[e.ArcTan=10]="ArcTan",e[e.ArcCos=11]="ArcCos",e[e.ArcSin=12]="ArcSin",e[e.Sign=13]="Sign",e[e.Negate=14]="Negate",e[e.OneMinus=15]="OneMinus",e[e.Reciprocal=16]="Reciprocal",e[e.ToDegrees=17]="ToDegrees",e[e.ToRadians=18]="ToRadians",e[e.Fract=19]="Fract",e[e.Exp2=20]="Exp2"}(wg||(wg={}));class bv extends zg{constructor(e){super(e),this.operation=wg.Cos,this.registerInput("input",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case wg.Cos:t=e=>Math.cos(e);break;case wg.Sin:t=e=>Math.sin(e);break;case wg.Abs:t=e=>Math.abs(e);break;case wg.Exp:t=e=>Math.exp(e);break;case wg.Exp2:t=e=>Math.pow(2,e);break;case wg.Round:t=e=>Math.round(e);break;case wg.Floor:t=e=>Math.floor(e);break;case wg.Ceiling:t=e=>Math.ceil(e);break;case wg.Sqrt:t=e=>Math.sqrt(e);break;case wg.Log:t=e=>Math.log(e);break;case wg.Tan:t=e=>Math.tan(e);break;case wg.ArcTan:t=e=>Math.atan(e);break;case wg.ArcCos:t=e=>Math.acos(e);break;case wg.ArcSin:t=e=>Math.asin(e);break;case wg.Sign:t=e=>Math.sign(e);break;case wg.Negate:t=e=>-e;break;case wg.OneMinus:t=e=>1-e;break;case wg.Reciprocal:t=e=>1/e;break;case wg.ToRadians:t=e=>e*Math.PI/180;break;case wg.ToDegrees:t=e=>180*e/Math.PI;break;case wg.Fract:t=e=>e>=0?e-Math.floor(e):e-Math.ceil(e)}if(!t)return this.output._storedFunction=null,void(this.output._storedValue=null);switch(this.input.type){case Ig.Int:case Ig.Float:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return t(i)};break;case Ig.Vector2:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new s.I9(t(i.x),t(i.y))};break;case Ig.Vector3:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new s.Pq(t(i.x),t(i.y),t(i.z))};break;case Ig.Vector4:this.output._storedFunction=e=>{const i=this.input.getConnectedValue(e);return new s.IU(t(i.x),t(i.y),t(i.z),t(i.w))}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${wg[this.operation]};\n`}}(0,ue.Cg)([oa("Operation",4,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},options:[{label:"Cos",value:wg.Cos},{label:"Sin",value:wg.Sin},{label:"Abs",value:wg.Abs},{label:"Exp",value:wg.Exp},{label:"Exp2",value:wg.Exp2},{label:"Round",value:wg.Round},{label:"Floor",value:wg.Floor},{label:"Ceiling",value:wg.Ceiling},{label:"Sqrt",value:wg.Sqrt},{label:"Log",value:wg.Log},{label:"Tan",value:wg.Tan},{label:"ArcTan",value:wg.ArcTan},{label:"ArcCos",value:wg.ArcCos},{label:"ArcSin",value:wg.ArcSin},{label:"Sign",value:wg.Sign},{label:"Negate",value:wg.Negate},{label:"OneMinus",value:wg.OneMinus},{label:"Reciprocal",value:wg.Reciprocal},{label:"ToDegrees",value:wg.ToDegrees},{label:"ToRadians",value:wg.ToRadians},{label:"Fract",value:wg.Fract}]})],bv.prototype,"operation",void 0),(0,o.Y5)("BABYLON.GeometryTrigonometryBlock",bv);class Pv extends zg{constructor(e){super(e),this._rotationMatrix=new s.uq,this._scalingMatrix=new s.uq,this._translationMatrix=new s.uq,this._scalingRotationMatrix=new s.uq,this._pivotMatrix=new s.uq,this._backPivotMatrix=new s.uq,this._transformMatrix=new s.uq,this.evaluateContext=!0,this.registerInput("value",Ig.AutoDetect),this.registerInput("matrix",Ig.Matrix,!0),this.registerInput("translation",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("rotation",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("scaling",Ig.Vector3,!0,s.Pq.One()),this.registerInput("pivot",Ig.Vector3,!0,s.Pq.Zero()),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get pivot(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const t=e=>{const t=this.value.getConnectedValue(e);if(!t)return null;let i;if(this.matrix.isConnected)i=this.matrix.getConnectedValue(e);else{const t=this.scaling.getConnectedValue(e)||s.Pq.OneReadOnly,r=this.rotation.getConnectedValue(e)||s.Pq.ZeroReadOnly,n=this.translation.getConnectedValue(e)||s.Pq.ZeroReadOnly,a=this.pivot.getConnectedValue(e)||s.Pq.ZeroReadOnly;s.uq.TranslationToRef(-a.x,-a.y,-a.z,this._pivotMatrix),s.uq.ScalingToRef(t.x,t.y,t.z,this._scalingMatrix),s.uq.RotationYawPitchRollToRef(r.y,r.x,r.z,this._rotationMatrix),s.uq.TranslationToRef(n.x+a.x,n.y+a.y,n.z+a.z,this._translationMatrix),this._pivotMatrix.multiplyToRef(this._scalingMatrix,this._backPivotMatrix),this._backPivotMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),i=this._transformMatrix}switch(this.value.type){case Ig.Geometry:{const e=t.clone();return e.transform(i),e}case Ig.Vector2:return s.I9.Transform(t,i);case Ig.Vector3:return s.Pq.TransformCoordinates(t,i);case Ig.Vector4:return s.IU.TransformCoordinates(t,i)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Pv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.GeometryTransformBlock",Pv);class yv extends zg{constructor(e){super(e),this.registerInput("angle",Ig.Float,!0,0),this.registerOutput("matrix",Ig.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>s.uq.RotationX(this.angle.getConnectedValue(e))}}(0,o.Y5)("BABYLON.RotationXBlock",yv);class Av extends zg{constructor(e){super(e),this.registerInput("angle",Ig.Float,!0,0),this.registerOutput("matrix",Ig.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>s.uq.RotationY(this.angle.getConnectedValue(e))}}(0,o.Y5)("BABYLON.RotationYBlock",Av);class Rv extends zg{constructor(e){super(e),this.registerInput("angle",Ig.Float,!0,0),this.registerOutput("matrix",Ig.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>s.uq.RotationZ(this.angle.getConnectedValue(e))}}(0,o.Y5)("BABYLON.RotationZBlock",Rv);class Iv extends zg{constructor(e){super(e),this.registerInput("scale",Ig.Vector3,!1,s.Pq.One()),this.registerOutput("matrix",Ig.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){const e=new Yg("Scale");e.value=new s.Pq(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.scale.getConnectedValue(e);return s.uq.Scaling(t.x,t.y,t.z)}}}(0,o.Y5)("BABYLON.ScalingBlock",Iv);class Mv extends zg{constructor(e){super(e),this.registerInput("source",Ig.Vector3,!0,s.Pq.Up()),this.registerInput("target",Ig.Vector3,!0,s.Pq.Left()),this.registerOutput("matrix",Ig.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.source.getConnectedValue(e).clone(),i=this.target.getConnectedValue(e).clone(),r=new s.uq;return t.normalize(),i.normalize(),s.uq.RotationAlignToRef(t,i,r,!0),r}}}(0,o.Y5)("BABYLON.AlignBlock",Mv);class Ov extends zg{constructor(e){super(e),this.registerInput("translation",Ig.Vector3,!1,s.Pq.Zero()),this.registerOutput("matrix",Ig.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){const e=new Yg("Translation");e.value=new s.Pq(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{const t=this.translation.getConnectedValue(e);return s.uq.Translation(t.x,t.y,t.z)}}}(0,o.Y5)("BABYLON.TranslationBlock",Ov);class Nv extends zg{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("instance",Ig.Geometry,!0),this.registerInput("density",Ig.Float,!0,1,0,1),this.registerInput("matrix",Ig.Matrix,!0),this.registerInput("rotation",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("scaling",Ig.Vector3,!0,s.Pq.One()),this.scaling.acceptedConnectionPointTypes.push(Ig.Float),this.registerOutput("output",Ig.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected)return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=this._vertexData.positions.length/3;const i=[],r=new s.Pq,n=[];let a=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const e=a[3*this._currentIndex],t=a[3*this._currentIndex+1],i=a[3*this._currentIndex+2];let r=!1;for(let s=0;s<n.length;s+=3)if(Math.abs(n[s]-e)<Ee.bH&&Math.abs(n[s+1]-t)<Ee.bH&&Math.abs(n[s+2]-i)<Ee.bH){r=!0;break}r||(this._indexTranslation[n.length/3]=this._currentIndex,n.push(e,t,i))}a=n,t=a.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const n=this.density.getConnectedValue(e);if(n<1&&Math.random()>n)continue;r.fromArray(a,3*this._currentIndex);const o=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(o,r,t,i)}else{const t=e.adaptInput(this.scaling,Ig.Vector3,s.Pq.OneReadOnly),n=this.rotation.getConnectedValue(e)||s.Pq.ZeroReadOnly;e._instantiate(o,r,n,t,i)}this._currentLoopIndex++}if(e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),!i.length)return null;if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};\n`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],Nv.prototype,"evaluateContext",void 0),(0,ue.Cg)([oa("Remove duplicated positions",0,"ADVANCED",{notifiers:{update:!0}})],Nv.prototype,"removeDuplicatedPositions",void 0),(0,o.Y5)("BABYLON.InstantiateOnVerticesBlock",Nv);class Dv extends zg{constructor(e){super(e),this._currentPosition=new s.Pq,this._currentUV=new s.I9,this._vertex0=new s.Pq,this._vertex1=new s.Pq,this._vertex2=new s.Pq,this._tempVector0=new s.Pq,this._tempVector1=new s.Pq,this._uv0=new s.I9,this._uv1=new s.I9,this._uv2=new s.I9,this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("instance",Ig.Geometry,!0),this.registerInput("count",Ig.Int,!0,256),this.registerInput("matrix",Ig.Matrix,!0),this.registerInput("rotation",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("scaling",Ig.Vector3,!0,s.Pq.One()),this.scaling.acceptedConnectionPointTypes.push(Ig.Float),this.registerOutput("output",Ig.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),s.Pq.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),r=this._vertexData.indices.length/3,n=i/r;let a=0;const o=[];let l=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<r;this._currentFaceIndex++){a+=n;const r=(0|a)-l;if(r<1)continue;const c=this._vertexData.indices[3*this._currentFaceIndex],h=this._vertexData.indices[3*this._currentFaceIndex+1],u=this._vertexData.indices[3*this._currentFaceIndex+2];this._vertex0.fromArray(this._vertexData.positions,3*c),this._vertex1.fromArray(this._vertexData.positions,3*h),this._vertex2.fromArray(this._vertexData.positions,3*u),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,2*c),this._uv1.fromArray(this._vertexData.uvs,2*h),this._uv2.fromArray(this._vertexData.uvs,2*u));for(let c=0;c<r&&!(l>=i);c++){let i=Math.random(),r=Math.random();if(i>r){const e=i;i=r,r=e}const c=i,h=r-i,u=1-c-h;if(this._currentPosition.set(c*this._vertex0.x+h*this._vertex1.x+u*this._vertex2.x,c*this._vertex0.y+h*this._vertex1.y+u*this._vertex2.y,c*this._vertex0.z+h*this._vertex1.z+u*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(c*this._uv0.x+h*this._uv1.x+u*this._uv2.x,c*this._uv0.y+h*this._uv1.y+u*this._uv2.y),t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length){a-=n;continue}const d=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(d,this._currentPosition,t,o)}else{const t=e.adaptInput(this.scaling,Ig.Vector3,s.Pq.OneReadOnly),i=this.rotation.getConnectedValue(e)||s.Pq.ZeroReadOnly;e._instantiate(d,this._currentPosition,i,t,o)}l++,this._currentLoopIndex++}}if(o.length)if(1===o.length)this._vertexData=o[0];else{const e=o.splice(0,1)[0];this._vertexData=e.merge(o,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],Dv.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.InstantiateOnFacesBlock",Dv);class Fv extends zg{constructor(e){super(e),this._currentPosition=new s.Pq,this._vertex0=new s.Pq,this._vertex1=new s.Pq,this._vertex2=new s.Pq,this.evaluateContext=!0,this.gridMode=!1,this.registerInput("geometry",Ig.Geometry),this.registerInput("instance",Ig.Geometry,!0),this.registerInput("count",Ig.Int,!0,256),this.registerInput("matrix",Ig.Matrix,!0),this.registerInput("rotation",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("scaling",Ig.Vector3,!0,s.Pq.One()),this.registerInput("gridSize",Ig.Int,!0,10),this.scaling.acceptedConnectionPointTypes.push(Ig.Float),this.registerOutput("output",Ig.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get gridSize(){return this._inputs[6]}get output(){return this._outputs[0]}_getValueOnGrid(e,t,i,r){const n=(r-i)/t;return i+n/2+e*n}_getIndexinGrid(e,t,i,r){return e+t*r+i*r*r}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!(this._vertexData&&this._vertexData.positions&&this._vertexData.indices&&this.instance.isConnected))return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),void(this.output._storedValue=null);let t=null;const i=this.count.getConnectedValue(e),r=[],n=(0,o_.b8)(this._vertexData.positions,0,this._vertexData.positions.length/3),a=n.minimum,o=n.maximum,l=new s.Pq(.5,.8,.2),c=this._vertexData.indices.length/3,h=this.gridSize.getConnectedValue(e);let u;if(this._currentLoopIndex=0,this.gridMode){u=[];for(let e=0;e<h*h*h;e++)u[e]=!1}for(let n=0;n<i;n++){if(this.gridMode){let e=Math.floor(Math.random()*h),t=Math.floor(Math.random()*h),i=Math.floor(Math.random()*h),r=this._getIndexinGrid(e,t,i,h);if(u[r]){let n=!1;for(let s=0;s<h*h*h;s++)if(!u[s]){i=Math.floor(s/(h*h)),t=Math.floor((s-i*h*h)/h),e=s-i*h*h-t*h,r=this._getIndexinGrid(e,t,i,h),n=!0;break}if(!n)break}if(!u[r]){const n=this._getValueOnGrid(e,h,a.x,o.x),s=this._getValueOnGrid(t,h,a.y,o.y),l=this._getValueOnGrid(i,h,a.z,o.z);this._currentPosition.set(n,s,l),u[r]=!0}}else this._currentPosition.set(Math.random()*(o.x-a.x)+a.x,Math.random()*(o.y-a.y)+a.y,Math.random()*(o.z-a.z)+a.z);const i=new Ii.Rl(this._currentPosition,l);let d=0;for(let e=0;e<c;e++){this._vertex0.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e]),this._vertex1.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+1]),this._vertex2.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+2]);const t=i.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);t&&t.distance>0&&d++}if(d%2==0){n--;continue}if(t=this.instance.getConnectedValue(e),!t||!t.positions||0===t.positions.length)continue;const p=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(p,this._currentPosition,t,r)}else{const t=e.adaptInput(this.scaling,Ig.Vector3,s.Pq.OneReadOnly),i=this.rotation.getConnectedValue(e)||s.Pq.ZeroReadOnly;e._instantiate(p,this._currentPosition,i,t,r)}this._currentLoopIndex++}if(r.length)if(1===r.length)this._vertexData=r[0];else{const e=r.splice(0,1)[0];this._vertexData=e.merge(r,!0,!1,!0,!0)}return e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.gridMode = ${this.gridMode?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.gridMode=this.gridMode,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext),void 0!==e.gridMode&&(this.gridMode=e.gridMode)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],Fv.prototype,"evaluateContext",void 0),(0,ue.Cg)([oa("Grid mode",0,"MODES",{notifiers:{rebuild:!0}})],Fv.prototype,"gridMode",void 0),(0,o.Y5)("BABYLON.InstantiateOnVolumeBlock",Fv);class Lv extends zg{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",Ig.Geometry,!0),this.registerInput("count",Ig.Int,!0,1),this.registerOutput("output",Ig.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Lv.prototype,"evaluateContext",void 0);class wv extends Lv{constructor(e){super(e),this.registerInput("matrix",Ig.Matrix,!0),this.registerInput("position",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("rotation",Ig.Vector3,!0,s.Pq.Zero()),this.registerInput("scaling",Ig.Vector3,!0,s.Pq.One()),this.scaling.acceptedConnectionPointTypes.push(Ig.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const r=t.clone();if(this.matrix.isConnected){const t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(r,t,i)}else{const t=this.position.getConnectedValue(e)||s.Pq.ZeroReadOnly,n=e.adaptInput(this.scaling,Ig.Vector3,s.Pq.OneReadOnly),a=this.rotation.getConnectedValue(e)||s.Pq.ZeroReadOnly;e._instantiate(r,t,a,n,i)}}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,o.Y5)("BABYLON.InstantiateBlock",wv);class Bv extends Lv{constructor(e){super(e),this.registerInput("direction",Ig.Vector3,!0,new s.Pq(1,0,0)),this.registerInput("rotation",Ig.Vector3,!0,new s.Pq(0,0,0)),this.registerInput("scaling",Ig.Vector3,!0,new s.Pq(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(Ig.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[],r=s.uq.Identity(),n=s.Pq.Zero(),a=s.Pq.Zero(),o=s.Pq.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;const l=t.clone(),c=this.direction.getConnectedValue(e),h=this.rotation.getConnectedValue(e),u=e.adaptInput(this.scaling,Ig.Vector3,s.Pq.OneReadOnly);n.copyFrom(c.clone().scale(this._currentIndex)),a.copyFrom(h.clone().scale(this._currentIndex)),o.copyFrom(u.clone().scale(this._currentIndex)),o.addInPlaceFromFloats(1,1,1),s.uq.ComposeToRef(o,s.PT.FromEulerAngles(a.x,a.y,a.z),n,r),e._instantiateWithMatrix(l,r,i)}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,o.Y5)("BABYLON.InstantiateLinearBlock",Bv);class Vv extends Lv{constructor(e){super(e),this.registerInput("radius",Ig.Int,!0,0,0),this.registerInput("angleStart",Ig.Float,!0,0),this.registerInput("angleEnd",Ig.Float,!0,2*Math.PI),this.registerInput("transform",Ig.Vector3,!0,new s.Pq(0,0,0)),this.registerInput("rotation",Ig.Vector3,!0,new s.Pq(0,0,0)),this.registerInput("scaling",Ig.Vector3,!0,new s.Pq(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(Ig.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){const t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);const t=this.count.getConnectedValue(e),i=[],r=s.uq.Identity(),n=s.uq.Identity(),a=s.uq.Identity(),o=s.Pq.Zero(),l=s.Pq.Zero(),c=s.Pq.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){const h=this.instance.getConnectedValue(e);if(!h||!h.positions||0===h.positions.length)continue;const u=h.clone(),d=this.radius.getConnectedValue(e),p=this.angleStart.getConnectedValue(e),f=this.angleEnd.getConnectedValue(e),m=this.transform.getConnectedValue(e),_=this.rotation.getConnectedValue(e),g=e.adaptInput(this.scaling,Ig.Vector3,s.Pq.OneReadOnly),v=p+(f-p)/t*this._currentIndex,S=s.PT.FromEulerAngles(0,v,0);o.copyFrom(m.clone().scale(this._currentIndex)),l.copyFrom(_.clone().scale(this._currentIndex)),c.copyFrom(g.clone().scale(this._currentIndex)),c.addInPlaceFromFloats(1,1,1),s.uq.RotationYawPitchRollToRef(l.y,l.x,l.z,r),n.setTranslationFromFloats(0,0,d),s.uq.ComposeToRef(c,S,o,a),r.multiplyToRef(n,n),n.multiplyToRef(a,a),e._instantiateWithMatrix(u,a,i)}if(i.length)if(1===i.length)this._vertexData=i[0];else{const e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,o.Y5)("BABYLON.InstantiateRadialBlock",Vv);class kv extends zg{constructor(e){super(e),this.registerInput("float ",Ig.Float,!0),this.registerInput("int ",Ig.Int,!0),this.registerOutput("float",Ig.Float),this.registerOutput("int",Ig.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return"float "===e?"floatIn":"int "===e?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}}(0,o.Y5)("BABYLON.IntFloatConverterBlock",kv);class Gv extends zg{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}get buildExecutionTime(){return-1}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);this.log=[];const t=e=>{const t=this.input.getConnectedValue(e);if(null==t)return this.log.push(["null",""]),t;switch(this.input.type){case Ig.Vector2:this.log.push([u_(t,4),t.toString()]);break;case Ig.Vector3:this.log.push([d_(t,4),t.toString()]);break;case Ig.Vector4:this.log.push([p_(t,4),t.toString()]);break;default:this.log.push([t.toString(),t.toString()])}return t};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}}(0,o.Y5)("BABYLON.DebugBlock",Gv);class Uv extends zg{constructor(e){super(e),this.registerInput("geometry",Ig.Geometry),this.registerOutput("output",Ig.Geometry),this.registerOutput("id",Ig.Int),this.registerOutput("collectionId",Ig.Int),this.registerOutput("verticesCount",Ig.Int),this.registerOutput("facesCount",Ig.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected)return this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,void(this.output._storedFunction=null);this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}(0,o.Y5)("BABYLON.GeometryInfoBlock",Uv),function(e){e[e.Spherical=0]="Spherical",e[e.Cylindrical=1]="Cylindrical",e[e.Cubic=2]="Cubic"}(Bg||(Bg={}));class zv extends zg{constructor(e){super(e),this.mapping=Bg.Spherical,this.registerInput("position",Ig.Vector3),this.registerInput("normal",Ig.Vector3),this.registerInput("center",Ig.Vector3,!0,s.Pq.Zero()),this.registerOutput("uv",Ig.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected)return this.uv._storedFunction=null,void(this.uv._storedValue=null);const e=s.Pq.Zero(),t=t=>{const i=this.position.getConnectedValue(t)||s.Pq.Zero(),r=this.normal.getConnectedValue(t)||s.Pq.Zero(),n=this.center.getConnectedValue(t),a=s.I9.Zero();switch(this.mapping){case Bg.Spherical:{i.subtractToRef(n,e);const t=e.length();t>0&&(a.x=Math.acos(e.y/t)/Math.PI,0===e.x&&0===e.z||(a.y=Math.atan2(e.x,e.z)/(2*Math.PI)));break}case Bg.Cylindrical:{i.subtractToRef(n,e);const t=e.length();t>0&&(a.x=Math.atan2(e.x/t,e.z/t)/(2*Math.PI),a.y=(e.y+1)/2);break}case Bg.Cubic:{const e=Math.abs(r.x),t=Math.abs(r.y),s=Math.abs(r.z),o=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z));let l=0,c=0;e>=t&&e>=s?(l=i.y/o-n.y,c=i.z/o-n.z):t>=e&&t>=s?(l=i.x/o-n.x,c=i.z/o-n.z):(l=i.x/o-n.x,c=i.y/o-n.y),a.x=(l+1)/2,a.y=(c+1)/2}}return a};this.uv._storedFunction=e=>t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${Bg[this.mapping]};\n`}serialize(){const e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}(0,ue.Cg)([oa("Mapping",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Spherical",value:Bg.Spherical},{label:"Cylindrical",value:Bg.Cylindrical},{label:"Cubic",value:Bg.Cubic}]})],zv.prototype,"mapping",void 0),(0,o.Y5)("BABYLON.MappingBlock",zv);class Wv extends zg{constructor(e){super(e),this.registerInput("matrix0",Ig.Matrix),this.registerInput("matrix1",Ig.Matrix),this.registerOutput("output",Ig.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;const t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return t&&i?t.multiply(i):null}}}(0,o.Y5)("BABYLON.MatrixComposeBlock",Wv);class Hv extends zg{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",Ig.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(const e of this._endpoints)e.output._storedFunction=e=>this.input.getConnectedValue(e)}}(0,o.Y5)("BABYLON.TeleportInBlock",Hv);class Yv extends zg{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",Ig.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}(0,o.Y5)("BABYLON.TeleportOutBlock",Yv);class Xv extends zg{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",Ig.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}_prepareImgToLoadAsync(e){return new Promise(((t,i)=>{const r=new Image,n=document.createElement("canvas"),s=n.getContext("2d");r.onload=()=>{n.width=r.width,n.height=r.height,s.drawImage(r,0,0);const e=s.getImageData(0,0,r.width,r.height).data,i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=r.width,this._height=r.height,t()},r.onerror=()=>{this._data=null,i()},r.src=e}))}cleanData(){this._data=null}loadTextureFromFileAsync(e){return this._prepareImgToLoadAsync(URL.createObjectURL(e))}loadTextureFromUrlAsync(e){return this._prepareImgToLoadAsync(e)}extractFromTextureAsync(e){return new Promise(((t,i)=>{if(!e.isReady())return void e.onLoadObservable.addOnce((()=>this.extractFromTextureAsync(e).then(t).catch(i)));const r=e.getSize();kh.LO.GetTextureDataAsync(e,r.width,r.height).then((async e=>{const i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=r.width,this._height=r.height,t()})).catch(i)}))}_buildBlock(){if(!this._data)return void(this.texture._storedValue=null);const e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){const e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}}(0,ue.Cg)([oa("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Xv.prototype,"serializedCachedData",void 0),(0,o.Y5)("BABYLON.GeometryTextureBlock",Xv);class qv extends zg{constructor(e){super(e),this.clampCoordinates=!0,this.registerInput("texture",Ig.Texture),this.registerInput("coordinates",Ig.Vector2),this.registerOutput("rgba",Ig.Vector4),this.registerOutput("rgb",Ig.Vector3),this.registerOutput("r",Ig.Float),this.registerOutput("g",Ig.Float),this.registerOutput("b",Ig.Float),this.registerOutput("a",Ig.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_buildBlock(){const e=e=>{const t=this.texture.getConnectedValue(e);if(!t||!t.data)return null;const i=this.coordinates.getConnectedValue(e);if(!i)return null;const r=this.clampCoordinates?Math.max(0,Math.min(i.x,1)):this._repeatClamp(i.x),n=this.clampCoordinates?Math.max(0,Math.min(i.y,1)):this._repeatClamp(i.y),a=Math.floor(r*(t.width-1)),o=Math.floor(n*(t.height-1)),l=a+t.width*o;return s.IU.FromArray(t.data,4*l)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{const i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{const i=e(t);return i?i.x:null},this.g._storedFunction=t=>{const i=e(t);return i?i.y:null},this.b._storedFunction=t=>{const i=e(t);return i?i.z:null},this.a._storedFunction=t=>{const i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};\n`}serialize(){const e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates}}(0,ue.Cg)([oa("Clamp Coordinates",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],qv.prototype,"clampCoordinates",void 0),(0,o.Y5)("BABYLON.GeometryTextureFetchBlock",qv);class $v extends zg{constructor(e){super(e),this.registerInput("geometry",Ig.Geometry),this.registerOutput("min",Ig.Vector3),this.registerOutput("max",Ig.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?(0,o_.b8)(t.positions,0,t.positions.length/3).minimum:null},this.max._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?(0,o_.b8)(t.positions,0,t.positions.length/3).maximum:null}}}(0,o.Y5)("BABYLON.BoundingBlock",$v),function(e){e[e.Intersect=0]="Intersect",e[e.Subtract=1]="Subtract",e[e.Union=2]="Union"}(Vg||(Vg={}));class jv extends zg{get _isReadyState(){return Ag()?null:(this._csg2LoadingPromise||(this._csg2LoadingPromise=Rg()),this._csg2LoadingPromise)}constructor(e){super(e),this.evaluateContext=!1,this.operation=Vg.Intersect,this.useOldCSGEngine=!1,this.registerInput("geometry0",Ig.Geometry),this.registerInput("geometry1",Ig.Geometry),this.registerOutput("output",Ig.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{const t=this.geometry0.getConnectedValue(e),i=this.geometry1.getConnectedValue(e);if(!t||!i)return null;const r=t.positions.length/3;let n;if(!t.normals&&i.normals&&(t.normals=new Array(t.positions.length)),!i.normals&&t.normals&&(i.normals=new Array(i.positions.length)),!t.uvs&&i.uvs&&(t.uvs=new Array(2*r)),!i.uvs&&t.uvs&&(i.uvs=new Array(2*r)),!t.colors&&i.colors&&(t.colors=new Array(4*r)),!i.colors&&t.colors&&(i.colors=new Array(4*r)),this.useOldCSGEngine){const e=P_.FromVertexData(t),r=P_.FromVertexData(i);switch(this.operation){case Vg.Intersect:n=e.intersect(r);break;case Vg.Subtract:n=e.subtract(r);break;case Vg.Union:n=e.union(r)}}else{const e=yg.FromVertexData(t),r=yg.FromVertexData(i);switch(this.operation){case Vg.Intersect:n=e.intersect(r);break;case Vg.Subtract:n=e.subtract(r);break;case Vg.Union:n=e.add(r)}}return n.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${Vg[this.operation]};\n`,e+=`${this._codeVariableName}.useOldCSGEngine = ${this.useOldCSGEngine?"true":"false"};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e.useOldCSGEngine=this.useOldCSGEngine,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation),this.useOldCSGEngine=!!e.useOldCSGEngine}}(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],jv.prototype,"evaluateContext",void 0),(0,ue.Cg)([oa("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Intersect",value:Vg.Intersect},{label:"Subtract",value:Vg.Subtract},{label:"Union",value:Vg.Union}]})],jv.prototype,"operation",void 0),(0,ue.Cg)([oa("Use old CSG engine",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],jv.prototype,"useOldCSGEngine",void 0),(0,o.Y5)("BABYLON.BooleanGeometryBlock",jv);class Kv extends zg{constructor(e){super(e),this.registerInput("x",Ig.AutoDetect),this.registerInput("y",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.x.isConnected||!this.y.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>Math.atan2(e,t);this.output._storedFunction=t=>{const i=this.x.getConnectedValue(t),r=this.y.getConnectedValue(t);switch(this.x.type){case Ig.Int:case Ig.Float:return e(i,r);case Ig.Vector2:return new s.I9(e(i.x,r.x),e(i.y,r.y));case Ig.Vector3:return new s.Pq(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case Ig.Vector4:return new s.IU(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0}}}(0,o.Y5)("BABYLON.GeometryArcTan2Block",Kv);class Zv extends zg{constructor(e){super(e),this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerInput("gradient",Ig.Float,!0,0,0,1),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>(1-e)*t+e*i;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case Ig.Int:case Ig.Float:return e(n,i,r);case Ig.Vector2:return new s.I9(e(n,i.x,r.x),e(n,i.y,r.y));case Ig.Vector3:return new s.Pq(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));case Ig.Vector4:return new s.IU(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z),e(n,i.w,r.w))}return 0},this}}(0,o.Y5)("BABYLON.GeometryLerpBlock",Zv);class Qv extends zg{constructor(e){super(e),this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerInput("gradient",Ig.Float,!0,0,0,1),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryNLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>(1-e)*t+e*i;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case Ig.Int:case Ig.Float:return e(n,i,r);case Ig.Vector2:{const t=new s.I9(e(n,i.x,r.x),e(n,i.y,r.y));return t.normalize(),t}case Ig.Vector3:{const t=new s.Pq(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));return t.normalize(),t}case Ig.Vector4:{const t=new s.IU(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z),e(n,i.w,r.w));return t.normalize(),t}}return 0},this}}(0,o.Y5)("BABYLON.GeometryNLerpBlock",Qv);class Jv extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("edge",Ig.Float,!0,0),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryStepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>e<t?0:1;return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge.getConnectedValue(t);switch(this.value.type){case Ig.Int:case Ig.Float:return e(i,r);case Ig.Vector2:return new s.I9(e(i.x,r),e(i.y,r));case Ig.Vector3:return new s.Pq(e(i.x,r),e(i.y,r),e(i.z,r));case Ig.Vector4:return new s.IU(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}(0,o.Y5)("BABYLON.GeometryStepBlock",Jv);class eS extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("edge0",Ig.Float,!0,0),this.registerInput("edge1",Ig.Float,!0,1),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometrySmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>{const r=Math.max(0,Math.min((e-t)/(i-t),1));return r*r*(3-2*r)};return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge0.getConnectedValue(t),n=this.edge1.getConnectedValue(t);switch(this.value.type){case Ig.Int:case Ig.Float:return e(i,r,n);case Ig.Vector2:return new s.I9(e(i.x,r,n),e(i.y,r,n));case Ig.Vector3:return new s.Pq(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n));case Ig.Vector4:return new s.IU(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n),e(i.w,r,n))}return 0},this}}(0,o.Y5)("BABYLON.GeometrySmoothStepBlock",eS);class tS extends zg{constructor(e){super(e),this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>e-Math.floor(e/t)*t;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);switch(this.left.type){case Ig.Int:case Ig.Float:return e(i,r);case Ig.Vector2:return new s.I9(e(i.x,r.x),e(i.y,r.y));case Ig.Vector3:return new s.Pq(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case Ig.Vector4:return new s.IU(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0},this}}(0,o.Y5)("BABYLON.GeometryModBlock",tS);class iS extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("power",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryPowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.power.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t)=>Math.pow(e,t);return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.power.getConnectedValue(t);switch(this.value.type){case Ig.Int:case Ig.Float:return e(i,r);case Ig.Vector2:return new s.I9(e(i.x,r),e(i.y,r));case Ig.Vector3:return new s.Pq(e(i.x,r),e(i.y,r),e(i.z,r));case Ig.Vector4:return new s.IU(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}(0,o.Y5)("BABYLON.GeometryPowBlock",iS);class rS extends zg{get minimum(){return this.min.value}set minimum(e){this.min.value=e}get maximum(){return this.max.value}set maximum(e){this.max.value=e}constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("min",Ig.Float,!0,0),this.registerInput("max",Ig.Float,!0,1),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Geometry),this._inputs[0].excludedConnectionPointTypes.push(Ig.Texture)}getClassName(){return"GeometryClampBlock"}get value(){return this._inputs[0]}get min(){return this._inputs[1]}get max(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);const e=(e,t,i)=>Math.max(t,Math.min(e,i));return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.min.isConnected?this.min.getConnectedValue(t):this.minimum,n=this.max.isConnected?this.max.getConnectedValue(t):this.maximum;switch(this.value.type){case Ig.Int:case Ig.Float:return e(i,r,n);case Ig.Vector2:return new s.I9(e(i.x,r,n),e(i.y,r,n));case Ig.Vector3:return new s.Pq(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n));case Ig.Vector4:return new s.IU(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n),e(i.w,r,n))}return 0},this}_deserialize(e){super._deserialize(e),this.minimum=e.minimum,this.maximum=e.maximum}}(0,o.Y5)("BABYLON.GeometryClampBlock",rS);class nS extends zg{constructor(e){super(e),this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerOutput("output",Ig.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Int),this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Vector2),this._inputs[1].excludedConnectionPointTypes.push(Ig.Int),this._inputs[1].excludedConnectionPointTypes.push(Ig.Float),this._inputs[1].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ig.Vector2)}getClassName(){return"GeometryCrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.left.isConnected&&this.right.isConnected?(this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);switch(this.left.type){case Ig.Vector3:return s.Pq.Cross(t,i);case Ig.Vector4:return s.Pq.Cross(t.toVector3(),i.toVector3())}return 0},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryCrossBlock",nS),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(kg||(kg={}));class sS extends zg{constructor(e){super(e),this.type=kg.EaseInOutSine,this.registerInput("input",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ig.Int)}getClassName(){return"GeometryCurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected)return this.output._storedFunction=null,void(this.output._storedValue=null);let e;switch(this.type){case kg.EaseInSine:e=e=>1-Math.cos(3.1415*e/2);break;case kg.EaseOutSine:e=e=>Math.sin(3.1415*e/2);break;case kg.EaseInOutSine:e=e=>-(Math.cos(3.1415*e)-1)/2;break;case kg.EaseInQuad:e=e=>e*e;break;case kg.EaseOutQuad:e=e=>(1-e)*(1-e);break;case kg.EaseInOutQuad:e=e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;break;case kg.EaseInCubic:e=e=>e*e*e;break;case kg.EaseOutCubic:e=e=>1-Math.pow(1-e,3);break;case kg.EaseInOutCubic:e=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;break;case kg.EaseInQuart:e=e=>e*e*e*e;break;case kg.EaseOutQuart:e=e=>1-Math.pow(1-e,4);break;case kg.EaseInOutQuart:e=e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2;break;case kg.EaseInQuint:e=e=>e*e*e*e*e;break;case kg.EaseOutQuint:e=e=>1-Math.pow(1-e,5);break;case kg.EaseInOutQuint:e=e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2;break;case kg.EaseInExpo:e=e=>0===e?0:Math.pow(2,10*e-10);break;case kg.EaseOutExpo:e=e=>1===e?1:1-Math.pow(2,-10*e);break;case kg.EaseInOutExpo:e=e=>0===e?0:1===e?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2;break;case kg.EaseInCirc:e=e=>1-Math.sqrt(1-Math.pow(e,2));break;case kg.EaseOutCirc:e=e=>Math.sqrt(1-Math.pow(e-1,2));break;case kg.EaseInOutCirc:e=e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2;break;case kg.EaseInBack:e=e=>2.70158*e*e*e-1.70158*e*e;break;case kg.EaseOutBack:e=e=>2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2);break;case kg.EaseInOutBack:e=e=>e<.5?Math.pow(2*e,2)*(7.189819*e-2.5949095)/2:(Math.pow(2*e-2,2)*(3.5949095*(2*e-2)+3.5949095)+2)/2;break;case kg.EaseInElastic:e=e=>0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin(6.283/3*(10*e-10.75));break;case kg.EaseOutElastic:e=e=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(6.283/3*(10*e-.75))+1;break;case kg.EaseInOutElastic:e=e=>0===e?0:1==e?1:e<.5?-Math.pow(2,20*e-10)*Math.sin(6.283/4.5*(20*e-11.125))/2:Math.pow(2,-20*e+10)*Math.sin(6.283/4.5*(20*e-11.125))/2+1}return this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);switch(this.input.type){case Ig.Float:return e(i);case Ig.Vector2:return new s.I9(e(i.x),e(i.y));case Ig.Vector3:return new s.Pq(e(i.x),e(i.y),e(i.z));case Ig.Vector4:return new s.IU(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryCurveBlockTypes.${kg[this.type]};\n`}}(0,ue.Cg)([oa("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:kg.EaseInSine},{label:"EaseOutSine",value:kg.EaseOutSine},{label:"EaseInOutSine",value:kg.EaseInOutSine},{label:"EaseInQuad",value:kg.EaseInQuad},{label:"EaseOutQuad",value:kg.EaseOutQuad},{label:"EaseInOutQuad",value:kg.EaseInOutQuad},{label:"EaseInCubic",value:kg.EaseInCubic},{label:"EaseOutCubic",value:kg.EaseOutCubic},{label:"EaseInOutCubic",value:kg.EaseInOutCubic},{label:"EaseInQuart",value:kg.EaseInQuart},{label:"EaseOutQuart",value:kg.EaseOutQuart},{label:"EaseInOutQuart",value:kg.EaseInOutQuart},{label:"EaseInQuint",value:kg.EaseInQuint},{label:"EaseOutQuint",value:kg.EaseOutQuint},{label:"EaseInOutQuint",value:kg.EaseInOutQuint},{label:"EaseInExpo",value:kg.EaseInExpo},{label:"EaseOutExpo",value:kg.EaseOutExpo},{label:"EaseInOutExpo",value:kg.EaseInOutExpo},{label:"EaseInCirc",value:kg.EaseInCirc},{label:"EaseOutCirc",value:kg.EaseOutCirc},{label:"EaseInOutCirc",value:kg.EaseInOutCirc},{label:"EaseInBack",value:kg.EaseInBack},{label:"EaseOutBack",value:kg.EaseOutBack},{label:"EaseInOutBack",value:kg.EaseInOutBack},{label:"EaseInElastic",value:kg.EaseInElastic},{label:"EaseOutElastic",value:kg.EaseOutElastic},{label:"EaseInOutElastic",value:kg.EaseInOutElastic}]})],sS.prototype,"type",void 0),(0,o.Y5)("BABYLON.GeometryCurveBlock",sS);class aS extends zg{constructor(e){super(e),this.registerInput("color",Ig.Vector3),this.registerInput("level",Ig.Float,!0,0),this.registerOutput("output",Ig.Vector3)}getClassName(){return"GeometryDesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.color.isConnected?(this.output._storedFunction=e=>{const t=this.color.getConnectedValue(e),i=this.level.getConnectedValue(e),r=.5*(Math.min(t.x,t.y,t.z)+Math.max(t.x,t.y,t.z));return new s.Pq(t.x*(1-i)+r*i,t.y*(1-i)+r*i,t.z*(1-i)+r*i)},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryDesaturateBlock",aS);class oS extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("steps",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(Ig.Float)}getClassName(){return"GeometryPosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.value.isConnected&&this.steps.isConnected?(this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.steps.getConnectedValue(e);let r=i;if(this.steps.type===Ig.Float)switch(this.value.type){case Ig.Vector2:r=new s.I9(i,i);break;case Ig.Vector3:r=new s.Pq(i,i,i);break;case Ig.Vector4:r=new s.IU(i,i,i,i)}switch(this.value.type){case Ig.Vector2:return new s.I9(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y));case Ig.Vector3:return new s.Pq(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z));case Ig.Vector4:return new s.IU(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z),t.w/(1/r.w)*(1/r.w));default:return Math.floor(t/(1/i)*(1/i))}},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryPosterizeBlock",oS);class lS extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerInput("reference",Ig.AutoDetect),this.registerInput("distance",Ig.Float,!0,0),this.registerInput("replacement",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ig.Float),this._inputs[1].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[3].excludedConnectionPointTypes.push(Ig.Float),this._inputs[3].excludedConnectionPointTypes.push(Ig.Matrix)}getClassName(){return"GeometryReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){return this.value.isConnected&&this.reference.isConnected&&this.replacement.isConnected?(this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.reference.getConnectedValue(e),r=this.distance.getConnectedValue(e),n=this.replacement.getConnectedValue(e);return t.subtract(i).length()<r?n:t},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryReplaceColorBlock",lS);class cS extends zg{constructor(e){super(e),this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerOutput("output",Ig.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Int),this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ig.Float),this._inputs[1].excludedConnectionPointTypes.push(Ig.Matrix)}getClassName(){return"GeometryDistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.left.isConnected&&this.right.isConnected?(this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.subtract(i).length()},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryDistanceBlock",cS);class hS extends zg{constructor(e){super(e),this.registerInput("left",Ig.AutoDetect),this.registerInput("right",Ig.AutoDetect),this.registerOutput("output",Ig.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ig.Int),this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ig.Float),this._inputs[1].excludedConnectionPointTypes.push(Ig.Matrix)}getClassName(){return"GeometryDotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.left.isConnected&&this.right.isConnected?(this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.dot(i)},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryDotBlock",hS);class uS extends zg{constructor(e){super(e),this.registerInput("value",Ig.AutoDetect),this.registerOutput("output",Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Int),this._inputs[0].excludedConnectionPointTypes.push(Ig.Float),this._inputs[0].excludedConnectionPointTypes.push(Ig.Matrix)}getClassName(){return"GeometryLengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){return this.value.isConnected?(this.output._storedFunction=e=>this.value.getConnectedValue(e).length(),this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryLengthBlock",uS);class dS extends zg{constructor(e){super(e),this.registerInput("input",Ig.Vector2),this.registerInput("angle",Ig.Float,!0,0),this.registerOutput("output",Ig.Vector2)}getClassName(){return"GeometryRotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){return this.input.isConnected?(this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e),i=this.angle.getConnectedValue(e);return new s.I9(Math.cos(i)*t.x-Math.sin(i)*t.y,Math.sin(i)*t.x+Math.cos(i)*t.y)},this):(this.output._storedFunction=null,void(this.output._storedValue=null))}}(0,o.Y5)("BABYLON.GeometryRotate2dBlock",dS);class pS extends zg{constructor(e){super(e),this.onInterceptionObservable=new n.cP(void 0,!0),this.registerInput("input",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryInterceptorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>{let t=i.getConnectedValue(e);return this.customFunction&&(t=this.customFunction(t,e)),this.onInterceptionObservable.notifyObservers(t),t}}}(0,o.Y5)("BABYLON.GeometryInterceptorBlock",pS),function(e){e[e.Max=0]="Max",e[e.Min=1]="Min",e[e.Sum=2]="Sum"}(Gg||(Gg={}));class fS extends zg{constructor(e){super(e),this.aggregation=Gg.Sum,this.evaluateContext=!0,this.registerInput("geometry",Ig.Geometry),this.registerInput("source",Ig.AutoDetect),this.registerOutput("output",Ig.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[1]}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"AggregatorBlock"}get geometry(){return this._inputs[0]}get source(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.source.isConnected)return e.restoreGeometryContext(),e.restoreExecutionContext(),void(this.output._storedValue=null);const t=this._vertexData.positions.length/3,i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++)i.push(this.source.getConnectedValue(e));let r,n=null;switch(this.aggregation){case Gg.Max:n=(e,t)=>Math.max(e,t);break;case Gg.Min:n=(e,t)=>Math.min(e,t);break;case Gg.Sum:n=(e,t)=>e+t}if(!n)return e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedFunction=null,void(this.output._storedValue=null);switch(this.source.type){case Ig.Int:case Ig.Float:r=i.reduce(n);break;case Ig.Vector2:{const e=i.map((e=>e.x)).reduce(n),t=i.map((e=>e.y)).reduce(n);r=new s.I9(e,t);break}case Ig.Vector3:{const e=i.map((e=>e.x)).reduce(n),t=i.map((e=>e.y)).reduce(n),a=i.map((e=>e.z)).reduce(n);r=new s.Pq(e,t,a);break}case Ig.Vector4:{const e=i.map((e=>e.x)).reduce(n),t=i.map((e=>e.y)).reduce(n),a=i.map((e=>e.z)).reduce(n),o=i.map((e=>e.w)).reduce(n);r=new s.IU(e,t,a,o);break}}return e.restoreGeometryContext(),e.restoreExecutionContext(),r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};\n`;return e+=`${this._codeVariableName}.aggregation = BABYLON.Aggregations.${Gg[this.aggregation]};\n`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.aggregation=this.aggregation,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext),void 0!==e.aggregation&&(this.aggregation=e.aggregation)}}(0,ue.Cg)([oa("Aggregation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Max",value:Gg.Max},{label:"Min",value:Gg.Min},{label:"Sum",value:Gg.Sum}]})],fS.prototype,"aggregation",void 0),(0,ue.Cg)([oa("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fS.prototype,"evaluateContext",void 0),(0,o.Y5)("BABYLON.AggregatorBlock",fS);var mS,_S=i(80830),gS=i(90201),vS=i(88723),SS=i(17808),xS=i(12714),TS=i(63325),ES=i(95171),CS=i(27637),bS=i(52511),PS=i(34863),yS=i(84613),AS=i(58990),RS=i(69536),IS=i(95552),MS=i(6286),OS=i(57039);!function(e){e[e.INIT=0]="INIT",e[e.RUNNING=1]="RUNNING",e[e.DONE=2]="DONE",e[e.ERROR=3]="ERROR"}(mS||(mS={}));class NS{constructor(e){this.name=e,this._isCompleted=!1,this._taskState=0}get isCompleted(){return this._isCompleted}get taskState(){return this._taskState}get errorObject(){return this._errorObject}_setErrorObject(e,t){this._errorObject||(this._errorObject={message:e,exception:t})}run(e,t,i){this._taskState=1,this.runTask(e,(()=>{this._onDoneCallback(t,i)}),((e,t)=>{this._onErrorCallback(i,e,t)}))}runTask(e,t,i){throw new Error("runTask is not implemented")}reset(){this._taskState=0}_onErrorCallback(e,t,i){this._taskState=3,this._errorObject={message:t,exception:i},this.onError&&this.onError(this,t,i),e()}_onDoneCallback(e,t){try{this._taskState=2,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),e()}catch(e){this._onErrorCallback(t,"Task is done, error executing success callback(s)",e)}}}class DS{constructor(e,t,i){this.remainingCount=e,this.totalCount=t,this.task=i}}class FS extends NS{constructor(e,t,i,r,n){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=r,this.extension=n}runTask(e,t,i){ol.cn.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,(e=>{this.loadedContainer=e,this.loadedMeshes=e.meshes,this.loadedTransformNodes=e.transformNodes,this.loadedParticleSystems=e.particleSystems,this.loadedSkeletons=e.skeletons,this.loadedAnimationGroups=e.animationGroups,t()}),null,((e,t,r)=>{i(t,r)}),this.extension)}}class LS extends NS{constructor(e,t,i,r,n){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=r,this.extension=n}runTask(e,t,i){ol.cn.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,((e,i,r,n,s)=>{this.loadedMeshes=e,this.loadedTransformNodes=s,this.loadedParticleSystems=i,this.loadedSkeletons=r,this.loadedAnimationGroups=n,t()}),null,((e,t,r)=>{i(t,r)}),this.extension)}}class wS extends NS{constructor(e,t,i,r,n){super(e),this.name=e,this.rootUrl=t,this.filename=i,this.targetConverter=r,this.extension=n}runTask(e,t,i){const r=e.animatables.length,n=e.animationGroups.length;this.loadedAnimatables=[],this.loadedAnimationGroups=[],ol.cn.ImportAnimations(this.rootUrl,this.filename,e,!1,3,this.targetConverter,(()=>{this.loadedAnimatables=e.animatables.slice(r),this.loadedAnimationGroups=e.animationGroups.slice(n),t()}),null,((e,t,r)=>{i(t,r)}),this.extension)}}class BS extends NS{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,(e=>{this.text=e,t()}),void 0,!1,!1,((e,t)=>{e&&i(e.status+" "+e.statusText,t)}))}}class VS extends NS{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,(e=>{this.data=e,t()}),void 0,!0,!0,((e,t)=>{e&&i(e.status+" "+e.statusText,t)}))}}class kS extends NS{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){const r=new Image;re.S0.SetCorsBehavior(this.url,r),r.onload=()=>{this.image=r,t()},r.onerror=e=>{i("Error loading image",e)},r.src=this.url}}class GS extends NS{constructor(e,t,i,r=!0,n=_e.g.TRILINEAR_SAMPLINGMODE){super(e),this.name=e,this.url=t,this.noMipmap=i,this.invertY=r,this.samplingMode=n}runTask(e,t,i){this.texture=new _e.g(this.url,e,this.noMipmap,this.invertY,this.samplingMode,(()=>{t()}),((e,t)=>{i(e,t)}))}}class US extends NS{constructor(e,t,i,r,n,s){super(e),this.name=e,this.url=t,this.extensions=i,this.noMipmap=r,this.files=n,this.prefiltered=s}runTask(e,t,i){this.texture=new Uo.b(this.url,e,this.extensions,this.noMipmap,this.files,(()=>{t()}),((e,t)=>{i(e,t)}),void 0,this.prefiltered)}}class zS extends NS{constructor(e,t,i,r=!1,n=!0,s=!1,a=!1){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=r,this.generateHarmonics=n,this.gammaSpace=s,this.reserved=a}runTask(e,t,i){this.texture=new Gh(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,(()=>{t()}),((e,t)=>{i(e,t)}))}}class WS extends NS{constructor(e,t,i,r=!1,n=!0){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=r,this.gammaSpace=n}runTask(e,t,i){this.texture=new Uu(this.url,e,this.size,this.noMipmap,this.gammaSpace,(()=>{t()}),((e,t)=>{i(e,t)}))}}class HS{constructor(e){this._isLoading=!1,this._tasks=new Array,this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new n.cP,this.onTaskErrorObservable=new n.cP,this.onTasksDoneObservable=new n.cP,this.onProgressObservable=new n.cP,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=e||P.q.LastCreatedScene}addContainerTask(e,t,i,r,n){const s=new FS(e,t,i,r,n);return this._tasks.push(s),s}addMeshTask(e,t,i,r,n){const s=new LS(e,t,i,r,n);return this._tasks.push(s),s}addTextFileTask(e,t){const i=new BS(e,t);return this._tasks.push(i),i}addBinaryFileTask(e,t){const i=new VS(e,t);return this._tasks.push(i),i}addImageTask(e,t){const i=new kS(e,t);return this._tasks.push(i),i}addTextureTask(e,t,i,r,n=_e.g.TRILINEAR_SAMPLINGMODE){const s=new GS(e,t,i,r,n);return this._tasks.push(s),s}addCubeTextureTask(e,t,i,r,n,s){const a=new US(e,t,i,r,n,s);return this._tasks.push(a),a}addHDRCubeTextureTask(e,t,i,r=!1,n=!0,s=!1,a=!1){const o=new zS(e,t,i,r,n,s,a);return this._tasks.push(o),o}addEquiRectangularCubeTextureAssetTask(e,t,i,r=!1,n=!0){const s=new WS(e,t,i,r,n);return this._tasks.push(s),s}removeTask(e){const t=this._tasks.indexOf(e);t>-1&&this._tasks.splice(t,1)}_decreaseWaitingTasksCount(e){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,e),this.onProgressObservable.notifyObservers(new DS(this._waitingTasksCount,this._totalTasksCount,e))}catch(e){f.V.Error("Error running progress callbacks."),f.V.Log(e)}if(0===this._waitingTasksCount){try{const e=this._tasks.slice();this.onFinish&&this.onFinish(e);for(const t of e)if(2===t.taskState){const e=this._tasks.indexOf(t);e>-1&&this._tasks.splice(e,1)}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(e){f.V.Error("Error running tasks-done callbacks."),f.V.Log(e)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}}_runTask(e){const t=(t,i)=>{e._setErrorObject(t,i),this.onTaskError?this.onTaskError(e):e.onError||f.V.Error(this._formatTaskErrorMessage(e)),this.onTaskErrorObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)};e.run(this._scene,(()=>{try{this.onTaskSuccess&&this.onTaskSuccess(e),this.onTaskSuccessObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)}catch(e){t("Error executing task success callbacks",e)}}),t)}_formatTaskErrorMessage(e){let t="Unable to complete task "+e.name;return e.errorObject.message&&(t+=`: ${e.errorObject.message}`),e.errorObject.exception&&(t+=`: ${e.errorObject.exception}`),t}reset(){return this._isLoading=!1,this._tasks=new Array,this}load(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,0===this._waitingTasksCount)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(let e=0;e<this._tasks.length;e++){const t=this._tasks[e];0===t.taskState&&this._runTask(t)}return this}loadAsync(){return new Promise(((e,t)=>{this._isLoading?e():(this.onTasksDoneObservable.addOnce((i=>{i&&i.length?t(i):e()})),this.load())}))}}var YS=i(87836),XS=i(83404),qS=i(57646);class $S{constructor(e,t){this._meshesOrigins=[],this._toCenterVectors=[],this._scaledDirection=new s.Pq(1,1,1),this._newPosition=s.Pq.Zero(),this._centerPosition=s.Pq.Zero(),this._meshes=e.slice(),t?this._centerMesh=t:this._setCenterMesh(),this._centerMesh.computeWorldMatrix(!0);const i=this._meshes.indexOf(this._centerMesh);i>=0&&this._meshes.splice(i,1),this._centerPosition=this._centerMesh.getAbsolutePosition().clone();for(let e=0;e<this._meshes.length;e++)if(this._meshes[e]){const t=this._meshes[e];this._meshesOrigins[e]=t.getAbsolutePosition().clone(),this._toCenterVectors[e]=s.Pq.Zero(),t.hasBoundingInfo&&this._centerMesh.hasBoundingInfo&&(t.computeWorldMatrix(!0),t.getBoundingInfo().boundingBox.centerWorld.subtractToRef(this._centerMesh.getBoundingInfo().boundingBox.centerWorld,this._toCenterVectors[e]))}}_setCenterMesh(){let e=s.Pq.Zero();const t=s.Pq.Zero();let i=Number.MAX_VALUE;for(let e=0;e<this._meshes.length;e++)if(this._meshes[e]){const i=this._meshes[e].getBoundingInfo();i&&t.addInPlace(i.boundingBox.centerWorld)}e=t.scale(1/this._meshes.length);for(let t=0;t<this._meshes.length;t++)if(this._meshes[t]){const r=this._meshes[t],n=r.getBoundingInfo();if(n){const t=n.boundingBox.centerWorld.subtract(e).lengthSquared();t<i&&(this._centerMesh=r,i=t)}}}getClassName(){return"MeshExploder"}getMeshes(){const e=this._meshes.slice();return e.unshift(this._centerMesh),e}explode(e=1){for(let t=0;t<this._meshes.length;t++)this._meshes[t]&&this._meshesOrigins[t]&&this._toCenterVectors[t]&&(this._toCenterVectors[t].scaleToRef(e,this._scaledDirection),this._meshesOrigins[t].addToRef(this._scaledDirection,this._newPosition),this._meshes[t].setAbsolutePosition(this._newPosition));this._centerMesh.setAbsolutePosition(this._centerPosition)}}var jS=i(88495);class KS{static get FilesToLoad(){return jS.T.FilesToLoad}constructor(e,t,i,r,n,s,a,o,l,c=!1){this.useAppend=c,this.onProcessFileCallback=()=>!0,this.displayLoadingUI=!0,this.loadAsync=(e,t)=>this.useAppend?ol.cn.AppendAsync("file:",e,this._currentScene,t):ol.cn.LoadAsync("file:",e,this._engine,t),this._engine=e,this._currentScene=t,this._sceneLoadedCallback=i,this._progressCallback=r,this._additionalRenderLoopLogicCallback=n,this._textureLoadingCallback=s,this._startingProcessingFilesCallback=a,this._onReloadCallback=o,this._errorCallback=l}monitorElementForDragNDrop(e){e&&(this._elementToMonitor=e,this._dragEnterHandler=e=>{this._drag(e)},this._dragOverHandler=e=>{this._drag(e)},this._dropHandler=e=>{this._drop(e)},this._elementToMonitor.addEventListener("dragenter",this._dragEnterHandler,!1),this._elementToMonitor.addEventListener("dragover",this._dragOverHandler,!1),this._elementToMonitor.addEventListener("drop",this._dropHandler,!1))}get filesToLoad(){return this._filesToLoad}dispose(){this._elementToMonitor&&(this._elementToMonitor.removeEventListener("dragenter",this._dragEnterHandler),this._elementToMonitor.removeEventListener("dragover",this._dragOverHandler),this._elementToMonitor.removeEventListener("drop",this._dropHandler))}_renderFunction(){if(this._additionalRenderLoopLogicCallback&&this._additionalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){const e=this._currentScene.getWaitingItemsCount();e>0&&this._textureLoadingCallback(e)}this._currentScene.render()}}_drag(e){e.stopPropagation(),e.preventDefault()}_drop(e){e.stopPropagation(),e.preventDefault(),this.loadFiles(e)}_traverseFolder(e,t,i,r){const n=e.createReader(),s=e.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,"$1/");n.readEntries((e=>{i.count+=e.length;for(const n of e)n.isFile?n.file((e=>{e.correctName=s+e.name,t.push(e),0==--i.count&&r()})):n.isDirectory&&this._traverseFolder(n,t,i,r);0==--i.count&&r()}))}_processFiles(e){for(let t=0;t<e.length;t++){const i=e[t].correctName.toLowerCase(),r=i.split(".").pop();this.onProcessFileCallback(e[t],i,r,(e=>this._sceneFileToLoad=e))&&(ol.cn.IsPluginForExtensionAvailable("."+r)&&(this._sceneFileToLoad=e[t]),KS.FilesToLoad[i]=e[t])}}loadFiles(e){if(e&&e.dataTransfer&&e.dataTransfer.files&&(this._filesToLoad=e.dataTransfer.files),e&&e.target&&e.target.files&&(this._filesToLoad=e.target.files),this._filesToLoad&&0!==this._filesToLoad.length&&(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(this._filesToLoad),this._filesToLoad&&this._filesToLoad.length>0)){const t=[],i=[],r=e.dataTransfer?e.dataTransfer.items:null;for(let e=0;e<this._filesToLoad.length;e++){const n=this._filesToLoad[e],s=n.name.toLowerCase();let a;if(n.correctName=s,r){const t=r[e];t.getAsEntry?a=t.getAsEntry():t.webkitGetAsEntry&&(a=t.webkitGetAsEntry())}a&&a.isDirectory?i.push(a):t.push(n)}if(0===i.length)this._processFiles(t),this._processReload();else{const e={count:i.length};for(const r of i)this._traverseFolder(r,t,e,(()=>{this._processFiles(t),0===e.count&&this._processReload()}))}}}_processReload(){this._onReloadCallback?this._onReloadCallback(this._sceneFileToLoad):this.reload()}reload(){if(this._sceneFileToLoad)this.useAppend||this._currentScene&&(f.V.errorsCount>0&&f.V.ClearLogCache(),this._engine.stopRenderLoop()),ol.cn.ShowLoadingScreen=!1,this.displayLoadingUI&&this._engine.displayLoadingUI(),this.loadAsync(this._sceneFileToLoad,this._progressCallback).then((e=>{this.useAppend?this.displayLoadingUI&&this._engine.hideLoadingUI():(this._currentScene&&this._currentScene.dispose(),this._currentScene=e,this._currentScene.executeWhenReady((()=>{this.displayLoadingUI&&this._engine.hideLoadingUI(),this._engine.runRenderLoop((()=>{this._renderFunction()}))}))),this._sceneLoadedCallback&&this._currentScene&&this._sceneLoadedCallback(this._sceneFileToLoad,this._currentScene)})).catch((e=>{this.displayLoadingUI&&this._engine.hideLoadingUI(),this._errorCallback&&this._errorCallback(this._sceneFileToLoad,this._currentScene,e.message)}));else{if(1===this._filesToLoad.length){const e=this._filesToLoad[0].name.toLowerCase().split(".").pop();if(e)switch(e.toLowerCase()){case"dds":case"env":case"hdr":return}}f.V.Error("Please provide a valid .babylon file.")}}}var ZS=i(61039);class QS{dispose(){if(this._observers&&this._observables)for(let e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null}static Watch(e,t,i=-1,r=null){const n=new QS;n._observers=new Array,n._observables=e;for(const s of e){const e=s.add(t,i,!1,r);e&&n._observers.push(e)}return n}}n.cP.prototype.notifyObserversWithPromise=async function(e,t=-1,i,r,n){let s=Promise.resolve(e);if(!this.observers.length)return s;const a=this._eventState;return a.mask=t,a.target=i,a.currentTarget=r,a.skipNextObservers=!1,a.userInfo=n,this.observers.forEach((i=>{a.skipNextObservers||i._willBeUnregistered||i.mask&t&&(s=i.scope?s.then((t=>(a.lastReturnValue=t,i.callback.apply(i.scope,[e,a])))):s.then((t=>(a.lastReturnValue=t,i.callback(e,a)))),i.unregisterOnNextCall&&this._deferUnregister(i))})),await s,e};var JS=i(86817);class ex{getDescription(){return""}apply(e,t){return!0}constructor(e=0){this.priority=e}}class tx extends ex{getDescription(){return"Reducing render target texture size to "+this.maximumSize}constructor(e=0,t=1024,i=.5){super(e),this.priority=e,this.maximumSize=t,this.step=i}apply(e,t){let i=!0;for(let t=0;t<e.textures.length;t++){const r=e.textures[t];if(!r.canRescale||r.getContext)continue;const n=r.getSize();Math.max(n.width,n.height)>this.maximumSize&&(r.scale(this.step),i=!1)}return i}}class ix extends ex{getDescription(){return"Setting hardware scaling level to "+this._currentScale}constructor(e=0,t=2,i=.25){super(e),this.priority=e,this.maximumScale=t,this.step=i,this._currentScale=-1,this._directionOffset=1}apply(e,t){return-1===this._currentScale&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,e.getEngine().setHardwareScalingLevel(this._currentScale),1===this._directionOffset?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}}class rx extends ex{getDescription(){return"Turning shadows on/off"}apply(e,t){return e.shadowsEnabled=t.isInImprovementMode,!0}}class nx extends ex{getDescription(){return"Turning post-processes on/off"}apply(e,t){return e.postProcessesEnabled=t.isInImprovementMode,!0}}class sx extends ex{getDescription(){return"Turning lens flares on/off"}apply(e,t){return e.lensFlaresEnabled=t.isInImprovementMode,!0}}class ax extends ex{getDescription(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}apply(e,t){return!this.onApply||this.onApply(e,t)}}class ox extends ex{getDescription(){return"Turning particles on/off"}apply(e,t){return e.particlesEnabled=t.isInImprovementMode,!0}}class lx extends ex{getDescription(){return"Turning render targets off"}apply(e,t){return e.renderTargetsEnabled=t.isInImprovementMode,!0}}class cx extends ex{constructor(){super(...arguments),this._canBeMerged=e=>{if(!(e instanceof Rt.e))return!1;const t=e;return!(t.isDisposed()||!t.isVisible||!t.isEnabled()||t.instances.length>0||t.skeleton||t.hasLODLevels||0===t.getTotalVertices())}}static get UpdateSelectionTree(){return cx._UpdateSelectionTree}static set UpdateSelectionTree(e){cx._UpdateSelectionTree=e}getDescription(){return"Merging similar meshes together"}apply(e,t,i){const r=e.meshes.slice(0);let n=r.length;for(let e=0;e<n;e++){const t=[],i=r[e];if(this._canBeMerged(i)){t.push(i);for(let s=e+1;s<n;s++){const e=r[s];this._canBeMerged(e)&&e.material===i.material&&e.checkCollisions===i.checkCollisions&&(t.push(e),n--,r.splice(s,1),s--)}t.length<2||Rt.e.MergeMeshes(t,void 0,!0)}}const s=e;return s.createOrUpdateSelectionOctree&&(null!=i?i&&s.createOrUpdateSelectionOctree():cx.UpdateSelectionTree&&s.createOrUpdateSelectionOctree()),!0}}cx._UpdateSelectionTree=!1;class hx{constructor(e=60,t=2e3){this.targetFrameRate=e,this.trackerDuration=t,this.optimizations=[]}addOptimization(e){return this.optimizations.push(e),this}addCustomOptimization(e,t,i=0){const r=new ax(i);return r.onApply=e,r.onGetDescription=t,this.optimizations.push(r),this}static LowDegradationAllowed(e){const t=new hx(e);let i=0;return t.addOptimization(new cx(i)),t.addOptimization(new rx(i)),t.addOptimization(new sx(i)),i++,t.addOptimization(new nx(i)),t.addOptimization(new ox(i)),i++,t.addOptimization(new tx(i,1024)),t}static ModerateDegradationAllowed(e){const t=new hx(e);let i=0;return t.addOptimization(new cx(i)),t.addOptimization(new rx(i)),t.addOptimization(new sx(i)),i++,t.addOptimization(new nx(i)),t.addOptimization(new ox(i)),i++,t.addOptimization(new tx(i,512)),i++,t.addOptimization(new lx(i)),i++,t.addOptimization(new ix(i,2)),t}static HighDegradationAllowed(e){const t=new hx(e);let i=0;return t.addOptimization(new cx(i)),t.addOptimization(new rx(i)),t.addOptimization(new sx(i)),i++,t.addOptimization(new nx(i)),t.addOptimization(new ox(i)),i++,t.addOptimization(new tx(i,256)),i++,t.addOptimization(new lx(i)),i++,t.addOptimization(new ix(i,4)),t}}class ux{get isInImprovementMode(){return this._improvementMode}set isInImprovementMode(e){this._improvementMode=e}get currentPriorityLevel(){return this._currentPriorityLevel}get currentFrameRate(){return this._currentFrameRate}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(e){this._targetFrameRate=e}get trackerDuration(){return this._trackerDuration}set trackerDuration(e){this._trackerDuration=e}get optimizations(){return this._options.optimizations}constructor(e,t,i=!0,r=!1){if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new n.cP,this.onNewOptimizationAppliedObservable=new n.cP,this.onFailureObservable=new n.cP,this._options=t||new hx,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i){let e=0;for(const t of this._options.optimizations)t.priority=e++}this._improvementMode=r,this._scene=e||P.q.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>{this._sceneDisposeObserver=null,this.dispose()}))}stop(){this._isRunning=!1}reset(){this._currentPriorityLevel=0}start(){this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady((()=>{setTimeout((()=>{this._checkCurrentState()}),this._trackerDuration)})))}_checkCurrentState(){if(!this._isRunning)return;const e=this._scene,t=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate)return this._isRunning=!1,void this.onSuccessObservable.notifyObservers(this);let i=!0,r=!0;for(let n=0;n<t.optimizations.length;n++){const s=t.optimizations[n];s.priority===this._currentPriorityLevel&&(r=!1,i=i&&s.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(s))}if(r)return this._isRunning=!1,void this.onFailureObservable.notifyObservers(this);i&&this._currentPriorityLevel++,e.executeWhenReady((()=>{setTimeout((()=>{this._checkCurrentState()}),this._trackerDuration)}))}dispose(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}static OptimizeAsync(e,t,i,r){const n=new ux(e,t||hx.ModerateDegradationAllowed(),!1);return i&&n.onSuccessObservable.add((()=>{i()})),r&&n.onFailureObservable.add((()=>{r()})),n.start(),n}}let dx=[];const px=(e,t)=>{e.doNotSerialize||(t.vertexData.push(e.serializeVerticeData()),dx[e.id]=!0)},fx=(e,t)=>{const i={},r=e._geometry;return r&&(e.getScene().getGeometryById(r.id)||px(r,t.geometries)),e.serialize&&e.serialize(i),i};class mx{static ClearCache(){dx=[]}static Serialize(e){return mx._Serialize(e)}static _Serialize(e,t=!0){const i={};if(t&&!e.getEngine()._features.supportSyncTextureRead&&_e.g.ForceSerializeBuffers&&f.V.Warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),mx.ClearCache(),i.useDelayedTextureLoading=e.useDelayedTextureLoading,i.autoClear=e.autoClear,i.clearColor=e.clearColor.asArray(),i.ambientColor=e.ambientColor.asArray(),i.gravity=e.gravity.asArray(),i.collisionsEnabled=e.collisionsEnabled,i.useRightHandedSystem=e.useRightHandedSystem,void 0!==e.fogMode&&null!==e.fogMode&&(i.fogMode=e.fogMode),void 0!==e.fogColor&&null!==e.fogColor&&(i.fogColor=e.fogColor.asArray()),void 0!==e.fogStart&&null!==e.fogStart&&(i.fogStart=e.fogStart),void 0!==e.fogEnd&&null!==e.fogEnd&&(i.fogEnd=e.fogEnd),void 0!==e.fogDensity&&null!==e.fogDensity&&(i.fogDensity=e.fogDensity),e.isPhysicsEnabled&&e.isPhysicsEnabled()){const t=e.getPhysicsEngine();t&&(i.physicsEnabled=!0,i.physicsGravity=t.gravity.asArray(),i.physicsEngine=t.getPhysicsPluginName())}e.metadata&&(i.metadata=e.metadata),i.morphTargetManagers=[];for(const t of e.meshes){const e=t.morphTargetManager;e&&i.morphTargetManagers.push(e.serialize())}let r,n,s;for(i.lights=[],r=0;r<e.lights.length;r++)n=e.lights[r],n.doNotSerialize||i.lights.push(n.serialize());for(i.cameras=[],r=0;r<e.cameras.length;r++){const t=e.cameras[r];t.doNotSerialize||i.cameras.push(t.serialize())}if(e.activeCamera&&(i.activeCameraID=e.activeCamera.id),pe.p.AppendSerializedAnimations(e,i),e.animationGroups&&e.animationGroups.length>0){i.animationGroups=[];for(let t=0;t<e.animationGroups.length;t++){const r=e.animationGroups[t];i.animationGroups.push(r.serialize())}}if(e.reflectionProbes&&e.reflectionProbes.length>0)for(i.reflectionProbes=[],r=0;r<e.reflectionProbes.length;r++){const t=e.reflectionProbes[r];i.reflectionProbes.push(t.serialize())}for(i.materials=[],i.multiMaterials=[],r=0;r<e.materials.length;r++)s=e.materials[r],s.doNotSerialize||i.materials.push(s.serialize());for(i.multiMaterials=[],r=0;r<e.multiMaterials.length;r++){const t=e.multiMaterials[r];i.multiMaterials.push(t.serialize())}for(e.environmentTexture&&(e.environmentTexture._files?i.environmentTexture=e.environmentTexture.serialize():(i.environmentTexture=e.environmentTexture.name,i.environmentTextureRotationY=e.environmentTexture.rotationY)),i.environmentIntensity=e.environmentIntensity,i.skeletons=[],r=0;r<e.skeletons.length;r++){const t=e.skeletons[r];t.doNotSerialize||i.skeletons.push(t.serialize())}for(i.transformNodes=[],r=0;r<e.transformNodes.length;r++)e.transformNodes[r].doNotSerialize||i.transformNodes.push(e.transformNodes[r].serialize());i.geometries={},i.geometries.boxes=[],i.geometries.spheres=[],i.geometries.cylinders=[],i.geometries.toruses=[],i.geometries.grounds=[],i.geometries.planes=[],i.geometries.torusKnots=[],i.geometries.vertexData=[],dx=[];const a=e.getGeometries();for(r=0;r<a.length;r++){const e=a[r];e.isReady()&&px(e,i.geometries)}for(i.meshes=[],r=0;r<e.meshes.length;r++){const t=e.meshes[r];if(t instanceof Rt.e){const e=t;e.doNotSerialize||1!==e.delayLoadState&&0!==e.delayLoadState||i.meshes.push(fx(e,i))}}for(i.particleSystems=[],r=0;r<e.particleSystems.length;r++)i.particleSystems.push(e.particleSystems[r].serialize(!1));for(i.postProcesses=[],r=0;r<e.postProcesses.length;r++)i.postProcesses.push(e.postProcesses[r].serialize());e.actionManager&&(i.actions=e.actionManager.serialize("scene"));for(const t of e._serializableComponents)t.serialize(i);if(e.spriteManagers)for(i.spriteManagers=[],r=0;r<e.spriteManagers.length;r++)i.spriteManagers.push(e.spriteManagers[r].serialize(!0));return i}static SerializeAsync(e){const t=mx._Serialize(e,!1),i=[];return this._CollectPromises(t,i),Promise.all(i).then((()=>t))}static _CollectPromises(e,t){if(Array.isArray(e))for(let i=0;i<e.length;++i){const r=e[i];r instanceof Promise?t.push(r.then((t=>e[i]=t))):(r instanceof Object||Array.isArray(r))&&this._CollectPromises(r,t)}else if(e instanceof Object)for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const r=e[i];r instanceof Promise?t.push(r.then((t=>e[i]=t))):(r instanceof Object||Array.isArray(r))&&this._CollectPromises(r,t)}}static SerializeMesh(e,t=!1,i=!1){const r={meshes:[],transformNodes:[],cameras:[],lights:[]};if(mx.ClearCache(),e=e instanceof Array?e:[e],t||i)for(let r=0;r<e.length;++r)i&&e[r].getDescendants().forEach((t=>{e.indexOf(t)<0&&!t.doNotSerialize&&e.push(t)})),t&&e[r].parent&&e.indexOf(e[r].parent)<0&&!e[r].parent.doNotSerialize&&e.push(e[r].parent);return e.forEach((e=>{((e,t)=>{if(e._isMesh){const i=e;if(1===i.delayLoadState||0===i.delayLoadState){const e=e=>{t.materials=t.materials||[],i.material&&!t.materials.some((e=>e.id===i.material.id))&&t.materials.push(e.serialize())};if(i.material&&!i.material.doNotSerialize)if(i.material instanceof Lh.F){if(t.multiMaterials=t.multiMaterials||[],!t.multiMaterials.some((e=>e.id===i.material.id))){t.multiMaterials.push(i.material.serialize());for(const t of i.material.subMaterials)t&&e(t)}}else e(i.material);else i.material||e(i.getScene().defaultMaterial);const r=i._geometry;r&&(t.geometries||(t.geometries={},t.geometries.boxes=[],t.geometries.spheres=[],t.geometries.cylinders=[],t.geometries.toruses=[],t.geometries.grounds=[],t.geometries.planes=[],t.geometries.torusKnots=[],t.geometries.vertexData=[]),px(r,t.geometries)),i.skeleton&&!i.skeleton.doNotSerialize&&(t.skeletons=t.skeletons||[],t.skeletons.push(i.skeleton.serialize())),t.meshes=t.meshes||[],t.meshes.push(fx(i,t))}}else if("TransformNode"===e.getClassName()){const i=e;t.transformNodes.push(i.serialize())}else if(-1!==e.getClassName().indexOf("Camera")){const i=e;t.cameras.push(i.serialize())}else if(-1!==e.getClassName().indexOf("Light")){const i=e;t.lights.push(i.serialize())}})(e,r)})),r}}var _x=i(88836),gx=i(88973),vx=i(98130),Sx=i(4894),xx=i(46153),Tx=i(63665);class Ex{static IsSupported(e,t){const i=t??e.getRenderingCanvas();return!!i&&"function"==typeof i.captureStream}get isRecording(){return!!this._canvas&&this._isRecording}constructor(e,t={}){if(!Ex.IsSupported(e,t.canvas))throw"Your browser does not support recording so far.";const i=t.canvas??e.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._isRecording=!1,this._options={...Ex._DefaultOptions,...t};const r=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(const e of this._options.audioTracks)r.addTrack(e);this._mediaRecorder=new MediaRecorder(r,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=e=>this._handleDataAvailable(e),this._mediaRecorder.onerror=e=>this._handleError(e),this._mediaRecorder.onstop=()=>this._handleStop()}stopRecording(){this._canvas&&this._mediaRecorder&&this.isRecording&&(this._isRecording=!1,this._mediaRecorder.stop())}startRecording(e="babylonjs.webm",t=7){if(!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout((()=>{this.stopRecording()}),1e3*t),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}dispose(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null}_handleDataAvailable(e){e.data.size>0&&this._recordedChunks.push(e.data)}_handleError(e){if(this.stopRecording(),!this._reject)throw new e.error;this._reject(e.error)}_handleStop(){this.stopRecording();const e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&re.S0.Download(e,this._fileName)}}Ex._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3};var Cx=i(78073);class bx extends jt.w{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,r,n,s,a=0){super(e,"fxaa",["texelSize"],null,t,i,r||_e.g.BILINEAR_SAMPLINGMODE,n,s,null,a,"fxaa",void 0,!0);const o=this._getDefines();this.updateEffect(o),this.onApplyObservable.add((e=>{const t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,72358)),Promise.resolve().then(i.bind(i,34444))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,24295)),Promise.resolve().then(i.bind(i,73697))])),super._gatherImports(e,t)}_getDefines(){const e=this.getEngine();return e&&e.extractDriverInfo().toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,r){return pe.p.Parse((()=>new bx(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,o.Y5)("BABYLON.FxaaPostProcess",bx);var Px=i(29900);let yx=null;function Ax(e,t,i,r,n="image/png",s=!1,a){const{height:o,width:l}=Nx(e,t,i);if(!o||!l)return void f.V.Error("Invalid 'size' parameter !");yx||(yx=document.createElement("canvas")),yx.width=l,yx.height=o;const c=yx.getContext("2d"),h=e.getRenderWidth()/e.getRenderHeight();let u=l,d=u/h;d>o&&(d=o,u=d*h);const p=Math.max(0,l-u)/2,m=Math.max(0,o-d)/2;t.getScene().activeCamera!==t?Mx(e,t,i,(e=>{if(s){const t=new Blob([e]);re.S0.DownloadBlob(t),r&&r("")}else r&&r(e)}),n,1,e.getCreationOptions().antialias,void 0,void 0,void 0,void 0,a):e.onEndFrameObservable.addOnce((()=>{const t=e.getRenderingCanvas();c&&t&&c.drawImage(t,p,m,u,d),yx&&(s?(re.S0.EncodeScreenshotCanvasData(yx,void 0,n,void 0,a),r&&r("")):re.S0.EncodeScreenshotCanvasData(yx,r,n,void 0,a))}))}function Rx(e,t,i,r="image/png",n){return new Promise(((s,a)=>{Ax(e,t,i,(e=>{void 0!==e?s(e):a(new Error("Data is undefined"))}),r,void 0,n)}))}function Ix(e,t,i,r,n="image/png",s){return new Promise((a=>{Ax(e,t,{width:i,height:r},(()=>{a()}),n,!0,s)}))}function Mx(e,t,r,n,s="image/png",a=1,o=!1,l,c=!1,h=!1,u=!0,d,p){const{height:m,width:_,finalWidth:g,finalHeight:v}=Nx(e,t,r),S={width:_,height:m};if(!m||!_)return void f.V.Error("Invalid 'size' parameter !");const x={width:e.getRenderWidth(),height:e.getRenderHeight()};e.setSize(_,m);const T=t.getScene(),E=new Si.$("screenShot",S,T,!1,!1,0,!1,_e.g.BILINEAR_SAMPLINGMODE,void 0,h,void 0,void 0,void 0,a);E.renderList=T.meshes.slice(),E.samples=a,E.renderSprites=c,E.activeCamera=t,E.forceLayerMaskCheck=u,p?.(E);const C=()=>{E.isReadyForRendering()&&t.isReady(!0)?(e.onEndFrameObservable.addOnce((()=>{g===_&&v===m?E.readPixels(void 0,void 0,void 0,!1).then((e=>{(0,Px.DumpData)(_,m,e,n,s,l,!0,void 0,d),E.dispose()})):(e.isWebGPU?Promise.resolve().then(i.bind(i,35385)):Promise.resolve().then(i.bind(i,38752))).then((()=>(0,kh.Qs)("pass",E.getInternalTexture(),T,void 0,void 0,void 0,g,v).then((t=>{e._readTexturePixels(t,g,v,-1,0,null,!0,!1,0,0).then((e=>{(0,Px.DumpData)(g,v,e,n,s,l,!0,void 0,d),t.dispose()}))}))))})),T.incrementRenderId(),T.resetCachedMaterial(),E.render(!0),e.setSize(x.width,x.height),t.getProjectionMatrix(!0)):setTimeout(C,16)},b=()=>{T.incrementRenderId(),T.resetCachedMaterial(),C()};if(o){const e=new bx("antialiasing",1,T.activeCamera);E.addPostProcess(e),e.onEffectCreatedObservable.addOnce((e=>{e.isReady()?b():e.onCompiled=()=>{b()}}))}else b()}function Ox(e,t,i,r="image/png",n=1,s=!1,a,o=!1,l=!1,c=!0,h,u){return new Promise(((d,p)=>{Mx(e,t,i,(e=>{void 0!==e?d(e):p(new Error("Data is undefined"))}),r,n,s,a,o,l,c,h,u)}))}function Nx(e,t,i){let r=0,n=0,s=0,a=0;if("object"==typeof i){const o=i.precision?Math.abs(i.precision):1;i.width&&i.height?(r=i.height*o,n=i.width*o):i.width&&!i.height?(n=i.width*o,r=Math.round(n/e.getAspectRatio(t))):i.height&&!i.width?(r=i.height*o,n=Math.round(r*e.getAspectRatio(t))):(n=Math.round(e.getRenderWidth()*o),r=Math.round(n/e.getAspectRatio(t))),i.finalWidth&&i.finalHeight?(a=i.finalHeight,s=i.finalWidth):i.finalWidth&&!i.finalHeight?(s=i.finalWidth,a=Math.round(s/e.getAspectRatio(t))):i.finalHeight&&!i.finalWidth?(a=i.finalHeight,s=Math.round(a*e.getAspectRatio(t))):(s=n,a=r)}else isNaN(i)||(r=i,n=i,s=i,a=i);return n&&(n=Math.floor(n)),r&&(r=Math.floor(r)),s&&(s=Math.floor(s)),a&&(a=Math.floor(a)),{height:0|r,width:0|n,finalWidth:0|s,finalHeight:0|a}}const Dx={CreateScreenshot:Ax,CreateScreenshotAsync:Rx,CreateScreenshotWithResizeAsync:Ix,CreateScreenshotUsingRenderTarget:Mx,CreateScreenshotUsingRenderTargetAsync:Ox};var Fx;re.S0.CreateScreenshot=Ax,re.S0.CreateScreenshotAsync=Rx,re.S0.CreateScreenshotUsingRenderTarget=Mx,re.S0.CreateScreenshotUsingRenderTargetAsync=Ox,function(e){e[e.Checkbox=0]="Checkbox",e[e.Slider=1]="Slider",e[e.Vector3=2]="Vector3",e[e.Quaternion=3]="Quaternion",e[e.Color3=4]="Color3",e[e.String=5]="String",e[e.Button=6]="Button",e[e.Options=7]="Options",e[e.Tab=8]="Tab",e[e.FileButton=9]="FileButton",e[e.Vector2=10]="Vector2"}(Fx||(Fx={}));var Lx=i(68642);class wx{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){this.color2?a.ov.LerpToRef(this.color1,this.color2,Math.random(),e):e.copyFrom(this.color1)}}class Bx{constructor(e,t){this.gradient=e,this.color=t}}class Vx{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return void 0===this.factor2||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class kx{static GetCurrentGradient(e,t,i){if(t[0].gradient>e)return void i(t[0],t[0],1);for(let r=0;r<t.length-1;r++){const n=t[r],s=t[r+1];if(e>=n.gradient&&e<=s.gradient)return void i(n,s,(e-n.gradient)/(s.gradient-n.gradient))}const r=t.length-1;i(t[r],t[r],1)}}var Gx=i(24682),Ux=i(74450);class zx{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{const e={};return{getItem:t=>{const i=e[t];return void 0===i?null:i},setItem:(t,i)=>{e[t]=i}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return null!==i?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return null!==i?"true"===i:t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return null!==i?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}zx._Storage=zx._GetStorage();class Wx{constructor(e){this.particleSystem=e,this.position=s.Pq.Zero(),this.direction=s.Pq.Zero(),this.color=new a.ov(0,0,0,0),this.colorStep=new a.ov(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new s.I9(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new a.ov(0,0,0,0),this._currentColor2=new a.ov(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=Wx._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(void 0===this._randomCellOffset&&(this._randomCellOffset=Math.random()*this.lifeTime),0===t?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID+1;let r;r=this._initialSpriteCellLoop?(0,it.Clamp)(e*t%this.lifeTime/this.lifeTime):(0,it.Clamp)(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+r*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const e=s.AA.Vector3[0];this.direction.normalizeToRef(e),t.setDirection(e,0,Math.PI/2)}}else e.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(e.inheritedVelocityAmount/2,s.AA.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(s.AA.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach((e=>{this._inheritParticleInfoToSubEmitter(e)}))}_reset(){this.age=0,this.id=Wx._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new s.IU(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}Wx._Count=0;class Hx{constructor(){this.direction1=new s.Pq(0,1,0),this.direction2=new s.Pq(0,1,0),this.minEmitBox=new s.Pq(-.5,-.5,-.5),this.maxEmitBox=new s.Pq(.5,.5,.5)}startDirectionFunction(e,t,i,r){const n=(0,it.RandomRange)(this.direction1.x,this.direction2.x),a=(0,it.RandomRange)(this.direction1.y,this.direction2.y),o=(0,it.RandomRange)(this.direction1.z,this.direction2.z);if(r)return t.x=n,t.y=a,void(t.z=o);s.Pq.TransformNormalFromFloatsToRef(n,a,o,e,t)}startPositionFunction(e,t,i,r){const n=(0,it.RandomRange)(this.minEmitBox.x,this.maxEmitBox.x),a=(0,it.RandomRange)(this.minEmitBox.y,this.maxEmitBox.y),o=(0,it.RandomRange)(this.minEmitBox.z,this.maxEmitBox.z);if(r)return t.x=n,t.y=a,void(t.z=o);s.Pq.TransformCoordinatesFromFloatsToRef(n,a,o,e,t)}clone(){const e=new Hx;return y.r.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){s.Pq.FromArrayToRef(e.direction1,0,this.direction1),s.Pq.FromArrayToRef(e.direction2,0,this.direction2),s.Pq.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),s.Pq.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}var Yx,Xx=i(77950);class qx extends $l{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}get shaderLanguage(){return this._shaderLanguage}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new ec.E(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new n.cP),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,r=null,o=!1,l=.01){super(e),this._emitterInverseWorldMatrix=s.uq.Identity(),this._inheritedVelocityOffset=new s.Pq,this.onDisposeObservable=new n.cP,this.onStoppedObservable=new n.cP,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new a.ov(0,0,0,0),this._colorDiff=new a.ov(0,0,0,0),this._scaledDirection=s.Pq.Zero(),this._scaledGravity=s.Pq.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this.isLocal=!1,this.isGPU=!1,this._shaderLanguage=0,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=e=>{},this.recycleParticle=e=>{const t=this._particles.pop();t!==e&&t.copyTo(e),this._stockParticles.push(t)},this._createParticle=()=>{let e;return 0!==this._stockParticles.length?(e=this._stockParticles.pop(),e._reset()):e=new Wx(this),this._prepareParticle(e),e},this._shadersLoaded=!1,this._capacity=t,this._epsilon=l,this._isAnimationSheetEnabled=o,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=s.uq.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||P.q.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._initShaderSourceAsync(),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new ec.E(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new Hx;let c=null;this.updateFunction=e=>{let t=null;this.noiseTexture&&(t=this.noiseTexture.getSize(),this.noiseTexture.getContent()?.then((e=>{c=e})));const i=e===this._particles;for(let r=0;r<e.length;r++){const n=e[r];let o=this._scaledUpdateSpeed;const l=n.age;if(n.age+=o,n.age>n.lifeTime){const e=n.age-l;o=(n.lifeTime-l)*o/e,n.age=n.lifeTime}const h=n.age/n.lifeTime;this._colorGradients&&this._colorGradients.length>0?kx.GetCurrentGradient(h,this._colorGradients,((e,t,i)=>{e!==n._currentColorGradient&&(n._currentColor1.copyFrom(n._currentColor2),t.getColorToRef(n._currentColor2),n._currentColorGradient=e),a.ov.LerpToRef(n._currentColor1,n._currentColor2,i,n.color)})):(n.colorStep.scaleToRef(o,this._scaledColorStep),n.color.addInPlace(this._scaledColorStep),n.color.a<0&&(n.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&kx.GetCurrentGradient(h,this._angularSpeedGradients,((e,t,i)=>{e!==n._currentAngularSpeedGradient&&(n._currentAngularSpeed1=n._currentAngularSpeed2,n._currentAngularSpeed2=t.getFactor(),n._currentAngularSpeedGradient=e),n.angularSpeed=(0,it.Lerp)(n._currentAngularSpeed1,n._currentAngularSpeed2,i)})),n.angle+=n.angularSpeed*o;let u=o;if(this._velocityGradients&&this._velocityGradients.length>0&&kx.GetCurrentGradient(h,this._velocityGradients,((e,t,i)=>{e!==n._currentVelocityGradient&&(n._currentVelocity1=n._currentVelocity2,n._currentVelocity2=t.getFactor(),n._currentVelocityGradient=e),u*=(0,it.Lerp)(n._currentVelocity1,n._currentVelocity2,i)})),n.direction.scaleToRef(u,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&kx.GetCurrentGradient(h,this._limitVelocityGradients,((e,t,i)=>{e!==n._currentLimitVelocityGradient&&(n._currentLimitVelocity1=n._currentLimitVelocity2,n._currentLimitVelocity2=t.getFactor(),n._currentLimitVelocityGradient=e);const r=(0,it.Lerp)(n._currentLimitVelocity1,n._currentLimitVelocity2,i);n.direction.length()>r&&n.direction.scaleInPlace(this.limitVelocityDamping)})),this._dragGradients&&this._dragGradients.length>0&&kx.GetCurrentGradient(h,this._dragGradients,((e,t,i)=>{e!==n._currentDragGradient&&(n._currentDrag1=n._currentDrag2,n._currentDrag2=t.getFactor(),n._currentDragGradient=e);const r=(0,it.Lerp)(n._currentDrag1,n._currentDrag2,i);this._scaledDirection.scaleInPlace(1-r)})),this.isLocal&&n._localPosition?(n._localPosition.addInPlace(this._scaledDirection),s.Pq.TransformCoordinatesToRef(n._localPosition,this._emitterWorldMatrix,n.position)):n.position.addInPlace(this._scaledDirection),c&&t&&n._randomNoiseCoordinates1){const e=this._fetchR(n._randomNoiseCoordinates1.x,n._randomNoiseCoordinates1.y,t.width,t.height,c),i=this._fetchR(n._randomNoiseCoordinates1.z,n._randomNoiseCoordinates2.x,t.width,t.height,c),r=this._fetchR(n._randomNoiseCoordinates2.y,n._randomNoiseCoordinates2.z,t.width,t.height,c),a=s.AA.Vector3[0],l=s.AA.Vector3[1];a.copyFromFloats((2*e-1)*this.noiseStrength.x,(2*i-1)*this.noiseStrength.y,(2*r-1)*this.noiseStrength.z),a.scaleToRef(o,l),n.direction.addInPlace(l)}this.gravity.scaleToRef(o,this._scaledGravity),n.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&kx.GetCurrentGradient(h,this._sizeGradients,((e,t,i)=>{e!==n._currentSizeGradient&&(n._currentSize1=n._currentSize2,n._currentSize2=t.getFactor(),n._currentSizeGradient=e),n.size=(0,it.Lerp)(n._currentSize1,n._currentSize2,i)})),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&kx.GetCurrentGradient(h,this._colorRemapGradients,((e,t,i)=>{const r=(0,it.Lerp)(e.factor1,t.factor1,i),s=(0,it.Lerp)(e.factor2,t.factor2,i);n.remapData.x=r,n.remapData.y=s-r})),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&kx.GetCurrentGradient(h,this._alphaRemapGradients,((e,t,i)=>{const r=(0,it.Lerp)(e.factor1,t.factor1,i),s=(0,it.Lerp)(e.factor2,t.factor2,i);n.remapData.z=r,n.remapData.w=s-r}))),this._isAnimationSheetEnabled&&n.updateCellIndex(),n._inheritParticleInfoToSubEmitters(),n.age>=n.lifeTime&&(this._emitFromParticle(n),n._attachedSubEmitters&&(n._attachedSubEmitters.forEach((e=>{e.particleSystem.disposeOnStop=!0,e.particleSystem.stop()})),n._attachedSubEmitters=null),this.recycleParticle(n),i&&r--)}}}serialize(e){throw new Error("Method not implemented.")}clone(e,t,i=!1){throw new Error("Method not implemented.")}_addFactorGradient(e,t,i,r){const n=new Vx(t,i,r);e.push(n),e.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0))}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const r of e){if(r.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(4*this._rawTextureWidth),t=a.IG.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;kx.GetCurrentGradient(r,this._rampGradients,((r,n,s)=>{a.v9.LerpToRef(r.color,n.color,s,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255}))}this._rampGradientsTexture=me.I.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new Bx(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const r=new wx(e,t,i);return this._colorGradients.push(r),this._colorGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)t?.dispose();this._drawWrappers=[]}_fetchR(e,t,i,r,n){return n[4*(((e=.5*Math.abs(e)+.5)*i%i|0)+((t=.5*Math.abs(t)+.5)*r%r|0)*i)]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&8!==this.billboardMode&&9!==this.billboardMode||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new Ue.h(e,this._vertexData,!0,t);let i=0;const r=this._vertexBuffer.createVertexBuffer(Ue.R.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Ue.R.PositionKind]=r,i+=3;const n=this._vertexBuffer.createVertexBuffer(Ue.R.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[Ue.R.ColorKind]=n,i+=4;const s=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=s,i+=1;const a=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=a,i+=2,this._isAnimationSheetEnabled){const e=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=e,i+=1}if(!this._isBillboardBased||8===this.billboardMode||9===this.billboardMode){const e=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=e,i+=3}if(this._useRampGradients){const e=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=e,i+=4}let o;if(this._useInstancing){const t=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Ue.h(e,t,!1,2),o=this._spriteBuffer.createVertexBuffer("offset",0,2)}else o=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=o,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return void(this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3])));const e=[],t=[];let i=0;for(let r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e)setTimeout((()=>{this.start(0)}),e);else{if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){-1!==this.emitter?.getClassName().indexOf("Mesh")&&this.emitter.computeWorldMatrix(!0);const e=this.noiseTexture;if(e&&e.onGeneratedObservable)e.onGeneratedObservable.addOnce((()=>{setTimeout((()=>{for(let t=0;t<this.preWarmCycles;t++)this.animate(!0),e.render()}))}));else for(let e=0;e<this.preWarmCycles;e++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(e))}_postStop(e){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,r){let n=e*this._vertexBufferSize;if(this._vertexData[n++]=t.position.x+this.worldOffset.x,this._vertexData[n++]=t.position.y+this.worldOffset.y,this._vertexData[n++]=t.position.z+this.worldOffset.z,this._vertexData[n++]=t.color.r,this._vertexData[n++]=t.color.g,this._vertexData[n++]=t.color.b,this._vertexData[n++]=t.color.a,this._vertexData[n++]=t.angle,this._vertexData[n++]=t.scale.x*t.size,this._vertexData[n++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[n++]=t.cellIndex),this._isBillboardBased)8!==this.billboardMode&&9!==this.billboardMode||(this._vertexData[n++]=t.direction.x,this._vertexData[n++]=t.direction.y,this._vertexData[n++]=t.direction.z);else if(t._initialDirection){let e=t._initialDirection;this.isLocal&&(s.Pq.TransformNormalToRef(e,this._emitterWorldMatrix,s.AA.Vector3[0]),e=s.AA.Vector3[0]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[n++]=e.x,this._vertexData[n++]=e.y,this._vertexData[n++]=e.z}else{let e=t.direction;this.isLocal&&(s.Pq.TransformNormalToRef(e,this._emitterWorldMatrix,s.AA.Vector3[0]),e=s.AA.Vector3[0]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[n++]=e.x,this._vertexData[n++]=e.y,this._vertexData[n++]=e.z}this._useRampGradients&&t.remapData&&(this._vertexData[n++]=t.remapData.x,this._vertexData[n++]=t.remapData.y,this._vertexData[n++]=t.remapData.z,this._vertexData[n++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon)),this._vertexData[n++]=i,this._vertexData[n++]=r)}_prepareParticle(e){}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const e=this.emitter;this._emitterWorldMatrix=e.getWorldMatrix()}else{const e=this.emitter;this._emitterWorldMatrix=s.uq.Translation(e.x,e.y,e.z)}let t;this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const e=(0,it.Clamp)(this._actualFrame/this.targetStopDuration);kx.GetCurrentGradient(e,this._lifeTimeGradients,((i,r)=>{const n=i,s=r,a=n.getFactor(),o=s.getFactor(),l=(e-n.gradient)/(s.gradient-n.gradient);t.lifeTime=(0,it.Lerp)(a,o,l)}))}else t.lifeTime=(0,it.RandomRange)(this.minLifeTime,this.maxLifeTime);const e=(0,it.RandomRange)(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),s.Pq.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),0===e?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(e),this._sizeGradients&&0!==this._sizeGradients.length?(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1):t.size=(0,it.RandomRange)(this.minSize,this.maxSize),t.scale.copyFromFloats((0,it.RandomRange)(this.minScaleX,this.maxScaleX),(0,it.RandomRange)(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const e=this._actualFrame/this.targetStopDuration;kx.GetCurrentGradient(e,this._startSizeGradients,((e,i,r)=>{e!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=i.getFactor(),this._currentStartSizeGradient=e);const n=(0,it.Lerp)(this._currentStartSize1,this._currentStartSize2,r);t.scale.scaleInPlace(n)}))}if(this._angularSpeedGradients&&0!==this._angularSpeedGradients.length?(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1):t.angularSpeed=(0,it.RandomRange)(this.minAngularSpeed,this.maxAngularSpeed),t.angle=(0,it.RandomRange)(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),this._colorGradients&&0!==this._colorGradients.length)t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);else{const e=(0,it.RandomRange)(0,1);a.ov.LerpToRef(this.color1,this.color2,e,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new s.IU(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new s.Pq(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new s.Pq(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const r=[Ue.R.PositionKind,Ue.R.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){const r=["invView","view","projection","textureMask","translationPivot","eyePosition"];return(0,Xo.TV)(r),e&&r.push("particlesInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t,i=!0){if(this._scene&&((0,Xo.tv)(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&0!==this._scene.fogMode&&e.push("#define FOG")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===$l.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case 2:e.push("#define BILLBOARDY");break;case 8:case 9:e.push("#define BILLBOARDSTRETCHED"),9===this.billboardMode&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:e.push("#define BILLBOARDMODE_ALL")}i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...qx._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&8!==this.billboardMode&&9!==this.billboardMode,this._useRampGradients)),e.push(...qx._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&((0,Xx._)(e,this._imageProcessingConfigurationDefines),(0,Xx.C)(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t?.effect)return t;const i=[];this.fillDefines(i,e);const r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let n=this._drawWrappers[r];n||(n=this._drawWrappers[r]=[]);let s=n[e];s||(s=new ec.E(this._engine),s.drawContext&&(s.drawContext.useInstancing=this._useInstancing),n[e]=s);const a=i.join("\n");if(s.defines!==a){const e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),s.setEffect(this._engine.createEffect("particles",e,t,i,a,void 0,void 0,void 0,void 0,this._shaderLanguage),a)}return s}animate(e=!1){if(!this._started)return;if(!e&&this._scene){if(!this.isReady())return;if(this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}let t;if(this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this.manualEmitCount>-1)t=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let e=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const t=this._actualFrame/this.targetStopDuration;kx.GetCurrentGradient(t,this._emitRateGradients,((t,i,r)=>{t!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=i.getFactor(),this._currentEmitRateGradient=t),e=(0,it.Lerp)(this._currentEmitRate1,this._currentEmitRate2,r)}))}t=e*this._scaledUpdateSpeed|0,this._newPartsExcess+=e*this._scaledUpdateSpeed-t}if(this._newPartsExcess>1&&(t+=0|this._newPartsExcess,this._newPartsExcess-=0|this._newPartsExcess),this._alive=!1,this._stopped?t=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(t),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let e=0;for(let t=0;t<this._particles.length;t++){const i=this._particles[t];this._appendParticleVertices(e,i),e+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),this._spriteBuffer?._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!qx.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,60887)),Promise.resolve().then(i.bind(i,18269))])):await Promise.all([Promise.resolve().then(i.bind(i,28044)),Promise.resolve().then(i.bind(i,66726))]),this._shadersLoaded=!0}isReady(){if(!this._shadersLoaded)return!1;if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==$l.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper($l.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper($l.BLENDMODE_ADD).effect.isReady())return!1}return!0}_render(e){const t=this._getWrapper(e),i=t.effect,r=this._engine;r.enableEffect(t);const n=this.defaultViewMatrix??this._scene.getViewMatrix();if(i.setTexture("diffuseSampler",this.particleTexture),i.setMatrix("view",n),i.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const e=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,this.spriteCellWidth/e.width)}if(i.setVector2("translationPivot",this.translationPivot),i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const e=this._scene.activeCamera;i.setVector3("eyePosition",e.globalPosition)}this._rampGradientsTexture&&(this._rampGradients&&this._rampGradients.length||(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),i.setTexture("rampSampler",this._rampGradientsTexture));const a=i.defines;switch(this._scene&&((0,Xo.gS)(i,this,this._scene),this.applyFog&&(0,qo.Yy)(this._scene,void 0,i)),a.indexOf("#define BILLBOARDMODE_ALL")>=0&&(n.invertToRef(s.AA.Matrix[0]),i.setMatrix("invView",s.AA.Matrix[0])),void 0!==this._vertexArrayObject?this._scene?.forceWireframe?r.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,i):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,null,i)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:this._indexBuffer)):this._indexBuffer?r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBuffer:this._indexBuffer,i):r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null,i),this.useLogarithmicDepth&&this._scene&&(0,qo.DL)(a,i,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(i),e){case $l.BLENDMODE_ADD:r.setAlphaMode(1);break;case $l.BLENDMODE_ONEONE:r.setAlphaMode(6);break;case $l.BLENDMODE_STANDARD:r.setAlphaMode(2);break;case $l.BLENDMODE_MULTIPLY:r.setAlphaMode(4)}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(i),this._useInstancing?this._scene?.forceWireframe?r.drawElementsType(6,0,10,this._particles.length):r.drawArraysType(7,0,4,this._particles.length):this._scene?.forceWireframe?r.drawElementsType(1,0,10*this._particles.length):r.drawElementsType(0,0,6*this._particles.length),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return t=this.blendMode===$l.BLENDMODE_MULTIPLYADD?this._render($l.BLENDMODE_MULTIPLY)+this._render($l.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}_onDispose(e=!1,t=!1){}dispose(e=!0,t=!1,i=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(t,i),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}}qx.ForceGLSL=!1,function(e){e[e.ATTACHED=0]="ATTACHED",e[e.END=1]="END"}(Yx||(Yx={}));class $x{constructor(e){if(this.particleSystem=e,this.type=1,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=(0,o.n9)("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;e?e instanceof s.Pq?e=e.clone():-1!==e.getClassName().indexOf("Mesh")&&(e=new((0,o.n9)("BABYLON.Mesh"))("",e.getScene()),e.isVisible=!1):e=new s.Pq;const t=new $x(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,r=!1){throw(0,Oc.n)("ParseParticle")}static Parse(e,t,i){const r=e.particleSystem,n=new $x($x._ParseParticleSystem(r,t,i,!0));return n.type=e.type,n.inheritDirection=e.inheritDirection,n.inheritedVelocityAmount=e.inheritedVelocityAmount,n.particleSystem._isSubEmitter=!0,n}dispose(){this.particleSystem.dispose()}}class jx{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(Ue.R.PositionKind),this._normals=e.getVerticesData(Ue.R.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=s.Pq.Zero(),this._mesh=null,this.direction1=new s.Pq(0,1,0),this.direction2=new s.Pq(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,r){if(this.useMeshNormalsForDirection&&this._normals)return void s.Pq.TransformNormalToRef(this._storedNormal,e,t);const n=(0,it.RandomRange)(this.direction1.x,this.direction2.x),a=(0,it.RandomRange)(this.direction1.y,this.direction2.y),o=(0,it.RandomRange)(this.direction1.z,this.direction2.z);r?t.copyFromFloats(n,a,o):s.Pq.TransformNormalFromFloatsToRef(n,a,o,e,t)}startPositionFunction(e,t,i,r){if(!this._indices||!this._positions)return;const n=3*Math.random()*(this._indices.length/3)|0,a=Math.random(),o=Math.random()*(1-a),l=1-a-o,c=this._indices[n],h=this._indices[n+1],u=this._indices[n+2],d=s.AA.Vector3[0],p=s.AA.Vector3[1],f=s.AA.Vector3[2],m=s.AA.Vector3[3];s.Pq.FromArrayToRef(this._positions,3*c,d),s.Pq.FromArrayToRef(this._positions,3*h,p),s.Pq.FromArrayToRef(this._positions,3*u,f),m.x=a*d.x+o*p.x+l*f.x,m.y=a*d.y+o*p.y+l*f.y,m.z=a*d.z+o*p.z+l*f.z,r?t.copyFromFloats(m.x,m.y,m.z):s.Pq.TransformCoordinatesFromFloatsToRef(m.x,m.y,m.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(s.Pq.FromArrayToRef(this._normals,3*c,d),s.Pq.FromArrayToRef(this._normals,3*h,p),s.Pq.FromArrayToRef(this._normals,3*u,f),this._storedNormal.x=a*d.x+o*p.x+l*f.x,this._storedNormal.y=a*d.y+o*p.y+l*f.y,this._storedNormal.z=a*d.z+o*p.z+l*f.z)}clone(){const e=new jx(this.mesh);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=this.mesh?.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(e,t){s.Pq.FromArrayToRef(e.direction1,0,this.direction1),s.Pq.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class Kx{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,r){const n=s.AA.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,n);const e=s.AA.Vector3[1];n.subtractToRef(i.position,e),e.scaleToRef(1/i.lifeTime,n)}else n.set(0,0,0);r?t.copyFrom(n):s.Pq.TransformNormalToRef(n,e,t)}startPositionFunction(e,t,i,r){const n=s.AA.Vector3[0];this.particlePositionGenerator?this.particlePositionGenerator(-1,i,n):n.set(0,0,0),r?t.copyFrom(n):s.Pq.TransformCoordinatesToRef(n,e,t)}clone(){const e=new Kx;return y.r.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.particlePositionGenerator=this.particlePositionGenerator,e.particleDestinationGenerator=this.particleDestinationGenerator,e}parse(e){e.particlePositionGenerator&&(this.particlePositionGenerator=e.particlePositionGenerator),e.particleDestinationGenerator&&(this.particleDestinationGenerator=e.particleDestinationGenerator)}}class Zx{constructor(){this.direction1=new s.Pq(0,1,0),this.direction2=new s.Pq(0,1,0)}startDirectionFunction(e,t,i,r){const n=(0,it.RandomRange)(this.direction1.x,this.direction2.x),a=(0,it.RandomRange)(this.direction1.y,this.direction2.y),o=(0,it.RandomRange)(this.direction1.z,this.direction2.z);r?t.copyFromFloats(n,a,o):s.Pq.TransformNormalFromFloatsToRef(n,a,o,e,t)}startPositionFunction(e,t,i,r){r?t.copyFromFloats(0,0,0):s.Pq.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new Zx;return y.r.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){s.Pq.FromArrayToRef(e.direction1,0,this.direction1),s.Pq.FromArrayToRef(e.direction2,0,this.direction2)}}class Qx{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const n=i.position.subtract(e.getTranslation()).normalize(),a=(0,it.RandomRange)(0,this.directionRandomizer),o=(0,it.RandomRange)(0,this.directionRandomizer),l=(0,it.RandomRange)(0,this.directionRandomizer);n.x+=a,n.y+=o,n.z+=l,n.normalize(),r?t.copyFrom(n):s.Pq.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,r){const n=this.radius-(0,it.RandomRange)(0,this.radius*this.radiusRange),a=(0,it.RandomRange)(0,1),o=(0,it.RandomRange)(0,2*Math.PI),l=Math.acos(2*a-1),c=n*Math.cos(o)*Math.sin(l),h=n*Math.cos(l),u=n*Math.sin(o)*Math.sin(l);r?t.copyFromFloats(c,Math.abs(h),u):s.Pq.TransformCoordinatesFromFloatsToRef(c,Math.abs(h),u,e,t)}clone(){const e=new Qx(this.radius,this.directionRandomizer);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Jx{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const n=i.position.subtract(e.getTranslation()).normalize(),a=(0,it.RandomRange)(0,this.directionRandomizer),o=(0,it.RandomRange)(0,this.directionRandomizer),l=(0,it.RandomRange)(0,this.directionRandomizer);n.x+=a,n.y+=o,n.z+=l,n.normalize(),r?t.copyFrom(n):s.Pq.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,r){const n=this.radius-(0,it.RandomRange)(0,this.radius*this.radiusRange),a=(0,it.RandomRange)(0,1),o=(0,it.RandomRange)(0,2*Math.PI),l=Math.acos(2*a-1),c=n*Math.cos(o)*Math.sin(l),h=n*Math.cos(l),u=n*Math.sin(o)*Math.sin(l);r?t.copyFromFloats(c,h,u):s.Pq.TransformCoordinatesFromFloatsToRef(c,h,u,e,t)}clone(){const e=new Jx(this.radius,this.directionRandomizer);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class eT extends Jx{constructor(e=1,t=new s.Pq(0,1,0),i=new s.Pq(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=(0,it.RandomRange)(this.direction1.x,this.direction2.x),r=(0,it.RandomRange)(this.direction1.y,this.direction2.y),n=(0,it.RandomRange)(this.direction1.z,this.direction2.z);s.Pq.TransformNormalFromFloatsToRef(i,r,n,e,t)}clone(){const e=new eT(this.radius,this.direction1,this.direction2);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class tT{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=s.Pq.Zero()}startDirectionFunction(e,t,i,r,n){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),s.Pq.TransformNormalToRef(this._tempVector,n,this._tempVector);const a=(0,it.RandomRange)(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);o+=(0,it.RandomRange)(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=a,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),r?t.copyFrom(this._tempVector):s.Pq.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){const n=(0,it.RandomRange)(-this.height/2,this.height/2),a=(0,it.RandomRange)(0,2*Math.PI),o=(0,it.RandomRange)((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(o)*this.radius,c=l*Math.cos(a),h=l*Math.sin(a);r?t.copyFromFloats(c,n,h):s.Pq.TransformCoordinatesFromFloatsToRef(c,n,h,e,t)}clone(){const e=new tT(this.radius,this.directionRandomizer);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class iT extends tT{constructor(e=1,t=1,i=1,r=new s.Pq(0,1,0),n=new s.Pq(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=n}startDirectionFunction(e,t,i,r){const n=(0,it.RandomRange)(this.direction1.x,this.direction2.x),a=(0,it.RandomRange)(this.direction1.y,this.direction2.y),o=(0,it.RandomRange)(this.direction1.z,this.direction2.z);r?t.copyFromFloats(n,a,o):s.Pq.TransformNormalFromFloatsToRef(n,a,o,e,t)}clone(){const e=new iT(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),s.Pq.FromArrayToRef(e.direction1,0,this.direction1),s.Pq.FromArrayToRef(e.direction2,0,this.direction2)}}class rT{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){r?s.AA.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),s.AA.Vector3[0]).normalize();const n=(0,it.RandomRange)(0,this.directionRandomizer),a=(0,it.RandomRange)(0,this.directionRandomizer),o=(0,it.RandomRange)(0,this.directionRandomizer);t.x=s.AA.Vector3[0].x+n,t.y=s.AA.Vector3[0].y+a,t.z=s.AA.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,r){const n=(0,it.RandomRange)(0,2*Math.PI);let a;this.emitFromSpawnPointOnly?a=1e-4:(a=(0,it.RandomRange)(0,this.heightRange),a=1-a*a);let o=this._radius-(0,it.RandomRange)(0,this._radius*this.radiusRange);o*=a;const l=o*Math.sin(n),c=o*Math.cos(n),h=a*this._height;if(r)return t.x=l,t.y=h,void(t.z=c);s.Pq.TransformCoordinatesFromFloatsToRef(l,h,c,e,t)}clone(){const e=new rT(this._radius,this._angle,this.directionRandomizer);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=void 0!==e.radiusRange?e.radiusRange:1,this.heightRange=void 0!==e.radiusRange?e.heightRange:1,this.emitFromSpawnPointOnly=void 0!==e.emitFromSpawnPointOnly&&e.emitFromSpawnPointOnly}}class nT extends rT{constructor(e=1,t=Math.PI,i=new s.Pq(0,1,0),r=new s.Pq(0,1,0)){super(e,t),this.direction1=i,this.direction2=r}startDirectionFunction(e,t){const i=(0,it.RandomRange)(this.direction1.x,this.direction2.x),r=(0,it.RandomRange)(this.direction1.y,this.direction2.y),n=(0,it.RandomRange)(this.direction1.z,this.direction2.z);s.Pq.TransformNormalFromFloatsToRef(i,r,n,e,t)}clone(){const e=new nT(this.radius,this.angle,this.direction1,this.direction2);return y.r.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CONEEMITTER\n#define DIRECTEDCONEEMITTER"}getClassName(){return"ConeDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}function sT(e,t){const i=new Zx;return i.direction1=e,i.direction2=t,i}function aT(e=1,t=1){return new Qx(e,t)}function oT(e=1,t=1){return new Jx(e,t)}function lT(e=1,t=new s.Pq(0,1,0),i=new s.Pq(0,1,0)){return new eT(e,t,i)}function cT(e=1,t=1,i=1,r=0){return new tT(e,t,i,r)}function hT(e=1,t=1,i=1,r=new s.Pq(0,1,0),n=new s.Pq(0,1,0)){return new iT(e,t,i,r,n)}function uT(e=1,t=Math.PI/4){return new rT(e,t)}function dT(e=1,t=Math.PI/4,i=new s.Pq(0,1,0),r=new s.Pq(0,1,0)){return new nT(e,t,i,r)}class pT extends qx{constructor(){super(...arguments),this._disposeEmitterOnDispose=!1,this._emitFromParticle=e=>{if(!this._subEmitters||0===this._subEmitters.length)return;const t=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[t].forEach((t=>{if(1===t.type){const i=t.clone();e._inheritParticleInfoToSubEmitter(i),i.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(i.particleSystem),i.particleSystem.start()}}))}}createPointEmitter(e,t){const i=sT(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=aT(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=oT(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new s.Pq(0,1,0),i=new s.Pq(0,1,0)){const r=lT(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const n=cT(e,t,i,r);return this.particleEmitterType=n,n}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new s.Pq(0,1,0),n=new s.Pq(0,1,0)){const a=hT(e,t,i,r,n);return this.particleEmitterType=a,a}createConeEmitter(e=1,t=Math.PI/4){const i=uT(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new s.Pq(0,1,0),r=new s.Pq(0,1,0)){const n=dT(e,t,i,r);return this.particleEmitterType=n,n}createBoxEmitter(e,t,i,r){const n=new Hx;return this.particleEmitterType=n,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,n}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach((e=>{e instanceof pT?this._subEmitters.push([new $x(e)]):e instanceof $x?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)}))}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach((e=>{e.stop(!0)})),this.activeSubSystems=[])}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);-1!==e&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_preStart(){this._prepareSubEmitterInternalArray(),this._subEmitters&&0!=this._subEmitters.length&&(this.activeSubSystems=[])}_postStop(e){e&&this._stopSubEmitters()}_prepareParticle(e){if(this._subEmitters&&this._subEmitters.length>0){const t=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];e._attachedSubEmitters=[],t.forEach((t=>{if(0===t.type){const i=t.clone();e._attachedSubEmitters.push(i),i.particleSystem.start()}}))}}_onDispose(e=!1,t=!1){if(this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),e&&this.particles?.forEach((e=>{if(e._attachedSubEmitters)for(let t=e._attachedSubEmitters.length-1;t>=0;t-=1)e._attachedSubEmitters[t].dispose()})),t&&this.activeSubSystems)for(let e=this.activeSubSystems.length-1;e>=0;e-=1)this.activeSubSystems[e].dispose();if(this._subEmitters&&this._subEmitters.length){for(let e=0;e<this._subEmitters.length;e++)for(const t of this._subEmitters[e])t.dispose();this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0)}static _Parse(e,t,i,r){let n;n=i instanceof ne.$?null:i;const l=(0,o.n9)("BABYLON.Texture");if(l&&n&&(e.texture?t.particleTexture=l.Parse(e.texture,n,r):e.textureName&&(t.particleTexture=new l(r+e.textureName,n,!1,void 0===e.invertY||e.invertY),t.particleTexture.name=e.textureName)),e.emitterId||0===e.emitterId||void 0!==e.emitter?e.emitterId&&n?t.emitter=n.getLastMeshById(e.emitterId):t.emitter=s.Pq.FromArray(e.emitter):t.emitter=s.Pq.Zero(),t.isLocal=!!e.isLocal,void 0!==e.renderingGroupId&&(t.renderingGroupId=e.renderingGroupId),void 0!==e.isBillboardBased&&(t.isBillboardBased=e.isBillboardBased),void 0!==e.billboardMode&&(t.billboardMode=e.billboardMode),void 0!==e.useLogarithmicDepth&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let i=0;i<e.animations.length;i++){const r=e.animations[i],n=(0,o.n9)("BABYLON.Animation");n&&t.animations.push(n.Parse(r))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&n&&n.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=0|e.startDelay,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),void 0!==e.preWarmCycles&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),void 0!==e.minInitialRotation&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=s.Pq.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=s.Pq.FromArray(e.noiseStrength)),t.color1=a.ov.FromArray(e.color1),t.color2=a.ov.FromArray(e.color2),t.colorDead=a.ov.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const i of e.colorGradients)t.addColorGradient(i.gradient,a.ov.FromArray(i.color1),i.color2?a.ov.FromArray(i.color2):void 0);if(e.rampGradients){for(const i of e.rampGradients)t.addRampGradient(i.gradient,a.v9.FromArray(i.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const i of e.colorRemapGradients)t.addColorRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.alphaRemapGradients)for(const i of e.alphaRemapGradients)t.addAlphaRemapGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.sizeGradients)for(const i of e.sizeGradients)t.addSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.angularSpeedGradients)for(const i of e.angularSpeedGradients)t.addAngularSpeedGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.velocityGradients)for(const i of e.velocityGradients)t.addVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.dragGradients)for(const i of e.dragGradients)t.addDragGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.emitRateGradients)for(const i of e.emitRateGradients)t.addEmitRateGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.startSizeGradients)for(const i of e.startSizeGradients)t.addStartSizeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.lifeTimeGradients)for(const i of e.lifeTimeGradients)t.addLifeTimeGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);if(e.limitVelocityGradients){for(const i of e.limitVelocityGradients)t.addLimitVelocityGradient(i.gradient,void 0!==i.factor1?i.factor1:i.factor,i.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&n){const i=(0,o.n9)("BABYLON.ProceduralTexture");t.noiseTexture=i.Parse(e.noiseTexture,n,r)}let c;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":c=new Jx;break;case"SphereDirectedParticleEmitter":c=new eT;break;case"ConeEmitter":case"ConeParticleEmitter":c=new rT;break;case"ConeDirectedParticleEmitter":c=new nT;break;case"CylinderParticleEmitter":c=new tT;break;case"CylinderDirectedParticleEmitter":c=new iT;break;case"HemisphericParticleEmitter":c=new Qx;break;case"PointParticleEmitter":c=new Zx;break;case"MeshParticleEmitter":c=new jx;break;case"CustomParticleEmitter":c=new Kx;break;default:c=new Hx}c.parse(e.particleEmitterType,n)}else c=new Hx,c.parse(e,n);t.particleEmitterType=c,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=e.spriteCellLoop??!0,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=e.disposeOnStop??!1,t.manualEmitCount=e.manualEmitCount??-1}static Parse(e,t,i,r=!1,n){const o=e.name;let l,c,h=null,u=null;if(t instanceof ne.$?l=t:(c=t,l=c.getEngine()),e.customShader&&l.createEffectForParticles){u=e.customShader;const t=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join("\n"):"";h=l.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,t)}const d=new pT(o,n||e.capacity,t,h,e.isAnimationSheetEnabled);if(d.customShader=u,d._rootUrl=i,e.id&&(d.id=e.id),e.subEmitters){d.subEmitters=[];for(const r of e.subEmitters){const e=[];for(const n of r)e.push($x.Parse(n,t,i));d.subEmitters.push(e)}}return pT._Parse(e,d,t,i),e.textureMask&&(d.textureMask=a.ov.FromArray(e.textureMask)),e.worldOffset&&(d.worldOffset=s.Pq.FromArray(e.worldOffset)),e.preventAutoStart&&(d.preventAutoStart=e.preventAutoStart),r||d.preventAutoStart||d.start(),d}serialize(e=!1){const t={};if(pT._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,t.worldOffset=this.worldOffset.asArray(),this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const r=[];for(const t of i)r.push(t.serialize(e));t.subEmitters.push(r)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const i=t.emitter;e.emitterId=i.id}else{const i=t.emitter;e.emitter=i.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,pe.p.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const r=t.getColorGradients();if(r){e.colorGradients=[];for(const t of r){const i={gradient:t.gradient,color1:t.color1.asArray()};t.color2?i.color2=t.color2.asArray():i.color2=t.color1.asArray(),e.colorGradients.push(i)}}const n=t.getRampGradients();if(n){e.rampGradients=[];for(const t of n){const i={gradient:t.gradient,color:t.color.asArray()};e.rampGradients.push(i)}e.useRampGradients=t.useRampGradients}const s=t.getColorRemapGradients();if(s){e.colorRemapGradients=[];for(const t of s){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.colorRemapGradients.push(i)}}const a=t.getAlphaRemapGradients();if(a){e.alphaRemapGradients=[];for(const t of a){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.alphaRemapGradients.push(i)}}const o=t.getSizeGradients();if(o){e.sizeGradients=[];for(const t of o){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.sizeGradients.push(i)}}const l=t.getAngularSpeedGradients();if(l){e.angularSpeedGradients=[];for(const t of l){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.angularSpeedGradients.push(i)}}const c=t.getVelocityGradients();if(c){e.velocityGradients=[];for(const t of c){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.velocityGradients.push(i)}}const h=t.getDragGradients();if(h){e.dragGradients=[];for(const t of h){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.dragGradients.push(i)}}const u=t.getEmitRateGradients();if(u){e.emitRateGradients=[];for(const t of u){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.emitRateGradients.push(i)}}const d=t.getStartSizeGradients();if(d){e.startSizeGradients=[];for(const t of d){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.startSizeGradients.push(i)}}const p=t.getLifeTimeGradients();if(p){e.lifeTimeGradients=[];for(const t of p){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.lifeTimeGradients.push(i)}}const f=t.getLimitVelocityGradients();if(f){e.limitVelocityGradients=[];for(const t of f){const i={gradient:t.gradient,factor1:t.factor1};void 0!==t.factor2?i.factor2=t.factor2:i.factor2=t.factor1,e.limitVelocityGradients.push(i)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}clone(e,t,i=!1){const r={...this._customWrappers};let n=null;const s=this._engine;if(s.createEffectForParticles&&null!=this.customShader){n=this.customShader;const e=n.shaderOptions.defines.length>0?n.shaderOptions.defines.join("\n"):"",t=s.createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,e);r[0]?r[0].effect=t:this.setCustomEffect(t,0)}const a=this.serialize(i),o=pT.Parse(a,this._scene||this._engine,this._rootUrl);return o.name=e,o.customShader=n,o._customWrappers=r,void 0===t&&(t=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=t,this.preventAutoStart||o.start(),o}}pT.BILLBOARDMODE_Y=2,pT.BILLBOARDMODE_ALL=7,pT.BILLBOARDMODE_STRETCHED=8,pT.BILLBOARDMODE_STRETCHED_LOCAL=9,$x._ParseParticleSystem=pT.Parse;class fT{constructor(){this._trackedScene=null}track(e){this._trackedScene=e,pe.p.AllowLoadingUniqueId=!0,this._savedJSON=mx.Serialize(e),pe.p.AllowLoadingUniqueId=!1}getDelta(){if(!this._trackedScene)return null;const e=_e.g.ForceSerializeBuffers;_e.g.ForceSerializeBuffers=!1,pe.p.AllowLoadingUniqueId=!0;const t=mx.Serialize(this._trackedScene);pe.p.AllowLoadingUniqueId=!1;const i={};for(const e in t)this._compareCollections(e,this._savedJSON[e],t[e],i);return _e.g.ForceSerializeBuffers=e,i}_compareArray(e,t,i,r){if(0===t.length&&0===i.length)return!0;if(t.length&&!isNaN(t[0])||i.length&&!isNaN(i[0])){if(t.length!==i.length)return!1;if(0===t.length)return!0;for(let n=0;n<t.length;n++)if(t[n]!==i[n])return r[e]=i,!1;return!0}const n=[];for(let s=0;s<t.length;s++){const a=t[s],o=a.uniqueId;n.push(o);const l=i.filter((e=>e.uniqueId===o));if(l.length){const t=l[0],i={};this._compareObjects(a,t,i)||(r[e]||(r[e]=[]),i.__state={id:t.id||t.name},r[e].push(i))}else{const t={__state:{deleteId:a.id||a.name}};r[e]||(r[e]=[]),r[e].push(t)}}for(let t=0;t<i.length;t++){const s=i[t],a=s.uniqueId;-1===n.indexOf(a)&&(r[e]||(r[e]=[]),r[e].push(s))}return!0}_compareObjects(e,t,i){let r=!1;for(const n in e){if(!Object.prototype.hasOwnProperty.call(e,n))continue;const s=e[n],a=t[n];let o=!1;if(Array.isArray(s))o=JSON.stringify(s)!==JSON.stringify(a);else if(isNaN(s)&&"[object String]"!=Object.prototype.toString.call(s)){if("object"==typeof s&&"object"==typeof a){const e={};this._compareObjects(s,a,e)||(i[n]=e,r=!0)}}else o=s!==a;o&&(r=!0,i[n]=a)}return!r}_compareCollections(e,t,i,r){if(t!==i&&t&&i)if(Array.isArray(t)&&Array.isArray(i)){if(this._compareArray(e,t,i,r))return}else if("object"==typeof t&&"object"==typeof i){const n={};return void(this._compareObjects(t,i,n)||(r[e]=n))}}static GetShadowGeneratorById(e,t){const i=e.lights.map((e=>e.getShadowGenerators()));for(const e of i)if(e){const i=e.values();for(let e=i.next();!0!==e.done;e=i.next()){const i=e.value;if(i&&i.id===t)return i}}return null}static ApplyDelta(e,t){"string"==typeof e&&(e=JSON.parse(e));const i=t;for(const r in e){const n=e[r],s=i[r];if(Array.isArray(s)||"shadowGenerators"===r)switch(r){case"cameras":this._ApplyDeltaForEntity(n,t,t.getCameraById.bind(t),(e=>Ct.i.Parse(e,t)));break;case"lights":this._ApplyDeltaForEntity(n,t,t.getLightById.bind(t),(e=>oh.v.Parse(e,t)));break;case"shadowGenerators":this._ApplyDeltaForEntity(n,t,(e=>this.GetShadowGeneratorById(t,e)),(e=>hh.Parse(e,t)));break;case"meshes":this._ApplyDeltaForEntity(n,t,t.getMeshById.bind(t),(e=>Rt.e.Parse(e,t,"")));break;case"skeletons":this._ApplyDeltaForEntity(n,t,t.getSkeletonById.bind(t),(e=>ve.E.Parse(e,t)));break;case"materials":this._ApplyDeltaForEntity(n,t,t.getMaterialById.bind(t),(e=>Zl.i.Parse(e,t,"")));break;case"multiMaterials":this._ApplyDeltaForEntity(n,t,t.getMaterialById.bind(t),(e=>Lh.F.Parse(e,t,"")));break;case"transformNodes":this._ApplyDeltaForEntity(n,t,t.getTransformNodeById.bind(t),(e=>ui.V.Parse(e,t,"")));break;case"particleSystems":this._ApplyDeltaForEntity(n,t,t.getParticleSystemById.bind(t),(e=>pT.Parse(e,t,"")));break;case"morphTargetManagers":this._ApplyDeltaForEntity(n,t,t.getMorphTargetById.bind(t),(e=>Uh.j.Parse(e,t)));break;case"postProcesses":this._ApplyDeltaForEntity(n,t,t.getPostProcessByName.bind(t),(e=>jt.w.Parse(e,t,"")))}else isNaN(s)?s.fromArray&&s.fromArray(n):i[r]=n}}static _ApplyPropertiesToEntity(e,t){for(const i in e){const r=e[i],n=t[i];void 0!==n&&(!isNaN(n)||Array.isArray(n)?t[i]=r:n.fromArray?n.fromArray(r):"object"==typeof n&&null!==n&&this._ApplyPropertiesToEntity(r,n))}}static _ApplyDeltaForEntity(e,t,i,r){for(const n of e)if(n.__state&&void 0!==n.__state.id){const e=i(n.__state.id);e&&(this._ApplyPropertiesToEntity(n,e),pe.p.ParseProperties(n,e,t,null))}else if(n.__state&&void 0!==n.__state.deleteId){const e=i(n.__state.deleteId);e?.dispose()}else r(n)}}var mT,_T=i(28083);!function(e){class t{serialize(){const e={},t=new Array(this._characterToIdx.size);return this._characterToIdx.forEach(((e,i)=>{t[e]=i})),e.characters=t,e.insertionCosts=this._insertionCosts,e.deletionCosts=this._deletionCosts,e.substitutionCosts=this._substitutionCosts,JSON.stringify(e)}static Deserialize(e){const i=JSON.parse(e),r=new t(i.characters);return r._insertionCosts=i.insertionCosts,r._deletionCosts=i.deletionCosts,r._substitutionCosts=i.substitutionCosts,r}constructor(e,t=null,i=null,r=null){let n;t=t??(()=>1),i=i??(()=>1),r=r??((e,t)=>e===t?0:1),this._characterToIdx=new Map,this._insertionCosts=new Array(e.length),this._deletionCosts=new Array(e.length),this._substitutionCosts=new Array(e.length);for(let s=0;s<e.length;++s){n=e[s],this._characterToIdx.set(n,s),this._insertionCosts[s]=t(n),this._deletionCosts[s]=i(n),this._substitutionCosts[s]=new Array(e.length);for(let t=s;t<e.length;++t)this._substitutionCosts[s][t]=r(n,e[t])}}getCharacterIdx(e){return this._characterToIdx.get(e)}getInsertionCost(e){return this._insertionCosts[e]}getDeletionCost(e){return this._deletionCosts[e]}getSubstitutionCost(e,t){const i=Math.min(e,t),r=Math.max(e,t);return this._substitutionCosts[i][r]}}e.Alphabet=t;class i{serialize(){return JSON.stringify(this._characters)}static Deserialize(e,t){const r=new i([],t);return r._characters=JSON.parse(e),r}constructor(e,t){if(e.length>i._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+i._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=t,this._characters=e.map((e=>this._alphabet.getCharacterIdx(e)))}distance(e){return i._Distance(this,e)}static _Distance(e,t){const r=e._alphabet;if(r!==t._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const n=e._characters,s=t._characters,a=n.length,o=s.length,l=i._CostMatrix;l[0][0]=0;for(let e=0;e<a;++e)l[e+1][0]=l[e][0]+r.getInsertionCost(n[e]);for(let e=0;e<o;++e)l[0][e+1]=l[0][e]+r.getInsertionCost(s[e]);for(let e=0;e<a;++e)for(let t=0;t<o;++t)i._InsertionCost=l[e+1][t]+r.getInsertionCost(s[t]),i._DeletionCost=l[e][t+1]+r.getDeletionCost(n[e]),i._SubstitutionCost=l[e][t]+r.getSubstitutionCost(n[e],s[t]),l[e+1][t+1]=Math.min(i._InsertionCost,i._DeletionCost,i._SubstitutionCost);return l[a][o]}}i._MAX_SEQUENCE_LENGTH=256,i._CostMatrix=[...Array(i._MAX_SEQUENCE_LENGTH+1)].map((()=>new Array(i._MAX_SEQUENCE_LENGTH+1))),e.Sequence=i}(mT||(mT={}));class gT{serialize(){return JSON.stringify(this)}static Deserialize(e){const t=JSON.parse(e),i=new gT(t._segmentLength);return i._points=t._points.map((e=>new s.Pq(e._x,e._y,e._z))),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(0===t)this._points.push(e.clone());else{const i=()=>this._segmentLength/s.Pq.Distance(this._points[t-1],e);for(let r=i();r<=1;r=i()){const i=this._points[t-1].scale(1-r);e.scaleAndAddToRef(r,i),this._points.push(i),++t}}}resampleAtTargetResolution(e){const t=new gT(this.getLength()/e);return this._points.forEach((e=>{t.add(e)})),t}tokenize(e){const t=[],i=new s.Pq;for(let r=2;r<this._points.length;++r)gT._TransformSegmentDirToRef(this._points[r-2],this._points[r-1],this._points[r],i)&&t.push(gT._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,r){return t.subtractToRef(e,gT._ForwardDir),gT._ForwardDir.normalize(),t.scaleToRef(-1,gT._InverseFromVec),gT._InverseFromVec.normalize(),!(Math.abs(s.Pq.Dot(gT._ForwardDir,gT._InverseFromVec))>.98||(s.Pq.CrossToRef(gT._ForwardDir,gT._InverseFromVec,gT._UpDir),gT._UpDir.normalize(),s.uq.LookAtLHToRef(e,t,gT._UpDir,gT._LookMatrix),i.subtractToRef(t,gT._FromToVec),gT._FromToVec.normalize(),s.Pq.TransformNormalToRef(gT._FromToVec,gT._LookMatrix,r),0))}static _TokenizeSegment(e,t){gT._BestMatch=0,gT._Score=s.Pq.Dot(e,t[0]),gT._BestScore=gT._Score;for(let i=1;i<t.length;++i)gT._Score=s.Pq.Dot(e,t[i]),gT._Score>gT._BestScore&&(gT._BestMatch=i,gT._BestScore=gT._Score);return gT._BestMatch}}gT._ForwardDir=new s.Pq,gT._InverseFromVec=new s.Pq,gT._UpDir=new s.Pq,gT._FromToVec=new s.Pq,gT._LookMatrix=new s.uq;class vT{static Generate(e=64,t=256,i=.1,r=.001,n=[]){const a=new vT(e);for(let t=0;t<e;++t)a.chars[t]=new s.Pq(Math.random()-.5,Math.random()-.5,Math.random()-.5),a.chars[t].normalize();for(let e=0;e<n.length;++e)a.chars[e].copyFrom(n[e]);let o,l;const c=new s.Pq,h=new s.Pq;for(let e=0;e<t;++e){o=(1-(u=e/(t-1)))*i+u*r;for(let e=n.length;e<a.chars.length;++e)c.copyFromFloats(0,0,0),a.chars.forEach((t=>{a.chars[e].subtractToRef(t,h),l=h.lengthSquared(),l>1e-6&&h.scaleAndAddToRef(1/(h.lengthSquared()*l),c)})),c.scaleInPlace(o),a.chars[e].addInPlace(c),a.chars[e].normalize()}var u;return a}serialize(){return JSON.stringify(this.chars)}static Deserialize(e){const t=JSON.parse(e),i=new vT(t.length);for(let e=0;e<t.length;++e)i.chars[e]=new s.Pq(t[e]._x,t[e]._y,t[e]._z);return i}constructor(e){this.chars=new Array(e)}}class ST{serialize(){return JSON.stringify(this._sequences.map((e=>e.serialize())))}static Deserialize(e,t){const i=new ST;return i._sequences=JSON.parse(e).map((e=>mT.Sequence.Deserialize(e,t))),i}static CreateFromTrajectory(e,t,i){return ST.CreateFromTokenizationPyramid(ST._GetTokenizationPyramid(e,t),i)}static CreateFromTokenizationPyramid(e,t){const i=new ST;return i._sequences=e.map((e=>new mT.Sequence(e,t))),i}constructor(){this._sequences=[]}static _GetTokenizationPyramid(e,t,i=ST._FINEST_DESCRIPTOR_RESOLUTION){const r=[];for(let n=i;n>4;n=Math.floor(n/2))r.push(e.resampleAtTargetResolution(n).tokenize(t.chars));return r}distance(e){let t,i=0;for(let r=0;r<this._sequences.length;++r)t=Math.pow(2,r),i+=t*this._sequences[r].distance(e._sequences[r]);return i}}ST._FINEST_DESCRIPTOR_RESOLUTION=32;class xT{serialize(){const e={};return e.descriptors=this._descriptors.map((e=>e.serialize())),e.centroidIdx=this._centroidIdx,e.averageDistance=this._averageDistance,JSON.stringify(e)}static Deserialize(e,t){const i=JSON.parse(e),r=new xT;return r._descriptors=i.descriptors.map((e=>ST.Deserialize(e,t))),r._centroidIdx=i.centroidIdx,r._averageDistance=i.averageDistance,r}constructor(e=[]){this._descriptors=e,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}add(e){this._descriptors.push(e),this._refreshDescription()}getMatchCost(e){return e.distance(this._descriptors[this._centroidIdx])/this._averageDistance}getMatchMinimumDistance(e){return Math.min(...this._descriptors.map((t=>t.distance(e))))}_refreshDescription(){let e;this._centroidIdx=-1;const t=this._descriptors.map((t=>(e=0,this._descriptors.forEach((i=>{e+=t.distance(i)})),e)));for(let e=0;e<t.length;++e)(this._centroidIdx<0||t[e]<t[this._centroidIdx])&&(this._centroidIdx=e);this._averageDistance=0,this._descriptors.forEach((e=>{this._averageDistance+=e.distance(this._descriptors[this._centroidIdx])})),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,xT._MIN_AVERAGE_DISTANCE))}}xT._MIN_AVERAGE_DISTANCE=1;class TT{serialize(){const e={};return e.maximumAllowableMatchCost=this._maximumAllowableMatchCost,e.vector3Alphabet=this._vector3Alphabet.serialize(),e.levenshteinAlphabet=this._levenshteinAlphabet.serialize(),e.nameToDescribedTrajectory=[],this._nameToDescribedTrajectory.forEach(((t,i)=>{e.nameToDescribedTrajectory.push(i),e.nameToDescribedTrajectory.push(t.serialize())})),JSON.stringify(e)}static Deserialize(e){const t=JSON.parse(e),i=new TT;i._maximumAllowableMatchCost=t.maximumAllowableMatchCost,i._vector3Alphabet=vT.Deserialize(t.vector3Alphabet),i._levenshteinAlphabet=mT.Alphabet.Deserialize(t.levenshteinAlphabet);for(let e=0;e<t.nameToDescribedTrajectory.length;e+=2)i._nameToDescribedTrajectory.set(t.nameToDescribedTrajectory[e],xT.Deserialize(t.nameToDescribedTrajectory[e+1],i._levenshteinAlphabet));return i}static Generate(){const e=vT.Generate(64,256,.1,.001,[s.Pq.Forward()]),t=new Array(e.chars.length);for(let e=0;e<t.length;++e)t[e]=e;const i=new mT.Alphabet(t,(e=>0===e?0:1),(e=>0===e?0:1),((t,i)=>Math.min(1-s.Pq.Dot(e.chars[t],e.chars[i]),1))),r=new TT;return r._vector3Alphabet=e,r._levenshteinAlphabet=i,r}constructor(){this._maximumAllowableMatchCost=4,this._nameToDescribedTrajectory=new Map}addTrajectoryToClassification(e,t){this._nameToDescribedTrajectory.has(t)||this._nameToDescribedTrajectory.set(t,new xT),this._nameToDescribedTrajectory.get(t).add(ST.CreateFromTrajectory(e,this._vector3Alphabet,this._levenshteinAlphabet))}deleteClassification(e){return this._nameToDescribedTrajectory.delete(e)}classifyTrajectory(e){const t=ST.CreateFromTrajectory(e,this._vector3Alphabet,this._levenshteinAlphabet),i=[];if(this._nameToDescribedTrajectory.forEach(((e,r)=>{e.getMatchCost(t)<this._maximumAllowableMatchCost&&i.push(r)})),0===i.length)return null;let r,n=0,s=this._nameToDescribedTrajectory.get(i[n]).getMatchMinimumDistance(t);for(let e=0;e<i.length;++e)r=this._nameToDescribedTrajectory.get(i[e]).getMatchMinimumDistance(t),r<s&&(s=r,n=e);return i[n]}}var ET=i(41917);class CT{constructor(e,t,i){this._scene=e,f.V.Log(`[Reflector] Connecting to ws://${t}:${i}`),this._webSocket=new WebSocket(`ws://${t}:${i}`),this._webSocket.onmessage=e=>{const t=e.data;if(t.startsWith(CT._SERVER_PREFIX)){const e=t.substring(CT._SERVER_PREFIX.length);return f.V.Log(`[Reflector] Received server message: ${e.substring(0,64)}`),void this._handleServerMessage(e)}f.V.Log(`[Reflector] Received client message: ${t.substring(0,64)}`),this._handleClientMessage()},this._webSocket.onclose=e=>{f.V.Log(`[Reflector] Disconnected ${e.code} ${e.reason}`)}}close(){this._webSocket.close()}_handleServerMessage(e){"connected"===e&&mx.SerializeAsync(this._scene).then((e=>{this._webSocket.send(`load|${JSON.stringify(e)}`)}))}_handleClientMessage(){}}CT._SERVER_PREFIX="$$";class bT{constructor(e){this._observer=null,this._currentState=[],this.onPressureChanged=new n.cP,bT.IsAvailable&&(this._observer=new PressureObserver((e=>{this._currentState=e,this.onPressureChanged.notifyObservers(e)}),e))}static get IsAvailable(){return"undefined"!=typeof PressureObserver&&PressureObserver.knownSources&&PressureObserver.knownSources.includes("cpu")}observe(e){try{this._observer?.observe(e),this.onPressureChanged.notifyObservers(this._currentState)}catch{}}unobserve(e){try{this._observer?.unobserve(e)}catch{}}dispose(){this._observer?.disconnect(),this._observer=null,this.onPressureChanged.clear()}}class PT{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(1.5*this._view.length),t=new Float32Array(e);t.set(this._view),this._view=t}}const yT=1800,AT="timestamp",RT="numPoints",IT=/\r/g;class MT{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const e=Te.j.Now-this._startingTimestamp,t=this.datasets.ids.length,i=this.datasets.startingIndices.itemLength;let r=0;if(i>0){const e=this.datasets.startingIndices.at(i-1);r=e+this.datasets.data.at(e+MT.NumberOfPointsOffset)+MT.SliceDataOffset}if(this.datasets.startingIndices.push(r),this.datasets.data.push(e),this.datasets.data.push(t),this.datasets.ids.forEach((e=>{const t=this._strategies.get(e);t&&this.datasets.data.push(t.getData())})),this.datasetObservable.hasObservers()){const i=[e,t];for(let e=0;e<t;e++)i.push(this.datasets.data.at(r+MT.SliceDataOffset+e));this.datasetObservable.notifyObservers(i)}},this.datasets={ids:[],data:new PT(yT),startingIndices:new PT(yT)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new n.cP,this.datasetObservable=new n.cP,this.metadataObservable=new n.cP((e=>e.callback(this._datasetMeta,new n.qO(0)))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&(this._strategies.get(e)?.dispose(),this._strategies.delete(e));const r={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:t=>{let i=0,r=0;const n=t.onAfterRenderObservable.add((()=>{r=i,i=0})),s=this._customEventObservable.add((t=>{e===t.name&&(void 0!==t.value?i=t.value:i++)}));return{id:e,getData:()=>r,dispose:()=>{t.onAfterRenderObservable.remove(n),this._customEventObservable.remove(s)}}},category:i}),r}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach((e=>{this.registerEvent(e,!0)}))}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:r}of e){const e=t(this._scene);this._strategies.has(e.id)?e.dispose():(this.datasets.ids.push(e.id),i&&(i=i.replace(new RegExp("@","g"),"")),this._datasetMeta.set(e.id,{color:this._getHexColorFromId(e.id),category:i,hidden:r}),this._strategies.set(e.id,e))}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let i=0;i<e.length;i++)t=e.charCodeAt(i)+((t<<5)-t);let i="#";for(let e=0;e<24;e+=8){const r="0"+(t>>e&255).toString(16);i+=r.substring(r.length-2)}return i}getCurrentSlice(){const e=[Te.j.Now-this._startingTimestamp,this.datasets.ids.length];this.datasets.ids.forEach((t=>{const i=this._strategies.get(t);i&&this.datasetObservable.hasObservers()&&e.push(i.getData())})),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(e)}updateMetadata(e,t,i){const r=this._datasetMeta.get(e);r&&(r[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new PT(yT),this.datasets.ids.length=0,this.datasets.startingIndices=new PT(yT),this._datasetMeta.clear(),this._strategies.forEach((e=>e.dispose())),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(IT,"").split("\n").map((e=>e.split(",").filter((e=>e.length>0)))).filter((e=>e.length>0)),r=MT.NumberOfPointsOffset;if(i.length<2)return!1;const n={ids:[],data:new PT(yT),startingIndices:new PT(yT)},[s,...a]=i;if(s.length<2||s[0]!==AT||s[r]!==RT)return!1;const o=new Map;for(let e=MT.SliceDataOffset;e<s.length;e++){const[t,i]=s[e].split("@");n.ids.push(t),o.set(t,i)}let l=0;for(const e of a){if(e.length<2)return!1;const t=parseFloat(e[0]),i=parseInt(e[r]);if(isNaN(i)||isNaN(t))return!1;if(n.data.push(t),n.data.push(i),i+MT.SliceDataOffset!==e.length)return!1;for(let t=MT.SliceDataOffset;t<e.length;t++){const i=parseFloat(e[t]);if(isNaN(i))return!1;n.data.push(i)}n.startingIndices.push(l),l+=e.length}if(this.datasets.ids=n.ids,this.datasets.data=n.data,this.datasets.startingIndices=n.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach((e=>e.dispose())),this._strategies.clear(),!t)for(const e of this.datasets.ids){const t=o.get(e);this._datasetMeta.set(e,{category:t,color:this._getHexColorFromId(e)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${AT},${RT}`;for(let t=0;t<this.datasets.ids.length;t++)if(e+=`,${this.datasets.ids[t]}`,this._datasetMeta){const i=this._datasetMeta.get(this.datasets.ids[t]);i?.category&&(e+=`@${i.category}`)}e+="\n";for(let t=0;t<this.datasets.startingIndices.itemLength;t++){const i=this.datasets.startingIndices.at(t),r=this.datasets.data.at(i),n=this.datasets.data.at(i+MT.NumberOfPointsOffset);e+=`${r},${n}`;for(let t=0;t<n;t++)e+=`,${this.datasets.data.at(i+MT.SliceDataOffset+t)}`;for(let t=0;t<this.datasets.ids.length-n;t++)e+=",";e+="\n"}const t=`${(new Date).toISOString()}-perfdata.csv`;re.S0.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?void 0===this._startingTimestamp&&(this._startingTimestamp=Te.j.Now):(this.datasets.data=new PT(yT),this.datasets.startingIndices=new PT(yT),this._startingTimestamp=Te.j.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach((e=>{e.dispose()})),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}const OT=()=>{};class NT{static FpsStrategy(){return e=>{const t=e.getEngine();return{id:"FPS",getData:()=>t.getFps(),dispose:OT}}}static ThermalStrategy(){return this._PressureStrategy("Thermal utilization","thermal")}static PowerSupplyStrategy(){return this._PressureStrategy("Power supply utilization","power-supply")}static PressureStrategy(){return this._PressureStrategy("Pressure")}static _PressureStrategy(e,t=null){return()=>{let i=0;const r=new bT;return r.observe("cpu"),r.onPressureChanged.add((e=>{for(const r of e)if(t&&r.factors.includes(t)||!t&&0===(r.factors?.length??0))switch(r.state){case"nominal":i=0;break;case"fair":i=.25;break;case"serious":i=.5;break;case"critical":i=1}})),{id:e,getData:()=>i,dispose:()=>r.dispose()}}}static TotalMeshesStrategy(){return e=>({id:"Total meshes",getData:()=>e.meshes.length,dispose:OT})}static ActiveMeshesStrategy(){return e=>({id:"Active meshes",getData:()=>e.getActiveMeshes().length,dispose:OT})}static ActiveIndicesStrategy(){return e=>({id:"Active indices",getData:()=>e.getActiveIndices(),dispose:OT})}static ActiveFacesStrategy(){return e=>({id:"Active faces",getData:()=>e.getActiveIndices()/3,dispose:OT})}static ActiveBonesStrategy(){return e=>({id:"Active bones",getData:()=>e.getActiveBones(),dispose:OT})}static ActiveParticlesStrategy(){return e=>({id:"Active particles",getData:()=>e.getActiveParticles(),dispose:OT})}static DrawCallsStrategy(){return e=>{let t=0;const i=e.onBeforeAnimationsObservable.add((()=>{e.getEngine()._drawCalls.fetchNewFrame()})),r=e.onAfterRenderObservable.add((()=>{t=e.getEngine()._drawCalls.current}));return{id:"Draw calls",getData:()=>t,dispose:()=>{e.onBeforeAnimationsObservable.remove(i),e.onAfterRenderObservable.remove(r)}}}}static TotalLightsStrategy(){return e=>({id:"Total lights",getData:()=>e.lights.length,dispose:OT})}static TotalVerticesStrategy(){return e=>({id:"Total vertices",getData:()=>e.getTotalVertices(),dispose:OT})}static TotalMaterialsStrategy(){return e=>({id:"Total materials",getData:()=>e.materials.length,dispose:OT})}static TotalTexturesStrategy(){return e=>({id:"Total textures",getData:()=>e.textures.length,dispose:OT})}static AbsoluteFpsStrategy(){return e=>{const t=new Mc(e);return t.captureFrameTime=!0,{id:"Absolute FPS",getData:()=>1e3/t.frameTimeCounter.lastSecAverage,dispose:OT}}}static MeshesSelectionStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeActiveMeshesEvaluationObservable.add((()=>{t=Te.j.Now})),n=e.onAfterActiveMeshesEvaluationObservable.add((()=>{i=Te.j.Now-t}));return{id:"Meshes Selection",getData:()=>i,dispose:()=>{e.onBeforeActiveMeshesEvaluationObservable.remove(r),e.onAfterActiveMeshesEvaluationObservable.remove(n)}}}}static RenderTargetsStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeRenderTargetsRenderObservable.add((()=>{t=Te.j.Now})),n=e.onAfterRenderTargetsRenderObservable.add((()=>{i=Te.j.Now-t}));return{id:"Render Targets",getData:()=>i,dispose:()=>{e.onBeforeRenderTargetsRenderObservable.remove(r),e.onAfterRenderTargetsRenderObservable.remove(n)}}}}static ParticlesStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeParticlesRenderingObservable.add((()=>{t=Te.j.Now})),n=e.onAfterParticlesRenderingObservable.add((()=>{i=Te.j.Now-t}));return{id:"Particles",getData:()=>i,dispose:()=>{e.onBeforeParticlesRenderingObservable.remove(r),e.onAfterParticlesRenderingObservable.remove(n)}}}}static SpritesStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeSpritesRenderingObservable?.add((()=>{t=Te.j.Now})),n=e.onAfterSpritesRenderingObservable?.add((()=>{i=Te.j.Now-t}));return{id:"Sprites",getData:()=>i,dispose:()=>{e.onBeforeSpritesRenderingObservable?.remove(r),e.onAfterSpritesRenderingObservable?.remove(n)}}}}static AnimationsStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeAnimationsObservable.add((()=>{t=Te.j.Now})),n=e.onAfterAnimationsObservable.add((()=>{i=Te.j.Now-t}));return{id:"Animations",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(r),e.onAfterAnimationsObservable.remove(n)}}}}static PhysicsStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforePhysicsObservable?.add((()=>{t=Te.j.Now})),n=e.onAfterPhysicsObservable?.add((()=>{i=Te.j.Now-t}));return{id:"Physics",getData:()=>i,dispose:()=>{e.onBeforePhysicsObservable?.remove(r),e.onAfterPhysicsObservable?.remove(n)}}}}static RenderStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeDrawPhaseObservable.add((()=>{t=Te.j.Now})),n=e.onAfterDrawPhaseObservable.add((()=>{i=Te.j.Now-t}));return{id:"Render",getData:()=>i,dispose:()=>{e.onBeforeDrawPhaseObservable.remove(r),e.onAfterDrawPhaseObservable.remove(n)}}}}static FrameTotalStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeAnimationsObservable.add((()=>{t=Te.j.Now})),n=e.onAfterRenderObservable.add((()=>{i=Te.j.Now-t}));return{id:"Frame Total",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(r),e.onAfterRenderObservable.remove(n)}}}}static InterFrameStrategy(){return e=>{let t=Te.j.Now,i=0;const r=e.onBeforeAnimationsObservable.add((()=>{i=Te.j.Now-t})),n=e.onAfterRenderObservable.add((()=>{t=Te.j.Now}));return{id:"Inter-frame",getData:()=>i,dispose:()=>{e.onBeforeAnimationsObservable.remove(r),e.onAfterRenderObservable.remove(n)}}}}static GpuFrameTimeStrategy(){return e=>{const t=new Ic(e.getEngine());return t.captureGPUFrameTime=!0,{id:"GPU frame time",getData:()=>Math.max(1e-6*t.gpuFrameTimeCounter.current,0),dispose:()=>{t.dispose()}}}}}kt.Z.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new MT(this)),this._perfCollector};var DT=i(60799);class FT{constructor(e,t){this._disableRenderingRefCount=0,this._currentPerformancePriorityMode=0,this._scene=e,this._engine=e.getEngine(),this._engine.isWebGPU&&(this._options={morphTargetsNumMaxInfluences:20,...t},this._engine.snapshotRenderingMode=1,this.fixMeshes(),this._onResizeObserver=this._engine.onResizeObservable.add((()=>{this.disableSnapshotRendering(),this.enableSnapshotRendering()})),this._scene.onBeforeRenderObservable.add((()=>{if(this._fastSnapshotRenderingEnabled){e.skeletons.forEach((e=>e.prepare(!0)));for(const t of e.meshes)if(t.infiniteDistance&&t.transferToEffect(t.computeWorldMatrix(!0)),t.skeleton&&t.transferToEffect(t.computeWorldMatrix(!0)),"GaussianSplattingMesh"===t.getClassName()&&t._postToWorker(),t.morphTargetManager&&t.subMeshes)for(const e of t.subMeshes){const i=e._drawWrapper,r=i.effect;if(r){const e=i.drawContext.buffers.LeftOver,n=r._pipelineContext?.uniformBuffer;e&&n&&n.setDataBuffer(e)&&(t.morphTargetManager._bind(r),(0,qo.nR)(t,r),n.update())}}}})))}enableSnapshotRendering(){this._engine.isWebGPU&&(--this._disableRenderingRefCount>0||(this._disableRenderingRefCount=0,this._currentPerformancePriorityMode=this._pendingCurrentPerformancePriorityMode??this._scene.performancePriority,this._pendingCurrentPerformancePriorityMode=void 0,this._scene.performancePriority=0,this._scene.executeWhenReady((()=>{this._disableRenderingRefCount>0||this._executeAtFrame(this._engine.frameId+2,(()=>{this._engine.snapshotRendering=!0}))}))))}disableSnapshotRendering(){this._engine.isWebGPU&&(0===this._disableRenderingRefCount&&(this._scene.performancePriority=0,0!==this._currentPerformancePriorityMode&&(this._pendingCurrentPerformancePriorityMode=this._currentPerformancePriorityMode,this._scene.executeWhenReady((()=>{this._executeAtFrame(this._engine.frameId+2,(()=>{this._disableRenderingRefCount>0&&void 0!==this._pendingCurrentPerformancePriorityMode&&(this._scene.performancePriority=this._pendingCurrentPerformancePriorityMode),this._pendingCurrentPerformancePriorityMode=void 0}),!0)})))),this._engine.snapshotRendering=!1,this._disableRenderingRefCount++)}fixMeshes(e){if(this._engine.isWebGPU){e=e||this._scene.meshes;for(const t of e)t.ignoreCameraMaxZ=!1,t.morphTargetManager&&(t.morphTargetManager.numMaxInfluencers=Math.min(t.morphTargetManager.numTargets,this._options.morphTargetsNumMaxInfluences))}}updateMesh(e){if(this._fastSnapshotRenderingEnabled)if(Array.isArray(e))for(const t of e)t.transferToEffect(t.computeWorldMatrix(!0));else e.transferToEffect(e.computeWorldMatrix(!0))}updateMeshesForEffectLayer(e,t=!0){if(!this._engine.isWebGPU)return;const i=e.mainTexture.renderPassId;t?this._onBeforeRenderObserverUpdateLayer=this._scene.onBeforeRenderObservable.add((()=>{this._updateMeshMatricesForRenderPassId(i)})):this._updateMeshMatricesForRenderPassId(i)}dispose(){this._engine.isWebGPU&&(this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserverUpdateLayer),this._engine.onResizeObservable.remove(this._onResizeObserver))}get _fastSnapshotRenderingEnabled(){return this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode}_updateMeshMatricesForRenderPassId(e){if(!this._fastSnapshotRenderingEnabled)return;const t=this._scene.getTransformMatrix();for(let i=0;i<this._scene.meshes.length;++i){const r=this._scene.meshes[i];if(r.subMeshes)for(let i=0;i<r.subMeshes.length;++i){const n=r.subMeshes[i]._getDrawWrapper(e),s=n?.effect;if(s){const e=n.drawContext.buffers.LeftOver,i=s._pipelineContext?.uniformBuffer;e&&i&&i.setDataBuffer(e)&&(s.setMatrix("viewProjection",t),s.setMatrix("world",r.computeWorldMatrix()),i.update())}}}}_executeAtFrame(e,t,i=!1){const r=this._engine.onEndFrameObservable.add((()=>{this._disableRenderingRefCount>0&&!i||0===this._disableRenderingRefCount&&i?this._engine.onEndFrameObservable.remove(r):this._engine.frameId>=e&&(this._engine.onEndFrameObservable.remove(r),t())}))}}n.cP.prototype.runCoroutineAsync=function(e){if(!this._coroutineScheduler){const e=function(e){const t=new Array,i=new Array,r=new Array,n=e.add((()=>{const e=t.length;for(let n=0;n<e;n++)(0,DT.FE)(t.shift(),i.shift(),r.shift())}));return{scheduler:(e,n,s)=>{t.push(e),i.push(n),r.push(s)},dispose:()=>{e.remove(n)}}}(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return(0,DT.kj)(e,this._coroutineScheduler)},n.cP.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};async function LT(e,t){const i=t.probe??new $h("tempProbe",t.size,e),r=!!t.probe;r||(t.position?i.position=t.position.clone():e.activeCamera&&(i.position=e.activeCamera.position.clone()));const n=t.meshesFilter?e.meshes.filter(t.meshesFilter):e.meshes;i.renderList?.push(...n),i.refreshRate=Si.$.REFRESHRATE_RENDER_ONCE,i.cubeTexture.render();const s=new nd("tempProceduralTexture","equirectangularPanorama",{width:2*t.size,height:t.size},e);return s.setTexture("cubeMap",i.cubeTexture),new Promise(((e,n)=>{s.onGeneratedObservable.addOnce((()=>{const a=s.readPixels();if(!a)return n(new Error("No Pixel Data found on procedural texture")),s.dispose(),void(r||i.dispose());a.then((n=>{s.dispose(),r||i.dispose(),t.filename?((0,Px.DumpData)(2*t.size,t.size,n,void 0,"image/png",t.filename),e(null)):e(n)}))}))}))}ri.l.ShadersStore.equirectangularPanoramaPixelShader="#ifdef GL_ES\nprecision highp float;\n#endif\n#define M_PI 3.1415926535897932384626433832795\nvarying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(\n- sin( longitude )*sin( latitude ),\ncos( latitude ),\n- cos( longitude )*sin( latitude )\n);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}";class wT{constructor(){this._currentOperation=Promise.resolve()}lockAsync(e,t){t?.throwIfAborted();const i=t?()=>(t.throwIfAborted(),e()):e,r=this._currentOperation.then(i);return this._currentOperation=new Promise((e=>r.then((()=>e()),e))),r}static async LockAsync(e,t,i){if(i?.throwIfAborted(),0===t.length)return await e();const r=new qS.c;let n=0;return t.forEach((s=>s.lockAsync((async()=>(n++,n===t.length&&r.resolve(await e()),r.promise)),i).catch((e=>r.reject(e))))),r.promise}}var BT=i(28606),VT=i(59058),kT=i(55143),GT=i(37007),UT=i(69335),zT=i(32350),WT=i(16734);class HT{constructor(e=Recast){this.bjsRECAST={},this.name="RecastJSPlugin",this._maximumSubStepCount=10,this._timeStep=1/60,this._timeFactor=1,this._worker=null,"function"==typeof e?f.V.Error("RecastJS is not ready. Please make sure you await Recast() before using the plugin."):this.bjsRECAST=e,this.isSupported()?(this.setTimeStep(),this._tempVec1=new this.bjsRECAST.Vec3,this._tempVec2=new this.bjsRECAST.Vec3):f.V.Error("RecastJS is not available. Please make sure you included the js file.")}setWorkerURL(e){return!(!window||!window.Worker||(this._worker=new Worker(e),0))}setTimeStep(e=1/60){this._timeStep=e}getTimeStep(){return this._timeStep}setMaximumSubStepCount(e=10){this._maximumSubStepCount=e}getMaximumSubStepCount(){return this._maximumSubStepCount}set timeFactor(e){this._timeFactor=Math.max(e,0)}get timeFactor(){return this._timeFactor}createNavMesh(e,t,i){let r,n,s;this._worker&&!i?f.V.Warn("A worker is avaible but no completion callback. Defaulting to blocking navmesh creation"):!this._worker&&i&&f.V.Warn("A completion callback is avaible but no worker. Defaulting to blocking navmesh creation"),this.navMesh=new this.bjsRECAST.NavMesh;const a=[],o=[];let l=0;for(r=0;r<e.length;r++)if(e[r]){const t=e[r],i=t.getIndices();if(!i)continue;const c=t.getVerticesData(Ue.R.PositionKind,!1,!1);if(!c)continue;const h=[],u=t.computeWorldMatrix(!0);if(t.hasThinInstances){const e=t.thinInstanceGetWorldMatrices();for(let t=0;t<e.length;t++){const i=new wo.uq;e[t].multiplyToRef(u,i),h.push(i)}}else h.push(u);for(let e=0;e<h.length;e++){const t=h[e];for(n=0;n<i.length;n++)a.push(i[n]+l);const r=wo.Pq.Zero(),u=wo.Pq.Zero();for(s=0;s<c.length;s+=3)wo.Pq.FromArrayToRef(c,s,u),wo.Pq.TransformCoordinatesToRef(u,t,r),o.push(r.x,r.y,r.z);l+=c.length/3}}if(this._worker&&i)this._worker.postMessage([o,l,a,a.length,t]),this._worker.onmessage=function(e){i(e.data)};else{const e=new this.bjsRECAST.rcConfig;e.cs=t.cs,e.ch=t.ch,e.borderSize=t.borderSize?t.borderSize:0,e.tileSize=t.tileSize?t.tileSize:0,e.walkableSlopeAngle=t.walkableSlopeAngle,e.walkableHeight=t.walkableHeight,e.walkableClimb=t.walkableClimb,e.walkableRadius=t.walkableRadius,e.maxEdgeLen=t.maxEdgeLen,e.maxSimplificationError=t.maxSimplificationError,e.minRegionArea=t.minRegionArea,e.mergeRegionArea=t.mergeRegionArea,e.maxVertsPerPoly=t.maxVertsPerPoly,e.detailSampleDist=t.detailSampleDist,e.detailSampleMaxError=t.detailSampleMaxError,this.navMesh.build(o,l,a,a.length,e)}}createDebugNavMesh(e){let t,i;const r=this.navMesh.getDebugNavMesh(),n=r.getTriangleCount(),s=[],a=[];for(t=0;t<3*n;t++)s.push(t);for(t=0;t<n;t++)for(i=0;i<3;i++){const e=r.getTriangle(t).getPoint(i);a.push(e.x,e.y,e.z)}const o=new Rt.e("NavMeshDebug",e),l=new S_.P;return l.indices=s,l.positions=a,l.applyToMesh(o,!1),o}getClosestPoint(e){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const t=this.navMesh.getClosestPoint(this._tempVec1);return new wo.Pq(t.x,t.y,t.z)}getClosestPointToRef(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const i=this.navMesh.getClosestPoint(this._tempVec1);t.set(i.x,i.y,i.z)}getRandomPointAround(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const i=this.navMesh.getRandomPointAround(this._tempVec1,t);return new wo.Pq(i.x,i.y,i.z)}getRandomPointAroundToRef(e,t,i){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;const r=this.navMesh.getRandomPointAround(this._tempVec1,t);i.set(r.x,r.y,r.z)}moveAlong(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const i=this.navMesh.moveAlong(this._tempVec1,this._tempVec2);return new wo.Pq(i.x,i.y,i.z)}moveAlongToRef(e,t,i){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const r=this.navMesh.moveAlong(this._tempVec1,this._tempVec2);i.set(r.x,r.y,r.z)}_convertNavPathPoints(e){let t;const i=e.getPointCount(),r=[];for(t=0;t<i;t++){const i=e.getPoint(t);r.push(new wo.Pq(i.x,i.y,i.z))}return r}computePath(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const i=this.navMesh.computePath(this._tempVec1,this._tempVec2);return this._convertNavPathPoints(i)}computePathSmooth(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;const i=this.navMesh.computePathSmooth(this._tempVec1,this._tempVec2);return this._convertNavPathPoints(i)}createCrowd(e,t,i){return new YT(this,e,t,i)}setDefaultQueryExtent(e){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this.navMesh.setDefaultQueryExtent(this._tempVec1)}getDefaultQueryExtent(){const e=this.navMesh.getDefaultQueryExtent();return new wo.Pq(e.x,e.y,e.z)}buildFromNavmeshData(e){const t=e.length*e.BYTES_PER_ELEMENT,i=this.bjsRECAST._malloc(t),r=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,i,t);r.set(e);const n=new this.bjsRECAST.NavmeshData;n.dataPointer=r.byteOffset,n.size=e.length,this.navMesh=new this.bjsRECAST.NavMesh,this.navMesh.buildFromNavmeshData(n),this.bjsRECAST._free(r.byteOffset)}getNavmeshData(){const e=this.navMesh.getNavmeshData(),t=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,e.dataPointer,e.size),i=new Uint8Array(e.size);return i.set(t),this.navMesh.freeNavmeshData(e),i}getDefaultQueryExtentToRef(e){const t=this.navMesh.getDefaultQueryExtent();e.set(t.x,t.y,t.z)}dispose(){}addCylinderObstacle(e,t,i){return this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this.navMesh.addCylinderObstacle(this._tempVec1,t,i)}addBoxObstacle(e,t,i){return this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z,this.navMesh.addBoxObstacle(this._tempVec1,this._tempVec2,i)}removeObstacle(e){this.navMesh.removeObstacle(e)}isSupported(){return void 0!==this.bjsRECAST}getRandomSeed(){return this.bjsRECAST._getRandomSeed()}setRandomSeed(e){this.bjsRECAST._setRandomSeed(e)}}class YT{constructor(e,t,i,r){this.recastCrowd={},this.transforms=new Array,this.agents=new Array,this.reachRadii=new Array,this._agentDestinationArmed=new Array,this._agentDestination=new Array,this._onBeforeAnimationsObserver=null,this.onReachTargetObservable=new n.cP,this.bjsRECASTPlugin=e,this.recastCrowd=new this.bjsRECASTPlugin.bjsRECAST.Crowd(t,i,this.bjsRECASTPlugin.navMesh.getNavMesh()),this._scene=r,this._onBeforeAnimationsObserver=r.onBeforeAnimationsObservable.add((()=>{this.update(.001*r.getEngine().getDeltaTime()*e.timeFactor)}))}addAgent(e,t,i){const r=new this.bjsRECASTPlugin.bjsRECAST.dtCrowdAgentParams;r.radius=t.radius,r.height=t.height,r.maxAcceleration=t.maxAcceleration,r.maxSpeed=t.maxSpeed,r.collisionQueryRange=t.collisionQueryRange,r.pathOptimizationRange=t.pathOptimizationRange,r.separationWeight=t.separationWeight,r.updateFlags=7,r.obstacleAvoidanceType=0,r.queryFilterType=0,r.userData=0;const n=this.recastCrowd.addAgent(new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z),r);return this.transforms.push(i),this.agents.push(n),this.reachRadii.push(t.reachRadius?t.reachRadius:t.radius),this._agentDestinationArmed.push(!1),this._agentDestination.push(new wo.Pq(0,0,0)),n}getAgentPosition(e){const t=this.recastCrowd.getAgentPosition(e);return new wo.Pq(t.x,t.y,t.z)}getAgentPositionToRef(e,t){const i=this.recastCrowd.getAgentPosition(e);t.set(i.x,i.y,i.z)}getAgentVelocity(e){const t=this.recastCrowd.getAgentVelocity(e);return new wo.Pq(t.x,t.y,t.z)}getAgentVelocityToRef(e,t){const i=this.recastCrowd.getAgentVelocity(e);t.set(i.x,i.y,i.z)}getAgentNextTargetPath(e){const t=this.recastCrowd.getAgentNextTargetPath(e);return new wo.Pq(t.x,t.y,t.z)}getAgentNextTargetPathToRef(e,t){const i=this.recastCrowd.getAgentNextTargetPath(e);t.set(i.x,i.y,i.z)}getAgentState(e){return this.recastCrowd.getAgentState(e)}overOffmeshConnection(e){return this.recastCrowd.overOffmeshConnection(e)}agentGoto(e,t){this.recastCrowd.agentGoto(e,new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z));const i=this.agents.indexOf(e);i>-1&&(this._agentDestinationArmed[i]=!0,this._agentDestination[i].set(t.x,t.y,t.z))}agentTeleport(e,t){this.recastCrowd.agentTeleport(e,new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z))}updateAgentParameters(e,t){const i=this.recastCrowd.getAgentParameters(e);void 0!==t.radius&&(i.radius=t.radius),void 0!==t.height&&(i.height=t.height),void 0!==t.maxAcceleration&&(i.maxAcceleration=t.maxAcceleration),void 0!==t.maxSpeed&&(i.maxSpeed=t.maxSpeed),void 0!==t.collisionQueryRange&&(i.collisionQueryRange=t.collisionQueryRange),void 0!==t.pathOptimizationRange&&(i.pathOptimizationRange=t.pathOptimizationRange),void 0!==t.separationWeight&&(i.separationWeight=t.separationWeight),this.recastCrowd.setAgentParameters(e,i)}removeAgent(e){this.recastCrowd.removeAgent(e);const t=this.agents.indexOf(e);t>-1&&(this.agents.splice(t,1),this.transforms.splice(t,1),this.reachRadii.splice(t,1),this._agentDestinationArmed.splice(t,1),this._agentDestination.splice(t,1))}getAgents(){return this.agents}update(e){if(this.bjsRECASTPlugin.navMesh.update(),e<=wo.bH)return;const t=this.bjsRECASTPlugin.getTimeStep(),i=this.bjsRECASTPlugin.getMaximumSubStepCount();if(t<=wo.bH)this.recastCrowd.update(e);else{let r=Math.floor(e/t);i&&r>i&&(r=i),r<1&&(r=1);const n=e/r;for(let e=0;e<r;e++)this.recastCrowd.update(n)}for(let e=0;e<this.agents.length;e++){const t=this.agents[e],i=this.getAgentPosition(t);if(this.transforms[e].position=i,this._agentDestinationArmed[e]){const r=i.x-this._agentDestination[e].x,n=i.z-this._agentDestination[e].z,s=this.reachRadii[e],a=this._agentDestination[e].y-this.reachRadii[e],o=this._agentDestination[e].y+this.reachRadii[e],l=r*r+n*n;i.y>a&&i.y<o&&l<s*s&&(this._agentDestinationArmed[e]=!1,this.onReachTargetObservable.notifyObservers({agentIndex:t,destination:this._agentDestination[e]}))}}}setDefaultQueryExtent(e){const t=new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z);this.recastCrowd.setDefaultQueryExtent(t)}getDefaultQueryExtent(){const e=this.recastCrowd.getDefaultQueryExtent();return new wo.Pq(e.x,e.y,e.z)}getDefaultQueryExtentToRef(e){const t=this.recastCrowd.getDefaultQueryExtent();e.set(t.x,t.y,t.z)}getCorners(e){let t;const i=this.recastCrowd.getCorners(e),r=i.getPointCount(),n=[];for(t=0;t<r;t++){const e=i.getPoint(t);n.push(new wo.Pq(e.x,e.y,e.z))}return n}dispose(){this.recastCrowd.destroy(),this._scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.onReachTargetObservable.clear()}}ne.$.OfflineProviderFactory=(e,t,i=!1)=>new XT(e,t,i);class XT{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory="undefined"!=typeof indexedDB?indexedDB:void 0,this._currentSceneUrl=XT._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,XT.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,re.S0.SetImmediate((()=>{t(!0)}))):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if("function"==typeof URL&&0===this._currentSceneUrl.indexOf("http")){const e=new URL(this._currentSceneUrl);return e.pathname+=".manifest",e.toString()}}catch(e){}return`${this._currentSceneUrl}.manifest`};let r=!1,n=i();const s=new aa.u;navigator.onLine&&(r=!0,n=n+(null==n.match(/\?/)?"?":"&")+Date.now()),s.open("GET",n),s.addEventListener("load",(()=>{if(200===s.status||XT._ValidateXHRData(s,1))try{const t=JSON.parse(s.response);this._enableSceneOffline=t.enableSceneOffline,this._enableTexturesOffline=t.enableTexturesOffline&&XT._IsUASupportingBlobStorage,t.version&&!isNaN(parseInt(t.version))&&(this._manifestVersionFound=t.version),e(!0)}catch(e){t()}else t()}),!1),s.addEventListener("error",(()=>{if(r){r=!1;const e=i();s.open("GET",e),s.send()}else t()}),!1);try{s.send()}catch(t){f.V.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(this._idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline))if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const t=this._idbFactory.open("babylonjs",1);t.onerror=()=>{i()},t.onblocked=()=>{f.V.Error("IDB request blocked. Please reload the page."),i()},t.onsuccess=()=>{this._db=t.result,e()},t.onupgradeneeded=e=>{if(this._db=e.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(e){f.V.Error("Error while creating object stores. Exception: "+e.message),i()}}}else this._isSupported=!1,t&&t()}loadImage(e,t){const i=XT._ReturnFullUrlLocation(e),r=()=>{this._hasReachedQuota||null===this._db?t.src=e:this._saveImageIntoDBAsync(i,t)};this._mustUpdateRessources?r():this._loadImageFromDBAsync(i,t,r)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&null!==this._db){let r;const n=this._db.transaction(["textures"]);n.onabort=()=>{t.src=e},n.oncomplete=()=>{let n;r&&"function"==typeof URL?(n=URL.createObjectURL(r.data),t.onerror=()=>{f.V.Error("Error loading image from blob URL: "+n+" switching back to web url: "+e),t.src=e},t.src=n):i()};const s=n.objectStore("textures").get(e);s.onsuccess=e=>{r=e.target.result},s.onerror=()=>{f.V.Error("Error loading texture "+e+" from DB."),t.src=e}}else f.V.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){const r=()=>{let e;if(i&&"function"==typeof URL)try{e=URL.createObjectURL(i)}catch(t){e=URL.createObjectURL(i)}e&&(t.src=e)};if(XT._IsUASupportingBlobStorage){const n=new aa.u;n.open("GET",e),n.responseType="blob",n.addEventListener("load",(()=>{if(200===n.status&&this._db){i=n.response;const s=this._db.transaction(["textures"],"readwrite");s.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}r()},s.oncomplete=()=>{r()};const a={textureUrl:e,data:i};try{const e=s.objectStore("textures").put(a);e.onsuccess=()=>{},e.onerror=()=>{r()}}catch(i){25===i.code&&(XT._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e}),!1),n.addEventListener("error",(()=>{f.V.Error("Error in XHR request in BABYLON.Database."),t.src=e}),!1),n.send()}else t.src=e}else f.V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){this._loadVersionFromDBAsync(e,t,(()=>{this._saveVersionIntoDBAsync(e,t)}))}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let r;try{const n=this._db.transaction(["versions"]);n.oncomplete=()=>{r?this._manifestVersionFound!==r.data?(this._mustUpdateRessources=!0,i()):t(r.data):(this._mustUpdateRessources=!0,i())},n.onabort=()=>{t(-1)};const s=n.objectStore("versions").get(e);s.onsuccess=e=>{r=e.target.result},s.onerror=()=>{f.V.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(e){f.V.Error("Error while accessing 'versions' object store (READ OP). Exception: "+e.message),t(-1)}}else f.V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const r={sceneUrl:e,data:this._manifestVersionFound},n=i.objectStore("versions").put(r);n.onsuccess=()=>{},n.onerror=()=>{f.V.Error("Error in DB add version request in BABYLON.Database.")}}catch(e){f.V.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+e.message),t(-1)}else t(-1)}loadFile(e,t,i,r,n){const s=XT._ReturnFullUrlLocation(e),a=()=>{this._saveFileAsync(s,t,i,n,r)};this._checkVersionFromDB(s,(e=>{-1!==e?this._mustUpdateRessources?this._saveFileAsync(s,t,i,n,r):this._loadFileAsync(s,t,a,i):r&&r()}))}_loadFileAsync(e,t,i,r){if(this._isSupported&&this._db){let n,s;n=-1!==e.indexOf(".babylon")?"scenes":"textures";const a=this._db.transaction([n]);a.oncomplete=()=>{if(s){if(r){const e=s.data?.byteLength||0;r({total:e,loaded:e,lengthComputable:!0})}t(s.data)}else i()},a.onabort=()=>{i()};const o=a.objectStore(n).get(e);o.onsuccess=e=>{s=e.target.result},o.onerror=()=>{f.V.Error("Error loading file "+e+" from DB."),i()}}else f.V.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,r,n){if(this._isSupported){let s;s=-1!==e.indexOf(".babylon")?"scenes":"textures";const a=new aa.u;let o;a.open("GET",e+(null==e.match(/\?/)?"?":"&")+Date.now()),r&&(a.responseType="arraybuffer"),i&&(a.onprogress=i),a.addEventListener("load",(()=>{if(200===a.status||a.status<400&&XT._ValidateXHRData(a,r?6:1))if(o=r?a.response:a.responseText,!this._hasReachedQuota&&this._db){const i=this._db.transaction([s],"readwrite");let r;i.onabort=e=>{try{const t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(o)},i.oncomplete=()=>{t(o)},r="scenes"===s?{sceneUrl:e,data:o,version:this._manifestVersionFound}:{textureUrl:e,data:o};try{const e=i.objectStore(s).put(r);e.onsuccess=()=>{},e.onerror=()=>{f.V.Error("Error in DB add file request in BABYLON.Database.")}}catch(e){t(o)}}else t(o);else a.status>=400&&n?n(a):t()}),!1),a.addEventListener("error",(()=>{f.V.Error("error on XHR request."),n&&n()}),!1),a.send()}else f.V.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),n&&n()}static _ValidateXHRData(e,t=7){try{if(1&t){if(e.responseText&&e.responseText.length>0)return!0;if(1===t)return!1}if(2&t){const i=(0,Tx.O_)(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(2===t)return!1}if(4&t){const t=new Uint8Array(e.response,0,3);return 68===t[0]&&68===t[1]&&83===t[2]}}catch(e){}return!1}}XT._IsUASupportingBlobStorage=!0,XT.IDBStorageEnabled=!1,XT._ParseURL=e=>{document.createElement("a").href=e;const t=e.substring(0,e.lastIndexOf("#")),i=e.substring(t.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(i,0))},XT._ReturnFullUrlLocation=e=>-1===e.indexOf("http:/")&&-1===e.indexOf("https:/")&&"undefined"!=typeof window?XT._ParseURL(window.location.href)+e:e;class qT{_isUbo(e){return void 0!==e.addUniform}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}ri.l.ShadersStore.gpuUpdateParticlesPixelShader="#version 300 es\nvoid main() {discard;}\n";ri.l.ShadersStore.gpuUpdateParticlesVertexShader="#version 300 es\n#define PI 3.14159\nuniform float currentCount;uniform float timeDelta;uniform float stopFactor;\n#ifndef LOCAL\nuniform mat4 emitterWM;\n#endif\nuniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;\n#ifndef COLORGRADIENTS\nuniform vec4 color1;uniform vec4 color2;\n#endif\nuniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;\n#ifdef BOXEMITTER\nuniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;\n#endif\n#ifdef POINTEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#endif\n#ifdef HEMISPHERICEMITTER\nuniform float radius;uniform float radiusRange;uniform float directionRandomizer;\n#endif\n#ifdef SPHEREEMITTER\nuniform float radius;uniform float radiusRange;\n#ifdef DIRECTEDSPHEREEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nuniform float radius;uniform float height;uniform float radiusRange;\n#ifdef DIRECTEDCYLINDEREMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\n#ifdef CONEEMITTER\nuniform vec2 radius;uniform float coneAngle;uniform vec2 height;\n#ifdef DIRECTEDCONEEMITTER\nuniform vec3 direction1;uniform vec3 direction2;\n#else\nuniform float directionRandomizer;\n#endif\n#endif\nin vec3 position;\n#ifdef CUSTOMEMITTER\nin vec3 initialPosition;\n#endif\nin float age;in float life;in vec4 seed;in vec3 size;\n#ifndef COLORGRADIENTS\nin vec4 color;\n#endif\nin vec3 direction;\n#ifndef BILLBOARD\nin vec3 initialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nin float angle;\n#else\nin vec2 angle;\n#endif\n#ifdef ANIMATESHEET\nin float cellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nin float cellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nin vec3 noiseCoordinates1;in vec3 noiseCoordinates2;\n#endif\nout vec3 outPosition;\n#ifdef CUSTOMEMITTER\nout vec3 outInitialPosition;\n#endif\nout float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;\n#ifndef COLORGRADIENTS\nout vec4 outColor;\n#endif\nout vec3 outDirection;\n#ifndef BILLBOARD\nout vec3 outInitialDirection;\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nout float outAngle;\n#else\nout vec2 outAngle;\n#endif\n#ifdef ANIMATESHEET\nout float outCellIndex;\n#ifdef ANIMATESHEETRANDOMSTART\nout float outCellStartOffset;\n#endif\n#endif\n#ifdef NOISE\nout vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;\n#endif\n#ifdef SIZEGRADIENTS\nuniform sampler2D sizeGradientSampler;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nuniform sampler2D angularSpeedGradientSampler;\n#endif \n#ifdef VELOCITYGRADIENTS\nuniform sampler2D velocityGradientSampler;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\nuniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;\n#endif\n#ifdef DRAGGRADIENTS\nuniform sampler2D dragGradientSampler;\n#endif\n#ifdef NOISE\nuniform vec3 noiseStrength;uniform sampler2D noiseSampler;\n#endif\n#ifdef ANIMATESHEET\nuniform vec4 cellInfos;\n#endif\nvec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}\nvec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}\nvoid main() {float newAge=age+timeDelta; \nif (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;\n#ifdef SIZEGRADIENTS \noutSize.x=texture(sizeGradientSampler,vec2(0,0)).r;\n#else\noutSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;\n#endif\noutSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; \n#ifndef COLORGRADIENTS\noutColor=color1+(color2-color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \noutAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#else\noutAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;\n#endif \n#ifdef POINTEMITTER\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;\n#elif defined(BOXEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; \n#elif defined(SPHEREEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(direction1+(direction2-direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nvec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nangle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nvec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nfloat h=0.0001;\n#else\nfloat h=randoms2.y*height.y;h=1.-h*h; \n#endif\nfloat lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); \nvec3 randoms3=getRandomVec3(seed.z);\n#ifdef DIRECTEDCONEEMITTER\nnewDirection=direction1+(direction2-direction1)*randoms3;\n#else\nif (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }\n#endif\n#elif defined(CUSTOMEMITTER)\nnewPosition=initialPosition;outInitialPosition=initialPosition;\n#else \nnewPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));\n#endif\nfloat power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;\n#ifdef LOCAL\noutPosition=newPosition;\n#else\noutPosition=(emitterWM*vec4(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#ifndef BILLBOARD \noutInitialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nvec3 initial=newDirection;\n#else \nvec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;\n#endif\noutDirection=initial*power;\n#ifndef BILLBOARD \noutInitialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \noutCellIndex=cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\noutNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;\n#endif\n} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;\n#endif\n#if defined(CUSTOMEMITTER)\noutPosition=position+(direction-position)*ageGradient; \noutInitialPosition=initialPosition;\n#else\noutPosition=position+direction*directionScale;\n#endif\noutLife=life;outSeed=seed;\n#ifndef COLORGRADIENTS \noutColor=color;\n#endif\n#ifdef SIZEGRADIENTS\noutSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;\n#else\noutSize=size;\n#endif \n#ifndef BILLBOARD \noutInitialDirection=initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\noutDirection=direction;\n#else\nvec3 updatedDirection=direction+gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nfloat limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}\n#endif\noutDirection=updatedDirection;\n#ifdef NOISE\nfloat fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nfloat angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;\n#else\noutAngle=vec2(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nfloat offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\noutCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;\n#else\nfloat cellStartOffset=0.;\n#endif \nfloat ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}\nelse {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}\noutCellIndex=float(int(cellInfos.x+ratio*dist));\n#endif\n}}";class $T{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){return this._updateEffect?.isReady()??!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof Kx&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new So.M("gpuUpdateParticles",this._updateEffectOptions,this._engine),new qT(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof Kx&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}}(0,o.Y5)("BABYLON.WebGL2ParticleSystem",$T);ri.l.ShadersStoreWGSL.gpuUpdateParticlesComputeShader="struct Particle {position : vec3<f32>,\nage : f32,\nsize : vec3<f32>,\nlife : f32,\nseed : vec4<f32>,\ndirection : vec3<f32>,\ndummy0: f32,\n#ifdef CUSTOMEMITTER\ninitialPosition : vec3<f32>,\ndummy1: f32,\n#endif\n#ifndef COLORGRADIENTS\ncolor : vec4<f32>,\n#endif\n#ifndef BILLBOARD\ninitialDirection : vec3<f32>,\ndummy2: f32,\n#endif\n#ifdef NOISE\nnoiseCoordinates1 : vec3<f32>,\ndummy3: f32,\nnoiseCoordinates2 : vec3<f32>,\ndummy4: f32,\n#endif\n#ifdef ANGULARSPEEDGRADIENTS\nangle : f32,\n#else\nangle : vec2<f32>,\n#endif\n#ifdef ANIMATESHEET\ncellIndex : f32,\n#ifdef ANIMATESHEETRANDOMSTART\ncellStartOffset : f32,\n#endif\n#endif\n};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,\ntimeDelta : f32,\nstopFactor : f32,\nrandomTextureSize: i32,\nlifeTime : vec2<f32>,\nemitPower : vec2<f32>,\n#ifndef COLORGRADIENTS\ncolor1 : vec4<f32>,\ncolor2 : vec4<f32>,\n#endif\nsizeRange : vec2<f32>,\nscaleRange : vec4<f32>,\nangleRange : vec4<f32>,\ngravity : vec3<f32>,\n#ifdef LIMITVELOCITYGRADIENTS\nlimitVelocityDamping : f32,\n#endif\n#ifdef ANIMATESHEET\ncellInfos : vec4<f32>,\n#endif\n#ifdef NOISE\nnoiseStrength : vec3<f32>,\n#endif\n#ifndef LOCAL\nemitterWM : mat4x4<f32>,\n#endif\n#ifdef BOXEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\nminEmitBox : vec3<f32>,\nmaxEmitBox : vec3<f32>,\n#endif\n#ifdef CONEEMITTER\nradius : vec2<f32>,\nconeAngle : f32,\nheight : vec2<f32>,\n#ifdef DIRECTEDCONEEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef CYLINDEREMITTER\nradius : f32,\nheight : f32,\nradiusRange : f32,\n#ifdef DIRECTEDCYLINDEREMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n#ifdef HEMISPHERICEMITTER\nradius : f32,\nradiusRange : f32,\ndirectionRandomizer : f32,\n#endif\n#ifdef POINTEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#endif\n#ifdef SPHEREEMITTER\nradius : f32,\nradiusRange : f32,\n#ifdef DIRECTEDSPHEREEMITTER\ndirection1 : vec3<f32>,\ndirection2 : vec3<f32>,\n#else\ndirectionRandomizer : f32,\n#endif\n#endif\n};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;\n#ifdef SIZEGRADIENTS\n@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;\n#endif \n#ifdef ANGULARSPEEDGRADIENTS\n@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;\n#endif \n#ifdef VELOCITYGRADIENTS\n@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef LIMITVELOCITYGRADIENTS\n@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;\n#endif\n#ifdef DRAGGRADIENTS\n@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;\n#endif\n#ifdef NOISE\n@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;\n#endif\nfn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}\nfn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}\n@compute @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}\nlet PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;\n#ifdef SIZEGRADIENTS \nsizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;\n#else\nsizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;\n#endif\nparticlesOut.particles[index].size=vec3<f32>(\nsizex,\nparams.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,\nparams.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);\n#ifndef COLORGRADIENTS\nparticlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;\n#endif\n#ifndef ANGULARSPEEDGRADIENTS \nparticlesOut.particles[index].angle=vec2<f32>(\nparams.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,\nparams.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);\n#else\nparticlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;\n#endif \n#if defined(POINTEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#elif defined(BOXEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; \n#elif defined(HEMISPHERICEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#elif defined(SPHEREEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);\n#ifdef DIRECTEDSPHEREEMITTER\nnewDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);\n#else\nnewDirection=normalize(newPosition+params.directionRandomizer*randoms3);\n#endif\n#elif defined(CYLINDEREMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);\n#ifdef DIRECTEDCYLINDEREMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nangle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);\n#endif\n#elif defined(CONEEMITTER)\nlet randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;\n#ifdef CONEEMITTERSPAWNPOINT\nlet h : f32=0.0001;\n#else\nvar h : f32=randoms2.y*params.height.y;h=1.-h*h; \n#endif\nvar lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); \nlet randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);\n#ifdef DIRECTEDCONEEMITTER\nnewDirection=params.direction1+(params.direction2-params.direction1)*randoms3;\n#else\nif (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }\n#endif\n#elif defined(CUSTOMEMITTER)\nnewPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;\n#else \nnewPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));\n#endif\nlet power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;\n#ifdef LOCAL\nparticlesOut.particles[index].position=newPosition;\n#else\nparticlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=direction;\n#endif\n#else\n#ifdef LOCAL\nlet initial : vec3<f32>=newDirection;\n#else \nlet initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;\n#endif\nparticlesOut.particles[index].direction=initial*power;\n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=initial;\n#endif\n#endif\n#ifdef ANIMATESHEET \nparticlesOut.particles[index].cellIndex=params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nparticlesOut.particles[index].cellStartOffset=randoms.a*outLife;\n#endif \n#endif\n#ifdef NOISE\nparticlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;\n#endif\n} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;\n#ifdef VELOCITYGRADIENTS\ndirectionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;\n#endif\n#ifdef DRAGGRADIENTS\ndirectionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);\n#endif\nlet position : vec3<f32>=particlesIn.particles[index].position;\n#if defined(CUSTOMEMITTER)\nparticlesOut.particles[index].position=position+(direction-position)*ageGradient; \nparticlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;\n#else\nparticlesOut.particles[index].position=position+direction*directionScale;\n#endif\nparticlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;\n#ifndef COLORGRADIENTS \nparticlesOut.particles[index].color=particlesIn.particles[index].color;\n#endif\n#ifdef SIZEGRADIENTS\nparticlesOut.particles[index].size=vec3<f32>(\ntextureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,\nparticlesIn.particles[index].size.yz);\n#else\nparticlesOut.particles[index].size=particlesIn.particles[index].size;\n#endif \n#ifndef BILLBOARD \nparticlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;\n#endif\n#ifdef CUSTOMEMITTER\nparticlesOut.particles[index].direction=direction;\n#else\nvar updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;\n#ifdef LIMITVELOCITYGRADIENTS\nlet limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}\n#endif\nparticlesOut.particles[index].direction=updatedDirection;\n#ifdef NOISE\nlet noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;\n#endif \n#endif \n#ifdef ANGULARSPEEDGRADIENTS\nlet angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;\n#else\nlet angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);\n#endif\n#ifdef ANIMATESHEET \nvar offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;\n#ifdef ANIMATESHEETRANDOMSTART\nlet cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;\n#else\nlet cellStartOffset : f32=0.;\n#endif \nvar ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}\nelse {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}\nparticlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));\n#endif\n}}\n";class jT{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){return this._updateComputeShader?.isReady()??!1}createUpdateBuffer(e){const t={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(t.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(t.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(t.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(t.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(t.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(t.noiseTexture={group:1,binding:11}),this._updateComputeShader=new dr.H("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:t,defines:e.split("\n")}),this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=new vi.D(this._engine,void 0,void 0,"ComputeShaderParticleSystemUBO"),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new qT(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new He.K(this._engine,4*e.length,11,"ComputeShaderParticleSystemBuffer");return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^e]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){for(let e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}(0,o.Y5)("BABYLON.ComputeShaderParticleSystem",jT);ri.l.IncludesShadersStore.clipPlaneFragmentDeclaration2="#ifdef CLIPPLANE\nin float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nin float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nin float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nin float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nin float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nin float fClipDistance6;\n#endif\n",i(38857),i(97529),i(99668);ri.l.ShadersStore.gpuRenderParticlesPixelShader="precision highp float;\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;\n#include<clipPlaneFragmentDeclaration2> \n#include<imageProcessingDeclaration>\n#include<logDepthDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#include<fogFragmentDeclaration>\nvoid main() {\n#include<clipPlaneFragment> \nvec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;\n#ifdef BLENDMULTIPLYMODE\nfloat alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);\n#endif \n#include<logDepthFragment>\n#include<fogFragment>(color,gl_FragColor)\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);\n#else\n#ifdef IMAGEPROCESSING\ngl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);\n#endif\n#endif\n}\n";ri.l.IncludesShadersStore.clipPlaneVertexDeclaration2="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;out float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;out float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;out float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;out float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;out float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;out float fClipDistance6;\n#endif\n",i(63316),i(30834),i(56403);ri.l.ShadersStore.gpuRenderParticlesVertexShader="precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;\n#ifdef LOCAL\nuniform mat4 emitterWM;\n#endif\nattribute vec3 position;attribute float age;attribute float life;attribute vec3 size;\n#ifndef BILLBOARD\nattribute vec3 initialDirection;\n#endif\n#ifdef BILLBOARDSTRETCHED\nattribute vec3 direction;\n#endif\nattribute float angle;\n#ifdef ANIMATESHEET\nattribute float cellIndex;\n#endif\nattribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;\n#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)\nuniform mat4 invView;\n#endif\n#include<clipPlaneVertexDeclaration2>\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\n#ifdef COLORGRADIENTS\nuniform sampler2D colorGradientSampler;\n#else\nuniform vec4 colorDead;attribute vec4 color;\n#endif\n#ifdef ANIMATESHEET\nuniform vec3 sheetInfos;\n#endif\n#ifdef BILLBOARD\nuniform vec3 eyePosition;\n#endif\nvec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#ifdef BILLBOARDSTRETCHED\nvec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;\n#ifdef LOCAL\nreturn ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;\n#else\nreturn (position+worldOffset)+alignedCorner;\n#endif\n}\n#endif\nvoid main() {\n#ifdef ANIMATESHEET\nfloat rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;\n#else\nvUV=uv;\n#endif\nfloat ratio=min(1.0,age/life);\n#ifdef COLORGRADIENTS\nvColor=texture2D(colorGradientSampler,vec2(ratio,0));\n#else\nvColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);\n#endif\nvec2 cornerPos=(offset-translationPivot)*size.yz*size.x;\n#ifdef BILLBOARD\nvec4 rotatedCorner;rotatedCorner.w=0.;\n#ifdef BILLBOARDY\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));\n#elif defined(BILLBOARDSTRETCHED)\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));\n#else\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;\n#ifdef LOCAL\nvec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;\n#else\nvec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;\n#endif\nvPositionW=(invView*viewPosition).xyz;\n#endif\n#else\nvec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);\n#endif\ngl_Position=projection*viewPosition;\n#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)\nvec4 worldPos=vec4(vPositionW,1.0);\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<logDepthVertex>\n}";class KT extends $l{static get IsSupported(){if(!P.q.LastCreatedEngine)return!1;const e=P.q.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){const i=sT(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=aT(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=oT(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new s.Pq(0,1,0),i=new s.Pq(0,1,0)){const r=lT(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const n=cT(e,t,i,r);return this.particleEmitterType=n,n}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new s.Pq(0,1,0),n=new s.Pq(0,1,0)){const a=hT(e,t,i,r,n);return this.particleEmitterType=a,a}createConeEmitter(e=1,t=Math.PI/4){const i=uT(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new s.Pq(0,1,0),r=new s.Pq(0,1,0)){const n=dT(e,t,i,r);return this.particleEmitterType=n,n}createBoxEmitter(e,t,i,r){const n=new Hx;return this.particleEmitterType=n,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,n}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==pT.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else{if(!this._getWrapper(pT.BLENDMODE_MULTIPLY).effect.isReady())return!1;if(!this._getWrapper(pT.BLENDMODE_ADD).effect.isReady())return!1}return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";e?setTimeout((()=>{this.start(0)}),e):(this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop))}stop(){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new ec.E(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new n.cP),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[1^this._targetIndex]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new wx(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0)),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){for(const e in this._drawWrappers){const t=this._drawWrappers[e];t.drawContext?.reset()}}_addFactorGradient(e,t,i){const r=new Vx(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort(((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0));const r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,a=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.onDisposeObservable=new n.cP,this.onStoppedObservable=new n.cP,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=s.uq.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||P.q.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().supportComputeShaders){if(!(0,o.n9)("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,o.n9)("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!(0,o.n9)("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,o.n9)("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new ec.E(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new ec.E(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),(t=t??{}).randomTextureSize||delete t.randomTextureSize;const l={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},c=t;isFinite(c)&&(l.capacity=c),this._capacity=l.capacity,this._maxActiveParticleCount=l.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=a,this.particleEmitterType=new Hx;const h=Math.min(this._engine.getCaps().maxTextureSize,l.randomTextureSize);let u=[];for(let e=0;e<h;++e)u.push(Math.random()),u.push(Math.random()),u.push(Math.random()),u.push(Math.random());this._randomTexture=new me.I(new Float32Array(u),h,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,u=[];for(let e=0;e<h;++e)u.push(Math.random()),u.push(Math.random()),u.push(Math.random()),u.push(Math.random());this._randomTexture2=new me.I(new Float32Array(u),h,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=h}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let n=3;r.age=t.createVertexBuffer("age",n,1,this._attributesStrideSize,!0),n+=1,r.size=t.createVertexBuffer("size",n,3,this._attributesStrideSize,!0),n+=3,r.life=t.createVertexBuffer("life",n,1,this._attributesStrideSize,!0),n+=1,n+=4,this.billboardMode===pT.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",n,3,this._attributesStrideSize,!0)),n+=3,this._platform.alignDataInBuffer&&(n+=1),this.particleEmitterType instanceof Kx&&(n+=3,this._platform.alignDataInBuffer&&(n+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",n,4,this._attributesStrideSize,!0),n+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),r.angle=t.createVertexBuffer("angle",n,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?n++:n+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",n,1,this._attributesStrideSize,!0),n+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",n,1,this._attributesStrideSize,!0),n+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof Kx&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const r=this.particleEmitterType instanceof Kx,n=s.AA.Vector3[0];let a=0;for(let e=0;e<this._capacity;e++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(e,null,n),i.push(n.x),i.push(n.y),i.push(n.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),a+=16,r&&(this.particleEmitterType.particlePositionGenerator(e,null,n),i.push(n.x),i.push(n.y),i.push(n.z),this._platform.alignDataInBuffer&&i.push(0),a+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),a+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),a+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),a+=8),i.push(0),a+=1,this._angularSpeedGradientsTexture||(i.push(0),a+=1),this._isAnimationSheetEnabled&&(i.push(0),a+=1,this.spriteRandomStartCell&&(i.push(0),a+=1)),this._platform.alignDataInBuffer){let e=3-(a+3&3);for(a+=e;e-- >0;)i.push(0)}const o=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),c=this._platform.createParticleBuffer(i);this._buffer0=new Ue.h(t,l,!1,this._attributesStrideSize),this._buffer1=new Ue.h(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new Ue.h(t,o,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+="\n#define BILLBOARD"),this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(e+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(e+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(e+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(e+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(e+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(e+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(e+="\n#define NOISE"),this.isLocal&&(e+="\n#define LOCAL"),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e||(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e)),this._platform.isUpdateBufferReady()}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t?.effect)return t;const i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||(r=new ec.E(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);const n=i.join("\n");if(r.defines!==n){const e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),r.setEffect(this._engine.createEffect("gpuRenderParticles",e,t,i,n),n)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){const n=[Ue.R.PositionKind,"age","life","size","angle"];return e||n.push(Ue.R.ColorKind),t&&n.push("cellIndex"),i||n.push("initialDirection"),r&&n.push("direction"),n.push("offset",Ue.R.UVKind),n}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){const r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return(0,Xo.TV)(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,i=!0){if(this._scene&&((0,Xo.tv)(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==kt.Z.FOGMODE_NONE&&e.push("#define FOG")),t===pT.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case pT.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case pT.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case pT.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...KT._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===pT.BILLBOARDMODE_STRETCHED)),e.push(...KT._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(Mi.p.PrepareUniforms(e,this._imageProcessingConfigurationDefines),Mi.p.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){const i=this[t];if(!e||!e.length||i)return;const r=new Float32Array(this._rawTextureWidth);for(let t=0;t<this._rawTextureWidth;t++){const i=t/this._rawTextureWidth;kx.GetCurrentGradient(i,e,((e,i,n)=>{r[t]=(0,it.Lerp)(e.factor1,i.factor1,n)}))}this[t]=me.I.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(4*this._rawTextureWidth),t=a.IG.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;kx.GetCurrentGradient(r,this._colorGradients,((r,n,s)=>{a.ov.LerpToRef(r.color1,n.color1,s,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255*t.a}))}this._colorGradientsTexture=me.I.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){const i=this._getWrapper(e),r=i.effect;this._engine.enableEffect(i);const n=this._scene?.getViewMatrix()||s.uq.IdentityReadOnly;if(r.setMatrix("view",n),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot),r.setVector3("worldOffset",this.worldOffset),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const e=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,e.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const e=this._scene.activeCamera;r.setVector3("eyePosition",e.globalPosition)}const a=r.defines;if(this._scene&&((0,Xo.gS)(r,this,this._scene),this.applyFog&&(0,qo.Yy)(this._scene,void 0,r)),a.indexOf("#define BILLBOARDMODE_ALL")>=0){const e=n.clone();e.invert(),r.setMatrix("invView",e)}switch(this.useLogarithmicDepth&&this._scene&&(0,qo.DL)(a,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),e){case pT.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case pT.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case pT.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case pT.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,r,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._scene?.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._scene?.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer)return;if(!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{const t=this.emitter;e=s.AA.Matrix[0],s.uq.TranslationToRef(t.x,t.y,t.z,e)}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);const t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){if(!this._started)return 0;if(!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let e=0;e<this.preWarmCycles;e++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const e=0|this._accumulatedCount;this._accumulatedCount-=e,this._currentActiveCount+=e}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{const e=this.emitter;i=s.AA.Matrix[0],s.uq.TranslationToRef(e.x,e.y,e.z,i)}const r=this._engine;this.updateInAnimate||this._update(i);let n=0;return e||t||(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),n=this.blendMode===pT.BLENDMODE_MULTIPLYADD?this._render(pT.BLENDMODE_MULTIPLY,i)+this._render(pT.BLENDMODE_ADD,i):this._render(this.blendMode,i),this._engine.setAlphaMode(0)),n}rebuild(){const e=()=>{this._recreateUpdateEffect()&&this._platform.isUpdateBufferReady()?(this._initialize(!0),this._rebuildingAfterContextLost=!1):setTimeout(e,10)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const e in this._drawWrappers)this._drawWrappers[e].dispose();if(this._drawWrappers={},this._scene){const e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let e=0;e<this._renderVertexBuffers.length;++e){const t=this._renderVertexBuffers[e];for(const e in t)t[e].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){const r={...this._customWrappers};let n=null;const s=this._engine;if(s.createEffectForParticles&&null!=this.customShader){n=this.customShader;const e=n.shaderOptions.defines.length>0?n.shaderOptions.defines.join("\n"):"";r[0]=s.createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,e,void 0,void 0,void 0,this)}const a=this.serialize(i),o=KT.Parse(a,this._scene||this._engine,this._rootUrl);return o.name=e,o.customShader=n,o._customWrappers=r,void 0===t&&(t=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=t,o}serialize(e=!1){const t={};return pT._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,r=!1,n){const s=e.name;let a,o;t instanceof ne.$?a=t:(o=t,a=o.getEngine());const l=new KT(s,{capacity:n||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(l._rootUrl=i,e.customShader&&a.createEffectForParticles){const t=e.customShader,i=t.shaderOptions.defines.length>0?t.shaderOptions.defines.join("\n"):"",r=a.createEffectForParticles(t.shaderPath.fragmentElement,t.shaderOptions.uniforms,t.shaderOptions.samplers,i,void 0,void 0,void 0,l);l.setCustomEffect(r,0),l.customShader=t}return e.id&&(l.id=e.id),e.activeParticleCount&&(l.activeParticleCount=e.activeParticleCount),pT._Parse(e,l,t,i),e.preventAutoStart&&(l.preventAutoStart=e.preventAutoStart),r||l.preventAutoStart||l.start(),l}}class ZT{constructor(){this._emitterNodeIsOwned=!0,this.systems=[]}get emitterNode(){return this._emitterNode}set emitterNode(e){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(const t of this.systems)t.emitter=e;this._emitterNode=e}setEmitterAsSphere(e,t,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:e,renderingGroupId:t};const r=(0,Mo._6)("emitterSphere",{diameter:e.diameter,segments:e.segments},i);r.renderingGroupId=t;const n=new Oi.F("emitterSphereMaterial",i);n.emissiveColor=e.color,r.material=n;for(const e of this.systems)e.emitter=r;this._emitterNode=r}start(e){for(const t of this.systems)e&&(t.emitter=e),t.start()}dispose(){for(const e of this.systems)e.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(e=!1){const t={systems:[]};for(const i of this.systems)t.systems.push(i.serialize(e));return this._emitterNode&&(t.emitter=this._emitterCreationOptions),t}static Parse(e,t,i=!1,r){const n=new ZT,s=this.BaseAssetsUrl+"/textures/";t=t||P.q.LastCreatedScene;for(const a of e.systems)n.systems.push(i?KT.Parse(a,t,s,!0,r):pT.Parse(a,t,s,!0,r));if(e.emitter){const i=e.emitter.options;"Sphere"===e.emitter.kind&&n.setEmitterAsSphere({diameter:i.diameter,segments:i.segments,color:a.v9.FromArray(i.color)},e.emitter.renderingGroupId,t)}return n}}ZT.BaseAssetsUrl="https://assets.babylonjs.com/particles";class QT{static CreateDefault(e,t=500,i,r=!1){let n;return n=r?new KT("default system",{capacity:t},i):new pT("default system",t,i),n.emitter=e,n.particleTexture=new _e.g("https://assets.babylonjs.com/textures/flare.png",n.getScene()),n.createConeEmitter(.1,Math.PI/4),n.color1=new a.ov(1,1,1,1),n.color2=new a.ov(1,1,1,1),n.colorDead=new a.ov(1,1,1,0),n.minSize=.1,n.maxSize=.1,n.minEmitPower=2,n.maxEmitPower=2,n.updateSpeed=1/60,n.emitRate=30,n}static CreateAsync(e,t,i=!1,r){t||(t=P.q.LastCreatedScene);const n={};return t.addPendingData(n),new Promise(((s,a)=>{if(i&&!KT.IsSupported)return t.removePendingData(n),a("Particle system with GPU is not supported.");re.S0.LoadFile(`${QT.BaseAssetsUrl}/systems/${e}.json`,(e=>{t.removePendingData(n);const a=JSON.parse(e.toString());return s(ZT.Parse(a,t,i,r))}),void 0,void 0,void 0,(()=>(t.removePendingData(n),a(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`))))}))}static ExportSet(e){const t=new ZT;for(const i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,r=!1,n="",s){return new Promise(((a,o)=>{const l=new aa.u;l.addEventListener("readystatechange",(()=>{if(4==l.readyState)if(200==l.status){const t=JSON.parse(l.responseText);let o;o=r?KT.Parse(t,i,n,!1,s):pT.Parse(t,i,n,!1,s),e&&(o.name=e),a(o)}else o("Unable to load the particle system")})),l.open("GET",t),l.send()}))}static ParseFromSnippetAsync(e,t,i=!1,r="",n){if("_BLANK"===e){const e=this.CreateDefault(null);return e.start(),Promise.resolve(e)}return new Promise(((s,a)=>{const o=new aa.u;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.particleSystem);let c;c=i?KT.Parse(l,t,r,!1,n):pT.Parse(l,t,r,!1,n),c.snippetId=e,s(c)}else a("Unable to load the snippet "+e)})),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()}))}}QT.BaseAssetsUrl=ZT.BaseAssetsUrl,QT.SnippetUrl="https://snippet.babylonjs.com",QT.CreateFromSnippetAsync=QT.ParseFromSnippetAsync,(0,Dc.ji)(Gt.v.NAME_PARTICLESYSTEM,((e,t,i,r)=>{const n=(0,Dc.LO)(Gt.v.NAME_PARTICLESYSTEM);if(n&&void 0!==e.particleSystems&&null!==e.particleSystems)for(let s=0,a=e.particleSystems.length;s<a;s++){const a=e.particleSystems[s];i.particleSystems.push(n(a,t,r))}})),(0,Dc.cf)(Gt.v.NAME_PARTICLESYSTEM,((e,t,i)=>e.activeParticleCount?KT.Parse(e,t,i):pT.Parse(e,t,i))),ne.$.prototype.createEffectForParticles=function(e,t=[],r=[],n="",s,a,o,l,c=0){let h=[],u=[];const d=[];return l?l.fillUniformsAttributesAndSamplerNames(u,h,d):(h=pT._GetAttributeNamesOrOptions(),u=pT._GetEffectCreationOptions()),-1===n.indexOf(" BILLBOARD")&&(n+="\n#define BILLBOARD\n"),l?.isAnimationSheetEnabled&&-1===n.indexOf(" ANIMATESHEET")&&(n+="\n#define ANIMATESHEET\n"),-1===r.indexOf("diffuseSampler")&&r.push("diffuseSampler"),this.createEffect({vertex:l?.vertexShaderName??"particles",fragmentElement:e},h,u.concat(t),d.concat(r),n,s,a,o,void 0,c,(async()=>{0===c?await Promise.resolve().then(i.bind(i,28044)):await Promise.resolve().then(i.bind(i,60887))}))},Rt.e.prototype.getEmittedParticleSystems=function(){const e=[];for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},Rt.e.prototype.getHierarchyEmittedParticleSystems=function(){const e=[],t=this.getDescendants();t.push(this);for(let i=0;i<this.getScene().particleSystems.length;i++){const r=this.getScene().particleSystems[i],n=r.emitter;n.position&&-1!==t.indexOf(n)&&e.push(r)}return e};class JT{getBoundingInfo(){return this._boundingInfo}get hasBoundingInfo(){return null!==this._boundingInfo}constructor(e,t,i,r,n,o,l,c,h=null,u=null){this.idx=0,this.id=0,this.color=new a.ov(1,1,1,1),this.position=s.Pq.Zero(),this.rotation=s.Pq.Zero(),this.scaling=s.Pq.One(),this.uvs=new s.IU(0,0,1,1),this.velocity=s.Pq.Zero(),this.pivot=s.Pq.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=Er.u.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=s.Pq.Zero(),this.idx=e,this.id=t,this._pos=i,this._ind=r,this._model=n,this.shapeId=o,this.idxInShape=l,this._sps=c,h&&(this._modelBoundingInfo=h,this._boundingInfo=new fr.j(h.minimum,h.maximum)),null!==u&&(this.materialIndex=u)}copyToRef(e){return e.position.copyFrom(this.position),e.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(e.rotationQuaternion?e.rotationQuaternion.copyFrom(this.rotationQuaternion):e.rotationQuaternion=this.rotationQuaternion.clone()),e.scaling.copyFrom(this.scaling),this.color&&(e.color?e.color.copyFrom(this.color):e.color=this.color.clone()),e.uvs.copyFrom(this.uvs),e.velocity.copyFrom(this.velocity),e.pivot.copyFrom(this.pivot),e.translateFromPivot=this.translateFromPivot,e.alive=this.alive,e.isVisible=this.isVisible,e.parentId=this.parentId,e.cullingStrategy=this.cullingStrategy,null!==this.materialIndex&&(e.materialIndex=this.materialIndex),this}get scale(){return this.scaling}set scale(e){this.scaling=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e){return!(!this._boundingInfo||!e.hasBoundingInfo)&&(this._sps._bSphereOnly?vr.i.Intersects(this._boundingInfo.boundingSphere,e.getBoundingInfo().boundingSphere):this._boundingInfo.intersects(e.getBoundingInfo(),!1))}isInFrustum(e){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(e,this.cullingStrategy)}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=s.AA.Quaternion[0];const e=this.rotation;s.PT.RotationYawPitchRollToRef(e.y,e.x,e.z,t)}t.toRotationMatrix(e)}}class eE{get shapeID(){return this.shapeId}set shapeID(e){this.shapeId=e}constructor(e,t,i,r,n,s,a,o,l){this._indicesLength=0,this.shapeId=e,this._shape=t,this._indices=i,this._indicesLength=i.length,this._shapeUV=s,this._shapeColors=n,this._normals=r,this._positionFunction=a,this._vertexFunction=o,this._material=l}}class tE{constructor(e,t,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=e,this.ind=t,this.indicesLength=i,this.materialIndex=r}}class iE{constructor(){this.position=s.Pq.Zero(),this.color=new a.ov(1,1,1,1),this.uv=s.I9.Zero()}get x(){return this.position.x}set x(e){this.position.x=e}get y(){return this.position.y}set y(e){this.position.y=e}get z(){return this.position.z}set z(e){this.position.z=e}}class rE{constructor(e,t,i){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new JT(0,0,0,0,null,0,0,this),this._color=new a.ov(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._autoFixFaceOrientation=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=(e,t)=>t.sqDistance-e.sqDistance,this._materialSortFunction=(e,t)=>e.materialIndex-t.materialIndex,this._autoUpdateSubMeshes=!1,this._recomputeInvisibles=!1,this.name=e,this._scene=t||P.q.LastCreatedScene,this._camera=t.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._multimaterialEnabled=!!i&&i.enableMultiMaterial,this._useModelMaterial=!!i&&i.useModelMaterial,this._multimaterialEnabled=!!this._useModelMaterial||this._multimaterialEnabled,this._expandable=!!i&&i.expandable,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,this._computeBoundingBox=!!i?.computeBoundingBox&&i.computeBoundingBox,this._autoFixFaceOrientation=!!i?.autoFixFaceOrientation&&i.autoFixFaceOrientation,i&&void 0!==i.updatable?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new Lh.F(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new iE}buildMesh(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(0===this.nbParticles&&!this.mesh){const e=(0,Oo.WA)("",{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){const e=new Rt.e(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&S_.P.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();const e=new S_.P;if(e.indices=this._depthSort?this._indices:this._indices32,e.set(this._positions32,Ue.R.PositionKind),e.set(this._normals32,Ue.R.NormalKind),this._uvs32.length>0&&e.set(this._uvs32,Ue.R.UVKind),this._colors32.length>0&&e.set(this._colors32,Ue.R.ColorKind),e.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable){let e=0;for(let t=0;t<this.nbParticles;t++){const i=this.particles[t],r=i._model._indicesLength;for(let t=0;t<r;t++)if(0==t%3){const t={idx:i.idx,faceId:e};this.pickedParticles[e]=t,e++}}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(this._depthSort||this._multimaterialEnabled||this._autoFixFaceOrientation||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this._recomputeInvisibles=!0,this.mesh}_getUVKind(e,t){return-1===t&&(e.material?.diffuseTexture?t=e.material.diffuseTexture.coordinatesIndex:e.material?.albedoTexture&&(t=e.material.albedoTexture.coordinatesIndex)),"uv"+(t?t+1:"")}digest(e,t){let i=t&&t.facetNb||1,r=t&&t.number||0,n=t&&t.delta||0;const a=e.getVerticesData(Ue.R.PositionKind),o=e.getIndices(),l=e.getVerticesData(this._getUVKind(e,t?.uvKind??0)),c=e.getVerticesData(Ue.R.ColorKind),h=e.getVerticesData(Ue.R.NormalKind),u=t&&t.storage?t.storage:null;let d=0;const p=o.length/3;r?(r=r>p?p:r,i=Math.round(p/r),n=0):i=i>p?p:i;const f=[],m=[],_=[],g=[],v=[],S=s.Pq.Zero(),x=i;for(;d<p;){i=x+Math.floor((1+n)*Math.random()),d>p-i&&(i=p-d),f.length=0,m.length=0,_.length=0,g.length=0,v.length=0;let t=0;for(let e=3*d;e<3*(d+i);e++){_.push(t);const i=o[e],r=3*i;if(f.push(a[r],a[r+1],a[r+2]),m.push(h[r],h[r+1],h[r+2]),l){const e=2*i;g.push(l[e],l[e+1])}if(c){const e=4*i;v.push(c[e],c[e+1],c[e+2],c[e+3])}t++}let r=this.nbParticles;const T=this._posToShape(f),E=this._uvsToShapeUV(g),C=_.slice(),b=v.slice(),P=m.slice();let y;for(S.copyFromFloats(0,0,0),y=0;y<T.length;y++)S.addInPlace(T[y]);S.scaleInPlace(1/T.length);const A=new s.Pq(1/0,1/0,1/0),R=new s.Pq(-1/0,-1/0,-1/0);for(y=0;y<T.length;y++)T[y].subtractInPlace(S),A.minimizeInPlaceFromFloats(T[y].x,T[y].y,T[y].z),R.maximizeInPlaceFromFloats(T[y].x,T[y].y,T[y].z);let I;this._particlesIntersect&&(I=new fr.j(A,R));let M=null;this._useModelMaterial&&(M=e.material?e.material:this._setDefaultMaterial());const O=new eE(this._shapeCounter,T,C,P,b,E,null,null,M),N=this._positions.length,D=this._indices.length;this._meshBuilder(this._index,D,T,this._positions,C,this._indices,g,this._uvs,b,this._colors,P,this._normals,r,0,null,O),this._addParticle(r,this._lastParticleId,N,D,O,this._shapeCounter,0,I,u),this.particles[this.nbParticles].position.addInPlace(S),u||(this._index+=T.length,r++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,d+=i}return this._isNotBuilt=!0,this}_unrotateFixedNormals(){let e=0,t=0;const i=s.AA.Vector3[0],r=s.AA.Quaternion[0],n=s.AA.Matrix[0];for(let a=0;a<this.particles.length;a++){const o=this.particles[a],l=o._model._shape;if(o.rotationQuaternion)o.rotationQuaternion.conjugateToRef(r);else{const e=o.rotation;s.PT.RotationYawPitchRollToRef(e.y,e.x,e.z,r),r.conjugateInPlace()}r.toRotationMatrix(n);for(let r=0;r<l.length;r++)t=e+3*r,s.Pq.TransformNormalFromFloatsToRef(this._normals32[t],this._normals32[t+1],this._normals32[t+2],n,i),i.toArray(this._fixedNormal32,t);e=t+3}}_resetCopy(){const e=this._copy;e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.copyFromFloats(0,0,1,1),e.color=null,e.translateFromPivot=!1,e.shapeId=0,e.materialIndex=null}_meshBuilder(e,t,i,r,n,a,o,l,c,h,u,d,p,f,m,_){let g,v=0,S=0,x=0;this._resetCopy();const T=this._copy,E=!(!m||!m.storage);if(T.idx=p,T.idxInShape=f,T.shapeId=_.shapeId,this._useModelMaterial){const e=_._material.uniqueId,t=this._materialIndexesById;Object.prototype.hasOwnProperty.call(t,e)||(t[e]=this._materials.length,this._materials.push(_._material));const i=t[e];T.materialIndex=i}if(m&&m.positionFunction&&(m.positionFunction(T,p,f),this._mustUnrotateFixedNormals=!0),E)return T;const C=s.AA.Matrix[0],b=this._tmpVertex,P=b.position,y=b.color,A=b.uv,R=s.AA.Vector3[1],I=s.AA.Vector3[2],M=s.AA.Vector3[3];s.uq.IdentityToRef(C),T.getRotationMatrix(C),T.pivot.multiplyToRef(T.scaling,M),T.translateFromPivot?I.setAll(0):I.copyFrom(M);const O=m&&m.vertexFunction;for(g=0;g<i.length;g++){if(P.copyFrom(i[g]),T.color&&y.copyFrom(T.color),o&&A.copyFromFloats(o[v],o[v+1]),O&&m.vertexFunction(T,b,g),P.multiplyInPlace(T.scaling).subtractInPlace(M),s.Pq.TransformCoordinatesToRef(P,C,R),R.addInPlace(I).addInPlace(T.position),r.push(R.x,R.y,R.z),o){const e=T.uvs;l.push((e.z-e.x)*A.x+e.x,(e.w-e.y)*A.y+e.y),v+=2}if(T.color)this._color.copyFrom(y);else{const e=this._color;c&&void 0!==c[S]?(e.r=c[S],e.g=c[S+1],e.b=c[S+2],e.a=c[S+3]):(e.r=1,e.g=1,e.b=1,e.a=1)}h.push(this._color.r,this._color.g,this._color.b,this._color.a),S+=4,!this.recomputeNormals&&u&&(s.Pq.TransformNormalFromFloatsToRef(u[x],u[x+1],u[x+2],C,P),d.push(P.x,P.y,P.z),x+=3)}for(g=0;g<n.length;g++){const t=e+n[g];a.push(t),t>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){const e=null!==T.materialIndex?T.materialIndex:0;this.depthSortedParticles.push(new tE(p,t,n.length,e))}return T}_posToShape(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(s.Pq.FromArray(e,i));return t}_uvsToShapeUV(e){const t=[];if(e)for(let i=0;i<e.length;i++)t.push(e[i]);return t}_addParticle(e,t,i,r,n,s,a,o=null,l=null){const c=new JT(e,t,i,r,n,s,a,this,o);return(l||this.particles).push(c),c}addShape(e,t,i){const r=e.getVerticesData(Ue.R.PositionKind),n=e.getIndices(),s=e.getVerticesData(Ue.R.UVKind),a=e.getVerticesData(Ue.R.ColorKind),o=e.getVerticesData(Ue.R.NormalKind);this.recomputeNormals=!o;const l=Array.from(n),c=o?Array.from(o):[],h=a?Array.from(a):[],u=i&&i.storage?i.storage:null;let d=null;this._particlesIntersect&&(d=e.getBoundingInfo());const p=this._posToShape(r),f=this._uvsToShapeUV(s),m=i?i.positionFunction:null,_=i?i.vertexFunction:null;let g=null;this._useModelMaterial&&(g=e.material?e.material:this._setDefaultMaterial());const v=new eE(this._shapeCounter,p,l,c,h,f,m,_,g);for(let e=0;e<t;e++)this._insertNewParticle(this.nbParticles,e,v,p,n,s,a,o,d,u,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1}_rebuildParticle(e,t=!1){this._resetCopy();const i=this._copy;e._model._positionFunction&&e._model._positionFunction(i,e.idx,e.idxInShape);const r=s.AA.Matrix[0],n=s.AA.Vector3[0],a=s.AA.Vector3[1],o=s.AA.Vector3[2],l=s.AA.Vector3[3];i.getRotationMatrix(r),e.pivot.multiplyToRef(e.scaling,l),i.translateFromPivot?o.copyFromFloats(0,0,0):o.copyFrom(l);const c=e._model._shape;for(let t=0;t<c.length;t++)n.copyFrom(c[t]),e._model._vertexFunction&&e._model._vertexFunction(i,n,t),n.multiplyInPlace(i.scaling).subtractInPlace(l),s.Pq.TransformCoordinatesToRef(n,r,a),a.addInPlace(o).addInPlace(i.position).toArray(this._positions32,e._pos+3*t);t&&(e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.setAll(0),e.pivot.setAll(0),e.translateFromPivot=!1,e.parentId=null)}rebuildMesh(e=!1){for(let t=0;t<this.particles.length;t++)this._rebuildParticle(this.particles[t],e);return this.mesh.updateVerticesData(Ue.R.PositionKind,this._positions32,!1,!1),this}removeParticles(e,t){const i=t-e+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];const r=this.particles,n=this.nbParticles;if(t<n-1){const i=t+1,s=r[i]._pos-r[e]._pos,a=r[i]._ind-r[e]._ind;for(let e=i;e<n;e++){const t=r[e];t._pos-=s,t._ind-=a}}const s=r.splice(e,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);let a=0;const o=r.length;for(let e=0;e<o;e++){const t=r[e],i=t._model,n=i._shape,s=i._indices,o=i._normals,l=i._shapeColors,c=i._shapeUV;t.idx=e,this._idxOfId[t.id]=e,this._meshBuilder(this._index,a,n,this._positions,s,this._indices,c,this._uvs,l,this._colors,o,this._normals,t.idx,t.idxInShape,null,i),this._index+=n.length,a+=s.length}return this.nbParticles-=i,this._isNotBuilt=!0,s}insertParticlesFromArray(e){if(!this._expandable)return this;let t=0,i=e[0].shapeId;const r=e.length;for(let n=0;n<r;n++){const r=e[n],s=r._model,a=s._shape,o=s._indices,l=s._shapeUV,c=s._shapeColors,h=s._normals,u=!h;this.recomputeNormals=u||this.recomputeNormals;const d=r.getBoundingInfo(),p=this._insertNewParticle(this.nbParticles,t,s,a,o,l,c,h,d,null,null);r.copyToRef(p),t++,i!=r.shapeId&&(i=r.shapeId,t=0)}return this._isNotBuilt=!0,this}_insertNewParticle(e,t,i,r,n,s,a,o,l,c,h){const u=this._positions.length,d=this._indices.length,p=this._meshBuilder(this._index,d,r,this._positions,n,this._indices,s,this._uvs,a,this._colors,o,this._normals,e,t,h,i);let f=null;return this._updatable&&(f=this._addParticle(this.nbParticles,this._lastParticleId,u,d,i,this._shapeCounter,t,l,c),f.position.copyFrom(p.position),f.rotation.copyFrom(p.rotation),p.rotationQuaternion&&(f.rotationQuaternion?f.rotationQuaternion.copyFrom(p.rotationQuaternion):f.rotationQuaternion=p.rotationQuaternion.clone()),p.color&&(f.color?f.color.copyFrom(p.color):f.color=p.color.clone()),f.scaling.copyFrom(p.scaling),f.uvs.copyFrom(p.uvs),null!==p.materialIndex&&(f.materialIndex=p.materialIndex),this.expandable&&(this._idxOfId[f.id]=f.idx)),c||(this._index+=r.length,this.nbParticles++,this._lastParticleId++),f}setParticles(e=0,t=this.nbParticles-1,i=!0){if(!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(e,t,i);const r=s.AA.Matrix[0],n=s.AA.Matrix[1],a=this.mesh,o=this._colors32,l=this._positions32,c=this._normals32,h=this._uvs32,u=this._indices32,d=this._indices,p=this._fixedNormal32,f=this._depthSort&&this._depthSortParticles,m=s.AA.Vector3,_=m[5].copyFromFloats(1,0,0),g=m[6].copyFromFloats(0,1,0),v=m[7].copyFromFloats(0,0,1),S=m[8].setAll(Number.MAX_VALUE),x=m[9].setAll(-Number.MAX_VALUE),T=m[10].setAll(0),E=this._tmpVertex,C=E.position,b=E.color,P=E.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(n)),this.billboard){const e=m[0];this._camera.getDirectionToRef(ke._0.Z,e),s.Pq.TransformNormalToRef(e,n,v),v.normalize();const t=this._camera.getViewMatrix(!0);s.Pq.TransformNormalFromFloatsToRef(t.m[1],t.m[5],t.m[9],n,g),s.Pq.CrossToRef(g,v,_),g.normalize(),_.normalize()}this._depthSort&&s.Pq.TransformCoordinatesToRef(this._camera.globalPosition,n,T),s.uq.IdentityToRef(r);let y=0,A=0,R=0,I=0,M=0,O=0,N=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){const e=this.mesh.getBoundingInfo();e&&(S.copyFrom(e.minimum),x.copyFrom(e.maximum))}A=this.particles[e]._pos;const D=A/3|0;I=4*D,O=2*D;for(let i=e;i<=t;i++){const e=this.particles[i];this.updateParticle(e);const t=e._model._shape,n=e._model._shapeUV,u=e._rotationMatrix,d=e.position,D=e.rotation,F=e.scaling,L=e._globalPosition;if(f){const t=this.depthSortedParticles[i];t.idx=e.idx,t.ind=e._ind,t.indicesLength=e._model._indicesLength,t.sqDistance=s.Pq.DistanceSquared(e.position,T)}if(e.alive&&(!e._stillInvisible||e.isVisible||this._recomputeInvisibles)){if(e.isVisible){e._stillInvisible=!1;const i=m[12];if(e.pivot.multiplyToRef(F,i),this.billboard&&(D.x=0,D.y=0),(this._computeParticleRotation||this.billboard)&&e.getRotationMatrix(r),null!==e.parentId){const t=this.getParticleById(e.parentId);if(t){const e=t._rotationMatrix,i=t._globalPosition,n=d.x*e[1]+d.y*e[4]+d.z*e[7],s=d.x*e[0]+d.y*e[3]+d.z*e[6],a=d.x*e[2]+d.y*e[5]+d.z*e[8];if(L.x=i.x+s,L.y=i.y+n,L.z=i.z+a,this._computeParticleRotation||this.billboard){const t=r.m;u[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],u[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],u[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],u[3]=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],u[4]=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],u[5]=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],u[6]=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],u[7]=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],u[8]=t[8]*e[2]+t[9]*e[5]+t[10]*e[8]}}else e.parentId=null}else if(L.x=d.x,L.y=d.y,L.z=d.z,this._computeParticleRotation||this.billboard){const e=r.m;u[0]=e[0],u[1]=e[1],u[2]=e[2],u[3]=e[4],u[4]=e[5],u[5]=e[6],u[6]=e[8],u[7]=e[9],u[8]=e[10]}const s=m[11];for(e.translateFromPivot?s.setAll(0):s.copyFrom(i),N=0;N<t.length;N++){y=A+3*N,R=I+4*N,M=O+2*N;const r=2*N,a=r+1;C.copyFrom(t[N]),this._computeParticleColor&&e.color&&b.copyFrom(e.color),this._computeParticleTexture&&P.copyFromFloats(n[r],n[a]),this._computeParticleVertex&&this.updateParticleVertex(e,E,N);const o=C.x*F.x-i.x,d=C.y*F.y-i.y,f=C.z*F.z-i.z;let m=o*u[0]+d*u[3]+f*u[6],T=o*u[1]+d*u[4]+f*u[7],D=o*u[2]+d*u[5]+f*u[8];m+=s.x,T+=s.y,D+=s.z;const w=l[y]=L.x+_.x*m+g.x*T+v.x*D,B=l[y+1]=L.y+_.y*m+g.y*T+v.y*D,V=l[y+2]=L.z+_.z*m+g.z*T+v.z*D;if(this._computeBoundingBox&&(S.minimizeInPlaceFromFloats(w,B,V),x.maximizeInPlaceFromFloats(w,B,V)),!this._computeParticleVertex){const e=p[y],t=p[y+1],i=p[y+2],r=e*u[0]+t*u[3]+i*u[6],n=e*u[1]+t*u[4]+i*u[7],s=e*u[2]+t*u[5]+i*u[8];c[y]=_.x*r+g.x*n+v.x*s,c[y+1]=_.y*r+g.y*n+v.y*s,c[y+2]=_.z*r+g.z*n+v.z*s}if(this._computeParticleColor&&e.color){const e=this._colors32;e[R]=b.r,e[R+1]=b.g,e[R+2]=b.b,e[R+3]=b.a}if(this._computeParticleTexture){const t=e.uvs;h[M]=P.x*(t.z-t.x)+t.x,h[M+1]=P.y*(t.w-t.y)+t.y}}}else for(e._stillInvisible=!0,N=0;N<t.length;N++){if(y=A+3*N,R=I+4*N,M=O+2*N,l[y]=l[y+1]=l[y+2]=0,c[y]=c[y+1]=c[y+2]=0,this._computeParticleColor&&e.color){const t=e.color;o[R]=t.r,o[R+1]=t.g,o[R+2]=t.b,o[R+3]=t.a}if(this._computeParticleTexture){const t=e.uvs;h[M]=n[2*N]*(t.z-t.x)+t.x,h[M+1]=n[2*N+1]*(t.w-t.y)+t.y}}if(this._particlesIntersect){const t=e.getBoundingInfo(),i=t.boundingBox,r=t.boundingSphere,n=e._modelBoundingInfo;if(!this._bSphereOnly){const e=n.boundingBox.vectors,t=m[1],r=m[2];t.setAll(Number.MAX_VALUE),r.setAll(-Number.MAX_VALUE);for(let i=0;i<8;i++){const n=e[i].x*F.x,s=e[i].y*F.y,a=e[i].z*F.z,o=n*u[0]+s*u[3]+a*u[6],l=n*u[1]+s*u[4]+a*u[7],c=n*u[2]+s*u[5]+a*u[8],h=d.x+_.x*o+g.x*l+v.x*c,p=d.y+_.y*o+g.y*l+v.y*c,f=d.z+_.z*o+g.z*l+v.z*c;t.minimizeInPlaceFromFloats(h,p,f),r.maximizeInPlaceFromFloats(h,p,f)}i.reConstruct(t,r,a._worldMatrix)}const s=n.minimum.multiplyToRef(F,m[1]),o=n.maximum.multiplyToRef(F,m[2]),l=o.addToRef(s,m[3]).scaleInPlace(.5).addInPlace(L),c=o.subtractToRef(s,m[4]).scaleInPlace(.5*this._bSphereRadiusFactor),h=l.subtractToRef(c,m[1]),p=l.addToRef(c,m[2]);r.reConstruct(h,p,a._worldMatrix)}A=y+3,I=R+4,O=M+2}else N=t.length,A+=3*N,I+=4*N,O+=2*N}if(i){if(this._computeParticleColor){const e=a.getVertexBuffer(Ue.R.ColorKind);e&&!a.isPickable?e.updateDirectly(o,0):a.updateVerticesData(Ue.R.ColorKind,o,!1,!1)}if(this._computeParticleTexture){const e=a.getVertexBuffer(Ue.R.UVKind);e&&!a.isPickable?e.updateDirectly(h,0):a.updateVerticesData(Ue.R.UVKind,h,!1,!1)}const e=a.getVertexBuffer(Ue.R.PositionKind);if(e&&!a.isPickable?e.updateDirectly(l,0):a.updateVerticesData(Ue.R.PositionKind,l,!1,!1),!a.areNormalsFrozen||a.isFacetDataEnabled){if(this._computeParticleVertex||a.isFacetDataEnabled){const e=a.isFacetDataEnabled?a.getFacetDataParameters():null;S_.P.ComputeNormals(l,u,c,e);for(let e=0;e<c.length;e++)p[e]=c[e]}if(!a.areNormalsFrozen){const e=a.getVertexBuffer(Ue.R.NormalKind);e&&!a.isPickable?e.updateDirectly(c,0):a.updateVerticesData(Ue.R.NormalKind,c,!1,!1)}}if(f){const e=this.depthSortedParticles;e.sort(this._depthSortFunction);const t=e.length;let i=0,r=0;for(let n=0;n<t;n++){const t=e[n],s=t.indicesLength,a=t.ind;for(let e=0;e<s;e++)if(u[i]=d[a+e],i++,this._pickable&&0==e%3){const e=this.pickedParticles[r];e.idx=t.idx,e.faceId=r,r++}}}if(this._autoFixFaceOrientation){let e=0;for(let t=0;t<this.particles.length;t++){const i=f?this.particles[this.depthSortedParticles[t].idx]:this.particles[t];if(i.scale.x*i.scale.y*i.scale.z<0)for(let t=0;t<i._model._indicesLength;t+=3){const r=d[i._ind+t];u[e+t]=d[i._ind+t+1],u[e+t+1]=r}e+=i._model._indicesLength}}(f||this._autoFixFaceOrientation)&&a.updateIndices(u)}return this._computeBoundingBox&&(a.hasBoundingInfo?a.getBoundingInfo().reConstruct(S,x,a._worldMatrix):a.buildBoundingInfo(S,x,a._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this._recomputeInvisibles=!1,this.afterUpdateParticles(e,t,i),this}dispose(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null}pickedParticle(e){if(e.hit){const t=e.subMeshId,i=e.faceId-this.mesh.subMeshes[t].indexStart/3,r=this.pickedBySubMesh;if(r[t]&&r[t][i])return r[t][i]}return null}getParticleById(e){const t=this.particles[e];if(t&&t.id==e)return t;const i=this.particles,r=this._idxOfId[e];if(void 0!==r)return i[r];let n=0;const s=this.nbParticles;for(;n<s;){const t=i[n];if(t.id==e)return t;n++}return null}getParticlesByShapeId(e){const t=[];return this.getParticlesByShapeIdToRef(e,t),t}getParticlesByShapeIdToRef(e,t){t.length=0;for(let i=0;i<this.nbParticles;i++){const r=this.particles[i];r.shapeId==e&&t.push(r)}return this}computeSubMeshes(){if(!this.mesh||!this._multimaterialEnabled)return this;const e=this.depthSortedParticles;if(this.particles.length>0)for(let t=0;t<this.particles.length;t++){const i=this.particles[t];i.materialIndex||(i.materialIndex=0);const r=e[t];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();const t=this._indicesByMaterial,i=this._materialIndexes,r=this.mesh;r.subMeshes=[];const n=r.getTotalVertices();for(let e=0;e<i.length;e++){const s=t[e],a=t[e+1]-s,o=i[e];new lc.K(o,0,n,s,a,r)}return this}_sortParticlesByMaterial(){const e=[0];this._indicesByMaterial=e;const t=[];this._materialIndexes=t;const i=this.depthSortedParticles;i.sort(this._materialSortFunction);const r=i.length,n=this._indices32,s=this._indices;let a=0,o=0,l=0,c=i[0].materialIndex;t.push(c),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(let h=0;h<r;h++){const r=i[h],u=r.indicesLength,d=r.ind;r.materialIndex!==c&&(c=r.materialIndex,e.push(l),t.push(c),this._pickable&&(a++,this.pickedBySubMesh[a]=[],o=0));let p=0;for(let e=0;e<u;e++){if(n[l]=s[d+e],this._pickable&&0==e%3){const e=this.pickedBySubMesh[a][o];e?(e.idx=r.idx,e.faceId=p):this.pickedBySubMesh[a][o]={idx:r.idx,faceId:p},o++,p++}l++}}return e.push(n.length),this._updatable&&this.mesh.updateIndices(n),this}_setMaterialIndexesById(){this._materialIndexesById={};for(let e=0;e<this._materials.length;e++){const t=this._materials[e].uniqueId;this._materialIndexesById[t]=e}}_filterUniqueMaterialId(e){return e.filter((function(e,t,i){return i.indexOf(e)===t}))}_setDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new Oi.F(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this}setVisibilityBox(e){const t=e/2;this.mesh.buildBoundingInfo(new s.Pq(-t,-t,-t),new s.Pq(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e}set isVisibilityBoxLocked(e){this._isVisibilityBoxLocked=e,this.mesh.getBoundingInfo().isLocked=e}get isVisibilityBoxLocked(){return this._isVisibilityBoxLocked}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}set computeParticleVertex(e){this._computeParticleVertex=e}set computeBoundingBox(e){this._computeBoundingBox=e}set depthSortParticles(e){this._depthSortParticles=e}get computeParticleRotation(){return this._computeParticleRotation}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}get computeParticleVertex(){return this._computeParticleVertex}get computeBoundingBox(){return this._computeBoundingBox}get depthSortParticles(){return this._depthSortParticles}get expandable(){return this._expandable}get multimaterialEnabled(){return this._multimaterialEnabled}get useModelMaterial(){return this._useModelMaterial}get materials(){return this._materials}setMultiMaterial(e){this._materials=this._filterUniqueMaterialId(e),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new Lh.F(this.name+"MultiMaterial",this._scene);for(let e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial}get multimaterial(){return this._multimaterial}set multimaterial(e){this._multimaterial=e}get autoUpdateSubMeshes(){return this._autoUpdateSubMeshes}set autoUpdateSubMeshes(e){this._autoUpdateSubMeshes=e}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}updateParticleVertex(e,t,i){return this}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}var nE,sE,aE,oE,lE,cE,hE,uE,dE,pE,fE,mE,_E=i(77583),gE=i(47501),vE=i(66726),SE=i(28044),xE=i(18269),TE=i(60887),EE=(i(15470),i(83852));!function(e){e[e.FREE=0]="FREE",e[e.LIMITED=1]="LIMITED",e[e.LOCKED=2]="LOCKED"}(nE||(nE={})),function(e){e[e.LINEAR_X=0]="LINEAR_X",e[e.LINEAR_Y=1]="LINEAR_Y",e[e.LINEAR_Z=2]="LINEAR_Z",e[e.ANGULAR_X=3]="ANGULAR_X",e[e.ANGULAR_Y=4]="ANGULAR_Y",e[e.ANGULAR_Z=5]="ANGULAR_Z",e[e.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"}(sE||(sE={})),function(e){e[e.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",e[e.DISTANCE=2]="DISTANCE",e[e.HINGE=3]="HINGE",e[e.SLIDER=4]="SLIDER",e[e.LOCK=5]="LOCK",e[e.PRISMATIC=6]="PRISMATIC",e[e.SIX_DOF=7]="SIX_DOF"}(aE||(aE={})),function(e){e[e.SPHERE=0]="SPHERE",e[e.CAPSULE=1]="CAPSULE",e[e.CYLINDER=2]="CYLINDER",e[e.BOX=3]="BOX",e[e.CONVEX_HULL=4]="CONVEX_HULL",e[e.CONTAINER=5]="CONTAINER",e[e.MESH=6]="MESH",e[e.HEIGHTFIELD=7]="HEIGHTFIELD"}(oE||(oE={})),function(e){e[e.NONE=0]="NONE",e[e.VELOCITY=1]="VELOCITY",e[e.POSITION=2]="POSITION"}(lE||(lE={})),function(e){e.COLLISION_STARTED="COLLISION_STARTED",e.COLLISION_CONTINUED="COLLISION_CONTINUED",e.COLLISION_FINISHED="COLLISION_FINISHED",e.TRIGGER_ENTERED="TRIGGER_ENTERED",e.TRIGGER_EXITED="TRIGGER_EXITED"}(cE||(cE={})),function(e){e[e.STATIC=0]="STATIC",e[e.ANIMATED=1]="ANIMATED",e[e.DYNAMIC=2]="DYNAMIC"}(hE||(hE={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.TELEPORT=1]="TELEPORT",e[e.ACTION=2]="ACTION"}(uE||(uE={})),function(e){e[e.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",e[e.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",e[e.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE"}(dE||(dE={}));class CE{get disablePreStep(){return this._prestepType==uE.DISABLED}set disablePreStep(e){this._prestepType=e?uE.DISABLED:uE.TELEPORT}constructor(e,t,i,r){if(this._pluginData=void 0,this._pluginDataInstances=[],this._collisionCBEnabled=!1,this._collisionEndedCBEnabled=!1,this.disableSync=!1,this._isDisposed=!1,this._shape=null,this._prestepType=uE.DISABLED,!r)return;const n=r.getPhysicsEngine();if(!n)throw new Error("No Physics Engine available.");if(this._physicsEngine=n,2!=n.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const a=n.getPhysicsPlugin();if(!a)throw new Error("No Physics Plugin available.");this._physicsPlugin=a,e.rotationQuaternion||(e.rotationQuaternion=s.PT.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z)),this.startAsleep=i,this._motionType=t,this.disableSync=0==t;const o=e;o.hasThinInstances?this._physicsPlugin.initBodyInstances(this,t,o):(e.parent&&e.computeWorldMatrix(!0),this._physicsPlugin.initBody(this,t,e.absolutePosition,e.absoluteRotationQuaternion)),this.transformNode=e,e.physicsBody=this,n.addBody(this),this._nodeDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}getClassName(){return"PhysicsBody"}clone(e){const t=new CE(e,this.getMotionType(),this.startAsleep,this.transformNode.getScene());return t.shape=this.shape,t.setMassProperties(this.getMassProperties()),t.setLinearDamping(this.getLinearDamping()),t.setAngularDamping(this.getAngularDamping()),t}updateBodyInstances(){const e=this.transformNode;e.hasThinInstances&&this._physicsPlugin.updateBodyInstances(this,e)}get numInstances(){return this._pluginDataInstances.length}get motionType(){return this._motionType}set shape(e){this._shape=e,e&&this._physicsPlugin.setShape(this,e)}get shape(){return this._shape}getBoundingBox(){return this._physicsPlugin.getBodyBoundingBox(this)}setEventMask(e,t){this._physicsPlugin.setEventMask(this,e,t)}getEventMask(e){return this._physicsPlugin.getEventMask(this,e)}setMotionType(e,t){this.disableSync=0==e,this._physicsPlugin.setMotionType(this,e,t)}getMotionType(e){return this._physicsPlugin.getMotionType(this,e)}setPrestepType(e){this._prestepType=e}getPrestepType(){return this._prestepType}computeMassProperties(e){return this._physicsPlugin.computeMassProperties(this,e)}setMassProperties(e,t){this._physicsPlugin.setMassProperties(this,e,t)}getMassProperties(e){return this._physicsPlugin.getMassProperties(this,e)}setLinearDamping(e,t){this._physicsPlugin.setLinearDamping(this,e,t)}getLinearDamping(e){return this._physicsPlugin.getLinearDamping(this,e)}setAngularDamping(e,t){this._physicsPlugin.setAngularDamping(this,e,t)}getAngularDamping(e){return this._physicsPlugin.getAngularDamping(this,e)}setLinearVelocity(e,t){this._physicsPlugin.setLinearVelocity(this,e,t)}getLinearVelocityToRef(e,t){this._physicsPlugin.getLinearVelocityToRef(this,e,t)}getLinearVelocity(e){const t=new s.Pq;return this.getLinearVelocityToRef(t,e),t}setAngularVelocity(e,t){this._physicsPlugin.setAngularVelocity(this,e,t)}getAngularVelocityToRef(e,t){this._physicsPlugin.getAngularVelocityToRef(this,e,t)}getAngularVelocity(e){const t=new s.Pq;return this.getAngularVelocityToRef(t,e),t}applyImpulse(e,t,i){this._physicsPlugin.applyImpulse(this,e,t,i)}applyAngularImpulse(e,t){this._physicsPlugin.applyAngularImpulse(this,e,t)}applyForce(e,t,i){this._physicsPlugin.applyForce(this,e,t,i)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}getCollisionObservable(){return this._physicsPlugin.getCollisionObservable(this)}getCollisionEndedObservable(){return this._physicsPlugin.getCollisionEndedObservable(this)}setCollisionCallbackEnabled(e){this._collisionCBEnabled=e,this._physicsPlugin.setCollisionCallbackEnabled(this,e)}setCollisionEndedCallbackEnabled(e){this._collisionEndedCBEnabled=e,this._physicsPlugin.setCollisionEndedCallbackEnabled(this,e)}getObjectCenterWorld(e){const t=new s.Pq;return this.getObjectCenterWorldToRef(t,e)}getObjectCenterWorldToRef(e,t){if(this._pluginDataInstances?.length>0){const i=t||0,r=this.transformNode._thinInstanceDataStorage.matrixData;r&&e.set(r[16*i+12],r[16*i+13],r[16*i+14])}else e.copyFrom(this.transformNode.position);return e}addConstraint(e,t,i,r){this._physicsPlugin.addConstraint(this,e,t,i,r)}syncWithBone(e,t,i,r,n,a){const o=this.transformNode;if(o.rotationQuaternion)if(n){const i=s.AA.Quaternion[0];e.getRotationQuaternionToRef(1,t,i),i.multiplyToRef(n,o.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,o.rotationQuaternion);const l=s.AA.Vector3[0],c=s.AA.Vector3[1];a||((a=s.AA.Vector3[2]).x=0,a.y=1,a.z=0),e.getDirectionToRef(a,t,c),e.getAbsolutePositionToRef(t,l),null==r&&i&&(r=i.length()),null!=r&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),o.setAbsolutePosition(l)}iterateOverAllInstances(e){if(this._pluginDataInstances?.length>0)for(let t=0;t<this._pluginDataInstances.length;t++)e(this,t);else e(this,void 0)}setGravityFactor(e,t){this._physicsPlugin.setGravityFactor(this,e,t)}getGravityFactor(e){return this._physicsPlugin.getGravityFactor(this,e)}setTargetTransform(e,t,i){this._physicsPlugin.setTargetTransform(this,e,t,i)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._collisionCBEnabled&&this.setCollisionCallbackEnabled(!1),this._collisionEndedCBEnabled&&this.setCollisionEndedCallbackEnabled(!1),this._nodeDisposeObserver&&(this.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this.transformNode.physicsBody=null,this._pluginData=null,this._pluginDataInstances.length=0,this._isDisposed=!0,this.shape=null)}}class bE{constructor(e,t){if(this._pluginData=void 0,this._isTrigger=!1,this._isDisposed=!1,!t)return;const i=t.getPhysicsEngine();if(!i)throw new Error("No Physics Engine available.");if(2!=i.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const r=i.getPhysicsPlugin();if(!r)throw new Error("No Physics Plugin available.");if(this._physicsPlugin=r,void 0!==e.pluginData&&null!==e.pluginData)this._pluginData=e.pluginData,this._type=this._physicsPlugin.getShapeType(this);else if(void 0!==e.type&&null!==e.type){this._type=e.type;const t=e.parameters??{};this._physicsPlugin.initShape(this,e.type,t)}}getClassName(){return"PhysicsShape"}get type(){return this._type}set filterMembershipMask(e){this._physicsPlugin.setShapeFilterMembershipMask(this,e)}get filterMembershipMask(){return this._physicsPlugin.getShapeFilterMembershipMask(this)}set filterCollideMask(e){this._physicsPlugin.setShapeFilterCollideMask(this,e)}get filterCollideMask(){return this._physicsPlugin.getShapeFilterCollideMask(this)}set material(e){this._physicsPlugin.setMaterial(this,e),this._material=e}get material(){return this._material||(this._material=this._physicsPlugin.getMaterial(this)),this._material}set density(e){this._physicsPlugin.setDensity(this,e)}get density(){return this._physicsPlugin.getDensity(this)}addChildFromParent(e,t,i){const r=i.computeWorldMatrix(!0),n=e.computeWorldMatrix(!0),a=s.AA.Matrix[0];r.multiplyToRef(s.uq.Invert(n),a);const o=s.AA.Vector3[0],l=s.AA.Quaternion[0],c=s.AA.Vector3[1];a.decompose(c,l,o),this._physicsPlugin.addChild(this,t,o,l,c)}addChild(e,t,i,r){this._physicsPlugin.addChild(this,e,t,i,r)}removeChild(e){this._physicsPlugin.removeChild(this,e)}getNumChildren(){return this._physicsPlugin.getNumChildren(this)}getBoundingBox(){return this._physicsPlugin.getBoundingBox(this)}set isTrigger(e){this._isTrigger!==e&&(this._isTrigger=e,this._physicsPlugin.setTrigger(this,e))}get isTrigger(){return this._isTrigger}dispose(){this._isDisposed||(this._physicsPlugin.disposeShape(this),this._isDisposed=!0)}}class PE extends bE{constructor(e,t,i){super({type:0,parameters:{center:e,radius:t}},i)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingSphere.center,r=t.boundingBox.extendSize,n=Math.max(r.x,r.y,r.z);return new PE(i,n,e.getScene())}}class yE extends bE{constructor(e,t,i,r){super({type:1,parameters:{pointA:e,pointB:t,radius:i}},r)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,r=new s.Pq(0,t.boundingBox.extendSize.y-i,0),n=t.boundingBox.center.add(r),a=t.boundingBox.center.subtract(r);return new yE(n,a,i,e.getScene())}}class AE extends bE{constructor(e,t,i,r){super({type:2,parameters:{pointA:e,pointB:t,radius:i}},r)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,r=new s.Pq(0,t.boundingBox.extendSize.y,0),n=t.boundingBox.center.add(r),a=t.boundingBox.center.subtract(r);return new AE(n,a,i,e.getScene())}}class RE extends bE{constructor(e,t,i,r){super({type:3,parameters:{center:e,rotation:t,extents:i}},r)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.center,r=t.boundingBox.extendSize.scale(2);return new RE(i,s.PT.Identity(),r,e.getScene())}}class IE extends bE{constructor(e,t){super({type:4,parameters:{mesh:e}},t)}}class ME extends bE{constructor(e,t){super({type:6,parameters:{mesh:e}},t)}}class OE extends bE{constructor(e){super({type:5,parameters:{}},e)}}class NE extends bE{constructor(e,t,i,r,n,s){super({type:7,parameters:{heightFieldSizeX:e,heightFieldSizeZ:t,numHeightFieldSamplesX:i,numHeightFieldSamplesZ:r,heightFieldData:n}},s)}}class DE extends bE{constructor(e,t){super({type:7,parameters:{groundMesh:e}},t)}}class FE{constructor(e,t,i){if(this._pluginData=void 0,!i)throw new Error("Missing scene parameter for constraint constructor.");const r=i.getPhysicsEngine();if(!r)throw new Error("No Physics Engine available.");if(2!=r.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const n=r.getPhysicsPlugin();if(!n)throw new Error("No Physics Plugin available.");this._physicsPlugin=n,this._options=t,this._type=e}get type(){return this._type}get options(){return this._options}set isEnabled(e){this._physicsPlugin.setEnabled(this,e)}get isEnabled(){return this._physicsPlugin.getEnabled(this)}set isCollisionsEnabled(e){this._physicsPlugin.setCollisionsEnabled(this,e)}get isCollisionsEnabled(){return this._physicsPlugin.getCollisionsEnabled(this)}getBodiesUsingConstraint(){return this._physicsPlugin.getBodiesUsingConstraint(this)}dispose(){this._physicsPlugin.disposeConstraint(this)}}class LE{}class wE extends FE{constructor(e,t,i){super(7,e,i),this.limits=t}setAxisFriction(e,t){this._physicsPlugin.setAxisFriction(this,e,t)}getAxisFriction(e){return this._physicsPlugin.getAxisFriction(this,e)}setAxisMode(e,t){this._physicsPlugin.setAxisMode(this,e,t)}getAxisMode(e){return this._physicsPlugin.getAxisMode(this,e)}setAxisMinLimit(e,t){this._physicsPlugin.setAxisMinLimit(this,e,t)}getAxisMinLimit(e){return this._physicsPlugin.getAxisMinLimit(this,e)}setAxisMaxLimit(e,t){this._physicsPlugin.setAxisMaxLimit(this,e,t)}getAxisMaxLimit(e){return this._physicsPlugin.getAxisMaxLimit(this,e)}setAxisMotorType(e,t){this._physicsPlugin.setAxisMotorType(this,e,t)}getAxisMotorType(e){return this._physicsPlugin.getAxisMotorType(this,e)}setAxisMotorTarget(e,t){this._physicsPlugin.setAxisMotorTarget(this,e,t)}getAxisMotorTarget(e){return this._physicsPlugin.getAxisMotorTarget(this,e)}setAxisMotorMaxForce(e,t){this._physicsPlugin.setAxisMotorMaxForce(this,e,t)}getAxisMotorMaxForce(e){return this._physicsPlugin.getAxisMotorMaxForce(this,e)}}class BE extends FE{constructor(e,t,i,r,n){super(1,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class VE extends FE{constructor(e,t){super(2,{maxDistance:e},t)}}class kE extends FE{constructor(e,t,i,r,n){super(3,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class GE extends FE{constructor(e,t,i,r,n){super(4,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class UE extends FE{constructor(e,t,i,r,n){super(5,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class zE extends FE{constructor(e,t,i,r,n){super(6,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class WE extends wE{constructor(e,t,i,r,n,s,a,o,l){super({pivotA:e,pivotB:t,axisA:i,axisB:r},[{axis:6,minLimit:n,maxLimit:s,stiffness:a,damping:o}],l)}}!function(e){e[e.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",e[e.MINIMUM=1]="MINIMUM",e[e.MAXIMUM=2]="MAXIMUM",e[e.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",e[e.MULTIPLY=4]="MULTIPLY"}(pE||(pE={}));class HE{constructor(e,t,i={mass:0},r){if(this.transformNode=e,this.type=t,this._options=i,this._scene=r,this._disposeShapeWhenDisposed=!0,!this.transformNode)return void f.V.Error("No object was provided. A physics object is obligatory");const n=e;if(this.transformNode.parent&&0!==this._options.mass&&n.hasThinInstances&&f.V.Warn("A physics body has been created for an object which has a parent and thin instances. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),!this._scene)return;this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution;const s=0===this._options.mass?0:2,a=this._options.startAsleep??!1;this.body=new CE(e,s,a,this._scene),this._addSizeOptions(),t.getClassName&&"PhysicsShape"===t.getClassName()?(this.shape=t,this._disposeShapeWhenDisposed=!1):this.shape=new bE({type:t,parameters:this._options},this._scene),this._options.isTriggerShape&&(this.shape.isTrigger=!0),this.material={friction:this._options.friction,restitution:this._options.restitution},this.body.shape=this.shape,this.shape.material=this.material,this.body.setMassProperties({mass:this._options.mass}),this._nodeDisposeObserver=this.transformNode.onDisposeObservable.add((()=>{this.dispose()}))}_getObjectBoundingBox(){return this.transformNode.getRawBoundingInfo?this.transformNode.getRawBoundingInfo().boundingBox:new pr.I(new s.Pq(-.5,-.5,-.5),new s.Pq(.5,.5,.5))}_hasVertices(e){return e?.getTotalVertices()>0}_addSizeOptions(){this.transformNode.computeWorldMatrix(!0);const e=this._getObjectBoundingBox(),t=s.AA.Vector3[0];t.copyFrom(e.extendSize),t.scaleInPlace(2),t.multiplyInPlace(this.transformNode.absoluteScaling),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z);const i=s.AA.Vector3[1];if(i.copyFrom(e.minimum),i.multiplyInPlace(this.transformNode.absoluteScaling),!this._options.center){const t=new s.Pq;t.copyFrom(e.center),t.multiplyInPlace(this.transformNode.absoluteScaling),this._options.center=t}switch(this.type){case 0:!this._options.radius&&(0,it.WithinEpsilon)(t.x,t.y,1e-4)&&(0,it.WithinEpsilon)(t.x,t.z,1e-4)?this._options.radius=t.x/2:this._options.radius||(f.V.Warn("Non uniform scaling is unsupported for sphere shapes. Setting the radius to the biggest bounding box extent."),this._options.radius=Math.max(t.x,t.y,t.z)/2);break;case 1:{const e=t.x/2;this._options.radius=this._options.radius??e,this._options.pointA=this._options.pointA??new s.Pq(0,i.y+e,0),this._options.pointB=this._options.pointB??new s.Pq(0,i.y+t.y-e,0)}break;case 2:{const e=t.x/2;this._options.radius=this._options.radius??e,this._options.pointA=this._options.pointA??new s.Pq(0,i.y,0),this._options.pointB=this._options.pointB??new s.Pq(0,i.y+t.y,0)}break;case 6:case 4:case 7:if(!this._options.mesh&&this._hasVertices(this.transformNode))this._options.mesh=this.transformNode;else if(!this._options.mesh||!this._hasVertices(this._options.mesh))throw new Error("No valid mesh was provided for mesh or convex hull shape parameter. Please provide a mesh with valid geometry (number of vertices greater than 0).");break;case 3:this._options.extents=this._options.extents??new s.Pq(t.x,t.y,t.z),this._options.rotation=this._options.rotation??s.PT.Identity()}}dispose(){this._nodeDisposeObserver&&(this.body.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this.body.dispose(),this._disposeShapeWhenDisposed&&this.shape.dispose()}}class YE{}class XE{constructor(e,t,i){this._boxConfigs=new Array,this._joints=new Array,this._bones=new Array,this._initialRotation=new Array,this._initialRotation2=new Array,this._boneNames=[],this._transforms=new Array,this._aggregates=new Array,this._ragdollMode=!1,this._rootBoneName="",this._rootBoneIndex=-1,this._mass=10,this._restitution=0,this.pauseSync=!1,this._defaultJoint=3,this._defaultJointMin=-90,this._defaultJointMax=90,this._skeleton=e,this._scene=e.getScene(),this._rootTransformNode=t,this._config=i,this._boxConfigs=[],this._putBoxesInBoneCenter=!1,this._defaultJoint=3,this._init()}getAggregate(e){return e<0||e>=this._aggregates.length?this._aggregates[this._rootBoneIndex]:this._aggregates[e]}_createColliders(){this._rootTransformNode.computeWorldMatrix(),this._skeleton.computeAbsoluteMatrices(!0),this._skeleton.prepare(!0);const e=this._config;for(let t=0;t<e.length;t++){const i=void 0!==e[t].bone?[e[t].bone]:e[t].bones;for(let r=0;r<i.length;r++){const n=this._skeleton.bones[this._skeleton.getBoneIndexByName(i[r])];if(null==n)return;const a={width:this._config[t].width,depth:this._config[t].depth,height:this._config[t].height,size:this._config[t].size};a.width=a.width??a.size,a.depth=a.depth??a.size,a.height=a.height??a.size;const o=new ui.V(i[r]+"_transform",this._scene);a.joint=void 0!==e[t].joint?e[t].joint:this._defaultJoint,a.rotationAxis=void 0!==e[t].rotationAxis?e[t].rotationAxis:ke._0.X,a.min=void 0!==e[t].min?e[t].min:this._defaultJointMin,a.max=void 0!==e[t].max?e[t].max:this._defaultJointMax;let l=0;void 0!==e[t].putBoxInBoneCenter&&e[t].putBoxInBoneCenter||this._putBoxesInBoneCenter?(void 0===n.length&&f.V.Log("The length property is not defined for bone "+n.name),l=n.length/2):void 0!==e[t].boxOffset&&(l=e[t].boxOffset),a.boxOffset=l;const c=void 0!==e[t].boneOffsetAxis?e[t].boneOffsetAxis:ke._0.Y,h=n.getDirection(c,this._rootTransformNode);a.boneOffsetAxis=c,o.position=n.getAbsolutePosition(this._rootTransformNode).add(h.scale(l));const u=void 0!==e[t].mass?e[t].mass:this._mass,d=void 0!==e[t].restitution?e[t].restitution:this._restitution,p=new HE(o,3,{mass:u,restitution:d,friction:.6,extents:new s.Pq(a.width,a.height,a.depth)},this._scene);p.body.setCollisionCallbackEnabled(!0),p.body.disablePreStep=!1,p.body.setMotionType(1),this._aggregates.push(p),this._bones.push(n),this._boneNames.push(n.name),this._transforms.push(o),this._boxConfigs.push(a),this._initialRotation.push(n.getRotationQuaternion(1,this._rootTransformNode)),this._initialRotation2.push(n.getRotationQuaternion(1))}}}_initJoints(){this._rootTransformNode.computeWorldMatrix();for(let e=0;e<this._bones.length;e++){if(e==this._rootBoneIndex)continue;const t=this._findNearestParent(e);if(null==t)return void f.V.Warn("Couldn't find a nearest parent bone in the configs for bone called "+this._boneNames[e]);const i=this._boneNames.indexOf(t.name);let r=this._bones[e].getAbsolutePosition(this._rootTransformNode).subtract(this._transforms[i].position);const n=this._transforms[i].computeWorldMatrix(),a=s.uq.Invert(n);r=s.Pq.TransformCoordinates(this._bones[e].getAbsolutePosition(this._rootTransformNode),a);const o=this._bones[e].getAbsolutePosition(this._rootTransformNode),l=this._transforms[e].position.clone(),c=o.subtract(l),h=new FE(1,{pivotA:r,pivotB:c,axisA:this._boxConfigs[e].rotationAxis,axisB:this._boxConfigs[e].rotationAxis,collision:!1},this._scene);this._aggregates[i].body.addConstraint(this._aggregates[e].body,h),h.isEnabled=!1,this._joints.push(h)}}_syncBonesToPhysics(){const e=this._rootTransformNode.getWorldMatrix();for(let t=0;t<this._bones.length;t++){const i=this._aggregates[t].transformNode,r=this._bones[t].getAbsolutePosition();s.Pq.TransformCoordinatesToRef(r,e,i.position),this._bones[t].getDirectionToRef(this._boxConfigs[t].boneOffsetAxis,this._rootTransformNode,s.AA.Vector3[0]),s.AA.Vector3[0].scaleInPlace(this._boxConfigs[t].boxOffset??0),i.position.addInPlace(s.AA.Vector3[0]),this._setBoneOrientationToBody(t)}}_setBoneOrientationToBody(e){const t=this._aggregates[e].transformNode,i=this._bones[e];this._initialRotation[e].conjugateToRef(s.AA.Quaternion[0]),i.getRotationQuaternionToRef(1,this._rootTransformNode,s.AA.Quaternion[1]),s.AA.Quaternion[1].multiplyToRef(s.AA.Quaternion[0],t.rotationQuaternion),t.rotationQuaternion.normalize()}_syncBonesAndBoxes(){if(!this.pauseSync)if(this._ragdollMode){this._setBodyOrientationToBone(this._rootBoneIndex);const e=this._aggregates[this._rootBoneIndex].body.transformNode.position;this._rootTransformNode.getWorldMatrix().invertToRef(s.AA.Matrix[0]),s.Pq.TransformCoordinatesToRef(e,s.AA.Matrix[0],s.AA.Vector3[0]),this._bones[this._rootBoneIndex].setAbsolutePosition(s.AA.Vector3[0]);for(let e=0;e<this._bones.length;e++)e!=this._rootBoneIndex&&this._setBodyOrientationToBone(e)}else this._syncBonesToPhysics()}_setBodyOrientationToBone(e){const t=this._rootTransformNode.rotationQuaternion??s.PT.FromEulerAngles(this._rootTransformNode.rotation.x,this._rootTransformNode.rotation.y,this._rootTransformNode.rotation.z),i=this._initialRotation2[e],r=this._aggregates[e].body?.transformNode?.rotationQuaternion;t.multiplyToRef(i,s.AA.Quaternion[1]),r.multiplyToRef(s.AA.Quaternion[1],s.AA.Quaternion[0]),this._bones[e].setRotationQuaternion(s.AA.Quaternion[0],1,this._rootTransformNode)}_defineRootBone(){const e=this._skeleton.getChildren();return 1!=e.length?(f.V.Log("Ragdoll creation failed: there can only be one root in the skeleton."),!1):(this._rootBoneName=e[0].name,this._rootBoneIndex=this._boneNames.indexOf(this._rootBoneName),-1!=this._rootBoneIndex||(f.V.Log("Ragdoll creation failed: the array boneNames doesn't have the root bone. The root bone is "+this._skeleton.getChildren()),!1))}_findNearestParent(e){let t=this._bones[e].getParent();do{if(null!=t&&this._boneNames.includes(t.name))break;t=t?.getParent()}while(null!=t);return t}_init(){this._createColliders(),this._defineRootBone()&&(this._initJoints(),this._scene.registerBeforeRender((()=>{this._syncBonesAndBoxes()})),this._syncBonesToPhysics())}ragdoll(){this._ragdollMode=!0,this._skeleton.bones.forEach((e=>{e.linkTransformNode(null)}));for(let e=0;e<this._joints.length;e++)this._joints[e].isEnabled=!0;for(let e=0;e<this._aggregates.length;e++)this._aggregates[e].body.setMotionType(2)}dispose(){this._aggregates.forEach((e=>{e.dispose()}))}}class qE{constructor(e,t,i){this._vertices=[],this._indices=[],this._isRightHanded=i.useRightHandedSystem,this._collectIndices=t}addNodeMeshes(e,t){e.computeWorldMatrix(!0);const i=s.AA.Matrix[0];if(s.uq.ScalingToRef(e.absoluteScaling.x,e.absoluteScaling.y,e.absoluteScaling.z,i),e instanceof Rt.e?this._addMesh(e,i):e instanceof O_.Z&&this._addMesh(e.sourceMesh,i),t){const t=s.AA.Matrix[1];e.computeWorldMatrix().invertToRef(t);const r=s.AA.Matrix[2];t.multiplyToRef(i,r),e.getChildMeshes(!1).filter((e=>!e.physicsBody)).forEach((e=>{const t=e.computeWorldMatrix(),i=s.AA.Matrix[3];t.multiplyToRef(r,i),e instanceof Rt.e?this._addMesh(e,i):e instanceof O_.Z&&this._addMesh(e.sourceMesh,i)}))}}_addMesh(e,t){const i=e.getVerticesData(Ue.R.PositionKind)||[],r=i.length/3,n=this._vertices.length;for(let e=0;e<r;e++){const r=new s.Pq(i[3*e+0],i[3*e+1],i[3*e+2]);this._vertices.push(s.Pq.TransformCoordinates(r,t))}if(this._collectIndices){const t=e.getIndices();if(t)for(let e=0;e<t.length;e+=3)this._isRightHanded?(this._indices.push(t[e+0]+n),this._indices.push(t[e+1]+n),this._indices.push(t[e+2]+n)):(this._indices.push(t[e+2]+n),this._indices.push(t[e+1]+n),this._indices.push(t[e+0]+n))}}getVertices(e){const t=3*this._vertices.length,i=4*t,r=e._malloc(i),n=new Float32Array(e.HEAPU8.buffer,r,t);for(let e=0;e<this._vertices.length;e++)n[3*e+0]=this._vertices[e].x,n[3*e+1]=this._vertices[e].y,n[3*e+2]=this._vertices[e].z;return{offset:r,numObjects:t}}freeBuffer(e,t){e._free(t.offset)}getTriangles(e){const t=4*this._indices.length,i=e._malloc(t),r=new Int32Array(e.HEAPU8.buffer,i,this._indices.length);for(let e=0;e<this._indices.length;e++)r[e]=this._indices[e];return{offset:i,numObjects:this._indices.length}}}class $E{constructor(e){this.hpBodyId=e,this.userMassProps={centerOfMass:void 0,mass:void 0,inertia:void 0,inertiaOrientation:void 0}}}class jE{constructor(){this.bodyId=BigInt(0),this.position=new s.Pq,this.normal=new s.Pq}}class KE{constructor(){this.contactOnA=new jE,this.contactOnB=new jE,this.impulseApplied=0,this.type=0}static readToRef(e,t,i){const r=new Int32Array(e,t),n=new Float32Array(e,t);i.contactOnA.bodyId=BigInt(r[2]),i.contactOnA.position.set(n[10],n[11],n[12]),i.contactOnA.normal.set(n[13],n[14],n[15]),i.contactOnB.bodyId=BigInt(r[18]),i.contactOnB.position.set(n[26],n[27],n[28]),i.contactOnB.normal.set(n[29],n[30],n[31]),i.impulseApplied=n[34],i.type=r[0]}}class ZE{constructor(){this.bodyIdA=BigInt(0),this.bodyIdB=BigInt(0),this.type=0}static readToRef(e,t,i){const r=new Int32Array(e,t);i.type=r[0],i.bodyIdA=BigInt(r[2]),i.bodyIdB=BigInt(r[6])}}class QE{constructor(e=!0,t=HK){this._useDeltaForWorldStep=e,this._hknp={},this.name="HavokPlugin",this._fixedTimeStep=1/60,this._tmpVec3=(0,Ve.mI)(3,s.Pq.Zero),this._bodies=new Map,this._shapes=new Map,this._bodyCollisionObservable=new Map,this._constraintToBodyIdPair=new Map,this._bodyCollisionEndedObservable=new Map,this.onCollisionObservable=new n.cP,this.onCollisionEndedObservable=new n.cP,this.onTriggerCollisionObservable=new n.cP,"function"!=typeof t?(this._hknp=t,this.isSupported()?(this.world=this._hknp.HP_World_Create()[1],this._queryCollector=this._hknp.HP_QueryCollector_Create(1)[1]):f.V.Error("Havok is not available. Please make sure you included the js file.")):f.V.Error("Havok is not ready. Please make sure you await HK() before using the plugin.")}isSupported(){return void 0!==this._hknp}setGravity(e){this._hknp.HP_World_SetGravity(this.world,this._bVecToV3(e))}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){for(const e of t)e.disablePreStep||this.setPhysicsBodyTransformation(e,e.transformNode);const i=this._useDeltaForWorldStep?e:this._fixedTimeStep;this._hknp.HP_World_SetIdealStepTime(this.world,i),this._hknp.HP_World_Step(this.world,i),this._bodyBuffer=this._hknp.HP_World_GetBodyBuffer(this.world)[1];for(const e of t)e.disableSync||this.sync(e);this._notifyCollisions(),this._notifyTriggers()}getPluginVersion(){return 2}setVelocityLimits(e,t){this._hknp.HP_World_SetSpeedLimit(this.world,e,t)}getMaxLinearVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[1]}getMaxAngularVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[2]}initBody(e,t,i,r){e._pluginData=new $E(this._hknp.HP_Body_Create()[1]),this._internalSetMotionType(e._pluginData,t);const n=[this._bVecToV3(i),this._bQuatToV4(r)];this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,n),this._hknp.HP_World_AddBody(this.world,e._pluginData.hpBodyId,e.startAsleep),this._bodies.set(e._pluginData.hpBodyId[0],{body:e,index:0})}removeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._bodyCollisionObservable.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._bodies.delete(t.hpBodyId[0]);e._pluginData&&(this._bodyCollisionObservable.delete(e._pluginData.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,e._pluginData.hpBodyId),this._bodies.delete(e._pluginData.hpBodyId[0]))}initBodyInstances(e,t,i){const r=i._thinInstanceDataStorage?.instancesCount??0,n=i._thinInstanceDataStorage.matrixData;n&&(this._createOrUpdateBodyInstances(e,t,n,0,r,!1),e._pluginDataInstances.forEach(((t,i)=>{this._bodies.set(t.hpBodyId[0],{body:e,index:i})})))}_createOrUpdateBodyInstances(e,t,i,r,n,a){const o=s.AA.Quaternion[0],l=s.uq.Identity();for(let c=r;c<n;c++){const r=[i[16*c+12],i[16*c+13],i[16*c+14]];let n;n=a?e._pluginDataInstances[c].hpBodyId:this._hknp.HP_Body_Create()[1],l.setRowFromFloats(0,i[16*c+0],i[16*c+1],i[16*c+2],0),l.setRowFromFloats(1,i[16*c+4],i[16*c+5],i[16*c+6],0),l.setRowFromFloats(2,i[16*c+8],i[16*c+9],i[16*c+10],0),s.PT.FromRotationMatrixToRef(l,o);const h=[r,[o.x,o.y,o.z,o.w]];if(this._hknp.HP_Body_SetQTransform(n,h),!a){const i=new $E(n);e._pluginDataInstances.length&&(i.userMassProps=e._pluginDataInstances[0].userMassProps),this._internalSetMotionType(i,t),this._internalUpdateMassProperties(i),e._pluginDataInstances.push(i),this._hknp.HP_World_AddBody(this.world,n,e.startAsleep),i.worldTransformOffset=this._hknp.HP_Body_GetWorldTransformOffset(n)[1]}}}updateBodyInstances(e,t){const i=t._thinInstanceDataStorage?.instancesCount??0,r=t._thinInstanceDataStorage.matrixData;if(!r)return;const n=e._pluginDataInstances.length,s=this.getMotionType(e);if(i>n){this._createOrUpdateBodyInstances(e,s,r,n,i,!1);const t=this._hknp.HP_Body_GetShape(e._pluginDataInstances[0].hpBodyId)[1];t[0]||(t[0]=e.shape?._pluginData[0]);for(let r=n;r<i;r++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[r].hpBodyId,t),this._internalUpdateMassProperties(e._pluginDataInstances[r]),this._bodies.set(e._pluginDataInstances[r].hpBodyId[0],{body:e,index:r})}else if(i<n){const t=n-i;for(let i=0;i<t;i++){const t=e._pluginDataInstances.pop();this._bodies.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._hknp.HP_Body_Release(t.hpBodyId)}this._createOrUpdateBodyInstances(e,s,r,0,i,!0)}}sync(e){this.syncTransform(e,e.transformNode)}syncTransform(e,t){if(e._pluginDataInstances.length){const i=t,r=i._thinInstanceDataStorage.matrixData;if(!r)return;const n=e._pluginDataInstances.length;for(let t=0;t<n;t++){const i=e._pluginDataInstances[t].worldTransformOffset,n=new Float32Array(this._hknp.HEAPU8.buffer,this._bodyBuffer+i,16),s=16*t;for(let e=0;e<15;e++)3&~e&&(r[s+e]=n[e]);r[s+15]=1}i.thinInstanceBufferUpdated("matrix")}else try{const i=this._hknp.HP_Body_GetQTransform(e._pluginData.hpBodyId)[1],r=i[0],n=i[1],a=s.AA.Quaternion[0];a.set(n[0],n[1],n[2],n[3]);const o=t.parent;if(o&&!o.getWorldMatrix().isIdentity()){o.computeWorldMatrix(!0),s.AA.Vector3[1].copyFrom(t.scaling),a.normalize();const e=s.AA.Matrix[0],i=s.AA.Vector3[0];i.copyFromFloats(r[0],r[1],r[2]),s.uq.ComposeToRef(t.absoluteScaling,a,i,e);const n=s.AA.Matrix[1];o.getWorldMatrix().invertToRef(n);const l=s.AA.Matrix[2];e.multiplyToRef(n,l),l.decomposeToTransformNode(t),t.rotationQuaternion?.normalize(),t.scaling.copyFrom(s.AA.Vector3[1])}else t.position.set(r[0],r[1],r[2]),t.rotationQuaternion?t.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(t.rotation)}catch(e){f.V.Error(`Syncing transform failed for node ${t.name}: ${e.message}...`)}}setShape(e,t){const i=t&&t._pluginData?t._pluginData:BigInt(0);if(!(e.transformNode instanceof Rt.e&&e.transformNode._thinInstanceDataStorage?.matrixData))return this._hknp.HP_Body_SetShape(e._pluginData.hpBodyId,i),void this._internalUpdateMassProperties(e._pluginData);const r=e.transformNode,n=r._thinInstanceDataStorage?.instancesCount??0;for(let t=0;t<n;t++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[t].hpBodyId,i),this._internalUpdateMassProperties(e._pluginDataInstances[t])}_getPluginReference(e,t){return e._pluginDataInstances?.length?e._pluginDataInstances[t??0]:e._pluginData}getShape(e){const t=this._getPluginReference(e),i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1];if(0!=i){const t=e.transformNode.getScene();return new bE({pluginData:i},t)}return null}getShapeType(e){return e.type?e.type:this._hknp.HP_Shape_GetType(e._pluginData)}setEventMask(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t)}),i)}getEventMask(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1]}_fromMassPropertiesTuple(e){return{centerOfMass:s.Pq.FromArray(e[0]),mass:e[1],inertia:s.Pq.FromArray(e[2]),inertiaOrientation:s.PT.FromArray(e[3])}}_internalUpdateMassProperties(e){const t=this._internalComputeMassProperties(e),i=e.userMassProps;i.centerOfMass&&(t[0]=i.centerOfMass.asArray()),null!=i.mass&&(t[1]=i.mass),i.inertia&&(t[2]=i.inertia.asArray()),i.inertiaOrientation&&(t[3]=i.inertiaOrientation.asArray()),this._hknp.HP_Body_SetMassProperties(e.hpBodyId,t)}_internalSetMotionType(e,t){switch(t){case 0:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.STATIC);break;case 1:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.KINEMATIC);break;case 2:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.DYNAMIC)}}setMotionType(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._internalSetMotionType(e,t)}),i)}getMotionType(e,t){const i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMotionType(i.hpBodyId)[1];switch(r){case this._hknp.MotionType.STATIC:return 0;case this._hknp.MotionType.KINEMATIC:return 1;case this._hknp.MotionType.DYNAMIC:return 2}throw new Error("Unknown motion type: "+r)}setActivationControl(e,t){switch(t){case 1:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_ACTIVE);break;case 2:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_INACTIVE);break;case 0:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.SIMULATION_CONTROLLED)}}_internalComputeMassProperties(e){const t=this._hknp.HP_Body_GetShape(e.hpBodyId);if(t[0]==this._hknp.Result.RESULT_OK){const e=this._hknp.HP_Shape_BuildMassProperties(t[1]);if(e[0]==this._hknp.Result.RESULT_OK)return e[1]}return[[0,0,0],1,[1,1,1],[0,0,0,1]]}computeMassProperties(e,t){const i=this._getPluginReference(e,t),r=this._internalComputeMassProperties(i);return this._fromMassPropertiesTuple(r)}setMassProperties(e,t,i){this._applyToBodyOrInstances(e,(e=>{e.userMassProps=t,this._internalUpdateMassProperties(e)}),i)}getMassProperties(e,t){const i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMassProperties(i.hpBodyId)[1];return this._fromMassPropertiesTuple(r)}setLinearDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearDamping(e.hpBodyId,t)}),i)}getLinearDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetLinearDamping(i.hpBodyId)[1]}setAngularDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularDamping(e.hpBodyId,t)}),i)}getAngularDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetAngularDamping(i.hpBodyId)[1]}setLinearVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getLinearVelocityToRef(e,t,i){const r=this._getPluginReference(e,i),n=this._hknp.HP_Body_GetLinearVelocity(r.hpBodyId)[1];this._v3ToBvecRef(n,t)}_applyToBodyOrInstances(e,t,i){if(e._pluginDataInstances?.length>0&&void 0===i)for(let i=0;i<e._pluginDataInstances.length;i++)t(e._pluginDataInstances[i]);else t(this._getPluginReference(e,i))}applyImpulse(e,t,i,r){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyImpulse(e.hpBodyId,this._bVecToV3(i),this._bVecToV3(t))}),r)}applyAngularImpulse(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyAngularImpulse(e.hpBodyId,this._bVecToV3(t))}),i)}applyForce(e,t,i,r){t.scaleToRef(this.getTimeStep(),this._tmpVec3[0]),this.applyImpulse(e,this._tmpVec3[0],i,r)}setAngularVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getAngularVelocityToRef(e,t,i){const r=this._getPluginReference(e,i),n=this._hknp.HP_Body_GetAngularVelocity(r.hpBodyId)[1];this._v3ToBvecRef(n,t)}setPhysicsBodyTransformation(e,t){if(e.getPrestepType()==uE.TELEPORT){const i=e.transformNode;if(e.numInstances>0){const t=i._thinInstanceDataStorage.matrixData;if(!t)return;const r=e.numInstances;this._createOrUpdateBodyInstances(e,e.getMotionType(),t,0,r,!0)}else this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,this._getTransformInfos(t))}else e.getPrestepType()==uE.ACTION?this.setTargetTransform(e,t.absolutePosition,t.absoluteRotationQuaternion):e.getPrestepType()==uE.DISABLED?f.V.Warn("Prestep type is set to DISABLED. Unable to set physics body transformation."):f.V.Warn("Invalid prestep type set to physics body.")}setTargetTransform(e,t,i,r){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetTargetQTransform(e.hpBodyId,[this._bVecToV3(t),this._bQuatToV4(i)])}),r)}setGravityFactor(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetGravityFactor(e.hpBodyId,t)}),i)}getGravityFactor(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetGravityFactor(i.hpBodyId)[1]}disposeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._hknp.HP_Body_Release(t.hpBodyId),t.hpBodyId=void 0;e._pluginData&&(this._hknp.HP_Body_Release(e._pluginData.hpBodyId),e._pluginData.hpBodyId=void 0)}_createOptionsFromGroundMesh(e){const t=e.groundMesh;if(!t)return;let i=t.getVerticesData(Ue.R.PositionKind);const r=t.computeWorldMatrix(!0),n=[];let a;for(a=0;a<i.length;a+=3)s.Pq.FromArrayToRef(i,a,s.AA.Vector3[0]),s.Pq.TransformCoordinatesToRef(s.AA.Vector3[0],r,s.AA.Vector3[1]),s.AA.Vector3[1].toArray(n,a);i=n;const o=~~(Math.sqrt(i.length/3)-1),l=t.getBoundingInfo(),c=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.z),h=l.boundingBox.minimumWorld.x,u=l.boundingBox.minimumWorld.y,d=l.boundingBox.minimumWorld.z,p=new Float32Array((o+1)*(o+1)),f=2*c/o;for(let e=0;e<p.length;e++)p[e]=u;for(let e=0;e<i.length;e+=3){const t=Math.round((i[e+0]-h)/f),r=o-Math.round((i[e+2]-d)/f),n=i[e+1]-u;p[r*(o+1)+t]=n}e.numHeightFieldSamplesX=o+1,e.numHeightFieldSamplesZ=o+1,e.heightFieldSizeX=2*l.boundingBox.extendSizeWorld.x,e.heightFieldSizeZ=2*l.boundingBox.extendSizeWorld.z,e.heightFieldData=p}initShape(e,t,i){switch(t){case 0:{const t=i.radius||1,r=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateSphere(r,t)[1]}break;case 3:{const t=i.rotation?this._bQuatToV4(i.rotation):[0,0,0,1],r=i.extents?this._bVecToV3(i.extents):[1,1,1],n=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateBox(n,t,r)[1]}break;case 1:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],r=i.pointB?this._bVecToV3(i.pointB):[0,1,0],n=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCapsule(t,r,n)[1]}break;case 5:e._pluginData=this._hknp.HP_Shape_CreateContainer()[1];break;case 2:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],r=i.pointB?this._bVecToV3(i.pointB):[0,1,0],n=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCylinder(t,r,n)[1]}break;case 4:case 6:{const r=i.mesh;if(!r)throw new Error("No mesh provided to create physics shape.");{const n=!!i.includeChildMeshes,s=new qE(r,4!=t,r?.getScene());s.addNodeMeshes(r,n);const a=s.getVertices(this._hknp),o=a.numObjects/3;if(4==t)e._pluginData=this._hknp.HP_Shape_CreateConvexHull(a.offset,o)[1];else{const t=s.getTriangles(this._hknp),i=t.numObjects/3;e._pluginData=this._hknp.HP_Shape_CreateMesh(a.offset,o,t.offset,i)[1],s.freeBuffer(this._hknp,t)}s.freeBuffer(this._hknp,a)}}break;case 7:if(i.groundMesh&&this._createOptionsFromGroundMesh(i),!(i.numHeightFieldSamplesX&&i.numHeightFieldSamplesZ&&i.heightFieldSizeX&&i.heightFieldSizeZ&&i.heightFieldData))throw new Error("Missing required heightfield parameters");{const t=i.numHeightFieldSamplesX*i.numHeightFieldSamplesZ,r=4*t,n=this._hknp._malloc(r),s=new Float32Array(this._hknp.HEAPU8.buffer,n,t);for(let e=0;e<i.numHeightFieldSamplesX;e++)for(let t=0;t<i.numHeightFieldSamplesZ;t++){const r=t*i.numHeightFieldSamplesX+e,n=(i.numHeightFieldSamplesX-1-e)*i.numHeightFieldSamplesZ+t;s[r]=i.heightFieldData[n]}const a=i.heightFieldSizeX/(i.numHeightFieldSamplesX-1),o=i.heightFieldSizeZ/(i.numHeightFieldSamplesZ-1);e._pluginData=this._hknp.HP_Shape_CreateHeightField(i.numHeightFieldSamplesX,i.numHeightFieldSamplesZ,[a,1,o],n)[1],this._hknp._free(n)}break;default:throw new Error("Unsupported Shape Type.")}this._shapes.set(e._pluginData[0],e)}setShapeFilterMembershipMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[t,i])}getShapeFilterMembershipMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0]}setShapeFilterCollideMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[i,t])}getShapeFilterCollideMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1]}setMaterial(e,t){const i=t.friction??.5,r=t.staticFriction??i,n=t.restitution??0,s=t.frictionCombine??1,a=t.restitutionCombine??2,o=[r,i,n,this._materialCombineToNative(s),this._materialCombineToNative(a)];this._hknp.HP_Shape_SetMaterial(e._pluginData,o)}getMaterial(e){const t=this._hknp.HP_Shape_GetMaterial(e._pluginData)[1];return{staticFriction:t[0],friction:t[1],restitution:t[2],frictionCombine:this._nativeToMaterialCombine(t[3]),restitutionCombine:this._nativeToMaterialCombine(t[4])}}setDensity(e,t){this._hknp.HP_Shape_SetDensity(e._pluginData,t)}getDensity(e){return this._hknp.HP_Shape_GetDensity(e._pluginData)[1]}_getTransformInfos(e){if(e.parent)return e.computeWorldMatrix(!0),[this._bVecToV3(e.absolutePosition),this._bQuatToV4(e.absoluteRotationQuaternion)];let t=s.AA.Quaternion[0];if(e.rotationQuaternion)t=e.rotationQuaternion;else{const i=e.rotation;s.PT.FromEulerAnglesToRef(i.x,i.y,i.z,t)}return[this._bVecToV3(e.position),this._bQuatToV4(t)]}addChild(e,t,i,r,n){const s=[i?this._bVecToV3(i):[0,0,0],r?this._bQuatToV4(r):[0,0,0,1],n?this._bVecToV3(n):[1,1,1]];this._hknp.HP_Shape_AddChild(e._pluginData,t._pluginData,s)}removeChild(e,t){this._hknp.HP_Shape_RemoveChild(e._pluginData,t)}getNumChildren(e){return this._hknp.HP_Shape_GetNumChildren(e._pluginData)[1]}setTrigger(e,t){this._hknp.HP_Shape_SetTrigger(e._pluginData,t)}getBoundingBox(e){const t=this._hknp.HP_Shape_GetBoundingBox(e._pluginData,[[0,0,0],[0,0,0,1]])[1];return s.AA.Vector3[0].set(t[0][0],t[0][1],t[0][2]),s.AA.Vector3[1].set(t[1][0],t[1][1],t[1][2]),new pr.I(s.AA.Vector3[0],s.AA.Vector3[1],s.uq.IdentityReadOnly)}getBodyBoundingBox(e){const t=this.getBoundingBox(e.shape);return new pr.I(t.minimum,t.maximum,e.transformNode.getWorldMatrix())}getBodyGeometry(e){const t=e._pluginDataInstances?.length>0?e._pluginDataInstances[0]:e._pluginData,i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1],r=this._hknp.HP_Shape_CreateDebugDisplayGeometry(i);if(r[0]!=this._hknp.Result.RESULT_OK)return{positions:[],indices:[]};const n=this._hknp.HP_DebugGeometry_GetInfo(r[1])[1],s=new Float32Array(this._hknp.HEAPU8.buffer,n[0],3*n[1]),a=new Uint32Array(this._hknp.HEAPU8.buffer,n[2],3*n[3]),o=s.slice(0),l=a.slice(0);return this._hknp.HP_DebugGeometry_Release(r[1]),{positions:o,indices:l}}disposeShape(e){this._hknp.HP_Shape_Release(e._pluginData),e._pluginData=void 0}initConstraint(e,t,i,r,n){const a=e.type,o=e.options;if(!a||!o)return void f.V.Warn("No constraint type or options. Constraint is invalid.");if(t._pluginDataInstances.length>0&&void 0===r||i._pluginDataInstances.length>0&&void 0===n)return void f.V.Warn("Body is instanced but no instance index was specified. Constraint will not be applied.");e._pluginData=e._pluginData??[];const l=this._hknp.HP_Constraint_Create()[1];e._pluginData.push(l);const c=this._getPluginReference(t,r).hpBodyId,h=this._getPluginReference(i,n).hpBodyId;this._hknp.HP_Constraint_SetParentBody(l,c),this._hknp.HP_Constraint_SetChildBody(l,h),this._constraintToBodyIdPair.set(l[0],[c[0],h[0]]);const u=o.pivotA?this._bVecToV3(o.pivotA):this._bVecToV3(s.Pq.Zero()),d=o.axisA??new s.Pq(1,0,0),p=this._tmpVec3[0];o.perpAxisA?p.copyFrom(o.perpAxisA):d.getNormalToRef(p),this._hknp.HP_Constraint_SetAnchorInParent(l,u,this._bVecToV3(d),this._bVecToV3(p));const m=o.pivotB?this._bVecToV3(o.pivotB):this._bVecToV3(s.Pq.Zero()),_=o.axisB??new s.Pq(1,0,0),g=this._tmpVec3[0];if(o.perpAxisB?g.copyFrom(o.perpAxisB):_.getNormalToRef(g),this._hknp.HP_Constraint_SetAnchorInChild(l,m,this._bVecToV3(_),this._bVecToV3(g)),e._initOptions||(e._initOptions={axisA:d.clone(),axisB:_.clone(),perpAxisA:p.clone(),perpAxisB:g.clone(),pivotA:new s.Pq(u[0],u[1],u[2]),pivotB:new s.Pq(m[0],m[1],m[2])}),5==a)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(2==a){const e=o.maxDistance||0,t=this._hknp.ConstraintAxis.LINEAR_DISTANCE;this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(l,t,e),this._hknp.HP_Constraint_SetAxisMaxLimit(l,t,e)}else if(3==a)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(6==a)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(4==a)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(1==a)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else{if(7!=a)throw new Error("Unsupported Constraint Type.");{const t=e;for(const e of t.limits){const t=this._constraintAxisToNative(e.axis);0==(e.minLimit??-1)&&0==(e.maxLimit??-1)?this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LOCKED):(null!=e.minLimit&&(this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(l,t,e.minLimit)),null!=e.maxLimit&&(this._hknp.HP_Constraint_SetAxisMode(l,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMaxLimit(l,t,e.maxLimit))),e.stiffness&&this._hknp.HP_Constraint_SetAxisStiffness(l,t,e.stiffness),e.damping&&this._hknp.HP_Constraint_SetAxisDamping(l,t,e.damping)}}}const v=!!o.collision;this._hknp.HP_Constraint_SetCollisionsEnabled(l,v),this._hknp.HP_Constraint_SetEnabled(l,!0)}getBodiesUsingConstraint(e){const t=[];for(const i of e._pluginData){const e=this._constraintToBodyIdPair.get(i[0]);if(e){const i=this._bodies.get(e[0]),r=this._bodies.get(e[1]);i&&r&&t.push({parentBody:i.body,parentBodyIndex:i.index,childBody:r.body,childBodyIndex:r.index})}}return t}addConstraint(e,t,i,r,n){this.initConstraint(i,e,t,r,n)}setEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetEnabled(i,t)}getEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetEnabled(t)[1]}setCollisionsEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetCollisionsEnabled(i,t)}getCollisionsEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetCollisionsEnabled(t)[1]}setAxisFriction(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisFriction(r,this._constraintAxisToNative(t),i)}getAxisFriction(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisFriction(i,this._constraintAxisToNative(t))[1]:null}setAxisMode(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMode(r,this._constraintAxisToNative(t),this._limitModeToNative(i))}getAxisMode(e,t){const i=e._pluginData&&e._pluginData[0];if(i){const e=this._hknp.HP_Constraint_GetAxisMode(i,this._constraintAxisToNative(t))[1];return this._nativeToLimitMode(e)}return null}setAxisMinLimit(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMinLimit(r,this._constraintAxisToNative(t),i)}getAxisMinLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMinLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMaxLimit(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMaxLimit(r,this._constraintAxisToNative(t),i)}getAxisMaxLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMaxLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMotorType(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorType(r,this._constraintAxisToNative(t),this._constraintMotorTypeToNative(i))}getAxisMotorType(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._nativeToMotorType(this._hknp.HP_Constraint_GetAxisMotorType(i,this._constraintAxisToNative(t))[1]):null}setAxisMotorTarget(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorTarget(r,this._constraintAxisToNative(t),i)}getAxisMotorTarget(e,t){return e._pluginData&&e._pluginData[0]?this._hknp.HP_Constraint_GetAxisMotorTarget(e._pluginData,this._constraintAxisToNative(t))[1]:null}setAxisMotorMaxForce(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorMaxForce(r,this._constraintAxisToNative(t),i)}getAxisMotorMaxForce(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMotorMaxForce(i,this._constraintAxisToNative(t))[1]:null}disposeConstraint(e){for(const t of e._pluginData)this._hknp.HP_Constraint_SetEnabled(t,!1),this._hknp.HP_Constraint_Release(t);e._pluginData.length=0}_populateHitData(e,t){const i=this._bodies.get(e[0][0]);t.body=i?.body,t.bodyIndex=i?.index;const r=this._shapes.get(e[1][0]);t.shape=r;const n=e[3],s=e[4],a=e[5];t.setHitData({x:s[0],y:s[1],z:s[2]},{x:n[0],y:n[1],z:n[2]},a)}raycast(e,t,i,r){const n=r?.membership??-1,s=r?.collideWith??-1,a=r?.shouldHitTriggers??!1;i.reset(e,t);const o=[BigInt(0)],l=[this._bVecToV3(e),this._bVecToV3(t),[n,s],a,o];if(this._hknp.HP_World_CastRayWithCollector(this.world,this._queryCollector,l),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[,e]=this._hknp.HP_QueryCollector_GetCastRayResult(this._queryCollector,0)[1];this._populateHitData(e,i),i.calculateHitDistance()}}pointProximity(e,t){const i=e?.collisionFilter?.membership??-1,r=e?.collisionFilter?.collideWith??-1;t.reset();const n=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],s=[this._bVecToV3(e.position),e.maxDistance,[i,r],e.shouldHitTriggers,n];if(this._hknp.HP_World_PointProximityWithCollector(this.world,this._queryCollector,s),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,i]=this._hknp.HP_QueryCollector_GetPointProximityResult(this._queryCollector,0)[1];this._populateHitData(i,t),t.setHitDistance(e)}}shapeProximity(e,t,i){t.reset(),i.reset();const r=e.shape._pluginData,n=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],s=[r,this._bVecToV3(e.position),this._bQuatToV4(e.rotation),e.maxDistance,e.shouldHitTriggers,n];if(this._hknp.HP_World_ShapeProximityWithCollector(this.world,this._queryCollector,s),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,r,n]=this._hknp.HP_QueryCollector_GetShapeProximityResult(this._queryCollector,0)[1];this._populateHitData(r,t),this._populateHitData(n,i),t.setHitDistance(e),i.setHitDistance(e)}}shapeCast(e,t,i){t.reset(),i.reset();const r=e.shape._pluginData,n=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],s=[r,this._bQuatToV4(e.rotation),this._bVecToV3(e.startPosition),this._bVecToV3(e.endPosition),e.shouldHitTriggers,n];if(this._hknp.HP_World_ShapeCastWithCollector(this.world,this._queryCollector,s),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,r,n]=this._hknp.HP_QueryCollector_GetShapeCastResult(this._queryCollector,0)[1];this._populateHitData(r,t),this._populateHitData(n,i),t.setHitFraction(e),i.setHitFraction(e)}}getCollisionObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionObservable.get(t);return i||(i=new n.cP,this._bodyCollisionObservable.set(t,i)),i}getCollisionEndedObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionEndedObservable.get(t);return i||(i=new n.cP,this._bodyCollisionEndedObservable.set(t,i)),i}setCollisionCallbackEnabled(e,t){const i=this._hknp.EventType.COLLISION_STARTED.value|this._hknp.EventType.COLLISION_CONTINUED.value|this._hknp.EventType.COLLISION_FINISHED.value;e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t?i:0)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,t?i:0)}setCollisionEndedCallbackEnabled(e,t){const i=this._getPluginReference(e);let r=this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1];r=t?r|this._hknp.EventType.COLLISION_FINISHED.value:r&~this._hknp.EventType.COLLISION_FINISHED.value,e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,r)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,r)}_notifyTriggers(){let e=this._hknp.HP_World_GetTriggerEvents(this.world)[1];const t=new ZE;for(;e;){ZE.readToRef(this._hknp.HEAPU8.buffer,e,t);const i=this._bodies.get(t.bodyIdA),r=this._bodies.get(t.bodyIdB);if(i&&r){const e={collider:i.body,colliderIndex:i.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,type:this._nativeTriggerCollisionValueToCollisionType(t.type)};this.onTriggerCollisionObservable.notifyObservers(e)}e=this._hknp.HP_World_GetNextTriggerEvent(this.world,e)}}_notifyCollisions(){let e=this._hknp.HP_World_GetCollisionEvents(this.world)[1];const t=new KE,i=Number(this.world);for(;e;){KE.readToRef(this._hknp.HEAPU8.buffer,e,t);const r=this._bodies.get(t.contactOnA.bodyId),n=this._bodies.get(t.contactOnB.bodyId);if(r&&n){const e={collider:r.body,colliderIndex:r.index,collidedAgainst:n.body,collidedAgainstIndex:n.index,type:this._nativeCollisionValueToCollisionType(t.type)};if("COLLISION_FINISHED"===e.type)this.onCollisionEndedObservable.notifyObservers(e);else{t.contactOnB.position.subtractToRef(t.contactOnA.position,this._tmpVec3[0]);const i=s.Pq.Dot(this._tmpVec3[0],t.contactOnA.normal);e.point=t.contactOnA.position,e.distance=i,e.impulse=t.impulseApplied,e.normal=t.contactOnA.normal,this.onCollisionObservable.notifyObservers(e)}if(this._bodyCollisionObservable.size&&"COLLISION_FINISHED"!==e.type){const i=this._bodyCollisionObservable.get(t.contactOnA.bodyId),a=this._bodyCollisionObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const o=s.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),a){const e={collider:n.body,colliderIndex:n.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,point:t.contactOnB.position,distance:o,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};a.notifyObservers(e)}}else if(this._bodyCollisionEndedObservable.size){const i=this._bodyCollisionEndedObservable.get(t.contactOnA.bodyId),a=this._bodyCollisionEndedObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const o=s.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),a){const e={collider:n.body,colliderIndex:n.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,point:t.contactOnB.position,distance:o,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};a.notifyObservers(e)}}}e=this._hknp.HP_World_GetNextCollisionEvent(i,e)}}get numBodies(){return this._hknp.HP_World_GetNumBodies(this.world)[1]}dispose(){this._queryCollector&&(this._hknp.HP_QueryCollector_Release(this._queryCollector),this._queryCollector=void 0),this.world&&(this._hknp.HP_World_Release(this.world),this.world=void 0)}_v3ToBvecRef(e,t){t.set(e[0],e[1],e[2])}_bVecToV3(e){return[e._x,e._y,e._z]}_bQuatToV4(e){return[e._x,e._y,e._z,e._w]}_constraintMotorTypeToNative(e){switch(e){case 2:return this._hknp.ConstraintMotorType.POSITION;case 1:return this._hknp.ConstraintMotorType.VELOCITY}return this._hknp.ConstraintMotorType.NONE}_nativeToMotorType(e){switch(e){case this._hknp.ConstraintMotorType.POSITION:return 2;case this._hknp.ConstraintMotorType.VELOCITY:return 1}return 0}_materialCombineToNative(e){switch(e){case 0:return this._hknp.MaterialCombine.GEOMETRIC_MEAN;case 1:return this._hknp.MaterialCombine.MINIMUM;case 2:return this._hknp.MaterialCombine.MAXIMUM;case 3:return this._hknp.MaterialCombine.ARITHMETIC_MEAN;case 4:return this._hknp.MaterialCombine.MULTIPLY}}_nativeToMaterialCombine(e){switch(e){case this._hknp.MaterialCombine.GEOMETRIC_MEAN:return 0;case this._hknp.MaterialCombine.MINIMUM:return 1;case this._hknp.MaterialCombine.MAXIMUM:return 2;case this._hknp.MaterialCombine.ARITHMETIC_MEAN:return 3;case this._hknp.MaterialCombine.MULTIPLY:return 4;default:return}}_constraintAxisToNative(e){switch(e){case 0:return this._hknp.ConstraintAxis.LINEAR_X;case 1:return this._hknp.ConstraintAxis.LINEAR_Y;case 2:return this._hknp.ConstraintAxis.LINEAR_Z;case 3:return this._hknp.ConstraintAxis.ANGULAR_X;case 4:return this._hknp.ConstraintAxis.ANGULAR_Y;case 5:return this._hknp.ConstraintAxis.ANGULAR_Z;case 6:return this._hknp.ConstraintAxis.LINEAR_DISTANCE}}_nativeToLimitMode(e){switch(e){case this._hknp.ConstraintAxisLimitMode.FREE:return 0;case this._hknp.ConstraintAxisLimitMode.LIMITED:return 1;case this._hknp.ConstraintAxisLimitMode.LOCKED:return 2}return 0}_limitModeToNative(e){switch(e){case 0:return this._hknp.ConstraintAxisLimitMode.FREE;case 1:return this._hknp.ConstraintAxisLimitMode.LIMITED;case 2:return this._hknp.ConstraintAxisLimitMode.LOCKED}}_nativeCollisionValueToCollisionType(e){switch(e){case this._hknp.EventType.COLLISION_STARTED.value:return"COLLISION_STARTED";case this._hknp.EventType.COLLISION_FINISHED.value:return"COLLISION_FINISHED";case this._hknp.EventType.COLLISION_CONTINUED.value:return"COLLISION_CONTINUED"}return"COLLISION_STARTED"}_nativeTriggerCollisionValueToCollisionType(e){switch(e){case 8:return"TRIGGER_ENTERED";case 16:return"TRIGGER_EXITED"}return"TRIGGER_ENTERED"}}i(51446);class JE{static GetContactPointToRef(e,t,i,r,n){const s=e.getScene().getPhysicsEngine(),a=s?.getPluginVersion();if(1===a){const n=new Ii.Rl(t,i).intersectsMesh(e);if(n.hit&&n.pickedPoint)return r.copyFrom(n.pickedPoint),!0}else if(2===a)return e.physicsBody.getObjectCenterWorldToRef(r,n),!0;return!1}static HasAppliedForces(e,t){return 0===e.getMotionType(t)||0===(e.getMassProperties(t)?.mass??0)||0===e.transformNode?.getTotalVertices()}static IsInsideCylinder(e,t,i,r){const n=s.AA.Vector3[0];return e.subtractToRef(t,n),Math.abs(n.x)<=i&&Math.abs(n.z)<=i&&n.y>=0&&n.y<=r}}class eC{constructor(e){this._hitData={force:new s.Pq,contactPoint:new s.Pq,distanceFromOrigin:0},this._scene=e,this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine||f.V.Warn("Physics engine not enabled. Please enable the physics before you can use the methods.")}applyRadialExplosionImpulse(e,t,i,r){if(!this._physicsEngine)return f.V.Warn("Physics engine not enabled. Please enable the physics before you call this method."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;let n=!1;if("number"==typeof t){const e=t;(t=new sC).radius=e,t.strength=i??t.strength,t.falloff=r??t.falloff}else n=!(!t.affectedImpostorsCallback&&!t.affectedBodiesCallback);const s=new tC(this._scene,t),a=this._hitData;if(1===this._physicsEngine.getPluginVersion()){const t=Array();this._physicsEngine.getImpostors().forEach((i=>{s.getImpostorHitData(i,e,a)&&(i.applyImpulse(a.force,a.contactPoint),n&&t.push({impostor:i,hitData:this._copyPhysicsHitData(a)}))})),s.triggerAffectedImpostorsCallback(t)}else this._applicationForBodies(s,e,a,n,((e,t)=>{e.applyImpulse(t.force,t.contactPoint,t.instanceIndex)}));return s.dispose(!1),s}applyRadialExplosionForce(e,t,i,r){if(!this._physicsEngine)return f.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;let n=!1;if("number"==typeof t){const e=t;(t=new sC).radius=e,t.strength=i??t.strength,t.falloff=r??t.falloff}else n=!(!t.affectedImpostorsCallback&&!t.affectedBodiesCallback);const s=new tC(this._scene,t),a=this._hitData;if(1===this._physicsEngine.getPluginVersion()){const t=Array();this._physicsEngine.getImpostors().forEach((i=>{s.getImpostorHitData(i,e,a)&&(i.applyForce(a.force,a.contactPoint),n&&t.push({impostor:i,hitData:this._copyPhysicsHitData(a)}))})),s.triggerAffectedImpostorsCallback(t)}else this._applicationForBodies(s,e,a,n,((e,t)=>{e.applyForce(t.force,t.contactPoint,t.instanceIndex)}));return s.dispose(!1),s}_applicationForBodies(e,t,i,r,n){const s=Array(),a=this._physicsEngine.getBodies();for(const o of a)o.iterateOverAllInstances(((a,o)=>{e.getBodyHitData(a,t,i,o)&&(n(a,i),r&&s.push({body:a,hitData:this._copyPhysicsHitData(i)}))}));e.triggerAffectedBodiesCallback(s)}gravitationalField(e,t,i,r){if(!this._physicsEngine)return f.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new sC).radius=e,t.strength=i??t.strength,t.falloff=r??t.falloff}const n=new iC(this,this._scene,e,t);return n.dispose(!1),n}updraft(e,t,i,r,n){if(!this._physicsEngine)return f.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new aC).radius=e,t.strength=i??t.strength,t.height=r??t.height,t.updraftMode=n??t.updraftMode}const s=new rC(this._scene,e,t);return s.dispose(!1),s}vortex(e,t,i,r){if(!this._physicsEngine)return f.V.Warn("Physics engine not enabled. Please enable the physics before you call the PhysicsHelper."),null;if(1===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getImpostors().length)return null;if(2===this._physicsEngine.getPluginVersion()&&0===this._physicsEngine.getBodies().length)return null;if("number"==typeof t){const e=t;(t=new oC).radius=e,t.strength=i??t.strength,t.height=r??t.height}const n=new nC(this._scene,e,t);return n.dispose(!1),n}_copyPhysicsHitData(e){return{force:e.force.clone(),contactPoint:e.contactPoint.clone(),distanceFromOrigin:e.distanceFromOrigin,instanceIndex:e.instanceIndex}}}class tC{constructor(e,t){this._scene=e,this._options=t,this._dataFetched=!1,this._options={...new sC,...this._options}}getData(){return this._dataFetched=!0,{sphere:this._sphere}}_getHitData(e,t,i,r){const n=s.AA.Vector3[0];n.copyFrom(t).subtractInPlace(i);const a=s.AA.Vector3[1];if(!JE.GetContactPointToRef(e,i,n,a,r.instanceIndex))return!1;const o=s.Pq.Distance(i,a);if(o>this._options.radius)return!1;const l=0===this._options.falloff?this._options.strength:this._options.strength*(1-o/this._options.radius);return n.scaleInPlace(l),r.force.copyFrom(n),r.contactPoint.copyFrom(a),r.distanceFromOrigin=o,!0}getBodyHitData(e,t,i,r){if(JE.HasAppliedForces(e,r))return!1;const n=e.transformNode,s=e.getObjectCenterWorld(r);return i.instanceIndex=r,this._getHitData(n,s,t,i)}getImpostorHitData(e,t,i){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const r=e.object;if(!this._intersectsWithSphere(r,t,this._options.radius))return!1;const n=e.getObjectCenter();return this._getHitData(r,n,t,i),!0}triggerAffectedImpostorsCallback(e){this._options.affectedImpostorsCallback&&this._options.affectedImpostorsCallback(e)}triggerAffectedBodiesCallback(e){this._options.affectedBodiesCallback&&this._options.affectedBodiesCallback(e)}dispose(e=!0){this._sphere&&(e?this._sphere.dispose():setTimeout((()=>{this._dataFetched||this._sphere.dispose()}),0))}_prepareSphere(){this._sphere||(this._sphere=(0,Mo._6)("radialExplosionEventSphere",this._options.sphere,this._scene),this._sphere.isVisible=!1)}_intersectsWithSphere(e,t,i){return this._prepareSphere(),this._sphere.position=t,this._sphere.scaling.setAll(2*i),this._sphere._updateBoundingInfo(),this._sphere.computeWorldMatrix(!0),this._sphere.intersectsMesh(e,!0)}}class iC{constructor(e,t,i,r){this._physicsHelper=e,this._scene=t,this._origin=i,this._options=r,this._dataFetched=!1,this._options={...new sC,...this._options},this._tickCallback=()=>this._tick(),this._options.strength=-1*this._options.strength}getData(){return this._dataFetched=!0,{sphere:this._sphere}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._sphere&&(e?this._sphere.dispose():setTimeout((()=>{this._dataFetched||this._sphere.dispose()}),0))}_tick(){if(this._sphere)this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);else{const e=this._physicsHelper.applyRadialExplosionForce(this._origin,this._options);e&&(this._sphere=e.getData().sphere?.clone("radialExplosionEventSphereClone"))}}}class rC{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=s.Pq.Zero(),this._originDirection=s.Pq.Zero(),this._cylinderPosition=s.Pq.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new aC,...this._options},this._origin.addToRef(new s.Pq(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new s.Pq(0,this._options.height,0),this._originTop),1===this._options.updraftMode&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?(this._cylinder.dispose(),this._cylinder=void 0):setTimeout((()=>{!this._dataFetched&&this._cylinder&&(this._cylinder.dispose(),this._cylinder=void 0)}),0))}_getHitData(e,t){let i;i=1===this._options.updraftMode?this._originDirection:e.subtract(this._originTop);const r=s.Pq.Distance(this._origin,e),n=-1*this._options.strength,a=i.multiplyByFloats(n,n,n);t.force.copyFrom(a),t.contactPoint.copyFrom(e),t.distanceFromOrigin=r}_getBodyHitData(e,t,i){if(JE.HasAppliedForces(e))return!1;const r=e.getObjectCenterWorld(i);return!!JE.IsInsideCylinder(r,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(r,t),!0)}_getImpostorHitData(e,t){if(0===e.mass)return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const r=e.getObjectCenter();return this._getHitData(r,t),!0}_tick(){const e=rC._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=(0,ho.zk)("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return!!this._cylinder&&(this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0))}}rC._HitData={force:new s.Pq,contactPoint:new s.Pq,distanceFromOrigin:0};class nC{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=s.Pq.Zero(),this._cylinderPosition=s.Pq.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new oC,...this._options},this._origin.addToRef(new s.Pq(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new s.Pq(0,this._options.height,0),this._originTop),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?this._cylinder.dispose():setTimeout((()=>{this._dataFetched||this._cylinder.dispose()}),0))}_getHitData(e,t,i){const r=nC._OriginOnPlane;r.set(this._origin.x,t.y,this._origin.z);const n=s.AA.Vector3[0];t.subtractToRef(r,n);const a=s.AA.Vector3[1];if(!JE.GetContactPointToRef(e,r,n,a,i.instanceIndex))return!1;const o=s.Pq.Distance(a,r)/this._options.radius,l=s.AA.Vector3[2];let c,h,u;if(a.normalizeToRef(l),o>this._options.centripetalForceThreshold&&l.negateInPlace(),o>this._options.centripetalForceThreshold)c=l.x*this._options.centripetalForceMultiplier,h=l.y*this._options.updraftForceMultiplier,u=l.z*this._options.centripetalForceMultiplier;else{const e=s.Pq.Cross(r,t).normalize();c=(e.x+l.x)*this._options.centrifugalForceMultiplier,h=this._originTop.y*this._options.updraftForceMultiplier,u=(e.z+l.z)*this._options.centrifugalForceMultiplier}const d=s.AA.Vector3[3];return d.set(c,h,u),d.scaleInPlace(this._options.strength),i.force.copyFrom(d),i.contactPoint.copyFrom(t),i.distanceFromOrigin=o,!0}_getBodyHitData(e,t,i){if(JE.HasAppliedForces(e,i))return!1;const r=e.transformNode,n=e.getObjectCenterWorld(i);return!!JE.IsInsideCylinder(n,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(r,n,t))}_getImpostorHitData(e,t){if(0===e.mass)return!1;if("Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;const i=e.object;if(!this._intersectsWithCylinder(i))return!1;const r=e.getObjectCenter();return this._getHitData(i,r,t),!0}_tick(){const e=nC._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach((t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)})):this._physicsEngine.getBodies().forEach((t=>{t.iterateOverAllInstances(((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)}))}))}_prepareCylinder(){this._cylinder||(this._cylinder=(0,ho.zk)("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}nC._OriginOnPlane=s.Pq.Zero(),nC._HitData={force:new s.Pq,contactPoint:new s.Pq,distanceFromOrigin:0};class sC{constructor(){this.radius=5,this.strength=10,this.falloff=0,this.sphere={segments:32,diameter:1}}}class aC{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=0}}class oC{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}!function(e){e[e.Constant=0]="Constant",e[e.Linear=1]="Linear"}(fE||(fE={})),function(e){e[e.Center=0]="Center",e[e.Perpendicular=1]="Perpendicular"}(mE||(mE={}));var lC,cC=i(51478);class hC extends cC.d{constructor(){super(...arguments),this._hitDistance=0}get hitDistance(){return this._hitDistance}setHitDistance(e){this._hitDistance=e}reset(){super.reset(),this._hitDistance=0}}class uC extends cC.d{constructor(){super(...arguments),this._hitFraction=0}get hitFraction(){return this._hitFraction}setHitFraction(e){this._hitFraction=e}}class dC extends jt.w{get degree(){return this._effectWrapper.degree}set degree(e){this._effectWrapper.degree=e}getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i=null,r,n,s){const a={uniforms:_a.Uniforms,size:"number"==typeof t?t:void 0,camera:i,samplingMode:r,engine:n,reusable:s,...t};super(e,_a.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new _a(e,n,a),...a})}static _Parse(e,t,i,r){return pe.p.Parse((()=>new dC(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],dC.prototype,"degree",null),(0,o.Y5)("BABYLON.BlackAndWhitePostProcess",dC);class pC{constructor(e,t,i,r){this._name=t,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=re.S0.MakeArray(e||this._cameras);if(i)for(let e=0;e<i.length;e++){const r=i[e];if(!r)continue;const n=r.name;if(t=this._singleInstance?0:n,!this._postProcesses[t]){const e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[n]||(this._indicesForCamera[n]=[]),this._postProcesses[t].forEach((e=>{const t=r.attachPostProcess(e);this._indicesForCamera[n].push(t)})),this._cameras[n]||(this._cameras[n]=r)}}_detachCameras(e){const t=re.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],r=i.name,n=this._postProcesses[this._singleInstance?0:r];n&&n.forEach((e=>{i.detachPostProcess(e)})),this._cameras[r]&&(this._cameras[r]=null),delete this._indicesForCamera[r]}}_enable(e){const t=re.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],r=i.name,n=this._singleInstance?0:r;for(let s=0;s<this._indicesForCamera[r].length;s++){const a=this._indicesForCamera[r][s];null==i._postProcesses[a]&&t[e].attachPostProcess(this._postProcesses[n][s],a)}}}_disable(e){const t=re.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],r=i.name;this._postProcesses[this._singleInstance?0:r].forEach((e=>{i.detachPostProcess(e)}))}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}class fC extends jt.w{get threshold(){return this._effectWrapper.threshold}set threshold(e){this._effectWrapper.threshold=e}get _exposure(){return this._effectWrapper._exposure}set _exposure(e){this._effectWrapper._exposure=e}getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i=null,r,n,s,a=0,o=!1){const l={uniforms:Ca.Uniforms,size:"number"==typeof t?t:void 0,camera:i,samplingMode:r,engine:n,reusable:s,textureType:a,blockCompilation:o,...t};super(e,Ca.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new Ca(e,n,l),...l}),this._inputPostProcess=null,this.onApplyObservable.add((e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess)}))}}(0,ue.Cg)([(0,de.lK)()],fC.prototype,"threshold",null),(0,o.Y5)("BABYLON.ExtractHighlightsPostProcess",fC);class mC extends jt.w{get weight(){return this._effectWrapper.weight}set weight(e){this._effectWrapper.weight=e}getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,r,n,s=null,a,o,l,c=0,h=!1){const u="number"==typeof n?h:!!n.blockCompilation,d={uniforms:xa.Uniforms,samplers:xa.Samplers,size:"number"==typeof n?n:void 0,camera:s,samplingMode:a,engine:o,reusable:l,textureType:c,...n,blockCompilation:!0};super(e,xa.FragmentUrl,{effectWrapper:"number"!=typeof n&&n.effectWrapper?void 0:new xa(e,o,d),...d}),this.weight=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",i)})),u||this.updateEffect()}}(0,ue.Cg)([(0,de.lK)()],mC.prototype,"weight",null),(0,o.Y5)("BABYLON.BloomMergePostProcess",mC);class _C extends pC{get threshold(){return this._thinBloomEffect.threshold}set threshold(e){this._thinBloomEffect.threshold=e}get weight(){return this._thinBloomEffect.weight}set weight(e){this._thinBloomEffect.weight=e}get kernel(){return this._thinBloomEffect.kernel}set kernel(e){this._thinBloomEffect.kernel=e}get bloomScale(){return this._thinBloomEffect.scale}constructor(e,t,i,r,n=0,s=!1){const a=e._renderForCamera?e.getEngine():e;super(a,"bloom",(()=>this._effects),!0),this._effects=[],this._thinBloomEffect=new ba("bloom",a,t,s),this._downscale=new fC("highlights",{size:1,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:n,blockCompilation:s,effectWrapper:this._thinBloomEffect._downscale}),this._blurX=new ko("horizontal blur",this._thinBloomEffect._blurX.direction,this._thinBloomEffect._blurX.kernel,{size:t,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:n,blockCompilation:s,effectWrapper:this._thinBloomEffect._blurX}),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new ko("vertical blur",this._thinBloomEffect._blurY.direction,this._thinBloomEffect._blurY.kernel,{size:t,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:n,blockCompilation:s,effectWrapper:this._thinBloomEffect._blurY}),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=r,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new mC("bloomMerge",this._downscale,this._blurY,i,{size:t,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:n,blockCompilation:s,effectWrapper:this._thinBloomEffect._merge}),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){return this._thinBloomEffect.isReady()}}class gC extends jt.w{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,r,n,a,o,l,c=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],r,n,a,o,l,null,c,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new s.I9(.707,.707),this.centerPosition=new s.I9(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add((e=>{e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",t),e.setFloat("screen_height",i),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,80223))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,89524))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new gC(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],gC.prototype,"aberrationAmount",void 0),(0,ue.Cg)([(0,de.lK)()],gC.prototype,"radialIntensity",void 0),(0,ue.Cg)([(0,de.lK)()],gC.prototype,"direction",void 0),(0,ue.Cg)([(0,de.lK)()],gC.prototype,"centerPosition",void 0),(0,ue.Cg)([(0,de.lK)()],gC.prototype,"screenWidth",void 0),(0,ue.Cg)([(0,de.lK)()],gC.prototype,"screenHeight",void 0),(0,o.Y5)("BABYLON.ChromaticAberrationPostProcess",gC);class vC extends jt.w{get lensSize(){return this._effectWrapper.lensSize}set lensSize(e){this._effectWrapper.lensSize=e}get fStop(){return this._effectWrapper.fStop}set fStop(e){this._effectWrapper.fStop=e}get focusDistance(){return this._effectWrapper.focusDistance}set focusDistance(e){this._effectWrapper.focusDistance=e}get focalLength(){return this._effectWrapper.focalLength}set focalLength(e){this._effectWrapper.focalLength=e}getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,r,n,s,a,o=0,l=!1){const c={uniforms:Ma.Uniforms,samplers:Ma.Samplers,defines:"object"==typeof i&&i.depthNotNormalized?Ma.DefinesDepthNotNormalized:void 0,size:"number"==typeof i?i:void 0,camera:r,samplingMode:n,engine:s,reusable:a,textureType:o,blockCompilation:l,...i};super(e,Ma.FragmentUrl,{effectWrapper:"number"!=typeof i&&i.effectWrapper?void 0:new Ma(e,s,c),...c}),this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add((e=>{this._depthTexture?(e.setTexture("depthSampler",this._depthTexture),this._effectWrapper.camera=this._depthTexture.activeCamera):f.V.Warn("No depth texture set on CircleOfConfusionPostProcess")}))}set depthTexture(e){this._depthTexture=e}}(0,ue.Cg)([(0,de.lK)()],vC.prototype,"lensSize",null),(0,ue.Cg)([(0,de.lK)()],vC.prototype,"fStop",null),(0,ue.Cg)([(0,de.lK)()],vC.prototype,"focusDistance",null),(0,ue.Cg)([(0,de.lK)()],vC.prototype,"focalLength",null),(0,o.Y5)("BABYLON.CircleOfConfusionPostProcess",vC);class SC extends jt.w{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,r,n,s,a){super(e,"colorCorrection",null,["colorTable"],i,r,n,s,a);const o=r?.getScene()||null;this._colorTableTexture=new _e.g(t,o,!0,!1,_e.g.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=_e.g.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=_e.g.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,41993))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,48146))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new SC(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],SC.prototype,"colorTableUrl",void 0),(0,o.Y5)("BABYLON.ColorCorrectionPostProcess",SC);class xC extends jt.w{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,r,n,s,a,o=0){super(e,"convolution",["kernel","screenSize"],null,i,r,n,s,a,null,o),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,15062))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,66229))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new xC(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType)),e,i,r)}}xC.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],xC.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],xC.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],xC.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],xC.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],xC.GaussianKernel=[0,1,0,1,1,1,0,1,0],(0,ue.Cg)([(0,de.lK)()],xC.prototype,"kernel",void 0),(0,o.Y5)("BABYLON.ConvolutionPostProcess",xC);class TC extends ko{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,r,n,s,a,o=null,l=_e.g.BILINEAR_SAMPLINGMODE,c,h,u=0,d=!1,p=5){super(e,i,r,{camera:s,engine:c,reusable:h,textureType:u,defines:"#define DOF 1\n",blockCompilation:d,textureFormat:p,...n,samplingMode:2}),this.externalTextureSamplerBinding=!!o,this.onApplyObservable.add((e=>{null!=o&&e.setTextureFromPostProcess("textureSampler",o),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)}))}}(0,o.Y5)("BABYLON.DepthOfFieldBlurPostProcess",TC);class EC extends jt.w{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,r,n,s,a,o,l,c=0,h=!1){const u="number"==typeof n?h:!!n.blockCompilation,d={samplers:Da.Samplers,size:"number"==typeof n?n:void 0,camera:s,samplingMode:a,engine:o,reusable:l,textureType:c,...n,blockCompilation:!0};super(e,Da.FragmentUrl,{effectWrapper:"number"!=typeof n&&n.effectWrapper?void 0:new Da(e,o,d),...d}),this._blurSteps=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),r.forEach(((t,i)=>{e.setTextureFromPostProcessOutput("blurStep"+(r.length-i-1),t)}))})),u||this.updateEffect()}updateEffect(e=null,t=null,i=null,r,n,s){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,r,n,s)}}!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(lC||(lC={}));class CC extends pC{set focalLength(e){this._thinDepthOfFieldEffect.focalLength=e}get focalLength(){return this._thinDepthOfFieldEffect.focalLength}set fStop(e){this._thinDepthOfFieldEffect.fStop=e}get fStop(){return this._thinDepthOfFieldEffect.fStop}set focusDistance(e){this._thinDepthOfFieldEffect.focusDistance=e}get focusDistance(){return this._thinDepthOfFieldEffect.focusDistance}set lensSize(e){this._thinDepthOfFieldEffect.lensSize=e}get lensSize(){return this._thinDepthOfFieldEffect.lensSize}constructor(e,t,i=0,r=0,n=!1,s=!1){const a=e._renderForCamera?e.getEngine():e;super(a,"depth of field",(()=>this._effects),!0),this._effects=[],this._thinDepthOfFieldEffect=new Ba("Depth of Field",a,i,!1,n);const o=a.isWebGPU||a.version>1?6:5;this._circleOfConfusion=new vC("circleOfConfusion",t,{size:1,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:r,blockCompilation:n,depthNotNormalized:s,effectWrapper:this._thinDepthOfFieldEffect._circleOfConfusion},null),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];const l=this._thinDepthOfFieldEffect._depthOfFieldBlurX.length;for(let e=0;e<l;e++){const[t,i]=this._thinDepthOfFieldEffect._depthOfFieldBlurY[e],s=new TC("vertical blur",null,t.direction,t.kernel,{size:i,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:r,blockCompilation:n,textureFormat:0==e?o:5,effectWrapper:t},null,this._circleOfConfusion,0==e?this._circleOfConfusion:null);s.autoClear=!1;const[l,c]=this._thinDepthOfFieldEffect._depthOfFieldBlurX[e],h=new TC("horizontal blur",null,l.direction,l.kernel,{size:c,samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:r,blockCompilation:n,effectWrapper:l},null,this._circleOfConfusion,null);h.autoClear=!1,this._depthOfFieldBlurY.push(s),this._depthOfFieldBlurX.push(h)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new EC("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,{size:this._thinDepthOfFieldEffect._depthOfFieldBlurX[l-1][1],samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:a,textureType:r,blockCompilation:n,effectWrapper:this._thinDepthOfFieldEffect._dofMerge},null),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){return this._thinDepthOfFieldEffect.isReady()}}class bC extends jt.w{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,r,n,s){super(e,"displayPass",["passSampler"],["passSampler"],t,i,r,n,s)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,52361))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,14674))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new bC(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,o.Y5)("BABYLON.DisplayPassPostProcess",bC);class PC extends jt.w{getClassName(){return"FilterPostProcess"}constructor(e,t,i,r,n,s,a){super(e,"filter",["kernelMatrix"],null,i,r,n,s,a),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,77572))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,25197))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new PC(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.GG)()],PC.prototype,"kernelMatrix",void 0),(0,o.Y5)("BABYLON.FilterPostProcess",PC);class yC extends jt.w{getClassName(){return"GrainPostProcess"}constructor(e,t,i,r,n,s,a=0,o=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,r,n,s,null,a,void 0,null,o),this.intensity=30,this.animated=!1,this.onApplyObservable.add((e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,45221))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,29494))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new yC(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],yC.prototype,"intensity",void 0),(0,ue.Cg)([(0,de.lK)()],yC.prototype,"animated",void 0),(0,o.Y5)("BABYLON.GrainPostProcess",yC);class AC extends jt.w{getClassName(){return"HighlightsPostProcess"}constructor(e,t,i,r,n,s,a=0){super(e,"highlights",null,null,t,i,r,n,s,null,a)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,7749))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,85676))])),super._gatherImports(e,t)}}class RC extends jt.w{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null;const t=this.getEngine(),i=this.getCamera();if(i)e=i.getScene();else if(t&&t.scenes){const i=t.scenes;e=i[i.length-1]}else e=P.q.LastCreatedScene;this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new Mi.p}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters()}))),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,r,n,s,a=0,o){super(e,"imageProcessing",[],[],t,i,r,n,s,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:0,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},o?(o.applyByPostProcess=!0,this._attachImageProcessingConfiguration(o,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,55898)))):t.push(Promise.resolve().then(i.bind(i,16213))),super._gatherImports(e,t)}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const t in this._defines){const i=this._defines[t];switch(typeof i){case"number":case"string":e+=`#define ${t} ${i};\n`;break;default:i&&(e+=`#define ${t};\n`)}}const t=["textureSampler"],i=["scale"];Mi.p&&(Mi.p.PrepareSamplers(t,this._defines),Mi.p.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}(0,ue.Cg)([(0,de.lK)()],RC.prototype,"_fromLinearSpace",void 0);var IC=i(73423),MC=i(75646);const OC=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];(0,Xo.TV)(OC);class NC{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===NC.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===NC.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===NC.VELOCITY_LINEAR_TEXTURE_TYPE?(this._velocityLinearIndex=t,this._enableVelocityLinear=!0):e===NC.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===NC.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===NC.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===NC.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case NC.POSITION_TEXTURE_TYPE:return this._positionIndex;case NC.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case NC.VELOCITY_LINEAR_TEXTURE_TYPE:return this._velocityLinearIndex;case NC.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case NC.DEPTH_TEXTURE_TYPE:return this._depthIndex;case NC.NORMAL_TEXTURE_TYPE:return this._normalIndex;case NC.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return-1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableVelocityLinear(){return this._enableVelocityLinear}set enableVelocityLinear(e){this._enableVelocityLinear=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=1,i=15,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new a.ov(0,0,0,0),this._clearDepthColor=new a.ov(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._velocityLinearIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),NC._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!NC.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,30672)),Promise.resolve().then(i.bind(i,29610))])):await Promise.all([Promise.resolve().then(i.bind(i,75646)),Promise.resolve().then(i.bind(i,73423))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const r=[],n=[Ue.R.PositionKind,Ue.R.NormalKind],s=e.getMesh();if(i){let e=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(r.push("#define ALPHATEST"),r.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),(i.bumpTexture||i.normalTexture)&&Ho.h.BumpTextureEnabled){const t=i.bumpTexture||i.normalTexture;r.push("#define BUMP"),r.push(`#define BUMP_UV${t.coordinatesIndex+1}`),e=!0}if(this._enableReflectivity){let t=!1;"PBRMetallicRoughnessMaterial"===i.getClassName()?(i.metallicRoughnessTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),t=!0),t&&(i.baseTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),e=!0),i.baseColor&&r.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===i.getClassName()?(i.specularGlossinessTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&r.push("#define REFLECTIVITYCOLOR"),null!=i.glossiness&&r.push("#define GLOSSINESS")):"PBRMaterial"===i.getClassName()?(i.metallicTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),t=!0),t?(i.albedoTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),e=!0),i.albedoColor&&r.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):i.reflectivityColor&&r.push("#define REFLECTIVITYCOLOR"),null!=i.microSurface&&r.push("#define GLOSSINESS"))):"StandardMaterial"===i.getClassName()&&(i.specularTexture&&(r.push("#define REFLECTIVITYTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),i.specularColor&&r.push("#define REFLECTIVITYCOLOR"))}e&&(r.push("#define NEED_UV"),s.isVerticesDataPresent(Ue.R.UVKind)&&(n.push(Ue.R.UVKind),r.push("#define UV1")),s.isVerticesDataPresent(Ue.R.UV2Kind)&&(n.push(Ue.R.UV2Kind),r.push("#define UV2")))}this._enableDepth&&(r.push("#define DEPTH"),r.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(r.push("#define NORMAL"),r.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(r.push("#define POSITION"),r.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(r.push("#define VELOCITY"),r.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(s)&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableVelocityLinear&&(r.push("#define VELOCITY_LINEAR"),r.push("#define VELOCITY_LINEAR_INDEX "+this._velocityLinearIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(s)&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(r.push("#define REFLECTIVITY"),r.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&-1!==this._screenspaceDepthIndex&&(r.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),r.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&r.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&r.push("#define ENCODE_NORMAL"),s.useBones&&s.computeBonesUsingShaders&&s.skeleton?(n.push(Ue.R.MatricesIndicesKind),n.push(Ue.R.MatricesWeightsKind),s.numBoneInfluencers>4&&(n.push(Ue.R.MatricesIndicesExtraKind),n.push(Ue.R.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),r.push("#define BONETEXTURE "+s.skeleton.isUsingTextureForMatrices),r.push("#define BonesPerMesh "+(s.skeleton.bones.length+1))):(r.push("#define NUM_BONE_INFLUENCERS 0"),r.push("#define BONETEXTURE false"),r.push("#define BonesPerMesh 0"));const a=s.morphTargetManager;let o=0;a&&(o=a.numMaxInfluencers||a.numInfluencers,o>0&&(r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+o),a.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),(0,qo.MF)(n,s,o))),t&&(r.push("#define INSTANCES"),(0,qo.te)(n,this._enableVelocity||this._enableVelocityLinear),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this._linkedWithPrePass?r.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):r.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),(0,Xo.tv)(i,this._scene,r);const l=this._scene.getEngine(),c=e._getDrawWrapper(void 0,!0),h=c.defines,u=r.join("\n");return h!==u&&c.setEffect(l.createEffect("geometry",{attributes:n,uniformsNames:OC,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:u,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:o},shaderLanguage:this.shaderLanguage},l),u),c.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[],t=[];let i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[NC.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[NC.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[NC.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[NC.VELOCITY_TEXTURE_TYPE])),this._enableVelocityLinear&&(this._velocityLinearIndex=i,i++,e.push("gBuffer_VelocityLinear"),t.push(this._textureTypesAndFormats[NC.VELOCITY_LINEAR_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[NC.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[NC.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i,r]=this._assignRenderTargetIndices();let n=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?n=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(n=2);const a=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},o=[],l=[];for(const e of r)e?(o.push(e.textureType),l.push(e.textureFormat)):(o.push(n),l.push(5));if(this._normalsAreUnsigned=11===o[NC.NORMAL_TEXTURE_TYPE]||13===o[NC.NORMAL_TEXTURE_TYPE],this._multiRenderTarget=new td("gBuffer",a,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:o,formats:l,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=_e.g.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=_e.g.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const c=[!0],h=[!1],u=[!0];for(let e=1;e<t;++e)c.push(!0),u.push(!1),h.push(!0);const d=e.buildTextureLayout(c),p=e.buildTextureLayout(h),f=e.buildTextureLayout(u);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?p:d),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(f),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(d)})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}}));const m=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,n=r.getEngine(),a=e.getMaterial();if(!a)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,(this._enableVelocity||this._enableVelocityLinear)&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:s.uq.Identity(),viewProjection:r.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}const o=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(o.mustReturn)return;const l=n.getCaps().instancedArrays&&(null!==o.visibleInstances[e._id]||t.hasThinInstances),c=i.getWorldMatrix();if(this.isReady(e,l)){const s=e._getDrawWrapper();if(!s)return;const h=s.effect;let u;n.enableEffect(s),l||t._bind(e,h,a.fillMode),this._useUbo?((0,qo._8)(h,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(h.setMatrix("viewProjection",r.getTransformMatrix()),h.setMatrix("view",r.getViewMatrix()));const d=t._instanceDataStorage;if(d.isFrozen||!a.backFaceCulling&&null===a.sideOrientation)u=d.sideOrientation;else{const e=i._getWorldMatrixDeterminant();u=a._getEffectiveOrientation(t),e<0&&(u=u===Zl.i.ClockWiseSideOrientation?Zl.i.CounterClockWiseSideOrientation:Zl.i.ClockWiseSideOrientation)}if(a._preBind(s,u),a.needAlphaTesting()){const e=a.getAlphaTestTexture();e&&(h.setTexture("diffuseSampler",e),h.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if((a.bumpTexture||a.normalTexture)&&r.getEngine().getCaps().standardDerivatives&&Ho.h.BumpTextureEnabled){const e=a.bumpTexture||a.normalTexture;h.setFloat3("vBumpInfos",e.coordinatesIndex,1/e.level,a.parallaxScaleBias),h.setMatrix("bumpMatrix",e.getTextureMatrix()),h.setTexture("bumpSampler",e),h.setFloat2("vTangentSpaceParams",a.invertNormalMapX?-1:1,a.invertNormalMapY?-1:1)}if(this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===a.getClassName()?(null!==a.metallicRoughnessTexture&&(h.setTexture("reflectivitySampler",a.metallicRoughnessTexture),h.setMatrix("reflectivityMatrix",a.metallicRoughnessTexture.getTextureMatrix())),null!==a.metallic&&h.setFloat("metallic",a.metallic),null!==a.roughness&&h.setFloat("glossiness",1-a.roughness),null!==a.baseTexture&&(h.setTexture("albedoSampler",a.baseTexture),h.setMatrix("albedoMatrix",a.baseTexture.getTextureMatrix())),null!==a.baseColor&&h.setColor3("albedoColor",a.baseColor)):"PBRSpecularGlossinessMaterial"===a.getClassName()?(null!==a.specularGlossinessTexture?(h.setTexture("reflectivitySampler",a.specularGlossinessTexture),h.setMatrix("reflectivityMatrix",a.specularGlossinessTexture.getTextureMatrix())):null!==a.specularColor&&h.setColor3("reflectivityColor",a.specularColor),null!==a.glossiness&&h.setFloat("glossiness",a.glossiness)):"PBRMaterial"===a.getClassName()?(null!==a.metallicTexture&&(h.setTexture("reflectivitySampler",a.metallicTexture),h.setMatrix("reflectivityMatrix",a.metallicTexture.getTextureMatrix())),null!==a.metallic&&h.setFloat("metallic",a.metallic),null!==a.roughness&&h.setFloat("glossiness",1-a.roughness),null!==a.roughness||null!==a.metallic||null!==a.metallicTexture?(null!==a.albedoTexture&&(h.setTexture("albedoSampler",a.albedoTexture),h.setMatrix("albedoMatrix",a.albedoTexture.getTextureMatrix())),null!==a.albedoColor&&h.setColor3("albedoColor",a.albedoColor)):(null!==a.reflectivityTexture?(h.setTexture("reflectivitySampler",a.reflectivityTexture),h.setMatrix("reflectivityMatrix",a.reflectivityTexture.getTextureMatrix())):null!==a.reflectivityColor&&h.setColor3("reflectivityColor",a.reflectivityColor),null!==a.microSurface&&h.setFloat("glossiness",a.microSurface))):"StandardMaterial"===a.getClassName()&&(null!==a.specularTexture&&(h.setTexture("reflectivitySampler",a.specularTexture),h.setMatrix("reflectivityMatrix",a.specularTexture.getTextureMatrix())),null!==a.specularColor&&h.setColor3("reflectivityColor",a.specularColor))),(0,Xo.gS)(h,a,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&h.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);h.setTexture("boneSampler",i),h.setFloat("boneTextureWidth",4*(e.bones.length+1))}else h.setMatrices("mBones",t.skeleton.getTransformMatrices(t));(this._enableVelocity||this._enableVelocityLinear)&&h.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}(0,qo.nR)(t,h),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(h),(this._enableVelocity||this._enableVelocityLinear)&&(h.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),h.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),l&&t.hasThinInstances&&h.setMatrix("world",c),t._processRendering(i,e,h,a.fillMode,o,l,((e,t)=>{e||h.setMatrix("world",t)}))}(this._enableVelocity||this._enableVelocityLinear)&&(this._previousTransformationMatrices[i.uniqueId].world=c.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,r)=>{if((r||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const r=t.subMeshes[i],n=r.getMaterial(),s=r.getRenderingMesh();if(!n)continue;const a=s._getInstancesRenderList(r._id,!!r.getReplacementMesh()),o=e.getCaps().instancedArrays&&(null!==a.visibleInstances[r._id]||s.hasThinInstances);if(!this.isReady(r,o))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,r,n)=>{let s;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(n.length){for(e.setColorWrite(!1),s=0;s<n.length;s++)m(n.data[s]);e.setColorWrite(!0)}for(s=0;s<t.length;s++)m(t.data[s]);for(e.setDepthWrite(!1),s=0;s<i.length;s++)m(i.data[s]);if(this.renderTransparentMeshes)for(s=0;s<r.length;s++)m(r.data[s]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}NC.ForceGLSL=!1,NC.DEPTH_TEXTURE_TYPE=0,NC.NORMAL_TEXTURE_TYPE=1,NC.POSITION_TEXTURE_TYPE=2,NC.VELOCITY_TEXTURE_TYPE=3,NC.REFLECTIVITY_TEXTURE_TYPE=4,NC.SCREENSPACE_DEPTH_TEXTURE_TYPE=5,NC.VELOCITY_LINEAR_TEXTURE_TYPE=6,NC._SceneComponentInitialization=e=>{throw(0,Oc.n)("GeometryBufferRendererSceneComponent")};class DC{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(kt.Z.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),kt.Z.prototype.enableGeometryBufferRenderer=function(e=1,t=15,i){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new NC(this,e,t,i),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},kt.Z.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class FC{constructor(e){this.name=Gt.v.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Gt.v.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}NC._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_GEOMETRYBUFFERRENDERER);t||(t=new FC(e),e._addComponent(t))};class LC extends jt.w{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,r,n,s,a,o=0,l=!1,c=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,r,n,s,a,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",o,void 0,null,l),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=c,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new DC)),this._applyMode()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,11071))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,14018))])),super._gatherImports(e,t)}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return f.V.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=s.uq.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new s.I9(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(NC.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=s.AA.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new s.I9(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(NC.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,r){return pe.p.Parse((()=>new LC(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],LC.prototype,"motionStrength",void 0),(0,ue.Cg)([(0,de.lK)()],LC.prototype,"motionBlurSamples",null),(0,ue.Cg)([(0,de.lK)()],LC.prototype,"isObjectBased",null),(0,o.Y5)("BABYLON.MotionBlurPostProcess",LC);ri.l.ShadersStore.refractionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";class wC extends jt.w{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,r,n,s,a,o,l,c){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],s,a,o,l,c),this._ownRefractionTexture=!0,this.color=i,this.depth=r,this.colorLevel=n,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new _e.g(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new wC(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],wC.prototype,"color",void 0),(0,ue.Cg)([(0,de.lK)()],wC.prototype,"depth",void 0),(0,ue.Cg)([(0,de.lK)()],wC.prototype,"colorLevel",void 0),(0,ue.Cg)([(0,de.lK)()],wC.prototype,"refractionTextureUrl",void 0),(0,o.Y5)("BABYLON.RefractionPostProcess",wC);var BC=i(1442);class VC extends jt.w{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,r,n,s,a=0,o=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,r,n,s,null,a,void 0,null,o),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,96841))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,1442))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return pe.p.Parse((()=>new VC(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],VC.prototype,"colorAmount",void 0),(0,ue.Cg)([(0,de.lK)()],VC.prototype,"edgeAmount",void 0),(0,o.Y5)("BABYLON.SharpenPostProcess",VC);class kC{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(re.S0.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(re.S0.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=re.S0.MakeArray(e||this._cameras);if(!i)return;const r=[];let n;for(n=0;n<i.length;n++){const e=i[n];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&r.push(n))}for(n=0;n<r.length;n++)i.splice(r[n],1);for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(i)}_detachCameras(e){const t=re.S0.MakeArray(e||this._cameras);if(t){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const e=this._renderEffects[t].getPostProcesses();if(e)for(const t of e)t.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}(0,ue.Cg)([(0,de.lK)()],kC.prototype,"_name",void 0);class GC{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){const r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(kt.Z.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(Gt.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new UC(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new GC}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class UC{constructor(e){this.name=Gt.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Gt.v.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class zC extends kC{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new _C(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new CC(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new Lc("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=P.q.LastCreatedScene,r,s=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=0,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new n.cP,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=s,this._scene=i;const a=this._scene.getEngine().getCaps();this._hdr=t&&(a.textureHalfFloatRender||a.textureFloatRender),this._hdr?a.textureHalfFloatRender?this._defaultPipelineTextureType=2:a.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const o=this._scene.getEngine();this.sharpen=new VC("sharpen",1,null,_e.g.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new pC(o,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new CC(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=o.getHardwareScalingLevel(),this._resizeObserver=o.onResizeObservable.add((()=>{this._hardwareScaleLevel=o.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new _C(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new gC("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,_e.g.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new pC(o,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new yC("Grain",1,null,_e.g.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new pC(o,this.GrainPostProcessId,(()=>this.grain),!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?re.S0.SetImmediate((()=>{this._buildPipeline()})):this._buildPipeline())})),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras)this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new RC("imageProcessing",1,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new pC(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new bx("fxaa",1,null,_e.g.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new pC(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&f.V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=pe.p.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return pe.p.Parse((()=>new zC(e._name,e._name._hdr,t)),e,t,i)}}(0,ue.Cg)([(0,de.lK)()],zC.prototype,"sharpenEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"bloomKernel",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"_bloomWeight",void 0),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"_bloomThreshold",void 0),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"_hdr",void 0),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"bloomWeight",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"bloomThreshold",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"bloomScale",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"bloomEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"depthOfFieldEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"depthOfFieldBlurLevel",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"fxaaEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"samples",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"imageProcessingEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"glowLayerEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"chromaticAberrationEnabled",null),(0,ue.Cg)([(0,de.lK)()],zC.prototype,"grainEnabled",null),(0,o.Y5)("BABYLON.DefaultRenderingPipeline",zC);var WC=i(89524);ri.l.ShadersStore.lensHighlightsPixelShader="uniform sampler2D textureSampler; \nuniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}\nfloat w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;gl_FragColor=blurred;}";ri.l.ShadersStore.depthOfFieldPixelShader="uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; \nuniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)\n{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}\nvec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}\nfloat getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}\nvec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}\nif (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}\ncol/=total_weight; \nif (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}\nreturn col;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}\nfloat blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}\nelse {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}\nif (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}\nif (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}\n";class HC extends kC{constructor(e,t,i,r=1,n){super(i.getEngine(),e),this.LensChromaticAberrationEffect="LensChromaticAberrationEffect",this.HighlightsEnhancingEffect="HighlightsEnhancingEffect",this.LensDepthOfFieldEffect="LensDepthOfFieldEffect",this._pentagonBokehIsEnabled=!1,this._scene=i,this._depthTexture=i.enableDepthRenderer().getDepthMap(),t.grain_texture?this._grainTexture=t.grain_texture:this._createGrainTexture(),this._edgeBlur=t.edge_blur?t.edge_blur:0,this._grainAmount=t.grain_amount?t.grain_amount:0,this._chromaticAberration=t.chromatic_aberration?t.chromatic_aberration:0,this._distortion=t.distortion?t.distortion:0,this._highlightsGain=void 0!==t.dof_gain?t.dof_gain:-1,this._highlightsThreshold=t.dof_threshold?t.dof_threshold:1,this._dofDistance=void 0!==t.dof_focus_distance?t.dof_focus_distance:-1,this._dofAperture=t.dof_aperture?t.dof_aperture:1,this._dofDarken=t.dof_darken?t.dof_darken:0,this._dofPentagon=void 0===t.dof_pentagon||t.dof_pentagon,this._blurNoise=void 0===t.blur_noise||t.blur_noise,this._createChromaticAberrationPostProcess(r),this._createHighlightsPostProcess(r),this._createDepthOfFieldPostProcess(r/4),this.addEffect(new pC(i.getEngine(),this.LensChromaticAberrationEffect,(()=>this._chromaticAberrationPostProcess),!0)),this.addEffect(new pC(i.getEngine(),this.HighlightsEnhancingEffect,(()=>this._highlightsPostProcess),!0)),this.addEffect(new pC(i.getEngine(),this.LensDepthOfFieldEffect,(()=>this._depthOfFieldPostProcess),!0)),-1===this._highlightsGain&&this._disableEffect(this.HighlightsEnhancingEffect,null),i.postProcessRenderPipelineManager.addPipeline(this),n&&i.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,n)}getClassName(){return"LensRenderingPipeline"}get scene(){return this._scene}get edgeBlur(){return this._edgeBlur}set edgeBlur(e){this.setEdgeBlur(e)}get grainAmount(){return this._grainAmount}set grainAmount(e){this.setGrainAmount(e)}get chromaticAberration(){return this._chromaticAberration}set chromaticAberration(e){this.setChromaticAberration(e)}get dofAperture(){return this._dofAperture}set dofAperture(e){this.setAperture(e)}get edgeDistortion(){return this._distortion}set edgeDistortion(e){this.setEdgeDistortion(e)}get dofDistortion(){return this._dofDistance}set dofDistortion(e){this.setFocusDistance(e)}get darkenOutOfFocus(){return this._dofDarken}set darkenOutOfFocus(e){this.setDarkenOutOfFocus(e)}get blurNoise(){return this._blurNoise}set blurNoise(e){this._blurNoise=e}get pentagonBokeh(){return this._pentagonBokehIsEnabled}set pentagonBokeh(e){e?this.enablePentagonBokeh():this.disablePentagonBokeh()}get highlightsGain(){return this._highlightsGain}set highlightsGain(e){this.setHighlightsGain(e)}get highlightsThreshold(){return this._highlightsThreshold}set highlightsThreshold(e){this.setHighlightsThreshold(e)}setEdgeBlur(e){this._edgeBlur=e}disableEdgeBlur(){this._edgeBlur=0}setGrainAmount(e){this._grainAmount=e}disableGrain(){this._grainAmount=0}setChromaticAberration(e){this._chromaticAberration=e}disableChromaticAberration(){this._chromaticAberration=0}setEdgeDistortion(e){this._distortion=e}disableEdgeDistortion(){this._distortion=0}setFocusDistance(e){this._dofDistance=e}disableDepthOfField(){this._dofDistance=-1}setAperture(e){this._dofAperture=e}setDarkenOutOfFocus(e){this._dofDarken=e}enablePentagonBokeh(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n"),this._pentagonBokehIsEnabled=!0}disablePentagonBokeh(){this._pentagonBokehIsEnabled=!1,this._highlightsPostProcess.updateEffect()}enableNoiseBlur(){this._blurNoise=!0}disableNoiseBlur(){this._blurNoise=!1}setHighlightsGain(e){this._highlightsGain=e}setHighlightsThreshold(e){-1===this._highlightsGain&&(this._highlightsGain=1),this._highlightsThreshold=e}disableHighlights(){this._highlightsGain=-1}dispose(e=!1){this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=null,this._highlightsPostProcess=null,this._depthOfFieldPostProcess=null,this._grainTexture.dispose(),e&&this._scene.disableDepthRenderer()}_createChromaticAberrationPostProcess(e){this._chromaticAberrationPostProcess=new jt.w("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],e,null,_e.g.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=e=>{e.setFloat("chromatic_aberration",this._chromaticAberration),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight()),e.setFloat("radialIntensity",1),e.setFloat2("direction",17,17),e.setFloat2("centerPosition",.5,.5)}}_createHighlightsPostProcess(e){this._highlightsPostProcess=new jt.w("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],e,null,_e.g.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?"#define PENTAGON\n":""),this._highlightsPostProcess.externalTextureSamplerBinding=!0,this._highlightsPostProcess.onApply=e=>{e.setFloat("gain",this._highlightsGain),e.setFloat("threshold",this._highlightsThreshold),e.setTextureFromPostProcess("textureSampler",this._chromaticAberrationPostProcess),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight())}}_createDepthOfFieldPostProcess(e){this._depthOfFieldPostProcess=new jt.w("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],e,null,_e.g.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.externalTextureSamplerBinding=!0,this._depthOfFieldPostProcess.onApply=e=>{e.setTexture("depthSampler",this._depthTexture),e.setTexture("grainSampler",this._grainTexture),e.setTextureFromPostProcess("textureSampler",this._highlightsPostProcess),e.setTextureFromPostProcess("highlightsSampler",this._depthOfFieldPostProcess),e.setFloat("grain_amount",this._grainAmount),e.setBool("blur_noise",this._blurNoise),e.setFloat("screen_width",this._scene.getEngine().getRenderWidth()),e.setFloat("screen_height",this._scene.getEngine().getRenderHeight()),e.setFloat("distortion",this._distortion),e.setBool("dof_enabled",-1!==this._dofDistance),e.setFloat("screen_distance",1/(.1-1/this._dofDistance)),e.setFloat("aperture",this._dofAperture),e.setFloat("darken",this._dofDarken),e.setFloat("edge_blur",this._edgeBlur),e.setBool("highlights",-1!==this._highlightsGain),this._scene.activeCamera&&(e.setFloat("near",this._scene.activeCamera.minZ),e.setFloat("far",this._scene.activeCamera.maxZ))}}_createGrainTexture(){const e=new Uint8Array(1048576);for(let t=0;t<e.length;){const i=Math.floor(255*(0,it.RandomRange)(.42,.58));e[t++]=i,e[t++]=i,e[t++]=i,e[t++]=255}const t=me.I.CreateRGBATexture(e,512,512,this._scene,!1,!1,2);t.name="LensNoiseTexture",t.wrapU=_e.g.WRAP_ADDRESSMODE,t.wrapV=_e.g.WRAP_ADDRESSMODE,this._grainTexture=t}}class YC{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}class XC extends kC{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=P.q.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,r,n=!1,s=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=s,this._forceGeometryBuffer=n,!this.isSupported)return void f.V.Error("The current engine does not support SSAO 2.");const a=this._ratio.ssaoRatio||i,o=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),t.geometryBufferRenderer?.generateNormalsInWorldSpace&&f.V.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),t.prePassRenderer?.generateNormalsInWorldSpace&&f.V.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new $t.v("SSAOOriginalSceneColor",1,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,s),this._createBlurPostProcess(a,o,this._textureType),this._createSSAOCombinePostProcess(o,this._textureType),this.addEffect(new pC(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const r=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),n=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",n,e,r.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",n,t,r.v,i,!1)}_createBlurFilter(e,t,r,n,s,a){const o=new jt.w(e,"ssao2",["outSize","samples","soften","tolerance"],t,r,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,n,s,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,37152))):t.push(Promise.resolve().then(i.bind(i,30327)))}));return o.onApply=e=>{if(!this._scene.activeCamera)return;const t=a?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,i=a?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",t>0?t:i),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},o.samples=this.textureSamples,o.autoClear=!1,o}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,r=1-.85*e,n=Math.sqrt(1-r*r);return new s.Pq(Math.cos(i)*n,Math.sin(i)*n,r)}_generateHemisphere(){const e=this.samples,t=[];let i,r=0;for(;r<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(r,e);i=this._hemisphereSample_uniform(t[0],t[1])}t.push(i.x,i.y,i.z),r++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const r=this._getDefinesForSSAO();this._ssaoPostProcess=new jt.w("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,r,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,37152))):t.push(Promise.resolve().then(i.bind(i,30327)))})),this._ssaoPostProcess.autoClear=!1,this._ssaoPostProcess.onApply=e=>{if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===Ct.i.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",XC.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const t=this._scene.getEngine().getRenderWidth()/2,i=this._scene.getEngine().getRenderHeight()/2,r=this._scene.activeCamera.orthoLeft??-t,n=this._scene.activeCamera.orthoRight??t,s=this._scene.activeCamera.orthoBottom??-i,a=this._scene.activeCamera.orthoTop??i;e.setMatrix3x3("depthProjection",XC.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(n-r)),e.setFloat("yViewport",.5*(a-s))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new YC)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new jt.w("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,4725))):t.push(Promise.resolve().then(i.bind(i,31134)))})),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",s.AA.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.autoClear=!1,this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){const e=new Uint8Array(65536),t=s.I9.Zero();for(let i=0;i<e.length;)t.set((0,it.RandomRange)(0,1),(0,it.RandomRange)(0,1)).normalize().scaleInPlace(255),e[i++]=Math.floor(t.x),e[i++]=Math.floor(t.y),e[i++]=0,e[i++]=255;const i=me.I.CreateRGBATexture(e,128,128,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=_e.g.WRAP_ADDRESSMODE,i.wrapV=_e.g.WRAP_ADDRESSMODE,this._randomTexture=i}serialize(){const e=pe.p.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return pe.p.Parse((()=>new XC(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,t,i)}}XC.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],XC.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],(0,ue.Cg)([(0,de.lK)()],XC.prototype,"totalStrength",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"maxZ",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"minZAspect",void 0),(0,ue.Cg)([(0,de.lK)("epsilon")],XC.prototype,"_epsilon",void 0),(0,ue.Cg)([(0,de.lK)("samples")],XC.prototype,"_samples",void 0),(0,ue.Cg)([(0,de.lK)("textureSamples")],XC.prototype,"_textureSamples",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"_forceGeometryBuffer",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"_ratio",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"_textureType",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"radius",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"base",void 0),(0,ue.Cg)([(0,de.lK)("bypassBlur")],XC.prototype,"_bypassBlur",void 0),(0,ue.Cg)([(0,de.lK)("expensiveBlur")],XC.prototype,"_expensiveBlur",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"bilateralSamples",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"bilateralSoften",void 0),(0,ue.Cg)([(0,de.lK)()],XC.prototype,"bilateralTolerance",void 0),(0,o.Y5)("BABYLON.SSAO2RenderingPipeline",XC);ri.l.ShadersStore.ssaoPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)\n{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}\nvoid main()\n{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)\n{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}\n#endif\n";var qC=i(31134);class $C extends kC{get scene(){return this._scene}constructor(e,t,i,r){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const n=i.ssaoRatio||i,s=i.combineRatio||i;this._originalColorPostProcess=new $t.v("SSAOOriginalSceneColor",s,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(n),this._createBlurPostProcess(n),this._createSSAOCombinePostProcess(s),this.addEffect(new pC(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new pC(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new ko("BlurH",new s.I9(1,0),16,e,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new ko("BlurV",new s.I9(0,1),16,e,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new jt.w("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new jt.w("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,_e.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",s.AA.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){const e=new Uint8Array(1048576);for(let t=0;t<e.length;)e[t++]=Math.floor(255*Math.max(0,(0,it.RandomRange)(-1,1))),e[t++]=Math.floor(255*Math.max(0,(0,it.RandomRange)(-1,1))),e[t++]=Math.floor(255*Math.max(0,(0,it.RandomRange)(-1,1))),e[t++]=255;const t=me.I.CreateRGBATexture(e,512,512,this._scene,!1,!1,2);t.name="SSAORandomTexture",t.wrapU=_e.g.WRAP_ADDRESSMODE,t.wrapV=_e.g.WRAP_ADDRESSMODE,this._randomTexture=t}}(0,ue.Cg)([(0,de.lK)()],$C.prototype,"totalStrength",void 0),(0,ue.Cg)([(0,de.lK)()],$C.prototype,"radius",void 0),(0,ue.Cg)([(0,de.lK)()],$C.prototype,"area",void 0),(0,ue.Cg)([(0,de.lK)()],$C.prototype,"fallOff",void 0),(0,ue.Cg)([(0,de.lK)()],$C.prototype,"base",void 0);class jC{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}ri.l.ShadersStore.screenSpaceReflectionPixelShader="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {vec3 color;vec4 coords;};/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)\n{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)\nhitCoord-=dir;else\nhitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}\nprojectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)\n{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;\n#endif\n}}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class KC extends jt.w{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,r,n,s,a,o=0,l=!1,c=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,r,n,s,a,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",o,void 0,null,l),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=c,this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0,e.generateNormalsInWorldSpace&&f.V.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();e?.markAsDirty(),e?.generateNormalsInWorldSpace&&f.V.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new jC}this._updateEffectDefines(),this.onApply=e=>{const i=this._geometryBufferRenderer,r=this._prePassRenderer;if(!r&&!i)return;if(i){const t=i.getTextureIndex(NC.POSITION_TEXTURE_TYPE),r=i.getTextureIndex(NC.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("positionSampler",i.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",i.getGBuffer().textures[r])}else if(r){const t=r.getIndex(1),i=r.getIndex(3),n=r.getIndex(6);e.setTexture("normalSampler",r.getRenderTarget().textures[n]),e.setTexture("positionSampler",r.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",r.getRenderTarget().textures[i])}const n=t.activeCamera;if(!n)return;const s=n.getViewMatrix(!0),a=n.getProjectionMatrix(!0);e.setMatrix("projection",a),e.setMatrix("view",s),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(0|this._reflectionSamples)),e.push("#define SMOOTH_STEPS "+(0|this._smoothSteps)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,r){return pe.p.Parse((()=>new KC(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],KC.prototype,"threshold",void 0),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"strength",void 0),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"reflectionSpecularFalloffExponent",void 0),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"step",void 0),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"roughnessFactor",void 0),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"enableSmoothReflections",null),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"reflectionSamples",null),(0,ue.Cg)([(0,de.lK)()],KC.prototype,"smoothSteps",null),(0,o.Y5)("BABYLON.ScreenSpaceReflectionPostProcess",KC);ri.l.ShadersStore.standardPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}\ngl_FragColor=average;}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)\n{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)\n{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}\nvoid main(void)\n{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)\n{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}\naccumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;void main(void)\n{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];void main()\n{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)\n{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}\naverage=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];uniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)\n{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()\n{vec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;\n#endif\ngl_FragColor=color;}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)\n{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}\nfloat noise(in vec2 p)\n{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);}\nfloat fbm(vec2 p)\n{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}\nvec3 pattern(vec2 uv)\n{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}\nfloat luminance(vec3 color)\n{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{return vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);}\nvoid main(void)\n{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)\n{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}\nvec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)\n{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)\n{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)\nfactor=1.0;else if (dist<0.1)\nfactor=20.0*(0.1-dist);else if (dist<0.5)\nfactor=0.0;else\nfactor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)\n{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}\ngl_FragColor=result/float(nSamples);}\n#endif\n";class ZC extends kC{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void f.V.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,r=null,n){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=n||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=r,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new KC("HDRPass",t,e,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new pC(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new jt.w("HDRPass","standard",[],[],e,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new pC(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new jt.w("HDRDepthOfFieldSource","standard",[],[],e,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pC(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new jt.w("HDRVLSFinal","standard",[],[],e,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pC(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new jt.w("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pC(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new jt.w("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pC(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new bx("fxaa",1,null,_e.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new pC(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&f.V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new jt.w("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const r=this.downSampleX4PostProcess.width,n=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let s=-2;s<2;s++)i[t]=(e+.5)*(1/r),i[t+1]=(s+.5)*(1/n),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new pC(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new jt.w("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,r=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*r,i[2]=.5*t,i[3]=.5*r,i[4]=-.5*t,i[5]=-.5*r,i[6]=.5*t,i[7]=-.5*r,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new pC(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,i,r="blurWidth"){const n=e.getEngine(),a=new ko("HDRBlurH_"+i,new s.I9(1,0),this[r],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),o=new ko("HDRBlurV_"+i,new s.I9(0,1),this[r],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);a.onActivateObservable.add((()=>{const e=a.width/n.getRenderWidth();a.kernel=this[r]*e})),o.onActivateObservable.add((()=>{const e=o.height/n.getRenderHeight();o.kernel=this.horizontalBlur?64*e:this[r]*e})),this.addEffect(new pC(e.getEngine(),"HDRBlurH"+i,(()=>a),!0)),this.addEffect(new pC(e.getEngine(),"HDRBlurV"+i,(()=>o),!0)),this.blurHPostProcesses.push(a),this.blurVPostProcesses.push(o)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new jt.w("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new pC(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const r=i.getGBuffer();this.volumetricLightPostProcess=new jt.w("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const n=s.I9.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",r.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),n.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),n.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",n)}},this.addEffect(new pC(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new jt.w("HDRVLSMerge","standard",[],["originalSampler"],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new pC(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,ZC.LuminanceSteps);this.luminancePostProcess=new jt.w("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const r=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;r[0]=-.5*t,r[1]=.5*i,r[2]=.5*t,r[3]=.5*i,r[4]=-.5*t,r[5]=-.5*i,r[6]=.5*t,r[7]=-.5*i,e.setArray2("lumOffsets",r)},this.addEffect(new pC(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let r=ZC.LuminanceSteps-1;r>=0;r--){i=Math.pow(3,r);let n="#define LUMINANCE_DOWN_SAMPLE\n";0===r&&(n+="#define FINAL_DOWN_SAMPLER");const s=new jt.w("HDRLuminanceDownSample"+r,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,t);this.luminanceDownSamplePostProcesses.push(s)}let n=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,i)=>{const r=new Array(18);t.onApply=e=>{if(!n)return;let s=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)r[s]=e/n.width,r[s+1]=t/n.height,s+=2;e.setArray2("dsOffsets",r),e.setFloat("halfDestPixelSize",.5/n.width),n=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),i=new s.IU(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}))}),this.addEffect(new pC(e.getEngine(),"HDRLuminanceDownSample"+i,(()=>t),!0))}))}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new jt.w("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let r=1,n=0,s=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),r<0)r=this._hdrCurrentLuminance;else{const e=(s-n)/1e3;this._hdrCurrentLuminance<r+this.hdrDecreaseRate*e?r+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>r-this.hdrIncreaseRate*e?r-=this.hdrIncreaseRate*e:r=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/r:(r=(0,it.Clamp)(r,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",r)),s=n,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new pC(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new jt.w("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new pC(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new jt.w("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new pC(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const i=new s.I9(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const r=s.uq.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),n=s.uq.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2);let a=s.Pq.Dot(t.toVector3(),new s.Pq(1,0,0))+s.Pq.Dot(i.toVector3(),new s.Pq(0,0,1));a*=4;const o=s.uq.FromValues(.5*Math.cos(a),-Math.sin(a),0,0,Math.sin(a),.5*Math.cos(a),0,0,0,0,1,0,0,0,0,1),l=n.multiply(o).multiply(r);e.setMatrix("lensStarMatrix",l),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new jt.w("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new pC(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new LC("HDRMotionBlur",e,t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new jt.w("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,_e.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,r=s.uq.Identity();const n=s.uq.Identity();let a=s.uq.Identity();const o=s.I9.Zero();this.motionBlurPostProcess.onApply=t=>{a=e.getProjectionMatrix().multiply(e.getViewMatrix()),a.invertToRef(n),t.setMatrix("inverseViewProjection",n),t.setMatrix("prevViewProjection",r),r=a,o.x=this.motionBlurPostProcess.width,o.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",o),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new pC(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=pe.p.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=pe.p.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const r=pe.p.Parse((()=>new ZC(e._name,t,e._ratio)),e,t,i);return e.sourceLightId&&(r.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&pe.p.Parse((()=>r.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,i),r}}ZC.LuminanceSteps=6,(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"brightThreshold",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"blurWidth",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"horizontalBlur",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"exposure",null),(0,ue.Cg)([(0,de.uM)("lensTexture")],ZC.prototype,"lensTexture",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"volumetricLightCoefficient",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"volumetricLightPower",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"volumetricLightBlurScale",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"hdrMinimumLuminance",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"hdrDecreaseRate",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"hdrIncreaseRate",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"hdrAutoExposure",null),(0,ue.Cg)([(0,de.uM)("lensColorTexture")],ZC.prototype,"lensColorTexture",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"lensFlareStrength",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"lensFlareGhostDispersal",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"lensFlareHaloWidth",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"lensFlareDistortionStrength",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"lensFlareBlurWidth",void 0),(0,ue.Cg)([(0,de.uM)("lensStarTexture")],ZC.prototype,"lensStarTexture",void 0),(0,ue.Cg)([(0,de.uM)("lensFlareDirtTexture")],ZC.prototype,"lensFlareDirtTexture",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"depthOfFieldDistance",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"depthOfFieldBlurWidth",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"motionStrength",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"objectBasedMotionBlur",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"_ratio",void 0),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"BloomEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"DepthOfFieldEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"LensFlareEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"HDREnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"VLSEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"MotionBlurEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"fxaaEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"screenSpaceReflectionsEnabled",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"volumetricLightStepsCount",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"motionBlurSamples",null),(0,ue.Cg)([(0,de.lK)()],ZC.prototype,"samples",null),(0,o.Y5)("BABYLON.StandardRenderingPipeline",ZC);class QC{constructor(e=!1){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3],this.texturesRequired.push(e?10:5)}}const JC=s.uq.Compose(new s.Pq(.5,.5,.5),s.PT.Identity(),new s.Pq(.5,.5,.5)),eb=s.uq.Compose(new s.Pq(.5,.5,1),s.PT.Identity(),new s.Pq(.5,.5,0));class tb extends kC{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,r=!1,n=0,s=!1){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._useScreenspaceDepth=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=n,this._forceGeometryBuffer=r,this._useScreenspaceDepth=s,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0,e.enableScreenspaceDepth=this._useScreenspaceDepth,e.enableDepth=!this._useScreenspaceDepth)}else{const e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty())}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){const e=this._scene.getEngine(),t=this._prePassRenderer;let i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){const e=t.getRenderTarget();e&&e.textures&&(i=e.textures[t.getIndex(4)].getSize())}else this._ssrPostProcess?.inputTexture&&(i.width=this._ssrPostProcess.inputTexture.width,i.height=this._ssrPostProcess.inputTexture.height);return i}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._useScreenspaceDepth&&e.push("#define SSRAYTRACE_SCREENSPACE_DEPTH"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),(this._geometryBufferRenderer?.generateNormalsInWorldSpace??this._prePassRenderer?.generateNormalsInWorldSpace)&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._geometryBufferRenderer?.normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL");const t=this._cameras?.[0];t&&1===t.mode&&e.push("#define ORTHOGRAPHIC_CAMERA"),this._ssrPostProcess?.updateEffect(e.join("\n"))}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const e=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const e=this._cameras?.[0];e&&(this._depthRendererCamera=e,this._depthRenderer=new ph(this._scene,void 0,void 0,this._useScreenspaceDepth,1,!this._useScreenspaceDepth,"SSRBackDepth"),this._useScreenspaceDepth||(this._depthRenderer.clearColor.r=1e8),this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),e.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new pC(e,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new pC(e,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new pC(e,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),r=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));t.width===i&&t.height===r||this._depthRenderer.getDepthMap().resize({width:i,height:r})}_disposeDepthRenderer(){if(this._depthRenderer){if(this._depthRendererCamera){const e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap())??-1;-1!==e&&this._depthRendererCamera.customRenderTargets.splice(e,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._ssrPostProcess?.dispose(t),this._blurPostProcessX?.dispose(t),this._blurPostProcessY?.dispose(t),this._blurCombinerPostProcess?.dispose(t)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new jt.w("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","farPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,66707))):t.push(Promise.resolve().then(i.bind(i,27902)))})),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const i=t.getTextureIndex(NC.REFLECTIVITY_TEXTURE_TYPE),r=t.getTextureIndex(NC.NORMAL_TEXTURE_TYPE);if(e.setTexture("normalSampler",t.getGBuffer().textures[r]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this._useScreenspaceDepth){const i=t.getTextureIndex(NC.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else{const i=t.getTextureIndex(NC.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}}else if(i){const t=i.getIndex(this._useScreenspaceDepth?10:5),r=i.getIndex(3),n=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[n]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[r])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));const r=this._scene.activeCamera;if(!r)return;const n=r.getViewMatrix(),a=r.getProjectionMatrix();a.invertToRef(s.AA.Matrix[0]),n.invertToRef(s.AA.Matrix[1]),e.setMatrix("projection",a),e.setMatrix("view",n),e.setMatrix("invView",s.AA.Matrix[1]),e.setMatrix("invProjectionMatrix",s.AA.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",r.minZ),e.setFloat("farPlaneZ",r.maxZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);const o=this._getTextureSize();s.uq.ScalingToRef(o.width,o.height,1,s.AA.Matrix[2]),a.multiplyToRef(this._scene.getEngine().isWebGPU?eb:JC,s.AA.Matrix[3]),s.AA.Matrix[3].multiplyToRef(s.AA.Matrix[2],s.AA.Matrix[4]),e.setMatrix("projectionPixel",s.AA.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new QC(this._useScreenspaceDepth))}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new jt.w("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,74700))):t.push(Promise.resolve().then(i.bind(i,7953)))})),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((e=>{const t=this._blurPostProcessX?.inputTexture.width??this._scene.getEngine().getRenderWidth();e.setFloat2("texelOffsetScale",this._blurDispersionStrength/t,0)})),this._blurPostProcessY=new jt.w("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,74700))):t.push(Promise.resolve().then(i.bind(i,7953)))})),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((e=>{const t=this._blurPostProcessY?.inputTexture.height??this._scene.getEngine().getRenderHeight();e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/t)}));const t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],r=["textureSampler","mainSampler","reflectivitySampler"];let n="";this._debug&&(n+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(n+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(n+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this.useFresnel&&(n+="#define SSR_BLEND_WITH_FRESNEL\n",t.push("projection","invProjectionMatrix","nearPlaneZ","farPlaneZ"),r.push("depthSampler","normalSampler")),this._useScreenspaceDepth&&(n+="#define SSRAYTRACE_SCREENSPACE_DEPTH"),0===this._reflectivityThreshold&&(n+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new jt.w("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,r,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,n,this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,99491))):t.push(Promise.resolve().then(i.bind(i,48746)))})),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(i||t){if(i&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){const t=i.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[i.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(t){const i=t.getTextureIndex(NC.REFLECTIVITY_TEXTURE_TYPE);if(e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this.useFresnel){const i=this._scene.activeCamera;if(i&&this._useScreenspaceDepth&&(e.setFloat("nearPlaneZ",i.minZ),e.setFloat("farPlaneZ",i.maxZ)),e.setTexture("normalSampler",t.getGBuffer().textures[1]),this._useScreenspaceDepth){const i=t.getTextureIndex(NC.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else e.setTexture("depthSampler",t.getGBuffer().textures[0])}}else if(i){const t=i.getIndex(3);if(e.setTexture("reflectivitySampler",i.getRenderTarget().textures[t]),this.useFresnel){const t=this._scene.activeCamera;t&&this._useScreenspaceDepth&&(e.setFloat("nearPlaneZ",t.minZ),e.setFloat("farPlaneZ",t.maxZ));const r=i.getIndex(this._useScreenspaceDepth?10:5),n=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[n]),e.setTexture("depthSampler",i.getRenderTarget().textures[r])}}if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){const t=this._scene.activeCamera;if(t){const i=t.getProjectionMatrix();i.invertToRef(s.AA.Matrix[0]),e.setMatrix("projection",i),e.setMatrix("invProjectionMatrix",s.AA.Matrix[0])}}}}))}serialize(){const e=pe.p.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return pe.p.Parse((()=>new tb(e._name,t,e._ratio)),e,t,i)}}(0,ue.Cg)([(0,de.lK)()],tb.prototype,"samples",null),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"maxDistance",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"step",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"thickness",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"strength",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"reflectionSpecularFalloffExponent",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"maxSteps",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"roughnessFactor",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"selfCollisionNumSkip",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"_reflectivityThreshold",void 0),(0,ue.Cg)([(0,de.lK)("_ssrDownsample")],tb.prototype,"_ssrDownsample",void 0),(0,ue.Cg)([(0,de.lK)()],tb.prototype,"ssrDownsample",null),(0,ue.Cg)([(0,de.lK)("blurDispersionStrength")],tb.prototype,"_blurDispersionStrength",void 0),(0,ue.Cg)([(0,de.lK)("blurDownsample")],tb.prototype,"_blurDownsample",void 0),(0,ue.Cg)([(0,de.lK)("enableSmoothReflections")],tb.prototype,"_enableSmoothReflections",void 0),(0,ue.Cg)([(0,de.lK)("environmentTexture")],tb.prototype,"_environmentTexture",void 0),(0,ue.Cg)([(0,de.lK)("environmentTextureIsProbe")],tb.prototype,"_environmentTextureIsProbe",void 0),(0,ue.Cg)([(0,de.lK)("attenuateScreenBorders")],tb.prototype,"_attenuateScreenBorders",void 0),(0,ue.Cg)([(0,de.lK)("attenuateIntersectionDistance")],tb.prototype,"_attenuateIntersectionDistance",void 0),(0,ue.Cg)([(0,de.lK)("attenuateIntersectionIterations")],tb.prototype,"_attenuateIntersectionIterations",void 0),(0,ue.Cg)([(0,de.lK)("attenuateFacingCamera")],tb.prototype,"_attenuateFacingCamera",void 0),(0,ue.Cg)([(0,de.lK)("attenuateBackfaceReflection")],tb.prototype,"_attenuateBackfaceReflection",void 0),(0,ue.Cg)([(0,de.lK)("clipToFrustum")],tb.prototype,"_clipToFrustum",void 0),(0,ue.Cg)([(0,de.lK)("useFresnel")],tb.prototype,"_useFresnel",void 0),(0,ue.Cg)([(0,de.lK)("enableAutomaticThicknessComputation")],tb.prototype,"_enableAutomaticThicknessComputation",void 0),(0,ue.Cg)([(0,de.lK)("backfaceDepthTextureDownsample")],tb.prototype,"_backfaceDepthTextureDownsample",void 0),(0,ue.Cg)([(0,de.lK)("backfaceForceDepthWriteTransparentMeshes")],tb.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),(0,ue.Cg)([(0,de.lK)("isEnabled")],tb.prototype,"_isEnabled",void 0),(0,ue.Cg)([(0,de.lK)("inputTextureColorIsInGammaSpace")],tb.prototype,"_inputTextureColorIsInGammaSpace",void 0),(0,ue.Cg)([(0,de.lK)("generateOutputInGammaSpace")],tb.prototype,"_generateOutputInGammaSpace",void 0),(0,ue.Cg)([(0,de.lK)("debug")],tb.prototype,"_debug",void 0),(0,o.Y5)("BABYLON.SSRRenderingPipeline",tb);class ib extends kC{set samples(e){this._taaThinPostProcess.samples=e}get samples(){return this._taaThinPostProcess.samples}set msaaSamples(e){this._msaaSamples!==e&&(this._msaaSamples=e,this._taaPostProcess&&(this._taaPostProcess.samples=e))}get msaaSamples(){return this._msaaSamples}get factor(){return this._taaThinPostProcess.factor}set factor(e){this._taaThinPostProcess.factor=e}get disableOnCameraMove(){return this._taaThinPostProcess.disableOnCameraMove}set disableOnCameraMove(e){this._taaThinPostProcess.disableOnCameraMove=e}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&(this._taaThinPostProcess._reset(),this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras))):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get scene(){return this._scene}get isSupported(){return this._scene.getEngine().getCaps().texelFetch}constructor(e,t,i,r=0){const n=t.getEngine();super(n,e),this.TAARenderEffect="TAARenderEffect",this.TAAPassEffect="TAAPassEffect",this._msaaSamples=1,this._isEnabled=!0,this._isDirty=!1,this._camerasToBeAttached=[],this._pingpong=0,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._taaThinPostProcess=new Qa("TAA",this._scene.getEngine()),this.isSupported&&(this._createPingPongTextures(n.getRenderWidth(),n.getRenderHeight()),t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline())}getClassName(){return"TAARenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._ping.dispose(),this._pong.dispose(),super.dispose()}_createPingPongTextures(e,t){const i=this._scene.getEngine();this._ping?.dispose(),this._pong?.dispose(),this._ping=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._pong=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._taaThinPostProcess.textureWidth=e,this._taaThinPostProcess.textureHeight=t}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const e=this._scene.getEngine();this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._createTAAPostProcess(),this.addEffect(new pC(e,this.TAARenderEffect,(()=>this._taaPostProcess),!0)),this._createPassPostProcess(),this.addEffect(new pC(e,this.TAAPassEffect,(()=>this._passPostProcess),!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._taaPostProcess?.dispose(t),this._passPostProcess?.dispose(t),t.getProjectionMatrix(!0)}this._taaPostProcess=null,this._passPostProcess=null}_createTAAPostProcess(){this._taaPostProcess=new jt.w("TAA","taa",{uniforms:["factor"],samplers:["historySampler"],size:1,engine:this._scene.getEngine(),textureType:this._textureType,effectWrapper:this._taaThinPostProcess}),this._taaPostProcess.samples=this._msaaSamples,this._taaPostProcess.onActivateObservable.add((()=>{if(this._taaThinPostProcess.camera=this._scene.activeCamera,this._taaPostProcess?.width!==this._ping.width||this._taaPostProcess?.height!==this._ping.height){const e=this._scene.getEngine();this._createPingPongTextures(e.getRenderWidth(),e.getRenderHeight())}this._taaThinPostProcess.updateProjectionMatrix(),this._passPostProcess&&(this._passPostProcess.inputTexture=this._pingpong?this._ping:this._pong),this._pingpong=1^this._pingpong})),this._taaPostProcess.onApplyObservable.add((e=>{e._bindTexture("historySampler",this._pingpong?this._ping.texture:this._pong.texture)}))}_createPassPostProcess(){const e=this._scene.getEngine();this._passPostProcess=new $t.v("TAAPass",1,null,1,e),this._passPostProcess.inputTexture=this._ping,this._passPostProcess.autoClear=!1}serialize(){const e=pe.p.Serialize(this);return e.customType="TAARenderingPipeline",e}static Parse(e,t,i){return pe.p.Parse((()=>new ib(e._name,t,e._ratio)),e,t,i)}}(0,ue.Cg)([(0,de.lK)("samples")],ib.prototype,"samples",null),(0,ue.Cg)([(0,de.lK)("msaaSamples")],ib.prototype,"_msaaSamples",void 0),(0,ue.Cg)([(0,de.lK)()],ib.prototype,"factor",null),(0,ue.Cg)([(0,de.lK)()],ib.prototype,"disableOnCameraMove",null),(0,ue.Cg)([(0,de.lK)("isEnabled")],ib.prototype,"_isEnabled",void 0),(0,o.Y5)("BABYLON.TAARenderingPipeline",ib);var rb,nb=i(30327),sb=i(37152),ab=i(4725),ob=i(27902),lb=i(7953),cb=i(48746),hb=i(66707),ub=i(74700),db=i(99491);i(37489),i(6422),function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(rb||(rb={}));class pb extends jt.w{getClassName(){return"TonemapPostProcess"}constructor(e,t,i,r,n=2,s,a=0,o){super(e,"tonemap",["_ExposureAdjustment"],null,1,r,n,s,o,null,a),this._operator=t,this.exposureAdjustment=i;let l="#define ";0===this._operator?l+="HABLE_TONEMAPPING":1===this._operator?l+="REINHARD_TONEMAPPING":2===this._operator?l+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":3===this._operator&&(l+="PHOTOGRAPHIC_TONEMAPPING"),this.updateEffect(l),this.onApply=e=>{e.setFloat("_ExposureAdjustment",this.exposureAdjustment)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,85790))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,44053))])),super._gatherImports(e,t)}}ri.l.ShadersStore.volumetricLightScatteringPixelShader="uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}\nvec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),realColor.a))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n",i(28939),i(75159);ri.l.ShadersStore.volumetricLightScatteringPassVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";ri.l.ShadersStore.volumetricLightScatteringPassPixelShader="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);}\n";class fb extends jt.w{get useDiffuseColor(){return f.V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){f.V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,r,n=100,a=_e.g.BILINEAR_SAMPLINGMODE,o,l,c){super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,a,o,l,"#define NUM_SAMPLES "+n),this._screenCoordinates=s.I9.Zero(),this.customMeshPosition=s.Pq.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,o=(c=i?.getScene()??c??this._scene).getEngine(),this._viewPort=new ii.L(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),this.mesh=r??fb.CreateDefaultMesh("VolumetricLightScatteringMesh",c),this._createPass(c,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(c),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){const i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);const r=i._internalAbstractMeshDataInfo._materialForRenderPass?.[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(i,e,t);const n=[],s=[Ue.R.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&n.push("#define ALPHATEST"),i.isVerticesDataPresent(Ue.R.UVKind)&&(s.push(Ue.R.UVKind),n.push("#define UV1")),i.isVerticesDataPresent(Ue.R.UV2Kind)&&(s.push(Ue.R.UV2Kind),n.push("#define UV2")));const o=new Yo.J;if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){s.push(Ue.R.MatricesIndicesKind),s.push(Ue.R.MatricesWeightsKind),i.numBoneInfluencers>4&&(s.push(Ue.R.MatricesIndicesExtraKind),s.push(Ue.R.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),i.numBoneInfluencers>0&&o.addCPUSkinningFallback(0,i);const e=i.skeleton;e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");const l=i.morphTargetManager;let c=0;l&&(c=l.numMaxInfluencers||l.numInfluencers,c>0&&(n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+c),l.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),(0,qo.MF)(s,i,c))),t&&(n.push("#define INSTANCES"),(0,qo.te)(s),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const h=i.bakedVertexAnimationManager;h&&h.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&s.push("bakedVertexAnimationSettingsInstanced"));const u=e._getDrawWrapper(void 0,!0),d=u.defines,p=n.join("\n");if(d!==p){const e=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];u.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",{attributes:s,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:p,fallbacks:o,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:c}},i.getScene().getEngine()),p)}return u.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Si.$("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=_e.g.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=_e.g.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const r=this.getCamera();r?r.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const n=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh();if(this._meshExcluded(t))return;i._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const r=e.getMaterial();if(!r)return;const n=t.getScene(),s=n.getEngine();s.setState(r.backFaceCulling,void 0,void 0,void 0,r.cullBackFaces);const a=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const o=s.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||t.hasThinInstances);if(this._isReady(e,o)){const l=i._internalAbstractMeshDataInfo._materialForRenderPass?.[s.currentRenderPassId];let c=e._getDrawWrapper();if(t!==this.mesh||c||(c=r._getDrawWrapper()),!c)return;const h=c.effect;if(s.enableEffect(c),o||t._bind(e,h,r.fillMode),t===this.mesh)r.bind(i.getWorldMatrix(),t);else if(l)l.bindForSubMesh(i.getWorldMatrix(),i,e);else{if(h.setMatrix("viewProjection",n.getTransformMatrix()),r.needAlphaTesting()){const e=r.getAlphaTestTexture();e&&(h.setTexture("diffuseSampler",e),h.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,qo.f$)(t,h),(0,qo.nR)(t,h),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(h);const i=e.getMesh().bakedVertexAnimationManager;i&&i.isEnabled&&i.bind(h,o)}o&&t.hasThinInstances&&h.setMatrix("world",i.getWorldMatrix()),t._processRendering(i,e,h,Zl.i.TriangleFillMode,a,o,((e,t)=>{e||h.setMatrix("world",t)}))}};let s;const o=new a.ov(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{s=e.clearColor,e.clearColor=o})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=s})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,r)=>{if((r||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const r=e.subMeshes[t],n=r.getMaterial(),s=r.getRenderingMesh();if(!n)continue;const a=s._getInstancesRenderList(r._id,!!r.getReplacementMesh()),o=i.getCaps().instancedArrays&&(null!==a.visibleInstances[r._id]||s.hasThinInstances);if(!this._isReady(r,o))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,r,s)=>{const a=e.getEngine();let o;if(s.length){for(a.setColorWrite(!1),o=0;o<s.length;o++)n(s.data[o]);a.setColorWrite(!0)}for(o=0;o<t.length;o++)n(t.data[o]);for(o=0;o<i.length;o++)n(i.data[o]);if(r.length){for(o=0;o<r.length;o++){const t=r.data[o],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=r.data.slice(0,r.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),a.setAlphaMode(2),o=0;o<t.length;o++)n(t[o]);a.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const r=s.Pq.Project(i,s.uq.Identity(),t,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=(0,xo.x)(e,{size:1},t);i.billboardMode=Er.u.BILLBOARDMODE_ALL;const r=new Oi.F(e+"Material",t);return r.emissiveColor=new a.v9(1,1,1),i.material=r,i}}(0,ue.Cg)([(0,de.P_)()],fb.prototype,"customMeshPosition",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"useCustomMeshPosition",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"invert",void 0),(0,ue.Cg)([(0,de.xG)()],fb.prototype,"mesh",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"excludedMeshes",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"includedMeshes",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"exposure",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"decay",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"weight",void 0),(0,ue.Cg)([(0,de.lK)()],fb.prototype,"density",void 0),(0,o.Y5)("BABYLON.VolumetricLightScatteringPostProcess",fb);ri.l.ShadersStore.screenSpaceCurvaturePixelShader="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{if (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);return 0.25/control;}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}";class mb extends jt.w{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,r,n,s,a,o=0,l=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,r,n,s,a,void 0,o,void 0,null,l),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&f.V.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}):f.V.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=P.q.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,r){return pe.p.Parse((()=>new mb(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,r)}}(0,ue.Cg)([(0,de.lK)()],mb.prototype,"ridge",void 0),(0,ue.Cg)([(0,de.lK)()],mb.prototype,"valley",void 0),(0,o.Y5)("BABYLON.ScreenSpaceCurvaturePostProcess",mb);var _b=i(31856),gb=i(30535),vb=i(27905),Sb=i(27627),xb=i(17374),Tb=i(40932),Eb=i(38752),Cb=i(18691),bb=i(35385),Pb=i(70542),yb=i(18842),Ab=i(68479),Rb=i(55898),Ib=i(16213),Mb=i(96841),Ob=i(29494),Nb=i(45221),Db=i(80223),Fb=i(4151),Lb=i(96340),wb=i(56650),Bb=i(61565),Vb=i(7180),kb=i(96561),Gb=i(91991),Ub=i(81192),zb=i(24295),Wb=i(73697),Hb=i(72358),Yb=i(34444),Xb=i(43816),qb=i(34203),$b=i(59527),jb=i(42054),Kb=i(66229),Zb=i(15062),Qb=i(48146),Jb=i(41993),eP=i(14018),tP=i(11071),iP=i(25197),rP=i(77572),nP=i(85676),sP=i(7749),aP=i(14674),oP=i(52361),lP=i(44053),cP=i(85790),hP=i(87733);kt.Z.prototype.enableDepthRenderer=function(e,t=!1,i=!1,r=3,n=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){const s=!!this.getEngine().getCaps().textureFloatRender;let a=0;a=!this.getEngine().getCaps().textureHalfFloatRender||i&&s?s?1:0:2,this._depthRenderer[e.id]=new ph(this,a,e,t,r,n)}return this._depthRenderer[e.id]},kt.Z.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class uP{constructor(e){this.name=Gt.v.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Gt.v.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Gt.v.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}ph._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_DEPTHRENDERER);t||(t=new uP(e),e._addComponent(t))};class dP{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class pP{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new Sr.L(10),this._excludedSubMeshes=new Sr.L(10),this._excludedMeshes=[],this._colorCache=[new a.ov(pP._DEPTH_CLEAR_VALUE,pP._DEPTH_CLEAR_VALUE,0,0),new a.ov(-pP._MIN_DEPTH,pP._MAX_DEPTH,0,0),new a.ov(0,0,0,0)],this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._passCount=t,e.enablePrePassRenderer()){for(let e=0;e<this._layoutCacheFormat.length;++e)this._layoutCache[e]=this._engine.buildTextureLayout(this._layoutCacheFormat[e]);this._renderPassIds=[],this.useRenderPasses=!1,this._engine.isWebGPU&&(this._shaderLanguage=1),this._prePassEffectConfiguration=new dP,this._createTextures(),this._createEffects()}else f.V.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.")}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new td("depthPeelingDepth0MRT",e,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new td("depthPeelingDepth1MRT",e,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new td("depthPeelingColor0MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new td("depthPeelingColor1MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new td("depthPeelingBackMRT",e,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new Si.$("depthPeelingOutputRTT",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let i=0;i<2;i++){const r=this._engine._createInternalTexture(e,t[0],!1),n=this._engine._createInternalTexture(e,t[1],!1),s=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(r,0),this._depthMrts[i].setInternalTexture(n,1),this._depthMrts[i].setInternalTexture(s,2),this._colorMrts[i].setInternalTexture(n,0),this._colorMrts[i].setInternalTexture(s,1),this._thinTextures.push(new ud.D(r),new ud.D(n),new ud.D(s))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)6!==e&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return this._depthMrts[0].getSize().width===this._engine.getRenderWidth()&&this._depthMrts[0].getSize().height===this._engine.getRenderHeight()||(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){const e=this._scene.prePassRenderer;if(!e)return!1;const t=e.getIndex(4),i=e.defaultRT.textures?.length?e.defaultRT.textures[t].getInternalTexture():null;return!!i&&(this._blendBackTexture!==i&&(this._blendBackTexture=i,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new ud.D(this._blendBackTexture),e.defaultRT.renderTarget.shareDepth(this._depthMrts[0].renderTarget)),!0)}_createEffects(){this._blendBackEffectWrapper=new Ks.$({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,58540)):await Promise.resolve().then(i.bind(i,47509))}}),this._blendBackEffectWrapperPingPong=new Ks.$({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,58540)):await Promise.resolve().then(i.bind(i,47509))}}),this._finalEffectWrapper=new Ks.$({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,66930)):await Promise.resolve().then(i.bind(i,35075))}}),this._effectRenderer=new Ks.J(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[3*this._currentPingPongState]),e.setTexture("oitFrontColorSampler",this._thinTextures[3*this._currentPingPongState+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const r=e.data[i].getMaterial();let n=!0,s=!1;const a=e.data[i];let o,l=!1;if(this._useRenderPasses&&(o=a._getDrawWrapper(),l=!o),r&&(n=r.allowShaderHotSwapping,s=r.backFaceCulling,r.allowShaderHotSwapping=!1,r.backFaceCulling=!1),a.render(!1),l&&(o=a._getDrawWrapper(),o.materialContext)){let e=t[o.materialContext.uniqueId];e||(e=t[o.materialContext.uniqueId]=this._engine.createMaterialContext()),a._getDrawWrapper().materialContext=e}r&&(r.allowShaderHotSwapping=n,r.backFaceCulling=s)}}_finalCompose(e){const t=this._scene.prePassRenderer?.setCustomOutput(this._outputRT);t?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper.drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[3*e+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let t=0;t<e.length;t++){const i=e.data[t],r=i.getMaterial(),n=r&&i.getRenderingMesh()._getRenderingFillMode(r.fillMode);!r||n!==Zl.i.TriangleFanDrawMode&&n!==Zl.i.TriangleFillMode&&n!==Zl.i.TriangleStripDrawMode||-1!==this._excludedMeshes.indexOf(i.getMesh().uniqueId)?this._excludedSubMeshes.push(i):this._candidateSubMeshes.push(i)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,r=0;for(let e=0;e<this._passCount;e++){i=e%2,r=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[e+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const t=0!==r&&this._useRenderPasses?this._blendBackEffectWrapperPingPong:this._blendBackEffectWrapper;this._engine.enableEffect(t.drawWrapper),t.effect.setTexture("uBackColor",this._thinTextures[3*r+2]),this._effectRenderer.render(t),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(r),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}pP._DEPTH_CLEAR_VALUE=-99999,pP._MIN_DEPTH=0,pP._MAX_DEPTH=1,Object.defineProperty(kt.Z.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let e=this._getComponent(Gt.v.NAME_DEPTHPEELINGRENDERER);e||(e=new fP(this),this._addComponent(e))}return this._depthPeelingRenderer},set:function(e){this._depthPeelingRenderer=e},enumerable:!0,configurable:!0}),Object.defineProperty(kt.Z.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(e){this._useOrderIndependentTransparency!==e&&(this._useOrderIndependentTransparency=e,this.markAllMaterialsAsDirty(63),this.prePassRenderer?.markAsDirty())},enumerable:!0,configurable:!0});class fP{constructor(e){this.name=Gt.v.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new pP(e)}register(){}rebuild(){}dispose(){this.scene.depthPeelingRenderer?.dispose(),this.scene.depthPeelingRenderer=null}}Er.u.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},Er.u.prototype.enableEdgesRendering=function(e=.95,t=!1,i){return this.disableEdgesRendering(),this._edgesRenderer=new _P(this,e,t,!0,i),this},Object.defineProperty(Er.u.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),N_.l.prototype.enableEdgesRendering=function(e=.95,t=!1){return this.disableEdgesRendering(),this._edgesRenderer=new gP(this,e,t),this},N_.Q.prototype.enableEdgesRendering=function(e=.95,t=!1){return N_.l.prototype.enableEdgesRendering.apply(this,arguments),this};class mP{constructor(){this.edges=[],this.edgesConnectedCount=0}}class _P{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e,t){if(!e._edgeRenderLineShader){const r=new ir.B("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"],uniformBuffers:["Scene","Mesh"],shaderLanguage:t,extraInitializationsAsync:async()=>{1===t?await Promise.all([Promise.resolve().then(i.bind(i,88034)),Promise.resolve().then(i.bind(i,16996))]):await Promise.all([Promise.resolve().then(i.bind(i,64151)),Promise.resolve().then(i.bind(i,83833))])}},!1);r.disableDepthWrite=!0,r.backFaceCulling=!1,r.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=r}return e._edgeRenderLineShader}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=.95,i=!1,r=!0,n){this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new Sr.L(32),this._shaderLanguage=0,this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=n??null,this._epsilon=t;const s=this._source.getScene().getEngine();s.isWebGPU&&(this._drawWrapper=new ec.E(s),this._shaderLanguage=1),this._prepareRessources(),r&&(n?.useAlternateEdgeFinder??1?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add((()=>{this._rebuild()})),this._meshDisposeObserver=this._source.onDisposeObservable.add((()=>{this.dispose()}))}_prepareRessources(){this._lineShader||(this._lineShader=_P._GetShader(this._source.getScene(),this._shaderLanguage))}_rebuild(){let e=this._buffers[Ue.R.PositionKind];e&&e._rebuild(),e=this._buffers[Ue.R.NormalKind],e&&e._rebuild();const t=this._source.getScene().getEngine();this._ib=t.createIndexBuffer(this._linesIndices)}dispose(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let e=this._buffers[Ue.R.PositionKind];e&&(e.dispose(),this._buffers[Ue.R.PositionKind]=null),e=this._buffers[Ue.R.NormalKind],e&&(e.dispose(),this._buffers[Ue.R.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),this._drawWrapper?.dispose()}_processEdgeForAdjacencies(e,t,i,r,n){return e===i&&t===r||e===r&&t===i?0:e===r&&t===n||e===n&&t===r?1:e===n&&t===i||e===i&&t===n?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,n){const s=1e-10;return e.equalsWithEpsilon(i,s)&&t.equalsWithEpsilon(r,s)||e.equalsWithEpsilon(r,s)&&t.equalsWithEpsilon(i,s)?0:e.equalsWithEpsilon(r,s)&&t.equalsWithEpsilon(n,s)||e.equalsWithEpsilon(n,s)&&t.equalsWithEpsilon(r,s)?1:e.equalsWithEpsilon(n,s)&&t.equalsWithEpsilon(i,s)||e.equalsWithEpsilon(i,s)&&t.equalsWithEpsilon(n,s)?2:-1}_checkEdge(e,t,i,r,n){let a;a=void 0===t||s.Pq.Dot(i[e],i[t])<this._epsilon,a&&this.createLine(r,n,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){const n=(e,t,i)=>{i>=0&&t.push(i);for(let i=0;i<e.length;++i)t.push(e[i][0])};let s=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?s=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(s=2);for(let t=0;t<3;++t)t===s?e[t].sort(((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0)):e[t].sort(((e,t)=>e[1]>t[1]?-1:e[1]<t[1]?1:0));const a=[],o=[];n(e[s],a,-1);const l=a.length;for(let a=s+2;a>=s+1;--a)n(e[a%3],o,a!==s+2?r[i[t+(a+1)%3]]:-1);const c=o.length;i.push(r[i[t+s]],a[0],o[0]),i.push(r[i[t+(s+1)%3]],o[c-1],a[l-1]);const h=l<=c,u=h?l:c,d=h?c:l,p=h?l-1:c-1,f=h?0:1;let m=l+c-2,_=0,g=0;const v=h?a:o,S=h?o:a;let x=0;for(;m-- >0;){let e;f?i.push(v[_],S[g]):i.push(S[g],v[_]),x+=u,x>=d&&_<p?(e=v[++_],x-=d):e=S[++g],i.push(e)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){const e=this._source.getVerticesData(Ue.R.PositionKind);let t=this._source.getIndices();if(!t||!e)return;Array.isArray(t)||(t=Array.from(t));const i=this._options?.useFastVertexMerger??!0,r=i?Math.round(-Math.log(this._options?.epsilonVertexMerge??1e-6)/Math.log(10)):this._options?.epsilonVertexMerge??1e-6,n=[],a=[];if(i){const t={};for(let i=0;i<e.length;i+=3){const s=e[i+0],o=e[i+1],l=e[i+2],c=s.toFixed(r)+"|"+o.toFixed(r)+"|"+l.toFixed(r);if(void 0!==t[c])n.push(t[c]);else{const e=i/3;t[c]=e,n.push(e),a.push(e)}}}else for(let t=0;t<e.length;t+=3){const i=e[t+0],s=e[t+1],o=e[t+2];let l=!1;for(let a=0;a<t&&!l;a+=3){const t=e[a+0],c=e[a+1],h=e[a+2];if(Math.abs(i-t)<r&&Math.abs(s-c)<r&&Math.abs(o-h)<r){n.push(a/3),l=!0;break}}l||(n.push(t/3),a.push(t/3))}if(this._options?.applyTessellation){const i=this._options?.epsilonVertexAligned??1e-6,r=[];for(let s=0;s<t.length;s+=3){let o;for(let l=0;l<3;++l){const c=n[t[s+l]],h=n[t[s+(l+1)%3]],u=n[t[s+(l+2)%3]];if(c===h)continue;const d=e[3*c+0],p=e[3*c+1],f=e[3*c+2],m=e[3*h+0],_=e[3*h+1],g=e[3*h+2],v=Math.sqrt((m-d)*(m-d)+(_-p)*(_-p)+(g-f)*(g-f));for(let t=0;t<a.length-1;t++){const n=a[t];if(n===c||n===h||n===u)continue;const S=e[3*n+0],x=e[3*n+1],T=e[3*n+2],E=Math.sqrt((S-d)*(S-d)+(x-p)*(x-p)+(T-f)*(T-f)),C=Math.sqrt((S-m)*(S-m)+(x-_)*(x-_)+(T-g)*(T-g));Math.abs(E+C-v)<i&&(o||(o={index:s,edgesPoints:[[],[],[]]},r.push(o)),o.edgesPoints[l].push([n,E]))}}}for(let e=0;e<r.length;++e){const i=r[e];this._tessellateTriangle(i.edgesPoints,i.index,t,n)}r.length=0}const o={};for(let i=0;i<t.length;i+=3){let r;for(let a=0;a<3;++a){let l=n[t[i+a]],c=n[t[i+(a+1)%3]];const h=n[t[i+(a+2)%3]];if(l===c||(l===h||c===h)&&this._options?.removeDegeneratedTriangles)continue;if(s.AA.Vector3[0].copyFromFloats(e[3*l+0],e[3*l+1],e[3*l+2]),s.AA.Vector3[1].copyFromFloats(e[3*c+0],e[3*c+1],e[3*c+2]),s.AA.Vector3[2].copyFromFloats(e[3*h+0],e[3*h+1],e[3*h+2]),r||(s.AA.Vector3[1].subtractToRef(s.AA.Vector3[0],s.AA.Vector3[3]),s.AA.Vector3[2].subtractToRef(s.AA.Vector3[1],s.AA.Vector3[4]),r=s.Pq.Cross(s.AA.Vector3[3],s.AA.Vector3[4]),r.normalize()),l>c){const e=l;l=c,c=e}const u=l+"_"+c,d=o[u];d?d.done||(s.Pq.Dot(r,d.normal)<this._epsilon&&this.createLine(s.AA.Vector3[0],s.AA.Vector3[1],this._linesPositions.length/3),d.done=!0):o[u]={normal:r,done:!1,index:i,i:a}}}for(const i in o){const r=o[i];if(!r.done){const i=n[t[r.index+r.i]],a=n[t[r.index+(r.i+1)%3]];s.AA.Vector3[0].copyFromFloats(e[3*i+0],e[3*i+1],e[3*i+2]),s.AA.Vector3[1].copyFromFloats(e[3*a+0],e[3*a+1],e[3*a+2]),this.createLine(s.AA.Vector3[0],s.AA.Vector3[1],this._linesPositions.length/3)}}const l=this._source.getScene().getEngine();this._buffers[Ue.R.PositionKind]=new Ue.R(l,this._linesPositions,Ue.R.PositionKind,!1),this._buffers[Ue.R.NormalKind]=new Ue.R(l,this._linesNormals,Ue.R.NormalKind,!1,!1,4),this._buffersForInstances[Ue.R.PositionKind]=this._buffers[Ue.R.PositionKind],this._buffersForInstances[Ue.R.NormalKind]=this._buffers[Ue.R.NormalKind],this._ib=l.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(Ue.R.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=[],r=[];let n,a;for(n=0;n<t.length;n+=3){a=new mP;const o=t[n],l=t[n+1],c=t[n+2];a.p0=new s.Pq(e[3*o],e[3*o+1],e[3*o+2]),a.p1=new s.Pq(e[3*l],e[3*l+1],e[3*l+2]),a.p2=new s.Pq(e[3*c],e[3*c+1],e[3*c+2]);const h=s.Pq.Cross(a.p1.subtract(a.p0),a.p2.subtract(a.p1));h.normalize(),r.push(h),i.push(a)}for(n=0;n<i.length;n++){a=i[n];for(let e=n+1;e<i.length;e++){const r=i[e];if(3===a.edgesConnectedCount)break;if(3===r.edgesConnectedCount)continue;const s=t[3*e],o=t[3*e+1],l=t[3*e+2];for(let i=0;i<3;i++){let c=0;if(void 0===a.edges[i]){switch(i){case 0:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(a.p0,a.p1,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(t[3*n],t[3*n+1],s,o,l);break;case 1:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(a.p1,a.p2,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(t[3*n+1],t[3*n+2],s,o,l);break;case 2:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(a.p2,a.p0,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(t[3*n+2],t[3*n],s,o,l)}if(-1!==c&&(a.edges[i]=e,r.edges[c]=n,a.edgesConnectedCount++,r.edgesConnectedCount++,3===a.edgesConnectedCount))break}}}}for(n=0;n<i.length;n++){const e=i[n];this._checkEdge(n,e.edges[0],r,e.p0,e.p1),this._checkEdge(n,e.edges[1],r,e.p1,e.p2),this._checkEdge(n,e.edges[2],r,e.p2,e.p0)}const o=this._source.getScene().getEngine();this._buffers[Ue.R.PositionKind]=new Ue.R(o,this._linesPositions,Ue.R.PositionKind,!1),this._buffers[Ue.R.NormalKind]=new Ue.R(o,this._linesNormals,Ue.R.NormalKind,!1,!1,4),this._buffersForInstances[Ue.R.PositionKind]=this._buffers[Ue.R.PositionKind],this._buffersForInstances[Ue.R.NormalKind]=this._buffers[Ue.R.NormalKind],this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera)return void this._lineShader._setDrawWrapper(t);const i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances;let n=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const e=this._source._instanceDataStorage;if(n=this.customInstances.length,!e.instancesData)return void(this._source.getScene()._activeMeshesFrozen||this.customInstances.reset());if(!e.isFrozen){let t=0;for(let i=0;i<n;++i)this.customInstances.data[i].copyToArray(e.instancesData,t),t+=16;e.instancesBuffer.updateDirectly(e.instancesData,0,n)}}else n=this._source.thinInstanceCount;const s=e.getEngine();this._lineShader._preBind(),1!==this._source.edgesColor.a?s.setAlphaMode(2):s.setAlphaMode(0),s.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===Ct.i.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",s.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix(),this._source),s.drawElementsType(Zl.i.TriangleFillMode,0,this._indicesCount,n),this._lineShader.unbind(),r&&s.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class gP extends _P{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(Ue.R.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=s.AA.Vector3[0],r=s.AA.Vector3[1],n=t.length-1;for(let a=0,o=0;a<n;a+=2,o+=4)s.Pq.FromArrayToRef(e,3*t[a],i),s.Pq.FromArrayToRef(e,3*t[a+1],r),this.createLine(i,r,o);const a=this._source.getScene().getEngine();this._buffers[Ue.R.PositionKind]=new Ue.R(a,this._linesPositions,Ue.R.PositionKind,!1),this._buffers[Ue.R.NormalKind]=new Ue.R(a,this._linesNormals,Ue.R.NormalKind,!1,!1,4),this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}class vP{get iblSource(){return this._iblSource}set iblSource(e){this._iblSource!==e&&(this._disposeTextures(),this._iblSource=e,e.isCube,e.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl(e):e.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,e)))}_recreateAssetsFromNewIbl(e){this._debugPass&&this._debugPass.dispose(),this._createTextures(),this._debugPass&&this._createDebugPass(),this._icdfxPT.onGeneratedObservable.addOnce((()=>{this.onGeneratedObservable.notifyObservers()}))}getIcdfyTexture(){return this._icdfyPT?this._icdfyPT:this._dummyTexture}getIcdfxTexture(){return this._icdfxPT?this._icdfxPT:this._dummyTexture}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}get debugPassName(){return this._debugPassName}getDebugPassPP(){return this._debugPass||this._createDebugPass(),this._debugPass}constructor(e){this.debugEnabled=!1,this._debugSizeParams=new s.IU(0,0,0,0),this._debugPassName="Importance Sample Debug",this.onGeneratedObservable=new n.cP,this._scene=e,this._engine=e.getEngine();const t=new Uint8Array([0,0,0,255]);this._dummyTexture=new me.I(t,1,1,_i.N.TEXTUREFORMAT_RGBA,e,!1),vP._SceneComponentInitialization(this._scene)}_createTextures(){const e=this._iblSource?this._iblSource.getSize():{width:1,height:1};this._iblSource||(this._iblSource=me.I.CreateRTexture(new Uint8Array([255]),1,1,this._scene,!1,!1,1,0),this._iblSource.name="Placeholder IBL Source"),this._iblSource.isCube&&(e.width*=4,e.height*=2);const t=this._engine.isWebGPU,r={generateDepthBuffer:!1,generateMipMaps:!1,format:6,type:1,samplingMode:1,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(i.bind(i,51568)),Promise.resolve().then(i.bind(i,29145))]):await Promise.all([Promise.resolve().then(i.bind(i,82283)),Promise.resolve().then(i.bind(i,31858))])}},n={generateDepthBuffer:!1,generateMipMaps:!1,format:6,type:2,samplingMode:1,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(i.bind(i,2785)),Promise.resolve().then(i.bind(i,25880))]):await Promise.all([Promise.resolve().then(i.bind(i,35088)),Promise.resolve().then(i.bind(i,66649))])}};this._cdfyPT=new tc("cdfyTexture",{width:e.width,height:e.height+1},"iblCdfy",this._scene,r,!1,!1),this._cdfyPT.autoClear=!1,this._cdfyPT.setTexture("iblSource",this._iblSource),this._cdfyPT.setInt("iblHeight",e.height),this._iblSource.isCube&&(this._cdfyPT.defines="#define IBL_USE_CUBE_MAP\n"),this._cdfyPT.refreshRate=0,this._icdfyPT=new tc("icdfyTexture",{width:e.width,height:e.height},"iblIcdfy",this._scene,n,!1,!1),this._icdfyPT.autoClear=!1,this._icdfyPT.setTexture("cdfy",this._cdfyPT),this._icdfyPT.refreshRate=0,this._cdfxPT=new tc("cdfxTexture",{width:e.width+1,height:1},"iblCdfx",this._scene,r,!1,!1),this._cdfxPT.autoClear=!1,this._cdfxPT.setTexture("cdfy",this._cdfyPT),this._cdfxPT.refreshRate=0,this._icdfxPT=new tc("icdfxTexture",{width:e.width,height:1},"iblIcdfx",this._scene,n,!1,!1),this._icdfxPT.autoClear=!1,this._icdfxPT.setTexture("cdfx",this._cdfxPT),this._icdfxPT.refreshRate=0}_disposeTextures(){this._cdfyPT?.dispose(),this._icdfyPT?.dispose(),this._cdfxPT?.dispose(),this._icdfxPT?.dispose()}_createDebugPass(){this._debugPass&&this._debugPass.dispose();const e=this._engine.isWebGPU,t={width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight(),samplingMode:_e.g.BILINEAR_SAMPLINGMODE,engine:this._engine,textureType:0,uniforms:["sizeParams"],samplers:["cdfy","icdfy","cdfx","icdfx","iblSource"],defines:this._iblSource?.isCube?"#define IBL_USE_CUBE_MAP\n":"",shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,70730))):t.push(Promise.resolve().then(i.bind(i,5481)))}};this._debugPass=new jt.w(this._debugPassName,"importanceSamplingDebug",t);const r=this._debugPass.getEffect();r&&(r.defines=this._iblSource?.isCube?"#define IBL_USE_CUBE_MAP\n":""),this._iblSource?.isCube&&this._debugPass.updateEffect("#define IBL_USE_CUBE_MAP\n"),this._debugPass.onApplyObservable.add((e=>{e.setTexture("cdfy",this._cdfyPT),e.setTexture("icdfy",this._icdfyPT),e.setTexture("cdfx",this._cdfxPT),e.setTexture("icdfx",this._icdfxPT),e.setTexture("iblSource",this._iblSource),e.setFloat4("sizeParams",this._debugSizeParams.x,this._debugSizeParams.y,this._debugSizeParams.z,this._debugSizeParams.w)}))}isReady(){return this._iblSource&&"Placeholder IBL Source"!==this._iblSource.name&&this._iblSource.isReady()&&this._cdfyPT&&this._cdfyPT.isReady()&&this._icdfyPT&&this._icdfyPT.isReady()&&this._cdfxPT&&this._cdfxPT.isReady()&&this._icdfxPT&&this._icdfxPT.isReady()}dispose(){this._disposeTextures(),this._dummyTexture.dispose(),this._debugPass&&this._debugPass.dispose(),this.onGeneratedObservable.clear()}}vP._SceneComponentInitialization=e=>{throw(0,Oc.n)("IblCdfGeneratorSceneComponentSceneComponent")},Object.defineProperty(kt.Z.prototype,"iblCdfGenerator",{get:function(){return this._iblCdfGenerator},set:function(e){e&&(this._iblCdfGenerator=e)},enumerable:!0,configurable:!0}),kt.Z.prototype.enableIblCdfGenerator=function(){return this._iblCdfGenerator||(this._iblCdfGenerator=new vP(this),this.environmentTexture&&(this._iblCdfGenerator.iblSource=this.environmentTexture)),this._iblCdfGenerator},kt.Z.prototype.disableIblCdfGenerator=function(){this._iblCdfGenerator&&(this._iblCdfGenerator.dispose(),this._iblCdfGenerator=null)};class SP{constructor(e){this.name=Gt.v.NAME_IBLCDFGENERATOR,this._newIblObserver=null,this.scene=e}register(){this._updateIblSource(),this._newIblObserver=this.scene.onEnvironmentTextureChangedObservable.add(this._updateIblSource.bind(this))}rebuild(){}dispose(){this.scene.onEnvironmentTextureChangedObservable.remove(this._newIblObserver)}_updateIblSource(){this.scene.iblCdfGenerator&&this.scene.environmentTexture&&(this.scene.iblCdfGenerator.iblSource=this.scene.environmentTexture)}}vP._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_IBLCDFGENERATOR);t||(t=new SP(e),e._addComponent(t))};class xP{getVoxelGrid(){return this._triPlanarVoxelization?this._voxelGridRT:this._voxelGridZaxis}getDebugPassPP(){return this._voxelDebugPass||this._createDebugPass(),this._voxelDebugPass}get triPlanarVoxelization(){return this._triPlanarVoxelization}set triPlanarVoxelization(e){this._triPlanarVoxelization!==e&&(this._triPlanarVoxelization=e,this._disposeVoxelTextures(),this._createTextures())}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}isVoxelizationInProgress(){return this._voxelizationInProgress}get voxelResolutionExp(){return this._voxelResolutionExp}set voxelResolutionExp(e){this._voxelResolutionExp===e&&this._voxelGridZaxis||(this._voxelResolutionExp=Math.round(Math.min(Math.max(e,3),9)),this._voxelResolution=Math.pow(2,this._voxelResolutionExp),this._disposeVoxelTextures(),this._createTextures())}set voxelDebugAxis(e){this._voxelDebugAxis=e}get voxelDebugAxis(){return this._voxelDebugAxis}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}setDebugMipNumber(e){this._debugMipNumber=e}get debugPassName(){return this._debugPassName}get voxelDebugEnabled(){return this._voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelDebugEnabled!==e&&(this._voxelDebugEnabled=e,e&&(this._voxelSlabDebugRT=new Si.$("voxelSlabDebug",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},this._scene,{generateDepthBuffer:!0,generateMipMaps:!1,type:0,format:5,samplingMode:1}),this._voxelSlabDebugRT.noPrePassRenderer=!0),this._voxelSlabDebugRT&&this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelDebugEnabled?(this._addRTsForRender([this._voxelSlabDebugRT],this._includedMeshes,this._voxelDebugAxis,1,!0),this._setDebugBindingsBound=this._setDebugBindings.bind(this),this._scene.onBeforeRenderObservable.add(this._setDebugBindingsBound)):this._scene.onBeforeRenderObservable.removeCallback(this._setDebugBindingsBound))}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._voxelDebugPass){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams","mipNumber"],samplers:["voxelTexture","voxelSlabTexture"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{this._isVoxelGrid3D?e?t.push(Promise.resolve().then(i.bind(i,5025))):t.push(Promise.resolve().then(i.bind(i,89346))):e?t.push(Promise.resolve().then(i.bind(i,2765))):t.push(Promise.resolve().then(i.bind(i,59776)))}};this._voxelDebugPass=new jt.w(this.debugPassName,this._isVoxelGrid3D?"iblVoxelGrid3dDebug":"iblVoxelGrid2dArrayDebug",t),this._voxelDebugPass.onApplyObservable.add((e=>{0===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridXaxis):1===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridYaxis):2===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridZaxis):e.setTexture("voxelTexture",this.getVoxelGrid()),e.setTexture("voxelSlabTexture",this._voxelSlabDebugRT),e.setVector4("sizeParams",this._debugSizeParams),e.setFloat("mipNumber",this._debugMipNumber)}))}}constructor(e,t,r=6,n=!0){this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[],this._isVoxelGrid3D=!0,this._renderTargets=[],this._triPlanarVoxelization=!0,this._voxelizationInProgress=!1,this._invWorldScaleMatrix=s.uq.Identity(),this._voxelResolution=64,this._voxelResolutionExp=6,this._mipArray=[],this._voxelDebugEnabled=!1,this._voxelDebugAxis=-1,this._debugSizeParams=new s.IU(0,0,0,0),this._includedMeshes=[],this._debugMipNumber=0,this._debugPassName="Voxelization Debug Pass",this._scene=e,this._engine=e.getEngine(),this._triPlanarVoxelization=n,this._engine.getCaps().drawBuffersExtension||f.V.Error("Can't do voxel rendering without the draw buffers extension.");const a=this._engine.isWebGPU;this._maxDrawBuffers=this._engine.getCaps().maxDrawBuffers||0,this._copyMipEffectRenderer=new Ks.J(this._engine),this._copyMipEffectWrapper=new Ks.$({engine:this._engine,fragmentShader:"copyTexture3DLayerToTexture",useShaderStore:!0,uniformNames:["layerNum"],samplerNames:["textureSampler"],shaderLanguage:a?1:0,extraInitializationsAsync:async()=>{a?await Promise.resolve().then(i.bind(i,42220)):await Promise.resolve().then(i.bind(i,52083))}}),this.voxelResolutionExp=r}_generateMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._generateMipMap(t)}_generateMipMap(e){const t=this._mipArray[e-1];t&&(t.setTexture("srcMip",1===e?this.getVoxelGrid():this._mipArray[e-2]),t.render())}_copyMipMaps(){const e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._copyMipMap(t)}_copyMipMap(e){const t=this._mipArray[e-1];if(!t)return;const i=this.getVoxelGrid();let r;if(r=i instanceof Si.$&&i.renderTarget?i.renderTarget:i._rtWrapper,r){this._copyMipEffectRenderer.saveStates();const i=t.getSize().width;for(let n=0;n<i;n++)this._engine.bindFramebuffer(r,0,i,i,!0,e,n),this._copyMipEffectRenderer.applyEffectWrapper(this._copyMipEffectWrapper),this._copyMipEffectWrapper.effect.setTexture("textureSampler",t),this._copyMipEffectWrapper.effect.setInt("layerNum",n),this._copyMipEffectRenderer.draw(),this._engine.unBindFramebuffer(r,!0);this._copyMipEffectRenderer.restoreStates()}}_computeNumberOfSlabs(){return Math.ceil(this._voxelResolution/this._maxDrawBuffers)}_createTextures(){const e=this._engine.isWebGPU,t={width:this._voxelResolution,height:this._voxelResolution,layers:this._isVoxelGrid3D?void 0:this._voxelResolution,depth:this._isVoxelGrid3D?this._voxelResolution:void 0},r={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1},n=this._computeNumberOfSlabs(),s={generateDepthBuffer:!1,generateMipMaps:!0,type:0,format:6,samplingMode:4,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(i.bind(i,15691)):await Promise.resolve().then(i.bind(i,78))}};this._triPlanarVoxelization?(this._voxelGridXaxis=new Si.$("voxelGridXaxis",t,this._scene,r),this._voxelGridYaxis=new Si.$("voxelGridYaxis",t,this._scene,r),this._voxelGridZaxis=new Si.$("voxelGridZaxis",t,this._scene,r),this._voxelMrtsXaxis=this._createVoxelMRTs("x_axis_",this._voxelGridXaxis,n),this._voxelMrtsYaxis=this._createVoxelMRTs("y_axis_",this._voxelGridYaxis,n),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,n),this._voxelGridRT=new tc("combinedVoxelGrid",t,"iblCombineVoxelGrids",this._scene,s,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._voxelGridRT),1),this._voxelGridRT.setFloat("layer",0),this._voxelGridRT.setTexture("voxelXaxisSampler",this._voxelGridXaxis),this._voxelGridRT.setTexture("voxelYaxisSampler",this._voxelGridYaxis),this._voxelGridRT.setTexture("voxelZaxisSampler",this._voxelGridZaxis),this._voxelGridRT.autoClear=!1,this._voxelGridRT.wrapU=_e.g.CLAMP_ADDRESSMODE,this._voxelGridRT.wrapV=_e.g.CLAMP_ADDRESSMODE):(this._voxelGridZaxis=new Si.$("voxelGridZaxis",t,this._scene,s),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,n));const a={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(i.bind(i,76132)):await Promise.resolve().then(i.bind(i,38279))}};this._mipArray=new Array(Math.ceil(Math.log2(this._voxelResolution)));for(let e=1;e<=this._mipArray.length;e++){const t=this._voxelResolution>>e,i={width:t,height:t,depth:t};this._mipArray[e-1]=new tc("voxelMip"+e,i,"iblGenerateVoxelMip",this._scene,a,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._mipArray[e-1]),1);const r=this._mipArray[e-1];r.autoClear=!1,r.wrapU=_e.g.CLAMP_ADDRESSMODE,r.wrapV=_e.g.CLAMP_ADDRESSMODE,r.setTexture("srcMip",e>1?this._mipArray[e-2]:this.getVoxelGrid()),r.setInt("layerNum",0)}this._createVoxelMaterials()}_createVoxelMRTs(e,t,i){t.wrapU=_e.g.CLAMP_ADDRESSMODE,t.wrapV=_e.g.CLAMP_ADDRESSMODE,t.noPrePassRenderer=!0;const r=[],n=new Array(this._maxDrawBuffers).fill(this._isVoxelGrid3D?32879:35866);for(let s=0;s<i;s++){let i=new Array(this._maxDrawBuffers).fill(0);i=i.map(((e,t)=>s*this._maxDrawBuffers+t));let o=new Array(this._maxDrawBuffers).fill("");o=o.map(((t,i)=>"voxel_grid_"+e+(s*this._maxDrawBuffers+i)));const l=new td("mrt_"+e+s,{width:this._voxelResolution,height:this._voxelResolution,depth:this._isVoxelGrid3D?this._voxelResolution:void 0},this._maxDrawBuffers,this._scene,{types:new Array(this._maxDrawBuffers).fill(0),samplingModes:new Array(this._maxDrawBuffers).fill(3),generateMipMaps:!1,targetTypes:n,formats:new Array(this._maxDrawBuffers).fill(6),faceIndex:new Array(this._maxDrawBuffers).fill(0),layerIndex:i,layerCounts:new Array(this._maxDrawBuffers).fill(this._voxelResolution),generateDepthBuffer:!1,generateStencilBuffer:!1},o);l.clearColor=new a.ov(0,0,0,1),l.noPrePassRenderer=!0;for(let e=0;e<this._maxDrawBuffers;e++)l.setInternalTexture(t.getInternalTexture(),e);r.push(l)}return r}_disposeVoxelTextures(){this._stopVoxelization();for(let e=0;e<this._voxelMrtsZaxis.length;e++)this._triPlanarVoxelization&&(this._voxelMrtsXaxis[e].dispose(!0),this._voxelMrtsYaxis[e].dispose(!0)),this._voxelMrtsZaxis[e].dispose(!0);this._triPlanarVoxelization&&(this._voxelGridXaxis?.dispose(),this._voxelGridYaxis?.dispose(),this._voxelGridRT?.dispose()),this._voxelGridZaxis?.dispose(),this._mipArray.forEach((e=>{e.dispose()})),this._voxelMaterial?.dispose(),this._voxelSlabDebugMaterial?.dispose(),this._mipArray=[],this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[]}_createVoxelMaterials(){const e=this._engine.isWebGPU;this._voxelMaterial=new ir.B("voxelization",this._scene,"iblVoxelGrid",{uniforms:["world","viewMatrix","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,72439)),Promise.resolve().then(i.bind(i,69553))]):await Promise.all([Promise.resolve().then(i.bind(i,31826)),Promise.resolve().then(i.bind(i,37224))])}}),this._voxelMaterial.cullBackFaces=!1,this._voxelMaterial.backFaceCulling=!1,this._voxelMaterial.depthFunction=_i.N.ALWAYS,this._voxelSlabDebugMaterial=new ir.B("voxelSlabDebug",this._scene,"iblVoxelSlabDebug",{uniforms:["world","viewMatrix","cameraViewMatrix","projection","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,50342)),Promise.resolve().then(i.bind(i,77356))]):await Promise.all([Promise.resolve().then(i.bind(i,11589)),Promise.resolve().then(i.bind(i,70287))])}})}_setDebugBindings(){this._voxelSlabDebugMaterial.setMatrix("projection",this._scene.activeCamera.getProjectionMatrix()),this._voxelSlabDebugMaterial.setMatrix("cameraViewMatrix",this._scene.activeCamera.getViewMatrix())}isReady(){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){const i=this._mipArray[t].isReady();e&&(e=i)}return!(!e||this._voxelizationInProgress)}_stopVoxelization(){this._removeVoxelRTs(this._voxelMrtsXaxis),this._removeVoxelRTs(this._voxelMrtsYaxis),this._removeVoxelRTs(this._voxelMrtsZaxis)}_removeVoxelRTs(e){const t=this._renderTargets.findIndex((t=>t===e[0]));if(t>=0)this._renderTargets.splice(t,e.length);else{const t=this._scene.customRenderTargets.findIndex((t=>t===e[0]));t>=0&&this._scene.customRenderTargets.splice(t,e.length)}}updateVoxelGrid(e){this._stopVoxelization(),this._includedMeshes=e,this._voxelizationInProgress=!0,this._triPlanarVoxelization?(this._addRTsForRender(this._voxelMrtsXaxis,e,0),this._addRTsForRender(this._voxelMrtsYaxis,e,1),this._addRTsForRender(this._voxelMrtsZaxis,e,2)):this._addRTsForRender(this._voxelMrtsZaxis,e,2),this._voxelDebugEnabled&&this._addRTsForRender([this._voxelSlabDebugRT],e,this._voxelDebugAxis,1,!0),this._renderVoxelGridBound=this._renderVoxelGrid.bind(this),this._scene.onAfterRenderObservable.add(this._renderVoxelGridBound)}_renderVoxelGrid(){if(this._voxelizationInProgress){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){const i=this._mipArray[t].isReady();e&&(e=i)}for(let t=0;t<this._renderTargets.length;t++){const i=this._renderTargets[t].isReadyForRendering();e&&(e=i)}e&&(this._renderTargets.forEach((e=>{e.render()})),this._stopVoxelization(),this._triPlanarVoxelization&&this._voxelGridRT.render(),this._generateMipMaps(),this._copyMipMaps(),this._scene.onAfterRenderObservable.removeCallback(this._renderVoxelGridBound),this._voxelizationInProgress=!1)}}_addRTsForRender(e,t,i,r=0,n=!1){const a=1/this._computeNumberOfSlabs();let o;o=0===r?this._voxelMaterial:this._voxelSlabDebugMaterial,e.forEach(((e,r)=>{e.renderList=[];const n=r*a,l=(r+1)*a,c=a/this._maxDrawBuffers,h=new s.Pq(0,0,0);let u=new s.Pq(0,0,1);0===i?u=new s.Pq(1,0,0):1===i&&(u=new s.Pq(0,1,0));let d=new s.Pq(0,1,0);1===i&&(d=new s.Pq(1,0,0)),e.onBeforeRenderObservable.add((()=>{o.setMatrix("viewMatrix",s.uq.LookAtLH(h,u,d)),o.setMatrix("invWorldScale",this._invWorldScaleMatrix),o.setFloat("nearPlane",n),o.setFloat("farPlane",l),o.setFloat("stepSize",c)})),0!==t.length&&t.forEach((t=>{t&&(t.subMeshes&&t.subMeshes.length>0&&(e.renderList?.push(t),e.setMaterialForRendering(t,o)),t.getChildMeshes().forEach((t=>{t.subMeshes&&t.subMeshes.length>0&&(e.renderList?.push(t),e.setMaterialForRendering(t,o))})))}))})),n?e.forEach((e=>{-1===this._scene.customRenderTargets.indexOf(e)&&this._scene.customRenderTargets.push(e)})):this._renderTargets=this._renderTargets.concat(e)}resize(){this._voxelSlabDebugRT?.resize({width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight()})}dispose(){this._disposeVoxelTextures(),this._voxelSlabDebugRT&&(this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelSlabDebugRT.dispose()),this._voxelDebugPass&&this._voxelDebugPass.dispose()}}class TP{get voxelShadowOpacity(){return this._voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelShadowOpacity=e}get ssShadowOpacity(){return this._ssShadowOpacity}set ssShadowOpacity(e){this._ssShadowOpacity=e}get sssSamples(){return this._sssSamples}set sssSamples(e){this._sssSamples=e}get sssStride(){return this._sssStride}set sssStride(e){this._sssStride=e}get sssMaxDist(){return this._sssMaxDist}set sssMaxDist(e){this._sssMaxDist=e}get sssThickness(){return this._sssThickness}set sssThickness(e){this._sssThickness=e}get voxelNormalBias(){return this._voxelNormalBias}set voxelNormalBias(e){this._voxelNormalBias=e}get voxelDirectionBias(){return this._voxelDirectionBias}set voxelDirectionBias(e){this._voxelDirectionBias=e}get sampleDirections(){return this._sampleDirections}set sampleDirections(e){this._sampleDirections=e}get envRotation(){return this._envRotation}set envRotation(e){this._envRotation=e}getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){const e=this._engine.isWebGPU;if(!this._debugPassPP){const t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,74550))):t.push(Promise.resolve().then(i.bind(i,95859)))}};this._debugPassPP=new jt.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)}))}}constructor(e,t){this._voxelShadowOpacity=1,this._sssSamples=16,this._sssStride=8,this._sssMaxDist=.05,this._sssThickness=.5,this._ssShadowOpacity=1,this._cameraInvView=s.uq.Identity(),this._cameraInvProj=s.uq.Identity(),this._invWorldScaleMatrix=s.uq.Identity(),this._frameId=0,this._sampleDirections=4,this._shadowParameters=new s.IU(0,0,0,0),this._sssParameters=new s.IU(0,0,0,0),this._opacityParameters=new s.IU(0,0,0,0),this._voxelBiasParameters=new s.IU(0,0,0,0),this._voxelNormalBias=1.4,this._voxelDirectionBias=1.75,this.enabled=!0,this.debugEnabled=!1,this._debugPassName="Voxel Tracing Debug Pass",this._envRotation=0,this._debugVoxelMarchEnabled=!1,this._debugSizeParams=new s.IU(0,0,0,0),this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e="";this._scene.useRightHandedSystem&&(e+="#define RIGHT_HANDED\n"),this._debugVoxelMarchEnabled&&(e+="#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u\n");const t=this._engine.isWebGPU,r={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(i.bind(i,68225))]):await Promise.all([Promise.resolve().then(i.bind(i,66674))])}};this._outputTexture=new tc("voxelTracingPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowVoxelTracing",this._scene,r),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.defines=e,this._setBindings(this._scene.activeCamera);let n=0;this._scene.onBeforeRenderObservable.add((()=>{n=0})),this._scene.onAfterRenderTargetsRenderObservable.add((()=>{2==++n&&this.enabled&&this._outputTexture.isReady()&&(this._setBindings(this._scene.activeCamera),this._outputTexture.render())}))}_setBindings(e){this._scene.useRightHandedSystem&&(this._outputTexture.defines="#define RIGHT_HANDED\n"),this._outputTexture.setMatrix("viewMtx",e.getViewMatrix()),this._outputTexture.setMatrix("projMtx",e.getProjectionMatrix()),e.getProjectionMatrix().invertToRef(this._cameraInvProj),e.getViewMatrix().invertToRef(this._cameraInvView),this._outputTexture.setMatrix("invProjMtx",this._cameraInvProj),this._outputTexture.setMatrix("invViewMtx",this._cameraInvView),this._outputTexture.setMatrix("wsNormalizationMtx",this._invWorldScaleMatrix),this._frameId++;let t=this._scene.useRightHandedSystem?-(this._envRotation+.5*Math.PI):this._envRotation-.5*Math.PI;t%=2*Math.PI,this._shadowParameters.set(this._sampleDirections,this._frameId,1,t),this._outputTexture.setVector4("shadowParameters",this._shadowParameters);const i=this._renderPipeline._getVoxelGridTexture(),r=Math.floor(Math.log2(i.getSize().width));this._voxelBiasParameters.set(this._voxelNormalBias,this._voxelDirectionBias,r,0),this._outputTexture.setVector4("voxelBiasParameters",this._voxelBiasParameters),this._sssParameters.set(this._sssSamples,this._sssStride,this._sssMaxDist,this._sssThickness),this._outputTexture.setVector4("sssParameters",this._sssParameters),this._opacityParameters.set(this._voxelShadowOpacity,this._ssShadowOpacity,0,0),this._outputTexture.setVector4("shadowOpacity",this._opacityParameters),this._outputTexture.setTexture("voxelGridSampler",i),this._outputTexture.setTexture("blueNoiseSampler",this._renderPipeline._getNoiseTexture());const n=this._scene.iblCdfGenerator;n&&(this._outputTexture.setTexture("icdfySampler",n.getIcdfyTexture()),this._outputTexture.setTexture("icdfxSampler",n.getIcdfxTexture())),this._debugVoxelMarchEnabled&&(this._outputTexture.defines+="#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u\n");const s=this._scene.geometryBufferRenderer;if(!s)return;const a=s.getTextureIndex(NC.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",s.getGBuffer().textures[a]);const o=s.getTextureIndex(NC.NORMAL_TEXTURE_TYPE);this._outputTexture.setTexture("worldNormalSampler",s.getGBuffer().textures[o])}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())&&this._scene.iblCdfGenerator&&this._scene.iblCdfGenerator.getIcdfyTexture().isReady()&&this._scene.iblCdfGenerator.getIcdfxTexture().isReady()&&this._renderPipeline._getVoxelGridTexture().isReady()}dispose(){this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}class EP{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScale(e){this._worldScale=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:6,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,74550))):t.push(Promise.resolve().then(i.bind(i,95859)))}};this._debugPassPP=new jt.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)}))}}constructor(e,t){this._worldScale=1,this._blurParameters=new s.IU(0,0,0,0),this.enabled=!0,this._debugPassName="Spatial Blur Debug Pass",this.debugEnabled=!1,this._debugSizeParams=new s.IU(0,0,0,0),this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._engine.isWebGPU,t={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,93632))]):await Promise.all([Promise.resolve().then(i.bind(i,41025))])}};this._outputTexture=new tc("spatialBlurPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowSpatialBlur",this._scene,t,!1,!1,0),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._setBindings();let r=0;this._scene.onBeforeRenderObservable.add((()=>{r=0})),this._scene.onAfterRenderTargetsRenderObservable.add((()=>{2==++r&&this.enabled&&this._outputTexture.isReady()&&(this._setBindings(),this._outputTexture.render())}))}_setBindings(){this._outputTexture.setTexture("voxelTracingSampler",this._renderPipeline._getVoxelTracingTexture()),this._blurParameters.set(1,this._worldScale,0,0),this._outputTexture.setVector4("blurParameters",this._blurParameters);const e=this._scene.geometryBufferRenderer;if(!e)return;const t=e.getTextureIndex(NC.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",e.getGBuffer().textures[t]);const i=e.getTextureIndex(NC.NORMAL_TEXTURE_TYPE);this._outputTexture.setTexture("worldNormalSampler",e.getGBuffer().textures[i])}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}class CP{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}get remanence(){return this._remanence}set remanence(e){this._remanence=e}get reset(){return this._reset}set reset(e){this._reset=e}set isMoving(e){this._isMoving=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){const e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,74550))):t.push(Promise.resolve().then(i.bind(i,95859)))}};this._debugPassPP=new jt.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add((e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)}))}}constructor(e,t){this._accumulationParams=new s.IU(0,0,0,0),this.debugEnabled=!1,this.enabled=!0,this.onReadyObservable=new n.cP,this._debugPassName="Shadow Accumulation Debug Pass",this._remanence=.9,this._reset=!0,this._isMoving=!1,this._debugSizeParams=new s.IU(0,0,0,0),this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){const e=this._engine.isWebGPU,t={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,94078))]):await Promise.all([Promise.resolve().then(i.bind(i,69301))])}};this._outputTexture=new tc("shadowAccumulationPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowAccumulation",this._scene,t),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.onGeneratedObservable.addOnce((()=>{this.onReadyObservable.notifyObservers()})),this._setOutputTextureBindings();let r=0;this._scene.onBeforeRenderObservable.add((()=>{r=0})),this._scene.onAfterRenderTargetsRenderObservable.add((()=>{2==++r&&this.enabled&&this._outputTexture.isReady()&&(this._setOutputTextureBindings(),this._outputTexture.render())}));const n={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,35385))]):await Promise.all([Promise.resolve().then(i.bind(i,38752))])}};this._oldAccumulationCopy=new tc("oldAccumulationRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,n,!1),this._oldAccumulationCopy.autoClear=!1,this._oldAccumulationCopy.refreshRate=1,this._oldAccumulationCopy.onBeforeGenerationObservable.add(this._setAccumulationCopyBindings.bind(this)),this._setAccumulationCopyBindings();const s={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,35385))]):await Promise.all([Promise.resolve().then(i.bind(i,38752))])}};this._oldPositionCopy=new tc("oldLocalPositionRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,s,!1),this._updatePositionCopy(),this._oldPositionCopy.autoClear=!1,this._oldPositionCopy.refreshRate=1,this._oldPositionCopy.onBeforeGenerationObservable.add(this._updatePositionCopy.bind(this))}_setOutputTextureBindings(){const e=this._isMoving?this.remanence:.99;this._accumulationParams.set(e,this.reset?1:0,this._renderPipeline.voxelGridSize,0),this._outputTexture.setTexture("spatialBlurSampler",this._renderPipeline._getSpatialBlurTexture()),this._outputTexture.setVector4("accumulationParameters",this._accumulationParams),this._outputTexture.setTexture("oldAccumulationSampler",this._oldAccumulationCopy?this._oldAccumulationCopy:this._renderPipeline._dummyTexture2d),this._outputTexture.setTexture("prevPositionSampler",this._oldPositionCopy?this._oldPositionCopy:this._renderPipeline._dummyTexture2d);const t=this._scene.geometryBufferRenderer;if(!t)return;const i=t.getTextureIndex(NC.VELOCITY_LINEAR_TEXTURE_TYPE);this._outputTexture.setTexture("motionSampler",t.getGBuffer().textures[i]);const r=t.getTextureIndex(NC.POSITION_TEXTURE_TYPE);this._outputTexture.setTexture("positionSampler",t.getGBuffer().textures[r]),this.reset=!1,this._isMoving=!1}_updatePositionCopy(){const e=this._scene.geometryBufferRenderer,t=e.getTextureIndex(NC.POSITION_TEXTURE_TYPE);this._oldPositionCopy.setTexture("textureSampler",e.getGBuffer().textures[t])}_setAccumulationCopyBindings(){this._oldAccumulationCopy.setTexture("textureSampler",this._outputTexture)}resize(e=1){const t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.resize(t,!1),this._oldAccumulationCopy.resize(t,!1),this._oldPositionCopy.resize({width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},!1),this.reset=!0}_disposeTextures(){this._oldAccumulationCopy.dispose(),this._oldPositionCopy.dispose(),this._outputTexture.dispose()}isReady(){return this._oldAccumulationCopy&&this._oldAccumulationCopy.isReady()&&this._oldPositionCopy&&this._oldPositionCopy.isReady()&&this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._disposeTextures(),this._debugPassPP&&this._debugPassPP.dispose(),this.onReadyObservable.clear()}}class bP extends zo.M{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=!1}}class PP extends Mm.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,PP.Name,310,new bP),this.shadowOpacity=1,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled}getClassName(){return"IBLShadowsPluginMaterial"}getUniforms(){return{ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:"#ifdef RENDER_WITH_IBL_SHADOWS\n                    uniform vec2 renderTargetSize;\n                    uniform float shadowOpacity;\n                #endif"}}getSamplers(e){e.push("iblShadowsTexture")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity))}getCustomCode(e,t){let i;return 1===t?(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    var iblShadowsTextureSampler: sampler;\n                    var iblShadowsTexture: texture_2d<f32>;\n\n                    fn computeIndirectShadow() -> vec2f {\n                        var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;\n                        var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;\n                        return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);\n                    }\n                #endif\n            "},this._material instanceof Pu.d?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifdef REFLECTION\n                        var shadowValue: vec2f = computeIndirectShadow();\n                        finalIrradiance *= vec3f(shadowValue.x);\n                        finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));\n                    #endif\n                #endif\n            ":i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    var shadowValue: vec2f = computeIndirectShadow();\n                    color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));\n                #endif\n            "):(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    uniform sampler2D iblShadowsTexture;\n\n                    vec2 computeIndirectShadow() {\n                        vec2 uv = gl_FragCoord.xy / renderTargetSize;\n                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;\n                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);\n                    }\n                #endif\n            "},this._material instanceof Pu.d?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    #ifdef REFLECTION\n                        vec2 shadowValue = computeIndirectShadow();\n                        finalIrradiance *= shadowValue.x;\n                        finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);\n                    #endif\n                #endif\n            ":i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_IBL_SHADOWS\n                    vec2 shadowValue = computeIndirectShadow();\n                    color.rgb *= toGammaSpace(shadowValue.x);\n                #endif\n            "),"vertex"===e?null:i}}PP.Name="IBLShadowsPluginMaterial",(0,ue.Cg)([(0,de.lK)()],PP.prototype,"iblShadowsTexture",void 0),(0,ue.Cg)([(0,de.lK)()],PP.prototype,"shadowOpacity",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],PP.prototype,"isEnabled",void 0),(0,o.Y5)("BABYLON.IBLShadowsPluginMaterial",PP);class yP extends kC{resetAccumulation(){this._accumulationPass.reset=!0}get shadowOpacity(){return this._shadowOpacity}set shadowOpacity(e){this._shadowOpacity=e,this._setPluginParameters()}get shadowRenderSizeFactor(){return this._renderSizeFactor}set shadowRenderSizeFactor(e){this._renderSizeFactor=Math.max(Math.min(e,1),0),this._voxelTracingPass.resize(e),this._spatialBlurPass.resize(e),this._accumulationPass.resize(e),this._setPluginParameters()}get voxelShadowOpacity(){return this._voxelTracingPass?.voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.voxelShadowOpacity=e)}get ssShadowOpacity(){return this._voxelTracingPass?.ssShadowOpacity}set ssShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.ssShadowOpacity=e)}get ssShadowSampleCount(){return this._voxelTracingPass?.sssSamples}set ssShadowSampleCount(e){this._voxelTracingPass&&(this._voxelTracingPass.sssSamples=e)}get ssShadowStride(){return this._voxelTracingPass?.sssStride}set ssShadowStride(e){this._voxelTracingPass&&(this._voxelTracingPass.sssStride=e)}get ssShadowDistanceScale(){return this._sssMaxDistScale}set ssShadowDistanceScale(e){this._sssMaxDistScale=e,this._updateSSShadowParams()}get ssShadowThicknessScale(){return this._sssThicknessScale}set ssShadowThicknessScale(e){this._sssThicknessScale=e,this._updateSSShadowParams()}_getVoxelGridTexture(){const e=this._voxelRenderer?.getVoxelGrid();return e&&e.isReady()?e:this._dummyTexture3d}_getNoiseTexture(){const e=this._noiseTexture;return e&&e.isReady()?e:this._dummyTexture2d}_getVoxelTracingTexture(){const e=this._voxelTracingPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getSpatialBlurTexture(){const e=this._spatialBlurPass.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getAccumulatedTexture(){const e=this._accumulationPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}get gbufferDebugEnabled(){return this._gbufferDebugEnabled}set gbufferDebugEnabled(e){!e||this.allowDebugPasses?(this._gbufferDebugEnabled=e,e?this._enableEffect(this._getGBufferDebugPass().name,this.cameras):this._disableEffect(this._getGBufferDebugPass().name,this.cameras)):f.V.Warn("Can't enable G-Buffer debug view without setting allowDebugPasses to true.")}get cdfDebugEnabled(){return!!this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.debugEnabled}set cdfDebugEnabled(e){this.scene.iblCdfGenerator&&(!e||this.allowDebugPasses?e!==this.scene.iblCdfGenerator.debugEnabled&&(this.scene.iblCdfGenerator.debugEnabled=e,e?this._enableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras):this._disableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras)):f.V.Warn("Can't enable importance sampling debug view without setting allowDebugPasses to true."))}get voxelDebugEnabled(){return this._voxelRenderer?.voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelRenderer&&(!e||this.allowDebugPasses?(this._voxelRenderer.voxelDebugEnabled=e,e?this._enableEffect(this._voxelRenderer.debugPassName,this.cameras):this._disableEffect(this._voxelRenderer.debugPassName,this.cameras)):f.V.Warn("Can't enable voxel debug view without setting allowDebugPasses to true."))}get voxelDebugAxis(){return this._voxelRenderer?.voxelDebugAxis}set voxelDebugAxis(e){this._voxelRenderer&&(this._voxelRenderer.voxelDebugAxis=e)}set voxelDebugDisplayMip(e){this._voxelRenderer&&this._voxelRenderer.setDebugMipNumber(e)}get voxelTracingDebugEnabled(){return this._voxelTracingPass?.debugEnabled}set voxelTracingDebugEnabled(e){this._voxelTracingPass&&(!e||this.allowDebugPasses?e!==this._voxelTracingPass.debugEnabled&&(this._voxelTracingPass.debugEnabled=e,e?this._enableEffect(this._voxelTracingPass.debugPassName,this.cameras):this._disableEffect(this._voxelTracingPass.debugPassName,this.cameras)):f.V.Warn("Can't enable voxel tracing debug view without setting allowDebugPasses to true."))}get spatialBlurPassDebugEnabled(){return this._spatialBlurPass.debugEnabled}set spatialBlurPassDebugEnabled(e){this._spatialBlurPass&&(!e||this.allowDebugPasses?e!==this._spatialBlurPass.debugEnabled&&(this._spatialBlurPass.debugEnabled=e,e?this._enableEffect(this._spatialBlurPass.debugPassName,this.cameras):this._disableEffect(this._spatialBlurPass.debugPassName,this.cameras)):f.V.Warn("Can't enable spatial blur debug view without setting allowDebugPasses to true."))}get accumulationPassDebugEnabled(){return this._accumulationPass?.debugEnabled}set accumulationPassDebugEnabled(e){this._accumulationPass&&(!e||this.allowDebugPasses?e!==this._accumulationPass.debugEnabled&&(this._accumulationPass.debugEnabled=e,e?this._enableEffect(this._accumulationPass.debugPassName,this.cameras):this._disableEffect(this._accumulationPass.debugPassName,this.cameras)):f.V.Warn("Can't enable accumulation pass debug view without setting allowDebugPasses to true."))}addShadowCastingMesh(e){if(Array.isArray(e))for(const t of e)t&&-1===this._shadowCastingMeshes.indexOf(t)&&this._shadowCastingMeshes.push(t);else e&&-1===this._shadowCastingMeshes.indexOf(e)&&this._shadowCastingMeshes.push(e)}removeShadowCastingMesh(e){if(Array.isArray(e))for(const t of e){const e=this._shadowCastingMeshes.indexOf(t);-1!==e&&this._shadowCastingMeshes.splice(e,1)}else{const t=this._shadowCastingMeshes.indexOf(e);-1!==t&&this._shadowCastingMeshes.splice(t,1)}}get resolutionExp(){return this._voxelRenderer.voxelResolutionExp}set resolutionExp(e){e!==this._voxelRenderer.voxelResolutionExp&&(this._voxelRenderer.isVoxelizationInProgress()?f.V.Warn("Can't change the resolution of the voxel grid while voxelization is in progress."):(this._voxelRenderer.voxelResolutionExp=Math.max(1,Math.min(e,8)),this._accumulationPass.reset=!0))}get sampleDirections(){return this._voxelTracingPass?.sampleDirections}set sampleDirections(e){this._voxelTracingPass&&(this._voxelTracingPass.sampleDirections=e)}get shadowRemanence(){return this._accumulationPass?.remanence}set shadowRemanence(e){this._accumulationPass&&(this._accumulationPass.remanence=e)}get envRotation(){return this._voxelTracingPass?.envRotation}set envRotation(e){this._voxelTracingPass&&(this._voxelTracingPass.envRotation=e,this._accumulationPass.reset=!0)}get allowDebugPasses(){return this._allowDebugPasses}set allowDebugPasses(e){this._allowDebugPasses!==e&&(this._allowDebugPasses=e,e&&this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.isReady()?this._createDebugPasses():this.scene.iblCdfGenerator.onGeneratedObservable.addOnce((()=>{this._createDebugPasses()})):this._disposeDebugPasses())}static get IsSupported(){const e=P.q.LastCreatedEngine;return!!e&&e._features.supportIBLShadows}toggleShadow(e){this._enabled=e,this._voxelTracingPass.enabled=e,this._spatialBlurPass.enabled=e,this._accumulationPass.enabled=e,this._materialsWithRenderPlugin.forEach((t=>{t.pluginManager&&(t.pluginManager.getPlugin(PP.Name).isEnabled=e)})),this._setPluginParameters()}updateVoxelization(){0!==this._shadowCastingMeshes.length?(this._voxelRenderer.updateVoxelGrid(this._shadowCastingMeshes),this._updateSSShadowParams()):f.V.Warn("IBL Shadows: updateVoxelization called with no shadow-casting meshes to voxelize.")}updateSceneBounds(){const e={min:new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:new s.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)};this._shadowCastingMeshes.forEach((t=>{const i=t.getHierarchyBoundingVectors(!0);e.min=s.Pq.Minimize(e.min,i.min),e.max=s.Pq.Maximize(e.max,i.max)}));const t=e.max.subtract(e.min);if(this.voxelGridSize=Math.max(t.x,t.y,t.z),0===this._shadowCastingMeshes.length||!isFinite(this.voxelGridSize)||0===this.voxelGridSize)return f.V.Warn("IBL Shadows: Scene size is invalid. Can't update bounds."),void(this.voxelGridSize=1);const i=this.voxelGridSize/2,r=e.max.add(e.min).multiplyByFloats(-.5,-.5,-.5),n=s.uq.Compose(new s.Pq(1/i,1/i,1/i),new s.PT,new s.Pq(0,0,0));s.uq.Compose(new s.Pq(1,1,1),new s.PT,r).multiplyToRef(n,n),this._voxelTracingPass.setWorldScaleMatrix(n),this._voxelRenderer.setWorldScaleMatrix(n),this._spatialBlurPass.setWorldScale(2*i),this._updateSSShadowParams()}constructor(e,t,i={},r){super(t.getEngine(),e),this._allowDebugPasses=!1,this._debugPasses=[],this._shadowCastingMeshes=[],this._shadowOpacity=.8,this._enabled=!0,this._materialsWithRenderPlugin=[],this.onShadowTextureReadyObservable=new n.cP,this.onNewIblReadyObservable=new n.cP,this.voxelGridSize=1,this._renderSizeFactor=1,this._gbufferDebugEnabled=!1,this._gBufferDebugSizeParams=new s.IU(0,0,0,0),this.scene=t,this._cameras=r||[t.activeCamera];const a=new Uint8Array([0,0,0,255]);this._dummyTexture2d=new me.I(a,1,1,_i.N.TEXTUREFORMAT_RGBA,t,!1),this._dummyTexture3d=new ld(a,1,1,1,_i.N.TEXTUREFORMAT_RGBA,t,!1);const o={};o[NC.SCREENSPACE_DEPTH_TEXTURE_TYPE]={textureFormat:6,textureType:1},o[NC.VELOCITY_LINEAR_TEXTURE_TYPE]={textureFormat:7,textureType:2},o[NC.POSITION_TEXTURE_TYPE]={textureFormat:5,textureType:2},o[NC.NORMAL_TEXTURE_TYPE]={textureFormat:5,textureType:2};const l=t.enableGeometryBufferRenderer(void 0,14,o);l?(this._geometryBufferRenderer=l,this._geometryBufferRenderer.enableScreenspaceDepth=!0,this._geometryBufferRenderer.enableVelocityLinear=!0,this._geometryBufferRenderer.enablePosition=!0,this._geometryBufferRenderer.enableNormal=!0,this._geometryBufferRenderer.generateNormalsInWorldSpace=!0,this.scene.enableIblCdfGenerator(),this.shadowOpacity=i.shadowOpacity||.8,this._voxelRenderer=new xP(this.scene,this,i?i.resolutionExp:6,void 0===i.triPlanarVoxelization||i.triPlanarVoxelization),this._voxelTracingPass=new TP(this.scene,this),this._spatialBlurPass=new EP(this.scene,this),this._accumulationPass=new CP(this.scene,this),this._accumulationPass.onReadyObservable.addOnce((()=>{this.onShadowTextureReadyObservable.notifyObservers()})),this.sampleDirections=i.sampleDirections||2,this.voxelShadowOpacity=i.voxelShadowOpacity??1,this.envRotation=i.envRotation??0,this.shadowRenderSizeFactor=i.shadowRenderSizeFactor||1,this.ssShadowOpacity=void 0===i.ssShadowsEnabled||i.ssShadowsEnabled?1:0,this.ssShadowDistanceScale=i.ssShadowDistanceScale||1.25,this.ssShadowSampleCount=i.ssShadowSampleCount||16,this.ssShadowStride=i.ssShadowStride||8,this.ssShadowThicknessScale=i.ssShadowThicknessScale||1,this.shadowRemanence=i.shadowRemanence??.75,this._noiseTexture=new _e.g("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.scene,!1,!0,1),t.postProcessRenderPipelineManager.addPipeline(this),this.scene.onActiveCameraChanged.add(this._listenForCameraChanges.bind(this)),this.scene.onBeforeRenderObservable.add(this._updateBeforeRender.bind(this)),this._listenForCameraChanges(),this.scene.getEngine().onResizeObservable.add(this._handleResize.bind(this)),this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.onGeneratedObservable.add((()=>{this._setPluginParameters(),this.onNewIblReadyObservable.notifyObservers()}))):f.V.Error("Geometry buffer renderer is required for IBL shadows to work.")}_handleResize(){this._voxelRenderer.resize(),this._voxelTracingPass.resize(this.shadowRenderSizeFactor),this._spatialBlurPass.resize(this.shadowRenderSizeFactor),this._accumulationPass.resize(this.shadowRenderSizeFactor),this._setPluginParameters()}_getGBufferDebugPass(){if(this._gbufferDebugPass)return this._gbufferDebugPass;const e=this.engine.isWebGPU,t={width:this.scene.getEngine().getRenderWidth(),height:this.scene.getEngine().getRenderHeight(),samplingMode:1,engine:this.scene.getEngine(),textureType:0,textureFormat:5,uniforms:["sizeParams"],samplers:["depthSampler","normalSampler","positionSampler","velocitySampler"],reusable:!1,shaderLanguage:e?1:0,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,15465))):t.push(Promise.resolve().then(i.bind(i,22390)))}};return this._gbufferDebugPass=new jt.w("iblShadowGBufferDebug","iblShadowGBufferDebug",t),this._gbufferDebugPass.autoClear=!1,this._gbufferDebugPass.onApplyObservable.add((e=>{const t=this._geometryBufferRenderer.getTextureIndex(NC.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t]);const i=this._geometryBufferRenderer.getTextureIndex(NC.NORMAL_TEXTURE_TYPE);e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[i]);const r=this._geometryBufferRenderer.getTextureIndex(NC.POSITION_TEXTURE_TYPE);e.setTexture("positionSampler",this._geometryBufferRenderer.getGBuffer().textures[r]);const n=this._geometryBufferRenderer.getTextureIndex(NC.VELOCITY_LINEAR_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[n]),e.setVector4("sizeParams",this._gBufferDebugSizeParams),this.scene.activeCamera&&e.setFloat("maxDepth",this.scene.activeCamera.maxZ)})),this._gbufferDebugPass}_createDebugPasses(){this.scene.iblCdfGenerator?this._debugPasses=[{pass:this.scene.iblCdfGenerator.getDebugPassPP(),enabled:this.cdfDebugEnabled}]:this._debugPasses=[],this._debugPasses.push({pass:this._voxelRenderer.getDebugPassPP(),enabled:this.voxelDebugEnabled},{pass:this._voxelTracingPass.getDebugPassPP(),enabled:this.voxelTracingDebugEnabled},{pass:this._spatialBlurPass.getDebugPassPP(),enabled:this.spatialBlurPassDebugEnabled},{pass:this._accumulationPass.getDebugPassPP(),enabled:this.accumulationPassDebugEnabled},{pass:this._getGBufferDebugPass(),enabled:this.gbufferDebugEnabled});for(let e=0;e<this._debugPasses.length;e++)this._debugPasses[e].pass&&this.addEffect(new pC(this.scene.getEngine(),this._debugPasses[e].pass.name,(()=>this._debugPasses[e].pass),!0));const e=this.cameras.slice();this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this.scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.name,e);for(let e=0;e<this._debugPasses.length;e++)this._debugPasses[e].pass&&(this._debugPasses[e].enabled?this._enableEffect(this._debugPasses[e].pass.name,this.cameras):this._disableEffect(this._debugPasses[e].pass.name,this.cameras))}_disposeEffectPasses(){this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this._disposeDebugPasses(),this._reset()}_disposeDebugPasses(){for(let e=0;e<this._debugPasses.length;e++)this._disableEffect(this._debugPasses[e].pass.name,this.cameras),this._debugPasses[e].pass.dispose();this._debugPasses=[]}_updateDebugPasses(){let e=0;this._gbufferDebugEnabled&&e++,this.cdfDebugEnabled&&e++,this.voxelDebugEnabled&&e++,this.voxelTracingDebugEnabled&&e++,this.spatialBlurPassDebugEnabled&&e++,this.accumulationPassDebugEnabled&&e++;const t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t),r=1/i,n=1/t;let s=0,a=0;this.gbufferDebugEnabled&&(this._gBufferDebugSizeParams.set(s,a,i,t),s-=r,s<=-1&&(s=0,a-=n)),this.cdfDebugEnabled&&this.scene.iblCdfGenerator&&(this.scene.iblCdfGenerator.setDebugDisplayParams(s,a,i,t),s-=r,s<=-1&&(s=0,a-=n)),this.voxelDebugEnabled&&(this._voxelRenderer.setDebugDisplayParams(s,a,i,t),s-=r,s<=-1&&(s=0,a-=n)),this.voxelTracingDebugEnabled&&(this._voxelTracingPass.setDebugDisplayParams(s,a,i,t),s-=r,s<=-1&&(s=0,a-=n)),this.spatialBlurPassDebugEnabled&&(this._spatialBlurPass.setDebugDisplayParams(s,a,i,t),s-=r,s<=-1&&(s=0,a-=n)),this.accumulationPassDebugEnabled&&(this._accumulationPass.setDebugDisplayParams(s,a,i,t),s-=r,s<=-1&&(s=0,a-=n))}_updateSSShadowParams(){this._voxelTracingPass.sssMaxDist=this._sssMaxDistScale*this.voxelGridSize/(1<<this.resolutionExp),this._voxelTracingPass.sssThickness=.005*this._sssThicknessScale*this.voxelGridSize}addShadowReceivingMaterial(e){e?Array.isArray(e)?e.forEach((e=>{this._addShadowSupportToMaterial(e)})):this._addShadowSupportToMaterial(e):this.scene.materials.forEach((e=>{this._addShadowSupportToMaterial(e)}))}removeShadowReceivingMaterial(e){if(Array.isArray(e))e.forEach((e=>{const t=this._materialsWithRenderPlugin.indexOf(e);if(-1!==t){this._materialsWithRenderPlugin.splice(t,1);const i=e.pluginManager?.getPlugin(PP.Name);i.isEnabled=!1}}));else{const t=this._materialsWithRenderPlugin.indexOf(e);-1!==t&&(this._materialsWithRenderPlugin.splice(t,1),e.pluginManager.getPlugin(PP.Name).isEnabled=!1)}}_addShadowSupportToMaterial(e){if(!(e instanceof Pu.d||e instanceof Oi.F))return;let t=e.pluginManager?.getPlugin(PP.Name);t||(t=new PP(e)),-1===this._materialsWithRenderPlugin.indexOf(e)&&(this._enabled&&(t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity),t.isEnabled=this._enabled,this._materialsWithRenderPlugin.push(e))}_setPluginParameters(){this._enabled&&this._materialsWithRenderPlugin.forEach((e=>{if(e.pluginManager){const t=e.pluginManager.getPlugin(PP.Name);t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity}}))}_updateBeforeRender(){this._updateDebugPasses()}_listenForCameraChanges(){this.scene.activeCamera?.onViewMatrixChangedObservable.add((()=>{this._accumulationPass.isMoving=!0}))}isReady(){return this._noiseTexture.isReady()&&this._voxelRenderer.isReady()&&this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.isReady()&&(!this._voxelTracingPass||this._voxelTracingPass.isReady())&&(!this._spatialBlurPass||this._spatialBlurPass.isReady())&&(!this._accumulationPass||this._accumulationPass.isReady())}getClassName(){return"IBLShadowsRenderPipeline"}dispose(){this._materialsWithRenderPlugin.splice(0).forEach((e=>{this.removeShadowReceivingMaterial(e)})),this._disposeEffectPasses(),this._noiseTexture.dispose(),this._voxelRenderer.dispose(),this._voxelTracingPass.dispose(),this._spatialBlurPass.dispose(),this._accumulationPass.dispose(),this._dummyTexture2d.dispose(),this._dummyTexture3d.dispose(),this.onNewIblReadyObservable.clear(),this.onShadowTextureReadyObservable.clear(),super.dispose()}}class AP extends td{constructor(e,t,i,r,n,s){super(e,i,r,n,s),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new RC("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();i===e&&r===t||(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class RP{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty())}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._scene.activeCamera?.renderPassId??this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer)return void(this.doNotUseGeometryRendererFallback=!0);this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new a.ov(0,0,0,0),this._clearDepthColor=new a.ov(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine();let t=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=2);for(let e=0;e<RP.TextureFormats.length;++e){const i=RP.TextureFormats[e].format;1===RP.TextureFormats[e].type&&(RP.TextureFormats[e].type=t,1!==t||6!==i&&7!==i&&5!==i||this._engine._caps.supportFloatTexturesResolve||(RP.TextureFormats[e].type=2))}RP._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){const i=new AP(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),this._enabled&&this._update(),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),r=i&&i.isPrePassCapable,n=i&&-1!==this.excludedMaterials.indexOf(i);this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&r&&!n?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!n&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!1],r=[!0];for(let n=0;n<this.mrtCount;n++)e.push(!0),n>0&&(this._useSpecificClearForDepthTexture&&5===this._mrtLayout[n]?(t.push(!1),i.push(!0)):(t.push(!0),i.push(!1)),r.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(i),this._defaultAttachments=this._engine.buildTextureLayout(r)}_resetLayout(){for(let e=0;e<RP.TextureFormats.length;e++)this._textureIndices[RP.TextureFormats[e].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[RP.TextureFormats[4].type],this._mrtFormats=[RP.TextureFormats[4].format],this._mrtNames=[RP.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let t=0;t<this._mrtLayout.length;t++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:NC.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:NC.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:NC.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:NC.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:NC.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const r=this._mrtLayout.indexOf(t[i].prePassConstant);-1!==r&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,r),e[r]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return!!t&&(t.inputTexture=e.renderTarget,!0)}_renderPostProcesses(e,t){const i=this._postProcessesSourceForThisPass[0],r=i?i.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let n=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(n=n.concat([this._currentTarget.imageProcessingPostProcess])),n.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.renderTarget?.texture,n),this._scene.postProcessManager.directRender(n,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){const e=this.mrtCount;for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&this._enableTextures(this._effectConfigurations[e].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){this.mrtCount===e&&this.renderTargets[t].count===this.mrtCount||this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&(!this._effectConfigurations[e].postProcess&&this._effectConfigurations[e].createPostProcess&&this._effectConfigurations[e].createPostProcess(),this._effectConfigurations[e].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[e].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture){if(e.renderTargetTexture.useCameraPostProcesses){const t=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return t?t._postProcesses:[]}return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[]}return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&0!==this._scene.activeCameras.indexOf(t);this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter((e=>null!=e)),this._scene.autoClear=!0;const r=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!r&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const n=this._getFirstPostProcess(this._postProcessesSourceForThisPass),s=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let a=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||r,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),s?a=s:this._needsCompositionForThisPass?a=e.imageProcessingPostProcess:n&&(a=n),this._bindFrameBuffer(),this._linkInternalTexture(e,a)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){let t=!1;if(e)for(let i=0;i<e.length;i++)if("ImageProcessingPostProcess"===e[i]?.getClassName()){t=!0;break}return t}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(null!==e[t])return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];-1===this._textureIndices[i]&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtTypes.push(RP.TextureFormats[i].type),this._mrtFormats.push(RP.TextureFormats[i].format),this._mrtNames.push(RP.TextureFormats[i].name),this.mrtCount++),2!==i&&11!==i||(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){this._disable();let e,t=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=!0);for(let e=0;e<this._scene.materials.length;e++)this._scene.materials[e].setPrePassRenderer(this)&&(t=!0);t&&this._setRenderTargetEnabled(this.defaultRT,!0);for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)e=this._getPostProcessesSource(this.renderTargets[i]);else{const t=this._scene.activeCamera;if(!t)continue;e=t._postProcesses}if(e&&(e=e.filter((e=>null!=e)),e)){for(let r=0;r<e.length;r++)e[r].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),t=!0);this._hasImageProcessing(e)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,t&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(Zl.i.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}RP._SceneComponentInitialization=e=>{throw(0,Oc.n)("PrePassRendererSceneComponent")},RP.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"},{purpose:8,type:0,format:5,name:"prePass_WorldNormal"},{purpose:9,type:2,format:5,name:"prePass_LocalPosition"},{purpose:10,type:1,format:6,name:"prePass_ScreenDepth"},{purpose:11,type:2,format:5,name:"prePass_VelocityLinear"}],Object.defineProperty(kt.Z.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(e){e&&e.isSupported&&(this._prePassRenderer=e)},enumerable:!0,configurable:!0}),kt.Z.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new RP(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,f.V.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},kt.Z.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class IP{constructor(e){this.name=Gt.v.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(Gt.v.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(Gt.v.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(Gt.v.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(Gt.v.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(Gt.v.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(Gt.v.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(Gt.v.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(Gt.v.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,r){if(!r)return;const n=e.getScene();n.prePassRenderer&&n.prePassRenderer.bindAttachmentsForEffect(r,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){}dispose(){this.scene.disablePrePassRenderer()}}RP._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_PREPASSRENDERER);t||(t=new IP(e),e._addComponent(t))};ri.l.IncludesShadersStore.fibonacci="#define rcp(x) 1./x\n#define GOLDEN_RATIO 1.618033988749895\n#define TWO_PI 6.2831855\nvec2 Golden2dSeq(int i,float n)\n{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}\nvec2 SampleDiskGolden(int i,int sampleCount)\n{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}",i(15096);ri.l.IncludesShadersStore.diffusionProfile="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";ri.l.ShadersStore.subSurfaceScatteringPixelShader="#include<fibonacci>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<diffusionProfile>\nvarying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;\n#define rcp(x) 1./x\n#define Sq(x) x*x\n#define SSS_BILATERAL_FILTER true\nvec3 EvalBurleyDiffusionProfile(float r,vec3 S)\n{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); \nvec3 expSum=exp_13*(1.+exp_13*exp_13); \nreturn (S*rcp(8.*PI))*expSum; }\nvec2 SampleBurleyDiffusionProfile(float u,float rcpS)\n{u=1.-u; \nfloat g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); \nfloat p=(g*n)*n; \nfloat c=1.+p+n; \nfloat d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); \nfloat x=(3./LOG2_E)*log2(c)-d; \nfloat rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; \nreturn vec2(r,rcpPdf);}\nvec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)\n{\n#ifndef SSS_BILATERAL_FILTER\nz=0.;\n#endif\nfloat r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;\n#if SSS_CLAMP_ARTIFACT\nreturn clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);\n#else\nreturn EvalBurleyDiffusionProfile(r,S)*area;\n#endif\n}\nvoid EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,\nfloat phase,inout vec3 totalIrradiance,inout vec3 totalWeight)\n{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; \nfloat cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; \nvec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; \nfloat xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))\n{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}\nelse\n{}}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)\n{centerDepth=texture2D(depthSampler,vUV).r;}\nif (!passedStencilTest) { \ngl_FragColor=inputColor;return;}\nfloat distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; \nvec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; \nfloat mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)\n{\n#ifdef DEBUG_SSS_SAMPLES\nvec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;\n#endif\ngl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}\n#ifdef DEBUG_SSS_SAMPLES\nvec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;\n#endif\nfloat phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); \nvec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)\n{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,\nphase,totalIrradiance,totalWeight);}\ntotalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}";class MP extends jt.w{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,r=null,n,s,a,o=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,r,n||_e.g.BILINEAR_SAMPLINGMODE,s,a,null,o,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add((e=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration)return void f.V.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");const i=this.texelSize;e.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),e.setFloat2("texelSize",i.x,i.y),e.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),e.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),e.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),e.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),e.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),e.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),e.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)}))}}class OP{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=Gt.v.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new a.v9(1,1,1)),this._scene=e,OP._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return f.V.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[3*t]===e.r&&this._ssDiffusionS[3*t+1]===e.g&&this._ssDiffusionS[3*t+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new MP("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const t=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,t)}_sampleBurleyDiffusionProfile(e,t){const i=1+4*(e=1-e)*(2*e+Math.sqrt(1+4*e*e)),r=Math.pow(i,-1/3),n=1+i*r*r+r;return 3*Math.log(n/(4*e))*t}}OP._SceneComponentInitialization=e=>{throw(0,Oc.n)("SubSurfaceSceneComponent")},(0,Dc.ji)(Gt.v.NAME_SUBSURFACE,((e,t)=>{if(void 0!==e.ssDiffusionProfileColors&&null!==e.ssDiffusionProfileColors&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(let i=0,r=e.ssDiffusionProfileColors.length;i<r;i++){const r=e.ssDiffusionProfileColors[i];t.subSurfaceConfiguration.addDiffusionProfile(new a.v9(r.r,r.g,r.b))}})),Object.defineProperty(kt.Z.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(e){e&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=e)},enumerable:!0,configurable:!0}),kt.Z.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const e=this.enablePrePassRenderer();return e?(this._subSurfaceConfiguration=new OP(this),e.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},kt.Z.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class NP{constructor(e){this.name=Gt.v.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}OP._SceneComponentInitialization=e=>{let t=e._getComponent(Gt.v.NAME_SUBSURFACE);t||(t=new NP(e),e._addComponent(t))},kt.Z.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new DP(this)),this._outlineRenderer},Object.defineProperty(Rt.e.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOutline=e},enumerable:!0,configurable:!0}),Object.defineProperty(Rt.e.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOverlay=e},enumerable:!0,configurable:!0});class DP{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=Gt.v.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this._shaderLanguage=0,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<4;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Outline Renderer (${e})`);this._engine.isWebGPU&&(this._shaderLanguage=1)}register(){this.scene._beforeRenderingMeshStage.registerStep(Gt.v.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(Gt.v.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,r){r=r??this._passIdForDrawWrapper[0];const n=this.scene,s=n.getEngine(),a=s.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,a,r))return;const o=e.getMesh(),l=o._internalAbstractMeshDataInfo._actAsRegularMesh?o:null,c=e.getRenderingMesh(),h=l||c,u=e.getMaterial();if(!u||!n.activeCamera)return;const d=e._getDrawWrapper(r),p=ec.E.GetEffect(d);s.enableEffect(d),u.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(n.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:c.outlineWidth),p.setColor4("color",i?c.overlayColor:c.outlineColor,i?c.overlayAlpha:u.alpha),p.setMatrix("viewProjection",n.getTransformMatrix()),p.setMatrix("world",h.getWorldMatrix()),(0,qo.f$)(c,p),(0,qo.nR)(c,p),c.morphTargetManager&&c.morphTargetManager.isUsingTextureForTargets&&c.morphTargetManager._bind(p),a||c._bind(e,p,u.fillMode);const f=e.getMesh().bakedVertexAnimationManager;if(f&&f.isEnabled&&f.bind(p,a),u&&u.needAlphaTesting()){const e=u.getAlphaTestTexture();e&&(p.setTexture("diffuseSampler",e),p.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,Xo.gS)(p,u,n),s.setZOffset(-this.zOffset),s.setZOffsetUnits(-this.zOffsetUnits),c._processRendering(h,e,p,u.fillMode,t,a,((e,t)=>{p.setMatrix("world",t)})),s.setZOffset(0),s.setZOffsetUnits(0)}isReady(e,t,r){r=r??this._passIdForDrawWrapper[0];const n=[],s=[Ue.R.PositionKind,Ue.R.NormalKind],a=e.getMesh(),o=e.getMaterial();if(!o)return!1;const l=a.getScene();o.needAlphaTesting()&&(n.push("#define ALPHATEST"),a.isVerticesDataPresent(Ue.R.UVKind)&&(s.push(Ue.R.UVKind),n.push("#define UV1")),a.isVerticesDataPresent(Ue.R.UV2Kind)&&(s.push(Ue.R.UV2Kind),n.push("#define UV2"))),o.useLogarithmicDepth&&n.push("#define LOGARITHMICDEPTH"),(0,Xo.tv)(o,l,n);const c=new Yo.J;if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){s.push(Ue.R.MatricesIndicesKind),s.push(Ue.R.MatricesWeightsKind),a.numBoneInfluencers>4&&(s.push(Ue.R.MatricesIndicesExtraKind),s.push(Ue.R.MatricesWeightsExtraKind));const e=a.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),a.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,a),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");const h=a.morphTargetManager;let u=0;h&&(u=h.numMaxInfluencers||h.numInfluencers,u>0&&(n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+u),h.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),(0,qo.MF)(s,a,u))),t&&(n.push("#define INSTANCES"),(0,qo.te)(s),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const d=a.bakedVertexAnimationManager;d&&d.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&s.push("bakedVertexAnimationSettingsInstanced"));const p=e._getDrawWrapper(r,!0),f=p.defines,m=n.join("\n");if(f!==m){const e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];(0,Xo.TV)(e),p.setEffect(this.scene.getEngine().createEffect("outline",{attributes:s,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:m,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:u},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,76398)),Promise.resolve().then(i.bind(i,29860))]):await Promise.all([Promise.resolve().then(i.bind(i,47725)),Promise.resolve().then(i.bind(i,57447))])}},this.scene.getEngine()),m)}return p.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const r=t.getMaterial();r&&r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(DP._StencilReference),this._engine.setStencilFunctionReference(DP._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const e=this._engine.getAlphaMode(),r=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(e),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=r}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}DP._StencilReference=4;var FP,LP=i(38664);class wP{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&this._hasVelocity()&&(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){return!!this.vertexBuffers?.velocity}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}get shaderLanguage(){return this._shaderLanguage}constructor(e,t){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new n.cP,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null,this._shaderLanguage=t??(this._engine.isWebGPU?1:0)}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],r=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),r.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new Ks.$({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:r,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,17887)),Promise.resolve().then(i.bind(i,45973))]):await Promise.all([Promise.resolve().then(i.bind(i,62960)),Promise.resolve().then(i.bind(i,69418))])}}),e.push("particleAlpha"),this._thicknessEffectWrapper=new Ks.$({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,5662)),Promise.resolve().then(i.bind(i,77584))]):await Promise.all([Promise.resolve().then(i.bind(i,77517)),Promise.resolve().then(i.bind(i,61139))])}})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const e=this._depthEffectWrapper.drawWrapper.effect,t=this._thicknessEffectWrapper.drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||0===e)return;const t=this._depthEffectWrapper.drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||0===e)return;const t=this._thicknessEffectWrapper.drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){this._depthEffectWrapper?.dispose(!1),this._thicknessEffectWrapper?.dispose(!1),this.onParticleSizeChanged.clear()}}class BP extends wP{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add((()=>{this._engine.setAlphaMode(2)}))))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t,i){super(e,i),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class VP{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,null!==this._blurPostProcesses)){const e=this._blurPostProcesses[0],t=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let i=0;i<2*this._blurNumIterations;++i)this._blurPostProcesses[i]=1&i?t:e}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,s,a,o=1,l=6,c=1,h=6,u=!1,d=null,p=!0,f=1,m){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new n.cP,this._shaderLanguage=0,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=r,this._blurTextureSizeX=s,this._blurTextureSizeY=a,this._textureType=o,this._textureFormat=l,this._blurTextureType=c,this._blurTextureFormat=h,this._useStandardBlur=u,this._generateDepthBuffer=p,this._samples=f,this._postProcessRunningIndex=0,this.enableBlur=0!==s&&0!==a,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null,this._shaderLanguage=m??(this._engine.isWebGPU?1:0)}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});const e=this._rt.texture;e.incrementReferences(),this._texture=new _e.g(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=_e.g.CLAMP_ADDRESSMODE,this._texture.wrapV=_e.g.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,r,n,a,o=!1){const l=this._scene.getEngine(),c=new s.I9(Math.floor(this._blurTextureSizeX/n),Math.floor(this._blurTextureSizeY/n)),h=1===t&&l.getCaps().textureFloatLinearFiltering||2===t&&l.getCaps().textureHalfFloatLinearFiltering,u=this._engine.createRenderTargetTexture({width:c.x,height:c.y},{generateMipMaps:!1,type:t,format:r,samplingMode:h?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${a}`}),d=u.texture;d.incrementReferences();const p=new _e.g(null,this._scene);if(p.name="rttBlurred"+a,p._texture=d,p.wrapU=_e.g.CLAMP_ADDRESSMODE,p.wrapV=_e.g.CLAMP_ADDRESSMODE,p.anisotropicFilteringLevel=1,o){const n=new jt.w("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,86318)):await Promise.resolve().then(i.bind(i,30019))}));n.samples=this._samples,n.externalTextureSamplerBinding=!0,n.onApplyObservable.add((t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",n.inputTexture.texture),t.setInt("filterSize",this.blurFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++})),n.onSizeChangedObservable.add((()=>{n._textures.forEach((e=>{e.texture.wrapU=_e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=_e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(n);const s=new jt.w("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,86318)):await Promise.resolve().then(i.bind(i,30019))}));s.samples=this._samples,s.onApplyObservable.add((e=>{e.setInt("filterSize",this.blurFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++})),s.onSizeChangedObservable.add((()=>{s._textures.forEach((e=>{e.texture.wrapU=_e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=_e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(s),n.autoClear=!1,s.autoClear=!1;const a=[];for(let e=0;e<2*this._blurNumIterations;++e)a[e]=1&e?s:n;return[u,p,a]}{const n=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],s=new jt.w("BilateralBlurX","fluidRenderingBilateralBlur",n,null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,74351)):await Promise.resolve().then(i.bind(i,66984))}));s.samples=this._samples,s.externalTextureSamplerBinding=!0,s.onApplyObservable.add((t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",s.inputTexture.texture),t.setInt("maxFilterSize",this.blurMaxFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),t.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),t.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++})),s.onSizeChangedObservable.add((()=>{s._textures.forEach((e=>{e.texture.wrapU=_e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=_e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(s);const a=new jt.w("BilateralBlurY","fluidRenderingBilateralBlur",n,null,1,null,1,l,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,(async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,74351)):await Promise.resolve().then(i.bind(i,66984))}));a.samples=this._samples,a.onApplyObservable.add((e=>{e.setInt("maxFilterSize",this.blurMaxFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),e.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),e.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++})),a.onSizeChangedObservable.add((()=>{a._textures.forEach((e=>{e.texture.wrapU=_e.g.CLAMP_ADDRESSMODE,e.texture.wrapV=_e.g.CLAMP_ADDRESSMODE}))})),this._fixReusablePostProcess(a),s.autoClear=!1,a.autoClear=!1;const o=[];for(let e=0;e<2*this._blurNumIterations;++e)o[e]=1&e?a:s;return[u,p,o]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add((()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2})),e.onApplyObservable.add((()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2})))}_getProjectedParticleConstant(){return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((this._camera?.fov??45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._rt?.dispose(),this._rt=null,this._texture?.dispose(),this._texture=null,this._rtBlur?.dispose(),this._rtBlur=null,this._textureBlurred?.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}!function(e){e[e.DepthTexture=0]="DepthTexture",e[e.DepthBlurredTexture=1]="DepthBlurredTexture",e[e.ThicknessTexture=2]="ThicknessTexture",e[e.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",e[e.DiffuseTexture=4]="DiffuseTexture",e[e.Normals=5]="Normals",e[e.DiffuseRendering=6]="DiffuseRendering"}(FP||(FP={}));class kP{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get compositeMode(){return this._compositeMode}set compositeMode(e){this._compositeMode!==e&&(this._compositeMode=e,this._needInitialization=!0)}get camera(){return this._camera}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this._generateDiffuseTexture=!1,this.fluidColor=new a.v9(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new s.Pq(-2,-1,1).normalize(),this._debugFeature=1,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new n.cP,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._compositeMode=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new s.uq,this._depthClearColor=new a.ov(1e6,1e6,1e6,1),this._thicknessClearColor=new a.ov(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null,this._shaderLanguage=i??(this._engine.isWebGPU?1:0)}_initialize(){this.dispose(),this._needInitialization=!1;const e=this._depthMapSize??this._engine.getRenderWidth(),t=null!==this._depthMapSize?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new VP("Depth",this._scene,e,t,e,t,1,7,1,7,!1,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const e=this._diffuseMapSize??this._engine.getRenderWidth(),t=null!==this._diffuseMapSize?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new VP("Diffuse",this._scene,e,t,0,0,0,5,0,5,!0,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._diffuseRenderTarget)}const i=this._thicknessMapSize??this._engine.getRenderWidth(),r=null!==this._thicknessMapSize?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new VP("Thickness",this._scene,i,r,i,r,2,6,2,6,!0,this._camera,!1,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){null!==e&&e!==this._depthRenderTarget||this._setBlurDepthParameters(),null!==e&&e!==this._thicknessRenderTarget||this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){const e=this._scene.getEngine(),t=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],r=["depthSampler"],n=[];if(this.dispose(!0),!this._camera)return;const a=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,o=new s.I9(1/a.getSize().width,1/a.getSize().height);this._scene.useRightHandedSystem&&n.push("#define FLUIDRENDERING_RHS"),null!==this._environmentMap&&(this._environmentMap??this._scene.environmentTexture)&&(r.push("reflectionSampler"),n.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(r.push("diffuseSampler"),n.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):t.push("diffuseColor"),this._useVelocity&&(r.push("velocitySampler"),n.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(t.push("thickness"),r.push("bgDepthSampler"),n.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(t.push("minimumThickness"),r.push("thicknessSampler")),this._compositeMode&&n.push("#define FLUIDRENDERING_COMPOSITE_MODE"),this._debug&&(n.push("#define FLUIDRENDERING_DEBUG"),5===this._debugFeature?n.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):6===this._debugFeature?n.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(n.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),r.push("debugSampler"),0!==this._debugFeature&&1!==this._debugFeature||n.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new jt.w("FluidRendering","fluidRenderingRender",t,r,1,null,2,e,!1,null,0,void 0,void 0,!0,void 0,this._shaderLanguage,(async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,5282)):await Promise.resolve().then(i.bind(i,52667))})),this._renderPostProcess.updateEffect(n.join("\n")),this._renderPostProcess.samples=this._samples;const l=e,c=l.setTextureSampler;this._renderPostProcess.onApplyObservable.add((e=>{if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),c&&c.call(l,"textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(e.setTexture("depthSampler",this._depthRenderTarget.textureBlur),c&&c.call(l,"depthSamplerSampler",this._depthRenderTarget.textureBlur?.getInternalTexture()??null)):(e.setTexture("depthSampler",this._depthRenderTarget.texture),c&&c.call(l,"depthSamplerSampler",this._depthRenderTarget.texture?.getInternalTexture()??null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(e.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),c&&c.call(l,"diffuseSamplerSampler",this._diffuseRenderTarget.textureBlur?.getInternalTexture()??null)):(e.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),c&&c.call(l,"diffuseSamplerSampler",this._diffuseRenderTarget.texture?.getInternalTexture()??null)):e.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(e.setFloat("thickness",this.minimumThickness),e._bindTexture("bgDepthSampler",this._bgDepthTexture),c&&c.call(l,"bgDepthSamplerSampler",this._bgDepthTexture??null)):(this._thicknessRenderTarget.enableBlur?(e.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),c&&c.call(l,"thicknessSamplerSampler",this._thicknessRenderTarget.textureBlur?.getInternalTexture()??null)):(e.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),c&&c.call(l,"thicknessSamplerSampler",this._thicknessRenderTarget.texture?.getInternalTexture()??null)),e.setFloat("minimumThickness",this.minimumThickness)),null!==this._environmentMap){const t=this._environmentMap??this._scene.environmentTexture;t&&(e.setTexture("reflectionSampler",t),c&&c.call(l,"reflectionSamplerSampler",t?.getInternalTexture()??null))}if(e.setMatrix("viewMatrix",this._scene.getViewMatrix()),e.setMatrix("invProjectionMatrix",this._invProjectionMatrix),e.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),e.setVector2("texelSize",o),e.setFloat("density",this.density),e.setFloat("refractionStrength",this.refractionStrength),e.setFloat("fresnelClamp",this.fresnelClamp),e.setFloat("specularPower",this.specularPower),e.setVector3("dirLight",this.dirLight),e.setFloat("cameraFar",this._camera.maxZ),this._debug){let t=null;switch(this._debugFeature){case 0:t=this._depthRenderTarget.texture;break;case 1:t=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case 2:t=this._thicknessRenderTarget?.texture??null;break;case 3:t=this._thicknessRenderTarget?.enableBlur?this._thicknessRenderTarget?.textureBlur??null:this._thicknessRenderTarget?.texture??null;break;case 4:this._diffuseRenderTarget&&(t=this._diffuseRenderTarget.texture)}5!==this._debugFeature&&(e.setTexture("debugSampler",t),c&&c.call(l,"debugSamplerSampler",t?.getInternalTexture()??null))}}))}_clearTargets(){this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){if(this._needInitialization||!e.isReady())return;const t=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),this._depthRenderTarget?.applyBlurPostProcesses(),this._diffuseRenderTarget?.applyBlurPostProcesses(),this._thicknessRenderTarget?.applyBlurPostProcesses(),t&&this._engine.bindFramebuffer(t)}dispose(e=!1){e||(this._depthRenderTarget?.dispose(),this._depthRenderTarget=null,this._diffuseRenderTarget?.dispose(),this._diffuseRenderTarget=null,this._thicknessRenderTarget?.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),this._renderPostProcess?.dispose(),this._renderPostProcess=null,this._onUseVelocityChanged.clear(),this._needInitialization=!1}}class GP extends wP{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i,r){super(e,r),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,r=!0;switch(t){case"velocity":i=3;break;case"offset":r=!1}this._vertexBuffers[t]=new Ue.R(this._engine,e[t],t,!0,!1,i,r)}}_createEffects(){super._createEffects(),this._diffuseEffectWrapper=new Ks.$({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:["position","offset","color"],uniformNames:["view","projection","size"],samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,51080)):await Promise.resolve().then(i.bind(i,68647))}})}isReady(){return this._vertexBuffers.offset||(this._vertexBuffers.offset=new Ue.R(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&(this._diffuseEffectWrapper?.effect.isReady()??!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||0===e)return;const t=this._diffuseEffectWrapper.drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),null!==this._particleSize&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){super.dispose(),this._diffuseEffectWrapper?.dispose();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();this._vertexBuffers={}}}class UP{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,r=1){this._engine=e,this._copyTextureToTexture=new Zs(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:r,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"}),this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil").label=`FluidDepthTextureCopy${t}x${i}x${r}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}function zP(e){return!!e.particleSystem}function WP(e){return!!e.addBuffers}Object.defineProperty(kt.Z.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(e){this._fluidRenderer=e},enumerable:!0,configurable:!0}),kt.Z.prototype.enableFluidRenderer=function(){return this._fluidRenderer||(this._fluidRenderer=new YP(this)),this._fluidRenderer},kt.Z.prototype.disableFluidRenderer=function(){this._fluidRenderer?.dispose(),this._fluidRenderer=null};class HP{constructor(e){this.name=Gt.v.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(Gt.v.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(Gt.v.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){this.scene.fluidRenderer?._prepareRendering()}_afterCameraDraw(e){this.scene.fluidRenderer?._render(e)}rebuild(){const e=this.scene.fluidRenderer;if(!e)return;const t=new Set;for(let i=0;i<e.renderObjects.length;++i){const r=e.renderObjects[i].object;if(WP(r)){const e=r.vertexBuffers;for(const i in e)t.add(e[i].getWrapperBuffer())}}t.forEach((e=>{e._rebuild()}))}dispose(){this.scene.disableFluidRenderer()}}class YP{static _SceneComponentInitialization(e){let t=e._getComponent(Gt.v.NAME_FLUIDRENDERER);t||(t=new HP(e),e._addComponent(t))}get shaderLanguage(){return this._shaderLanguage}constructor(e){this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,YP._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add((()=>{this._initialize()})),this._engine.isWebGPU&&(this._shaderLanguage=1)}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return-1!==t?this.renderObjects[t]:null}addParticleSystem(e,t,i,r){const n=new BP(this._scene,e,this._shaderLanguage);n.onParticleSizeChanged.add((()=>this._setParticleSizeForRenderTargets())),i||(i=new kP(this._scene,r,this._shaderLanguage),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add((()=>this._setUseVelocityForRenderObject())),void 0!==t&&(i.generateDiffuseTexture=t);const s={object:n,targetRenderer:i};return this.renderObjects.push(s),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),s}addCustomParticles(e,t,i,r,n){const s=new GP(this._scene,e,t,this._shaderLanguage);s.onParticleSizeChanged.add((()=>this._setParticleSizeForRenderTargets())),r||(r=new kP(this._scene,n,this._shaderLanguage),this.targetRenderers.push(r)),r._onUseVelocityChanged.hasObservers()||r._onUseVelocityChanged.add((()=>this._setUseVelocityForRenderObject())),void 0!==i&&(r.generateDiffuseTexture=i);const a={object:s,targetRenderer:r};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return-1!==i&&(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort(((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0))}_removeUnusedTargetRenderers(){const e={};for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].targetRenderer;e[this.targetRenderers.indexOf(i)]=!0}let t=!1;const i=[];for(let r=0;r<this.targetRenderers.length;++r)e[r]?i.push(this.targetRenderers[r]):(this.targetRenderers[r].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(zP(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();const e=new Map;for(let t=0;t<this.targetRenderers.length;++t){const i=this.targetRenderers[t];if(i._initialize(),i.camera&&i._renderPostProcess){let r=e.get(i.camera);r||(r=[[],{}],e.set(i.camera,r)),r[0].push(i),i.camera.attachPostProcess(i._renderPostProcess,t)}}let t=e.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,r=e.get(t),n=t._getFirstPostProcess();if(!n)continue;const[s,a]=r;n.onSizeChangedObservable.add((()=>{n.inputTexture.depthStencilTexture||n.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,s[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${n.name}`);for(const e of s){const t=e._thicknessRenderTarget?.renderTarget,i=t?.texture;if(t&&i){const e=i.width+"_"+i.height;let r=a[e];r||(r=a[e]=new UP(this._engine,i.width,i.height)),r.depthRTWrapper.shareDepth(t)}}}))}t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,r=this._cameras.get(t)[1],n=e.get(t);if(n)for(const e in r)n[1][e]||r[e].dispose();else for(const e in r)r[e].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let r=e.get(i.targetRenderer);void 0===r&&(r=0),e.set(i.targetRenderer,Math.max(r,i.object.particleSize))}e.forEach(((e,t)=>{t._depthRenderTarget&&(t._depthRenderTarget.particleSize=e)}))}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization)return void this._initialize()}_render(e){for(let t=0;t<this.targetRenderers.length;++t)e&&this.targetRenderers[t].camera!==e||this.targetRenderers[t]._clearTargets();const t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){const t=i.value,r=this._cameras.get(t);if(e&&t!==e)continue;const n=t._getFirstPostProcess();if(!n)continue;const s=n.inputTexture?.depthStencilTexture;if(s){const[e,t]=r;for(const t of e)t._bgDepthTexture=s;for(const e in t)t[e].copy(s)}}for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];e&&i.targetRenderer.camera!==e||i.targetRenderer._render(i.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach((e=>{const t=e[1];for(const e in t)t[e].dispose()})),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}var XP=i(62960),qP=i(69418),$P=i(77517),jP=i(61139);const KP="fluidRenderingParticleDiffuseVertexShader",ZP="attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}\n";ri.l.ShadersStore[KP]=ZP;const QP={name:KP,shader:ZP};var JP=i(68647),ey=i(66984),ty=i(30019),iy=i(52667),ry=i(17887),ny=i(45973),sy=i(5662),ay=i(77584);const oy="fluidRenderingParticleDiffuseVertexShader",ly="attribute position: vec3f;attribute offset: vec2f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying diffuseColor: vec3f;@vertex\nfn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(\nvec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,\n0.0\n);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.diffuseColor=input.color.rgb;}\n";ri.l.ShadersStoreWGSL[oy]=ly;const cy={name:oy,shader:ly};var hy=i(51080),uy=i(74351),dy=i(86318),py=i(5282);class fy{get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this._customRenderTarget(e))}get positionWorldTexture(){return this._mrt.textures[0]}get normalWorldTexture(){return this._mrt.textures[1]}get fluxTexture(){return this._mrt.textures[2]}get renderList(){return this._mrt.renderList}get light(){return this._light}constructor(e,t,i={width:512,height:512}){this._lightTransformMatrix=s.uq.Identity(),this._enable=!1,this.forceUpdateLightParameters=!1,this._scene=e,this._light=t,this._textureDimensions=i,this._regularMatToMatWithPlugin=new Map,this._counters=[{name:"RSM Generation "+t.name,value:0}],this._createMultiRenderTarget(),this._recomputeLightTransformationMatrix(),this.enable=!0}setTextureDimensions(e){const t=this._mrt.renderList;this._textureDimensions=e,this._disposeMultiRenderTarget(),this._createMultiRenderTarget(),t?.forEach((e=>{this._addMeshToMRT(e)}))}addMesh(e){e?this._addMeshToMRT(e):this._scene.meshes.forEach((e=>{this._addMeshToMRT(e)})),this._recomputeLightTransformationMatrix()}updateLightParameters(){this._recomputeLightTransformationMatrix()}get lightTransformationMatrix(){return this.forceUpdateLightParameters&&this.updateLightParameters(),this._lightTransformMatrix}get countersGPU(){return this._counters}dispose(){this._disposeMultiRenderTarget()}_createMultiRenderTarget(){const e=this._light.name,t=this._scene.getEngine().getCaps(),i=t.rg11b10ufColorRenderable?13:2,r=t.rg11b10ufColorRenderable?4:5;let n,s;this._mrt=new td("RSMmrt_"+e,this._textureDimensions,3,this._scene,{types:[2,11,i],samplingModes:[2,2,2],generateMipMaps:!1,targetTypes:[3553,3553,3553],formats:[5,5,r]},["RSMPosition_"+e,"RSMNormal_"+e,"RSMFlux_"+e]),this._mrt.renderList=[],this._mrt.clearColor=new a.ov(0,0,0,1),this._mrt.noPrePassRenderer=!0;const o=this._scene.getEngine().supportsUniformBuffers;let l;o&&(n=this._scene.createSceneUniformBuffer(`Scene for RSM (light "${e}")`)),this._mrt.onBeforeBindObservable.add((()=>{s=this._scene.getSceneUniformBuffer(),l=this._light.shadowEnabled,this._light.shadowEnabled=!1})),this._mrt.onBeforeRenderObservable.add((e=>{n&&this._scene.setSceneUniformBuffer(n);const t=this._light.getViewMatrix(e),i=this._light.getProjectionMatrix(t||void 0,this._mrt.renderList||void 0);t&&i&&this._scene.setTransformMatrix(t,i),o&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._mrt.onAfterUnbindObservable.add((()=>{n&&this._scene.setSceneUniformBuffer(s),this._scene.updateTransformMatrix(),this._light.shadowEnabled=l,this._counters[0].value=this._mrt.renderTarget.gpuTimeInFrame?.counter.lastSecAverage??0})),this._customRenderTarget(!0)}_customRenderTarget(e){const t=this._scene.customRenderTargets.indexOf(this._mrt);e?-1===t&&this._scene.customRenderTargets.push(this._mrt):-1!==t&&this._scene.customRenderTargets.splice(t,1)}_recomputeLightTransformationMatrix(){const e=this._light.getViewMatrix(),t=this._light.getProjectionMatrix(e||void 0,this._mrt.renderList||void 0);e&&t&&e.multiplyToRef(t,this._lightTransformMatrix)}_addMeshToMRT(e){this._mrt.renderList?.push(e);const t=e.material;if(0===e.getTotalVertices()||!t)return;let i=this._regularMatToMatWithPlugin.get(t);if(!i&&(i=t.clone("RSMCreate_"+t.name)||void 0,i)){Object.defineProperty(i,"canRenderToMRT",{get:function(){return!1},enumerable:!0,configurable:!0}),i.disableLighting=!0;const e=new _y(i);e.isEnabled=!0,e.light=this._light,this._regularMatToMatWithPlugin.set(t,i)}this._mrt.setMaterialForRendering(e,i)}_disposeMultiRenderTarget(){this._customRenderTarget(!1),this._mrt.dispose()}}class my extends zo.M{constructor(){super(...arguments),this.RSMCREATE=!1,this.RSMCREATE_PROJTEXTURE=!1,this.RSMCREATE_LIGHT_IS_SPOT=!1}}class _y extends Mm.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,_y.Name,300,new my),this._lightColor=new a.v9,this._hasProjectionTexture=!1,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._varAlbedoName=e instanceof Pu.d?"surfaceAlbedo":"baseColor.rgb"}prepareDefines(e){e.RSMCREATE=this._isEnabled,this._hasProjectionTexture=!1;const t=this.light.getTypeID()===oh.v.LIGHTTYPEID_SPOTLIGHT;if(t){const e=this.light;this._hasProjectionTexture=!!e.projectionTexture&&e.projectionTexture.isReady()}e.RSMCREATE_PROJTEXTURE=this._hasProjectionTexture,e.RSMCREATE_LIGHT_IS_SPOT=t,e.SCENE_MRT_COUNT=3}getClassName(){return"RSMCreatePluginMaterial"}getUniforms(){return{ubo:[{name:"rsmTextureProjectionMatrix",size:16,type:"mat4"},{name:"rsmSpotInfo",size:4,type:"vec4"},{name:"rsmLightColor",size:3,type:"vec3"},{name:"rsmLightPosition",size:3,type:"vec3"}],fragment:"#ifdef RSMCREATE\n                    uniform mat4 rsmTextureProjectionMatrix;\n                    uniform vec4 rsmSpotInfo;\n                    uniform vec3 rsmLightColor;\n                    uniform vec3 rsmLightPosition;\n                #endif"}}getSamplers(e){e.push("rsmTextureProjectionSampler")}bindForSubMesh(e){if(this._isEnabled&&(this.light.diffuse.scaleToRef(this.light.getScaledIntensity(),this._lightColor),e.updateColor3("rsmLightColor",this._lightColor),this.light.getTypeID()===oh.v.LIGHTTYPEID_SPOTLIGHT)){const t=this.light;this._hasProjectionTexture&&(e.updateMatrix("rsmTextureProjectionMatrix",t.projectionTextureMatrix),e.setTexture("rsmTextureProjectionSampler",t.projectionTexture));const i=s.AA.Vector3[0];t.computeTransformedInformation()?(e.updateFloat3("rsmLightPosition",this.light.transformedPosition.x,this.light.transformedPosition.y,this.light.transformedPosition.z),t.transformedDirection.normalizeToRef(i)):(e.updateFloat3("rsmLightPosition",this.light.position.x,this.light.position.y,this.light.position.z),t.direction.normalizeToRef(i)),e.updateFloat4("rsmSpotInfo",i.x,i.y,i.z,Math.cos(.5*t.angle))}}getCustomCode(e,t){return"vertex"===e?null:1===t?{CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RSMCREATE\n                    #ifdef RSMCREATE_PROJTEXTURE\n                        var rsmTextureProjectionSamplerSampler: sampler;\n                        var rsmTextureProjectionSampler: texture_2d<f32>;\n                    #endif\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`\n                #ifdef RSMCREATE\n                    var rsmColor = ${this._varAlbedoName} * uniforms.rsmLightColor;\n                    #ifdef RSMCREATE_PROJTEXTURE\n                    {\n                        var strq = uniforms.rsmTextureProjectionMatrix * vec4f(fragmentInputs.vPositionW, 1.0);\n                        strq /= strq.w;\n                        rsmColor *= textureSample(rsmTextureProjectionSampler, rsmTextureProjectionSamplerSampler, strq.xy).rgb;\n                    }\n                    #endif\n                    #ifdef RSMCREATE_LIGHT_IS_SPOT\n                    {\n                        var cosAngle = max(0., dot(uniforms.rsmSpotInfo.xyz, normalize(fragmentInputs.vPositionW - uniforms.rsmLightPosition)));\n                        rsmColor = sign(cosAngle - uniforms.rsmSpotInfo.w) * rsmColor;\n                    }\n                    #endif\n\n                    #define MRT_AND_COLOR\n                    fragmentOutputs.fragData0 = vec4f(fragmentInputs.vPositionW, 1.);\n                    fragmentOutputs.fragData1 = vec4f(normalize(normalW) * 0.5 + 0.5, 1.);\n                    fragmentOutputs.fragData2 = vec4f(rsmColor, 1.);\n                #endif\n            `}:{CUSTOM_FRAGMENT_BEGIN:"\n                #ifdef RSMCREATE\n                    #extension GL_EXT_draw_buffers : require\n                #endif\n            ",CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RSMCREATE\n                    #ifdef RSMCREATE_PROJTEXTURE\n                        uniform highp sampler2D rsmTextureProjectionSampler;                    \n                    #endif\n                    layout(location = 0) out highp vec4 glFragData[3];\n                    vec4 glFragColor;\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`\n                #ifdef RSMCREATE\n                    vec3 rsmColor = ${this._varAlbedoName} * rsmLightColor;\n                    #ifdef RSMCREATE_PROJTEXTURE\n                    {\n                        vec4 strq = rsmTextureProjectionMatrix * vec4(vPositionW, 1.0);\n                        strq /= strq.w;\n                        rsmColor *= texture2D(rsmTextureProjectionSampler, strq.xy).rgb;\n                    }\n                    #endif\n                    #ifdef RSMCREATE_LIGHT_IS_SPOT\n                    {\n                        float cosAngle = max(0., dot(rsmSpotInfo.xyz, normalize(vPositionW - rsmLightPosition)));\n                        rsmColor = sign(cosAngle - rsmSpotInfo.w) * rsmColor;\n                    }\n                    #endif\n                    glFragData[0] = vec4(vPositionW, 1.);\n                    glFragData[1] = vec4(normalize(normalW) * 0.5 + 0.5, 1.);\n                    glFragData[2] = vec4(rsmColor, 1.);\n                #endif\n            `}}}_y.Name="RSMCreate",(0,ue.Cg)([(0,de.lK)()],_y.prototype,"light",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],_y.prototype,"isEnabled",void 0),(0,o.Y5)("BABYLON.RSMCreatePluginMaterial",_y);class gy{constructor(e){this.numSamples=400,this.radius=.1,this.intensity=.1,this.edgeArtifactCorrection=.1,this.rotateSample=!0,this.noiseFactor=100,this.useFullTexture=!1,this.rsm=e}dispose(){this.rsm.dispose()}}class vy{get enable(){return this._enable}set enable(e){0===this._giRSM.length&&(e=!1),e!==this._enable&&(this._enable=e,this._debugLayer.isEnabled=this._showOnlyGI&&e,this._materialsWithRenderPlugin.forEach((t=>{t.pluginManager&&(t.pluginManager.getPlugin(xy.Name).isEnabled=e)})),this.recreateResources(!e))}get enableBlur(){return this._enableBlur}set enableBlur(e){e!==this._enableBlur&&(this._enableBlur=e,this.recreateResources())}get useQualityBlur(){return this._useQualityBlur}set useQualityBlur(e){e!==this._useQualityBlur&&(this._useQualityBlur=e,this.recreateResources())}get fullSizeBlur(){return this._forceFullSizeBlur}set fullSizeBlur(e){this._forceFullSizeBlur!==e&&(this._forceFullSizeBlur=e,this.recreateResources())}get useQualityUpsampling(){return this._useQualityUpsampling}set useQualityUpsampling(e){e!==this._useQualityUpsampling&&(this._useQualityUpsampling=e,this.recreateResources())}get showOnlyGI(){return this._showOnlyGI}set showOnlyGI(e){this._showOnlyGI!==e&&(this._showOnlyGI=e,this._debugLayer.isEnabled=e)}get use32BitsDepthBuffer(){return this._use32BitsDepthBuffer}set use32BitsDepthBuffer(e){this._use32BitsDepthBuffer!==e&&(this._use32BitsDepthBuffer=e,this.recreateResources())}setOutputDimensions(e){this._outputDimensions=e,this.recreateResources()}setGITextureDimensions(e){this._giTextureDimensions=e,this.recreateResources()}get giTextureType(){return this._giTextureType}set giTextureType(e){this._giTextureType!==e&&(this._giTextureType=e,this.recreateResources())}get shaderLanguage(){return this._shaderLanguage}get giRSM(){return this._giRSM}addGIRSM(e){Array.isArray(e)?this._giRSM.push(...e):this._giRSM.push(e),this.recreateResources()}removeGIRSM(e){if(Array.isArray(e))for(let t=0;t<e.length;++t){const i=this._giRSM.indexOf(e[t]);-1!==i&&this._giRSM.splice(i,1)}else{const t=this._giRSM.indexOf(e);-1!==t&&this._giRSM.splice(t,1)}0===this._giRSM.length?this.enable=!1:this.recreateResources()}addMaterial(e){e?this._addGISupportToMaterial(e):this._scene.meshes.forEach((e=>{e.getTotalVertices()>0&&e.isEnabled()&&e.material&&this._addGISupportToMaterial(e.material)}))}get countersGPU(){return this._counters}recreateResources(e=!1){this._shadersLoaded?(this._disposePostProcesses(e),this._createPostProcesses(),this._setPluginParameters()):this._onShaderLoadedObservable.addOnce((()=>{this.recreateResources(e)}))}generateSampleTexture(e){this._sampleTexture?.dispose(),this._maxSamples=e;const t=new Float32Array(4*this._maxSamples);for(let e=0;e<this._maxSamples;e++){const i=Math.random(),r=Math.random(),n=i*Math.sin(2*Math.PI*r),s=i*Math.cos(2*Math.PI*r);t[4*e+0]=n,t[4*e+1]=s,t[4*e+2]=i*i,t[4*e+3]=1}this._sampleTexture=new me.I(t,this._maxSamples,1,5,this._scene,!1,!1,1,1),this._sampleTexture.name="GIRSMSamples"}dispose(){this._disposePostProcesses(!0),this._debugLayer.texture?.dispose(),this._debugLayer.dispose(),this._scene.onBeforeDrawPhaseObservable.remove(this._drawPhaseObserver),this._onShaderLoadedObservable.clear()}constructor(e,t,i={width:256,height:256},r=2048,a=11){this._giRSM=[],this._blurRTT=null,this._blurPostProcesses=null,this._blurXPostprocess=null,this._blurYPostprocess=null,this._upsamplingXPostprocess=null,this._upsamplingYPostprocess=null,this._ppGlobalIllumination=[],this._firstActivation=!0,this._geomBufferEnabled=!1,this._geomBufferEnablePosition=!1,this._tempMatrix=new s.uq,this._enable=!1,this.pause=!1,this._enableBlur=!0,this._useQualityBlur=!1,this.blurDepthThreshold=.05,this.blurNormalThreshold=.25,this.blurKernel=12,this._forceFullSizeBlur=!1,this._useQualityUpsampling=!1,this.upsamplerKernel=6,this._showOnlyGI=!1,this._use32BitsDepthBuffer=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._onShaderLoadedObservable=new n.cP,this._scene=e,this._engine=e.getEngine(),this._outputDimensions=t,this._giTextureDimensions=i,this._giTextureType=a,this._materialsWithRenderPlugin=[],this._maxSamples=r,this._debugLayer=new Vc.W("debug layer",null,this._scene,!1),this._debugLayer.isEnabled=!1,this._counters=[],this._countersRTW=[],this._initShaderSourceAsync(),this.generateSampleTexture(r),this._drawPhaseObserver=this._scene.onBeforeDrawPhaseObservable.add((()=>{const e=this._engine._currentRenderTarget;let t=!1;if(this._enable){this.pause||(this._scene.postProcessManager.directRender(this._ppGlobalIllumination,this._ppGlobalIllumination[0].inputTexture),this._engine.unBindFramebuffer(this._ppGlobalIllumination[0].inputTexture,!0),this._engine.setAlphaMode(0),t=!0,this.enableBlur&&this._blurPostProcesses&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,this._blurRTT.renderTarget,!0),this._engine.unBindFramebuffer(this._blurRTT.renderTarget,!0)));for(let e=0;e<this._counters.length;++e){const t=this._countersRTW[e];for(let i=0;i<t.length;++i)0===i?this._counters[e].value=this.pause?0:t[i].gpuTimeInFrame?.counter.lastSecAverage??0:this.pause||(this._counters[e].value+=t[i].gpuTimeInFrame?.counter.lastSecAverage??0)}this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport)}t&&e&&this._engine.bindFramebuffer(e)}))}async _initShaderSourceAsync(){this._engine.isWebGPU?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,1747)),Promise.resolve().then(i.bind(i,18272)),Promise.resolve().then(i.bind(i,42570)),Promise.resolve().then(i.bind(i,23785))])):await Promise.all([Promise.resolve().then(i.bind(i,61584)),Promise.resolve().then(i.bind(i,86497)),Promise.resolve().then(i.bind(i,66857)),Promise.resolve().then(i.bind(i,45198))]),this._shadersLoaded=!0,this._onShaderLoadedObservable.notifyObservers()}_disposePostProcesses(e=!1){this._blurRTT?.dispose(),this._blurRTT=null,this._blurPostProcesses=[],this._blurXPostprocess?.dispose(),this._blurXPostprocess=null,this._blurYPostprocess?.dispose(),this._blurYPostprocess=null,this._upsamplingXPostprocess?.dispose(),this._upsamplingXPostprocess=null,this._upsamplingYPostprocess?.dispose(),this._upsamplingYPostprocess=null;for(const e of this._ppGlobalIllumination)e.dispose();this._ppGlobalIllumination=[],e&&(this._geomBufferEnabled?(this._scene.enableGeometryBufferRenderer(),this._scene.geometryBufferRenderer.enablePosition=this._geomBufferEnablePosition):this._scene.disableGeometryBufferRenderer()),this._counters=[],this._countersRTW=[]}_setPluginParameters(){this._enable&&this._materialsWithRenderPlugin.forEach((e=>{if(e.pluginManager){const t=e.pluginManager.getPlugin(xy.Name);t.textureGIContrib=this.enableBlur?this._blurRTT.renderTarget.texture:this._ppGlobalIllumination[0].inputTexture.texture,t.outputTextureWidth=this._outputDimensions.width,t.outputTextureHeight=this._outputDimensions.height}}))}_createPostProcesses(){if(!this._enable)return;const e=13===this._giTextureType?4:5;this._firstActivation&&(this._firstActivation=!1,this._geomBufferEnabled=!!this._scene.geometryBufferRenderer,this._geomBufferEnablePosition=this._scene.geometryBufferRenderer?.enablePosition??!1),this._geomBufferEnabled||this._scene.disableGeometryBufferRenderer();const t=this._scene.enableGeometryBufferRenderer(this._enableBlur?this._outputDimensions:this._giTextureDimensions,this._use32BitsDepthBuffer?14:15,vy.GeometryBufferTextureTypesAndFormats);if(!t)throw new Error("Geometry buffer renderer is not supported but is required for GIRSMManager.");t.enablePosition=!0,this._geomBufferEnabled||(t.generateNormalsInWorldSpace=!0);const i=t.normalsAreUnsigned,r=t.generateNormalsInWorldSpace;this._counters.push({name:"Geometry buffer renderer",value:0}),this._countersRTW.push([this._scene.geometryBufferRenderer.getGBuffer().renderTarget]);let n="";i&&(n+="#define DECODE_NORMAL\n"),r||(n+="#define TRANSFORM_NORMAL\n");for(let i=0;i<this._giRSM.length;++i){const s=this._giRSM[i],a=s.rsm,o=new jt.w("RSMGlobalIllumination"+i,s.useFullTexture?"rsmFullGlobalIllumination":"rsmGlobalIllumination",{...this._giTextureDimensions,uniforms:["rsmLightMatrix","rsmInfo","rsmInfo2","invView"],samplers:["normalSampler","rsmPositionW","rsmNormalW","rsmFlux","rsmSamples"],defines:n,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage});this._ppGlobalIllumination.push(o),0!==i&&(o.shareOutputWith(this._ppGlobalIllumination[0]),o.alphaMode=1),o.autoClear=!1,o.externalTextureSamplerBinding=!0,o.onApplyObservable.add((e=>{e.setTexture("textureSampler",t.getGBuffer().textures[t.getTextureIndex(NC.POSITION_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(NC.NORMAL_TEXTURE_TYPE)]),e.setTexture("rsmPositionW",a.positionWorldTexture),e.setTexture("rsmNormalW",a.normalWorldTexture),e.setTexture("rsmFlux",a.fluxTexture),e.setMatrix("rsmLightMatrix",a.lightTransformationMatrix),s.useFullTexture?e.setFloat4("rsmInfo",a.fluxTexture.getInternalTexture().width,a.fluxTexture.getInternalTexture().height,s.intensity,s.edgeArtifactCorrection):(e.setTexture("rsmSamples",this._sampleTexture),e.setFloat4("rsmInfo",s.numSamples,s.radius,s.intensity,s.edgeArtifactCorrection),e.setFloat4("rsmInfo2",s.noiseFactor,s.rotateSample?1:0,a.fluxTexture.getInternalTexture().width,a.fluxTexture.getInternalTexture().height)),r||(this._tempMatrix.copyFrom(this._scene.activeCamera.getViewMatrix()),this._tempMatrix.invert(),e.setMatrix("invView",this._tempMatrix))}))}for(const e of this._ppGlobalIllumination)e.inputTexture||e.resize(this._giTextureDimensions.width,this._giTextureDimensions.height);if(this._counters.push({name:"GI generation",value:0}),this._countersRTW.push([this._ppGlobalIllumination[0].inputTexture]),this._enableBlur){const r=this._forceFullSizeBlur?this._outputDimensions:this._giTextureDimensions;this._blurRTT=new Si.$("GIRSMContribution",this._outputDimensions,this._scene,{type:this._giTextureType,format:e,generateDepthBuffer:!1}),this._blurRTT.wrapU=0,this._blurRTT.wrapV=0,this._blurRTT.updateSamplingMode(1),this._blurRTT.skipInitialClear=!0;const n=[];if(this._counters.push({name:"GI blur",value:0}),this._countersRTW.push(n),this._blurXPostprocess=new jt.w(this._useQualityBlur?"BilateralBlur":"BilateralBlurX",this._useQualityBlur?"bilateralBlurQuality":"bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._blurXPostprocess.onApplyObservable.add((e=>{e._bindTexture("textureSampler",this._ppGlobalIllumination[0].inputTexture.texture),e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(NC.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(NC.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.blurKernel),e.setFloat2("blurDir",1/this._giTextureDimensions.width,this._useQualityBlur?1/this._giTextureDimensions.height:0),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._blurXPostprocess.externalTextureSamplerBinding=!0,this._blurXPostprocess.autoClear=!1,this._useQualityBlur||(this._blurYPostprocess=new jt.w("BilateralBlurY","bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._blurYPostprocess.autoClear=!1,this._blurYPostprocess.onApplyObservable.add((e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(NC.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(NC.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.blurKernel),e.setFloat2("blurDir",0,1/this._giTextureDimensions.height),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._blurYPostprocess.resize(r.width,r.height),n.push(this._blurYPostprocess.inputTexture)),this._blurPostProcesses=[this._blurXPostprocess],this._blurYPostprocess&&this._blurPostProcesses.push(this._blurYPostprocess),this._giTextureDimensions.width>=this._outputDimensions.width&&this._giTextureDimensions.height>=this._outputDimensions.height||this._forceFullSizeBlur)n.push(this._blurRTT.renderTarget);else{const s=[];this._counters.push({name:"GI upsampling",value:0}),this._countersRTW.push(s),this._upsamplingXPostprocess=new jt.w(this._useQualityUpsampling?"BilateralUpsampling":"BilateralUpsamplingX",this._useQualityUpsampling?"bilateralBlurQuality":"bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._upsamplingXPostprocess.autoClear=!1,this._upsamplingXPostprocess.onApplyObservable.add((e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(NC.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(NC.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.upsamplerKernel),e.setFloat2("blurDir",1/this._outputDimensions.width,this._useQualityUpsampling?1/this._outputDimensions.height:0),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._upsamplingXPostprocess.resize(r.width,r.height),n.push(this._upsamplingXPostprocess.inputTexture),this.useQualityUpsampling||(this._upsamplingYPostprocess=new jt.w("BilateralUpsamplingY","bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:this._outputDimensions,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._upsamplingYPostprocess.autoClear=!1,this._upsamplingYPostprocess.onApplyObservable.add((e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(NC.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(NC.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.upsamplerKernel),e.setFloat2("blurDir",0,1/this._outputDimensions.height),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)})),this._upsamplingYPostprocess.resize(this._outputDimensions.width,this._outputDimensions.height),s.push(this._upsamplingYPostprocess.inputTexture)),s.push(this._blurRTT.renderTarget),this._blurPostProcesses.push(this._upsamplingXPostprocess),this._upsamplingYPostprocess&&this._blurPostProcesses.push(this._upsamplingYPostprocess)}}this._debugLayer.texture?.dispose(),this._debugLayer.texture=new Vo.t(this._scene,this._enableBlur?this._blurRTT.renderTarget.texture:this._ppGlobalIllumination[0].inputTexture.texture)}_addGISupportToMaterial(e){if(e.pluginManager?.getPlugin(xy.Name))return;const t=new xy(e);this._enable&&this._ppGlobalIllumination.length>0&&(t.textureGIContrib=this._ppGlobalIllumination[0].inputTexture.texture,t.outputTextureWidth=this._outputDimensions.width,t.outputTextureHeight=this._outputDimensions.height),t.isEnabled=this._enable,this._materialsWithRenderPlugin.push(e)}}vy.GeometryBufferTextureTypesAndFormats={0:{textureType:2,textureFormat:6},1:{textureType:11,textureFormat:5},2:{textureType:2,textureFormat:5}};class Sy extends zo.M{constructor(){super(...arguments),this.RENDER_WITH_GIRSM=!1,this.RSMCREATE_PROJTEXTURE=!1}}class xy extends Mm.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,xy.Name,310,new Sy),this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._isPBR=e instanceof Pu.d}prepareDefines(e){e.RENDER_WITH_GIRSM=this._isEnabled}getClassName(){return"GIRSMRenderPluginMaterial"}getUniforms(){return{ubo:[{name:"girsmTextureOutputSize",size:2,type:"vec2"}],fragment:"#ifdef RENDER_WITH_GIRSM\n                    uniform vec2 girsmTextureOutputSize;\n                #endif"}}getSamplers(e){e.push("girsmTextureGIContrib")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("girsmTextureGIContrib",this.textureGIContrib),e.updateFloat2("girsmTextureOutputSize",this.outputTextureWidth,this.outputTextureHeight))}getCustomCode(e,t){let i;return 1===t?(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_GIRSM\n                    var girsmTextureGIContribSampler: sampler;\n                    var girsmTextureGIContrib: texture_2d<f32>;\n\n                    fn computeIndirect() -> vec3f {\n                        var uv = fragmentInputs.position.xy / uniforms.girsmTextureOutputSize;\n                        return textureSample(girsmTextureGIContrib, girsmTextureGIContribSampler, uv).rgb;\n                    }\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:"\n                #ifdef RENDER_WITH_GIRSM\n                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;\n                #endif\n            "},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_GIRSM\n                    color = vec4f(color.rgb + computeIndirect() * baseColor.rgb, color.a);\n                #endif\n            ")):(i={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #ifdef RENDER_WITH_GIRSM\n                    uniform sampler2D girsmTextureGIContrib;\n\n                    vec3 computeIndirect() {\n                        vec2 uv = gl_FragCoord.xy / girsmTextureOutputSize;\n                        return texture2D(girsmTextureGIContrib, uv).rgb;\n                    }\n                #endif\n            ",CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:"\n                #ifdef RENDER_WITH_GIRSM\n                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;\n                #endif\n            "},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR="\n                #ifdef RENDER_WITH_GIRSM\n                    color.rgb += computeIndirect() * baseColor.rgb;\n                #endif\n            ")),"vertex"===e?null:i}}xy.Name="GIRSMRender",(0,ue.Cg)([(0,de.lK)()],xy.prototype,"textureGIContrib",void 0),(0,ue.Cg)([(0,de.lK)()],xy.prototype,"outputTextureWidth",void 0),(0,ue.Cg)([(0,de.lK)()],xy.prototype,"outputTextureHeight",void 0),(0,ue.Cg)([(0,de.lK)(),(0,de.$z)("_markAllSubMeshesAsTexturesDirty")],xy.prototype,"isEnabled",void 0),(0,o.Y5)("BABYLON.GIRSMRenderPluginMaterial",xy);var Ty=i(61584),Ey=i(86497),Cy=i(66857),by=i(45198),Py=i(1747),yy=i(18272),Ay=i(42570),Ry=i(23785),Iy=i(24567),My=i(93105),Oy=i(29610),Ny=i(30672),Dy=i(56125),Fy=i(12726),Ly=i(77938),wy=i(59752),By=i(83833),Vy=i(64151),ky=i(16996),Gy=i(88034),Uy=i(47725),zy=i(57447),Wy=i(76398),Hy=i(29860),Yy=i(52083),Xy=i(42220),qy=i(66674),$y=i(68225),jy=i(95859),Ky=i(74550),Zy=i(93632),Qy=i(41025),Jy=i(94078),eA=i(69301);const tA="iblShadowsCombinePixelShader",iA="precision highp float;varying vec2 vUV;uniform sampler2D shadowSampler;uniform sampler2D textureSampler;uniform float shadowOpacity;void main(void)\n{vec3 shadow=texture(shadowSampler,vUV).rgb;vec3 sceneColor=texture(textureSampler,vUV).rgb;float shadowValue=mix(1.0,shadow.x,shadowOpacity);gl_FragColor=vec4(sceneColor*shadowValue,1.0);}";ri.l.ShadersStore[tA]=iA;const rA={name:tA,shader:iA},nA="iblShadowsCombinePixelShader",sA="varying vUV: vec2f;var shadowSamplerSampler : sampler;var shadowSampler : texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform shadowOpacity: f32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var shadow\n: vec3f =\ntextureSample(shadowSampler,shadowSamplerSampler,input.vUV).rgb;var color\n: vec3f =\ntextureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var shadowValue: f32=mix(1.0,shadow.x,uniforms.shadowOpacity);fragmentOutputs.color=vec4f(color*shadowValue,1.0);}";ri.l.ShadersStoreWGSL[nA]=sA;const aA={name:nA,shader:sA};var oA=i(15691),lA=i(78),cA=i(38279),hA=i(76132),uA=i(22390),dA=i(15465),pA=i(51568),fA=i(82283),mA=i(29145),_A=i(31858),gA=i(2785),vA=i(35088),SA=i(25880),xA=i(66649),TA=i(70730),EA=i(5481),CA=i(59776),bA=i(2765),PA=i(31826),yA=i(37224),AA=i(72439),RA=i(69553),IA=i(89346),MA=i(5025),OA=i(70287),NA=i(11589),DA=i(77356),FA=i(50342),LA=i(47509),wA=i(35075),BA=i(58540),VA=i(66930);ri.l.ShadersStore.spriteMapPixelShader="#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nprecision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;\n#include<fogFragmentDeclaration>\n#include<logDepthDeclaration>\nfloat mt;const float fdStep=1.0*0.25;const float aFrameSteps=MAX_ANIMATION_FRAMES==0.0 ? 0.0 : 1.0/MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID) {float fX=frameID/spriteCount;return mat4(\nTEXTUREFUNC(frameMap,vec2(fX,0.0),0.0),\nTEXTUREFUNC(frameMap,vec2(fX,fdStep*1.0),0.0),\nTEXTUREFUNC(frameMap,vec2(fX,fdStep*2.0),0.0),\nvec4(0.0)\n);}\nvoid main() {vec4 color=vec4(0.0);vec2 tileUV=fract(tUV);vec2 tileID=floor(tUV);vec2 sheetUnits=1.0/spriteMapSize;float spriteUnits=1.0/spriteCount;vec2 stageUnits=1.0/stageSize;for(int i=0; i<LAYERS; i++) {float frameID;\n#define LAYER_ID_SWITCH\nvec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.0),0.0);if(animationData.y>0.0) {mt=mod(time*animationData.z,1.0);for(float f=0.0; f<MAX_ANIMATION_FRAMES; f++) {if(animationData.y>mt) {frameID=animationData.x;break;}\nanimationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.0);}}\nmat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;\n#ifdef FR_CW\nif (frameData[2].z==1.0) {tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;}\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\n#else\nif (frameData[2].z==1.0) {\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\ntileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;\n#ifdef FLIPU\ntileUV.y=1.0-tileUV.y;\n#endif\n}\n#endif\nvec4 nc=TEXTUREFUNC(spriteSheet,tileUV*frameSize+offset,0.0);if (i==0) {color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}\ncolor.xyz*=colorMul;\n#include<logDepthFragment>\n#include<fogFragment>\ngl_FragColor=color;}";var kA;ri.l.ShadersStore.spriteMapVertexShader="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform mat4 world;uniform mat4 view;uniform mat4 projection;uniform vec2 stageSize;uniform float stageScale;\n#include<fogVertexDeclaration>\n#include<logDepthDeclaration>\nvoid main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; \nvec3 viewPos=(view*world*p).xyz; \ngl_Position=projection*vec4(viewPos,1.0); \n#ifdef FOG\nvFogDistance=viewPos;\n#endif\n#include<logDepthVertex>\n}",function(e){e[e.CCW=0]="CCW",e[e.CW=1]="CW"}(kA||(kA={}));class GA{get spriteCount(){return this.sprites.length}get position(){return this._output.position}set position(e){this._output.position=e}get rotation(){return this._output.rotation}set rotation(e){this._output.rotation=e}get animationMap(){return this._animationMap}set animationMap(e){const t=e._texture._bufferView,i=this._createTileAnimationBuffer(t);this._animationMap.dispose(),this._animationMap=i,this._material.setTexture("animationMap",this._animationMap)}get fogEnabled(){return this._material.fogEnabled}set fogEnabled(e){this._material.fogEnabled=e}get useLogarithmicDepth(){return this._material.useLogarithmicDepth}set useLogarithmicDepth(e){this._material.useLogarithmicDepth=e}constructor(e,t,i,r,n){this.name=e,this.sprites=[],this.atlasJSON=t,this.sprites=this.atlasJSON.frames,this.spriteSheet=i,this.options=r,r.stageSize=r.stageSize||new s.I9(1,1),r.outputSize=r.outputSize||r.stageSize,r.outputPosition=r.outputPosition||s.Pq.Zero(),r.outputRotation=r.outputRotation||s.Pq.Zero(),r.layerCount=r.layerCount||1,r.maxAnimationFrames=r.maxAnimationFrames||0,r.baseTile=r.baseTile||0,r.flipU=r.flipU||!1,r.colorMultiply=r.colorMultiply||new s.Pq(1,1,1),this._scene=n,this._frameMap=this._createFrameBuffer(),this._tileMaps=new Array;for(let e=0;e<r.layerCount;e++)this._tileMaps.push(this._createTileBuffer(null,e));this._animationMap=this._createTileAnimationBuffer(null);const a=[];a.push("#define LAYERS "+r.layerCount),r?.frameRotationDirection===kA.CW&&a.push("#define FR_CW"),r.flipU&&a.push("#define FLIPU"),a.push(`#define MAX_ANIMATION_FRAMES ${r.maxAnimationFrames}.0`);const o=So.M.ShadersStore.spriteMapPixelShader;let l;if(n.getEngine()._features.supportSwitchCaseInShader){l="switch(i) {";for(let e=0;e<r.layerCount;e++)l+="case "+e+" : frameID = texture(tileMaps["+e+"], (tileID + 0.5) / stageSize, 0.).x;",l+="break;";l+="}"}else{l="";for(let e=0;e<r.layerCount;e++)l+=`if (${e} == i) { frameID = texture2D(tileMaps[${e}], (tileID + 0.5) / stageSize, 0.).x; }`}So.M.ShadersStore["spriteMap"+this.name+"PixelShader"]=o.replace("#define LAYER_ID_SWITCH",l),this._material=new ir.B("spriteMap:"+this.name,this._scene,{vertex:"spriteMap",fragment:"spriteMap"+this.name},{defines:a,attributes:["position","normal","uv"],uniforms:["world","view","projection","time","stageSize","outputSize","spriteMapSize","spriteCount","time","colorMul","mousePosition","curTile","flipU"],samplers:["spriteSheet","frameMap","tileMaps","animationMap"],needAlphaBlending:!0}),this._time=0,this._material.setFloat("spriteCount",this.spriteCount),this._material.setVector2("stageSize",r.stageSize),this._material.setVector2("outputSize",r.outputSize),this._material.setTexture("spriteSheet",this.spriteSheet),this._material.setVector2("spriteMapSize",new s.I9(1,1)),this._material.setVector3("colorMul",r.colorMultiply);let c=0;const h=()=>{this.spriteSheet&&this.spriteSheet.isReady()&&this.spriteSheet._texture?this._material.setVector2("spriteMapSize",new s.I9(this.spriteSheet._texture.baseWidth||1,this.spriteSheet._texture.baseHeight||1)):c<100&&setTimeout((()=>{c++,h()}),100)};h(),this._material.setVector3("colorMul",r.colorMultiply),this._material.setTexture("frameMap",this._frameMap),this._material.setTextureArray("tileMaps",this._tileMaps),this._material.setTexture("animationMap",this._animationMap),this._material.setFloat("time",this._time),this._output=(0,xo.x)(e+":output",{size:1,updatable:!0},n),this._output.scaling.x=r.outputSize.x,this._output.scaling.y=r.outputSize.y,this.position=r.outputPosition,this.rotation=r.outputRotation,this._scene.onBeforeRenderObservable.add((()=>{this._time+=this._scene.getEngine().getDeltaTime(),this._material.setFloat("time",this._time)})),this._output.material=this._material}getTileIdxByName(e){return this.atlasJSON.frames.findIndex((t=>t.filename===e))}getTileID(){const e=this.getMousePosition();return e.multiplyInPlace(this.options.stageSize||s.I9.Zero()),e.x=Math.floor(e.x),e.y=Math.floor(e.y),e}getMousePosition(){const e=this._output,t=this._scene.pick(this._scene.pointerX,this._scene.pointerY,(t=>t===e));if(!t||!t.hit||!t.getTextureCoordinates)return new s.I9(-1,-1);return t.getTextureCoordinates()||new s.I9(-1,-1)}_createFrameBuffer(){const e=[];for(let t=0;t<this.spriteCount;t++)e.push(0,0,0,0),e.push(0,0,0,0),e.push(0,0,0,0),e.push(0,0,0,0);for(let t=0;t<this.spriteCount;t++){const i=this.sprites[t].frame,r=this.sprites[t].spriteSourceSize,n=this.sprites[t].sourceSize,s=this.sprites[t].rotated?1:0,a=this.sprites[t].trimmed?1:0;e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.w,e[4*t+3]=i.h,e[4*t+4*this.spriteCount]=r.x,e[4*t+1+4*this.spriteCount]=r.y,e[4*t+3+4*this.spriteCount]=r.h,e[4*t+8*this.spriteCount]=n.w,e[4*t+1+8*this.spriteCount]=n.h,e[4*t+2+8*this.spriteCount]=s,e[4*t+3+8*this.spriteCount]=a}const t=new Float32Array(e);return me.I.CreateRGBATexture(t,this.spriteCount,4,this._scene,!1,!1,_e.g.NEAREST_NEAREST,1)}_createTileBuffer(e,t=0){let i=[];const r=this.options.stageSize.y||0,n=this.options.stageSize.x||0;if(e)i=e;else{let e=this.options.baseTile;0!=t&&(e=0);for(let t=0;t<r;t++)for(let t=0;t<4*n;t+=4)i.push(e,0,0,0)}const s=new Float32Array(i);return me.I.CreateRGBATexture(s,n,r,this._scene,!1,!1,_e.g.NEAREST_NEAREST,1)}changeTiles(e=0,t,i=0){const r=this._tileMaps[e]._texture._bufferView;if(null===r)return;let n=[];t instanceof s.I9?n.push(t):n=t;const a=this.options.stageSize.x||0;for(let e=0;e<n.length;e++){const t=n[e];t.x=Math.floor(t.x),t.y=Math.floor(t.y),r[4*t.x+t.y*(4*a)]=i}const o=this._createTileBuffer(r);this._tileMaps[e].dispose(),this._tileMaps[e]=o,this._material.setTextureArray("tileMap",this._tileMaps)}_createTileAnimationBuffer(e){const t=[];let i;if(e)i=e;else{for(let e=0;e<this.spriteCount;e++){t.push(0,0,0,0);let e=1;for(;e<(this.options.maxAnimationFrames||4);)t.push(0,0,0,0),e++}i=new Float32Array(t)}return me.I.CreateRGBATexture(i,this.spriteCount,this.options.maxAnimationFrames||4,this._scene,!1,!1,_e.g.NEAREST_NEAREST,1)}addAnimationToTile(e=0,t=0,i=0,r=0,n=1){const s=this._animationMap._texture._bufferView,a=4*e+4*this.spriteCount*t;if(!s)return;s[a]=i,s[a+1]=r,s[a+2]=n;const o=this._createTileAnimationBuffer(s);this._animationMap.dispose(),this._animationMap=o,this._material.setTexture("animationMap",this._animationMap)}saveTileMaps(){let e="";for(let t=0;t<this._tileMaps.length;t++)t>0&&(e+="\n\r"),e+=this._tileMaps[t]._texture._bufferView.toString();const t=document.createElement("a");t.href="data:octet/stream;charset=utf-8,"+encodeURI(e),t.target="_blank",t.download=this.name+".tilemaps",t.click(),t.remove()}loadTileMaps(e){const t=new XMLHttpRequest;t.open("GET",e);const i=this.options.layerCount||0;t.onload=()=>{const e=t.response.split("\n\r");for(let t=0;t<i;t++){const i=e[t].split(",").map(Number),r=this._createTileBuffer(i);this._tileMaps[t].dispose(),this._tileMaps[t]=r}this._material.setTextureArray("tileMap",this._tileMaps)},t.send()}dispose(){this._output.dispose(),this._material.dispose(),this._animationMap.dispose(),this._tileMaps.forEach((e=>{e.dispose()})),this._frameMap.dispose()}}class UA extends eu{constructor(e,t,i,r,n=null,s=.01,a=_e.g.TRILINEAR_SAMPLINGMODE,o){super(e,t,i,64,r,s,a,!0,n,o),this.name=e}}var zA,WA,HA=i(49481),YA=i(18467),XA=i(75393),qA=i(20468),$A=i(21114),jA=i(11879),KA=i(83406),ZA=i(4096);!function(e){e[e.ENTERING_XR=0]="ENTERING_XR",e[e.EXITING_XR=1]="EXITING_XR",e[e.IN_XR=2]="IN_XR",e[e.NOT_IN_XR=3]="NOT_IN_XR"}(zA||(zA={})),function(e){e[e.NOT_TRACKING=0]="NOT_TRACKING",e[e.TRACKING_LOST=1]="TRACKING_LOST",e[e.TRACKING=2]="TRACKING"}(WA||(WA={}));class QA extends gl{constructor(e,t={}){super(e),this.options=t,this._direction=new s.Pq(0,0,-1),this._mat=new s.uq,this._onSelectEnabled=!1,this._origin=new s.Pq(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new n.cP,this._onHitTestResults=e=>{const t=e.map((e=>{const t=s.uq.FromArray(e.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&t.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),t),{xrHitResult:e,transformationMatrix:t}}));this.lastNativeXRHitResults=e,this.onHitTestResultObservable.notifyObservers(t)},this._onSelect=e=>{this._onSelectEnabled&&QA.XRHitTestWithSelectEvent(e,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",re.S0.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,r){return e.requestHitTest(t,i).then((e=>{const t=r||(e=>!!e.hitMatrix);return e.filter(t)}))}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const r=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,r,t)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0)}detach(){return!!super.detach()&&(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;s.uq.FromArrayToRef(t.transform.matrix,0,this._mat),s.Pq.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),s.Pq.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});QA.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}QA.Name=nl._.HIT_TEST,QA.Version=1,nl.n.AddWebXRFeature(QA.Name,((e,t)=>()=>new QA(e,t)),QA.Version,!1);let JA=0;class eR extends gl{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new n.cP,this.onAnchorRemovedObservable=new n.cP,this.onAnchorUpdatedObservable=new n.cP,this._tmpVector=new s.Pq,this._tmpQuaternion=new s.PT,this.xrNativeFeatureName="anchors",this._options.clearAnchorsOnSessionInit&&this._xrSessionManager.onXRSessionInit.add((()=>{this._trackedAnchors.length=0,this._futureAnchors.length=0,this._lastFrameDetected.clear()}))}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new s.Pq,i=new s.PT){this._populateTmpTransformation(t,i);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(!e.xrHitResult.createAnchor)throw this.detach(),new Error("Anchors not enabled in this environment/browser");try{const t=await e.xrHitResult.createAnchor(r);return new Promise(((e,i)=>{this._futureAnchors.push({nativeAnchor:t,resolved:!1,submitted:!0,xrTransformation:r,resolve:e,reject:i})}))}catch(e){throw new Error(e)}}async addAnchorAtPositionAndRotationAsync(e,t=new s.PT,i=!1){this._populateTmpTransformation(e,t);const r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),n=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(r,this._xrSessionManager.currentFrame):void 0;return new Promise(((e,t)=>{this._futureAnchors.push({nativeAnchor:n,resolved:!1,submitted:!1,xrTransformation:r,resolve:e,reject:t})}))}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();e&&this.onAnchorRemovedObservable.notifyObservers(e)}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter((e=>!t.has(e.xrAnchor))).map((e=>this._trackedAnchors.indexOf(e)));let r=0;i.forEach((e=>{const t=this._trackedAnchors.splice(e-r,1)[0];this.onAnchorRemovedObservable.notifyObservers(t),r++})),t.forEach((t=>{if(this._lastFrameDetected.has(t)){const i=this._findIndexInAnchorArray(t),r=this._trackedAnchors[i];try{this._updateAnchorWithXRFrame(t,r,e),r.attachedNode&&(r.attachedNode.rotationQuaternion=r.attachedNode.rotationQuaternion||new s.PT,r.transformationMatrix.decompose(r.attachedNode.scaling,r.attachedNode.rotationQuaternion,r.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(r)}catch(e){re.S0.Warn("Anchor could not be updated")}}else{const i={id:JA++,xrAnchor:t,remove:()=>t.delete()},r=this._updateAnchorWithXRFrame(t,i,e);this._trackedAnchors.push(r),this.onAnchorAddedObservable.notifyObservers(r);const n=this._futureAnchors.filter((e=>e.nativeAnchor===t))[0];n&&(n.resolve(r),n.resolved=!0)}})),this._lastFrameDetected=t}this._futureAnchors.forEach((t=>{t.resolved||t.submitted||(this._createAnchorAtTransformation(t.xrTransformation,e).then((e=>{t.nativeAnchor=e}),(e=>{t.resolved=!0,t.reject(e)})),t.submitted=!0)}))}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const r=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(r){const e=t.transformationMatrix||new s.uq;s.uq.FromArrayToRef(r.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}async _createAnchorAtTransformation(e,t){if(!t.createAnchor)throw this.detach(),new Error("Anchors are not enabled in your browser");try{return t.createAnchor(e,this._referenceSpaceForFrameAnchors??this._xrSessionManager.referenceSpace)}catch(e){throw new Error(e)}}}eR.Name=nl._.ANCHOR_SYSTEM,eR.Version=1,nl.n.AddWebXRFeature(eR.Name,((e,t)=>()=>new eR(e,t)),eR.Version);let tR=0;class iR extends gl{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new n.cP,this.onPlaneRemovedObservable=new n.cP,this.onPlaneUpdatedObservable=new n.cP,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return"undefined"!=typeof XRPlane}async initiateRoomCapture(){return this._xrSessionManager.session.initiateRoomCapture?this._xrSessionManager.session.initiateRoomCapture():Promise.reject("initiateRoomCapture is not supported on this session")}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.detectedPlanes||e.worldInformation?.detectedPlanes;if(t){for(let e=0;e<this._detectedPlanes.length;e++){const i=this._detectedPlanes[e];t.has(i.xrPlane)||(this._detectedPlanes.splice(e--,1),this.onPlaneRemovedObservable.notifyObservers(i))}t.forEach((t=>{if(this._lastFrameDetected.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._findIndexInPlaneArray(t),r=this._detectedPlanes[i];this._updatePlaneWithXRPlane(t,r,e),this.onPlaneUpdatedObservable.notifyObservers(r)}}else{const i={id:tR++,xrPlane:t,polygonDefinition:[]},r=this._updatePlaneWithXRPlane(t,i,e);this._detectedPlanes.push(r),this.onPlaneAddedObservable.notifyObservers(r)}})),this._lastFrameDetected=t}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),this._xrSessionManager.session.updateWorldTrackingState?(this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()):e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map((e=>{const t=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new s.Pq(e.x,e.y,e.z*t)}));const r=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(r){const e=t.transformationMatrix||new s.uq;s.uq.FromArrayToRef(r.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}iR.Name=nl._.PLANE_DETECTION,iR.Version=1,nl.n.AddWebXRFeature(iR.Name,((e,t)=>()=>new iR(e,t)),iR.Version);class rR extends gl{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new n.cP}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach((t=>t.setEnabled(e))),this.onBackgroundStateChangedObservable.notifyObservers(e)}}rR.Name=nl._.BACKGROUND_REMOVER,rR.Version=1,nl.n.AddWebXRFeature(rR.Name,((e,t)=>()=>new rR(e,t)),rR.Version,!0);class nR{}class sR extends gl{_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||mc.j.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,r=(0,Mo._6)("impostor-mesh-"+e.uniqueId,{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth});r.isVisible=this._debugMode,r.isPickable=!1,r.rotationQuaternion=new s.PT;const n=e.grip||e.pointer;r.position.copyFrom(n.position),r.rotationQuaternion.copyFrom(n.rotationQuaternion);const a=new mc.j(r,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:a,impostorMesh:r}}constructor(e,t){super(e),this._options=t,this._attachController=e=>{this._controllers[e.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||f.V.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&e.inputSource.gamepad?e.onMotionControllerInitObservable.addOnce((t=>{t._doNotLoadControllerMesh?this._createPhysicsImpostor(e):t.onModelLoadedObservable.addOnce((()=>{const i=new mc.j(t.rootMesh,mc.j.MeshImpostor,{mass:0,...this._options.physicsProperties}),r=e.grip||e.pointer;this._controllers[e.uniqueId]={xrController:e,impostor:i,oldPos:r.position.clone(),oldRotation:r.rotationQuaternion.clone()}}))})):this._createPhysicsImpostor(e))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new s.PT,this._tmpVector=new s.Pq,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)}))}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:mc.j.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=(0,Mo._6)("headset-mesh",{diameterX:"number"==typeof t?t:t.width,diameterY:"number"==typeof t?t:t.height,diameterZ:"number"==typeof t?t:t.depth}),this._headsetMesh.rotationQuaternion=new s.PT,this._headsetMesh.isVisible=!1,this._headsetImpostor=new mc.j(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._headsetMesh&&this._headsetMesh.dispose(),!0)}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t="string"==typeof e?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),this._options.xrInput.xrCamera._lastXRViewerPose?.linearVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(this._options.xrInput.xrCamera._lastXRViewerPose?.angularVelocity){const e=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e],i=t.xrController.grip||t.xrController.pointer,r=t.oldPos||t.impostorMesh.position;if(t.xrController._lastXRPose?.linearVelocity){const e=t.xrController._lastXRPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),t.impostor.setLinearVelocity(this._tmpVector)}else i.position.subtractToRef(r,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),t.impostor.setLinearVelocity(this._tmpVector);r.copyFrom(i.position),this._debugMode&&f.V.Log([this._tmpVector,"linear"]);const n=t.oldRotation||t.impostorMesh.rotationQuaternion;if(t.xrController._lastXRPose?.angularVelocity){const e=t.xrController._lastXRPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),t.impostor.setAngularVelocity(this._tmpVector)}else if(!n.equalsWithEpsilon(i.rotationQuaternion)){n.conjugateInPlace().multiplyToRef(i.rotationQuaternion,this._tmpQuaternion);const e=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),e<.001)this._tmpVector.scaleInPlace(2);else{const t=2*Math.atan2(e,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(t/(e*(this._delta/1e3)))}t.impostor.setAngularVelocity(this._tmpVector)}n.copyFrom(i.rotationQuaternion),this._debugMode&&f.V.Log([this._tmpVector,this._tmpQuaternion,"angular"])}))}_detachController(e){const t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}sR.Name=nl._.PHYSICS_CONTROLLERS,sR.Version=1,nl.n.AddWebXRFeature(sR.Name,((e,t)=>()=>new sR(e,t)),sR.Version,!0);class aR extends gl{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new s.uq,this._tmpPos=new s.Pq,this._tmpQuat=new s.PT,this._initHitTestSource=e=>{if(!e)return;const t=new XRRay(this.options.offsetRay||{}),i={space:this.options.useReferenceSpace?e:this._xrSessionManager.viewerReferenceSpace,offsetRay:t};this.options.entityTypes&&(i.entityTypes=this.options.entityTypes),i.space?this._xrSessionManager.session.requestHitTestSource(i).then((e=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=e})):re.S0.Warn("waiting for viewer reference space to initialize")},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new n.cP,this.paused=!1,this.xrNativeFeatureName="hit-test",re.S0.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach())return!1;if(!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then((e=>{this._transientXrHitTestSource=e}))}return!0}detach(){return!!super.detach()&&(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(this.attached&&!this.paused){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach((e=>{this._processWebXRHitTestResult(e.results,e.inputSource)}))}}_processWebXRHitTestResult(e,t){const i=[];e.forEach((e=>{const r=e.getPose(this._xrSessionManager.referenceSpace);if(!r)return;const n=r.transform.position,a=r.transform.orientation;this._tmpPos.set(n.x,n.y,n.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._tmpQuat.set(a.x,a.y,a.z,a.w),s.uq.FromFloat32ArrayToRefScaled(r.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const o={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:e};i.push(o)})),this.onHitTestResultObservable.notifyObservers(i)}}aR.Name=nl._.HIT_TEST,aR.Version=2,nl.n.AddWebXRFeature(aR.Name,((e,t)=>()=>new aR(e,t)),aR.Version,!1);class oR extends gl{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new n.cP,this.onFeaturePointsUpdatedObservable=new n.cP,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(t&&0!==t.length){if(t.length%5!=0)throw new Error("Received malformed feature point cloud of length: "+t.length);const e=t.length/5,i=[],r=[];for(let n=0;n<e;n++){const e=5*n,a=t[e+4];this._featurePointCloud[a]?i.push(a):(this._featurePointCloud[a]={position:new s.Pq,confidenceValue:0},r.push(a)),this._featurePointCloud[a].position.x=t[e],this._featurePointCloud[a].position.y=t[e+1],this._featurePointCloud[a].position.z=t[e+2],this._featurePointCloud[a].confidenceValue=t[e+3]}r.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(r),i.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(i)}}_init(){this._xrSessionManager.session.trySetFeaturePointCloudEnabled&&this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)&&(this._enabled=!0)}}oR.Name=nl._.FEATURE_POINTS,oR.Version=1,nl.n.AddWebXRFeature(oR.Name,(e=>()=>new oR(e)),oR.Version);let lR=0;class cR extends gl{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new n.cP,this.onMeshRemovedObservable=new n.cP,this.onMeshUpdatedObservable=new n.cP,this.xrNativeFeatureName="mesh-detection",this._options.generateMeshes&&(this._options.convertCoordinateSystems=!0),this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}detach(){return!!super.detach()&&(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach((e=>{this.onMeshRemovedObservable.notifyObservers(e)})),this._detectedMeshes.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){try{if(!this.attached||!e)return;const t=e.detectedMeshes||e.worldInformation?.detectedMeshes;if(t){const i=new Set;this._detectedMeshes.forEach(((e,r)=>{t.has(r)||i.add(r)})),i.forEach((e=>{const t=this._detectedMeshes.get(e);t&&(this.onMeshRemovedObservable.notifyObservers(t),this._detectedMeshes.delete(e))})),t.forEach((t=>{if(this._detectedMeshes.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){const i=this._detectedMeshes.get(t);i&&(this._updateVertexDataWithXRMesh(t,i,e),this.onMeshUpdatedObservable.notifyObservers(i))}}else{const i={id:lR++,xrMesh:t},r=this._updateVertexDataWithXRMesh(t,i,e);this._detectedMeshes.set(t,r),this.onMeshAddedObservable.notifyObservers(r)}}))}}catch(e){f.V.Log(e.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){t.xrMesh=e,t.worldParentNode=this._options.worldParentNode;const r=e.vertices||e.positions;if(this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=r,t.normals=e.normals;else{t.positions=new Float32Array(r.length);for(let e=0;e<r.length;e+=3)t.positions[e]=r[e],t.positions[e+1]=r[e+1],t.positions[e+2]=-1*r[e+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let i=0;i<e.normals.length;i+=3)t.normals[i]=e.normals[i],t.normals[i+1]=e.normals[i+1],t.normals[i+2]=-1*e.normals[i+2]}}t.indices=e.indices;const n=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(n){const e=t.transformationMatrix||new wo.uq;wo.uq.FromArrayToRef(n.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}if(this._options.generateMeshes){if(t.mesh){const e=t.mesh;e.updateVerticesData(Ue.R.PositionKind,t.positions),t.normals?e.updateVerticesData(Ue.R.NormalKind,t.normals):e.createNormals(!0),e.updateIndices(t.indices)}else{const e=new Rt.e("xr mesh "+t.id,this._xrSessionManager.scene);e.rotationQuaternion=new wo.PT,e.setVerticesData(Ue.R.PositionKind,t.positions),t.normals?e.setVerticesData(Ue.R.NormalKind,t.normals):e.createNormals(!0),e.setIndices(t.indices,void 0,!0),t.mesh=e}t.transformationMatrix?.decompose(t.mesh.scaling,t.mesh.rotationQuaternion,t.mesh.position)}}return t}}var hR;cR.Name=nl._.MESH_DETECTION,cR.Version=1,nl.n.AddWebXRFeature(cR.Name,((e,t)=>()=>new cR(e,t)),cR.Version,!1),function(e){e[e.NotReceived=0]="NotReceived",e[e.Waiting=1]="Waiting",e[e.Received=2]="Received"}(hR||(hR={}));class uR extends gl{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new n.cP,this.onTrackableImageFoundObservable=new n.cP,this.onTrackedImageUpdatedObservable=new n.cP,this._trackableScoreStatus=hR.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach((e=>{e.originalBitmap.close()})),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map((e=>"string"==typeof e.src?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(e.src):Promise.resolve(e.src)));try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map(((e,t)=>({image:e,widthInMeters:this.options.images[t].estimatedRealWorldWidth}))),{trackedImages:this._originalTrackingRequest}}catch(e){return re.S0.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===hR.Waiting)return;if(this._trackableScoreStatus===hR.NotReceived)return void this._checkScoresAsync();const t=e.getImageTrackingResults();for(const i of t){let t=!1;const r=i.index,n=this._trackedImages[r];if(!n)continue;n.xrTrackingResult=i,n.realWorldWidth!==i.measuredWidthInMeters&&(n.realWorldWidth=i.measuredWidthInMeters,t=!0);const a=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(a){const e=n.transformationMatrix;s.uq.FromArrayToRef(a.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t=!0}const o="emulated"===i.trackingState;n.emulated!==o&&(n.emulated=o,t=!0),t&&this.onTrackedImageUpdatedObservable.notifyObservers(n)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==hR.NotReceived)return;this._trackableScoreStatus=hR.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(e&&0!==e.length){for(let t=0;t<e.length;++t)if("untrackable"==e[t])this.onUntrackableImageFoundObservable.notifyObservers(t);else{const e=this._originalTrackingRequest[t].image,i={id:t,originalBitmap:e,transformationMatrix:new s.uq,ratio:e.width/e.height};this._trackedImages[t]=i,this.onTrackableImageFoundObservable.notifyObservers(i)}this._trackableScoreStatus=e.length>0?hR.Received:hR.NotReceived}else this._trackableScoreStatus=hR.NotReceived}}uR.Name=nl._.IMAGE_TRACKING,uR.Version=1,nl.n.AddWebXRFeature(uR.Name,((e,t)=>()=>new uR(e,t)),uR.Version,!1);class dR extends gl{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",re.S0.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!(!super.attach()||!this._xrSessionManager.session.domOverlayState||null===this._xrSessionManager.session.domOverlayState.type||(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,null!==this._element&&!0===this.options.supressXRSelectEvents&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),0))}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),null!==this._element&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(void 0===this.options.element)return re.S0.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof this.options.element){const e=document.querySelector(this.options.element);if(null===e)return re.S0.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}dR.Name=nl._.DOM_OVERLAY,dR.Version=1,nl.n.AddWebXRFeature(dR.Name,((e,t)=>()=>new dR(e,t)),dR.Version,!1);class pR extends gl{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new s.PT,this._tmpRotationMatrix=s.uq.Identity(),this._tmpTranslationDirection=new s.Pq,this._tmpMovementTranslation=new s.Pq,this._tempCacheQuaternion=new s.PT,this._attachController=e=>{if(this._controllers[e.uniqueId])return;this._controllers[e.uniqueId]={xrController:e,registeredComponents:[]};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController)for(const i of this._currentRegistrationConfigurations){let r=null;if(i.allowedComponentTypes)for(const t of i.allowedComponentTypes){const i=e.motionController.getComponentOfType(t);if(null!==i){r=i;break}}if(i.mainComponentOnly){const t=e.motionController.getMainComponent();if(null===t)continue;r=t}if("function"==typeof i.componentSelectionPredicate&&(r=i.componentSelectionPredicate(e)),r&&i.forceHandedness&&e.inputSource.handedness!==i.forceHandedness)continue;if(null===r)continue;const n={registrationConfiguration:i,component:r};t.registeredComponents.push(n),"axisChangedHandler"in i&&(n.onAxisChangedObserver=r.onAxisValueChangedObservable.add((e=>{i.axisChangedHandler(e,this._movementState,this._featureContext,this._xrInput)}))),"buttonChangedHandler"in i&&(n.onButtonChangedObserver=r.onButtonStateChangedObservable.add((e=>{e.changes.pressed&&i.buttonChangedHandler(e.changes.pressed,this._movementState,this._featureContext,this._xrInput)})))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}},t&&void 0!==t.xrInput?(Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=pR.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:t.movementOrientationFollowsViewerPose??!0,movementOrientationFollowsController:t.movementOrientationFollowsController??!1,orientationPreferredHandedness:t.orientationPreferredHandedness,movementSpeed:t.movementSpeed??1,movementThreshold:t.movementThreshold??.25,rotationEnabled:t.rotationEnabled??!0,rotationSpeed:t.rotationSpeed??1,rotationThreshold:t.rotationThreshold??.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput):re.S0.Error('WebXRControllerMovement feature requires "xrInput" option.')}attach(){return!!super.attach()&&(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._controllers={},!0)}_onXRFrame(e){if(this.attached){if(0!==this._movementState.rotateX&&this._featureContext.rotationEnabled){const e=.001*this._xrSessionManager.scene.getEngine().getDeltaTime()*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);if(this._featureContext.movementOrientationFollowsViewerPose)this._xrInput.xrCamera.cameraRotation.y+=e,s.PT.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection);else if(this._featureContext.movementOrientationFollowsController){this._xrInput.xrCamera.cameraRotation.y+=e;const t=this._featureContext.orientationPreferredHandedness||"right",i=Object.keys(this._controllers).find((e=>this._controllers[e]?.xrController?.inputSource.handedness===t))||Object.keys(this._controllers)[0],r=this._controllers[i];s.PT.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),(r?.xrController.pointer.rotationQuaternion||s.PT.Identity()).multiplyToRef(this._tempCacheQuaternion,this._movementDirection)}else s.PT.RotationYawPitchRollToRef(3*e,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion)}else if(this._featureContext.movementOrientationFollowsViewerPose)this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);else if(this._featureContext.movementOrientationFollowsController){const e=this._featureContext.orientationPreferredHandedness||"right",t=Object.keys(this._controllers).find((t=>this._controllers[t]?.xrController.inputSource.handedness===e))||Object.keys(this._controllers)[0],i=this._controllers[t];this._movementDirection.copyFrom(i?.xrController.pointer.rotationQuaternion||s.PT.Identity())}(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(s.uq.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),s.Pq.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(t){for(const e of t.registeredComponents)e.onAxisChangedObserver&&e.component.onAxisValueChangedObservable.remove(e.onAxisChangedObserver),e.onButtonChangedObserver&&e.component.onButtonStateChangedObservable.remove(e.onButtonChangedObserver);delete this._controllers[e]}}}pR.Name=nl._.MOVEMENT,pR.REGISTRATIONS={default:[{allowedComponentTypes:[al.THUMBSTICK_TYPE,al.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(e,t,i)=>{t.rotateX=Math.abs(e.x)>i.rotationThreshold?e.x:0,t.rotateY=Math.abs(e.y)>i.rotationThreshold?e.y:0}},{allowedComponentTypes:[al.THUMBSTICK_TYPE,al.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(e,t,i)=>{t.moveX=Math.abs(e.x)>i.movementThreshold?e.x:0,t.moveY=Math.abs(e.y)>i.movementThreshold?e.y:0}}]},pR.Version=1,nl.n.AddWebXRFeature(pR.Name,((e,t)=>()=>new pR(e,t)),pR.Version,!0);var fR=i(67695);class mR extends gl{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=s.Pq.Up().negateInPlace(),this._lightColor=a.v9.White(),this._intensity=1,this._sphericalHarmonics=new h_.O,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new n.cP,this._updateReflectionCubeMap=()=>{if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const e=Date.now();if(e-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=e}const e=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(e&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)this._reflectionCubeMap._texture._hardwareTexture?.set(e),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const t=new gi.hV(this._xrSessionManager.scene.getEngine(),0);t.isCube=!0,t.invertY=!1,t._useSRGBBuffer="srgba8"===this.options.reflectionFormat,t.format=5,t.generateMipMaps=!0,t.type="srgba8"!==this.options.reflectionFormat?2:0,t.samplingMode=3,t.width=this._reflectionCubeMapTextureSize,t.height=this._reflectionCubeMapTextureSize,t._cachedWrapU=1,t._cachedWrapV=1,t._hardwareTexture=new Fi.d(e,this._getCanvasContext()),this._reflectionCubeMap._texture=t}this._reflectionCubeMap._texture.isReady=!0,this.options.disablePreFiltering?(this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)):(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._hdrFilter.prefilter(this._reflectionCubeMap).then((()=>{this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap)})))}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new Io.Z("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new s.Pq(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=fR.c.FALLOFF_GLTF),this._hdrFilter=new Vh(this._xrSessionManager.scene.getEngine()),re.S0.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return null===this._canvasContext&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(null===this._xrWebGLBinding){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){if(!super.attach())return!1;const e=this.options.reflectionFormat??(this._xrSessionManager.session.preferredReflectionFormat||"srgba8");return this.options.reflectionFormat=e,this._xrSessionManager.session.requestLightProbe({reflectionFormat:e}).then((e=>{this._xrLightProbe=e,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new Vo.t(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))})),!0}detach(){const e=super.detach();return null===this._xrLightProbe||this.options.disableCubeMapReflection||(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this._reflectionCubeMap&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){if(null!==this._xrLightProbe){if(this.options.lightEstimationPollInterval){const e=Date.now();if(e-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=e}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const e=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new s.Pq,this._lightColor=new a.v9,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*e),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new h_.Q,this._reflectionCubeMap.sphericalPolynomial?.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}mR.Name=nl._.LIGHT_ESTIMATION,mR.Version=1,nl.n.AddWebXRFeature(mR.Name,((e,t)=>()=>new mR(e,t)),mR.Version,!1);class _R extends gl{constructor(e){super(e),this.onEyeTrackingStartedObservable=new n.cP,this.onEyeTrackingEndedObservable=new n.cP,this.onEyeTrackingFrameUpdateObservable=new n.cP,this._eyeTrackingStartListener=e=>{this._latestEyeSpace=e.gazeSpace,this._gazeRay=new Ii.Rl(s.Pq.Zero(),s.Pq.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce((()=>{this._init()}))}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(this.attached&&e&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z).scaleInPlace(this._xrSessionManager.worldScalingFactor);const e=t.transform.orientation;s.AA.Quaternion[0].set(e.x,e.y,e.z,e.w),this._xrSessionManager.scene.useRightHandedSystem?s.Pq.RightHandedForwardReadOnly.rotateByQuaternionToRef(s.AA.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,s.AA.Quaternion[0].z*=-1,s.AA.Quaternion[0].w*=-1,s.Pq.LeftHandedForwardReadOnly.rotateByQuaternionToRef(s.AA.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}_R.Name=nl._.EYE_TRACKING,_R.Version=1,nl.n.AddWebXRFeature(_R.Name,(e=>()=>new _R(e)),_R.Version,!1);class gR{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():s.I9.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class vR{constructor(){this._samples=new gR(20),this._entropy=0,this.onFirstStepDetected=new n.cP}update(e,t,i,r){this._samples.push(e,t);const n=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=s.I9.Distance(n,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let a;for(a=this._samePointCheckStartIdx;a<this._samples.length&&!(s.I9.DistanceSquared(n,this._samples.at(a))<this._samePointSquaredDistanceThreshold);++a);if(a===this._samples.length)return;let o=-1,l=0;for(let e,t=1;t<a;++t)e=s.I9.DistanceSquared(n,this._samples.at(t)),e>o&&(l=t,o=e);if(o<this._apexSquaredDistanceThreshold)return;const c=this._samples.at(l),h=c.subtract(n);h.normalize();const u=s.AA.Vector2[0];let d,p,f=0;for(let e=1;e<a;++e)p=this._samples.at(e),p.subtractToRef(n,u),d=s.I9.Dot(h,u),f+=u.lengthSquared()-d*d;if(f>a*this._squaredProjectionDistanceThreshold)return;const m=s.AA.Vector3[0];m.set(i,r,0);const _=s.AA.Vector3[1];_.set(h.x,h.y,0);const g=s.Pq.Cross(m,_).z>0,v=n.clone(),S=n.clone();c.subtractToRef(n,h),g?(h.scaleAndAddToRef(this._axisToApexShrinkFactor,v),h.scaleAndAddToRef(this._axisToApexExtendFactor,S)):(h.scaleAndAddToRef(this._axisToApexExtendFactor,v),h.scaleAndAddToRef(this._axisToApexShrinkFactor,S)),this.onFirstStepDetected.notifyObservers({leftApex:v,rightApex:S,currentPosition:n,currentStepDirection:g?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return 9e-4}get _apexSquaredDistanceThreshold(){return.0081}get _squaredProjectionDistanceThreshold(){return 9e-4}get _axisToApexShrinkFactor(){return.8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return.93}get _entropyThreshold(){return.4}}class SR{constructor(e,t,i,r){this._leftApex=new s.I9,this._rightApex=new s.I9,this._currentPosition=new s.I9,this._axis=new s.I9,this._axisLength=-1,this._forward=new s.I9,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new s.I9,this._vitality=0,this.onMovement=new n.cP,this.onFootfall=new n.cP,this._reset(e,t,i,"left"===r)}_reset(e,t,i,r){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=r,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,r=s.I9.Dot(this._currentPosition,this._axis);this._t=r/(this._axisLength*this._axisLength);const n=this._currentPosition.lengthSquared()-r/this._axisLength*(r/this._axisLength);this._vitality*=.92-100*Math.max(n-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return.1}get forward(){return this._forward}}class xR{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new vR,this._walker=null,this._movement=new s.I9,this._millisecondsSinceLastUpdate=xR._MillisecondsPerUpdate,this.movementThisFrame=s.Pq.Zero(),this._engine=e,this._detector.onFirstStepDetected.add((e=>{this._walker||(this._walker=new SR(e.leftApex,e.rightApex,e.currentPosition,e.currentStepDirection),this._walker.onFootfall.add((()=>{f.V.Log("Footfall!")})),this._walker.onMovement.add((e=>{this._walker.forward.scaleAndAddToRef(.024*e.deltaT,this._movement)})))}))}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=xR._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=xR._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class TR extends gl{static get Name(){return nl._.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera="WebXRCamera"===this._locomotionTarget.getClassName()}constructor(e,t){super(e),this._up=new s.Pq,this._forward=new s.Pq,this._position=new s.Pq,this._movement=new s.Pq,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&f.V.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return void 0===this._sessionManager.sessionMode||"immersive-vr"===this._sessionManager.sessionMode}attach(){return!(!this.isCompatible||!super.attach()||(this._walker=new xR(this._sessionManager.scene.getEngine()),0))}detach(){return!!super.detach()&&(this._walker=null,!0)}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,r=t.transform.matrix;this._up.copyFromFloats(r[4],r[5],i*r[6]),this._forward.copyFromFloats(r[8],r[9],i*r[10]),this._position.copyFromFloats(r[12],r[13],i*r[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||s.Pq.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}nl.n.AddWebXRFeature(TR.Name,((e,t)=>()=>new TR(e,t)),TR.Version,!1);class ER extends Di{constructor(e,t,i,r,n,s,a=null){super(e,t,i,r,s),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=n,this.createRTTProvider=s,this._originalInternalTexture=a}}class CR extends Li{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this.onRenderTargetTextureCreatedObservable=new n.cP,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t="none"){const i=this._lastSubImages.get(t),r="right"==t?1:0,n=e.colorTextureWidth??e.textureWidth,s=e.colorTextureHeight??e.textureHeight;if(!this._renderTargetTextures[r]||i?.textureWidth!==n||i?.textureHeight!==s){let i;const a=e.depthStencilTextureWidth??n,o=e.depthStencilTextureHeight??s;n!==a&&s!==o||(i=e.depthStencilTexture),this._renderTargetTextures[r]=this._createRenderTargetTexture(n,s,null,e.colorTexture,i,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:s},this.onRenderTargetTextureCreatedObservable.notifyObservers({texture:this._renderTargetTextures[r],eye:t})}return this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e?.eye)}_setViewportForSubImage(e,t){const i=t.colorTextureWidth??t.textureWidth,r=t.colorTextureHeight??t.textureHeight,n=t.viewport;e.x=n.x/i,e.y=n.y/r,e.width=n.width/i,e.height=n.height/r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}class bR extends ER{constructor(e,t,i){super((()=>e.textureWidth),(()=>e.textureHeight),e,"XRProjectionLayer",t,(e=>new PR(e,i,this))),this.layer=e}}class PR extends CR{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}const yR={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1,clearOnAccess:!1},AR={};class RR extends gl{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this._isMultiviewEnabled=!1,this._projectionLayerInitialized=!1,this._compositionLayerTextureMapping=new WeakMap,this._layerToRTTProviderMapping=new WeakMap,this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t={...yR,...this._options.projectionLayerInit};return this._isMultiviewEnabled=this._options.preferMultiviewOnInit&&e.getCaps().multiview,this.createProjectionLayer(t),this._projectionLayerInitialized=!0,!0}detach(){return!!super.detach()&&(this._existingLayers.forEach((e=>{e.dispose()})),this._existingLayers.length=0,this._projectionLayerInitialized=!1,!0)}createXRWebGLLayer(e=AR){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new wi(t)}_validateLayerInit(e,t=this._isMultiviewEnabled){if(!this._xrSessionManager.inXRSession)throw new Error("Cannot create a layer outside of a WebXR session. Make sure the session has started before creating layers.");if(t&&"texture-array"!==e.textureType)throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&"texture-array"===e.textureType)throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.")}_extendXRLayerInit(e,t=this._isMultiviewEnabled){return t&&(e.textureType="texture-array"),e}createProjectionLayer(e=yR,t=this._isMultiviewEnabled){this._extendXRLayerInit(e,t),this._validateLayerInit(e,t);const i=this._xrWebGLBinding.createProjectionLayer(e),r=new bR(i,t,this._xrWebGLBinding);return this.addXRSessionLayer(r),r}_createQuadLayer(e={params:{}},t){this._extendXRLayerInit(e.params,!1);const i=this._existingLayers[0].layer.textureWidth,r=this._existingLayers[0].layer.textureHeight,n={space:this._xrSessionManager.referenceSpace,viewPixelWidth:i,viewPixelHeight:r,clearOnAccess:!0,...e.params};this._validateLayerInit(n,!1);const s=this._xrWebGLBinding.createQuadLayer(n);s.width=this._isMultiviewEnabled?1:2,s.height=1;const a=new ER((()=>s.width),(()=>s.height),s,"XRQuadLayer",!1,(e=>new CR(e,this._xrWebGLBinding,a)));t&&this._compositionLayerTextureMapping.set(s,t);const o=a.createRenderTargetTextureProvider(this._xrSessionManager);return this._layerToRTTProviderMapping.set(s,o),this.addXRSessionLayer(a),a}addFullscreenAdvancedDynamicTexture(e,t={distanceFromHeadset:1.5}){const i=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}},e),r=i.layer,n={x:0,y:0,z:-Math.max(.1,t.distanceFromHeadset)};r.transform=new XRRigidTransform(n,{x:0,y:0,z:0,w:1});const s=this._layerToRTTProviderMapping.get(r);if(!s)throw new Error("Could not find the RTT provider for the layer");const o=this._xrSessionManager.scene.layers.find((t=>t.texture===e));if(!o)throw new Error("Could not find the babylon layer for the texture");return s.onRenderTargetTextureCreatedObservable.add((e=>{e.eye&&"right"===e.eye||(e.texture.clearColor=new a.ov(0,0,0,0),o.renderTargetTextures.push(e.texture),o.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.scene.onBeforeRenderObservable.add((()=>{e.texture.render()})),o.renderTargetTextures.push(e.texture),o.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.onXRSessionEnded.addOnce((()=>{o.renderTargetTextures.splice(o.renderTargetTextures.indexOf(e.texture),1),o.renderOnlyInRenderTargetTextures=!1})))})),i}_addLensFlareSystem(e){const t=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}}),i=t.layer;i.width=2,i.height=1;i.transform=new XRRigidTransform({x:0,y:0,z:-10},{x:0,y:0,z:0,w:1});const r=this._layerToRTTProviderMapping.get(i);if(!r)throw new Error("Could not find the RTT provider for the layer");return r.onRenderTargetTextureCreatedObservable.add((t=>{t.texture.clearColor=new a.ov(0,0,0,0),t.texture.customRenderFunction=()=>{e.render()}})),this._xrSessionManager.onXRSessionInit.add((()=>{this._xrSessionManager.scene.lensFlareSystems.splice(this._xrSessionManager.scene.lensFlareSystems.indexOf(e),1)})),this._xrSessionManager.onXRSessionEnded.add((()=>{this._xrSessionManager.scene.lensFlareSystems.push(e)})),t}addXRSessionLayer(e){this._existingLayers.push(e),this.setXRSessionLayers(this._existingLayers)}setXRSessionLayers(e=this._existingLayers){const t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map((e=>e.layer)),this._xrSessionManager.updateRenderState(t),this._projectionLayerInitialized||this._xrSessionManager._setBaseLayerWrapper(e.length>0?e.at(0):null)}isCompatible(){return!this._xrSessionManager.isNative&&"undefined"!=typeof XRWebGLBinding&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){const t=this._existingLayers;for(let i=0;i<t.length;++i){const r=t[i];if("XRProjectionLayer"!==r.layerType){const t=this._layerToRTTProviderMapping.get(r.layer);if(!t)continue;if(t.layerWrapper.isMultiview){const i=e.getViewerPose(this._xrSessionManager.referenceSpace);if(i){const e=i.views;for(let i=0;i<e.length;++i){const r=e[i];t.getRenderTargetTextureForView(r)}}}else t.getRenderTargetTextureForView()}}}}RR.Name=nl._.LAYERS,RR.Version=1,nl.n.AddWebXRFeature(RR.Name,((e,t)=>()=>new RR(e,t)),RR.Version,!1);class IR extends gl{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float"}}get latestInternalTexture(){if(!this._cachedWebGLTexture)return null;const e=this._xrSessionManager.scene.getEngine(),t=new gi.hV(e,0);return t.isCube=!1,t.invertY=!1,t._useSRGBBuffer=!1,t.format="ushort"===this.depthDataFormat?2:5,t.generateMipMaps=!1,t.type="ushort"===this.depthDataFormat?5:1,t.samplingMode=7,t.width=this.width??0,t.height=this.height??0,t._cachedWrapU=1,t._cachedWrapV=1,t._hardwareTexture=new Fi.d(this._cachedWebGLTexture,e._gl),t}get latestDepthBuffer(){return this._cachedDepthBuffer?"ushort"===this.depthDataFormat?new Uint16Array(this._cachedDepthBuffer):new Float32Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this.onGetDepthInMetersAvailable=new n.cP,this.xrNativeFeatureName="depth-sensing",re.S0.Warn("depth-sensing is an experimental and unstable feature.")}attach(e){return!!super.attach(e)&&(null!=this._xrSessionManager.session.depthDataFormat&&null!=this._xrSessionManager.session.depthUsage&&(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),!0))}dispose(){this._cachedDepthImageTexture?.dispose(),this.onGetDepthInMetersAvailable.clear()}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(null!=i)for(const t of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,t,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,t,this.depthDataFormat);break;default:re.S0.Error("Unknown depth usage"),this.detach()}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){const r=e.getDepthInformation(t);if(null===r)return;const{data:n,width:s,height:a,rawValueToMeters:o,getDepthInMeters:l}=r;switch(this._width=s,this._height=a,this._rawValueToMeters=o,this._cachedDepthBuffer=n,this.onGetDepthInMetersAvailable.notifyObservers(l.bind(r)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=me.I.CreateRTexture(null,s,a,this._xrSessionManager.scene,!1,!0,_e.g.NEAREST_SAMPLINGMODE,1)),i){case"ushort":this._cachedDepthImageTexture.update(Float32Array.from(new Uint16Array(n)).map((e=>e*o)));break;case"float":this._cachedDepthImageTexture.update(new Float32Array(n).map((e=>e*o)))}}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){const r=e.getDepthInformation(t);if(null===r)return;const{texture:n,width:s,height:a}=r;this._width=s,this._height=a,this._cachedWebGLTexture=n;const o=this._xrSessionManager.scene,l=o.getEngine().wrapWebGLTexture(n);this._cachedDepthImageTexture||(this._cachedDepthImageTexture=me.I.CreateRTexture(null,s,a,o,!1,!0,_e.g.NEAREST_SAMPLINGMODE,"ushort"===i?0:1)),this._cachedDepthImageTexture._texture=l}getXRSessionInitExtension(){const e=null!=this.options.usagePreference&&0!==this.options.usagePreference.length,t=null!=this.options.dataFormatPreference&&0!==this.options.dataFormatPreference.length;return new Promise((i=>{i(e&&t?{depthSensing:{usagePreference:this.options.usagePreference.map((e=>{switch(e){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}})),dataFormatPreference:this.options.dataFormatPreference.map((e=>{switch(e){case"ushort":return"luminance-alpha";case"float":return"float32"}}))}}:{})}))}}IR.Name=nl._.DEPTH_SENSING,IR.Version=1,nl.n.AddWebXRFeature(IR.Name,((e,t)=>()=>new IR(e,t)),IR.Version,!1);ri.l.ShadersStore.velocityPixelShader="precision highp float;\n#define CUSTOM_FRAGMENT_BEGIN\nvarying vec4 clipPos;varying vec4 previousClipPos;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nhighp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";ri.l.ShadersStore.velocityVertexShader="#define CUSTOM_VERTEX_BEGIN\n#define VELOCITY\nattribute vec3 position;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform mat4 previousViewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;\n#endif\nvarying vec4 clipPos;varying vec4 previousClipPos;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#include<instancesVertex>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}\n#elif\nclipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}";class MR extends Si.${constructor(e,t,i,r=512){super("spacewarp rtt",r,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[s.uq.Identity(),s.uq.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new ir.B("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add((e=>{this._previousWorldMatrices[e.uniqueId]=this._previousWorldMatrices[e.uniqueId]||e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[e.uniqueId]),this._previousWorldMatrices[e.uniqueId]=e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)})),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;const i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach((e=>{this._originalPairing.push([e,e.material]),e.material=this._velocityMaterial})),super.render(e,t),this._originalPairing.forEach((e=>{e[0].material=e[1]}))}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}}class OR{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){const t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw new Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if("XRProjectionLayer"!==t.layerType)throw new Error('For Space Warp, the base layer type should "XRProjectionLayer".');const i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,r,n){if(!this._engine)throw new Error("Engine is disposed");const s={width:e,height:t},a=new MR(r,n,this._scene,s),o=a.renderTarget;return i&&(o._framebuffer=i),o._colorTextureArray=r,o._depthStencilTextureArray=n,a.disableRescaling(),a.renderListPredicate=()=>!0,a}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t);let r=this._renderTargetTextures.get(t.eye);const n=e.motionVectorTextureWidth,s=e.motionVectorTextureHeight;return r&&i?.textureWidth===n&&i?.textureHeight==s||(r=this._createRenderTargetTexture(n,s,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,r),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:s}),this._lastSubImages.set(t,e),r}trySetViewportForView(e,t){const i=this._lastSubImages.get(t)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}accessMotionVector(e){const t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){const t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.clear()}}class NR extends gl{constructor(e){super(e),this._onAfterRenderObserver=null,this.dependsOn=[nl._.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new OR(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._onAfterRenderObserver=this._xrSessionManager.scene.onAfterRenderObservable.add((()=>this._onAfterRender())),!0}detach(){return this._xrSessionManager.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),super.detach()}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;const i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}}NR.Name=nl._.SPACE_WARP,NR.Version=1,nl.n.AddWebXRFeature(NR.Name,(e=>()=>new NR(e)),NR.Version,!1);class DR extends gl{constructor(e,t={}){super(e),this.options=t,this._cachedInternalTextures=[],this.texturesData=[],this.viewIndex=[],this.cameraIntrinsics=[],this.onTexturesUpdatedObservable=new n.cP,this.xrNativeFeatureName="camera-access"}attach(e){return!!super.attach(e)&&(this._glContext=this._xrSessionManager.scene.getEngine()._gl,this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),!0)}detach(){return!!super.detach()&&(this._glBinding=void 0,this.options.doNotDisposeOnDetach||(this._cachedInternalTextures.forEach((e=>e.dispose())),this.texturesData.forEach((e=>e.dispose())),this._cachedInternalTextures.length=0,this.texturesData.length=0,this.cameraIntrinsics.length=0),!0)}dispose(){super.dispose(),this.onTexturesUpdatedObservable.clear()}_updateCameraIntrinsics(e,t){const i={width:e.camera.width,height:e.camera.height,x:0,y:0},r=e.projectionMatrix,n=(1-r[8])*i.width/2+i.x,s=(1-r[9])*i.height/2+i.y,a=i.width/2*r[0],o=i.height/2*r[5],l=i.width/2*r[4];this.cameraIntrinsics[t]={u0:n,v0:s,ax:a,ay:o,gamma:l,width:i.width,height:i.height,viewportX:i.x,viewportY:i.y}}_updateInternalTextures(e,t=0){if(!e.camera)return!1;this.viewIndex[t]=e.eye;const i=this._glBinding?.getCameraImage(e.camera);if(this._cachedInternalTextures[t])this._cachedInternalTextures[t]._hardwareTexture?.set(i);else{const r=new gi.hV(this._xrSessionManager.scene.getEngine(),0,!0);r.invertY=!1,r.format=5,r.generateMipMaps=!0,r.type=0,r.samplingMode=3,r.width=e.camera.width,r.height=e.camera.height,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new Fi.d(i,this._glContext),this._cachedInternalTextures[t]=r;const n=new Vo.t(this._xrSessionManager.scene);n.name=`WebXR Raw Camera Access (${t})`,n._texture=this._cachedInternalTextures[t],this.texturesData[t]=n,this._updateCameraIntrinsics(e,t)}return this._cachedInternalTextures[t].isReady=!0,!0}_onXRFrame(e){const t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(!i||!i.views)return;let r=!0;i.views.forEach(((e,t)=>{r=r&&this._updateInternalTextures(e,t)})),r&&this.onTexturesUpdatedObservable.notifyObservers(this.texturesData)}}DR.Name=nl._.RAW_CAMERA_ACCESS,DR.Version=1,nl.n.AddWebXRFeature(DR.Name,((e,t)=>()=>new DR(e,t)),DR.Version,!1);class FR extends ll{constructor(e,t,i){super(e,LR[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}pl.RegisterController("generic-hand-select-grasp",((e,t)=>new FR(t,e.gamepad,e.handedness)));const LR={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class wR extends ll{constructor(e,t,i){super(e,BR["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";return e="left"===this.handedness?wR.MODEL_LEFT_FILENAME:wR.MODEL_RIGHT_FILENAME,{filename:e,path:wR.MODEL_BASE_URL+"default/"}}_getModelLoadingConstraints(){const e=ol.cn.IsPluginForExtensionAvailable(".glb");return e||f.V.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){this.rootMesh&&(this.getComponentIds().forEach(((e,t)=>{if(!this.disableAnimation&&e&&this.rootMesh){const i=this._mapping.buttons[e],r=i.rootNodeName;if(!r)return void f.V.Log("Skipping unknown button at index: "+t+" with mapped name: "+e);const n=this._getChildByName(this.rootMesh,r);if(!n)return void f.V.Warn("Missing button mesh with name: "+r);if(i.valueMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.valueNodeName),i.pressedMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.pressedNodeName),i.unpressedMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.unpressedNodeName),i.valueMesh&&i.pressedMesh&&i.unpressedMesh){const t=this.getComponent(e);t&&t.onButtonStateChangedObservable.add((e=>{this._lerpTransform(i,e.value)}),void 0,!0)}else f.V.Warn("Missing button submesh under mesh with name: "+r)}})),this.getComponentIds().forEach((e=>{const t=this.getComponent(e);t.isAxes()&&["x-axis","y-axis"].forEach((i=>{if(!this.rootMesh)return;const r=this._mapping.axes[e][i],n=this._getChildByName(this.rootMesh,r.rootNodeName);n?(r.valueMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.valueNodeName),r.minMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.minNodeName),r.maxMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.maxNodeName),r.valueMesh&&r.minMesh&&r.maxMesh?t&&t.onAxisValueChangedObservable.add((e=>{const t="x-axis"===i?e.x:e.y;this._lerpTransform(r,t,!0)}),void 0,!0):f.V.Warn("Missing axis submesh under mesh with name: "+r.rootNodeName)):f.V.Warn("Missing axis mesh with name: "+r.rootNodeName)}))})))}_setRootMesh(e){let t;this.rootMesh=new Rt.e(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=s.PT.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}wR.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",wR.MODEL_LEFT_FILENAME="left.glb",wR.MODEL_RIGHT_FILENAME="right.glb",pl.RegisterController("windows-mixed-reality",((e,t)=>new wR(t,e.gamepad,e.handedness)));const BR={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class VR extends ll{constructor(e,t,i,r=!1,n=!1){super(e,kR[i],t,i),this._forceLegacyControllers=n,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";return e="left"===this.handedness?VR.MODEL_LEFT_FILENAME:VR.MODEL_RIGHT_FILENAME,{filename:e,path:this._isQuest()?VR.QUEST_MODEL_BASE_URL:VR.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i="right"===this.handedness?-1:1;this.getComponentIds().forEach((e=>{const r=e&&this.getComponent(e);r&&r.onButtonStateChangedObservable.add((r=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(t||(this._modelRootNode.getChildren()[3].rotation.x=.2*-r.value,this._modelRootNode.getChildren()[3].position.y=.005*-r.value,this._modelRootNode.getChildren()[3].position.z=.005*-r.value));case"xr-standard-squeeze":return void(t||(this._modelRootNode.getChildren()[4].position.x=i*r.value*.0035));case"xr-standard-thumbstick":return;case"a-button":case"x-button":return void(t||(r.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0));case"b-button":case"y-button":return void(t||(r.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0))}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new Rt.e(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=s.PT.FromEulerAngles(0,Math.PI,0)),e.forEach((e=>{e.isPickable=!1})),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}VR.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",VR.MODEL_LEFT_FILENAME="left.babylon",VR.MODEL_RIGHT_FILENAME="right.babylon",VR.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",pl.RegisterController("oculus-touch",((e,t)=>new VR(t,e.gamepad,e.handedness))),pl.RegisterController("oculus-touch-legacy",((e,t)=>new VR(t,e.gamepad,e.handedness,!0)));const kR={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class GR extends ll{constructor(e,t,i){super(e,UR[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){return{filename:GR.MODEL_FILENAME,path:GR.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=e&&this.getComponent(e);t&&t.onButtonStateChangedObservable.add((t=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":return void(this._modelRootNode.getChildren()[6].rotation.x=.15*-t.value);case"xr-standard-touchpad":case"xr-standard-squeeze":return}}),void 0,!0)}))}_setRootMesh(e){this.rootMesh=new Rt.e(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1})),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=s.PT.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}GR.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",GR.MODEL_FILENAME="wand.babylon",pl.RegisterController("htc-vive",((e,t)=>new GR(t,e.gamepad,e.handedness)));const UR={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};class zR{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>this._nativeImpl._imageTrackingResults??[]}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const r=this._xrTransform.orientation;return r.x=this._xrPoseVectorData[4],r.y=this._xrPoseVectorData[5],r.z=this._xrPoseVectorData[6],r.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}}un("NativeXRFrame",zR)}}]);